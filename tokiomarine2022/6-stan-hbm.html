<!DOCTYPE html>
<html>
<head prefix="og: http://ogp.me/ns#">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<title>6. Stanで階層ベイズモデル — 統計モデリング概論 DSHC 2022</title>
<link rel="stylesheet" href="/slides/lib/reveal.js/reveal.css">
<link rel="stylesheet" href="/slides/css/theme-reveal.css">
<meta name="author" content="Watal M. Iwasaki">
<meta property="og:title" content="6. Stanで階層ベイズモデル — 統計モデリング概論 DSHC 2022">
<meta property="og:type" content="article">
<meta property="og:url" content="https://heavywatal.github.io/slides/tokiomarine2022/6-stan-hbm.html">
<meta property="og:image" content="https://avatars.githubusercontent.com/heavywatal">
<meta property="og:description" content="">
<meta property="og:site_name" content="Slide decks — Heavy Watal">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@heavywatal">
<meta name="twitter:creator" content="@heavywatal">
<meta name="generator" content="Hugo 0.101.0" />
<link rel="stylesheet" href="/lib/katex/katex.min.css">
<script defer src="/lib/katex/katex.min.js"></script>
<script defer src="/lib/katex/contrib/auto-render.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  renderMathInElement(document.body, {
    delimiters: [
      {left: "\\[", right: "\\]", display: true},
      {left: "$", right: "$", display: false}
    ]
  });
});
</script>
<style>
.katex {
  font-size: 1.12em;
}

.katex-display > .katex {
  text-align: left;
  padding-left: 2rem;
}
</style>

<script defer src="https://use.fontawesome.com/releases/v5.8.2/js/all.js" integrity="sha384-DJ25uNYET2XCl5ZF++U8eNxPWqcKohUUBUpKGlNLMchM7q4Wjg2CUpjHLaL8yYPH" crossorigin="anonymous"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-V60H2JH0G6"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-V60H2JH0G6', { 'anonymize_ip': false });
}
</script>

</head>
<body>
<div class="reveal">
<div class="slides">
<section>
<link rel="stylesheet" href="style.css">
<h1 id="統計モデリング概論-dshc-2022"><a href=".">統計モデリング概論 DSHC 2022</a></h1>
<div class="author">
岩嵜 航 (Watal M. Iwasaki, PhD)
</div>
<div class="affiliation">
東北大学 生命科学研究科 進化ゲノミクス分野 特任助教<br>
(Graduate School of Life Sciences, Tohoku University)
</div>
<ol>
<li><a href="1-introduction.html">導入</a>
<li><a href="2-stats-model.html">統計モデルの基本: 確率分布、尤度</a>
<li><a href="3-glm.html">一般化線形モデル、混合モデル</a>
<li><a href="4-bayesian.html">ベイズ推定とMCMC</a>
<li><a href="5-stan-glm.html">StanでGLM</a>
<li class="current-deck"><a href="6-stan-hbm.html">Stanで階層ベイズモデル</a>
</ol>
<div class="footnote">
2022-08-24 東京海上 Data Science Hill Climb
<a href="https://heavywatal.github.io/slides/tokiomarine2022/">https://heavywatal.github.io/slides/tokiomarine2022/</a>
</div>

</section>
<section>
<h2 id="glmmで登場した個体差を階層ベイズモデルで">GLMMで登場した個体差を階層ベイズモデルで</h2>
<figure>
<a href="https://kuboweb.github.io/-kubo/ce/LinksGlm.html">
<img src="../tokiomarine2021/image/kubo-p2.png" width="100%">
<figcaption class="url">久保さん https://kuboweb.github.io/-kubo/ce/LinksGlm.html</figcaption>
</a>
</figure>

</section>
<section>
<h2 id="glmmで登場した個体差を階層ベイズモデルで">GLMMで登場した個体差を階層ベイズモデルで</h2>
<p>植物100個体から8個ずつ種子を取って植えたら全体で半分ちょい発芽。<br>
親1個体あたりの生存数は<span style="color: #3366ff;">n=8の二項分布</span>になるはずだけど、<br>
極端な値(全部死亡、全部生存)が多かった。個体差？</p>
<img src="figure/overdispersion-1.png" alt="plot of chunk overdispersion">
</section>
<section>
<h2 id="階層ベイズモデルのイメージ図">階層ベイズモデルのイメージ図</h2>
<p>事前分布のパラメータに、さらに事前分布を設定するので階層ベイズ</p>
<figure>
<img src="../tokiomarine2021/hbm.drawio.svg">
</figure>

</section>
<section>
<h2 id="さっきの図をstan言語で記述すると">さっきの図をStan言語で記述すると</h2>
<p>お絵描きモデルとStanモデルを見比べてみよう。</p>
<pre tabindex="0"><code>
data {
  int&lt;lower=0&gt; N;
  array[N] int&lt;lower=0&gt; y;
}

parameters {
  real a;           // mean ability
  vector[N] r;      // individual difference
  real&lt;lower=0&gt; s;  // sd of r
}

model {
  y ~ binomial(8, inv_logit(a + r));
  a ~ normal(0, 10);
  r ~ normal(0, s);
  s ~ exponential(0.01);
}
</code></pre><p><code>inv_logit(a + r)</code> が p に相当。<br>
<code>10</code> とか <code>0.01</code> とか、エイヤっと決めてるやつが超パラメータ。</p>

</section>
<section>
<h2 id="変量効果が入った推定結果">変量効果が入った推定結果</h2>
<pre tabindex="0"><code>Running MCMC with 4 chains, at most 6 in parallel...

Chain 1 finished in 0.3 seconds.
Chain 2 finished in 0.3 seconds.
Chain 3 finished in 0.3 seconds.
Chain 4 finished in 0.3 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.3 seconds.
Total execution time: 0.5 seconds.
</code></pre><pre tabindex="0"><code> variable    mean  median   sd  mad      q5     q95 rhat ess_bulk ess_tail
     lp__ -455.20 -454.87 9.24 9.31 -471.19 -440.89 1.01      858     1543
     a       0.27    0.27 0.32 0.32   -0.26    0.80 1.00      567     1161
     r[1]   -0.26   -0.26 0.79 0.78   -1.54    1.03 1.00     2924     2514
     r[2]    1.77    1.68 1.08 1.07    0.15    3.64 1.00     4828     2714
     r[3]    1.77    1.67 1.09 1.01    0.18    3.74 1.00     3284     1963
     r[4]   -3.85   -3.64 1.64 1.56   -6.87   -1.60 1.00     5074     2731
     r[5]   -2.24   -2.16 1.06 1.04   -4.06   -0.65 1.00     3370     2479
     r[6]   -2.24   -2.14 1.10 1.00   -4.19   -0.64 1.00     3832     2252
     r[7]    0.89    0.85 0.89 0.86   -0.50    2.38 1.00     3181     2308
     r[8]   -2.22   -2.15 1.03 1.01   -4.09   -0.63 1.00     3482     2450

 # showing 10 of 103 rows (change via &#39;max_rows&#39; argument or &#39;cmdstanr_max_rows&#39; option)
</code></pre>
</section>
<section>
<h2 id="抜粋して作図悪くない">抜粋して作図。悪くない。</h2>
<p>データ生成の真のパラメータ値は $a = 0.5,~s = 3.0$ だった。</p>
<pre tabindex="0"><code>Warning: The following arguments were unrecognized and ignored: bins
</code></pre><pre tabindex="0"><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
</code></pre><p><img src="figure/stan-glmm-1.png" alt="plot of chunk stan-glmm"></p>

</section>
<section>
<h2 id="事前分布の選別">事前分布の選別</h2>
<ol>
<li>
<p>とりあえず<strong>無情報事前分布</strong> $[-\infty, \infty]$。Stanのデフォルト。</p>
</li>
<li>
<p>収束が悪かったら<strong>弱情報事前分布</strong>を試す。<br>
事後分布を更新していったとき<strong>事前分布っぽさが残らない</strong>のが良い。</p>
<ul>
<li>取りうる値を逃すような狭すぎる分布はダメ。</li>
<li>狭すぎるよりはマシだが、広すぎても良くない。</li>
<li>一様分布 $[a, b]$ は一見無情報っぽくて良さそうだが、<br>
事後分布に裾野が残ったり絶壁ができたりしがちなので微妙。</li>
</ul>
<p>おすすめ: <strong>Student&rsquo;s t分布</strong>、正規分布、指数分布など。</p>
</li>
</ol>
<p><cite><a href="https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations">https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations</a></cite></p>

</section>
<section>
<h2 id="stanおすすめ弱情報事前分布-students-t分布">Stanおすすめ弱情報事前分布: Student&rsquo;s t分布</h2>
<p>Student&rsquo;s $t(\nu=\nu_0, \mu = 0, \sigma = \sigma_0)$</p>
<ul>
<li>自由度 $\nu$: 小さいほど裾野が広い。$3 \le \nu_0 \le 7 $ で適当に固定。</li>
<li>スケール $\sigma$: 「推定したい値は$[-\sigma_0, \sigma_0]$に収まるだろう」という値。</li>
</ul>
<p><img src="figure/student_t-1.png" alt="plot of chunk student_t"></p>
<p>正の値しか取らない場合は <code>&lt;lower=0&gt;</code> として右半分だけ使うとか。</p>

</section>
<section>
<h2 id="-階層ベイズモデルの練習問題">🔰 階層ベイズモデルの練習問題</h2>
<p><a href="6-stan-hbm.ipynb"><code>6-stan-hbm.ipynb</code></a>
をJupyterで開き、スライド説明に沿って実行していこう。</p>
<p>TODO: 時間が余った場合の練習問題</p>

</section>
<section>
<h2 id="非線形回帰の例-データ">非線形回帰の例: データ</h2>
<p>刺激強度xに対する応答強度yを20個体調査。<br>
非対称なひと山。応答変数も説明変数も正の値。</p>
<div>\[\begin{split}
y = ae ^ {-bx} - ce ^ {-dx}
\end{split}\]</div>
<p><img src="figure/non-linear-1.png" alt="plot of chunk non-linear"></p>

</section>
<section>
<h2 id="非線形回帰の例-stanコード">非線形回帰の例: Stanコード</h2>
<pre tabindex="0"><code class="language-stan" data-lang="stan">data {
  int&lt;lower=1&gt; N;
  vector[N] x;
  vector[N] y;
  int id[N];
  int&lt;lower=1&gt; Ninds;
}

parameters {
  real a;
  real d;
  real&lt;upper=a&gt; c;
  real&lt;upper=d&gt; b;
  real shape;
  vector[Ninds] intercept;
}

model {
  vector[N] mu = a * exp(-b * x) - (a - c) * exp(-d * x) + intercept[id];
  y ~ gamma(shape, shape ./ mu);
  a ~ exponential(1);
  b ~ exponential(1);
  c ~ exponential(1);
  d ~ exponential(1);
  shape ~ exponential(0.001);
  intercept ~ normal(0, 0.005);
}
</code></pre>
</section>
<section>
<h2 id="階層ベイズモデルのほかの応用先">階層ベイズモデルのほかの応用先</h2>
<ul>
<li>時系列モデル (状態空間モデル)</li>
<li>空間構造のあるモデル (e.g., CARモデル)</li>
<li>欠損値の補完</li>
</ul>

</section>
<section>
<h2 id="ベイズ推定まとめ">ベイズ推定まとめ</h2>
<ul>
<li>条件付き確率 $\text{Prob}(B \mid A)$ の理解が大事。
<ul>
<li>事後分布 $\propto$ 尤度 ⨉ 事前分布</li>
<li>確信度合いをデータで更新していく。</li>
</ul>
</li>
<li>推定結果は分布そのもの。
<ul>
<li>そこから点推定も区間推定も可能。</li>
</ul>
</li>
<li>解析的に解けない問題は計算機に乱数を振らせて解く。
<ul>
<li>理論・技術の進歩が目覚ましい。</li>
</ul>
</li>
</ul>

</section>
<section>
<h2 id="回帰分析ふりかえり">回帰分析ふりかえり</h2>
<p>より柔軟にモデルを記述できるようになった。計算方法も変化。</p>
<figure>
<a href="https://kuboweb.github.io/-kubo/ce/LinksGlm.html">
<img src="../tokiomarine2021/image/kubo-p2.png" width="100%">
<figcaption class="url">久保さん https://kuboweb.github.io/-kubo/ce/LinksGlm.html</figcaption>
</a>
</figure>

</section>
<section>
<h2 id="全体まとめ">全体まとめ</h2>
<ul>
<li>統計とは、データをうまくまとめ、それに基づいて推論するための手法。</li>
<li>モデルには<strong>理解志向</strong>と<strong>応用志向</strong>があり、統計モデルは前者寄り。
<ul>
<li>どちらも多少は分かった上で使い分けたい。</li>
<li>どっちにしろ真の正しい何かではない。</li>
</ul>
</li>
<li><strong>確率分布</strong>とその背後にある<strong>確率過程</strong>の理解が重要。
<ul>
<li>乱数生成→作図を繰り返してイメージを掴もう。</li>
<li>MCMCサンプリングも事後分布からの乱数生成。</li>
</ul>
</li>
</ul>

</section>
<section>
<h2 id="参考文献">参考文献</h2>
<ul>
<li><a href="https://amzn.to/33suMIZ">データ解析のための統計モデリング入門</a> 久保拓弥 2012</li>
<li><a href="https://amzn.to/3uwx7Pb">StanとRでベイズ統計モデリング</a> 松浦健太郎 2016</li>
<li><a href="https://amzn.to/3o1eCzP">RとStanではじめる ベイズ統計モデリングによるデータ分析入門</a> 馬場真哉 2019</li>
<li><a href="https://amzn.to/3uCxTKo">データ分析のための数理モデル入門</a> 江崎貴裕 2020</li>
<li><a href="https://amzn.to/3uznzCK">分析者のためのデータ解釈学入門</a> 江崎貴裕 2020</li>
<li><a href="https://amzn.to/3ty80Kv">統計学を哲学する</a> 大塚淳 2020</li>
</ul>
<a href="." class="readmore">
目次に戻る
</a>

</section>
</div>
</div>
<script src="/slides/lib/reveal.js/reveal.js"></script>
<script src="/slides/lib/reveal.js/plugin/notes.js"></script>
<script>
Reveal.initialize({
  width: 960,
  height: 720,
  margin: 0,
  controls: true,
  controlsLayout: 'bottom-right',
  controlsTutorial: false,
  controlsBackArrows: 'faded',
  progress: false,
  slideNumber: 'c/t',
  showSlideNumber: 'all',
  hashOneBasedIndex: true,
  hash: true,
  history: false,
  keyboard: true,
  overview: true,
  center: false,
  touch: true,
  loop: false,
  rtl: false,
  navigationMode: 'linear',
  shuffle: false,
  fragments: true,
  fragmentInURL: true,
  embedded: false,
  help: true,
  showNotes: false,
  autoPlayMedia: null,
  preloadIframes: null,
  mouseWheel: false,
  previewLinks: false,
  transition: 'none',
  transitionSpeed: 'fast',
  backgroundTransition: 'none',
  pdfMaxPagesPerSlide: 1,
  pdfSeparateFragments: false,
  viewDistance: 2,
  plugins: [ RevealNotes ]
});
</script>
<script>
{
const reload_all_img = function() {
  const imgs = document.getElementsByTagName("img");
  for (let i = 0; i < imgs.length; ++i) {
    const src = imgs[i].src;
    imgs[i].src += "?q";
    imgs[i].src = src;
  }
};
const reload_src_element = function(ev) {
  const original_src = ev.srcElement.src;
  ev.srcElement.src += "?q";
  ev.srcElement.src = original_src;
};
const reload_src = function(ev) {
  if (ev.shiftKey || ev.metaKey || ev.altKey) {
    reload_all_img();
  } else {
    reload_src_element(ev);
  }
};
const img_elements = document.getElementsByTagName("img");
for (let i = 0; i < img_elements.length; ++i) {
  img_elements[i].onclick = reload_src;
}
};
</script>
</body>
</html>
