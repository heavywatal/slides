<!DOCTYPE html>
<html>
<head prefix="og: http://ogp.me/ns#">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<title>5. Stanã§GLM â€” çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°æ¦‚è«– DSHC 2022</title>
<link rel="stylesheet" href="/slides/lib/reveal.js/reveal.css">
<link rel="stylesheet" href="/slides/css/theme-reveal.css">
<meta name="author" content="Watal M. Iwasaki">
<meta property="og:title" content="5. Stanã§GLM â€” çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°æ¦‚è«– DSHC 2022">
<meta property="og:type" content="article">
<meta property="og:url" content="https://heavywatal.github.io/slides/tokiomarine2022/5-stan-glm.html">
<meta property="og:image" content="https://avatars.githubusercontent.com/heavywatal">
<meta property="og:description" content="">
<meta property="og:site_name" content="Slide decks â€” Heavy Watal">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@heavywatal">
<meta name="twitter:creator" content="@heavywatal">
<meta name="generator" content="Hugo 0.96.0" />
<link rel="stylesheet" href="/lib/katex/katex.min.css">
<script defer src="/lib/katex/katex.min.js"></script>
<script defer src="/lib/katex/contrib/auto-render.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  renderMathInElement(document.body, {
    delimiters: [
      {left: "\\[", right: "\\]", display: true},
      {left: "$", right: "$", display: false}
    ]
  });
});
</script>
<style>
.katex {
  font-size: 1.12em;
}

.katex-display > .katex {
  text-align: left;
  padding-left: 2rem;
}
</style>

<script defer src="https://use.fontawesome.com/releases/v5.8.2/js/all.js" integrity="sha384-DJ25uNYET2XCl5ZF++U8eNxPWqcKohUUBUpKGlNLMchM7q4Wjg2CUpjHLaL8yYPH" crossorigin="anonymous"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-V60H2JH0G6"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-V60H2JH0G6', { 'anonymize_ip': false });
}
</script>

</head>
<body>
<div class="reveal">
<div class="slides">
<section>
<link rel="stylesheet" href="style.css">
<h1 id="çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°æ¦‚è«–-dshc-2022"><a href=".">çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°æ¦‚è«– DSHC 2022</a></h1>
<div class="author">
å²©åµœ èˆª (Watal M. Iwasaki, PhD)
</div>
<div class="affiliation">
æ±åŒ—å¤§å­¦ ç”Ÿå‘½ç§‘å­¦ç ”ç©¶ç§‘ é€²åŒ–ã‚²ãƒãƒŸã‚¯ã‚¹åˆ†é‡ ç‰¹ä»»åŠ©æ•™<br>
(Graduate School of Life Sciences, Tohoku University)
</div>
<ol>
<li><a href="1-introduction.html">å°å…¥</a>
<li><a href="2-stats-model.html">çµ±è¨ˆãƒ¢ãƒ‡ãƒ«ã®åŸºæœ¬: ç¢ºç‡åˆ†å¸ƒã€å°¤åº¦</a>
<li><a href="3-glm.html">ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã€æ··åˆãƒ¢ãƒ‡ãƒ«</a>
<li><a href="4-bayesian.html">ãƒ™ã‚¤ã‚ºæ¨å®šã¨MCMC</a>
<li class="current-deck"><a href="5-stan-glm.html">Stanã§GLM</a>
<li><a href="6-stan-hbm.html">Stanã§éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«</a>
</ol>
<div class="footnote">
2022-08-24 æ±äº¬æµ·ä¸Š Data Science Hill Climb
<a href="https://heavywatal.github.io/slides/tokiomarine2022/">https://heavywatal.github.io/slides/tokiomarine2022/</a>
</div>

</section>
<section>
<h2 id="stan">Stan</h2>
<a href="https://mc-stan.org/">
<img src="/slides/image/stan/logo_name.png" width="120" align="right">
</a>
<ul>
<li>Stanè¨€èªã§ãƒ¢ãƒ‡ãƒ«ã‚’æ›¸ã</li>
<li>C++ã‚’ä»‹ã—ã¦æ©Ÿæ¢°èªã«ç¿»è¨³(ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«)ã™ã‚‹ã®ã§é«˜é€Ÿ</li>
<li>Rã‚„Pythonãªã©ã‹ã‚‰å‘¼ã³å‡ºã—ã¦ä½¿ã†ã®ãŒä¾¿åˆ©</li>
</ul>
<p>å¤§éƒ¨åˆ†ã¯Rã§èª¬æ˜ã—ã€éƒ¨åˆ†çš„ã«Pythonã§ã®ç·´ç¿’ã‚’æŒŸã¿ã¾ã™ã€‚<br></p>
<p>èããªãŒã‚‰æ‰‹å…ƒã§<a href="tokiomarine2022-stan.ipynb">tokiomarine2022-stan.ipynb</a>ã‚’å®Ÿè¡Œã—ã¦ã‚‚ã„ã„ã§ã™ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># install.packages(&#34;rstan&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="nf">library</span><span class="p">(</span><span class="n">rstan</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">rstan_options</span><span class="p">(</span><span class="n">auto_write</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
</span></span></code></pre></div>
</section>
<section>
<h2 id="ãŠãŠã¾ã‹ãªæµã‚Œ">ãŠãŠã¾ã‹ãªæµã‚Œ</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># ãƒ‡ãƒ¼ã‚¿æº–å‚™</span>
</span></span><span class="line"><span class="cl"><span class="n">mydata</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Stanè¨€èªã§æ›¸ã„ãŸãƒ¢ãƒ‡ãƒ«ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«</span>
</span></span><span class="line"><span class="cl"><span class="n">model</span> <span class="o">=</span> <span class="n">rstan</span><span class="o">::</span><span class="nf">stan_model</span><span class="p">(</span><span class="n">file</span> <span class="o">=</span> <span class="s">&#34;model.stan&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°</span>
</span></span><span class="line"><span class="cl"><span class="n">fit</span> <span class="o">=</span> <span class="n">rstan</span><span class="o">::</span><span class="nf">sampling</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">mydata</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># çµæœã‚’çœºã‚ã‚‹</span>
</span></span><span class="line"><span class="cl"><span class="nf">print</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rstan</span><span class="o">::</span><span class="nf">stan_trace</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rstan</span><span class="o">::</span><span class="nf">stan_hist</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rstan</span><span class="o">::</span><span class="nf">stan_ac</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
</span></span></code></pre></div>
</section>
<section>
<h2 id="èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š-ãƒ‡ãƒ¼ã‚¿æº–å‚™">èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š: ãƒ‡ãƒ¼ã‚¿æº–å‚™</h2>
<p>è¡¨ãŒå‡ºã‚‹ç¢ºç‡ $p=0.7$ ã®ã‚¤ã‚«ã‚µãƒã‚³ã‚¤ãƒ³ã‚’Nå›æŠ•ã’ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½œã‚‹ã€‚<br>
ã“ã® $p$ ã‚’Stanã§æ¨å®šã—ã¦ã¿ã‚ˆã†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">true_p</span> <span class="o">=</span> <span class="m">0.7</span>
</span></span><span class="line"><span class="cl"><span class="n">N</span> <span class="o">=</span> <span class="m">40L</span>
</span></span><span class="line"><span class="cl"><span class="n">mydata</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">N</span> <span class="o">=</span> <span class="n">N</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="nf">rbinom</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="n">true_p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="nf">print</span><span class="p">(</span><span class="n">mydata</span><span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code>$N
[1] 40

$x
 [1] 0 0 1 0 1 1 0 1 1 0 1 0 0 1 1 0 0 1 1 1 0 1 0 0 1 1 1 0 1 0 0 0 1 1 1 0 1 1 0 1
</code></pre><p>Rãªã‚‰listå‹ã€Pythonãªã‚‰dictå‹ã«ã¾ã¨ã‚ã¦Stanã«æ¸¡ã™ã€‚</p>

</section>
<section>
<h2 id="èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š-stanè¨€èªã§ãƒ¢ãƒ‡ãƒ«å®šç¾©">èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š: Stanè¨€èªã§ãƒ¢ãƒ‡ãƒ«å®šç¾©</h2>
<p>æ–‡å­—åˆ—ã¨ã—ã¦ä¿æŒã™ã‚‹ã‹ã€åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ã„ã¦ãŠã:</p>
<pre tabindex="0"><code>data {
  int&lt;lower=0&gt; N;
  int x[N];
}

parameters {
  real&lt;lower=0,upper=1&gt; p;
}

model {
  x ~ binomial(1, p);
}
</code></pre><ul>
<li>ã„ãã¤ã‹ã®ãƒ–ãƒ­ãƒƒã‚¯ã«åˆ†ã‘ã¦è¨˜è¿°ã™ã‚‹:<br>
R/Pythonã‹ã‚‰å—ã‘å–ã‚‹ <code>data</code>, æ¨å®šã™ã‚‹ <code>parameter</code>, æœ¬ä½“ã® <code>model</code>.</li>
<li>æ•´æ•°å‹ <code>int</code>, å®Ÿæ•°å‹ <code>real</code>, ãã‚Œã‚‰ã®é…åˆ—ãŒã‚ã‚‹ã€‚</li>
<li>ä¸‹é™ <code>lower</code>, ä¸Šé™ <code>upper</code> ã‚’è¨­å®šã§ãã‚‹ã€‚</li>
</ul>

</section>
<section>
<h2 id="stanè¨€èªã®7ç¨®ã®ãƒ–ãƒ­ãƒƒã‚¯">Stanè¨€èªã®7ç¨®ã®ãƒ–ãƒ­ãƒƒã‚¯</h2>
<p>é †ç•ªå³å®ˆã€‚ã‚ˆãä½¿ã†ã®ã¯<strong>å¤ªå­—ã®ã‚„ã¤</strong>ã€‚</p>
<ol>
<li><code>functions {...}</code></li>
<li><strong><code>data {...}</code></strong></li>
<li><code>transformed data {...}</code></li>
<li><strong><code>parameters {...}</code></strong></li>
<li><code>transformed parameters {...}</code></li>
<li><strong><code>model {...}</code></strong></li>
<li><code>generated quantities {...}</code></li>
</ol>
<p><a href="https://mc-stan.org/docs/reference-manual/overview-of-stans-program-blocks.html">https://mc-stan.org/docs/reference-manual/overview-of-stans-program-blocks.html</a></p>

</section>
<section>
<h2 id="èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š-mcmcã‚µãƒ³ãƒ—ãƒ«">èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š: MCMCã‚µãƒ³ãƒ—ãƒ«</h2>
<p>äºˆã‚å®Ÿè¡Œé€Ÿåº¦ã®é€Ÿã„æ©Ÿæ¢°èªã«ç¿»è¨³(ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">model</span> <span class="o">=</span> <span class="n">rstan</span><span class="o">::</span><span class="nf">stan_model</span><span class="p">(</span><span class="s">&#34;binom.stan&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>ã“ã‚Œã«çµæ§‹æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã§ã€å¤‰æ›´ãŒç„¡ã‘ã‚Œã°å†åˆ©ç”¨ã™ã‚‹ãŸã‚å…ˆã»ã©
<code>rstan_options(auto_write = TRUE)</code> ã—ã¦ãŠã„ãŸã€‚</p>
<hr>
<p>ãƒ¢ãƒ‡ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">fit</span> <span class="o">=</span> <span class="n">rstan</span><span class="o">::</span><span class="nf">sampling</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">mydata</span><span class="p">)</span>
</span></span></code></pre></div><p>ã„ã‚ã„ã‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã‚ã‚‹ã‘ã©ã¨ã‚Šã‚ãˆãšãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§:<br>
<code>chains = 4</code>, <code>iter = 2000</code>, <code>warmup = floor(iter/2)</code>, <code>thin = 1</code>, &hellip;</p>
<p>å•é¡ŒãŒã‚ã£ãŸã‚‰å®Ÿè¡Œçµ‚äº†æ™‚ã«è­¦å‘Šã—ã¦ãã‚Œã‚‹ã®ã§<strong>ã¡ã‚ƒã‚“ã¨èª­ã‚€</strong>ã€‚</p>

</section>
<section>
<h2 id="èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š-çµæœã‚’çœºã‚ã‚‹">èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š: çµæœã‚’çœºã‚ã‚‹</h2>
<p>$\hat R$ ã‚‚ã»ã¼1ã§ $N_\text{eff}$ ã‚‚å¤§ãã„ã®ã§ã‚ˆã•ãã†ã€‚<br>
å¿µã®ãŸã‚ trace plot ã‚‚ç¢ºèªã—ã¦ãŠã“ã†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">print</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code>Inference for Stan model: binom.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

       mean se_mean   sd   2.5%    25%    50%    75%  97.5% n_eff Rhat
p      0.55    0.00 0.08   0.39   0.50   0.55   0.60   0.69  1651    1
lp__ -29.45    0.02 0.76 -31.61 -29.61 -29.16 -28.97 -28.92  1262    1

Samples were drawn using NUTS(diag_e) at Wed Jun  8 09:32:06 2022.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).
</code></pre><p>ä¹±æ•°ã‚’ä½¿ã£ãŸè¨ˆç®—ãªã®ã§(ä¹±æ•°ã‚·ãƒ¼ãƒ‰ã‚’å›ºå®šã—ãªã„é™ã‚Š)æ¯å›å¤‰ã‚ã‚‹ã€‚</p>

</section>
<section>
<h2 id="èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š-trace-plot-ç¢ºèª">èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š: trace plot ç¢ºèª</h2>
<p>ã©ã®chainã‚‚ä¼¼ãŸç¯„å›²ã‚’å‹•ã„ã¦ã„ã¦ã€ã—ã£ã‹ã‚Šæ¯›è™«ã£ã½ã„:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">rstan</span><span class="o">::</span><span class="nf">stan_trace</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
</span></span></code></pre></div><p><img src="figure/stan-binom-traceplot-1.png" alt="plot of chunk stan-binom-traceplot"></p>

</section>
<section>
<h2 id="èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š-è‡ªå·±ç›¸é–¢ã®ç¢ºèª">èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š: è‡ªå·±ç›¸é–¢ã®ç¢ºèª</h2>
<p>2&ndash;3ã‚¹ãƒ†ãƒƒãƒ—ãã‚‰ã„ã§è‡ªå·±ç›¸é–¢ãŒã»ã¼æ¶ˆãˆã‚‹ã®ã§å•é¡Œãªã—:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">rstan</span><span class="o">::</span><span class="nf">stan_ac</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">pars</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;p&#34;</span><span class="p">))</span>
</span></span></code></pre></div><p><img src="figure/stan-binom-ac-1.png" alt="plot of chunk stan-binom-ac"></p>

</section>
<section>
<h2 id="èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š-æ¨å®šçµæœç¢ºèª">èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š: æ¨å®šçµæœç¢ºèª</h2>
<p>ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºNãŒå°ã•ã„ã›ã„ã‹è£¾é‡ã®åºƒã„æ¨å®šçµæœã€‚<br>
çœŸã®$p$ã®å€¤ã‚‚å«ã¾ã‚Œã¦ã„ã‚‹:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">rstan</span><span class="o">::</span><span class="nf">stan_hist</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="m">30</span><span class="p">)</span>
</span></span></code></pre></div><p><img src="figure/stan-binom-hist-1.png" alt="plot of chunk stan-binom-hist"></p>
<p>æ¬¡ã¯ã‚‚ã†å°‘ã—ã ã‘è¤‡é›‘ãªä¾‹ã‚’è¦‹ã¦ã¿ã‚ˆã†ã€‚</p>

</section>
<section>
<h2 id="ç·šå½¢å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š-ãƒ‡ãƒ¼ã‚¿æº–å‚™">ç·šå½¢å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: ãƒ‡ãƒ¼ã‚¿æº–å‚™</h2>
<a href="https://allisonhorst.github.io/palmerpenguins/">
<cite>https://allisonhorst.github.io/palmerpenguins/</cite><br>
<img src="/slides/image/rstats/lter_penguins.png" width="45%">
<img src="/slides/image/rstats/culmen_depth.png" width="45%">
</a>
<p><img src="figure/stan-penguins-glm-1.png" alt="plot of chunk stan-penguins-glm">
</section>
<section>
<h2 id="ç·šå½¢å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š-ãƒ‡ãƒ¼ã‚¿æº–å‚™">ç·šå½¢å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: ãƒ‡ãƒ¼ã‚¿æº–å‚™</h2>
<a href="https://allisonhorst.github.io/palmerpenguins/">
<cite>https://allisonhorst.github.io/palmerpenguins/</cite><br>
<img src="/slides/image/rstats/lter_penguins.png" width="45%">
<img src="/slides/image/rstats/culmen_depth.png" width="45%">
</a>
<p><code>Stan does not support NA</code> ã¨æ€’ã‚‰ã‚Œã‚‹ã®ã§æ¬ æå€¤ã‚’å–ã‚Šé™¤ã„ã¦ãŠã:</p>
<pre tabindex="0"><code>List of 3
 $ body_mass_g      : int [1:342] 3750 3800 3250 3450 3650 3625 4675 3475 4250 3300 ...
 $ flipper_length_mm: int [1:342] 181 186 195 193 190 181 195 193 190 186 ...
 $ N                : int 342
</code></pre>
</section>
<section>
<h2 id="å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š-stanè¨€èªã§ãƒ¢ãƒ‡ãƒ«å®šç¾©">å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: Stanè¨€èªã§ãƒ¢ãƒ‡ãƒ«å®šç¾©</h2>
<p>åˆ‡ç‰‡ã€å‚¾ãã€ã°ã‚‰ã¤ãã‚’æ¨å®šã™ã‚‹:</p>
<pre tabindex="0"><code>data {
  int&lt;lower=0&gt; N;
  vector&lt;lower=0&gt;[N] body_mass_g;
  vector&lt;lower=0&gt;[N] flipper_length_mm;
}

parameters {
  real intercept;
  real slope;
  real&lt;lower=0&gt; sigma;
}

model {
  flipper_length_mm ~ normal(intercept + slope * body_mass_g, sigma);
}
</code></pre>
</section>
<section>
<h2 id="å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š-mcmcã‚µãƒ³ãƒ—ãƒ«">å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: MCMCã‚µãƒ³ãƒ—ãƒ«</h2>
<p>äºˆã‚å®Ÿè¡Œé€Ÿåº¦ã®é€Ÿã„æ©Ÿæ¢°èªã«ç¿»è¨³(ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">model</span> <span class="o">=</span> <span class="n">rstan</span><span class="o">::</span><span class="nf">stan_model</span><span class="p">(</span><span class="s">&#34;penguins.stan&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>ãƒ¢ãƒ‡ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">fit</span> <span class="o">=</span> <span class="n">rstan</span><span class="o">::</span><span class="nf">sampling</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">mydata</span><span class="p">)</span>
</span></span></code></pre></div><p>ã„ã‚ã„ã‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã‚ã‚‹ã‘ã©ã¨ã‚Šã‚ãˆãšãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§:<br>
<code>chains = 4</code>, <code>iter = 2000</code>, <code>warmup = floor(iter/2)</code>, <code>thin = 1</code>, &hellip;</p>
<p>å•é¡ŒãŒã‚ã£ãŸã‚‰å®Ÿè¡Œçµ‚äº†æ™‚ã«è­¦å‘Šã—ã¦ãã‚Œã‚‹ã®ã§<strong>ã¡ã‚ƒã‚“ã¨èª­ã‚€</strong>ã€‚</p>

</section>
<section>
<h2 id="å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š-çµæœã‚’çœºã‚ã‚‹">å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: çµæœã‚’çœºã‚ã‚‹</h2>
<p>$\hat R$ ã‚‚ã»ã¼1ã§ $N_\text{eff}$ ã‚‚å¤§ãã„ã®ã§ã‚ˆã•ãã†ã€‚<br>
å¿µã®ãŸã‚ trace plot ã‚‚ç¢ºèªã—ã¦ãŠã“ã†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">print</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code>Inference for Stan model: penguins.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

             mean se_mean   sd    2.5%     25%     50%     75%   97.5% n_eff Rhat
intercept  136.76    0.05 1.97  132.89  135.40  136.75  138.04  140.67  1506    1
slope        0.02    0.00 0.00    0.01    0.01    0.02    0.02    0.02  1526    1
sigma        6.94    0.01 0.27    6.41    6.76    6.94    7.13    7.47  1198    1
lp__      -830.83    0.04 1.24 -834.08 -831.39 -830.51 -829.93 -829.43  1120    1

Samples were drawn using NUTS(diag_e) at Wed Jun  8 09:32:31 2022.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).
</code></pre>
</section>
<section>
<h2 id="å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š-trace-plot-ç¢ºèª">å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: trace plot ç¢ºèª</h2>
<p>ã©ã®chainã‚‚ä¼¼ãŸç¯„å›²ã‚’å‹•ã„ã¦ã„ã¦ã€ã—ã£ã‹ã‚Šæ¯›è™«ã£ã½ã„:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">rstan</span><span class="o">::</span><span class="nf">stan_trace</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
</span></span></code></pre></div><p><img src="figure/stan-penguins-traceplot-1.png" alt="plot of chunk stan-penguins-traceplot"></p>

</section>
<section>
<h2 id="å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š-è‡ªå·±ç›¸é–¢ã®ç¢ºèª">å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: è‡ªå·±ç›¸é–¢ã®ç¢ºèª</h2>
<p>ã©ã‚Œã‚‚ã¾ã‚ã¾ã‚ã™ãæ¶ˆãˆã‚‹ã®ã§å•é¡Œãªã—:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">rstan</span><span class="o">::</span><span class="nf">stan_ac</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">pars</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;intercept&#34;</span><span class="p">,</span> <span class="s">&#34;slope&#34;</span><span class="p">,</span> <span class="s">&#34;sigma&#34;</span><span class="p">))</span>
</span></span></code></pre></div><p><img src="figure/stan-penguins-ac-1.png" alt="plot of chunk stan-penguins-ac"></p>

</section>
<section>
<h2 id="å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š-æ¨å®šçµæœç¢ºèª">å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: æ¨å®šçµæœç¢ºèª</h2>
<p>æ­£è¦åˆ†å¸ƒã£ã½ã„ãã‚Œã„ãªå½¢:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">rstan</span><span class="o">::</span><span class="nf">stan_hist</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="m">30</span><span class="p">)</span>
</span></span></code></pre></div><p><img src="figure/stan-penguins-hist-1.png" alt="plot of chunk stan-penguins-hist"></p>
<p>ã“ã‚Œã‚‰ã®å€¤ã‚’ä½¿ã£ã¦ç‚¹æ¨å®šãƒ»åŒºé–“æ¨å®šã‚‚å¯èƒ½ã€‚</p>

</section>
<section>
<h2 id="å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š-æ¨å®šçµæœã§å›å¸°">å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: æ¨å®šçµæœã§å›å¸°</h2>
<p>ç„¡äº‹ã«æœ€å°¤æ¨å®šã¨ä¼¼ãŸã‚ˆã†ãªç·šãŒå¼•ã‘ãŸã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">coef</span> <span class="o">=</span> <span class="n">rstan</span><span class="o">::</span><span class="nf">get_posterior_mean</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span><span class="n">[</span><span class="p">,</span> <span class="s">&#34;mean-all chains&#34;</span><span class="n">]</span>
</span></span><span class="line"><span class="cl"><span class="n">p_penweight</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="nf">geom_abline</span><span class="p">(</span><span class="n">intercept</span> <span class="o">=</span> <span class="n">coef[</span><span class="s">&#34;intercept&#34;</span><span class="n">]</span><span class="p">,</span> <span class="n">slope</span> <span class="o">=</span> <span class="n">coef[</span><span class="s">&#34;slope&#34;</span><span class="n">]</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#34;#3366ff&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p><img src="figure/stan-penguins-regression-1.png" alt="plot of chunk stan-penguins-regression"></p>

</section>
<section>
<h2 id="-å˜å›å¸°ã®ç·´ç¿’å•é¡Œ">ğŸ”° å˜å›å¸°ã®ç·´ç¿’å•é¡Œ</h2>
<p>TODO</p>
<hr>
<p>â˜•ï¸ ä¼‘æ†© + è³ªç–‘å¿œç­”</p>

</section>
<section>
<h2 id="stanã§é‡å›å¸°">Stanã§é‡å›å¸°</h2>
<p>TODO</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">fit</span> <span class="o">=</span> <span class="n">rstanarm</span><span class="o">::</span><span class="nf">stan_glm</span><span class="p">(</span><span class="n">flipper_length_mm</span> <span class="o">~</span> <span class="n">body_mass_g</span> <span class="o">+</span> <span class="n">species</span><span class="p">,</span> <span class="n">family</span> <span class="o">=</span> <span class="nf">gaussian</span><span class="p">(),</span> <span class="n">data</span> <span class="o">=</span> <span class="n">penguins</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pred</span> <span class="o">=</span> <span class="n">penguins</span> <span class="o">%&gt;%</span> <span class="n">tidyr</span><span class="o">::</span><span class="nf">drop_na</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="n">tidybayes</span><span class="o">::</span><span class="nf">add_fitted_draws</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p_penweight</span> <span class="o">+</span> <span class="nf">aes</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="n">species</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="n">species</span><span class="p">)</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="n">ggdist</span><span class="o">::</span><span class="nf">stat_lineribbon</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="n">.value</span><span class="p">),</span> <span class="n">data</span> <span class="o">=</span> <span class="n">pred</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">0.4</span><span class="p">)</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="nf">scale_color_manual</span><span class="p">(</span><span class="n">values</span> <span class="o">=</span> <span class="n">penguins_colors</span><span class="p">)</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="nf">scale_fill_brewer</span><span class="p">(</span><span class="n">palette</span> <span class="o">=</span> <span class="s">&#34;Greys&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p><img src="figure/rstanarm-penguins-multi-1.png" alt="plot of chunk rstanarm-penguins-multi"></p>

</section>
<section>
<h2 id="-stanã§é‡å›å¸°ã®ç·´ç¿’å•é¡Œ">ğŸ”° Stanã§é‡å›å¸°ã®ç·´ç¿’å•é¡Œ</h2>
<p>TODO</p>
<hr>
<p>â˜•ï¸ ä¼‘æ†© + è³ªç–‘å¿œç­”</p>

</section>
<section>
<h2 id="stanã§ãƒã‚¢ã‚½ãƒ³å›å¸°">Stanã§ãƒã‚¢ã‚½ãƒ³å›å¸°</h2>
<p>TODO</p>
<img src="figure/glm-poisson-1.png">
</section>
<section>
<h2 id="-stanã§ãƒã‚¢ã‚½ãƒ³å›å¸°ã®ç·´ç¿’å•é¡Œ">ğŸ”° Stanã§ãƒã‚¢ã‚½ãƒ³å›å¸°ã®ç·´ç¿’å•é¡Œ</h2>
<p>TODO</p>
<hr>
<p>â˜•ï¸ ä¼‘æ†© + è³ªç–‘å¿œç­”</p>

</section>
<section>
<h2 id="stanã§ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°">Stanã§ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°</h2>
<p>TODO</p>
<img src="figure/glm-logistic-1.png">
</section>
<section>
<h2 id="-stanã§ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°">ğŸ”° Stanã§ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°</h2>
<p>TODO</p>
<hr>
<p>â˜•ï¸ ä¼‘æ†© + è³ªç–‘å¿œç­”</p>

</section>
<section>
<h2 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h2>
<ul>
<li><a href="https://amzn.to/33suMIZ">ãƒ‡ãƒ¼ã‚¿è§£æã®ãŸã‚ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€</a> ä¹…ä¿æ‹“å¼¥ 2012</li>
<li><a href="https://amzn.to/3uwx7Pb">Stanã¨Rã§ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°</a> æ¾æµ¦å¥å¤ªéƒ 2016</li>
<li><a href="https://amzn.to/3o1eCzP">Rã¨Stanã§ã¯ã˜ã‚ã‚‹ ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿åˆ†æå…¥é–€</a> é¦¬å ´çœŸå“‰ 2019</li>
<li><a href="https://amzn.to/3uCxTKo">ãƒ‡ãƒ¼ã‚¿åˆ†æã®ãŸã‚ã®æ•°ç†ãƒ¢ãƒ‡ãƒ«å…¥é–€</a> æ±Ÿå´è²´è£• 2020</li>
<li><a href="https://amzn.to/3uznzCK">åˆ†æè€…ã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿è§£é‡ˆå­¦å…¥é–€</a> æ±Ÿå´è²´è£• 2020</li>
<li><a href="https://amzn.to/3ty80Kv">çµ±è¨ˆå­¦ã‚’å“²å­¦ã™ã‚‹</a> å¤§å¡šæ·³ 2020</li>
</ul>
<a href="6-stan-hbm.html" rel="next" class="readmore">
6. Stanã§éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«
</a>

</section>
</div>
</div>
<script src="/slides/lib/reveal.js/reveal.js"></script>
<script src="/slides/lib/reveal.js/plugin/notes.js"></script>
<script>
Reveal.initialize({
  width: 960,
  height: 720,
  margin: 0,
  controls: true,
  controlsLayout: 'bottom-right',
  controlsTutorial: false,
  controlsBackArrows: 'faded',
  progress: false,
  slideNumber: 'c/t',
  showSlideNumber: 'all',
  hashOneBasedIndex: true,
  hash: true,
  history: false,
  keyboard: true,
  overview: true,
  center: false,
  touch: true,
  loop: false,
  rtl: false,
  navigationMode: 'linear',
  shuffle: false,
  fragments: true,
  fragmentInURL: true,
  embedded: false,
  help: true,
  showNotes: false,
  autoPlayMedia: null,
  preloadIframes: null,
  mouseWheel: false,
  previewLinks: false,
  transition: 'none',
  transitionSpeed: 'fast',
  backgroundTransition: 'none',
  pdfMaxPagesPerSlide: 1,
  pdfSeparateFragments: false,
  viewDistance: 2,
  plugins: [ RevealNotes ]
});
</script>
<script>
{
const reload_all_img = function() {
  const imgs = document.getElementsByTagName("img");
  for (let i = 0; i < imgs.length; ++i) {
    const src = imgs[i].src;
    imgs[i].src += "?q";
    imgs[i].src = src;
  }
};
const reload_src_element = function(ev) {
  const original_src = ev.srcElement.src;
  ev.srcElement.src += "?q";
  ev.srcElement.src = original_src;
};
const reload_src = function(ev) {
  if (ev.shiftKey || ev.metaKey || ev.altKey) {
    reload_all_img();
  } else {
    reload_src_element(ev);
  }
};
const img_elements = document.getElementsByTagName("img");
for (let i = 0; i < img_elements.length; ++i) {
  img_elements[i].onclick = reload_src;
}
};
</script>
</body>
</html>
