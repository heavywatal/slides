<!DOCTYPE html>
<html>
<head prefix="og: http://ogp.me/ns#">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<title>4. 階層ベイズモデル — 統計モデリング概論 DSHC 2021</title>
<link rel="stylesheet" href="/slides/lib/reveal.js/reveal.css">
<link rel="stylesheet" href="/slides/css/theme-reveal.css">
<meta name="author" content="Watal M. Iwasaki">
<meta property="og:title" content="4. 階層ベイズモデル — 統計モデリング概論 DSHC 2021">
<meta property="og:type" content="article">
<meta property="og:url" content="https://heavywatal.github.io/slides/tokiomarine2021/4-bayesian.html">
<meta property="og:image" content="https://avatars.githubusercontent.com/heavywatal">
<meta property="og:description" content="">
<meta property="og:site_name" content="Slide decks — Heavy Watal">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@heavywatal">
<meta name="twitter:creator" content="@heavywatal">
<meta name="generator" content="Hugo 0.83.1" />
<link rel="stylesheet" href="/lib/katex/katex.min.css">
<script defer src="/lib/katex/katex.min.js"></script>
<script defer src="/lib/katex/contrib/auto-render.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  renderMathInElement(document.body, {
    delimiters: [
      {left: "\\[", right: "\\]", display: true},
      {left: "$", right: "$", display: false}
    ]
  });
});
</script>
<style>
.katex {
  font-size: 1.12em;
}

.katex-display > .katex {
  text-align: left;
  padding-left: 2rem;
}
</style>

<script defer src="https://use.fontawesome.com/releases/v5.8.2/js/all.js" integrity="sha384-DJ25uNYET2XCl5ZF++U8eNxPWqcKohUUBUpKGlNLMchM7q4Wjg2CUpjHLaL8yYPH" crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-41178626-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
</head>
<body>
<div class="reveal">
<div class="slides">
<section>
<link rel="stylesheet" href="style.css">
<h1 id="統計モデリング概論-dshc-2021"><a href=".">統計モデリング概論 DSHC 2021</a></h1>
<div class="author">
岩嵜 航 (Watal M. Iwasaki, PhD)
</div>
<div class="affiliation">
東北大学 生命科学研究科 進化ゲノミクス分野 特任助教<br>
(Graduate School of Life Sciences, Tohoku University)
</div>
<ol>
<li><a href="1-introduction.html">導入</a>
<li><a href="2-stats-model.html">統計モデルの基本</a>
<li><a href="3-glm.html">一般化線形モデル</a>
<li class="current-deck"><a href="4-bayesian.html">階層ベイズモデル</a>
</ol>
<div class="footnote">
2021-06-30 東京海上 Data Science Hill Climb
<a href="https://heavywatal.github.io/slides/tokiomarine2021/">https://heavywatal.github.io/slides/tokiomarine2021/</a>
</div>

</section>
<section>
<h2 id="コイントス4回たまたま表が1回だったら">コイントス4回、たまたま表が1回だったら</h2>
<div class="column-container">
  <div class="column" style="flex-shrink: 1.0;">
<dl>
<dt>最尤推定</dt>
<dd>推定結果は最も尤もらしい1点。</dd>
<dd>データが少ないとき過剰適合気味。</dd>
<dd>表が出る確率 p = 0.25 のコインだろう。<br>
(信じ難いけどデータはこう言っている)</dd>
</dl>
<br>
<dl>
<dt>ベイズ推定</dt>
<dd>推定結果は確率分布そのもの。</dd>
<dd>データが少ないなりの不確実さも表現。</dd>
<dd>p = 0.25 らへんである確率は高いが、<br>
p = 0.6 とかである可能性もまあある。
</div>
<div class="column" style="flex-shrink: 1.4;">
</dd>
</dl>
<p><img src="figure/freq-vs-bayes-1.png" alt="plot of chunk freq-vs-bayes"><img src="figure/freq-vs-bayes-2.png" alt="plot of chunk freq-vs-bayes"></p>
  </div>
</div>

</section>
<section>
<h2 id="コイントスの回数が増えていったら">コイントスの回数が増えていったら</h2>
<p><strong>最尤推定</strong>: 推定値が真の値に近づいていく</p>
<p><img src="figure/coin-frequentist-1.png" alt="plot of chunk coin-frequentist"></p>
<p><strong>ベイズ推定</strong>: 確率分布がどんどん尖り、確信が強まる</p>
<p><img src="figure/coin-bayesian-1.png" alt="plot of chunk coin-bayesian"></p>

</section>
<section>
<h2 id="確率おさらい">確率おさらい</h2>
<dl>
<dt>同時分布/結合確率: <span style="font-weight: normal;"> <span style="color: #E69F00;">A</span>かつ<span style="color: #0072B2;">B</span>の確率</span></dt>
<dd>$\text{Prob}(\textcolor{#E69F00}{A}, \textcolor{#0072B2}{B}) = \text{Prob}(\textcolor{#E69F00}{A} \cap \textcolor{#0072B2}{B}) = \text{Prob}(\textcolor{#E69F00}{A}) \text{Prob}(\textcolor{#0072B2}{B})$</dd>
<dt>周辺確率: <span style="font-weight: normal;"> <span style="color: #0072B2;">B</span>によらず<span style="color: #E69F00;">A</span>になる確率</span></dt>
<dd>$\text{Prob}(\textcolor{#E69F00}{A}) = \sum_{\textcolor{#0072B2}{B}} \text{Prob}(\textcolor{#E69F00}{A}, \textcolor{#0072B2}{B})$</dd>
<dt>条件付き確率: <span style="font-weight: normal;"> <span style="color: #0072B2;">B</span>である条件の下で<span style="color: #E69F00;">A</span>になる確率。重要。</span></dt>
<dd>$\text{Prob}(\textcolor{#E69F00}{A} \mid \textcolor{#0072B2}{B}) = \frac {\text{Prob}(\textcolor{#E69F00}{A}, \textcolor{#0072B2}{B})} {\text{Prob}(\textcolor{#0072B2}{B})}$</dd>
</dl>
<p><img src="figure/venn-1.png" alt="plot of chunk venn">
</section>
<section>
<h2 id="条件付き確率がよくわかる具体例">条件付き確率がよくわかる具体例</h2>
<dl>
<dt><span style="color: #0072B2;">B Brewery</span>のビールが<span style="color: #E69F00;">Awesome</span>な確率</dt>
<dd>$\text{Prob}(\textcolor{#E69F00}{\text{Awesome}} \mid \textcolor{#0072B2}{\text{B Brewery}}) = \frac {\text{Prob}(\textcolor{#E69F00}{\text{Awesome}},~\textcolor{#0072B2}{\text{B Brewery}})} {\text{Prob}(\textcolor{#0072B2}{\text{B Brewery}})}$</dd>
<dd>かなり高い確率。良い醸造所。</dd>
<dt><span style="color: #E69F00;">Awesome</span>なビールが<span style="color: #0072B2;">B Brewery</span>のものである確率</dt>
<dd>$\text{Prob}(\textcolor{#0072B2}{\text{B Brewery}} \mid \textcolor{#E69F00}{\text{Awesome}}) = \frac {\text{Prob}(\textcolor{#E69F00}{\text{Awesome}},~\textcolor{#0072B2}{\text{B Brewery}})} {\text{Prob}(\textcolor{#E69F00}{\text{Awesome}})}$</dd>
<dd>かなり低い確率。Awesomeなビールはほかにもたっくさんある。</dd>
</dl>
<img src="figure/venn-1.png" alt="plot of chunk venn">

</section>
<section>
<h2 id="ベイズの定理">ベイズの定理</h2>
<dl>
<dt>乗法定理</dt>
<dd>$\text{Prob}(\textcolor{#E69F00}{A},~\textcolor{#0072B2}{B}) = \text{Prob}(\textcolor{#E69F00}{A} \mid \textcolor{#0072B2}{B})~\text{Prob}(\textcolor{#0072B2}{B}) = \text{Prob}(\textcolor{#0072B2}{B} \mid \textcolor{#E69F00}{A})~\text{Prob}(\textcolor{#E69F00}{A})$</dd>
</dl>
<a href="https://en.wikipedia.org/wiki/Thomas_Bayes">
<img src="figure/Thomas_Bayes.gif" height="150" align="right"></a>
<p>移項するだけで<strong>ベイズの定理</strong>:
<img src="bayes.drawio.svg" style="padding-left: 1rem;"></p>
<p>宴会場にビールが運ばれてきた。これはどこのブルワリーの？</p>
<dl>
<dt>事前確率: $\text{Prob}(\textcolor{#0072B2}{B})$</dt>
<dd>飲む前、手元のビールが<span style="color: #0072B2;">B Brewery</span>のである確率。</dd>
<dd>↓ 🍻 飲んでみて更新</dd>
<dt>事後確率: $\text{Prob}(\textcolor{#0072B2}{B} \mid \textcolor{#E69F00}{A})$</dt>
<dd>飲んでみて<span style="color: #E69F00;">Awesome</span>だったビールが
<span style="color: #0072B2;">B Brewery</span>のである確率。</dd>
</dl>

</section>
<section>
<h2 id="ベイズの定理-in-感染症検査">ベイズの定理 in 感染症検査</h2>
<ul>
<li>有病率 $\text{Prob}(M)$ : 0.3% (この地域の感染者の割合; 事前確率)</li>
<li>感度 $\text{Prob}(P \mid M)$ : 90% (感染してる人に陽性判定が出る)</li>
<li>特異度 $\text{Prob}(N \mid \overline{M})$: 99% (感染してない人に陰性判定が出る)</li>
</ul>
<p>$\text{Prob}(M \mid P)$ 真陽性率(検査陽性の人が実際に感染者である確率)は？</p>
<div>\[\begin{split}
\text{Prob}(M \mid P)
  &= \frac {\text{Prob}(P \mid M)~\text{Prob}(M)} {\text{Prob}(P)} \\
  &= \frac {\text{Prob}(P \mid M)~\text{Prob}(M)}
           {\text{Prob}(P \mid M)~\text{Prob}(M) + (1 - \text{Prob}(N \mid \overline{M}))~\text{Prob}(\overline{M})} \\
  &= \frac {0.9 \times 0.003} {0.9 \times 0.003 + 0.01 \times 0.997} \approx 0.21
\end{split}\]</div>
<p>感染者を隔離するスクリーニング目的では使いものにならない性能。</p>
<p>🔰 同様に $\text{Prob}(\overline{M} \mid N)$ 真陰性率を計算してみよう<br>
🔰 計算結果が検査性能だけでなく有病率にも依存することを確認しよう</p>

</section>
<section>
<h2 id="ベイズの定理-in-統計モデリング">ベイズの定理 in 統計モデリング</h2>
<p>
<img src="bayesian.drawio.svg">
</p>
<p>モデル$M$に対する確信度合いをデータ$D$に基づいて更新する。<br>
モデル$M$を仮説$H$やパラメータ$\theta$に置き換えてもいい。</p>
<p><strong>周辺尤度</strong>は「確率分布の積分は1」を満たすための正規化定数とみなせる。<br>
比例関係だけ抜き出してこう書くことが多い:</p>
<div>\[\begin{split}
\text{Prob}(M \mid D) &\propto \text{Prob}(D \mid M)~\text{Prob}(M) \\
\text{Prob}(H \mid D) &\propto \text{Prob}(D \mid H)~\text{Prob}(H) \\
\text{Prob}(\theta \mid D) &\propto \text{Prob}(D \mid \theta)~\text{Prob}(\theta)
\end{split}\]</div>

</section>
<section>
<h2 id="表が出る確率のベイズ推定-1-事前分布">表が出る確率のベイズ推定: 1. 事前分布</h2>
<p>コイントスを繰り返して、表が出る確率pをベイズ推定したい。</p>
<p>事前分布には<strong>ベータ分布</strong>を採用(理由は後で分かる):</p>
<div>\[\begin{split}
\text{Beta}(p \mid a, b) =
   \frac{\Gamma(a + b)}{\Gamma(a) \Gamma(b)} p^{a-1} (1 - p)^{b-1}
\end{split}\]</div>
<p>分布の形は<strong>超パラメータ</strong> $a,~b$ によって決まる。<br>
ガンマ関数の部分は厳つく見えるけどただの正規化定数。<br>
投げる前なのでとりあえず真っ平ら $\text{Beta}(p \mid a = 1, b = 1)$:</p>
<p><img src="figure/prior-beta-1.png" alt="plot of chunk prior-beta"></p>

</section>
<section>
<h2 id="表が出る確率のベイズ推定-2-尤度関数">表が出る確率のベイズ推定: 2. 尤度関数</h2>
<p>4回投げて表が1回だった、というデータで<strong>尤度</strong>を計算(<strong>二項分布</strong>):</p>
<div>\[\begin{split}
\text{Binom}(1 \mid 4,~p) = \binom {1} {4} p^{1} (1 - p)^{3}
\end{split}\]</div>
<p>これに事前分布を掛けて正規化したら事後分布になるはず。</p>
<div class="column-container">
  <div class="column" style="flex-shrink: 2.0;">
<p><img src="figure/likelihood-binom-1.png" alt="plot of chunk likelihood-binom"></p>
  </div>
  <div class="column" style="flex-shrink: 4.0; padding-top: 3rem;">
  ⨉
  </div>
  <div class="column" style="flex-shrink: 1.0;">
<p>
<img src="figure/prior-beta-1.png" alt="plot of chunk prior-beta">
</p>
  </div>
</div>

</section>
<section>
<h2 id="表が出る確率のベイズ推定-3-事後分布">表が出る確率のベイズ推定: 3. 事後分布</h2>
<p>なんと、事後分布もベータ分布になる。</p>
<div>\[\begin{split}
\text{Posterior}
  &\propto \text{Binom}(1 \mid 4,~p) \times \text{Beta}(p \mid a = 1, b = 1)\\
  &= \binom {1} {4} p^{1} (1 - p)^{3} \times
     \frac{\Gamma(1 + 1)}{\Gamma(1) \Gamma(1)} p^{1-1} (1 - p)^{1-1} \\
  &= C p^{2-1} (1 - p)^{4-1} \\
  &= \text{Beta}(p \mid a = 2, b = 4)
\end{split}\]</div>
<p>超パラメータ$a$が表、$b$が裏の回数分だけ増加。</p>
<div class="column-container">
  <div class="column" style="flex-shrink: 1.0;">
<p><img src="figure/posterior-beta-1.png" alt="plot of chunk posterior-beta"></p>
  </div>
  <div class="column" style="flex-shrink: 4.0; padding-top: 3rem;">
  $\propto$
  </div>
  <div class="column" style="flex-shrink: 1.0">
<p>
<img src="figure/likelihood-binom-1.png" alt="plot of chunk likelihood-binom">
</p>
  </div>
  <div class="column" style="flex-shrink: 4.0; padding-top: 3rem;">
  ⨉
  </div>
  <div class="column" style="flex-shrink: 1.0;">
<p>
<img src="figure/prior-beta-1.png" alt="plot of chunk prior-beta">
</p>
  </div>
</div>

</section>
<section>
<h2 id="表が出る確率のベイズ推定-4-逐次学習">表が出る確率のベイズ推定: 4. 逐次学習</h2>
<p>さっきの事後分布を事前分布として、さらにデータを集める。</p>
<p>コイントス4回のうち表1回、に基づく<strong>事前分布</strong>: $\text{Beta}(p \mid 2,~4)$</p>
<p>さらに16回投げたら表が7回、の<strong>尤度</strong>: $\text{Binomial}(7 \mid 16,~p)$</p>
<p><strong>事後分布</strong>はまた事前分布と同じ形になる:</p>
<div>\[\begin{split}
\text{Beta}(p \mid 9, 13) \propto
  \text{Binomial}(7 \mid 16,~p) \times \text{Beta}(p \mid 2, 4)
\end{split}\]</div>
<p>データを加えるたびに更新していける:</p>
<img src="figure/coin-bayesian-1.png" alt="plot of chunk coin-bayesian">

</section>
<section>
<h2 id="共役事前分布">共役事前分布</h2>
<p>事後分布が事前分布と同じ形なので計算しやすい、という組み合わせ。</p>
<table>
<thead>
<tr>
<th>尤度関数</th>
<th>共役事前分布</th>
</tr>
</thead>
<tbody>
<tr>
<td>二項分布</td>
<td>ベータ分布</td>
</tr>
<tr>
<td>ポアソン分布</td>
<td>ガンマ分布</td>
</tr>
<tr>
<td>正規分布</td>
<td>ガンマ分布</td>
</tr>
<tr>
<td>正規分布 (分散既知)</td>
<td>正規分布</td>
</tr>
</tbody>
</table>
<p>共役事前分布を使うことが常に正しいとも限らない。<br>
計算コストがかかっても<strong>無情報事前分布</strong>を使う風潮。</p>

</section>
<section>
<h2 id="事後分布を用いた推定">事後分布を用いた推定</h2>
<div class="column-container">
  <div class="column" style="flex-shrink: 1.0;">
<dl>
<dt>区間推定</dt>
<dd>幅のある推定値を提示</dd>
<dd>e.g., 95%ベイズ確信区間<br>
(等裾事後信用区間, 最高密度区間)</dd>
<dt>点推定</dt>
<dd>値を1点だけ提示</dd>
<dd>e.g., MAP, MED, EAP
</div>
<div class="column" style="flex-shrink: 1.3;">
</dd>
</dl>
<p><img src="figure/integrate-1.png" alt="plot of chunk integrate"></p>
  </div>
</div>
<p>コイン投げモデルのベータ分布は美しい例。<br>
→ 解析的(数学的)に解ける。</p>
<p>実践的なモデル・事後分布はもっと複雑。<br>
→ コンピュータに頼って数値計算: MCMC</p>

</section>
<section>
<h2 id="mcmc-umuarcov-ucuhain-umuonte-ucuarlo">MCMC: <u>M</u>arcov <u>C</u>hain <u>M</u>onte <u>C</u>arlo</h2>
<a href="https://en.wikipedia.org/wiki/Andrey_Markov">
<img src="figure/AAMarkov.jpg" height="180" align="right"></a>
<dl>
<dt>マルコフ連鎖</dt>
<dd>次の時点の挙動が現在の値だけで決定されるような確率過程。</dd>
<dd>$\ldots \to X_{t - 2} \to X_{t - 1} \to X_{t} \to X_{t + 1}$</dd>
<dd>$\text{Prob}(X_{t+1} \mid X_{t}, X_{t-1}, X_{t-2}, \ldots) = \text{Prob}(X_{t+1} \mid X_{t})$</dd>
<dd>e.g., すごろく</dd>
<dt>モンテカルロ法</dt>
<dd>乱数を用いた計算方法の総称。</dd>
<dd><a href="https://en.wikipedia.org/wiki/Monte_Carlo_Casino">
<img src="figure/Real_Monte_Carlo_Casino.jpg" height="200"></a>
<a href="https://en.wikipedia.org/wiki/Stanislaw_Ulam">
<img src="figure/Stanislaw_Ulam.jpg" height="200"></a>
<a href="https://en.wikipedia.org/wiki/John_von_Neumann">
<img src="figure/John_von_Neumann.jpg" height="200"></a>
<a href="https://en.wikipedia.org/wiki/Nicholas_Metropolis">
<img src="figure/Nicholas_Metropolis.png" height="200"></a>
</dd>
</dl>

</section>
<section>
<h2 id="モンテカルロ法は乱数を用いた計算方法">モンテカルロ法は乱数を用いた計算方法</h2>
<p>e.g., 半径1の円の面積</p>
<p>面積4の正方形に400個の一様乱数を打ち込んだら318個乗った:<br>
$4 \times \frac {318} {400} = 3.18$</p>
<p><img src="figure/circle-1.png" alt="plot of chunk circle"></p>
<p>数学を知っていれば $\pi r ^ 2 \approx 3.14$</p>

</section>
<section>
<h2 id="変な分布もモンテカルロ法で扱えそう">変な分布もモンテカルロ法で扱えそう</h2>
<p>e.g., 確率密度分布に従って変数Xを集める(棄却サンプリング)。</p>
<p><img src="figure/mcpdf-1.png" alt="plot of chunk mcpdf"></p>
<p>でも、ハズレの値もけっこう引いてしまう。</p>

</section>
<section>
<h2 id="次元の呪い-高次元になるほど当たりにくくなる">次元の呪い: 高次元になるほど当たりにくくなる</h2>
<p>(N次元球の体積 / N次元の立方体) はゼロに近づいていく。</p>
<img src="figure/circle-1.png" width="210" align="right">
<ul>
<li>2次元: $\frac {\pi r ^ 2} {(2r) ^ 2} = \frac \pi 4 \approx 0.79$</li>
<li>3次元: $\frac {\frac 4 3 \pi r ^ 3} {(2r) ^ 3} = \frac \pi 6 \approx 0.52$</li>
<li>N次元: $\frac {\frac {\pi ^ {N/2}} {\Gamma (N/2 + 1)} r ^ N} {(2r) ^ N} = \frac {\pi ^ {N/2}} {2^N \Gamma (N/2 + 1)} \to 0$</li>
</ul>
<p>パラメータが増えると計算量(≈乱数の無駄撃ち)が急増。</p>
<hr>
<p>密度の高い「当たり」付近を効率よく探索したい。<br>
「当たり」は「当たり」の近くにありがちだろう。<br>
→ マルコフ連鎖が使えそう</p>

</section>
<section>
<h2 id="metropolis--hastings法-mh法">Metropolis&ndash;Hastings法 (MH法)</h2>
<ol start="0">
<li>パラメータ $\theta$ の初期値を選ぶ</li>
<li>$\theta$ をちょっと増減させて $\theta_\text{new}$ を作る</li>
<li>それぞれ尤度を計算し、比較。
<ul>
<li>$L(\theta_\text{new}) \ge L(\theta)$ なら $\theta_\text{new}$ を即採択</li>
<li>$L(\theta_\text{new}) &lt; L(\theta)$ でも
確率 $r = \frac {L(\theta_\text{new})} {L(\theta)}$ で  $\theta_\text{new}$ を採択</li>
</ul>
</li>
<li>$\theta_\text{new}$ が採択されたら $\theta$ を更新。手順1に戻る。</li>
</ol>
<p><img src="figure/metropolis-1.png" alt="plot of chunk metropolis">
</section>
<section>
<h2 id="採択されたパラメータ値の軌跡">採択されたパラメータ値の軌跡</h2>
<p>尤度が高い方にただ向かうだけでなく、結構うろつく。<br>
 </p>
<p><img src="figure/metropolis-trajectory-head-1.png" alt="plot of chunk metropolis-trajectory-head"></p>

</section>
<section>
<h2 id="採択されたパラメータ値の軌跡">採択されたパラメータ値の軌跡</h2>
<p>尤度が高い方にただ向かうだけでなく、結構うろつく。<br>
通ったパラメータ値を集めるといい感じの分布が得られる。</p>
<p><img src="figure/metropolis-trajectory-1.png" alt="plot of chunk metropolis-trajectory"></p>

</section>
<section>
<h2 id="尤度に比例する事後分布からサンプルしたのと等価">尤度に比例する事後分布からサンプルしたのと等価</h2>
<p>全体にばら撒く棄却サンプリングよりも効率よく集められる。<br>
が、パラメータ1つの1次元ではご利益はわかりにくい。</p>
<p><img src="figure/propto-lik-1.png" alt="plot of chunk propto-lik"></p>
<p>パラメータが複数ある場合は？</p>

</section>
<section>
<h2 id="gibbs-sampling">Gibbs Sampling</h2>
<p>「ほかを固定してひとつ更新」を繰り返す。</p>
<p>e.g., 二次元正規分布。(-2, 2) からスタート。</p>
<p><img src="figure/gibbs-1.png" alt="plot of chunk gibbs"></p>
<p>TODO: アニメーション、周辺分布</p>

</section>
<section>
<h2 id="中間まとめ">中間まとめ</h2>
<ul>
<li>ベイズ推定では不確実性も表現できる。</li>
<li>コンピュータに頼った計算方法としてのモンテカルロ法。</li>
<li>多次元でも効率よくサンプルするためのMCMC。</li>
</ul>
<hr>
<p>ここから、実行するにあたっての注意点を見ていく。
</section>
<section>
<h2 id="何回やっても似たような結果になってほしい">何回やっても似たような結果になってほしい</h2>
<p>乱数や初期値によって偶々、じゃないことを確認したい。</p>
<p>e.g., <code>chains = 3, iter = 600</code> 。ほぼ同じところをうろうろ:</p>
<p><img src="figure/chains-1.png" alt="plot of chunk chains"></p>
<p>収束(convergence)の判定については後ほど。</p>

</section>
<section>
<h2 id="初期値の影響が消えるまでウォーミングアップ">初期値の影響が消えるまでウォーミングアップ</h2>
<p>定常分布の山に到達してからが本番。</p>
<p>e.g., <code>iter = 600, warmup = 200</code> で灰色の部分を捨てる:</p>
<p><img src="figure/warmup-1.png" alt="plot of chunk warmup"></p>
<p>どれくらい長く捨てるべきかは場合による。</p>

</section>
<section>
<h2 id="適度に間引いて自己相関を軽減したい">適度に間引いて自己相関を軽減したい</h2>
<p>直前の値と似すぎていたら独立サンプルとして扱えないので。</p>
<p>e.g., <code>thin = 5</code> で5回に1回だけサンプルする:</p>
<p><img src="figure/thin-1.png" alt="plot of chunk thin"></p>
<p>間引かなくても大丈夫な場合も、間引いても解決しない場合もある。</p>

</section>
<section>
<h2 id="収束判定">収束判定</h2>
<ul>
<li>複数chains・複数初期値で実行し、軌跡や分布を可視化</li>
<li>Gelman-Rubin統計量 $\hat R &lt; 1.05$</li>
<li>Effective Sample Size (ESS) $N_\text{eff} &gt; 100$ per chain</li>
</ul>
<p>TODO: 収束してる例 vs してない例
</section>
<section>
<h2 id="収束自己相関が悪い場合にどう改善するか">収束・自己相関が悪い場合にどう改善するか</h2>
<ul>
<li>小手先の対処
<ul>
<li>warmupとiterをもっと長くする</li>
<li>thinを大きくして間引く</li>
</ul>
</li>
<li>ちょっと大掛かり
<ul>
<li>モデルを見直す</li>
<li>プログラムを見直す</li>
<li>アルゴリズム・ソフトウェアを変える</li>
</ul>
</li>
</ul>

</section>
<section>
<h2 id="mcmcの方法いろいろ">MCMCの方法いろいろ</h2>
<p>採択率を高め、早く収束するように改良されてきている。</p>
<ul>
<li>Metropolis&ndash;Hastings法
<ul>
<li>Gibbs Sampling</li>
<li>Hamiltonian Monte Carlo (HMC)
<ul>
<li>No-U-Turn Sampler (NUTS)</li>
</ul>
</li>
</ul>
</li>
</ul>

</section>
<section>
<h2 id="mcmcソフトウェア">MCMCソフトウェア</h2>
<ul>
<li><a href="https://www.mrc-bsu.cam.ac.uk/software/bugs/">BUGS</a>
<ul>
<li>クローズドソースで、ほぼWindows専用。</li>
</ul>
</li>
<li><a href="https://mcmc-jags.sourceforge.io/">JAGS</a>
<ul>
<li>オープンソースで、さまざまなOS・言語から利用可能。</li>
<li>マニュアルや用例が不足。</li>
</ul>
</li>
<li><a href="https://mc-stan.org/"><strong>Stan</strong></a> 👈
<ul>
<li>オープンソースで、さまざまなOS・言語から利用可能。</li>
<li>開発も利用も活発。マニュアルや用例も充実。</li>
<li>HMC/NUTSにより早く収束。</li>
</ul>
</li>
<li><a href="https://docs.pymc.io/">PyMC3</a></li>
<li><a href="https://num.pyro.ai/">NumPyro</a></li>
<li><a href="https://www.tensorflow.org/probability/">TensorFlow Probability</a></li>
</ul>

</section>
<section>
<h2 id="stan">Stan</h2>
<a href="https://mc-stan.org/">
<img src="/slides/figure/stan/logo_name.png" width="120" align="right">
</a>
<ul>
<li>Stan言語でモデルを書く</li>
<li>C++を介して機械語に翻訳(コンパイル)するので高速</li>
<li>RやPythonなどから呼び出して使うのが便利</li>
</ul>
<p>大部分はRで説明し、部分的にPythonでの練習を挟みます。<br></p>
<p>聞きながら手元で<a href="tokiomarine2021-stan.ipynb">tokiomarine2021-stan.ipynb</a>を実行してもいいです。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="c1"># install.packages(&#34;rstan&#34;)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">rstan</span><span class="p">)</span>
<span class="nf">rstan_options</span><span class="p">(</span><span class="n">auto_write</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
</code></pre></div>
</section>
<section>
<h2 id="おおまかな流れ">おおまかな流れ</h2>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="c1"># データ準備</span>
<span class="n">mydata</span>

<span class="c1"># Stan言語で書いたモデルをコンパイル</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">rstan</span><span class="o">::</span><span class="nf">stan_model</span><span class="p">(</span><span class="n">file</span> <span class="o">=</span> <span class="s">&#34;model1.stan&#34;</span><span class="p">)</span>

<span class="c1"># MCMCサンプリング</span>
<span class="n">fit</span> <span class="o">=</span> <span class="n">rstan</span><span class="o">::</span><span class="nf">sampling</span><span class="p">(</span><span class="n">model1</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">mydata</span><span class="p">)</span>

<span class="c1"># 結果を眺める</span>
<span class="nf">print</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
<span class="n">rstan</span><span class="o">::</span><span class="nf">stan_trace</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
<span class="n">rstan</span><span class="o">::</span><span class="nf">stan_hist</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
<span class="n">rstan</span><span class="o">::</span><span class="nf">stan_ac</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
</code></pre></div>
</section>
<section>
<h2 id="説明変数なしのベイズ推定-データ準備">説明変数なしのベイズ推定: データ準備</h2>
<p>表が出る確率 $p=0.7$ のイカサマコインをN回投げたデータを作る。<br>
この $p$ をStanで推定してみよう。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">true_p</span> <span class="o">=</span> <span class="m">0.7</span>
<span class="n">N</span> <span class="o">=</span> <span class="m">40L</span>
<span class="n">data</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">N</span> <span class="o">=</span> <span class="n">N</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="nf">rbinom</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="n">true_p</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div><pre><code>$N
[1] 40

$x
 [1] 1 1 0 1 1 1 1 1 1 1 1 0 1 0 0 0 0 0 0 0 1 1 0 1 1 1 1 1 0 0 1 1 0 1 0 0 1 1 0 1
</code></pre><p>Rならlist型、Pythonならdict型にまとめてStanに渡す。</p>

</section>
<section>
<h2 id="説明変数なしのベイズ推定-stan言語でモデル定義">説明変数なしのベイズ推定: Stan言語でモデル定義</h2>
<p>文字列として保持するか、別ファイルに書いておく:</p>
<pre><code>data {
  int&lt;lower=0&gt; N;
  int x[N];
}

parameters {
  real&lt;lower=0,upper=1&gt; p;
}

model {
  x ~ binomial(1, p);
}
</code></pre><ul>
<li>いくつかのブロックに分けて記述する:<br>
R/Pythonから受け取る <code>data</code>, 推定する <code>parameter</code>, 本体の <code>model</code>.</li>
<li>整数型 <code>int</code>, 実数型 <code>real</code>, それらの配列がある。</li>
<li>下限 <code>lower</code>, 上限 <code>upper</code> を設定できる。</li>
</ul>

</section>
<section>
<h2 id="stan言語の7種のブロック">Stan言語の7種のブロック</h2>
<p>順番厳守。よく使うのは<strong>太字のやつ</strong>。</p>
<ol>
<li><code>functions {...}</code></li>
<li><strong><code>data {...}</code></strong></li>
<li><code>transformed data {...}</code></li>
<li><strong><code>parameters {...}</code></strong></li>
<li><code>transformed parameters {...}</code></li>
<li><strong><code>model {...}</code></strong></li>
<li><code>generated quantities {...}</code></li>
</ol>
<p><a href="https://mc-stan.org/docs/reference-manual/overview-of-stans-program-blocks.html">https://mc-stan.org/docs/reference-manual/overview-of-stans-program-blocks.html</a></p>

</section>
<section>
<h2 id="説明変数なしのベイズ推定-mcmcサンプル">説明変数なしのベイズ推定: MCMCサンプル</h2>
<p>予め実行速度の速い機械語に翻訳(コンパイル):</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">model</span> <span class="o">=</span> <span class="n">rstan</span><span class="o">::</span><span class="nf">stan_model</span><span class="p">(</span><span class="s">&#34;binom.stan&#34;</span><span class="p">)</span>
</code></pre></div><p>これに結構時間がかかるので、変更が無ければ再利用するため先ほど
<code>rstan_options(auto_write = TRUE)</code> しておいた。</p>
<hr>
<p>モデルとデータを使ってMCMCサンプリング:</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">fit</span> <span class="o">=</span> <span class="n">rstan</span><span class="o">::</span><span class="nf">sampling</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">)</span>
</code></pre></div><p>いろいろオプションはあるけどとりあえずデフォルトで:<br>
<code>chains = 4</code>, <code>iter = 2000</code>, <code>warmup = floor(iter/2)</code>, <code>thin = 1</code>, &hellip;</p>
<p>問題があったら実行終了時に警告してくれるので<strong>ちゃんと読む</strong>。</p>

</section>
<section>
<h2 id="説明変数なしのベイズ推定-結果を眺める">説明変数なしのベイズ推定: 結果を眺める</h2>
<p>$\hat R$ もほぼ1で $N_\text{eff}$ も大きいのでよさそう。<br>
念のため trace plot も確認しておこう。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">print</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
</code></pre></div><pre><code>Inference for Stan model: binom.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

       mean se_mean   sd   2.5%    25%    50%    75%  97.5% n_eff Rhat
p      0.59    0.00 0.07   0.44   0.54   0.59   0.64   0.73  1553    1
lp__ -28.84    0.02 0.72 -30.94 -28.98 -28.57 -28.40 -28.35  1004    1

Samples were drawn using NUTS(diag_e) at Wed Jun 30 09:10:56 2021.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).
</code></pre><p>乱数を使った計算なので(乱数シードを固定しない限り)毎回変わる。</p>

</section>
<section>
<h2 id="説明変数なしのベイズ推定-trace-plot-確認">説明変数なしのベイズ推定: trace plot 確認</h2>
<p>どのchainも似た範囲を動いていて、しっかり毛虫っぽい:</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">rstan</span><span class="o">::</span><span class="nf">stan_trace</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
</code></pre></div><p><img src="figure/stan-binom-traceplot-1.png" alt="plot of chunk stan-binom-traceplot"></p>

</section>
<section>
<h2 id="説明変数なしのベイズ推定-自己相関の確認">説明変数なしのベイズ推定: 自己相関の確認</h2>
<p>2&ndash;3ステップくらいで自己相関がほぼ消えるので問題なし:</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">rstan</span><span class="o">::</span><span class="nf">stan_ac</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">pars</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;p&#34;</span><span class="p">))</span>
</code></pre></div><p><img src="figure/stan-binom-ac-1.png" alt="plot of chunk stan-binom-ac"></p>

</section>
<section>
<h2 id="説明変数なしのベイズ推定-推定結果確認">説明変数なしのベイズ推定: 推定結果確認</h2>
<p>サンプルサイズNが小さいせいか裾野の広い推定結果。<br>
真の$p$の値も含まれている:</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">rstan</span><span class="o">::</span><span class="nf">stan_hist</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="m">30</span><span class="p">)</span>
</code></pre></div><p><img src="figure/stan-binom-hist-1.png" alt="plot of chunk stan-binom-hist"></p>
<p>次はもう少しだけ複雑な例を見てみよう。</p>

</section>
<section>
<h2 id="線形回帰のベイズ推定-データ準備">線形回帰のベイズ推定: データ準備</h2>
<a href="https://allisonhorst.github.io/palmerpenguins/">
<cite>https://allisonhorst.github.io/palmerpenguins/</cite><br>
<img src="/slides/figure/rstats/lter_penguins.png" width="45%">
<img src="/slides/figure/rstats/culmen_depth.png" width="45%">
</a>
<p><img src="figure/stan-penguins-glm-1.png" alt="plot of chunk stan-penguins-glm">
</section>
<section>
<h2 id="線形回帰のベイズ推定-データ準備">線形回帰のベイズ推定: データ準備</h2>
<a href="https://allisonhorst.github.io/palmerpenguins/">
<cite>https://allisonhorst.github.io/palmerpenguins/</cite><br>
<img src="/slides/figure/rstats/lter_penguins.png" width="45%">
<img src="/slides/figure/rstats/culmen_depth.png" width="45%">
</a>
<p><code>Stan does not support NA</code> と怒られるので欠損値を取り除いておく:</p>
<pre><code>List of 3
 $ body_mass_g      : int [1:342] 3750 3800 3250 3450 3650 3625 4675 3475 4250 3300 ...
 $ flipper_length_mm: int [1:342] 181 186 195 193 190 181 195 193 190 186 ...
 $ N                : int 342
</code></pre>
</section>
<section>
<h2 id="単回帰のベイズ推定-stan言語でモデル定義">単回帰のベイズ推定: Stan言語でモデル定義</h2>
<p>切片、傾き、ばらつきを推定する:</p>
<pre><code>data {
  int&lt;lower=0&gt; N;
  vector&lt;lower=0&gt;[N] body_mass_g;
  vector&lt;lower=0&gt;[N] flipper_length_mm;
}

parameters {
  real intercept;
  real slope;
  real&lt;lower=0&gt; sigma;
}

model {
  flipper_length_mm ~ normal(intercept + slope * body_mass_g, sigma);
}
</code></pre>
</section>
<section>
<h2 id="単回帰のベイズ推定-mcmcサンプル">単回帰のベイズ推定: MCMCサンプル</h2>
<p>予め実行速度の速い機械語に翻訳(コンパイル):</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">model</span> <span class="o">=</span> <span class="n">rstan</span><span class="o">::</span><span class="nf">stan_model</span><span class="p">(</span><span class="s">&#34;penguins.stan&#34;</span><span class="p">)</span>
</code></pre></div><p>モデルとデータを使ってMCMCサンプリング:</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">fit</span> <span class="o">=</span> <span class="n">rstan</span><span class="o">::</span><span class="nf">sampling</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">)</span>
</code></pre></div><p>いろいろオプションはあるけどとりあえずデフォルトで:<br>
<code>chains = 4</code>, <code>iter = 2000</code>, <code>warmup = floor(iter/2)</code>, <code>thin = 1</code>, &hellip;</p>
<p>問題があったら実行終了時に警告してくれるので<strong>ちゃんと読む</strong>。</p>

</section>
<section>
<h2 id="単回帰のベイズ推定-結果を眺める">単回帰のベイズ推定: 結果を眺める</h2>
<p>$\hat R$ もほぼ1で $N_\text{eff}$ も大きいのでよさそう。<br>
念のため trace plot も確認しておこう。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">print</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
</code></pre></div><pre><code>Inference for Stan model: penguins.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

             mean se_mean   sd    2.5%     25%     50%     75%   97.5% n_eff Rhat
intercept  136.76    0.06 2.03  132.81  135.36  136.73  138.20  140.86  1148    1
slope        0.02    0.00 0.00    0.01    0.01    0.02    0.02    0.02  1145    1
sigma        6.95    0.01 0.26    6.46    6.77    6.94    7.13    7.50  1347    1
lp__      -830.86    0.03 1.24 -834.07 -831.46 -830.53 -829.92 -829.42  1270    1

Samples were drawn using NUTS(diag_e) at Wed Jun 30 09:11:00 2021.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).
</code></pre>
</section>
<section>
<h2 id="単回帰のベイズ推定-trace-plot-確認">単回帰のベイズ推定: trace plot 確認</h2>
<p>どのchainも似た範囲を動いていて、しっかり毛虫っぽい:</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">rstan</span><span class="o">::</span><span class="nf">stan_trace</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
</code></pre></div><p><img src="figure/stan-penguins-traceplot-1.png" alt="plot of chunk stan-penguins-traceplot"></p>

</section>
<section>
<h2 id="単回帰のベイズ推定-自己相関の確認">単回帰のベイズ推定: 自己相関の確認</h2>
<p>どれもまあまあすぐ消えるので問題なし:</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">rstan</span><span class="o">::</span><span class="nf">stan_ac</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">pars</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;intercept&#34;</span><span class="p">,</span> <span class="s">&#34;slope&#34;</span><span class="p">,</span> <span class="s">&#34;sigma&#34;</span><span class="p">))</span>
</code></pre></div><p><img src="figure/stan-penguins-ac-1.png" alt="plot of chunk stan-penguins-ac"></p>

</section>
<section>
<h2 id="単回帰のベイズ推定-推定結果確認">単回帰のベイズ推定: 推定結果確認</h2>
<p>正規分布っぽいきれいな形:</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">rstan</span><span class="o">::</span><span class="nf">stan_hist</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="m">30</span><span class="p">)</span>
</code></pre></div><p><img src="figure/stan-penguins-hist-1.png" alt="plot of chunk stan-penguins-hist"></p>
<p>これらの値を使って点推定・区間推定も可能。</p>

</section>
<section>
<h2 id="単回帰のベイズ推定-推定結果で回帰">単回帰のベイズ推定: 推定結果で回帰</h2>
<p>無事に最尤推定と似たような線が引けた。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">coef</span> <span class="o">=</span> <span class="n">rstan</span><span class="o">::</span><span class="nf">get_posterior_mean</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span><span class="n">[</span><span class="p">,</span> <span class="s">&#34;mean-all chains&#34;</span><span class="n">]</span>
<span class="n">p_penweight</span> <span class="o">+</span>
  <span class="nf">geom_abline</span><span class="p">(</span><span class="n">intercept</span> <span class="o">=</span> <span class="n">coef[</span><span class="s">&#34;intercept&#34;</span><span class="n">]</span><span class="p">,</span> <span class="n">slope</span> <span class="o">=</span> <span class="n">coef[</span><span class="s">&#34;slope&#34;</span><span class="n">]</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#34;#3366ff&#34;</span><span class="p">)</span>
</code></pre></div><p><img src="figure/stan-penguins-regression-1.png" alt="plot of chunk stan-penguins-regression"></p>

</section>
<section>
<h2 id="ベイズ推定を使った回帰に便利なパッケージ">ベイズ推定を使った回帰に便利なパッケージ</h2>
<p><a href="https://mc-stan.org/rstanarm/">rstanarm</a> + <a href="https://mjskay.github.io/tidybayes">tidybayes</a></p>
<ul>
<li>Stan言語のモデルを自分で書かずに済む。</li>
<li>モデルの主要部品がコンパイル済みなので試行錯誤も機敏に。</li>
<li>区間推定の可視化までお世話してくれる。</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">library</span><span class="p">(</span><span class="n">rstanarm</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">tidybayes</span><span class="p">)</span>
<span class="n">fit</span> <span class="o">=</span> <span class="n">rstanarm</span><span class="o">::</span><span class="nf">stan_glm</span><span class="p">(</span><span class="n">flipper_length_mm</span> <span class="o">~</span> <span class="n">body_mass_g</span><span class="p">,</span> <span class="n">family</span> <span class="o">=</span> <span class="nf">gaussian</span><span class="p">(),</span> <span class="n">data</span> <span class="o">=</span> <span class="n">penguins</span><span class="p">)</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">penguins</span> <span class="o">%&gt;%</span> <span class="n">tidyr</span><span class="o">::</span><span class="nf">drop_na</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="n">tidybayes</span><span class="o">::</span><span class="nf">add_fitted_draws</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
<span class="n">p_penweight</span> <span class="o">+</span>
  <span class="n">ggdist</span><span class="o">::</span><span class="nf">stat_lineribbon</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="n">.value</span><span class="p">),</span> <span class="n">data</span> <span class="o">=</span> <span class="n">pred</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#34;#3366ff&#34;</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">0.4</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">scale_fill_brewer</span><span class="p">(</span><span class="n">palette</span> <span class="o">=</span> <span class="s">&#34;Greys&#34;</span><span class="p">)</span>
</code></pre></div><p><img src="figure/rstanarm-penguins-1.png" alt="plot of chunk rstanarm-penguins"></p>

</section>
<section>
<h2 id="rstanarmを使えば重回帰のベイズ推定も簡単">rstanarmを使えば重回帰のベイズ推定も簡単</h2>
<p>GLMのような書き味で書ける。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">fit</span> <span class="o">=</span> <span class="n">rstanarm</span><span class="o">::</span><span class="nf">stan_glm</span><span class="p">(</span><span class="n">flipper_length_mm</span> <span class="o">~</span> <span class="n">body_mass_g</span> <span class="o">+</span> <span class="n">species</span><span class="p">,</span> <span class="n">family</span> <span class="o">=</span> <span class="nf">gaussian</span><span class="p">(),</span> <span class="n">data</span> <span class="o">=</span> <span class="n">penguins</span><span class="p">)</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">penguins</span> <span class="o">%&gt;%</span> <span class="n">tidyr</span><span class="o">::</span><span class="nf">drop_na</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="n">tidybayes</span><span class="o">::</span><span class="nf">add_fitted_draws</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
<span class="n">p_penweight</span> <span class="o">+</span> <span class="nf">aes</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="n">species</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="n">species</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">ggdist</span><span class="o">::</span><span class="nf">stat_lineribbon</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="n">.value</span><span class="p">),</span> <span class="n">data</span> <span class="o">=</span> <span class="n">pred</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">0.4</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">scale_color_manual</span><span class="p">(</span><span class="n">values</span> <span class="o">=</span> <span class="n">penguins_colors</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">scale_fill_brewer</span><span class="p">(</span><span class="n">palette</span> <span class="o">=</span> <span class="s">&#34;Greys&#34;</span><span class="p">)</span>
</code></pre></div><p><img src="figure/rstanarm-penguins-multi-1.png" alt="plot of chunk rstanarm-penguins-multi"></p>

</section>
<section>
<h2 id="glmmで登場した個体差を階層ベイズモデルで">GLMMで登場した個体差を階層ベイズモデルで</h2>
<figure>
<a href="https://kuboweb.github.io/-kubo/ce/LinksGlm.html">
<img src="figure/kubo-p2.png" width="100%">
<figcaption class="url">久保さん https://kuboweb.github.io/-kubo/ce/LinksGlm.html</figcaption>
</a>
</figure>

</section>
<section>
<h2 id="glmmで登場した個体差を階層ベイズモデルで">GLMMで登場した個体差を階層ベイズモデルで</h2>
<p>植物100個体から8個ずつ種子を取って植えたら全体で半分ちょい発芽。<br>
親1個体あたりの生存数は<span style="color: #3366ff;">n=8の二項分布</span>になるはずだけど、<br>
極端な値(全部死亡、全部生存)が多かった。個体差？</p>
<img src="figure/overdispersion-1.png" alt="plot of chunk overdispersion">
</section>
<section>
<h2 id="階層ベイズモデルのイメージ図">階層ベイズモデルのイメージ図</h2>
<p>事前分布のパラメータに、さらに事前分布を設定するので階層ベイズ</p>
<figure>
<img src="hbm.drawio.svg">
</figure>

</section>
<section>
<h2 id="さっきの図をstan言語で記述すると">さっきの図をStan言語で記述すると</h2>
<p>お絵描きモデルとStanモデルを見比べてみよう。</p>
<pre><code>data {
  int&lt;lower=0&gt; N;
  int y[N];
}

parameters {
  real a;           // mean ability
  vector[N] r;      // individual difference
  real&lt;lower=0&gt; s;  // sd of r
}

model {
  y ~ binomial(8, inv_logit(a + r));
  a ~ normal(0, 10);
  r ~ normal(0, s);
  s ~ exponential(0.01);
}
</code></pre><p><code>inv_logit(a + r)</code> が p に相当。<br>
<code>10</code> とか <code>0.01</code> とか、なんかエイヤっと決めてるやつが超パラメータ。</p>

</section>
<section>
<h2 id="変量効果が入った推定結果">変量効果が入った推定結果</h2>
<pre><code>Inference for Stan model: glmm.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

          mean se_mean   sd    2.5%     25%     50%     75%   97.5% n_eff Rhat
a         0.86    0.01 0.30    0.27    0.65    0.85    1.06    1.47   709    1
r[1]      1.24    0.02 1.09   -0.64    0.48    1.14    1.89    3.60  4445    1
r[2]     -2.68    0.02 1.02   -4.81   -3.29   -2.59   -1.96   -0.94  2883    1
r[3]      2.88    0.03 1.67    0.22    1.68    2.67    3.81    6.71  3998    1
r[4]     -0.26    0.01 0.79   -1.71   -0.80   -0.28    0.27    1.37  3118    1
r[5]     -0.80    0.01 0.76   -2.28   -1.31   -0.79   -0.30    0.67  2957    1
r[6]      2.86    0.02 1.64    0.27    1.68    2.66    3.82    6.60  4680    1
r[7]      2.82    0.03 1.62    0.25    1.66    2.64    3.77    6.48  3885    1
r[8]     -1.89    0.02 0.84   -3.58   -2.44   -1.86   -1.31   -0.25  2944    1
r[9]      1.21    0.02 1.05   -0.68    0.49    1.11    1.84    3.51  3773    1
r[10]     2.86    0.02 1.63    0.25    1.68    2.66    3.80    6.53  4647    1
r[11]     2.87    0.03 1.67    0.17    1.64    2.68    3.91    6.60  4376    1
r[12]    -1.33    0.01 0.79   -2.90   -1.85   -1.33   -0.79    0.22  3259    1
r[13]    -2.67    0.02 0.97   -4.73   -3.30   -2.61   -1.98   -1.00  3437    1
r[14]     1.25    0.02 1.08   -0.65    0.47    1.19    1.94    3.57  4005    1
r[15]     2.81    0.02 1.58    0.21    1.66    2.61    3.74    6.42  4477    1
r[16]     2.85    0.03 1.60    0.24    1.73    2.63    3.78    6.56  4087    1
r[17]     1.22    0.02 1.11   -0.68    0.44    1.14    1.94    3.57  4594    1
r[18]    -1.32    0.02 0.80   -2.95   -1.84   -1.31   -0.78    0.19  2824    1
r[19]     2.86    0.02 1.63    0.19    1.73    2.64    3.79    6.65  4426    1
r[20]    -4.03    0.03 1.48   -7.41   -4.87   -3.85   -2.97   -1.62  3149    1
r[21]     1.22    0.02 1.07   -0.66    0.47    1.13    1.86    3.54  4327    1
r[22]    -0.78    0.01 0.77   -2.30   -1.31   -0.79   -0.26    0.78  3001    1
r[23]     0.35    0.01 0.87   -1.28   -0.24    0.33    0.90    2.16  3689    1
r[24]     2.82    0.03 1.59    0.22    1.65    2.64    3.79    6.37  3788    1
r[25]     0.35    0.01 0.86   -1.23   -0.23    0.30    0.88    2.18  4062    1
r[26]     2.85    0.03 1.62    0.27    1.64    2.67    3.82    6.43  3279    1
r[27]     2.86    0.03 1.64    0.22    1.71    2.63    3.78    6.76  3680    1
r[28]     1.21    0.02 1.08   -0.62    0.46    1.09    1.87    3.62  3754    1
r[29]     2.84    0.02 1.59    0.21    1.69    2.65    3.78    6.48  4810    1
r[30]    -2.68    0.02 1.00   -4.83   -3.28   -2.60   -1.98   -0.92  3060    1
r[31]    -3.99    0.03 1.45   -7.28   -4.83   -3.81   -2.96   -1.63  2952    1
r[32]    -2.68    0.02 1.01   -4.85   -3.30   -2.61   -1.98   -0.90  2815    1
r[33]    -2.68    0.02 1.00   -4.82   -3.28   -2.59   -1.99   -0.96  3476    1
r[34]     2.85    0.02 1.59    0.28    1.67    2.69    3.81    6.53  4749    1
r[35]    -2.69    0.02 1.00   -4.90   -3.29   -2.62   -2.00   -0.99  3393    1
r[36]     2.82    0.02 1.59    0.22    1.68    2.65    3.75    6.43  4370    1
r[37]     0.37    0.01 0.87   -1.20   -0.23    0.33    0.90    2.23  3546    1
r[38]    -1.91    0.02 0.85   -3.74   -2.45   -1.87   -1.32   -0.34  3071    1
r[39]     2.85    0.03 1.66    0.22    1.67    2.62    3.82    6.58  4098    1
r[40]    -2.69    0.02 1.04   -4.95   -3.33   -2.61   -1.97   -0.89  3420    1
r[41]    -1.31    0.01 0.80   -2.95   -1.85   -1.31   -0.79    0.27  2995    1
r[42]     1.21    0.02 1.08   -0.73    0.46    1.11    1.90    3.52  4218    1
r[43]    -2.68    0.02 1.03   -4.89   -3.33   -2.61   -1.95   -0.90  3605    1
r[44]     0.35    0.01 0.88   -1.29   -0.26    0.31    0.92    2.21  3542    1
r[45]     2.88    0.02 1.63    0.22    1.71    2.69    3.84    6.60  4947    1
r[46]     2.89    0.03 1.68    0.22    1.70    2.69    3.88    6.56  4175    1
r[47]     0.35    0.01 0.86   -1.24   -0.22    0.32    0.89    2.17  3410    1
r[48]    -1.92    0.02 0.85   -3.70   -2.45   -1.87   -1.34   -0.39  2827    1
r[49]    -3.99    0.03 1.45   -7.22   -4.86   -3.81   -2.96   -1.68  3179    1
r[50]     2.79    0.02 1.62    0.21    1.63    2.61    3.72    6.57  4224    1
r[51]    -0.27    0.01 0.82   -1.84   -0.83   -0.30    0.27    1.37  3225    1
r[52]    -0.79    0.01 0.79   -2.36   -1.31   -0.78   -0.28    0.75  3355    1
r[53]     1.21    0.02 1.06   -0.62    0.46    1.12    1.88    3.54  3757    1
r[54]    -2.67    0.02 0.98   -4.78   -3.27   -2.61   -1.99   -0.88  3137    1
r[55]    -1.90    0.01 0.85   -3.69   -2.44   -1.86   -1.32   -0.34  3257    1
r[56]    -1.90    0.02 0.83   -3.61   -2.43   -1.86   -1.32   -0.38  3050    1
r[57]     0.35    0.01 0.88   -1.27   -0.26    0.31    0.91    2.20  3844    1
r[58]     1.24    0.02 1.10   -0.65    0.48    1.15    1.90    3.73  3565    1
r[59]     2.85    0.03 1.57    0.30    1.72    2.66    3.76    6.46  3546    1
r[60]    -1.92    0.02 0.89   -3.80   -2.48   -1.87   -1.33   -0.27  3357    1
r[61]    -2.67    0.02 1.00   -4.86   -3.30   -2.60   -1.97   -0.94  3188    1
r[62]    -0.28    0.01 0.77   -1.77   -0.79   -0.29    0.25    1.25  3402    1
r[63]    -4.01    0.02 1.46   -7.36   -4.90   -3.83   -2.98   -1.66  3559    1
r[64]    -0.26    0.01 0.79   -1.80   -0.78   -0.26    0.26    1.35  3080    1
r[65]    -0.27    0.01 0.80   -1.79   -0.81   -0.29    0.26    1.36  3077    1
r[66]    -4.01    0.03 1.50   -7.46   -4.88   -3.81   -2.96   -1.62  2526    1
r[67]     2.86    0.03 1.60    0.23    1.71    2.71    3.79    6.53  3560    1
r[68]    -0.79    0.01 0.76   -2.26   -1.31   -0.80   -0.27    0.70  2718    1
r[69]     2.82    0.02 1.54    0.33    1.71    2.65    3.74    6.26  4607    1
r[70]    -1.88    0.02 0.84   -3.66   -2.42   -1.84   -1.30   -0.32  3018    1
r[71]     0.37    0.01 0.89   -1.29   -0.25    0.31    0.95    2.18  3946    1
r[72]     0.35    0.01 0.87   -1.26   -0.24    0.32    0.89    2.19  4401    1
r[73]     2.90    0.03 1.70    0.23    1.69    2.67    3.91    6.82  3470    1
r[74]    -4.06    0.03 1.53   -7.68   -4.89   -3.86   -2.97   -1.65  3088    1
r[75]    -0.79    0.01 0.75   -2.28   -1.30   -0.80   -0.29    0.71  3009    1
r[76]     2.83    0.03 1.58    0.30    1.72    2.63    3.73    6.48  3871    1
r[77]     2.86    0.03 1.64    0.26    1.66    2.67    3.85    6.66  3622    1
r[78]     0.35    0.02 0.86   -1.25   -0.23    0.33    0.90    2.08  3232    1
r[79]     1.20    0.02 1.07   -0.62    0.45    1.10    1.85    3.56  4236    1
r[80]    -4.02    0.02 1.48   -7.52   -4.87   -3.83   -3.01   -1.57  3530    1
r[81]     0.35    0.01 0.88   -1.19   -0.26    0.29    0.92    2.20  4097    1
r[82]    -0.26    0.01 0.80   -1.79   -0.80   -0.27    0.24    1.37  3447    1
r[83]    -4.05    0.03 1.48   -7.37   -4.94   -3.90   -2.98   -1.63  3259    1
r[84]    -1.33    0.01 0.81   -2.95   -1.86   -1.34   -0.79    0.25  3054    1
r[85]     2.84    0.03 1.63    0.30    1.69    2.63    3.71    6.60  3748    1
r[86]    -1.91    0.02 0.85   -3.69   -2.43   -1.86   -1.34   -0.33  2845    1
r[87]    -1.90    0.01 0.83   -3.58   -2.44   -1.87   -1.33   -0.38  3169    1
r[88]    -4.05    0.03 1.49   -7.44   -4.91   -3.84   -3.02   -1.70  2924    1
r[89]     2.86    0.03 1.62    0.19    1.71    2.66    3.82    6.47  3770    1
r[90]    -1.91    0.02 0.86   -3.74   -2.47   -1.88   -1.32   -0.34  2748    1
r[91]     0.36    0.01 0.89   -1.31   -0.24    0.31    0.93    2.24  3800    1
r[92]     1.23    0.02 1.10   -0.69    0.49    1.14    1.90    3.59  3520    1
r[93]     2.85    0.03 1.64    0.19    1.67    2.67    3.79    6.63  4225    1
r[94]     2.90    0.03 1.69    0.23    1.67    2.70    3.88    6.77  4122    1
r[95]    -1.90    0.01 0.85   -3.68   -2.47   -1.87   -1.30   -0.29  3251    1
r[96]    -0.24    0.01 0.83   -1.80   -0.80   -0.27    0.31    1.43  3486    1
r[97]     1.19    0.02 1.04   -0.60    0.45    1.10    1.82    3.45  4284    1
r[98]    -1.32    0.01 0.81   -3.00   -1.86   -1.29   -0.75    0.22  3315    1
r[99]    -2.66    0.02 1.00   -4.87   -3.28   -2.58   -1.97   -0.91  2890    1
r[100]   -0.80    0.01 0.77   -2.33   -1.31   -0.78   -0.27    0.72  3468    1
s         2.61    0.01 0.32    2.04    2.39    2.58    2.80    3.31  1001    1
lp__   -456.82    0.33 9.18 -475.53 -462.53 -456.37 -450.55 -440.05   794    1

Samples were drawn using NUTS(diag_e) at Wed Jun 30 09:11:12 2021.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).
</code></pre>
</section>
<section>
<h2 id="抜粋して作図悪くない">抜粋して作図。悪くない。</h2>
<p>データ生成の真のパラメータ値は $a = 0.5,~s = 3.0$ だった。</p>
<p><img src="figure/stan-glmm-1.png" alt="plot of chunk stan-glmm"></p>

</section>
<section>
<h2 id="事前分布の選別">事前分布の選別</h2>
<ol>
<li>
<p>とりあえず<strong>無情報事前分布</strong> $[-\infty, \infty]$。Stanのデフォルト。</p>
</li>
<li>
<p>収束が悪かったら<strong>弱情報事前分布</strong>を試す。<br>
事後分布を更新していったとき<strong>事前分布っぽさが残らない</strong>のが良い。</p>
<ul>
<li>取りうる値を逃すような狭すぎる分布はダメ。</li>
<li>狭すぎるよりはマシだが、広すぎても良くない。</li>
<li>一様分布 $[a, b]$ は一見無情報っぽくて良さそうだが、<br>
事後分布に裾野が残ったり絶壁ができたりしがちなので微妙。</li>
</ul>
<p>おすすめ: <strong>Student&rsquo;s t分布</strong>、正規分布、指数分布など。</p>
</li>
</ol>
<p><cite><a href="https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations">https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations</a></cite></p>

</section>
<section>
<h2 id="stanおすすめ弱情報事前分布-students-t分布">Stanおすすめ弱情報事前分布: Student&rsquo;s t分布</h2>
<p>Student&rsquo;s $t(\nu=\nu_0, \mu = 0, \sigma = \sigma_0)$</p>
<ul>
<li>自由度 $\nu$: 小さいほど裾野が広い。$3 \le \nu_0 \le 7 $ で適当に固定。</li>
<li>スケール $\sigma$: 「推定したい値は$[-\sigma_0, \sigma_0]$に収まるだろう」という値。</li>
</ul>
<p><img src="figure/student_t-1.png" alt="plot of chunk student_t"></p>
<p>正の値しか取らない場合は <code>&lt;lower=0&gt;</code> として右半分だけ使うとか。</p>

</section>
<section>
<h2 id="非線形回帰の例-データ">非線形回帰の例: データ</h2>
<p>刺激強度xに対する応答強度yを20個体調査。<br>
非対称なひと山。応答変数も説明変数も正の値。</p>
<div>\[\begin{split}
y = ae ^ {-bx} - ce ^ {-dx}
\end{split}\]</div>
<p><img src="figure/non-linear-1.png" alt="plot of chunk non-linear"></p>

</section>
<section>
<h2 id="非線形回帰の例-stanコード">非線形回帰の例: Stanコード</h2>
<pre><code class="language-stan" data-lang="stan">data {
  int&lt;lower=1&gt; N;
  vector[N] x;
  vector[N] y;
  int id[N];
  int&lt;lower=1&gt; Ninds;
}

parameters {
  real a;
  real d;
  real&lt;upper=a&gt; c;
  real&lt;upper=d&gt; b;
  real shape;
  vector[Ninds] intercept;
}

model {
  vector[N] mu = a * exp(-b * x) - (a - c) * exp(-d * x) + intercept[id];
  y ~ gamma(shape, shape ./ mu);
  a ~ exponential(1);
  b ~ exponential(1);
  c ~ exponential(1);
  d ~ exponential(1);
  shape ~ exponential(0.001);
  intercept ~ normal(0, 0.005);
}
</code></pre>
</section>
<section>
<h2 id="練習問題">練習問題</h2>
<p>🔰 <code>penguins</code> データでStanを動かしてみよう。</p>
<p><a href="https://mc-stan.org/docs/functions-reference/">定義済みの関数</a></p>

</section>
<section>
<h2 id="階層ベイズモデルのほかの応用先">階層ベイズモデルのほかの応用先</h2>
<ul>
<li>時系列モデル (状態空間モデル)</li>
<li>空間構造のあるモデル (e.g., CARモデル)</li>
<li>欠損値の補完</li>
</ul>

</section>
<section>
<h2 id="ベイズ推定まとめ">ベイズ推定まとめ</h2>
<ul>
<li>条件付き確率 $\text{Prob}(B \mid A)$ の理解が大事。
<ul>
<li>事後分布 $\propto$ 尤度 ⨉ 事前分布</li>
<li>確信度合いをデータで更新していく。</li>
</ul>
</li>
<li>推定結果は分布そのもの。
<ul>
<li>そこから点推定も区間推定も可能。</li>
</ul>
</li>
<li>解析的に解けない問題は計算機に乱数を振らせて解く。
<ul>
<li>理論・技術の進歩が目覚ましい。</li>
</ul>
</li>
</ul>

</section>
<section>
<h2 id="回帰分析ふりかえり">回帰分析ふりかえり</h2>
<p>より柔軟にモデルを記述できるようになった。計算方法も変化。</p>
<figure>
<a href="https://kuboweb.github.io/-kubo/ce/LinksGlm.html">
<img src="figure/kubo-p2.png" width="100%">
<figcaption class="url">久保さん https://kuboweb.github.io/-kubo/ce/LinksGlm.html</figcaption>
</a>
</figure>

</section>
<section>
<h2 id="全体まとめ">全体まとめ</h2>
<ul>
<li>統計とは、データをうまくまとめ、それに基づいて推論するための手法。</li>
<li>モデルには<strong>理解志向</strong>と<strong>応用志向</strong>があり、統計モデルは前者寄り。
<ul>
<li>どちらも多少は分かった上で使い分けたい。</li>
<li>どっちにしろ真の正しい何かではない。</li>
</ul>
</li>
<li><strong>確率分布</strong>とその背後にある<strong>確率過程</strong>の理解が重要。
<ul>
<li>乱数生成→作図を繰り返してイメージを掴もう。</li>
<li>MCMCサンプリングも事後分布からの乱数生成。</li>
</ul>
</li>
</ul>

</section>
<section>
<h2 id="参考文献">参考文献</h2>
<ul>
<li><a href="https://amzn.to/33suMIZ">データ解析のための統計モデリング入門</a> 久保拓弥 2012</li>
<li><a href="https://amzn.to/3uwx7Pb">StanとRでベイズ統計モデリング</a> 松浦健太郎 2016</li>
<li><a href="https://amzn.to/3o1eCzP">RとStanではじめる ベイズ統計モデリングによるデータ分析入門</a> 馬場真哉 2019</li>
<li><a href="https://amzn.to/3uCxTKo">データ解析のための数理モデル入門</a> 江崎貴裕 2020</li>
<li><a href="https://amzn.to/3uznzCK">分析者のためのデータ解釈学入門</a> 江崎貴裕 2020</li>
<li><a href="https://amzn.to/3ty80Kv">統計学を哲学する</a> 大塚淳 2020</li>
</ul>
<a href="." class="readmore">
目次に戻る
</a>

</section>
</div>
</div>
<script src="/slides/lib/reveal.js/reveal.js"></script>
<script src="/slides/lib/reveal.js/plugin/notes.js"></script>
<script>
Reveal.initialize({
  width: 960,
  height: 720,
  margin: 0,
  controls: true,
  controlsLayout: 'bottom-right',
  controlsTutorial: false,
  controlsBackArrows: 'faded',
  progress: false,
  slideNumber: 'c/t',
  showSlideNumber: 'all',
  hashOneBasedIndex: true,
  hash: true,
  history: false,
  keyboard: true,
  overview: true,
  center: false,
  touch: true,
  loop: false,
  rtl: false,
  navigationMode: 'linear',
  shuffle: false,
  fragments: true,
  fragmentInURL: true,
  embedded: false,
  help: true,
  showNotes: false,
  autoPlayMedia: null,
  preloadIframes: null,
  mouseWheel: false,
  previewLinks: false,
  transition: 'none',
  transitionSpeed: 'fast',
  backgroundTransition: 'none',
  pdfMaxPagesPerSlide: 1,
  pdfSeparateFragments: false,
  viewDistance: 2,
  plugins: [ RevealNotes ]
});
</script>
<script>
{
const reload_all_img = function() {
  const imgs = document.getElementsByTagName("img");
  for (let i = 0; i < imgs.length; ++i) {
    const src = imgs[i].src;
    imgs[i].src += "?q";
    imgs[i].src = src;
  }
};
const reload_src_element = function(ev) {
  const original_src = ev.srcElement.src;
  ev.srcElement.src += "?q";
  ev.srcElement.src = original_src;
};
const reload_src = function(ev) {
  if (ev.shiftKey || ev.metaKey || ev.altKey) {
    reload_all_img();
  } else {
    reload_src_element(ev);
  }
};
const img_elements = document.getElementsByTagName("img");
for (let i = 0; i < img_elements.length; ++i) {
  img_elements[i].onclick = reload_src;
}
};
</script>
</body>
</html>
