```{r, setup-common}
#| file: "setup.R"
#| echo: false
#| results: asis
```
```{r, setup-local}
#| include: false
# to suppress "warning: jobserver unavailable: using -j1" from cmdstanr
withr::local_envvar(MAKEFLAGS = "-j1")
withr::local_package("cmdstanr")
```

---
## GLMMã§ç™»å ´ã—ãŸå€‹ä½“å·®ã‚’éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã§

<figure>
<a href="https://kuboweb.github.io/-kubo/ce/LinksGlm.html">
<img src="../tokiomarine2021/image/kubo-p2.png" width="1000">
<figcaption class="url">ä¹…ä¿ã•ã‚“ https://kuboweb.github.io/-kubo/ce/LinksGlm.html</figcaption>
</a>
</figure>


---
## GLMMã§ç™»å ´ã—ãŸå€‹ä½“å·®ã‚’éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã§

æ¤ç‰©100å€‹ä½“ã‹ã‚‰8å€‹ãšã¤ç¨®å­ã‚’å–ã£ã¦æ¤ãˆãŸã‚‰å…¨ä½“ã§åŠåˆ†ã¡ã‚‡ã„ç™ºèŠ½ã€‚<br>
è¦ª1å€‹ä½“ã‚ãŸã‚Šã®ç”Ÿå­˜æ•°ã¯<span style="color: #3366ff;">n=8ã®äºŒé …åˆ†å¸ƒ</span>ã«ãªã‚‹ã¯ãšã ã‘ã©ã€<br>
æ¥µç«¯ãªå€¤(å…¨éƒ¨æ­»äº¡ã€å…¨éƒ¨ç”Ÿå­˜)ãŒå¤šã‹ã£ãŸã€‚å€‹ä½“å·®ï¼Ÿ

<img `r src_alt_fig_chunk("overdispersion")`>



---
## å€‹ä½“å·®ã‚’ãƒ¢ãƒ‡ãƒ«ã«çµ„ã¿è¾¼ã¿ãŸã„

å„å€‹ä½“ã®ç”Ÿå­˜ç‡$p_i$ã‚’ãã®ã¾ã¾ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã™ã‚‹ã¨**éå‰°é©åˆ**ã€‚<br>
ã€Œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•° â‰¥ ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºã€ã®â€œãƒ‡ãƒ¼ã‚¿èª­ã¿ä¸Šã’â€ãƒ¢ãƒ‡ãƒ«ã€‚<br>
i.e., ã“ã®å€‹ä½“ã¯4å€‹ç”Ÿãæ®‹ã£ã¦ç”Ÿå­˜ç‡0.5ã ã­ã€‚æ¬¡ã®å€‹ä½“ã¯2å€‹ä½“ã ã‹ã‚‰......

<img `r src_alt_fig_chunk("saturated-glmm")`>

å€‹ä½“ã®ç”Ÿå­˜èƒ½åŠ›ã‚’ã‚‚ã£ã¨å°‘ãªã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§è¡¨ç¾ã§ããªã„ã‹ï¼Ÿ


---
## å€‹ä½“å·®ã‚’ãƒ¢ãƒ‡ãƒ«ã«çµ„ã¿è¾¼ã¿ãŸã„

å„å€‹ä½“ã®ç”Ÿå­˜ç‡$p_i$ãŒèƒ½åŠ›å€¤$z_i$ã®ã‚·ã‚°ãƒ¢ã‚¤ãƒ‰é–¢æ•°ã§æ±ºã¾ã‚‹ã¨ä»®å®šã€‚<br>
ãã®èƒ½åŠ›å€¤ã¯å…¨å€‹ä½“å…±é€šã®æ­£è¦åˆ†å¸ƒã«å¾“ã†ã¨ä»®å®š:
$z_i \sim \mathcal{N}(\hat z, \sigma)$

<img `r src_alt_fig_chunk("sigmoid")`>

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿2ã¤ã§æ¸ˆã‚€: å¹³å‡ $\hat z$, ã°ã‚‰ã¤ã $\sigma$ ã€‚

å‰è€…ã¯æ¨™æœ¬å¹³å‡ $\hat p$ ã‹ã‚‰æ±‚ã¾ã‚‹ã¨ã—ã¦ã€å¾Œè€…ã©ã†ã™ã‚‹ï¼Ÿ

---
## å€‹ä½“èƒ½åŠ›ã®ã°ã‚‰ã¤ã $\sigma$ ãŒå¤§ãã„ã¨ä¸¡ç«¯ãŒå¢—ãˆã‚‹

æ™®é€šã®äºŒé …åˆ†å¸ƒã¯å€‹ä½“å·®ç„¡ã— $\sigma = 0$ ã‚’ä»®å®šã—ã¦ã‚‹ã®ã¨åŒã˜ã€‚

<img `r src_alt_fig_chunk("alter-sigma")`>

<img `r src_alt_fig_chunk("alter-sigma", number = 2)`>

---
## zã®å€¤ã§è‰²åˆ†ã‘ã—ã¦ã¿ã‚‹ã¨æƒ³åƒã—ã‚„ã™ã„

æ­£è¦åˆ†å¸ƒã¨äºŒé …åˆ†å¸ƒã®æ··ãœåˆã‚ã›......?

<img `r src_alt_fig_chunk("alter-sigma-z")`>

<img `r src_alt_fig_chunk("alter-sigma-z", number = 2)`>

---
## éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ¡ãƒ¼ã‚¸å›³

äº‹å‰åˆ†å¸ƒã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã€ã•ã‚‰ã«äº‹å‰åˆ†å¸ƒã‚’è¨­å®šã™ã‚‹ã®ã§éšå±¤ãƒ™ã‚¤ã‚º

<figure>
<img src="../tokiomarine2022/hbm.drawio.svg" width="800">
</figure>


---
## ã•ã£ãã®å›³ã‚’Stanè¨€èªã§è¨˜è¿°ã™ã‚‹ã¨

`10` ã¨ã‹ `3` ã¨ã‹ã€ã‚¨ã‚¤ãƒ¤ã£ã¨æ±ºã‚ã¦ã‚‹ã‚„ã¤ãŒè¶…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‚

```{stan, glmm}
#| cache_stan: true
data {
  int<lower=0> N;
  array[N] int<lower=0> y;
}

parameters {
  real z_hat;           // mean ability
  real<lower=0> sigma;  // sd of r
  vector[N] r;          // individual difference
}

transformed parameters {
  vector[N] z = z_hat + r;
  vector[N] p = inv_logit(z);
}

model {
  y ~ binomial(8, p);
  z_hat ~ normal(0, 10);
  r ~ normal(0, sigma);
  sigma ~ student_t(3, 0, 1);
}
```

---
## å¤‰é‡åŠ¹æœãŒå…¥ã£ãŸæ¨å®šçµæœ

```{r, df-seeds-od-8}
#| echo: false
set.seed(24601)
sigmoid = function(x, gain = 1) {1 / (1 + exp(-gain * x))}
samplesize = 100L
df_seeds_od = tibble::tibble(
  z = rnorm(samplesize, 0.5, 3),
  p = sigmoid(z),
  y = rbinom(samplesize, 8L, p))
```
```{r, stan-glmm-prep}
#| cache_stan: glmm
#| stan_save_output_files: fit
#| message: false
#| results: false
seeds_data = list(y = df_seeds_od$y, N = samplesize)
model = cmdstan_model("stan/glmm.stan")
fit = model$sample(data = seeds_data, seed = 19937L, step_size = 0.1, refresh = 0)
draws = fit$draws(c("z_hat", "sigma", "r[1]", "r[2]"))
```

```{r, stan-glmm-print}
#| echo: false
#| cache.globals: fit
print(fit)
```

---
## æŠœç²‹ã—ã¦ä½œå›³ã€‚æ‚ªããªã„ã€‚

ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã®çœŸã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å€¤ã¯ $\hat z = 0.5,~\sigma = 3.0$ ã ã£ãŸã€‚

```{r, stan-glmm}
#| echo: false
#| warning: false
#| fig.width: 11
#| fig.height: 6
p_trace = bayesplot::mcmc_trace(draws, facet_args = list(nrow = 1L)) + coord_flip()
p_hist = bayesplot::mcmc_hist(draws, facet_args = list(nrow = 1L), bins = 30)
cowplot::plot_grid(p_trace, p_hist, ncol = 1L)
```


---
## ğŸ”° éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã®ç·´ç¿’å•é¡Œ: ç¨®ã®æ•°

100å€‹ä½“ã®æ¤ç‰©ã‹ã‚‰8ã¤ãšã¤ç¨®ã‚’å–ã£ãŸã€ã®ãƒ‡ãƒ¼ã‚¿ã§ã‚„ã£ã¦ã¿ã‚ˆã†ã€‚

```{r, df-seeds-generate}
#| ref.label: df-seeds-od-8
#| echo: -1
```

<img `r src_alt_fig_chunk("overdispersion")`>


---
## ğŸ”° éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã®ç·´ç¿’å•é¡Œ: ãƒ“ãƒ¼ãƒ«æ³¨æ–‡æ•°
<!-- TODO: æ™‚é–“ãŒä½™ã£ãŸå ´åˆã®ç·´ç¿’å•é¡Œ -->

```{r, beer-overdispersion-data-re}
#| echo: -1
set.seed(24601)
samplesize = 300L
lambda = 3
overdisp = 4
.n = lambda / (overdisp - 1)
.p = 1 / overdisp
df_beer_od = tibble::tibble(
  X = rnbinom(samplesize, size = .n, prob = .p)
)
```

<img `r src_alt_fig_chunk("beer-overdispersion")`>


---
## éç·šå½¢å›å¸°ã®ä¾‹: ãƒ‡ãƒ¼ã‚¿

åˆºæ¿€å¼·åº¦xã«å¯¾ã™ã‚‹å¿œç­”å¼·åº¦yã‚’20å€‹ä½“èª¿æŸ»ã€‚<br>
éå¯¾ç§°ãªã²ã¨å±±ã€‚å¿œç­”å¤‰æ•°ã‚‚èª¬æ˜å¤‰æ•°ã‚‚æ­£ã®å€¤ã€‚

<div>\[\begin{split}
y = ae ^ {-bx} - ce ^ {-dx}
\end{split}\]</div>

```{r, non-linear}
#| echo: false
#| fig.width: 10
#| fig.height: 5
set.seed(19937L)
expo = function(x, y0, lambda) y0 * exp(- lambda * x)

genfunc = function(params) {
  function(x) {
    expo(x, params["a"], params["b"]) - expo(x, params["c"], params["d"])
  }
}

params = c(a = 0.08, b = 0.01, c = 0.05, d = 0.05)
func = genfunc(params)
n_inds = 20L
sd_inds = 0.005
shape = 60
min_ipi = 5
intercept = sort(rnorm(n_inds, 0, sd_inds))
df = tidyr::crossing(id = seq_len(n_inds), x = seq(min_ipi, 105, 10)) |>
  dplyr::mutate(y = rgamma(length(x), shape = shape, scale = (func(x) + intercept[id]) / shape))

p_base = ggplot(df) + aes(x, y) +
  geom_point(aes(color = id), alpha = 0.7, shape = 16, size = 3) +
  geom_line(aes(color = id, group = id), alpha = 0.2) +
  xlim(0, NA) + ylim(0, NA) +
  geom_function(fun = func) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank())

p_base
```

---
## éç·šå½¢å›å¸°ã®ä¾‹: Stanã‚³ãƒ¼ãƒ‰

ã•ã£ãã®æ•°å¼ã‚’ `model` ãƒ–ãƒ­ãƒƒã‚¯ã«æ›¸ãã€‚

```stan
data {
  int<lower=1> N;
  vector[N] x;
  vector[N] y;
  int id[N];
  int<lower=1> Ninds;
}

parameters {
  real<lower=0> a;
  real<lower=0> d;
  real<lower=0,upper=a> c;
  real<lower=0,upper=d> b;
  real shape;
  vector[Ninds] intercept;
}

model {
  vector[N] mu = a * exp(-b * x) - (a - c) * exp(-d * x) + intercept[id];
  y ~ gamma(shape, shape ./ mu);
  a ~ normal(0, 100);
  b ~ normal(0, 100);
  c ~ normal(0, 100);
  d ~ normal(0, 100);
  shape ~ normal(0, 100);
  intercept ~ normal(0, 0.005);
}
```



---
## éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã®ã»ã‹ã®å¿œç”¨å…ˆ

- æ™‚ç³»åˆ—ãƒ¢ãƒ‡ãƒ« (çŠ¶æ…‹ç©ºé–“ãƒ¢ãƒ‡ãƒ«)
- ç©ºé–“æ§‹é€ ã®ã‚ã‚‹ãƒ¢ãƒ‡ãƒ« (e.g., CARãƒ¢ãƒ‡ãƒ«)
- æ¬ æå€¤ã®è£œå®Œ



---
## ãƒ™ã‚¤ã‚ºæ¨å®šã¾ã¨ã‚

- æ¡ä»¶ä»˜ãç¢ºç‡ $\text{Prob}(B \mid A)$ ã®ç†è§£ãŒå¤§äº‹ã€‚
    - äº‹å¾Œåˆ†å¸ƒ $\propto$ å°¤åº¦ â¨‰ äº‹å‰åˆ†å¸ƒ
    - ç¢ºä¿¡åº¦åˆã„ã‚’ãƒ‡ãƒ¼ã‚¿ã§æ›´æ–°ã—ã¦ã„ãã€‚
- æ¨å®šçµæœã¯åˆ†å¸ƒãã®ã‚‚ã®ã€‚
    - ãã“ã‹ã‚‰ç‚¹æ¨å®šã‚‚åŒºé–“æ¨å®šã‚‚å¯èƒ½ã€‚
- è§£æçš„ã«è§£ã‘ãªã„å•é¡Œã¯è¨ˆç®—æ©Ÿã«ä¹±æ•°ã‚’æŒ¯ã‚‰ã›ã¦è§£ãã€‚
    - MCMCã‚µãƒ³ãƒ—ãƒ« $\sim$ è§£ãã«ãã„äº‹å¾Œåˆ†å¸ƒ
    - ç†è«–ãƒ»æŠ€è¡“ã®é€²æ­©ãŒç›®è¦šã¾ã—ã„ã€‚


---
## å›å¸°åˆ†æãµã‚Šã‹ãˆã‚Š

ã‚ˆã‚ŠæŸ”è»Ÿã«ãƒ¢ãƒ‡ãƒ«ã‚’è¨˜è¿°ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚è¨ˆç®—æ–¹æ³•ã‚‚å¤‰åŒ–ã€‚

<figure>
<a href="https://kuboweb.github.io/-kubo/ce/LinksGlm.html">
<img src="../tokiomarine2021/image/kubo-p2.png" width="1000">
<figcaption class="url">ä¹…ä¿ã•ã‚“ https://kuboweb.github.io/-kubo/ce/LinksGlm.html</figcaption>
</a>
</figure>


---
## å…¨ä½“ã¾ã¨ã‚

- çµ±è¨ˆã¨ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’ã†ã¾ãã¾ã¨ã‚ã€ãã‚Œã«åŸºã¥ã„ã¦æ¨è«–ã™ã‚‹ãŸã‚ã®æ‰‹æ³•ã€‚
- ãƒ¢ãƒ‡ãƒ«ã«ã¯**ç†è§£å¿—å‘**ã¨**å¿œç”¨å¿—å‘**ãŒã‚ã‚Šã€çµ±è¨ˆãƒ¢ãƒ‡ãƒ«ã¯å‰è€…å¯„ã‚Šã€‚
    - ã©ã¡ã‚‰ã‚‚å¤šå°‘ã¯åˆ†ã‹ã£ãŸä¸Šã§ä½¿ã„åˆ†ã‘ãŸã„ã€‚
    - ã©ã£ã¡ã«ã—ã‚çœŸã®æ­£ã—ã„ä½•ã‹ã§ã¯ãªã„ã€‚
- **ç¢ºç‡åˆ†å¸ƒ**ã¨ãã®èƒŒå¾Œã«ã‚ã‚‹**ç¢ºç‡éç¨‹**ã®ç†è§£ãŒé‡è¦ã€‚
    - ä¹±æ•°ç”Ÿæˆâ†’ä½œå›³ã‚’ç¹°ã‚Šè¿”ã—ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ´ã‚‚ã†ã€‚
    - MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‚‚äº‹å¾Œåˆ†å¸ƒã‹ã‚‰ã®ä¹±æ•°ç”Ÿæˆã€‚
- æœ¬è¬›ç¾©ã§ã€Œçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã‚’å®Œå…¨ã«ç†è§£ã—ãŸã€ã¨ã¯è¨€ãˆãªã„ã€‚
    - ç†è«–ã‚‚å®Ÿè·µã‚‚ã»ã¨ã‚“ã©èª¬æ˜ã—ã¦ã„ãªã„ã€‚
    - æœ¬ã‚’èª­ã‚€æº–å‚™ãŒã§ããŸã€ãã‚‰ã„ã®æ°—æŒã¡ï¼Ÿ


---
## å‚è€ƒæ–‡çŒ®

- [ãƒ‡ãƒ¼ã‚¿è§£æã®ãŸã‚ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€](https://amzn.to/33suMIZ) ä¹…ä¿æ‹“å¼¥ 2012
- [Stanã¨Rã§ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°](https://amzn.to/3uwx7Pb) æ¾æµ¦å¥å¤ªéƒ 2016
- [Rã¨Stanã§ã¯ã˜ã‚ã‚‹ ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿åˆ†æå…¥é–€](https://amzn.to/3o1eCzP) é¦¬å ´çœŸå“‰ 2019
- [ãƒ‡ãƒ¼ã‚¿åˆ†æã®ãŸã‚ã®æ•°ç†ãƒ¢ãƒ‡ãƒ«å…¥é–€](https://amzn.to/3uCxTKo) æ±Ÿå´è²´è£• 2020
- [åˆ†æè€…ã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿è§£é‡ˆå­¦å…¥é–€](https://amzn.to/3uznzCK) æ±Ÿå´è²´è£• 2020
- [çµ±è¨ˆå­¦ã‚’å“²å­¦ã™ã‚‹](https://amzn.to/3ty80Kv) å¤§å¡šæ·³ 2020

<a href="." class="readmore">
ç›®æ¬¡ã«æˆ»ã‚‹
</a>
