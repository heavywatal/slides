+++
url = "tmd2020/4-structure2.html"
title = "4. ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å‡¦ç†2: çµåˆã€å¤‰å½¢ãªã© â€” Rã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿å‰å‡¦ç†å®Ÿç¿’ 2020"
linktitle = "ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å‡¦ç†2: çµåˆã€å¤‰å½¢ãªã©ã€‚"
date = 2020-10-10T14:40:00+09:00
type = "reveal"
draft = false
+++


# [Rã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿å‰å‡¦ç†å®Ÿç¿’2020](.)

<div class="author">
å²©åµœ èˆª (Watal M. Iwasaki, PhD)
</div>

<div class="affiliation">
æ±åŒ—å¤§å­¦ ç”Ÿå‘½ç§‘å­¦ç ”ç©¶ç§‘ é€²åŒ–ã‚²ãƒãƒŸã‚¯ã‚¹åˆ†é‡ ç‰¹ä»»åŠ©æ•™<br>
(Graduate School of Life Sciences, Tohoku University)
</div>

<ol>
<li><a href="1-introduction.html">å…¥é–€1: å‰å‡¦ç†ã¨ã¯ã€‚Rã‚’ä½¿ã†ãƒ¡ãƒªãƒƒãƒˆã€‚Rã®åŸºæœ¬ã€‚</a>
<li><a href="2-visualization.html">å…¥é–€2: ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–ã®é‡è¦æ€§ã¨æ–¹æ³•ã€‚</a>
<li><a href="3-structure1.html">ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å‡¦ç†1: æŠ½å‡ºã€é›†ç´„ãªã©ã€‚</a>
<li class="current-deck"><a href="4-structure2.html">ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å‡¦ç†2: çµåˆã€å¤‰å½¢ãªã©ã€‚</a>
<li><a href="5-content.html">ãƒ‡ãƒ¼ã‚¿å†…å®¹ã®å‡¦ç†: æ•°å€¤ã€æ–‡å­—åˆ—ã€æ—¥æ™‚ãªã©ã€‚</a>
<li><a href="6-practice.html">å®Ÿè·µ: ç¾å®Ÿã®å•é¡Œã«å¯¾å‡¦ã—ã¦ã¿ã‚‹ã€‚</a>
</ol>

<div class="footnote">
2020-10-10 æ±äº¬åŒ»ç§‘æ­¯ç§‘å¤§å­¦ M&Dã‚¿ãƒ¯ãƒ¼ æƒ…å ±æ¤œç´¢å®¤1
<a href="https://heavywatal.github.io/slides/tmd2020/">https://heavywatal.github.io/slides/tmd2020/</a>
</div>

```{r setup-global, include=FALSE, code=readLines("setup.R")}
```

```{r setup-local, include=FALSE}
library(ggplot2)
library(tibble)
library(dplyr)
library(tidyr)
library(purrr)
knitr::opts_chunk$set(cache = TRUE)
anscombe = tibble::as_tibble(anscombe)
```

---
## å‰å‡¦ç†ã¯å¤§ãã2ã¤ã«åˆ†ã‘ã‚‰ã‚Œã‚‹

- **ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å¯¾è±¡ã¨ã™ã‚‹å‡¦ç†** â€” ç¬¬3, 4å› æœ¬æ—¥ã®è©±é¡Œ
    - ä½¿ã„ãŸã„éƒ¨åˆ†ã ã‘æŠ½å‡º
    - ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ç‰¹å¾´ã‚’è¦ç´„
    - ä½•ã‹ã®é †ã«ä¸¦ã¹æ›¿ãˆ
    - **ç•°ãªã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã®çµåˆ** ğŸ‘ˆ ç¬¬4å›ã“ã“ã‹ã‚‰
    - **å¤‰å½¢: ç¸¦é•· â†” æ¨ªåºƒ**
- ãƒ‡ãƒ¼ã‚¿å†…å®¹ã‚’å¯¾è±¡ã¨ã™ã‚‹å‡¦ç† <span style="color: #888888;">â€” ç¬¬5å› æ¥é€±</span>
    - æ•°å€¤ã‚’å¤‰æ›ã™ã‚‹ (e.g., å¯¾æ•°ã€åº§æ¨™ç³»)
    - å¤‰æ›: é€£ç¶šå¤‰æ•° â†” ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ«å¤‰æ•° â†” ãƒ€ãƒŸãƒ¼å¤‰æ•°
    - å¤–ã‚Œå€¤ãƒ»æ¬ æå€¤ã«å¯¾å‡¦
    - æ–‡å­—åˆ—ã‹ã‚‰æ•°å€¤ã‚„æ—¥æ™‚ã‚’æŠœãå‡ºã™

<small style="display: block; text-align: right;"><a href="https://www.amazon.co.jp/dp/4774196479/ref=as_li_ss_tl?ie=UTF8&linkCode=ll1&tag=heavywatal-22&linkId=8a3fd4e9a0c944b1b41242bbab8d147b">
æœ¬æ©‹æ™ºå…‰ã€Œå‰å‡¦ç†å¤§å…¨ã€
</a></small>

---
## dplyr --- data.frameã®é«˜é€Ÿå‡¦ç†æ‹…å½“

<a href="https://dplyr.tidyverse.org/">
<img src="/_img/hex-stickers/dplyr.webp" width="120" align="right">
</a>

ã‚·ãƒ³ãƒ—ãƒ«ãªé–¢æ•°ãŒãŸãã•ã‚“ã€‚ç¹‹ã’ã¦ä½¿ã† (piping)

æŠ½å‡º
: åˆ—: `select()`,
: è¡Œ: `filter()`, `distinct()`, `slice()`

è¦ç´„ãƒ»é›†è¨ˆ
: `group_by()`, `summarize()`, `count()`

ä¸¦ã¹æ›¿ãˆ
: `arrange()`, `relocate()`

åˆ—ã®è¿½åŠ ãƒ»å¤‰æ›´
: `mutate()`, `rename()`

çµåˆ
: è¡Œæ–¹å‘: `bind_rows()`
: åˆ—æ–¹å‘: `left_join()`, `inner_join()`, `full_join()`


---
## è¡Œã®çµåˆ: `bind_rows()`

ä¾‹ã€‚å…ˆé ­ã¨æœ«å°¾ã‚’6è¡Œãšã¤å–ã£ã¦ã²ã¨ã¤ã®è¡¨ã«çµåˆã™ã‚‹:
```{r bind_rows}
bind_rows(head(diamonds), tail(diamonds))
```

ğŸ”° `mpg` ã§åŒæ§˜ã«3è¡Œãšã¤å–ã£ã¦çµåˆã—ã¦ã¿ã‚ˆã†


---
## å…±é€šã™ã‚‹åˆ—ã§çµåˆ: `full_join()`

ä»–æ–¹ã«ç„¡ã„éƒ¨åˆ†ã‚’ `NA` ã§è£œå®Œã—ã¦**å·¦å³ã¨ã‚‚å…¨è¡Œ**ä¿æŒ:
```{r full_join}
full_join(band_members, band_instruments, by = "name")
```
```
band_members          band_instruments
   name    band          name  plays
  <chr>   <chr>         <chr>  <chr>
1  Mick  Stones       1  John guitar
2  John Beatles       2  Paul   bass
3  Paul Beatles       3 Keith guitar
```

ğŸ”° ãƒ‘ã‚¤ãƒ—æ¼”ç®—å­ `%>%` ã‚’ä½¿ã£ã¦åŒã˜å‡¦ç†ã‚’ã—ã¦ã¿ã‚ˆã†

---
## å…±é€šã™ã‚‹åˆ—ã§çµåˆ: `full_join()`

çµåˆã«ä½¿ã†åˆ—ã®åå‰ãŒé•ã£ã¦ã¦ã‚‚å¤§ä¸ˆå¤«:
```{r full_join_by}
full_join(band_members, band_instruments2, by = c(name = "artist"))
```
```
band_members          band_instruments2
   name    band         artist  plays
  <chr>   <chr>          <chr>  <chr>
1  Mick  Stones       1   John guitar
2  John Beatles       2   Paul   bass
3  Paul Beatles       3  Keith guitar
```

ğŸ”° ãƒ‘ã‚¤ãƒ—æ¼”ç®—å­ `%>%` ã‚’ä½¿ã£ã¦åŒã˜å‡¦ç†ã‚’ã—ã¦ã¿ã‚ˆã†

---
## å…±é€šã™ã‚‹åˆ—ã§çµåˆ: `left_join()`

å³å´ã«ç„¡ã„éƒ¨åˆ†ã‚’ `NA` ã§è£œå®Œã—ã¦**å·¦å´ã ã‘å…¨è¡Œ**ä¿æŒ:
```{r left_join}
left_join(band_members, band_instruments, by = "name")
```
```
band_members          band_instruments
   name    band          name  plays
  <chr>   <chr>         <chr>  <chr>
1  Mick  Stones       1  John guitar
2  John Beatles       2  Paul   bass
3  Paul Beatles       3 Keith guitar
```

ãã®é€†ã¯ `right_join()`

ğŸ”° ãƒ‘ã‚¤ãƒ—æ¼”ç®—å­ `%>%` ã‚’ä½¿ã£ã¦åŒã˜å‡¦ç†ã‚’ã—ã¦ã¿ã‚ˆã†

---
## å…±é€šã™ã‚‹åˆ—ã§çµåˆ: `inner_join()`

å·¦å³ã¨ã‚‚ã«**å…±é€šã™ã‚‹å€¤ã®ã‚ã‚‹è¡Œã ã‘**ä¿æŒ:
```{r inner_join}
inner_join(band_members, band_instruments, by = "name")
```
```
band_members          band_instruments
   name    band          name  plays
  <chr>   <chr>         <chr>  <chr>
1  Mick  Stones       1  John guitar
2  John Beatles       2  Paul   bass
3  Paul Beatles       3 Keith guitar
```

ğŸ”° ãƒ‘ã‚¤ãƒ—æ¼”ç®—å­ `%>%` ã‚’ä½¿ã£ã¦åŒã˜å‡¦ç†ã‚’ã—ã¦ã¿ã‚ˆã†

---
## joinã¾ã¨ã‚

<figure>
<a href="https://r4ds.had.co.nz/relational-data.html#mutating-joins">
<img src="/slides/image/r4ds/join.png" height="550">
<br>
<figcaption><small>https://r4ds.had.co.nz/relational-data.html#mutating-joins</small></figcaption>
</a>
</figure>


---
## joinä¾‹é¡Œ: `nycflights13` ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ

ğŸ”° é–¢é€£ã™ã‚‹data.frameã‚’ã„ã‚ã„ã‚ãªæ–¹æ³•ã§çµåˆã—ã¦ã¿ã‚ˆã†ã€‚

```r
install.packages("nycflights13")
library(nycflights13)
data(package = "nycflights13")
# airlines, airports, flights, planes, weather
```

<figure>
<a href="https://r4ds.had.co.nz/relational-data.html#nycflights13-relational">
<img src="/slides/image/r4ds/relational-nycflights.png" height="320">
<br>
<figcaption><small>https://r4ds.had.co.nz/relational-data.html#nycflights13-relational</small></figcaption>
</a>
</figure>


---
## tidyr --- data.frameã®å¤‰å½¢ãƒ»æ•´å½¢æ‹…å½“

<a href="https://tidyr.tidyverse.org/">
<img src="/_img/hex-stickers/tidyr.webp" width="120" align="right">
</a>

æ¨ªåºƒã‹ã‚‰ç¸¦é•·ã«
: `pivot_longer()`, <strike><code>gather()</code></strike>

ç¸¦é•·ã‹ã‚‰æ¨ªåºƒã«
: `pivot_wider()`, <strike><code>spread()</code></strike>

åˆ—ã‚’åˆ†é›¢ã€çµåˆ
: `separate()`, `unite()`

å…¥ã‚Œå­æ§‹é€ ã‚’ã¤ãã‚‹ã€è§£æ¶ˆã™ã‚‹
: `nest()`, `unnest()`

*etc.*


---
## `pivot_longer()` æ¨ªåºƒã‹ã‚‰ç¸¦é•·ã«

è¤‡æ•°åˆ—ã«ã¾ãŸãŒã‚‹å€¤ã‚’1åˆ—ã«ã™ã‚‹ã€‚<br>
ãã®ãƒ©ãƒ™ãƒ«ã‚‚åˆã‚ã›ã¦ç§»å‹•ã€‚

<figure>
<a href="https://r4ds.had.co.nz/tidy-data.html#longer">
<img src="/slides/image/r4ds/tidy-gather.png" width="800">
<br>
<figcaption><small>https://r4ds.had.co.nz/tidy-data.html#longer</small></figcaption>
</a>
</figure>

---
## `pivot_longer()` æ¨ªåºƒã‹ã‚‰ç¸¦é•·ã«: `relig_income` ã®ä¾‹

å®—æ•™ã¨åå…¥ã®é–¢ä¿‚ã‚’èª¿æŸ»ã—ãŸãƒ‡ãƒ¼ã‚¿ã€‚<br>
ä¸–å¸¯æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆãŒè¤‡æ•°åˆ—ã«ã¾ãŸãŒã£ã¦ã„ã‚‹ã€‚

```{r relig_income}
print(relig_income)
```

---
## `pivot_longer()` æ¨ªåºƒã‹ã‚‰ç¸¦é•·ã«: `relig_income` ã®ä¾‹

å®—æ•™ã¨åå…¥ã®é–¢ä¿‚ã‚’èª¿æŸ»ã—ãŸãƒ‡ãƒ¼ã‚¿ã€‚<br>
ã“ã†ãªã£ã¦ãŸã‚‰ggplotã§ãã‚‹ã®ã«ã€‚

<div class="column-container">
<div class="column">

```r
print(relig_long)
```
```
        religion             income count
           <chr>              <chr> <dbl>
  1     Agnostic              <$10k    27
  2     Agnostic            $10-20k    34
  3     Agnostic            $20-30k    60
  4     Agnostic            $30-40k    81
 --
177 Unaffiliated           $75-100k   407
178 Unaffiliated          $100-150k   321
179 Unaffiliated              >150k   258
180 Unaffiliated Don't know/refused   597
```

</div>
<div class="column">

```{r relig_income-plot, echo = FALSE, fig.width = 4.5, fig.height = 6}
relig_income %>%
  pivot_longer(!religion, names_to = "income", values_to = "count") %>%
  mutate(income = na_if(income, "Don't know/refused")) %>%
  mutate(income = factor(income, levels = rev(unique(income)))) %>%
  ggplot() +
  aes(religion, count) +
  geom_col(aes(fill = income), position = "fill") +
  scale_fill_viridis_d(na.value = "#cccccc") +
  scale_x_discrete(limits = rev(relig_income$religion)) +
  coord_flip() +
  theme_classic() +
  theme(axis.title = element_blank())
```

</div>
</div>

---
## `pivot_longer()` æ¨ªåºƒã‹ã‚‰ç¸¦é•·ã«: `relig_income` ã®ä¾‹

è¤‡æ•°åˆ—ã«ã¾ãŸãŒã£ã¦ã„ã‚‹ä¸–å¸¯æ•°ã‚«ã‚¦ãƒ³ãƒˆã‚’ `count` 1åˆ—ã«ç§»å‹•ã€‚<br>
åˆ—åã«ãªã£ã¦ãŸåå…¥å¸¯ã‚’ `income` åˆ—ã«ç§»å‹•ã€‚

```{r pivot_longer}
relig_long = relig_income[1:2, 1:4] %>% print() %>%
  pivot_longer(!religion, names_to = "income", values_to = "count") %>%
  print()
```

ç§»å‹•ã™ã‚‹åˆ—ã‚’æŒ‡å®šã™ã‚‹ `!religion` ã®ã¨ã“ã‚ã¯ç›´æ¥ `2:10` ã¨ã‹ã‚‚å¯ã€‚


---
## `pivot_longer()` æ¨ªåºƒã‹ã‚‰ç¸¦é•·ã«: ç·´ç¿’å•é¡Œ

ğŸ”° `world_bank_pop` ã®äººå£ãƒ‡ãƒ¼ã‚¿ã‚’ç¸¦é•·ã«ã—ã¦ã¿ã‚ˆã†

```{r world_bank_pop}
print(world_bank_pop)
```


---
## `pivot_wider()` ç¸¦é•·ã‹ã‚‰æ¨ªåºƒã«

1åˆ—ã«åã¾ã£ã¦ã„ãŸå€¤ã‚’è¤‡æ•°åˆ—ã®è¡Œåˆ—ã«å¤‰æ›ã€‚<br>
ãã®ãƒ©ãƒ™ãƒ«ã‚’åˆ—ã®åå‰ã«ã™ã‚‹ã€‚

<figure>
<a href="https://r4ds.had.co.nz/tidy-data.html#wider">
<img src="/slides/image/r4ds/tidy-spread.png" height="480">
<br>
<figcaption><small>https://r4ds.had.co.nz/tidy-data.html#wider</small></figcaption>
</a>
</figure>

---
## `pivot_wider()` ç¸¦é•·ã‹ã‚‰æ¨ªåºƒã«: `fish_encounters`

ç™ºä¿¡å™¨ã®ã¤ã„ãŸé­šãŒè¦³æ¸¬åœ°ç‚¹ã‚’é€šéã—ãŸã“ã¨ã‚’è¨˜éŒ²ã—ãŸãƒ‡ãƒ¼ã‚¿ã€‚<br>
æ—¢ã«ggplotã—ã‚„ã™ãã†ãªå½¢ã ã‘ã©ã€ã‚ãˆã¦1é­š1è¡Œã®æ¨ªåºƒã«ã—ãŸã„ã€‚

<div class="column-container">
<div class="column">

```{r fish_encounters}
print(fish_encounters)
```

</div>
<div class="column">

```r
print(fish_wide)
```
```{r fish_wide, echo = FALSE}
fish_encounters %>%
  pivot_wider(names_from = station, values_from = seen)
```

</div>
</div>

---
## `pivot_wider()` ç¸¦é•·ã‹ã‚‰æ¨ªåºƒã«: `fish_encounters`

è¦³æ¸¬åœ°ç‚¹ `station` ã‚’åˆ—åã«ç§»å‹•ã€‚<br>
è¦³å¯Ÿã•ã‚ŒãŸã‹ã©ã†ã‹ `seen` ã‚’å„åˆ—ã«ç§»å‹•ã€‚å­˜åœ¨ã—ãªã‘ã‚Œã° `NA`

```{r pivot_wider}
fish_encounters %>%
  pivot_wider(names_from = station, values_from = seen)
```

`values_fill = 0` ã¨ã™ã‚Œã° `NA` ã˜ã‚ƒãªã `0` ã§åŸ‹ã‚ã‚‰ã‚Œã‚‹ã€‚

---
## `pivot_wider()` ç¸¦é•·ã‹ã‚‰æ¨ªåºƒã«: ç·´ç¿’å•é¡Œ

ğŸ”° `population` ã§1å¹´ã®ãƒ‡ãƒ¼ã‚¿ãŒ1è¡Œã«ãªã‚‹ã‚ˆã†ã«å¤‰å½¢ã—ã‚ˆã†<br>
ğŸ”° `population` ã§1å›½ã®ãƒ‡ãƒ¼ã‚¿ãŒ1è¡Œã«ãªã‚‹ã‚ˆã†ã«å¤‰å½¢ã—ã‚ˆã†

```{r population}
print(population)
```

ğŸ”° `us_rent_income` ã§ `income` ã¨ `rent` ã®æ¨å®šå€¤ãŒãã‚Œãã‚Œåˆ—ã¨ãªã‚‹ã‚ˆã†ã«å¤‰å½¢ã—ã‚ˆã†

```{r us_rent_income}
print(us_rent_income)
```

---
## `separate()` åˆ—ã‚’åˆ†é›¢

<figure>
<a href="https://r4ds.had.co.nz/tidy-data.html#separate">
<img src="/slides/image/r4ds/tidy-separate.png" width="800">
<br>
<figcaption><small>https://r4ds.had.co.nz/tidy-data.html#separate</small></figcaption>
</a>
</figure>

---
## `separate()` åˆ—ã‚’åˆ†é›¢: `table3`

[R for Data Science](https://r4ds.had.co.nz/tidy-data.html#separate)
ã«ç™»å ´ã™ã‚‹ãŠè©¦ã—ãƒ‡ãƒ¼ã‚¿ã€‚

```{r table3}
print(table3)
```

---
## `separate()` åˆ—ã‚’åˆ†é›¢: `table3`

[R for Data Science](https://r4ds.had.co.nz/tidy-data.html#separate)
ã«ç™»å ´ã™ã‚‹ãŠè©¦ã—ãƒ‡ãƒ¼ã‚¿ã€‚

```{r separate}
table3 %>% separate(rate, into = c("cases", "population"), sep = "/")
```

`sep` ã¯æŒ‡å®šã—ãªãã¦ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨˜å·ã‚„ç©ºç™½ã‚’èªè­˜ã—ã¦ãã‚Œã‚‹ã€‚

---
## `unite()` åˆ—ã‚’èåˆ

<figure>
<a href="https://r4ds.had.co.nz/tidy-data.html#unite">
<img src="/slides/image/r4ds/tidy-unite.png" width="800">
<br>
<figcaption><small>https://r4ds.had.co.nz/tidy-data.html#unite</small></figcaption>
</a>
</figure>

---
## `unite()` åˆ—ã‚’èåˆ: `table5`

[R for Data Science](https://r4ds.had.co.nz/tidy-data.html#unite)
ã«ç™»å ´ã™ã‚‹ãŠè©¦ã—ãƒ‡ãƒ¼ã‚¿ã€‚

```{r table5}
print(table5)
```

---
## `unite()` åˆ—ã‚’èåˆ: `table5`

[R for Data Science](https://r4ds.had.co.nz/tidy-data.html#unite)
ã«ç™»å ´ã™ã‚‹ãŠè©¦ã—ãƒ‡ãƒ¼ã‚¿ã€‚

```{r unite}
table5 %>%
  unite(year, century, year, sep = "") %>%
  mutate(year = as.integer(year))
```

çµåˆç›´å¾Œã¯æ–‡å­—åˆ—ã«ãªã£ã¦ã„ã‚‹ã®ã§æ•°å€¤ãªã‚‰å¿˜ã‚Œãšã«å¤‰æ›ã€‚<br>
ã“ã†ã—ãŸãƒ‡ãƒ¼ã‚¿å†…å®¹ã‚’å¯¾è±¡ã¨ã™ã‚‹å‡¦ç†ã«ã¤ã„ã¦ã¯ã€æ¥é€±ãã‚ã—ãã€‚

---
## `separate()` / `unite()` ç·´ç¿’å•é¡Œ

ğŸ”° `table3` ã® `rate` ã‚’åˆ†å‰²ã—ãŸã‚ã¨ã€ã¾ãŸå…ƒã«æˆ»ã—ã¦ã¿ã‚ˆã†ã€‚

ğŸ”° `table3` ã® `year` ã‚’åˆ†å‰²ã—ã¦ `table5` ã‚’ä½œã£ã¦ã¿ã‚ˆã†ã€‚

```{r table3-practice}
print(table3)
```

ğŸ”° `world_bank_pop` ã® `indicator` ã‚’3åˆ—ã«åˆ†å‰²ã—ã¦ã¿ã‚ˆã†ã€‚

```{r world_bank_pop-practice}
print(world_bank_pop)
```

---
## `nest()` å…¥ã‚Œå­ã«ã™ã‚‹

ã‚°ãƒ«ãƒ¼ãƒ—æ¯ã«data.frameã‚’åŒºåˆ‡ã£ã¦listå‹ã®åˆ—ã«å…¥ã‚Œã‚‹ã€‚

<figure>
<a href="https://www.tidyverse.org/blog/2019/09/tidyr-1-0-0/">
<img src="/slides/image/rstats/nest-pack-chop.png" height="400">
<br>
<figcaption><small>https://www.tidyverse.org/blog/2019/09/tidyr-1-0-0/</small></figcaption>
</a>
</figure>

<div>
<a href="https://purrr.tidyverse.org/">
<img src="/_img/hex-stickers/purrr.webp" width="80" style="vertical-align: middle;">
purrrãƒ‘ãƒƒã‚±ãƒ¼ã‚¸</a>ã¨å…±ã«æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã¨å¼·åŠ› (ä»Šå›ã¯ç´¹ä»‹ã ã‘)
</div>

---
## `nest()` å…¥ã‚Œå­ã«ã™ã‚‹

ã‚°ãƒ«ãƒ¼ãƒ—æ¯ã«data.frameã‚’åŒºåˆ‡ã£ã¦listå‹ã®åˆ—ã«å…¥ã‚Œã‚‹ã€‚

```{r nest}
mpg_nested = mpg %>% nest(data = -drv) %>% print()
mpg_nested$data[[1]]
```

---
## å°‘ã—å‰ã«å‡ºã¦ããŸã“ã‚Œã€ãã‚ãã‚ã§ãã‚‹ã®ã§ã¯

```{r messy_example}
print(VADeaths)
```

â†“ ä¸‹ã”ã—ã‚‰ãˆ: ä½œå›³ãƒ»è§£æã§ä½¿ã„ã‚„ã™ã„æ•´ç„¶ãƒ‡ãƒ¼ã‚¿ã«

```{r tidy_vadeaths, echo=FALSE}
VADeaths %>%
  as.data.frame() %>%
  rownames_to_column("age") %>%
  pivot_longer(-age, names_to = c("region", "sex"), names_sep = " ", values_to = "death") %>%
  separate(age, c("lbound", "ubound"), convert = TRUE)
```

---
## ã¡ã‚‡ã£ã¨è£œè¶³

```{r vadeaths-class}
class(VADeaths)
rownames(VADeaths)
VADeaths %>%
  as.data.frame() %>%            # dplyr/tidyrã§æ‰±ã†ã®ã¯data.frame
  rownames_to_column("age") %>%  # è¡Œåã¯æ‰±ã„ã«ãã„ã®ã§æ™®é€šã®åˆ—ã«
  print()
```

---
## ä¾‹é¡Œ: `VADeaths` ã‚’ç¸¦é•·ã«ã—ã¦ggplotã—ã¦ã¿ã‚ˆã†

```{r vadeaths_rownames, results="hold"}
as.data.frame(VADeaths) %>%              # data.frameã«å¤‰æ›
  rownames_to_column("age")              # è¡Œåã‚’åˆ—ã«
```

<img src="figure/vadeaths_plot-1.png" alt="plot of chunk vadeaths_plot">


---
## ä¾‹é¡Œ: `VADeaths` ã‚’ç¸¦é•·ã«ã—ãŸã„

```{r vadeaths_longer, results="hold"}
as.data.frame(VADeaths) %>%              # data.frameã«å¤‰æ›
  rownames_to_column("age") %>%          # è¡Œåã‚’åˆ—ã«
  pivot_longer(-age, values_to = "death")     # ageä»¥å¤–ã‚’ç§»å‹•ã—ã¦ç¸¦é•·åŒ–
                                         # æ–°ã—ã„nameåˆ—ã‚’åˆ†å‰²
```

---
## ä¾‹é¡Œ: `VADeaths` ã‚’ç¸¦é•·ã«ã—ãŸã„

```{r vadeaths_region_sex, results="hold"}
as.data.frame(VADeaths) %>%              # data.frameã«å¤‰æ›
  rownames_to_column("age") %>%          # è¡Œåã‚’åˆ—ã«
  pivot_longer(-age, values_to = "death") %>% # ageä»¥å¤–ã‚’ç§»å‹•ã—ã¦ç¸¦é•·åŒ–
  separate(name, c("region", "sex"))     # æ–°ã—ã„nameåˆ—ã‚’åˆ†å‰²
```

---
## ä¾‹é¡Œ: `VADeaths` ã‚’ç¸¦é•·ã«ã—ãŸã„

```{r vadeaths_age, results="hold"}
va_deaths = as.data.frame(VADeaths) %>%  # data.frameã«å¤‰æ›
  rownames_to_column("age") %>%          # è¡Œåã‚’åˆ—ã«
  pivot_longer(-age, values_to = "death") %>% # ageä»¥å¤–ã‚’ç§»å‹•ã—ã¦ç¸¦é•·åŒ–
  separate(name, c("region", "sex")) %>% # æ–°ã—ã„nameåˆ—ã‚’åˆ†å‰²
  separate(age, c("lbound", "ubound"), "-", convert = TRUE) %>%
  print()                                # ä¸‹é™ã¨ä¸Šé™ã‚’åˆ†é›¢
```

---
## ä¾‹é¡Œ: `VADeaths` åˆ¥è§£

```{r vadeaths_pivot, results="hold"}
va_deaths = as.data.frame(VADeaths) %>%  # data.frameã«å¤‰æ›
  rownames_to_column("age") %>%          # è¡Œåã‚’åˆ—ã«
  pivot_longer(                          # ç¸¦é•·ã«å¤‰å½¢ã—ãŸã„
    -age,                                # ageä»¥å¤–ã®åˆ—ã«å…¥ã£ã¦ã‚‹å€¤ã‚’ç§»å‹•
    names_to = c("region", "sex"),       # å…ƒã®åˆ—åã‚’2ã¤ã«åˆ†é›¢
    names_sep = " ",                     # ã‚¹ãƒšãƒ¼ã‚¹ã§åˆ‡ã‚‹
    values_to = "death") %>%             # å€¤ã®è¡Œãå…ˆã®åˆ—å
  separate(age, c("lbound", "ubound"), "-", convert = TRUE) %>%
  print()                                # ä¸‹é™ã¨ä¸Šé™ã‚’åˆ†é›¢
```

---
## ä¾‹é¡Œ: `VADeaths` ä½œå›³ä¾‹

```{r vadeaths_plot, fig.height = 4, fig.width = 5}
ggplot(va_deaths) +
  aes(lbound, death) +
  geom_point(aes(color = sex, shape = region), size = 5) +
  theme_classic(base_size = 18)
```

---
## ä¾‹é¡Œ: `anscombe`

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r anscombe, results="hold"}
anscombe %>%
  rowid_to_column("id")              # IDã‚’ã¤ã‘ã¦ãŠã
                                     # x y ã§å§‹ã¾ã‚‹åˆ—ã®å€¤ã‚’ç§»ã—ã¦ç¸¦é•·ã«
```

ğŸ”° ã†ã¾ãå¤‰å½¢ã—ã¦ggplotã¨è¦ç´„çµ±è¨ˆé‡ã®è¨ˆç®—ã‚’ã—ã¦ã¿ã‚ˆã†


---
## ä¾‹é¡Œ: `anscombe`

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r anscombe_longer, results="hold"}
anscombe %>%
  rowid_to_column("id") %>%          # IDã‚’ã¤ã‘ã¦ãŠã
  pivot_longer(matches("^x|y"))      # x y ã§å§‹ã¾ã‚‹åˆ—ã®å€¤ã‚’ç§»ã—ã¦ç¸¦é•·ã«

                                     # nameåˆ—ã‚’åˆ†å‰²
```

---
## ä¾‹é¡Œ: `anscombe`

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r anscombe_separate, results="hold"}
anscombe %>%
  rowid_to_column("id") %>%          # IDã‚’ã¤ã‘ã¦ãŠã
  pivot_longer(matches("^x|y")) %>%  # x y ã§å§‹ã¾ã‚‹åˆ—ã®å€¤ã‚’ç§»ã—ã¦ç¸¦é•·ã«
  separate(name, c("axis", "group"), 1L, convert = TRUE)
                                     # nameåˆ—ã‚’åˆ†å‰²
```

---
## ä¾‹é¡Œ: `anscombe`

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r anscombe_wider, results="hold"}
tidy_anscombe = anscombe %>%
  rowid_to_column("id") %>%          # IDã‚’ã¤ã‘ã¦ãŠã
  pivot_longer(matches("^x|y")) %>%  # x y ã§å§‹ã¾ã‚‹åˆ—ã®å€¤ã‚’ç§»ã—ã¦ç¸¦é•·ã«
  separate(name, c("axis", "group"), 1L, convert = TRUE) %>%
                                     # nameåˆ—ã‚’åˆ†å‰²
  pivot_wider(names_from = axis, values_from = value) %>%
                                     # axisåˆ—å†…ã® x y ã‚’åˆ—ã«ã—ã¦æ¨ªåºƒåŒ–
  arrange(group) %>%                 # ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ä¸¦ã¹ã‚‹
  print()                            # ggplotã—ãŸã„å½¢ï¼
```

---
## ä¾‹é¡Œ: `anscombe` åˆ¥è§£

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r anscombe_pivot}
tidy_anscombe = anscombe %>%
  pivot_longer(                       # ç¸¦é•·ã«å¤‰å½¢ã—ãŸã„
    everything(),                     # ã™ã¹ã¦ã®åˆ—ã«ã¤ã„ã¦
    names_to = c(".value", "group"),  # æ–°ã—ã„åˆ—å
    names_sep = 1L,                   # åˆ‡ã‚‹ä½ç½®
    names_transform = list(group = as.integer)) %>% # å‹å¤‰æ›
  arrange(group) %>%                  # ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ä¸¦ã¹ã‚‹
  print()                             # ggplotã—ãŸã„å½¢ï¼
```


---
## ä¾‹é¡Œ: `anscombe` ä½œå›³ä¾‹

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r plot_anscombe, fig.height=3, fig.width=10, out.width="98%"}
ggplot(tidy_anscombe) + aes(x, y) +
  geom_point(size = 3) +
  stat_smooth(method = lm, formula = y ~ x, se = FALSE, fullrange = TRUE) +
  facet_wrap(~ group, nrow = 1L) +
  theme_bw(base_size = 16)
```

---
## ä¾‹é¡Œ: `anscombe` è¦ç´„

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r summarize_anscombe}
tidy_anscombe %>%
  group_by(group) %>%   # groupåˆ—ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦
  summarize(            # x, yåˆ—ã‚’ä½¿ã£ã¦summarize
    mean_x = mean(x),
    mean_y = mean(y),
    sd_x = sd(x),
    sd_y = sd(y),
    cor_xy = cor(x, y)
  )
```


---
## å‰å‡¦ç†ã¯å¤§ãã2ã¤ã«åˆ†ã‘ã‚‰ã‚Œã‚‹

<div style="float: right;">
<a href="https://dplyr.tidyverse.org/">
<img src="/_img/hex-stickers/dplyr.webp" width="120">
</a><br>
<a href="https://tidyr.tidyverse.org/">
<img src="/_img/hex-stickers/tidyr.webp" width="120">
</a>
</div>

- **ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å¯¾è±¡ã¨ã™ã‚‹å‡¦ç†** ğŸ‘ˆ ç¬¬3, 4å› æœ¬æ—¥ã®è©±é¡Œ
    - ä½¿ã„ãŸã„éƒ¨åˆ†ã ã‘æŠ½å‡º --- `select()`, `filter()`
    - ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ç‰¹å¾´ã‚’è¦ç´„ --- `group_by()`, `summarize()`
    - ä½•ã‹ã®é †ã«ä¸¦ã¹æ›¿ãˆ --- `arrange()`
    - ç•°ãªã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã®çµåˆ --- `*_join()`
    - å¤‰å½¢: ç¸¦é•· â†” æ¨ªåºƒ --- `pivot_longer()`, `pivot_wider()`
- ãƒ‡ãƒ¼ã‚¿å†…å®¹ã‚’å¯¾è±¡ã¨ã™ã‚‹å‡¦ç† â€” ç¬¬5å› æ¥é€±
    - æ•°å€¤ã‚’å¤‰æ›ã™ã‚‹ (e.g., å¯¾æ•°ã€åº§æ¨™ç³»)
    - å¤‰æ›: é€£ç¶šå¤‰æ•° â†” ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ«å¤‰æ•° â†” ãƒ€ãƒŸãƒ¼å¤‰æ•°
    - å¤–ã‚Œå€¤ãƒ»æ¬ æå€¤ã«å¯¾å‡¦
    - æ–‡å­—åˆ—ã‹ã‚‰æ•°å€¤ã‚„æ—¥æ™‚ã‚’æŠœãå‡ºã™

<small style="display: block; text-align: right;"><a href="https://www.amazon.co.jp/dp/4774196479/ref=as_li_ss_tl?ie=UTF8&linkCode=ll1&tag=heavywatal-22&linkId=8a3fd4e9a0c944b1b41242bbab8d147b">
æœ¬æ©‹æ™ºå…‰ã€Œå‰å‡¦ç†å¤§å…¨ã€
</a></small>


---
## æ†¶ãˆãªãã¦ã„ã„ã€‚å…¬å¼ã‚µã‚¤ãƒˆãªã©ã‚’è¦‹ãªãŒã‚‰ä½œæ¥­

<figure>
<a href="https://dplyr.tidyverse.org/">
<img src="/slides/image/rstats/dplyr-website.png" width="90%">
<figcaption><small>https://dplyr.tidyverse.org/</small></figcaption>
</a>
</figure>


---
## Reference

R for Data Science --- Hadley Wickham and Garrett Grolemund
: <https://r4ds.had.co.nz/>,
  [Paperback](https://amzn.to/2tbRmVc),
  [æ—¥æœ¬èªç‰ˆæ›¸ç±](https://amzn.to/2yyFRKt)

[å‰å‡¦ç†å¤§å…¨ --- æœ¬æ©‹æ™ºå…‰](https://www.amazon.co.jp/dp/4774196479/ref=as_li_ss_tl?ie=UTF8&linkCode=ll1&tag=heavywatal-22&linkId=8a3fd4e9a0c944b1b41242bbab8d147b)<br>
[Rãƒ¦ãƒ¼ã‚¶ã®ãŸã‚ã®RStudio[å®Ÿè·µ]å…¥é–€ (å®‡å®™æœ¬) --- æ¾æ‘ã‚‰](https://amzn.to/3eBprm5)

æ•´ç„¶ãƒ‡ãƒ¼ã‚¿ã¨ã¯ä½•ã‹ --- [@f_nisihara](https://twitter.com/f_nisihara)
: [Speaker Deck](https://speakerdeck.com/fnshr/zheng-ran-detatutenani),
  [Colorless Green Ideas](https://id.fnshr.info/2017/01/09/tidy-data-intro/)

Official documents:
: [tidyverse](https://www.tidyverse.org/),
  [dplyr](https://dplyr.tidyverse.org/),
  [tidyr](https://tidyr.tidyverse.org/),
  [purrr](https://purrr.tidyverse.org/),
  [tibble](https://tibble.tidyverse.org/),
  [readr](https://readr.tidyverse.org/),

Older versions
: ã€Œ[Rã«ã‚„ã‚‰ã›ã¦æ¥½ã—ã‚ˆã† â€” ãƒ‡ãƒ¼ã‚¿ã®å¯è¦–åŒ–ã¨ä¸‹ã”ã—ã‚‰ãˆ](https://heavywatal.github.io/slides/nagoya2018/)ã€
   å²©åµœèˆª 2018
: ã€ŒRã‚’ç”¨ã„ãŸãƒ‡ãƒ¼ã‚¿è§£æã®åŸºç¤ã¨å¿œç”¨ã€çŸ³å·ç”±å¸Œ 2019 åå¤å±‹å¤§å­¦

<a href="5-content.html" rel="next" class="readmore">
5. ãƒ‡ãƒ¼ã‚¿å†…å®¹ã®å‡¦ç†: æ•°å€¤ã€æ–‡å­—åˆ—ã€æ—¥æ™‚ãªã©ã€‚
</a>
