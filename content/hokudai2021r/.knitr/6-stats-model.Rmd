+++
url = "hokudai2021r/6-stats-model.html"
title = "6. çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°åŸºç¤ â€” Rã«ã‚„ã‚‰ã›ã¦æ¥½ã—ã‚ˆã† 2021 åŒ—å¤§"
linktitle = "çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°åŸºç¤: ç¢ºç‡åˆ†å¸ƒã€å°¤åº¦ã€ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«"
date = 2021-09-15T13:00:00+09:00
type = "reveal"
draft = false
+++


# [Rã«ã‚„ã‚‰ã›ã¦æ¥½ã—ã‚ˆã† â€” ãƒ‡ãƒ¼ã‚¿ã®å¯è¦–åŒ–ã¨ä¸‹ã”ã—ã‚‰ãˆ](.)

<div class="author">
å²©åµœ èˆª (Watal M. Iwasaki, PhD)
</div>

<div class="affiliation">
æ±åŒ—å¤§å­¦ ç”Ÿå‘½ç§‘å­¦ç ”ç©¶ç§‘ é€²åŒ–ã‚²ãƒãƒŸã‚¯ã‚¹åˆ†é‡ ç‰¹ä»»åŠ©æ•™<br>
(Graduate School of Life Sciences, Tohoku University)
</div>

<ol>
<li><a href="1-introduction.html">å…¥é–€1: ãƒ‡ãƒ¼ã‚¿è§£æã®å…¨ä½“åƒã€‚Rã‚’ä½¿ã†ãƒ¡ãƒªãƒƒãƒˆã€‚Rã®åŸºæœ¬ã€‚</a>
<li><a href="2-visualization.html">å…¥é–€2: ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–ã®é‡è¦æ€§ã¨æ–¹æ³•ã€‚</a>
<li><a href="3-structure1.html">ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å‡¦ç†1: æŠ½å‡ºã€é›†ç´„ãªã©ã€‚</a>
<li><a href="4-structure2.html">ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å‡¦ç†2: çµåˆã€å¤‰å½¢ãªã©ã€‚</a>
<li><a href="5-content.html">ãƒ‡ãƒ¼ã‚¿å†…å®¹ã®å‡¦ç†: æ•°å€¤ã€æ–‡å­—åˆ—ã€æ—¥æ™‚ãªã©ã€‚</a>
<li class="current-deck"><a href="6-stats-model.html">çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°åŸºç¤: ç¢ºç‡åˆ†å¸ƒã€å°¤åº¦ã€ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«</a>
</ol>

<div class="footnote">
2021-09-13 åŒ—æµ·é“å¤§å­¦ ç”Ÿå‘½ç§‘å­¦é™¢ ç‰¹åˆ¥è¬›ç¾©
<a href="https://heavywatal.github.io/slides/hokudai2021r/">https://heavywatal.github.io/slides/hokudai2021r/</a>
</div>

```{r setup-global, include=FALSE, code=readLines("setup.R")}
```

```{r setup-local, include=FALSE}
library(ggplot2)
library(tibble)
library(dplyr)
library(tidyr)
knitr::opts_chunk$set(cache = TRUE)
```


---
## ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦ã‚„ã‚ŠãŸã„ã“ã¨

- ç¾è±¡ã‚’**ç†è§£**ã—ãŸã„
- å°†æ¥ã‚’**äºˆæ¸¬**ã—ãŸã„
- ã‚‚ã®ã‚’**åˆ†é¡ãƒ»åˆ¤åˆ¥**ã—ãŸã„
- æŒ™å‹•ã‚’**åˆ¶å¾¡**ã—ãŸã„
- æ–°ã—ã„ä½•ã‹ã‚’**ç”Ÿæˆ**ã—ãŸã„

ãã®ãŸã‚ã«è§£æã¯å¿…è¦ï¼Ÿ
æœªåŠ å·¥ã®ç”Ÿãƒ‡ãƒ¼ã‚¿ã“ãå®ï¼Ÿ

---
## ãƒ‡ãƒ¼ã‚¿è§£æã£ã¦å¿…è¦ï¼Ÿ ç”Ÿãƒ‡ãƒ¼ã‚¿è¦‹ã‚Œã°ã„ã„ã¹ï¼Ÿ

å¾€ã€…ã«ã—ã¦è¤‡é›‘éãã€æƒ…å ±å¤šã™ãã€ãã®ã¾ã¾ã§ã¯æ‰‹ã«è² ãˆãªã„

```{r diamonds}
print(ggplot2::diamonds)
```

ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰53,940å€‹ã«ã¤ã„ã¦10é …ç›®ã®å€¤ã‚’æŒã¤ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ

---
## è¦ç´„çµ±è¨ˆé‡ã‚’è¦‹ã¦ã¿ã‚ˆã†

å„åˆ—ã®**å¹³å‡**ã¨ã‹**æ¨™æº–åå·®**ã¨ã‹:

```{r summary-diamonds, echo = FALSE}
diamonds %>%
  dplyr::summarize(across(where(is.numeric), list(mean = mean, sd = sd, max = max))) %>%
  dplyr::mutate(across(where(is.numeric), round, digits = 2)) %>%
  tidyr::pivot_longer(everything(), names_to = c(".value", "stat"), names_sep = "_")
```

å¤§ãã• `carat` ã¨ä¾¡æ ¼ `price` ã®**ç›¸é–¢ä¿‚æ•°**ã¯ 0.92 (ã‹ãªã‚Šé«˜ã„)ã€‚
```{r cor-diamonds, eval = FALSE, include = FALSE}
cor(diamonds$carat, diamonds$price)
# [1] 0.9215913
```

**ç”Ÿã®ã¾ã¾ã‚ˆã‚Šã¯æŠŠæ¡ã—ã‚„ã™ã„**ã‹ã‚‚ã€‚

ã—ã‹ã—è¦æ³¨æ„...

---
## å¹³å‡å€¤ã°ã‹ã‚Šè¦‹ã¦å¯è¦–åŒ–ã‚’æ€ ã‚‹ã¨æ§‹é€ ã‚’è¦‹é€ƒã™

<figure style="position: relative;">
<a href="https://www.autodesk.com/research/publications/same-stats-different-graphs">
<img src="/slides/image/rstats/datasaurus.png" width="800">
<figcaption class="url">https://www.autodesk.com/research/publications/same-stats-different-graphs</figcaption>
</a>
<img src="/slides/image/rstats/DataDino-600x455.gif" width="180"
     style="position: absolute; left: 0; top: 0; z-index: 255;">
</figure>


---
## ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–ã¯ç†è§£ã®ç¬¬ä¸€æ­©

æƒ…å ±ã‚’ã†ã¾ãçµã£ã¦æ•´ç† â†’ **ç›´æ„Ÿçš„ã«ã‚ã‹ã‚‹**

<img src="figure/simplify-diamonds-1.png" alt="plot of chunk simplify-diamonds">

`carat` ãŒå¤§ãã„ã»ã© `price` ã‚‚é«˜ã„ã‚‰ã—ã„ã€‚<br>
ãã®åº¦åˆã„ã¯ `clarity` ã«ã‚ˆã£ã¦ç•°ãªã‚‹ã‚‰ã—ã„ã€‚

---
## çµ±è¨ˆã¨ã¯

ãƒ‡ãƒ¼ã‚¿ã‚’ã†ã¾ãã¾ã¨ã‚ã€ãã‚Œã«åŸºã¥ã„ã¦æ¨è«–ã™ã‚‹ãŸã‚ã®æ‰‹æ³•ã€‚

- **è¨˜è¿°çµ±è¨ˆ**: ãƒ‡ãƒ¼ã‚¿ãã®ã‚‚ã®ã‚’è¦ç´„ã™ã‚‹
    - è¦ç´„çµ±è¨ˆé‡ (e.g., å¹³å‡ã€æ¨™æº–åå·®ã€etc.)
    - ä½œå›³ã€ä½œè¡¨
- **æ¨æ¸¬çµ±è¨ˆ**: ãƒ‡ãƒ¼ã‚¿ã®èƒŒå¾Œã«ã‚ã‚‹æ¯é›†å›£ãƒ»ç”Ÿæˆéç¨‹ã‚’è€ƒãˆã‚‹
    - æ•°ç†ãƒ¢ãƒ‡ãƒ«
    - ç¢ºç‡åˆ†å¸ƒ
    - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿(æ¯æ•°)

ã€Œã‚°ãƒ©ãƒ•ã‚’çœºã‚ã¦ãªã‚“ã¨ãªãåˆ†ã‹ã‚‹ã€ä»¥ä¸Šã®åˆ†æã«ã¯**ãƒ¢ãƒ‡ãƒ«**ãŒå¿…è¦

---
## ãƒ¢ãƒ‡ãƒ«ã¨ã¯

å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ ã‚’å˜ç´”åŒ–ãƒ»ç†æƒ³åŒ–ã—ã¦æ‰±ã„ã‚„ã™ãã—ãŸã‚‚ã®

Mathematical Model æ•°ç†ãƒ¢ãƒ‡ãƒ«<img src="../tokiomarine2021/image/hill-equation.png" width="150" align="right" style="margin: 0 -5px;">
: æ•°å­¦çš„ãªæ–¹ç¨‹å¼ã¨ã—ã¦è¨˜è¿°ã•ã‚Œã‚‹ã‚‚ã®ã€‚
: e.g., Lotka-Volterra eq., <span style="color: #888;">Hill eq.</span>
: <br>

Computational Model æ•°å€¤è¨ˆç®—ãƒ¢ãƒ‡ãƒ«<img src="/slides/image/tumopp/Chex_Lconst.gif" width="140" align="right">
: æ•°å€¤è¨ˆç®—ã®æ‰‹ç¶šãã¨ã—ã¦è¨˜è¿°ã•ã‚Œã‚‹ã‚‚ã®ã€‚
: e.g., Schellingâ€™s Segregation Model, <span style="color: #888;"><em>tumopp</em></span>
: <br>

Concrete Model å…·è±¡ãƒ¢ãƒ‡ãƒ«<img src="../tokiomarine2021/image/weisberg-sfbay.jpg" width="260" align="right">
: å…·ä½“çš„ãªäº‹ç‰©ã§ä½œã‚‰ã‚Œã‚‹ã‚‚ã®ã€‚
: e.g., San Francisco Bay-Delta Model

<cite>
Weisberg 2012 "Simulation and Similarity" (ç§‘å­¦ã¨ãƒ¢ãƒ‡ãƒ«)
</cite>

???
æ•°ç†ãƒ¢ãƒ‡ãƒ«ãŒæ±ºå®šè«–çš„ã€æ•°å€¤è¨ˆç®—ãŒç¢ºç‡è«–çš„ã€ã«ãªã‚‹å ´åˆãŒå¤šã„ã‘ã©å¿…ãšã—ã‚‚ãã†ã§ã¯ãªã„ã€‚
è§£æçš„ã«è§£ãã“ã¨ã‚’è«¦ã‚ã¦è¨ˆç®—æ©Ÿã«ã‚„ã‚‰ã›ã‚‹ã¨ã„ã†ç‚¹ã§å®Ÿè£…æ–¹æ³•ã¯ç•°ãªã‚‹ãŒã€
æ•°ç†çš„ã«è¨˜è¿°ã—ã¦è§£é‡ˆã™ã‚‹ã¨ã„ã†å¤§æ ã§ã¯åŒã˜ã¨ã¿ãªã—ãŸã»ã†ãŒã„ã„ã‹ã‚‚ã—ã‚Œãªã„ã€‚

ãƒ—ãƒ©ãƒ¢ãƒ‡ãƒ«: è»Šã‚„é£›è¡Œæ©Ÿã®é‡ã•ãƒ»æè³ªã¯ç„¡è¦–ã—ã¦è‰²ã‚„å½¢ã‚’æ¨¡å€£
<img src="../lifesci2020seminar/image/schelling-segregation.gif" width="160" align="right" style="margin: -20px -15px; height: 160px; object-fit: cover;">

---
## ãƒ‡ãƒ¼ã‚¿ç§‘å­¦ã«ãŠã‘ã‚‹æ•°ç†ãƒ¢ãƒ‡ãƒ«

ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚’ã†ã¾ãçœŸä¼¼ã§ããã†ãªä»®å®šã®æ•°å¼è¡¨ç¾ã€‚<br>
&nbsp;

<figure>
<img src="../tokiomarine2021/math-model.drawio.svg"><br>
<figcaption><cite>ã€Œãƒ‡ãƒ¼ã‚¿åˆ†æã®ãŸã‚ã®æ•°ç†ãƒ¢ãƒ‡ãƒ«å…¥é–€ã€æ±Ÿå´è²´è£• 2020 ã‚ˆã‚Šæ”¹å¤‰</cite></figcaption>
</figure>


???

ç¢ºç‡ãƒ¢ãƒ‡ãƒ«: æ±ºå®šè«–çš„ãªãƒ¢ãƒ‡ãƒ«ã˜ã‚ƒãªãã¦ç¢ºç‡è«–çš„ãªã‚†ã‚‰ãã‚’å°å…¥ã—ãŸã‚‚ã®ã€‚
ãŸã ã—ã€å¤§å¡šæ·³ã•ã‚“ã®å®šç¾©ã¯ç•°ãªã‚‹ã€‚
å¸°ç´æ¨è«–ã‚’å¯èƒ½ã«ã™ã‚‹æ çµ„ã¿ã¨ã—ã¦è‡ªç„¶ã®æ–‰ä¸€æ€§(ãƒ’ãƒ¥ãƒ¼ãƒ )ã‚’ä»®å®šã—ãŸä¸Šã§ã€
ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ã„ã‚‹çœŸã®ç¾è±¡ã‚’ç¢ºç‡ç”¨èªã§è¨˜è¿°ã—ãŸã‚‚ã®ãŒç¢ºç‡ãƒ¢ãƒ‡ãƒ«ã ã€ã¨ã„ã†æ„Ÿã˜ã€‚
ãã“ã‹ã‚‰ã•ã‚‰ã«å¼·ã„ä»®å®šã¨ã—ã¦ãƒ‘ãƒ©ãƒ¡ãƒˆãƒªãƒƒã‚¯ãªç¢ºç‡åˆ†å¸ƒã‚’ç”Ÿæˆå…ƒã¨ã—ãŸã®ãŒçµ±è¨ˆãƒ¢ãƒ‡ãƒ«ã€‚

---
## ãƒ‡ãƒ¼ã‚¿ç§‘å­¦ã«ãŠã‘ã‚‹æ•°ç†ãƒ¢ãƒ‡ãƒ«

ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚’ã†ã¾ãçœŸä¼¼ã§ããã†ãªä»®å®šã®æ•°å¼è¡¨ç¾ã€‚<br>
e.g., å¤§ãã„ã»ã©é«˜ãå£²ã‚Œã‚‹: $\text{price} = A \times \text{carat} + B + \epsilon$

```{r lm-diamonds, echo = FALSE, fig.height = 5, fig.width = 6}
diamonds %>%
  dplyr::filter(clarity %in% c("I1", "SI2", "IF")) %>%
  ggplot(aes(carat, price)) +
  geom_point(alpha = 0.3, size = 3) +
  stat_smooth(formula = y ~ x, method = lm, se = FALSE) +
  coord_cartesian(ylim = c(0, 20000)) +
  labs(title = "Diamonds") +
  theme_classic(base_size = 22)
```

æ–°ã—ãæ¡ã‚ŒãŸãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰ã®ä¾¡æ ¼äºˆæƒ³ã¨ã‹ã«ã‚‚ä½¿ãˆã‚‹ã€‚

ã“ã®ã‚ˆã†ã«ã€ŒYã‚’Xã®é–¢æ•°ã¨ã—ã¦è¡¨ã™ã€ã‚ˆã†ãªãƒ¢ãƒ‡ãƒ«ã‚’**å›å¸°**ã¨å‘¼ã¶ã€‚


---
## ä»Šå›ã¯å›å¸°ã‚’è»¸ã¨ã—ãŸçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã®è§£èª¬

å˜ç´”ãªç›´ç·šã‚ã¦ã¯ã‚ã‹ã‚‰å‡ºç™ºã—ã€ã¡ã‚‡ã£ã¨ãšã¤çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã€‚

<figure>
<a href="https://kuboweb.github.io/-kubo/ce/LinksGlm.html">
<img src="../tokiomarine2021/image/kubo-p2.png" width="100%">
<figcaption class="url">ä¹…ä¿ã•ã‚“ https://kuboweb.github.io/-kubo/ce/LinksGlm.html</figcaption>
</a>
</figure>


---
## å›å¸°ã¯æ•™å¸«ã‚ã‚Šæ©Ÿæ¢°å­¦ç¿’ã®ä¸€ç¨®ã¨ã‚‚è¨€ãˆã‚‹

<figure>
<img src="../tokiomarine2021/regression-in-ml.drawio.svg">
</figure>

ã§ã‚‚çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã¯ã„ã‚ã‚†ã‚‹â€œæ©Ÿæ¢°å­¦ç¿’â€ã¨ã¯é•ã†æ°—ã‚‚ã™ã‚‹...?


---
## ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã«ãŠã‘ã‚‹2ã¤ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

<figure>
<img src="../tokiomarine2021/model-approaches.drawio.svg"><br>
<figcaption><cite>ã€Œãƒ‡ãƒ¼ã‚¿åˆ†æã®ãŸã‚ã®æ•°ç†ãƒ¢ãƒ‡ãƒ«å…¥é–€ã€æ±Ÿå´è²´è£• 2020 ã‚ˆã‚Šæ”¹å¤‰</cite></figcaption>
</figure>

---
## ã©ã£ã¡ã‚‚çŸ¥ã£ã¦ãŠã„ã¦ä½¿ã„åˆ†ã‘ãŸã„

é …ç›®       | çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚° | è¿‘å¹´ã®æ©Ÿæ¢°å­¦ç¿’
---------- | -------------- | ----------------
ä¾‹ | ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«<br>éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ« | ãƒ©ãƒ³ãƒ€ãƒ ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆ<br>ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
ãƒ¢ãƒ‡ãƒ«æ§‹é€  | å˜ç´”åŒ–ã—ãŸã„ | æ€§èƒ½ã®ãŸã‚ãªã‚‰è¤‡é›‘åŒ–
ãƒ¢ãƒ‡ãƒ«è§£é‡ˆ | **ã“ã“ãŒå¼·ã¿** | é›£ã—ã„ã€‚é‡è¦–ã—ãªã„ã€‚é€”ä¸Šã€‚
äºˆæ¸¬ãƒ»ç”Ÿæˆ | ã†ã¾ãã™ã‚Œã°é ‘å¥ | **ä¸»ç›®çš„**ã€‚å¼·åŠ›ã€‚é«˜ç²¾åº¦
ãƒ‡ãƒ¼ã‚¿é‡   | å°‘ãªãã¦ã‚‚ãã‚Œãªã‚Š | å¤§é‡ã«å¿…è¦
è¨ˆç®—é‡     | å ´åˆã«ã‚ˆã‚‹  | å ´åˆã«ã‚ˆã‚‹


---
## æœ¬è¬›ç¾©ã®ãŠå“æ›¸ã

<figure style="float: right;">
<a href="https://kuboweb.github.io/-kubo/ce/IwanamiBook.html">
<img src="../tokiomarine2021/image/kubo-book.jpg" width="300" alt="ãƒ‡ãƒ¼ã‚¿è§£æã®ãŸã‚ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€ ä¹…ä¿æ‹“å¼¥ 2012">
</a>
</figure>

ä¹…ä¿å…ˆç”Ÿã®"ç·‘æœ¬"ã“ã¨<br>
ã€Œãƒ‡ãƒ¼ã‚¿è§£æã®ãŸã‚ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€ã€<br>
ã‚’ãƒ™ãƒ¼ã‚¹ã«å›å¸°åˆ†æã®æ¦‚è¦ã‚’ç´¹ä»‹ã€‚

1. ã‚¤ãƒ³ãƒˆãƒ­
1. çµ±è¨ˆãƒ¢ãƒ‡ãƒ«ã®åŸºæœ¬
    - ç¢ºç‡å¤‰æ•°ãƒ»**ç¢ºç‡åˆ†å¸ƒ** ğŸ‘ˆ æœ¬æ—¥ã®ä¸»å½¹
    - å°¤åº¦ãƒ»æœ€å°¤æ¨å®š
1. ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã€<del>æ··åˆãƒ¢ãƒ‡ãƒ«</del>
1. <del>ãƒ™ã‚¤ã‚ºçµ±è¨ˆã€éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«</del>

å›å¸°ã®ã‚­ãƒ¢ã¯**ç·šã§ã¯ãªãåˆ†å¸ƒ**


---
## å›å¸°ãƒ¢ãƒ‡ãƒ«ã®2æ®µéš

1. Define a **family of models**: ã ã„ãŸã„ã©ã‚“ãªå½¢ã‹ã€å¼ã‚’ãŸã¦ã‚‹
    - ç›´ç·š: $y = a_1 + a_2 x$
    - å¯¾æ•°: $\log(y) = a_1 + a_2 x$
    - äºŒæ¬¡æ›²ç·š: $y = a_1 + a_2 x^2$

2. Generate a **fitted model**: ãƒ‡ãƒ¼ã‚¿ã«åˆã†ã‚ˆã†ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´
    - $y = 3x + 7$
    - $y = 9x^2$

<a href="https://r4ds.had.co.nz/model-basics.html" class="url">https://r4ds.had.co.nz/model-basics.html</a>


---
## ãŸã¶ã‚“èº«é•·ãŒé«˜ã„ã»ã©ä½“é‡ã‚‚é‡ã„

ãªã‚“ã¨ãªã $y = a x + b$ ã§ã„ã„ç·šãŒå¼•ã‘ãã†<br>
&nbsp;

```{r weight-height, echo = FALSE, fig.height = 5, fig.width = 5}
n = 50
df_weight = tibble::tibble(
  height = rnorm(n, 1.70, 0.05),
  bmi = rnorm(n, 22, 1),
  weight = bmi * (height ** 2)
)
p_weight = ggplot(df_weight) + aes(height, weight) +
  geom_point(alpha = 0.5) +
  theme_bw(base_size = 20) + theme(panel.grid = element_blank())
p_weight
```


---
## ãŸã¶ã‚“èº«é•·ãŒé«˜ã„ã»ã©ä½“é‡ã‚‚é‡ã„

ãªã‚“ã¨ãªã $y = a x + b$ ã§ã„ã„ç·šãŒå¼•ã‘ãã†<br>
ã˜ã‚ƒã‚åˆ‡ç‰‡ã¨å‚¾ãã€ã©ã†æ±ºã‚ã‚‹ï¼Ÿ

```{r weight-lines, echo = FALSE, fig.height = 5, fig.width = 5}
df_ab = tibble(intercept = runif(n, -50, 50), slope = runif(n, -200, 200)) %>%
  dplyr::mutate(intercept = intercept - 1.7 * slope + 50)
p_weight +
  geom_abline(data = df_ab, aes(intercept = intercept, slope = slope), color = "#3366ff", alpha = 0.5)
```


---
## æœ€å°äºŒä¹—æ³•

å›å¸°ç›´ç·šã‹ã‚‰ã®<strong style="color: #3366ff">æ®‹å·®</strong>å¹³æ–¹å’Œ(RSS)ã‚’æœ€å°åŒ–ã™ã‚‹ã€‚

```{r weight-residual, echo = FALSE, fig.height = 5, fig.width = 10}
predict_weight = function(parameters, data) {
  parameters[1] + parameters[2] * data$height
}

rss_weight = function(parameters, data) {
  pred = predict_weight(parameters, data)
  sqdev = (data[["weight"]] - pred) ** 2
  sum(sqdev)
}
# rss_weight(c(40, -5), df_weight)

param1 = c(10, 30)
lm_weight = lm(weight ~ height, data = df_weight)
rss1 = rss_weight(param1, df_weight)
rss2 = rss_weight(lm_weight$coefficients, df_weight)
stopifnot(abs(sum(lm_weight$residuals ** 2) - rss2) < 1e-6)

p1 = p_weight %+%
  (df_weight %>% dplyr::mutate(pred = predict_weight(param1, .))) +
  geom_line(aes(y = pred)) +
  geom_linerange(aes(ymin = weight, ymax = pred), colour = "#3366ff") +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = sprintf("RSS = %.1f", rss1))
p2 = p_weight %+%
  (df_weight %>% modelr::add_predictions(lm_weight)) +
  geom_line(aes(y = pred)) +
  geom_linerange(aes(ymin = weight, ymax = pred), colour = "#3366ff") +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = sprintf("RSS = %.1f", rss2))
cowplot::plot_grid(p1, p2, nrow = 1L)
```


---
## æ®‹å·®å¹³æ–¹å’Œ(RSS)ãŒæœ€å°ã¨ãªã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¢ã›

ãƒ©ãƒ³ãƒ€ãƒ ã«è©¦ã—ã¦ã¿ã¦ã€ä¸Šä½ã®ã‚‚ã®ã‚’æ¡ç”¨

```{r weight-goodlines, echo = FALSE, fig.height = 5, fig.width = 10}
n = 200
df_ab_random = tibble::tibble(intercept = runif(n, -200, 100), slope = runif(n, 0, 150)) %>%
  dplyr::mutate(rss = purrr::map2_dbl(intercept, slope, ~ rss_weight(c(.x, .y), data = df_weight)))
p_ab = ggplot(df_ab_random) + aes(intercept, slope) +
  geom_point(data = function(x) {filter(x, rank(rss) < 6)}, shape = 1, size = 4) +
  geom_point(aes(color = log10(rss))) +
  theme_bw(base_size = 20) +
  theme(panel.grid = element_blank(), legend.position = c(0.99, 0.99), legend.justification = c(1, 1))

p2 = p_weight +
  geom_abline(data = df_ab_random %>% dplyr::slice_min(rss, n = 5), aes(slope = slope, intercept = intercept), color = "#3366ff", alpha = 0.5)
cowplot::plot_grid(p_ab, p2, nrow = 1L)
```

---
## æ®‹å·®å¹³æ–¹å’Œ(RSS)ãŒæœ€å°ã¨ãªã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¢ã›

**ã‚°ãƒªãƒƒãƒ‰ã‚µãƒ¼ãƒ**: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç©ºé–“ã®ä¸€å®šç¯„å›²å†…ã‚’å‡ç­‰ã«è©¦ã™

```{r weight-grid, echo = FALSE, fig.height = 5, fig.width = 10}
df_ab_grid = tidyr::crossing(intercept = seq(-100, -30, 4), slope = seq(50, 100, 4)) %>%
  dplyr::mutate(rss = purrr::map2_dbl(intercept, slope, ~ rss_weight(c(.x, .y), data = df_weight)))

p1 = p_ab %+% df_ab_grid

p2 = p_weight +
  geom_abline(data = df_ab_grid %>% dplyr::slice_min(rss, n = 5), aes(slope = slope, intercept = intercept), color = "#3366ff", alpha = 0.5)
cowplot::plot_grid(p1, p2, nrow = 1L)
```

ã“ã†ã—ãŸ**æœ€é©åŒ–**ã®æ‰‹æ³•ã¯ã„ã‚ã„ã‚ã‚ã‚‹ã‘ã©ã€ã“ã“ã§ã¯æ‰±ã‚ãªã„ã€‚


---
## ã“ã‚Œãã‚‰ã„ãªã‚‰ä¸€ç¬ã§è¨ˆç®—ã—ã¦ã‚‚ã‚‰ãˆã‚‹

```{r lm}
par_init = c(intercept = 0, slope = 0)
result = optim(par_init, fn = rss_weight, data = df_weight)
result$par
```

```{r weight-lm, echo = FALSE, fig.height = 5, fig.width = 5}
label = sprintf("y = %.1f x + %.1f", result$par["slope"], result$par["intercept"])
p_weight +
  stat_smooth(formula = y ~ x, method = lm, se = FALSE, color = "#3366ff", alpha = 0.5) +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = label)
```

---
## ä½•ã§ã‚‚ã‹ã‚“ã§ã‚‚ç›´ç·šã‚ã¦ã¯ã‚ã§ã¯ã‚ˆã‚ã—ããªã„

```{r lm-bad, echo = FALSE, fig.height = 5, fig.width = 5}
n = 300L
a = 3
b = -3
df_pois = tibble::tibble(x = runif(n, 0.4, 1.7), y = rpois(n, exp(a * x + b)))

x_breaks = c(0.5, 1.0, 1.5)
coeff = lm(y ~ x, data = df_pois)$coefficients
df_lm = tidyr::crossing(x = x_breaks, y = seq(-5, 20, 0.1)) %>%
 dplyr::mutate(density = dnorm(y, coeff[1] + coeff[2] * x, 1.4)) %>%
 dplyr::filter(density > 1e-4)

p_pois = ggplot(df_pois) + aes(x, y) +
  ggridges::geom_vridgeline(data = df_lm, aes(width = density * 0.4, group = x), linetype = 0, alpha = 0) +
  geom_point(alpha = 0.5, shape = 16, size = 2) +
  scale_x_continuous(breaks = x_breaks) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank())
p_pois + stat_smooth(formula = y ~ x, method = lm, se = FALSE)
```

- è¦³å¯Ÿãƒ‡ãƒ¼ã‚¿ã¯å¸¸ã«**æ­£ã®å€¤**ãªã®ã«äºˆæ¸¬ãŒè² ã«çªå…¥ã—ã¦ãªã„ï¼Ÿ
- **ç¸¦è»¸ã¯æ•´æ•°**ã€‚ã—ã‹ã‚‚ã®**ã°ã‚‰ã¤ã**ãŒæ¨ªè»¸ã«å¿œã˜ã¦å¤‰åŒ–ï¼Ÿ


---
## ä½•ã§ã‚‚ã‹ã‚“ã§ã‚‚ç›´ç·šã‚ã¦ã¯ã‚ã§ã¯ã‚ˆã‚ã—ããªã„

```{r glm-better, echo = FALSE, fig.height = 5, fig.width = 10}
p_lm = p_pois +
  stat_smooth(formula = y ~ x, method = lm, se = FALSE) +
  ggridges::geom_vridgeline(data = df_lm, aes(width = density * 0.4, group = x), fill = "#3366ffaa", linetype = 0)
# p_lm

df_ridges = tidyr::crossing(x = x_breaks, y = seq_len(30L) - 1L) %>%
 dplyr::mutate(density = dpois(y, exp(a * x + b))) %>%
 dplyr::filter(density > 1e-4)
df_bars = df_ridges %>% wtl::ridges2bars(y, density)

p_poisson = p_pois +
  stat_smooth(formula = y ~ x, method = glm, method.args = list(family = poisson), se = FALSE) +
  ggridges::geom_vridgeline(data = df_bars, aes(width = density * 0.5, group = x), fill = "#3366ffaa", linetype = 0)
# p_poisson

cowplot::plot_grid(p_lm, p_poisson, nrow = 1L)
```

- è¦³å¯Ÿãƒ‡ãƒ¼ã‚¿ã¯å¸¸ã«**æ­£ã®å€¤**ãªã®ã«äºˆæ¸¬ãŒè² ã«çªå…¥ã—ã¦ãªã„ï¼Ÿ
- **ç¸¦è»¸ã¯æ•´æ•°**ã€‚ã—ã‹ã‚‚ã®**ã°ã‚‰ã¤ã**ãŒæ¨ªè»¸ã«å¿œã˜ã¦å¤‰åŒ–ï¼Ÿ
- **ãƒ‡ãƒ¼ã‚¿ã«åˆã‚ã›ãŸçµ±è¨ˆãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã†ã¨ãƒã‚·**


---
## ã¡ã‚‡ã£ã¨ãšã¤ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã‚’ç™ºå±•ã•ã›ã¦ã„ã

**ç·šå½¢ãƒ¢ãƒ‡ãƒ« LM** (å˜ç´”ãªç›´ç·šã‚ã¦ã¯ã‚)

<span style="color: #888888;">&nbsp; &nbsp; â†“ ã„ã‚ã‚“ãª<strong>ç¢ºç‡åˆ†å¸ƒ</strong>ã‚’æ‰±ã„ãŸã„</span> ğŸ‘ˆ çµ±è¨ˆãƒ¢ãƒ‡ãƒ«ã®é‡è¦ãªéƒ¨å“

**ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ« GLM**

<span style="color: #888888;">&nbsp; &nbsp; â†“ å€‹ä½“å·®ãªã©ã®å¤‰é‡åŠ¹æœã‚’æ‰±ã„ãŸã„</span>

**ä¸€èˆ¬åŒ–ç·šå½¢æ··åˆãƒ¢ãƒ‡ãƒ« GLMM**

<span style="color: #888888;">&nbsp; &nbsp; â†“ ã‚‚ã£ã¨è‡ªç”±ãªãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã‚’ï¼</span>

**éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ« HBM**

<cite>[ãƒ‡ãƒ¼ã‚¿è§£æã®ãŸã‚ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€](https://amzn.to/33suMIZ) ä¹…ä¿æ‹“å¼¥ 2012 ã‚ˆã‚Šæ”¹å¤‰</cite>


---
## ç¢ºç‡åˆ†å¸ƒ

ç™ºç”Ÿã™ã‚‹äº‹è±¡(å€¤)ã¨é »åº¦ã®é–¢ä¿‚ã€‚

æ‰‹å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚’æ•°ãˆã¦ä½œã‚‹ã®ãŒ**çµŒé¨“åˆ†å¸ƒ**<br>
e.g., ã‚µã‚¤ã‚³ãƒ­ã‚’12å›æŠ•ã’ãŸçµæœã€å­¦ç”Ÿ1000äººã®èº«é•·

```{r distribution, echo = FALSE, fig.height = 4, fig.width = 8}
p1 = tibble::tibble(face = sample.int(6, 12, replace = TRUE)) %>%
  ggplot() + aes(face) +
  geom_bar(aes(y = after_stat(prop))) +
  scale_x_continuous(breaks = seq_len(6L)) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor.y = element_blank(), panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank(),
        axis.ticks = element_blank())

p2 = tibble::tibble(height = rnorm(1000L, c(160, 170), 5.5)) %>%
  ggplot() + aes(height) +
  geom_histogram(aes(y = after_stat(density)), binwidth = 1, boundary = 0) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor.x = element_blank(), axis.ticks = element_blank())
cowplot::plot_grid(p1, p2, nrow = 1L)
```

ä¸€æ–¹ã€å°‘æ•°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨æ•°å¼ã§ä½œã‚‹ã®ãŒ**ç†è«–åˆ†å¸ƒ**ã€‚<br>
(ã“ã¡ã‚‰ã‚’å˜ã«ã€Œç¢ºç‡åˆ†å¸ƒã€ã¨å‘¼ã¶ã“ã¨ãŒå¤šã„å°è±¡ï¼‰

---
## ç¢ºç‡å¤‰æ•°$X$ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿$\theta$ã®ç¢ºç‡åˆ†å¸ƒ$f$ã«å¾“ã†...?

$X \sim f(\theta)$

e.g.,<br>
ã‚³ã‚¤ãƒ³ã‚’3æšæŠ•ã’ãŸã†ã¡è¡¨ã®å‡ºã‚‹æšæ•° $X$ ã¯**äºŒé …åˆ†å¸ƒã«å¾“ã†**ã€‚<br>
$X \sim \text{Binomial}(n = 3, p = 0.5)$

<div class="column-container">
  <div class="column" style="flex-shrink: 2.0;">

```{r dbinom, echo = FALSE, fig.height = 3, fig.width = 3}
size = 3L; p = 0.5
tibble(X = seq(0, 3), Prob = dbinom(X, size, p), obs = Inf) %>%
  ggplot() + aes(X, Prob) +
  geom_col() +
  scale_y_continuous(breaks = c(0, 1), limits = c(0, 1)) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank(), axis.ticks = element_blank())
```

  </div>
  <div class="column" style="padding-top: 10px;">
\[\begin{split}
\text{Prob}(X = k) &= \binom n k p^k (1 - p)^{n - k} \\
k &\in \{0, 1, 2, \ldots, n\}
\end{split}\]
  </div>
</div>

ä¸€ç·’ã«å®Ÿé¨“ã—ã¦ã¿ã‚ˆã†ã€‚

---
## è©¦è¡Œã‚’ç¹°ã‚Šè¿”ã—ã¦è¨˜éŒ²ã—ã¦ã¿ã‚‹

ã‚³ã‚¤ãƒ³ã‚’3æšæŠ•ã’ãŸã†ã¡è¡¨ã®å‡ºãŸæšæ•° $X$

è©¦è¡Œ1: **è¡¨** è£ **è¡¨** â†’ $X = 2$<br>
è©¦è¡Œ2: è£ è£ è£ â†’ $X = 0$<br>
è©¦è¡Œ3: **è¡¨** è£ è£ â†’ $X = 1$ ç¶šã‘ã¦ $2, 1, 3, 0, 2, \ldots$

```{r rbinom, echo = FALSE, fig.height = 3, fig.width = 11}
size = 3L; p = 0.5
X = c(2L, 0L, 1L, 2L, 1L, 3L, 0L, 2L, rbinom(92L, size, p))
df_rbinom = purrr::map_dfr(c(1, 2, 3, 10, 100), ~{
  tibble::tibble(X = head(X, .x)) %>% dplyr::count(X) %>%
    dplyr::mutate(Freq = n / .x, Repl = .x)
}) %>%
  dplyr::bind_rows(tibble(X = seq(0, 3), Freq = dbinom(X, size, p), Repl = Inf))
df_rbinom %>%
  ggplot() + aes(X, Freq) +
  geom_col() +
  scale_y_continuous(breaks = c(0, 1), limits = c(0, 1)) +
  facet_wrap(vars(Repl), nrow = 1L, labeller = label_both) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank(), axis.ticks = element_blank())
```

<div style="text-align: right;">
è©¦è¡Œå›æ•°ã‚’å¢—ã‚„ã™ã»ã©<b>äºŒé …åˆ†å¸ƒ</b>ã®å½¢ã«è¿‘ã¥ãã€‚<br>
0ã¨3ã¯ãƒ¬ã‚¢ã€‚1ã¨2ãŒ3å€ã»ã©å‡ºã‚„ã™ã„ã‚‰ã—ã„ã€‚
</div>

---
## ã‚³ã‚¤ãƒ³ãƒˆã‚¹ã—ãªãã¦ã‚‚ $X$ ã‚‰ã—ãã‚‚ã®ã‚’ç”Ÿæˆã§ãã‚‹

- ã‚³ã‚¤ãƒ³ã‚’3æšæŠ•ã’ãŸã†ã¡è¡¨ã®å‡ºã‚‹æšæ•° $X$
- $n = 3, p = 0.5$ ã®äºŒé …åˆ†å¸ƒã‹ã‚‰ã‚µãƒ³ãƒ—ãƒ«ã™ã‚‹ä¹±æ•° $X$

<div class="column-container">
  <div class="column" style="flex-shrink: 2.0;">
<img src="figure/dbinom-1.png" alt="plot of chunk dbinom">
  </div>
  <div class="column" style="padding-top: 10px;">
$X \sim \text{Binomial}(n = 3, p = 0.5)$

&nbsp;&nbsp; â†“ ã‚µãƒ³ãƒ—ãƒ«

{2, 0, 1, 2, 1, 3, 0, 2, ...}
  </div>
</div>

ã“ã‚Œã‚‰ã¯ã¨ã¦ã‚‚ã‚ˆãä¼¼ã¦ã„ã‚‹ã®ã§<br>
**ã€Œã‚³ã‚¤ãƒ³ã‚’næšæŠ•ã’ãŸã†ã¡è¡¨ã®å‡ºã‚‹æšæ•°ã¯äºŒé …åˆ†å¸ƒã«å¾“ã†ã€**<br>
ã¿ãŸã„ãªè¨€ã„æ–¹ã‚’ã™ã‚‹ã€‚é€†ã«è¨€ã†ã¨<br>
**ã€ŒäºŒé …åˆ†å¸ƒã¨ã¯nå›è©¦è¡Œã®ã†ã¡ã®æˆåŠŸå›æ•°ã‚’ç¢ºç‡å¤‰æ•°ã¨ã™ã‚‹åˆ†å¸ƒã€**<br>
ã®ã‚ˆã†ã«ç†è§£ã§ãã‚‹ã€‚

---
## çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã®ä¸€ç’°ã¨ã‚‚æ‰ãˆã‚‰ã‚Œã‚‹

ã‚³ã‚¤ãƒ³3æšæŠ•ã’ã‚’ç¹°ã‚Šè¿”ã—ã¦å¾—ãŸãƒ‡ãƒ¼ã‚¿ {2, 0, 1, 2, 1, 3, 0, 2, ...}

&nbsp;&nbsp; â†“ ãŸã£ãŸ2ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§è¨˜è¿°ã€‚æƒ…å ±ã‚’åœ§ç¸®ã€‚

$n = 3, p = 0.5$ ã®äºŒé …åˆ†å¸ƒã§èª¬æ˜ãƒ»å†ç¾ã§ãã‚‹ã

<figure>
<img src="../tokiomarine2021/math-model.drawio.svg" width="600"><br>
<figcaption><cite>ã€Œãƒ‡ãƒ¼ã‚¿åˆ†æã®ãŸã‚ã®æ•°ç†ãƒ¢ãƒ‡ãƒ«å…¥é–€ã€æ±Ÿå´è²´è£• 2020 ã‚ˆã‚Šæ”¹å¤‰</cite></figcaption>
</figure>

ã“ã†ã„ã†ãµã†ã«ç¾è±¡ã¨å¯¾å¿œã—ãŸç¢ºç‡åˆ†å¸ƒã€ã»ã‹ã«ã‚‚ã‚ã‚‹ï¼Ÿ

???
ãŸã ã—ã€Œã“ã‚ŒãŒ3é€£ã‚³ã‚¤ãƒ³ãƒˆã‚¹ã®çœŸç†ã ã€ã§ã¯ãªã„ã€‚<br>
ã‚ãã¾ã§ã€Œã“ã†å˜ç´”åŒ–ã—ã¦ç†è§£ã§ããã†ãƒ»ä½¿ãˆãã†ã€ãªã ã‘ã€‚

ã»ã‹ã®ä»®å®š: ã‚³ã‚¤ãƒ³ãŒç«‹ã¤ã‹ã‚‚ã€‚åã£ãŸã‚³ã‚¤ãƒ³ã‹ã‚‚ã€‚ä¸¡è¡¨ã‹ã‚‚ã€‚

äºŒé …åˆ†å¸ƒã¯næšã‚³ã‚¤ãƒ³ãƒˆã‚¹ã‚’ãŸã£ãŸ2ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§èª¬æ˜ã™ã‚‹å„ªç§€ãƒ¢ãƒ‡ãƒ«


---
## æœ‰åãªç¢ºç‡åˆ†å¸ƒã€ãã‚Œã«ã€Œå¾“ã†ã€ã‚‚ã®

é›¢æ•£ä¸€æ§˜åˆ†å¸ƒ
: ã‚³ã‚¤ãƒ³ã®è¡¨è£ã€ã‚µã‚¤ã‚³ãƒ­ã®å‡ºç›®1â€“6

å¹¾ä½•åˆ†å¸ƒ
: æˆåŠŸç‡pã®è©¦è¡ŒãŒåˆã‚ã¦æˆåŠŸã™ã‚‹ã¾ã§ã®å¤±æ•—å›æ•°

äºŒé …åˆ†å¸ƒ
: æˆåŠŸç‡pã€è©¦è¡Œå›æ•°nã®ã†ã¡ã®æˆåŠŸå›æ•°

ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒ
: å˜ä½æ™‚é–“ã‚ãŸã‚Šå¹³å‡$\lambda$å›èµ·ã“ã‚‹äº‹è±¡ã®ç™ºç”Ÿå›æ•°

ã‚¬ãƒ³ãƒåˆ†å¸ƒ
: ãƒã‚¢ã‚½ãƒ³éç¨‹ã§kå›èµ·ã“ã‚‹ã¾ã§ã®å¾…ã¡æ™‚é–“
: (k = 1ã®ã¨ã**æŒ‡æ•°åˆ†å¸ƒ**ã¨å‘¼ã°ã‚Œã‚‹)

æ­£è¦åˆ†å¸ƒ
: ç¢ºç‡å¤‰æ•°ã®å’Œã€å¹³å‡å€¤

---
## é›¢æ•£ä¸€æ§˜åˆ†å¸ƒ

åŒã˜ç¢ºç‡ã§èµ·ã“ã‚‹né€šã‚Šã®äº‹è±¡ã®ã†ã¡å®Ÿéš›ã«èµ·ã“ã£ãŸäº‹è±¡X

e.g., ã‚³ã‚¤ãƒ³ã®è¡¨è£ã€ã‚µã‚¤ã‚³ãƒ­ã®å‡ºç›®1â€“6

```{r dunif, echo = FALSE, fig.height = 4, fig.width = 6}
df_coin = tibble::tibble(X = c("head", "tail"), Prob = c(0.5, 0.5), group = "Coin")
df_dice = tibble::tibble(X = as.character(seq_len(6L)), Prob = rep(1 / 6, 6), group = "Dice")
dplyr::bind_rows(df_coin, df_dice) %>%
  ggplot() + aes(X, Prob) +
  geom_col() +
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 1)) +
  facet_grid(cols = vars(group), scale = "free_x", space = "free_x") +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank(), axis.ticks = element_blank())
```

ğŸ”° ä¸€æ§˜åˆ†å¸ƒã«ãªã‚Šãã†ãªä¾‹ã‚’è€ƒãˆã¦ã¿ã‚ˆã†


---
## å¹¾ä½•åˆ†å¸ƒ $~\text{Geom}(p)$

æˆåŠŸç‡pã®è©¦è¡ŒãŒåˆã‚ã¦æˆåŠŸã™ã‚‹ã¾ã§ã®å¤±æ•—å›æ•°X

e.g., ã‚³ã‚¤ãƒ³ãƒˆã‚¹ã§è¡¨ãŒå‡ºã‚‹ã¾ã§ã«ä½•å›è£ãŒå‡ºã‚‹ã‹

```{r geometric, echo = FALSE, fig.height = 4, fig.width = 11}
df = purrr::map_dfr(c(0.2, 0.5, 0.9), function(p) {
  tibble::tibble(p, X = seq(0, 25), Prob = dgeom(X, p))
}) %>%
  dplyr::filter(Prob > 0.001)
x_br = c(seq.int(0, 10), seq.int(15, 100, 5))
ggplot(df) + aes(X, Prob) +
  scale_x_continuous(breaks = x_br) +
  scale_y_continuous(breaks = c(0, 1), limits = c(0, 1)) +
  geom_col() +
  facet_grid(cols = vars(p), scales = "free_x", space = "free_x", labeller = label_both) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank(), axis.ticks = element_blank())
```

\\[
\text{Prob}(X = k \mid p) = p (1 - p)^k
\\]

ã€Œåˆã‚ã¦æˆåŠŸã™ã‚‹ã¾ã§ã®è©¦è¡Œå›æ•°ã€ã¨ã™ã‚‹å®šç¾©ã‚‚ã‚ã‚‹ã€‚

ğŸ”° å¹¾ä½•åˆ†å¸ƒã«ãªã‚Šãã†ãªä¾‹ã‚’è€ƒãˆã¦ã¿ã‚ˆã†

---
## äºŒé …åˆ†å¸ƒ $~\text{Binomial}(n,~p)$

ç¢ºç‡$p$ã§å½“ãŸã‚‹ã‚¯ã‚¸ã‚’$n$å›å¼•ã„ãŸã†ã¡å½“ãŸã£ãŸå›æ•°Xã€‚å¹³å‡ã¯$np$ã€‚

```{r dbinom-n, echo = FALSE, fig.height = 4, fig.width = 11}
p = 0.25
df = purrr::map_dfr(2 ** seq.int(0, 4), function(n) {
  tibble::tibble(X = seq(0, n), Prob = dbinom(X, n, p), n = n)
})
ggplot(df) + aes(X, Prob) +
  scale_x_continuous(breaks = df[["X"]]) +
  scale_y_continuous(breaks = c(0, 1), limits = c(0, 1)) +
  geom_col() +
  facet_grid(cols = vars(n), scales = "free_x", space = "free_x", labeller = label_both) +
  labs(title = paste0("p = ", p)) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank(), axis.ticks = element_blank())
```

\\[
\text{Prob}(X = k \mid n,~p) = \binom n k p^k (1 - p)^{n - k}
\\]

ğŸ”° äºŒé …åˆ†å¸ƒã«ãªã‚Šãã†ãªä¾‹ã‚’è€ƒãˆã¦ã¿ã‚ˆã†


---
## ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒ $~\text{Poisson}(\lambda)$

å˜ä½æ™‚é–“(ç©ºé–“)ã‚ãŸã‚Šã«å¹³å‡$\lambda$å›ç™ºç”Ÿã™ã‚‹äº‹è±¡ãŒå®Ÿéš›ã«èµ·ããŸå›æ•°Xã€‚

e.g., 1æ™‚é–“ã‚ãŸã‚Šã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ä»¶æ•°ã€ãƒ¡ãƒƒã‚·ãƒ¥åŒºç”»å†…ã®ç”Ÿç‰©å€‹ä½“æ•°

```{r dpoisson, echo = FALSE, fig.height = 4, fig.width = 11}
lambda = c(1, 5, 10)

p_poisson_process = tibble::tibble(y = rev(seq_along(lambda)), lambda) %>%
  dplyr::mutate(time = purrr::map(lambda, ~runif(.x * 3, 0, 3))) %>%
  tidyr::unnest(time) %>%
  ggplot() + aes(time, y) +
  annotate("segment", x = -0.1, xend = 3.1, y = 1:3, yend = 1:3, size = 2, arrow = grid::arrow(length = unit(0.1, "inches"), type = "closed"), linejoin = "mitre") +
  geom_point(aes(color = lambda, fill = lambda), size = 8, shape = 124, key_glyph = draw_key_rect) +
  scale_color_continuous(guide = NULL) +
  scale_fill_continuous(guide = guide_legend(label.position = "top", title.vjust = 1), breaks = lambda) +
  scale_y_continuous(limits = c(0.5, 3.5), breaks = NULL) +
  labs(y = NULL, x = "time (space)") +
  theme_bw(base_size = 18) +
  theme(axis.text.y = element_blank(), axis.ticks = element_blank(), panel.border = element_blank(),
        panel.grid.minor = element_blank(), legend.position = "top")

p2 = tidyr::crossing(X = seq.int(0L, 20L), lambda) %>%
  dplyr::mutate(Prob = dpois(X, lambda)) %>%
  ggplot() + aes(X, Prob) +
  geom_col(aes(fill = lambda), position = "identity", alpha = 0.5) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
        axis.ticks = element_blank(), legend.position = "none")
cowplot::plot_grid(p_poisson_process, p2, nrow = 1L, rel_widths = c(4, 3))
```

\\[
\text{Prob}(X = k \mid \lambda) = \frac {\lambda^k e^{-\lambda}} {k!}
\\]

äºŒé …åˆ†å¸ƒã®æ¥µé™ $(\lambda = np;~n \to \infty;~p \to 0)$ã€‚<br>
ã‚ã£ãŸã«èµ·ããªã„ã“ã¨ã‚’ä½•å›ã‚‚è©¦è¡Œã™ã‚‹ã‚ˆã†ãªæ„Ÿã˜ã€‚


---
## æŒ‡æ•°åˆ†å¸ƒ $~\text{Exp}(\lambda)$

ãƒã‚¢ã‚½ãƒ³éç¨‹ã®äº‹è±¡ã®ç™ºç”Ÿé–“éš”xã€‚å¹³å‡ã¯ $1 / \lambda$ ã€‚

e.g., ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å—ä¿¡é–“éš”ã€é“è·¯æ²¿ã„ã«è½ã¡ã¦ã‚‹æ‰‹è¢‹ã®é–“éš”

```{r dexp, echo = FALSE, fig.height = 4, fig.width = 11}
p2 = tidyr::crossing(x = seq(0, 3, length.out = 201), lambda) %>%
  dplyr::mutate(Prob = dexp(x, rate = lambda)) %>%
  ggplot() + aes(x, Prob) +
  geom_area(aes(fill = lambda, group = lambda), position = "identity", alpha = 0.5) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
        axis.ticks = element_blank(), legend.position = "none")
cowplot::plot_grid(p_poisson_process, p2, nrow = 1L, rel_widths = c(4, 3))
```

\\[
\text{Prob}(x \mid \lambda) = \lambda e^{-\lambda x}
\\]

å¹¾ä½•åˆ†å¸ƒã®é€£ç¶šå€¤ç‰ˆã€‚

ğŸ”° ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒãƒ»æŒ‡æ•°åˆ†å¸ƒã«ãªã‚Šãã†ãªä¾‹ã‚’è€ƒãˆã¦ã¿ã‚ˆã†


---
## ã‚¬ãƒ³ãƒåˆ†å¸ƒ $~\text{Gamma}(k,~\lambda)$

ãƒã‚¢ã‚½ãƒ³éç¨‹ã®äº‹è±¡kå›ç™ºç”Ÿã¾ã§ã®å¾…ã¡æ™‚é–“x

e.g., ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’2ã¤å—ä¿¡ã™ã‚‹ã¾ã§ã®å¾…ã¡æ™‚é–“

```{r dgamma, echo = FALSE, fig.height = 4, fig.width = 11}
p2 = tidyr::crossing(x = seq(0, 3, length.out = 201), lambda) %>%
  dplyr::mutate(Prob = dgamma(x, rate = lambda, shape = 3)) %>%
  ggplot() + aes(x, Prob) +
  geom_area(aes(fill = lambda, group = lambda), position = "identity", alpha = 0.5) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
        axis.ticks = element_blank(), legend.position = "none")
cowplot::plot_grid(p_poisson_process, p2, nrow = 1L, rel_widths = c(4, 3))
```

\\[
\text{Prob}(x \mid k,~\lambda) = \frac {\lambda^k x^{k - 1} e^{-\lambda x}} {\Gamma(k)}
\\]

æŒ‡æ•°åˆ†å¸ƒã‚’kã®ã¶ã‚“å³ã«è†¨ã‚‰ã¾ã›ãŸæ„Ÿã˜ã€‚<br>
shapeãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ $k = 1$ ã®ã¨ãæŒ‡æ•°åˆ†å¸ƒã¨ä¸€è‡´ã€‚


---
## æ­£è¦åˆ†å¸ƒ $~\mathcal{N}(\mu,~\sigma)$

å¹³å‡ $\mu$ã€æ¨™æº–åå·® $\sigma$ ã®ç¾ã—ã„åˆ†å¸ƒã€‚ã‚ˆãç™»å ´ã™ã‚‹ã€‚<br>
e.g., $\mu = 50, ~\sigma = 10$ (æ¿ƒã„ç°è‰²ã«ãƒ‡ãƒ¼ã‚¿ã®95%, 99%ãŒå«ã¾ã‚Œã‚‹):

```{r gaussian, echo = FALSE, fig.height = 5, fig.width = 11}
ci = qnorm(c(0.005, 0.025, 0.975, 0.995), 50, 10)
tibble::tibble(x = seq(0, 100, 0.1), Prob = dnorm(x, 50, 10)) %>%
  ggplot() + aes(x, Prob) +
  geom_area(alpha = 0.4) +
  geom_area(data = function(.x) {dplyr::filter(.x, dplyr::between(x, ci[2], ci[3]))}, alpha = 0.4) +
  geom_area(data = function(.x) {dplyr::filter(.x, dplyr::between(x, ci[1], ci[4]))}, alpha = 0.4) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
        axis.ticks = element_blank(), legend.position = "none")
```

\\[
\text{Prob}(x \mid \mu,~\sigma) = \frac 1 {\sqrt{2 \pi \sigma^2}} \exp \left(\frac {-(x - \mu)^2} {2\sigma^2} \right)
\\]

---
## æ­£è¦åˆ†å¸ƒã«è¿‘ã¥ãã‚‚ã®ãŒã„ã‚ã„ã‚ã‚ã‚‹

æ¨™æœ¬å¹³å‡ã®åå¾©(**ä¸­å¿ƒæ¥µé™å®šç†**);
e.g., ä¸€æ§˜åˆ†å¸ƒ [0, 100) ã‹ã‚‰40ã‚µãƒ³ãƒ—ãƒ«

```{r central-limit, echo = FALSE, fig.height = 3, fig.width = 11}
n = 40L
X = replicate(10000L, mean(runif(n, 0, 100)))
purrr::map_dfr(c(10, 100, 1000, 10000), ~{tibble::tibble(X = head(X, .x), Repl = .x)}) %>%
  ggplot() + aes(X) +
  geom_histogram(bins = 25) +
  facet_wrap(vars(Repl), nrow = 1L, scale = "free_y", labeller = label_both) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank(),
        axis.ticks = element_blank())
```

å¤§ãã„$n$ã®äºŒé …åˆ†å¸ƒ

```{r binom-normal, echo = FALSE, fig.height = 3, fig.width = 11}
purrr::map_dfr(c(1, 4, 16, 64, 256), ~{
  tibble::tibble(X = seq(0, .x), Prob = dbinom(X, .x, 0.25), n = .x) %>%
  dplyr::filter(Prob > 1e-5)
}) %>%
  ggplot() + aes(X, Prob) +
  geom_col(width = 1) +
  facet_wrap(vars(n), nrow = 1L, scale = "free", labeller = label_both) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank(),
        axis.ticks = element_blank())
```

---
## æ­£è¦åˆ†å¸ƒã«è¿‘ã¥ãã‚‚ã®ãŒã„ã‚ã„ã‚ã‚ã‚‹

å¤§ãã„$\lambda$ã®ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒ

```{r poisson-normal, echo = FALSE, fig.height = 2.5, fig.width = 11}
purrr::map_dfr(c(1, 4, 16, 64, 256), ~{
  tibble::tibble(X = seq(0, 4 * .x), Prob = dpois(X, .x), lambda = .x) %>%
  dplyr::filter(Prob > 1e-5)
}) %>%
  ggplot() + aes(X, Prob) +
  geom_col(width = 1) +
  facet_wrap(vars(lambda), nrow = 1L, scale = "free", labeller = label_both) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank(),
        axis.ticks = element_blank())
```

å¹³å‡å€¤å›ºå®šãªã‚‰$k$ãŒå¤§ãããªã‚‹ã»ã©å·¦å³å¯¾ç§°ã«å°–ã‚‹ã‚¬ãƒ³ãƒåˆ†å¸ƒ

```{r gamma-normal, echo = FALSE, fig.height = 4, fig.width = 11}
.guide = guide_legend(reverse = TRUE, label.position = "left", label.hjust = 1)
tidyr::crossing(x = seq(0, 25, length.out = 300), k = 10 ** seq.int(0, 3)) %>%
  dplyr::mutate(Prob = dgamma(x, rate = k / 10, shape = k)) %>%
  ggplot() + aes(x, Prob) +
  geom_area(aes(fill = k, group = k), position = "identity", alpha = 0.5) +
  scale_fill_viridis_c(trans = "log10", guide = .guide) +
  coord_cartesian(xlim = c(0, 20)) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
        axis.ticks = element_blank())
```


---
## æœ‰åãªç¢ºç‡åˆ†å¸ƒå¯¾å¿œé–¢ä¿‚ãµã‚Šã‹ãˆã‚Š

<figure style="float: right;">
<img src="../tokiomarine2021/math-model.drawio.svg" width="300"><br>
</figure>

é›¢æ•£ä¸€æ§˜åˆ†å¸ƒ
: ã‚³ã‚¤ãƒ³ã®è¡¨è£ã€ã‚µã‚¤ã‚³ãƒ­ã®å‡ºç›®1â€“6

å¹¾ä½•åˆ†å¸ƒ
: æˆåŠŸç‡pã®è©¦è¡ŒãŒåˆã‚ã¦æˆåŠŸã™ã‚‹ã¾ã§ã®å¤±æ•—å›æ•°

äºŒé …åˆ†å¸ƒ
: æˆåŠŸç‡pã€è©¦è¡Œå›æ•°nã®ã†ã¡ã®æˆåŠŸå›æ•°

ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒ
: å˜ä½æ™‚é–“ã‚ãŸã‚Šå¹³å‡$\lambda$å›èµ·ã“ã‚‹äº‹è±¡ã®ç™ºç”Ÿå›æ•°

ã‚¬ãƒ³ãƒåˆ†å¸ƒ
: ãƒã‚¢ã‚½ãƒ³éç¨‹ã§kå›èµ·ã“ã‚‹ã¾ã§ã®å¾…ã¡æ™‚é–“
: (k = 1ã®ã¨ã**æŒ‡æ•°åˆ†å¸ƒ**ã¨å‘¼ã°ã‚Œã‚‹)

æ­£è¦åˆ†å¸ƒ
: ç¢ºç‡å¤‰æ•°ã®å’Œã€å¹³å‡å€¤ã€‚ä½¿ã„å‹æ‰‹ãŒè‰¯ãã€ã‚ˆãç™»å ´ã™ã‚‹ã€‚


---
## ç¾å®Ÿã«ã¯ã€ç¢ºç‡åˆ†å¸ƒã«ã€Œå¾“ã‚ãªã„ã€ã“ã¨ãŒå¤šã„

æ¤ç‰©100å€‹ä½“ã‹ã‚‰8å€‹ãšã¤ç¨®å­ã‚’å–ã£ã¦æ¤ãˆãŸã‚‰å…¨ä½“ã§åŠåˆ†ã¡ã‚‡ã„ç™ºèŠ½ã€‚<br>
è¦ª1å€‹ä½“ã‚ãŸã‚Šã®ç”Ÿå­˜æ•°ã¯<span style="color: #3366ff;">n=8ã®äºŒé …åˆ†å¸ƒ</span>ã«ãªã‚‹ã¯ãšã ã‘ã©ã€<br>
æ¥µç«¯ãªå€¤(å…¨éƒ¨æ­»äº¡ã€å…¨éƒ¨ç”Ÿå­˜)ãŒå¤šã‹ã£ãŸã€‚

<img src="figure/overdispersion-1.png" alt="plot of chunk overdispersion" width=400>

ã€Œãã‚Œã¯ãªãœï¼Ÿã€ã¨è€ƒãˆã¦è¦å› ã‚’æ¢ã‚‹ã®ã‚‚çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã®ä»•äº‹ã€‚<br>
**ã€Œæ™®é€šã¯ã“ã‚Œã«å¾“ã†ã¯ãšã€ã‚’ç†è§£ã—ã¦ã“ã**ã§ãã‚‹æ€è€ƒã€‚


---
## ç–‘ä¼¼ä¹±æ•°ç”Ÿæˆå™¨ Pseudo Random Number Generator

ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ä¸Šã§ãƒ©ãƒ³ãƒ€ãƒ **ã£ã½ã„**æ•°å€¤ã‚’å‡ºåŠ›ã™ã‚‹è£…ç½®ã€‚<br>
å®Ÿéš›ã«ã¯**æ±ºå®šè«–çš„**ã«è¨ˆç®—ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€<br>
ã‚·ãƒ¼ãƒ‰(å‡ºç™ºç‚¹)ã¨å‘¼ã³å‡ºã—å›æ•°ãŒåŒã˜ãªã‚‰å‡ºã‚‹æ•°ã‚‚åŒã˜ã«ãªã‚‹ã€‚

```r
set.seed(42)
runif(3L)
# 0.9148060 0.9370754 0.2861395
runif(3L)
# 0.8304476 0.6417455 0.5190959
set.seed(42)
runif(6L)
# 0.9148060 0.9370754 0.2861395 0.8304476 0.6417455 0.5190959
```

ã‚·ãƒ¼ãƒ‰ã«é©å½“ãªå›ºå®šå€¤ã‚’ä¸ãˆã¦ãŠãã“ã¨ã§å†ç¾æ€§ã‚’ä¿ã¦ã‚‹ã€‚<br>
ãŸã ã—ã€Œã“ã®ã‚·ãƒ¼ãƒ‰ã˜ã‚ƒãªã„ã¨è‰¯ã„çµæœãŒå‡ºãªã„ã€ã¯ãƒ€ãƒ¡ã€‚

ã•ã¾ã–ã¾ãªã€Œåˆ†å¸ƒã«å¾“ã†ã€ä¹±æ•°ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã€‚

---
## ã„ã‚ã‚“ãªä¹±æ•°ã‚’ç”Ÿæˆãƒ»å¯è¦–åŒ–ã—ã¦æ„Ÿè¦šã‚’æ´ã‚‚ã†

ğŸ”° `?rbinom` ãªã©ãƒ˜ãƒ«ãƒ—ã‚’å‚ç…§ã—ã¤ã¤ãŸãã•ã‚“è©¦ãã†ã€‚

ğŸ”° e.g., 1%ã®å½“ãŸã‚Šã‚’ç‹™ã£ã¦100é€£ã‚¬ãƒãƒ£ã‚’å›ã—ãŸå ´åˆã¨ã‹

```r
n = 100
x = sample.int(6, n, replace = TRUE)
x = runif(n, min = 0, max = 1)
x = rgeom(n, prob = 0.5)
x = rbinom(n, size = 3, prob = 0.5)
x = rpois(n, lambda = 10)
x = rnorm(n, mean = 50, sd = 10)
print(x)

p1 = ggplot(data.frame(x)) + aes(x)
p1 + geom_histogram() # for continuous values
p1 + geom_bar()       # for discrete values
```

---
## ãƒ‡ãƒ¼ã‚¿ã«åˆ†å¸ƒã‚’ã‚ã¦ã¯ã‚ãŸã„

ã‚ã‚‹æ¤ç‰©ã‚’50å€‹ä½“èª¿ã¹ã¦ã€ãã‚Œãã‚Œã®ç¨®å­æ•°Xã‚’æ•°ãˆãŸã€‚

```{r poisson-seed, echo = FALSE, fig.height = 4, fig.width = 4}
df_rpois = tibble::tibble(X = rpois(50L, 3))
ggplot(df_rpois) + aes(X) +
  geom_bar() +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank(),
        axis.ticks = element_blank())
```

ã‚«ã‚¦ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã ã‹ã‚‰ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒã£ã½ã„ã€‚<br>
ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ $\lambda$ ã¯ã©ã†æ±ºã‚ã‚‹ï¼Ÿ


---
## ãƒ‡ãƒ¼ã‚¿ã«åˆ†å¸ƒã‚’ã‚ã¦ã¯ã‚ãŸã„

ã‚ã‚‹æ¤ç‰©ã‚’50å€‹ä½“èª¿ã¹ã¦ã€ãã‚Œãã‚Œã®ç¨®å­æ•°Xã‚’æ•°ãˆãŸã€‚

```{r poisson-seed-lambda, echo = FALSE, fig.height = 4, fig.width = 11}
df_dpois = purrr::map_dfr(c(1, 3, 5), ~{
  tibble(lambda = .x, X = seq(0, 11), Prob = dpois(X, lambda))
})
p_pois = ggplot(df_rpois) + aes(X) +
  geom_bar(aes(y = after_stat(prop)), width = 0.4) +
  geom_col(data = df_dpois, aes(y = Prob), alpha = 0.5, fill = "#3366ff") +
  facet_wrap(vars(lambda), nrow = 1L, labeller = label_both) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(), axis.ticks = element_blank())
p_pois
```

ã‚«ã‚¦ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã ã‹ã‚‰ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒã£ã½ã„ã€‚<br>
ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ $\lambda$ ã¯ã©ã†æ±ºã‚ã‚‹ï¼Ÿ<br>
(é»’ãŒè¦³å¯Ÿãƒ‡ãƒ¼ã‚¿ã€‚<span style="color: #3366ff;">é’ãŒãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒ</span>ã€‚ã‚ˆãé‡ãªã‚‹ã®ã¯ï¼Ÿ)


---
## <ruby>å°¤<rt>ã‚†ã†</rt>åº¦</ruby> (likelihood)

<ruby>å°¤<rt>ã‚‚ã£ã¨</rt></ruby>ã‚‚ã‚‰ã—ã•ã€‚
ãƒ¢ãƒ‡ãƒ«ã®ã‚ã¦ã¯ã¾ã‚Šã®è‰¯ã•ã®å°ºåº¦ã®ã²ã¨ã¤ã€‚

**ã‚ã‚‹ãƒ¢ãƒ‡ãƒ«$M$ã®ä¸‹ã§ãã®ãƒ‡ãƒ¼ã‚¿$D$ãŒè¦³å¯Ÿã•ã‚Œã‚‹ç¢ºç‡**ã€‚<br>
å®šç¾©é€šã‚Šç´ ç›´ã«æ›¸ãã¨<br>
$\text{Prob}(D \mid M)$

ãƒ‡ãƒ¼ã‚¿$D$ã‚’å›ºå®šã—ã€ãƒ¢ãƒ‡ãƒ«$M$ã®é–¢æ•°ã¨ã¿ãªã—ãŸã‚‚ã®ãŒ**å°¤åº¦é–¢æ•°**:<br>
$L(M \mid D)$

ãƒ¢ãƒ‡ãƒ«ã®æ§‹é€ ã‚‚å›ºå®šã—ã¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿$\theta$ã ã‘å‹•ã‹ã™å ´åˆã¯ã“ã†æ›¸ã:<br>
$L(\theta \mid D)$ ã¨ã‹ $L(\theta)$ ã¨ã‹


---
## å°¤åº¦ã‚’æ‰‹è¨ˆç®—ã§ãã‚‹ä¾‹

ã‚³ã‚¤ãƒ³ã‚’5æšæŠ•ã’ãŸçµæœ $D$: è¡¨ 4, è£ 1

è¡¨ãŒå‡ºã‚‹ç¢ºç‡ $p = 0.5$ ã¨ä»®å®š:
<div>\[\begin{split}
L(0.5 \mid D)
  &= \binom 5 1 \times \text{Prob}(è¡¨ \mid 0.5) ^ 4 \times \text{Prob}(è£ \mid 0.5) ^ 1 \\
  &= 5 \times 0.5 ^ 4 \times 0.5 ^ 1 = 0.15625
\end{split}\]</div>

è¡¨ãŒå‡ºã‚‹ç¢ºç‡ $p = 0.8$ ã¨ä»®å®š:
<div>\[\begin{split}
L(0.8 \mid D)
  &= \binom 5 1 \times \text{Prob}(è¡¨ \mid 0.8) ^ 4 \times \text{Prob}(è£ \mid 0.8) ^ 1 \\
  &= 5 \times 0.8 ^ 4 \times 0.2 ^ 1 = 0.4096
\end{split}\]</div>

$L(0.8 \mid D) > L(0.5 \mid D)$

$p = 0.8$ ã®ã»ã†ãŒã‚ˆã‚Šå°¤ã‚‚ã‚‰ã—ã„ã€‚



---
## ç¨®å­æ•°ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒã®ä¾‹ã§ã‚‚å°¤åº¦ã‚’è¨ˆç®—ã—ã¦ã¿ã‚‹

ã‚ã‚‹æ¤ç‰©ãŒä½œã£ãŸç¨®å­ã‚’æ•°ãˆã‚‹ã€‚$n = 50$å€‹ä½“ã¶ã‚“ã€‚

<div>\[\begin{split}
L(\lambda \mid D)
  = \prod _i ^n \text{Prob}(X_i \mid \lambda)
  = \prod _i ^n \frac {\lambda ^ {X_i} e ^ {-\lambda}} {X_i !}
\end{split}\]</div>

```{r poisson-seed-likelihood, echo = FALSE, fig.height = 4, fig.width = 11}
df_likelihood = df_rpois %>%
  dplyr::left_join(df_dpois, by = "X") %>%
  dplyr::group_by(lambda) %>%
  dplyr::summarize(L = prod(Prob)) %>%
  dplyr::mutate(logL = log(L), label = sprintf("L(%.0f|D) = %.1e", lambda, L))
p_pois +
  geom_text(data = df_likelihood, aes(label = label), x = Inf, y = Inf, hjust = 1.1, vjust = 1.3, size = 6, color = "#3366ff")
```

ã“ã®ä¸­ã§ã¯ $\lambda = 3$ ãŒã„ã„ã‘ã©ã€ã‚ˆã‚Šå°¤ã‚‚ã‚‰ã—ã„å€¤ã‚’æ±‚ã‚ãŸã„ã€‚

---
## æœ€å°¤æ¨å®š <u>M</u>aximum <u>L</u>ikelihood <u>E</u>stimation

æ‰±ã„ã‚„ã™ã„ **å¯¾æ•°å°¤åº¦** (log likelihood) ã«ã—ã¦ã‹ã‚‰è¨ˆç®—ã™ã‚‹ã€‚<br>
ä¸€éšå¾®åˆ†ãŒ0ã«ãªã‚‹ $\lambda$ ã‚’æ±‚ã‚ã‚‹ã¨...**æ¨™æœ¬å¹³å‡**ã¨ä¸€è‡´ã€‚

<div>\[\begin{split}
\log L(\lambda \mid D)
  &= \sum _i ^n \left[ X_i \log (\lambda) - \lambda - \log (X_i !) \right] \\
\frac {\mathrm d \log L(\lambda \mid D)} {\mathrm d \lambda}
  &= \frac 1 \lambda \sum _i ^n X_i - n = 0 \\
\hat \lambda &= \frac 1 n \sum _i ^n X_i
\end{split}\]</div>


```{r poisson-mle, echo = FALSE, fig.height = 3, fig.width = 10}
count_rpois = df_rpois %>% dplyr::count(X)
calc_likelihood_rpois = function(lambda) {
  prod(dpois(count_rpois[["X"]], lambda) ** count_rpois[["n"]])
}
X_mle = mean(df_rpois[["X"]])
L_mle = calc_likelihood_rpois(X_mle)
p_mle = tibble::tibble(lambda = seq(1, 5, 0.1), L = purrr::map_dbl(lambda, calc_likelihood_rpois)) %>%
  dplyr::mutate(logL = log(L)) %>%
  ggplot() + aes(lambda, logL) +
  geom_line() +
  geom_vline(xintercept = X_mle, color = "#3366ff") +
  annotate("point", x = X_mle, y = log(L_mle), size = 3, color = "#3366ff") +
  annotate("text", x = Inf, y = Inf, hjust = 1.1, vjust = 1.2, size = 5, color = "#3366ff", label = sprintf("lambda = %.2f", X_mle)) +
  labs(y = "log L") +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
        axis.ticks = element_blank())

df_dpois = tibble(lambda = X_mle, X = seq(0, 11), Prob = dpois(X, lambda))
p_pois = ggplot(df_rpois) + aes(X) +
  geom_bar(aes(y = after_stat(prop)), width = 0.4) +
  geom_col(data = df_dpois, aes(y = Prob), alpha = 0.5, fill = "#3366ff") +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(), axis.ticks = element_blank())

cowplot::plot_grid(p_mle, p_pois, nrow = 1L, rel_widths = c(2, 1))
```

---
## æœ€å°¤æ¨å®šã‚’ä½¿ã£ã¦ã‚‚â€œçœŸã®Î»â€ã¯å¾—ã‚‰ã‚Œãªã„

ä»Šå›ã®ãƒ‡ãƒ¼ã‚¿ã¯çœŸã®ç”Ÿæˆãƒ«ãƒ¼ãƒ«â€œ$X \sim \text{Poisson}(\lambda = 3.0)$â€ã§ä½œã£ãŸã€‚<br>
ã€Œ50å€‹ä½“ã‚µãƒ³ãƒ—ãƒ«â†’æœ€å°¤æ¨å®šã€ã‚’1,000å›ç¹°ã‚Šè¿”ã—ã¦ã¿ã‚‹ã¨:

```{r poisson-mle-repl, echo = FALSE, fig.height = 5, fig.width = 11}
nrep = 1000L
df_repl = tibble::tibble(X = rpois(50L * nrep, 3), repl = rep(seq_len(nrep), each = 50L))
df_sum = df_repl %>%
  dplyr::group_by(repl) %>%
  dplyr::summarize(lambda = mean(X))
df_minmax = dplyr::bind_rows(dplyr::slice_max(df_sum, lambda), dplyr::slice_min(df_sum, lambda))

p_repl = df_sum %>%
  ggplot() + aes(lambda) +
  geom_histogram(bins = 25, center = 3) +
  annotate("point", x = df_minmax$lambda, y = 0, color = "#3366ff", size = 8, alpha = 0.5) +
  labs(x = "estimated_lambda") +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
        axis.ticks = element_blank())

df_dpois = tidyr::crossing(lambda = df_minmax$lambda, X = seq(0, 11)) %>%
  dplyr::mutate(Prob = dpois(X, lambda))
p_minmax = df_repl %>%
  dplyr::filter(repl %in% df_minmax$repl) %>%
  dplyr::left_join(df_minmax, by = "repl") %>%
  ggplot() + aes(X) +
  geom_bar(aes(y = after_stat(prop)), width = 0.4) +
  geom_col(data = df_dpois, aes(y = Prob), alpha = 0.5, fill = "#3366ff") +
  facet_wrap(vars(lambda), ncol = 1L, labeller = label_both) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(), axis.ticks = element_blank())

cowplot::plot_grid(p_repl, p_minmax, nrow = 1L, rel_widths = c(2, 1))
```

ã‚µãƒ³ãƒ—ãƒ«ã®å–ã‚Œæ–¹ã«ã‚ˆã£ã¦ã¯ã‹ãªã‚Šã‚ºãƒ¬ãŸæ¨å®šã‚’ã—ã¦ã—ã¾ã†ã€‚<br>
(æ¨™æœ¬ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚ã¦ã¯ã¾ã‚Šã¯ã‹ãªã‚Šè‰¯ãè¦‹ãˆã‚‹ã®ã«ï¼)


---
## ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºã‚’å¢—ã‚„ã™ã»ã©ãƒã‚·ã«ã¯ãªã‚‹

â€œ$X \sim \text{Poisson}(\lambda = 3.0)$â€ã‹ã‚‰nã‚µãƒ³ãƒ—ãƒ«â†’æœ€å°¤æ¨å®šã‚’1,000å›ç¹°ã‚Šè¿”ã™:

```{r poisson-mle-nsam, echo = FALSE, fig.height = 4, fig.width = 11}
nrep = 1000L
purrr::map_dfr(c(5, 50, 500, 5000), ~{
  tibble::tibble(X = rpois(.x * nrep, 3), repl = rep(seq_len(nrep), each = .x)) %>%
    dplyr::group_by(repl) %>%
    dplyr::summarize(estimated_lambda = mean(X)) %>%
    dplyr::mutate(n = .x)
}) %>%
  ggplot() + aes(estimated_lambda) +
  geom_histogram(bins = 25, center = 3) +
  facet_wrap(vars(n), nrow = 1L, labeller = label_both) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
        axis.ticks = element_blank())
```

Q. ã˜ã‚ƒã‚ã©ã‚Œãã‚‰ã„ã®ã‚µãƒ³ãƒ—ãƒ«æ•°nã‚’ç¢ºä¿ã™ã‚Œã°ã„ã„ã®ã‹ï¼Ÿ<br>
A. æ¨å®šã—ãŸã„çµ±è¨ˆé‡ã¨ã‹ã€è¨±å®¹ã§ãã‚‹èª¤å·®ã¨ã‹ã«ã‚ˆã‚‹ã€‚


---
## ã™ã¹ã¦ã®ãƒ¢ãƒ‡ãƒ«ã¯é–“é•ã£ã¦ã„ã‚‹

ç¢ºç‡åˆ†å¸ƒãŒã„ã„æ„Ÿã˜ã«æœ€å°¤æ¨å®šã§ããŸã¨ã—ã¦ã‚‚ã€<br>
ãã‚Œã¯ã‚ãã¾ã§ãƒ¢ãƒ‡ãƒ«ã€‚ä»®å®šã€‚è¿‘ä¼¼ã€‚

> All models are wrong, but some are useful. --- George E. P. Box

<figure>
<img src="../tokiomarine2021/math-model.drawio.svg" width="600"><br>
<figcaption><cite>ã€Œãƒ‡ãƒ¼ã‚¿åˆ†æã®ãŸã‚ã®æ•°ç†ãƒ¢ãƒ‡ãƒ«å…¥é–€ã€æ±Ÿå´è²´è£• 2020 ã‚ˆã‚Šæ”¹å¤‰</cite></figcaption>
</figure>


---
## çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã®é“å…· --- ã¾ã¨ã‚

- **ç¢ºç‡å¤‰æ•°** $X$
- **ç¢ºç‡åˆ†å¸ƒ** $X \sim f(\theta)$
    - **å°‘ãªã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿** $\theta$ ã§ã°ã‚‰ã¤ãã®æ§˜å­ã‚’è¡¨ç¾
    - **ã“ã®ç¾è±¡ã¯ã“ã®åˆ†å¸ƒã‚’ä½œã‚ŠãŒã¡(ã€œã«å¾“ã†)** ã¨ã„ã†çŸ¥è¦‹ãŒã‚ã‚‹
- **å°¤åº¦**
    - ã‚ã‚‹ãƒ¢ãƒ‡ãƒ«ã§ã“ã®ãƒ‡ãƒ¼ã‚¿ã«ãªã‚‹ç¢ºç‡ $\text{Prob}(D \mid M)$
    - ãƒ‡ãƒ¼ã‚¿å›ºå®šã§ãƒ¢ãƒ‡ãƒ«æ¢ç´¢ â†’ **å°¤åº¦é–¢æ•°** $L(M \mid D),~L(\theta \mid D)$
    - å¯¾æ•°ã‚’å–ã£ãŸã»ã†ãŒæ‰±ã„ã‚„ã™ã„ â†’ **å¯¾æ•°å°¤åº¦** $\log L(M \mid D)$
    - ã“ã‚Œã‚’æœ€å¤§åŒ–ã™ã‚‹ã‚ˆã†ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ $\hat \theta$ æ¢ã— ï¼ **æœ€å°¤æ³•**










---
## ã“ã“ã¾ã§è¦‹ã¦ããŸçµ±è¨ˆãƒ¢ãƒ‡ãƒ«

ç¢ºç‡å¤‰æ•°$X$ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿$\theta$ã®ç¢ºç‡åˆ†å¸ƒ$f$ã«â€œå¾“ã†â€:&nbsp;
$X \sim f(\theta) $

e.g., ã‚ã‚‹æ¤ç‰©ãŒä½œã‚‹ç¨®ã®æ•°$X$ã¯å¹³å‡å€¤$\lambda$ã®ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒã«å¾“ã†:

<div>\[\begin{split}
X \sim \text{Poisson}(\lambda)
\end{split}\]</div>

```{r only-dist, echo = FALSE, fig.height = 4, fig.width = 4}
df_rpois = tibble::tibble(X = rpois(50L, 3))
df_dpois = tibble(X = seq(0, 11), Prob = dpois(X, mean(df_rpois$X)))
p_pois = ggplot(df_rpois) + aes(X) +
  geom_bar(aes(y = after_stat(prop)), width = 0.3) +
  geom_col(data = df_dpois, aes(y = Prob), alpha = 0.5, fill = "#3366ff") +
  theme_bw(base_size = 18)
p_pois +
  theme(panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(), axis.ticks = element_blank())
```

ã“ã‚Œã‚’ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«(GLM)ã¨ã—ã¦è¦‹ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã€‚

---
## ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«(GLM)ã¨ã—ã¦è¨˜è¿°ã—ã¦ã¿ã‚‹

å€‹ä½“$i$ã®ç¨®å­æ•°$y_i$ã¯å¹³å‡å€¤$\lambda_i$ã®ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒã«å¾“ã†ã€‚<br>
å¹³å‡å€¤$\lambda_i$ã¯**ä»–ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‰ãš$\beta_0$ã§ä¸€å®š**ã€‚

<div>\[\begin{split}
y_i &\sim \text{Poisson}(\lambda_i) \\
\lambda_i &= \beta_0
\end{split}\]</div>

```{r glm-without-x, echo = FALSE, fig.height = 4, fig.width = 4}
p_pois +
  labs(x = "y") +
  coord_flip() +
  theme(panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(), axis.ticks = element_blank())
```

ç¨®å­æ•°ã‚’Yè»¸ã«ã—ã¦ã€å¼ã‚’2ã¤ã«åˆ†ã‘ãŸã ã‘...?<br>
**èª¬æ˜å¤‰æ•°**ã‚’å«ã‚€ãƒ¢ãƒ‡ãƒ«ã‚’è¦‹ã‚Œã°ã”åˆ©ç›ŠãŒåˆ†ã‹ã‚‹ã‹ã‚‚ã€‚

---
## èª¬æ˜å¤‰æ•°ãŒ1ã¤ã‚ã‚‹ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«

å€‹ä½“$i$ã®ç¨®å­æ•°$y_i$ã¯å¹³å‡å€¤$\lambda_i$ã®ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒã«å¾“ã†ã€‚<br>
å¹³å‡å€¤ã®å¯¾æ•°$\log(\lambda_i)$ã¯**ãã®å€‹ä½“ã®å¤§ãã•$x_i$ã«æ¯”ä¾‹**ã™ã‚‹ã€‚

<div class="column-container">
  <div class="column" style="flex-shrink: 1.0;">

<figure>
<img src="../tokiomarine2021/glm.drawio.svg" width="100%"><br>
</figure>

  </div>
  <div class="column" style="flex-shrink: 1.0;">

```{r glm-poisson, echo = FALSE, fig.height = 5, fig.width = 5}
n = 300L
a = 3
b = -3
df_pois = tibble::tibble(x = runif(n, 0.4, 1.7), y = rpois(n, exp(a * x + b)))

x_breaks = c(0.5, 1.0, 1.5)
df_ridges = tidyr::crossing(x = x_breaks, y = seq_len(30L) - 1L) %>%
 dplyr::mutate(density = dpois(y, exp(a * x + b))) %>%
 dplyr::filter(density > 1e-4)
df_bars = df_ridges %>% wtl::ridges2bars(y, density)

p_pois = ggplot(df_pois) + aes(x, y) +
  geom_point(alpha = 0.5, shape = 16, size = 2) +
  scale_x_continuous(breaks = x_breaks) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank())

p_pois +
  stat_smooth(formula = y ~ x, method = glm, method.args = list(family = poisson), se = FALSE) +
  ggridges::geom_vridgeline(data = df_bars, aes(width = density * 0.5, group = x), fill = "#3366ffaa", linetype = 0)
```

  </div>
</div>

ã“ã®å ´åˆã¯**å˜å›å¸°**ã€‚èª¬æ˜å¤‰æ•°ãŒè¤‡æ•°ã‚ã‚‹ã¨**é‡å›å¸°**ã€‚


---
## è¤‡æ•°ã®èª¬æ˜å¤‰æ•°ã‚’åŒæ™‚ã«æ‰±ã†é‡å›å¸°

<p>\[\begin{split}
y_i &\sim \text{Poisson}(\lambda_i) \\
\log(\lambda_i) &= \beta_0 + \beta_1 x_{1i} + \beta_2 x_{2i} + \ldots
\end{split}\]</p>

æ°—æ¸©ã‚‚æ¹¿åº¦ã‚‚é«˜ã„ã»ã©ãƒ“ãƒ¼ãƒ«ãŒå£²ã‚Œã‚‹ã€ã¨ã‹

```{r multiple-regression, echo = FALSE, fig.height = 5, fig.width = 10}
n = 200L
true_coef = c(3, 0.05, 0.006)
df_beer = tibble::tibble(
  temperature = runif(n, 8, 32),
  humidity = runif(n, 20, 80),
  beer_sales = rpois(n, exp(true_coef[1] + true_coef[2] * temperature + true_coef[3] * humidity))
)
glm_multi = glm(beer_sales ~ temperature + humidity, df_beer, family = poisson)

df_pred = tidyr::crossing(temperature = seq(8, 32, 2), humidity = seq(20, 80, 5)) %>%
  modelr::add_predictions(glm_multi) %>%
  dplyr::mutate(y_pred = exp(pred))

p1 = ggplot(df_beer) + aes(temperature, beer_sales, color = humidity) +
  geom_line(data = df_pred, aes(y = y_pred, group = humidity), alpha = 0.7) +
  geom_point(alpha = 0.5) +
  scale_color_viridis_c(option = "cividis", direction = -1) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(),
        legend.position = c(0.01, 0.99), legend.justification = c(0, 1))
p2 = ggplot(df_beer) + aes(humidity, beer_sales, color = temperature) +
  geom_line(data = df_pred, aes(y = y_pred, group = temperature), alpha = 0.7) +
  geom_point(alpha = 0.5) +
  scale_color_viridis_c(option = "turbo") +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(),
        legend.position = c(0.01, 0.99), legend.justification = c(0, 1))

cowplot::plot_grid(p1, p2, nrow = 1L)
```

ä»Šåº¦ã¯**ç¢ºç‡åˆ†å¸ƒ**ã¨**ãƒªãƒ³ã‚¯é–¢æ•°**ã‚’å¤‰ãˆã¦ã¿ã‚ˆã†ã€‚


---
## ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°

- ç¢ºç‡åˆ†å¸ƒ: **äºŒé …åˆ†å¸ƒ**
- ãƒªãƒ³ã‚¯é–¢æ•°: $\text{logit}(p) = \log \frac {p} {1 - p}$

ä½•ã‹ã®æˆå¦ã«å¯¾ã™ã‚‹ä½•ã‹ã®å› å­ã®å½±éŸ¿ã€ã¨ã‹

<div class="column-container">
  <div class="column" style="flex-shrink: 1.0; padding-top: 1rem;">

å®¢10äººä¸­$y_i$äººãŒãƒ“ãƒ¼ãƒ«ã‚’æ³¨æ–‡ã€‚<br>
ãã®æ—¥$i$ã®æ°—æ¸©$x_i$ã«ã‚ˆã£ã¦å‰²åˆãŒå¤‰åŒ–ã€‚

<p>\[\begin{split}
y_i &\sim \text{Binomial}(n,~p_i) \\
\text{logit}(p_i) &= \beta_0 + \beta_1 x_i \\
p_i &= \frac 1 {1 + e^{-(\beta_0 + \beta_1 x_i)}}
\end{split}\]</p>

ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯é–¢æ•°â†‘

  </div>
  <div class="column" style="flex-shrink: 1.0;">

```{r glm-logistic, echo = FALSE, fig.height = 5, fig.width = 5}
nrep = 200L
n = 10L
df_rlogistic = tibble::tibble(
  x = runif(nrep, -10, 35),
  logit_p = -3 + 0.3 * x,
  p = wtl::logistic(logit_p),
  y = rbinom(nrep, n, p),
  response = matrix(c(y, n - y), ncol = 2)
)
glm_logistic = glm(response ~ x, df_rlogistic, family = binomial)
df_pred = df_rlogistic %>%
  modelr::add_predictions(glm_logistic) %>%
  dplyr::mutate(y_pred = n * wtl::logistic(pred))

coef = glm_logistic$coefficients

x_breaks = c(-10, 0, 10, 20, 30)
df_ridges = tidyr::crossing(x = x_breaks, y = seq.int(0, n)) %>%
  dplyr::mutate(p = wtl::logistic(coef[1] + coef[2] * x), density = dbinom(y, n, p)) %>%
  dplyr::filter(density > 1e-4)
df_bars = df_ridges %>% wtl::ridges2bars(y, density)

ggplot(df_pred) + aes(x, y) +
  geom_point(alpha = 0.5, shape = 16) +
  ggridges::geom_vridgeline(data = df_bars, aes(width = density * 6, group = x), fill = "#3366ffaa", linetype = 0) +
  geom_line(aes(y = y_pred), size = 2, color = "#3366ff") +
  scale_x_continuous(breaks = x_breaks) +
  scale_y_continuous(breaks = seq.int(0, 10)) +
  labs(x = "temperature", y = "beer_sales") +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank(), panel.grid.major.y = element_blank())
```

  </div>
</div>

???
ãƒ­ã‚¸ãƒƒãƒˆ = å¯¾æ•°ã‚ªãƒƒã‚º
ã‚ªãƒƒã‚º = å¤±æ•—ã®ä½•å€æˆåŠŸã—ã‚„ã™ã„ã‹
XãŒ1å¢—ãˆã‚‹ã¨ã‚ªãƒƒã‚ºãŒe^aå€ã«å¢—ãˆã‚‹ã€‚


---
## ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸° (ç‹­ç¾©)

- ç¢ºç‡åˆ†å¸ƒ: **ãƒ™ãƒ«ãƒŒãƒ¼ã‚¤åˆ†å¸ƒ** ($n = 1$ ã®äºŒé …åˆ†å¸ƒ)
- ãƒªãƒ³ã‚¯é–¢æ•°: $\text{logit}(p) = \log \frac {p} {1 - p}$

ä½•ã‹ã®æˆå¦ã«å¯¾ã™ã‚‹ä½•ã‹ã®å› å­ã®å½±éŸ¿ã€ã¨ã‹

<div class="column-container">
  <div class="column" style="flex-shrink: 1.0; padding-top: 1rem;">

é¢¨ãŒå¹ã‘ã°æ¡¶å±‹ãŒå„²ã‹ã‚‹ã€‚

<p>\[\begin{split}
y_i &\sim \text{Bernoulli}(p_i) \\
  &= \text{Binomial}(1,~p_i) \\
\text{logit}(p_i) &= \beta_0 + \beta_1 x_i \\
p_i &= \frac 1 {1 + e^{-(\beta_0 + \beta_1 x_i)}}
\end{split}\]</p>

ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯é–¢æ•°â†‘

  </div>
  <div class="column" style="flex-shrink: 1.0;">

```{r wind, echo = FALSE, fig.height = 4, fig.width = 5}
n = 200
df_wind = tibble::tibble(
  max_wind = runif(n, 0, 40),
  bucket_sales = rbinom(n, 1L, wtl::sigmoid(max_wind - 20, 0.2)) + 0L)
glm_bernoulli = glm(bucket_sales ~ max_wind, df_wind, family = "binomial")

coef = glm_bernoulli$coefficients
x_breaks = c(0, 10, 20, 30, 40)
df_ridges = tidyr::crossing(x = x_breaks, y = c(0, 1)) %>%
  dplyr::mutate(p = wtl::logistic(coef[1] + coef[2] * x), density = dbinom(y, 1, p)) %>%
  dplyr::filter(density > 1e-4)
df_bars = df_ridges %>% wtl::ridges2bars(y, density, width = 0.2)

df_wind %>%
  modelr::add_predictions(glm_bernoulli) %>%
  dplyr::mutate(y_pred = wtl::logistic(pred)) %>%
  ggplot() + aes(max_wind, bucket_sales) +
  geom_point(alpha = 0.3, shape = 124, size = 6) +
  ggridges::geom_vridgeline(data = df_bars, aes(x, y, width = density * 6, group = x), fill = "#3366ffaa", linetype = 0) +
  geom_line(aes(y = y_pred), color = "#3366ff") +
  scale_y_continuous(breaks = c(0, 1)) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank(), panel.grid.major.y = element_blank())
```

  </div>
</div>


---
## ä¸€èˆ¬ç·šå½¢ãƒ¢ãƒ‡ãƒ« (â€œåŒ–â€ç„¡ã—) ã¯GLMã®ä¸€ç¨®

- ç¢ºç‡åˆ†å¸ƒ: **æ­£è¦åˆ†å¸ƒ**
- ãƒªãƒ³ã‚¯é–¢æ•°: **æ’ç­‰é–¢æ•°**(ãªã«ã‚‚ã›ãšãã®ã¾ã¾)

<div class="column-container">
  <div class="column" style="flex-shrink: 1.0; padding-top: 1rem;">

<p>\[\begin{split}
y_i &\sim \mathcal{N}(\mu_i,~\sigma^2) \\
\text{identity}(\mu_i) &= \beta_0 + \beta_1 x_i
\end{split}\]</p>

  </div>
  <div class="column" style="flex-shrink: 1.0;">

```{r glm-weight, echo = FALSE, fig.height = 4, fig.width = 4}
n = 100
df_weight = tibble::tibble(
  height = rnorm(n, 1.70, 0.06),
  bmi = rnorm(n, 22, 0.8),
  weight = bmi * (height ** 2)
) %>%
  dplyr::filter(dplyr::between(height, 1.6, 1.8))

coef = lm(weight ~ height, df_weight)$coefficients

x_breaks = c(1.65, 1.7, 1.75)
df_ridges = tidyr::crossing(height = x_breaks, weight = seq(50, 80, 0.2)) %>%
  dplyr::mutate(density = dnorm(weight, coef[1] + coef[2] * height, 1.8)) %>%
  dplyr::filter(density > 1e-4)

ggplot(df_weight) + aes(height, weight) +
  geom_point(alpha = 0.5, shape = 16) +
  ggridges::geom_vridgeline(data = df_ridges, aes(width = density * 0.08, group = height), fill = "#3366ffaa", linetype = 0) +
  stat_smooth(method = lm, formula = y ~ x, se = FALSE) +
  scale_x_continuous(breaks = x_breaks) +
  theme_bw(base_size = 20) + theme(panel.grid.minor = element_blank())
```

  </div>
</div>

æœ€å°äºŒä¹—æ³•ã®ç›´ç·šã‚ã¦ã¯ã‚ã¨çµæœçš„ã«åŒã˜ã«ãªã‚‹ã€‚

<small style="color: #999999;">å˜å›å¸°ãƒ»é‡å›å¸°ã¨è¨€ã£ãŸã¨ãä¸€èˆ¬ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã‚’å‰æã¨ã™ã‚‹äººã‚‚ã„ã‚‹ã€‚</small>

---
## åˆ†æ•£åˆ†æ (<u>An</u>alysis <u>o</u>f <u>va</u>riance, ANOVA) as GLM

**è³ªçš„ãªèª¬æ˜å¤‰æ•°**ã‚’æŒã¤**æ­£è¦åˆ†å¸ƒãƒ»æ’ç­‰ãƒªãƒ³ã‚¯**ã®GLMã€ã¨è§£é‡ˆå¯èƒ½ã€‚<br>
<span title="ãƒ€ãƒŸãƒ¼å¤‰æ•°ã¨ã‚‚å‘¼ã°ã‚Œã‚‹">**æŒ‡ç¤ºå¤‰æ•°**</span> (0 or 1) ã«å¤‰æ›ã—ã¦ã‹ã‚‰é‡å›å¸°ã™ã‚‹ã€‚

<div class="column-container">
  <div class="column" style="flex-shrink: 1.0; padding-top: 1rem;">

| å¤©æ°— | â†’ | $x_1$ â˜€ï¸ æ™´ã‚Œ | $x_2$ â˜”ï¸ é›¨ |
| ---- | :-: | :---: | :---: |
| â˜ï¸ ãã‚‚ã‚Š | | 0 | 0 |
| â˜€ï¸ æ™´ã‚Œ | | 1 | 0 |
| â˜”ï¸ é›¨ | | 0 | 1 |

<p>\[\begin{split}
y_i &= \mathcal{N}(\mu_i,\sigma^2) \\
\mu_i &= \beta_0 + \beta_1 x_{1i} + \beta_2 x_{2i}
\end{split}\]</p>

  </div>
  <div class="column" style="flex-shrink: 1.3;">

```{r glm-anova, echo = FALSE, fig.height = 4.5, fig.width = 4.5}
n = 200L
coef = c(70, 3, 20, -20)
weather_levels = c("sunny", "cloudy", "rainy")
df_beer = tibble::tibble(
    temperature = runif(n, 8, 32),
    weather = factor(sample(weather_levels, n, TRUE), levels = weather_levels)
  ) %>%
  dplyr::mutate(name = weather, value = 1L) %>%
  tidyr::pivot_wider(values_fill = 0L) %>%
  dplyr::select(!cloudy) %>%
  dplyr::mutate(beer_sales = rnorm(n, coef[1] + coef[2] * temperature + coef[3] * sunny + coef[4] * rainy, 10))

lm_anova = lm(beer_sales ~ weather, df_beer)
df_ridges = tidyr::crossing(weather = factor(weather_levels, levels = weather_levels), beer_sales = seq(50, 200, 1)) %>%
  modelr::add_predictions(lm_anova) %>%
  dplyr::mutate(density = dnorm(beer_sales, pred, 10)) %>%
  dplyr::filter(density > 1e-4)

tidy_anova = broom::tidy(lm_anova)

avgs = tidyr::crossing(weather = factor(weather_levels, levels = weather_levels)) %>%
  modelr::add_predictions(lm_anova) %>%
  tibble::deframe()

dfl = tibble::tribble(
  ~x, ~xend, ~y, ~yend,
  -Inf, Inf, avgs["cloudy"], avgs["cloudy"],
  1.5, 2.5, avgs["sunny"], avgs["sunny"],
  2.5, 3.5, avgs["rainy"], avgs["rainy"]
)

dfa = tibble::tribble(
  ~x, ~xend, ~y, ~yend,
  1.75, 1.75, avgs["cloudy"], avgs["sunny"],
  2.75, 2.75, avgs["cloudy"], avgs["rainy"]
)

dfs = tibble::tribble(
  ~x, ~y, ~label,
  0.6, avgs["cloudy"] + (avgs["sunny"] - avgs["cloudy"]) * 0.3, "beta[0]",
  1.55, (avgs["cloudy"] + avgs["sunny"]) / 2, "beta[1]",
  2.55, (avgs["cloudy"] + avgs["rainy"]) / 2, "beta[2]"
)

.arr = grid::arrow(length = grid::unit(0.1, "inches"))
df_beer %>%
  ggplot() + aes(weather, beer_sales, color = weather) +
  ggridges::geom_vridgeline(data = df_ridges, aes(width = density * 6, group = weather), fill = "#3366ffaa", linetype = 0) +
  annotate("segment", x = dfl$x, xend = dfl$xend, y = dfl$y, yend = dfl$yend, color = "#3366ffaa") +
  annotate("segment", x = dfa$x, xend = dfa$xend, y = dfa$y, yend = dfa$yend, arrow = .arr, color = "#3366ffaa") +
  annotate("text", x = dfs$x, y = dfs$y, label = dfs$label, parse = TRUE, size = 6, color = "#3366ffaa") +
  geom_jitter(width = 0.08, height = 0, alpha = 0.66, shape = 16, size = 3) +
  scale_color_viridis_d(direction = -1, guide = guide_legend(title = NULL)) +
  scale_x_discrete(limits = c("cloudy", "sunny", "rainy")) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), legend.position = "none")
```

  </div>
</div>

ãã‚‚ã‚Šâ˜ï¸ $\beta_0$ ã‚’åŸºæº–ã«ã€æ™´ã‚Œã®åŠ¹æœâ˜€ï¸ $\beta_1$ ã¨é›¨ã®åŠ¹æœâ˜”ï¸ $\beta_2$ ãŒæ±‚ã¾ã‚‹ã€‚

GLMãªã‚‰ç¢ºç‡åˆ†å¸ƒãƒ»ãƒªãƒ³ã‚¯é–¢æ•°ã‚’å¤‰ãˆã¦ã‚‚ã£ã¨æŸ”è»Ÿã«ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã§ãã‚‹ã€‚


---
## å…±åˆ†æ•£åˆ†æ (<u>An</u>alysis of <u>cova</u>riance, ANCOVA) as GLM

**è³ªçš„å¤‰æ•°ã¨é‡çš„å¤‰æ•°ã‚’ä¸¡æ–¹**å«ã‚€GLMã€ã¨è§£é‡ˆå¯èƒ½ã€‚<br>
æ­£è¦åˆ†å¸ƒãƒ»ç­‰åˆ†æ•£ãƒ»æ’ç­‰ãƒªãƒ³ã‚¯ãªã©ãŒä»®å®šã•ã‚Œã‚‹ã€‚


<div class="column-container">
  <div class="column" style="flex-shrink: 1.0; padding-top: 1rem;">

| å¤©æ°— | â†’ | $x_1$ â˜€ï¸ æ™´ã‚Œ | $x_2$ â˜”ï¸ é›¨ |
| ---- | :-: | :---: | :---: |
| â˜ï¸ ãã‚‚ã‚Š | | 0 | 0 |
| â˜€ï¸ æ™´ã‚Œ | | 1 | 0 |
| â˜”ï¸ é›¨ | | 0 | 1 |

<p>\[\begin{split}
y_i &= \mathcal{N}(\mu_i,\sigma^2) \\
\mu_i &= \beta_0 + \beta_1 x_{1i} + \beta_2 x_{2i} + \beta_3 x_{3i}
\end{split}\]</p>

  </div>
  <div class="column" style="flex-shrink: 1.3;">


```{r glm-ancova, echo = FALSE, fig.height = 4.5, fig.width = 4.5}
lm_ancova = lm(beer_sales ~ temperature + weather, df_beer)
df_pred = tidyr::crossing(temperature = seq(8, 32, 2), weather = factor(weather_levels, levels = weather_levels)) %>%
  modelr::add_predictions(lm_ancova) %>%
  dplyr::mutate(y_pred = pred)

ggplot(df_beer) + aes(temperature, beer_sales, color = weather) +
  geom_line(data = df_pred, aes(y = y_pred, group = weather), alpha = 0.7, size = 2) +
  geom_point(alpha = 0.6, shape = 16, size = 3) +
  scale_color_viridis_d(direction = -1, guide = guide_legend(title = NULL)) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(),
        legend.position = c(0.01, 0.99), legend.justification = c(0, 1))
```

  </div>
</div>

GLMãªã‚‰ç¢ºç‡åˆ†å¸ƒãƒ»ãƒªãƒ³ã‚¯é–¢æ•°ã‚’å¤‰ãˆã¦ã‚‚ã£ã¨æŸ”è»Ÿã«ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã§ãã‚‹ã€‚


---
## ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«(GLM)ãµã‚Šã‹ãˆã‚Š

ç¢ºç‡åˆ†å¸ƒãƒ»ãƒªãƒ³ã‚¯é–¢æ•°ã‚’å¤‰ãˆã¦æŸ”è»Ÿã«ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã§ãã‚‹ã€‚<br>
ç‰¹å®šã®çµ„ã¿åˆã‚ã›ã«ã¯åå‰ãŒã‚ã‚‹ã€‚

| åå‰ | ç¢ºç‡åˆ†å¸ƒ | ãƒªãƒ³ã‚¯é–¢æ•° | èª¬æ˜å¤‰æ•° |
| ---- | -------- | -------- | -------- |
|ãƒã‚¢ã‚½ãƒ³å›å¸°|ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒ|log| |
|ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°|äºŒé …åˆ†å¸ƒ|logit| |
|ä¸€èˆ¬ç·šå½¢å›å¸°|æ­£è¦åˆ†å¸ƒ|æ’ç­‰| |
|åˆ†æ•£åˆ†æ|æ­£è¦åˆ†å¸ƒ|æ’ç­‰|è³ªçš„å¤‰æ•°|
|å…±åˆ†æ•£åˆ†æ|æ­£è¦åˆ†å¸ƒ|æ’ç­‰|è³ªçš„å¤‰æ•°+é‡çš„å¤‰æ•°|

ãƒªãƒ³ã‚¯é–¢æ•°ã‚’ã‚‚ã†å°‘ã—ã ã‘æ˜ã‚Šä¸‹ã’ãŸã„ã€‚


---
## ãƒªãƒ³ã‚¯é–¢æ•°

çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã«ãŠã„ã¦ã€Œã¾ã£ã™ãä»¥å¤–ã‚‚è¡¨ç¾ã§ãã‚‹ã€æ„å‘³

$\text{identity}(\mu_i)$
: $\mu_i = \beta_0 + \beta_1 x_{1i} + \beta_2 x_{2i} + \ldots$
: èª¬æ˜å¤‰æ•°ã®åŠ¹æœãŒ**è¶³ã—ç®—**çš„ã«åƒãã€‚

$\log(\lambda_i)$
: $\lambda_i = e^{\beta_0 + \beta_1 x_{1i} + \beta_2 x_{2i} + \ldots} = e^{\beta_0} \times e^{\beta_1 x_{1i}} \times e^{\beta_2 x_{2i}} \times \ldots$
: èª¬æ˜å¤‰æ•°ã®åŠ¹æœãŒ**æ›ã‘ç®—**çš„ã«åƒãã€‚<br>
  e.g., $\Delta x_1$ å¢—ãˆã‚‹ã¨ $e^{\beta_1 \Delta x_{1}}$ å€ã«ãªã‚‹

$\text{logit}(p_i)$
: $p_i = \frac 1 {1 + e^{-(\beta_0 + \beta_1 x_i + \ldots)}} $ (ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯é–¢æ•°)
: èª¬æ˜å¤‰æ•°ã®åŠ¹æœãŒ**é ­æ‰“ã¡**ã«ãªã‚‹ã€‚<br>
  e.g., $\lim_{x \to -\infty} p = 0;~\lim_{x \to \infty} p = 1$

ã»ã‹ã« `probit`, `inverse`, `sqrt`, etc.


---
## ãƒ‡ãƒ¼ã‚¿ã¯ã²ã¨ã¤ã€ãƒ¢ãƒ‡ãƒ«ã¯ãŸãã•ã‚“

ã©ã†é¸ã¶ï¼Ÿ

1. ãƒ¡ã‚«ãƒ‹ã‚ºãƒ çš„ã«ç´å¾—ã§ãã‚‹ã‚‚ã®ã‚’é¸ã¶
    - ãƒã‚¢ã‚½ãƒ³éç¨‹ã®**ã‚«ã‚¦ãƒ³ãƒˆ**ãªã‚‰ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒã€**é–“éš”**ãªã‚‰ã‚¬ãƒ³ãƒåˆ†å¸ƒ
    - nå›ä¸­kå›ã®ã‚ˆã†ã«**å‰²åˆçš„ãªã‚«ã‚¦ãƒ³ãƒˆ**ãªã‚‰äºŒé …åˆ†å¸ƒ
1. ãƒ‡ãƒ¼ã‚¿ã‚’å¯è¦–åŒ–ã—ã¦ã¿ã¦ã€ãã‚Œã£ã½ã„å½¢ãƒ»æ€§è³ªã®ã‚‚ã®ã‚’é¸ã¶
    - **å·¦å³å¯¾ç§°ã®ã²ã¨å±±**ãªã‚‰ã¨ã‚Šã‚ãˆãšæ­£è¦åˆ†å¸ƒ
    - **è² ã®å€¤ã‚’å–ã‚‰ãªã„**ãªã‚‰ã‚¬ãƒ³ãƒåˆ†å¸ƒ
    - ç›´ç·šçš„ã‹ã€æŒ‡æ•°é–¢æ•°çš„ã‹ã€é ­æ‰“ã¡ã‹ã€ãªã©ãªã©

å®¢è¦³çš„ãªæŒ‡æ¨™ã‚‚ã»ã—ã„ã€‚<br>
ãƒ¢ãƒ‡ãƒ«ã®å°¤ã‚‚ã‚‰ã—ã•ã¨ã„ãˆã°...


---
## <ruby>å°¤<rt>ã‚†ã†</rt>åº¦</ruby> (likelihood)

**ã‚ã‚‹ãƒ¢ãƒ‡ãƒ«$M$ã®ä¸‹ã§ãã®ãƒ‡ãƒ¼ã‚¿$D$ãŒè¦³å¯Ÿã•ã‚Œã‚‹ç¢ºç‡**:<br>
$\text{Prob}(D \mid M)$

ãƒ‡ãƒ¼ã‚¿$D$ã‚’å›ºå®šã—ã€ãƒ¢ãƒ‡ãƒ«$M$ã®é–¢æ•°ã¨ã¿ãªã—ãŸã‚‚ã®ãŒ**å°¤åº¦é–¢æ•°**:<br>
$L(M \mid D)$

ãƒ¢ãƒ‡ãƒ«ã®æ§‹é€ ã‚‚å›ºå®šã—ã¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿$\theta$ã ã‘å‹•ã‹ã™å ´åˆã¯ã“ã†æ›¸ã:<br>
$L(\theta \mid D)$ or $L(\theta)$

**å¯¾æ•°å°¤åº¦** $\log L$ ã®å½¢ã«ã—ãŸã»ã†ãŒã„ã‚ã„ã‚ä¾¿åˆ©ã€‚

<hr>

å„ãƒ¢ãƒ‡ãƒ«ã§æœ€é©ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¢ã—ã¦ã€æ¯”è¼ƒ:<br>
$\log L^* (M_1) \text{ vs. } \log L^* (M_2) \text{ vs. } \log L^* (M_3) \ldots$


---
## ãŸã—ã‹ã«å°¤åº¦ã¯ã‚ã¦ã¯ã¾ã‚Šã®è‰¯ã•ã‚’è¡¨ã—ã¦ãã†

ã“ã®å ´åˆã¯ç›´ç·šå›å¸°ã‚ˆã‚Šã‚‚ãƒã‚¢ã‚½ãƒ³å›å¸°ãŒè‰¯ã•ãã†:

```{r compare-loglik, echo = FALSE, fig.height = 5, fig.width = 9}
n = 300L
a = 3
b = -3
df_pois = tibble::tibble(x = runif(n, 0.4, 1.7), y = rpois(n, exp(a * x + b)))

models = setNames(, c("gaussian", "poisson")) %>% purrr::map(~{
  glm(y ~ x, family = .x, data = df_pois)
})

x_breaks = c(0.5, 1.0, 1.5)
df_lm = tidyr::crossing(x = x_breaks, y = seq(-5, 20, 0.1)) %>%
  modelr::add_predictions(models[["gaussian"]]) %>%
  dplyr::mutate(density = dnorm(y, pred, 1.4)) %>%
  dplyr::filter(density > 1e-4)

p_pois = ggplot(df_pois) + aes(x, y) +
  ggridges::geom_vridgeline(data = df_lm, aes(width = density * 0.4, group = x), linetype = 0, alpha = 0) +
  geom_point(alpha = 0.5, shape = 16, size = 2) +
  scale_x_continuous(breaks = x_breaks) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank())

label = sprintf("logLik = %.1f", broom::glance(models[["gaussian"]])$logLik)
p_lm = p_pois +
  labs(title = "gaussian, identity link") +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = label, color = "#3366ff", size = 6) +
  stat_smooth(formula = y ~ x, method = lm, se = FALSE) +
  ggridges::geom_vridgeline(data = df_lm, aes(width = density * 0.4, group = x), fill = "#3366ffaa", linetype = 0)
# p_lm

df_ridges = tidyr::crossing(x = x_breaks, y = seq_len(30L) - 1L) %>%
  modelr::add_predictions(models[["poisson"]]) %>%
  dplyr::mutate(density = dpois(y, exp(pred))) %>%
  dplyr::filter(density > 1e-4)
df_bars = df_ridges %>% wtl::ridges2bars(y, density)

label = sprintf("logLik = %.1f", broom::glance(models[["poisson"]])$logLik)
p_poisson = p_pois +
  labs(title = "poisson, log link") +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = label, color = "#3366ff", size = 6) +
  stat_smooth(formula = y ~ x, method = glm, method.args = list(family = poisson), se = FALSE) +
  ggridges::geom_vridgeline(data = df_bars, aes(width = density * 0.5, group = x), fill = "#3366ffaa", linetype = 0)
# p_poisson

cowplot::plot_grid(p_lm, p_poisson, nrow = 1L)
```

ã“ã®èª¿å­ã§ã€ã‚ˆã‚Šå°¤åº¦ã®é«˜ã„ãƒ¢ãƒ‡ãƒ«ã‚’æ¢ã—ã¦ã„ã‘ã°ã„ã„ã ã‚ã†ã‹ï¼Ÿ

---
## ã‚ã¦ã¯ã¾ã‚ŠãŒè‰¯ã‘ã‚Œã°ã„ã„ã£ã¦ã‚‚ã‚“ã§ã‚‚ãªã„

éå‰°é©åˆ / éå­¦ç¿’ / overfitting
: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¢—ã‚„ã›ã°**ç¾ãƒ‡ãƒ¼ã‚¿ã¸ã®**é©åˆåº¦ãƒ»å°¤åº¦ã‚’é«˜ãã§ãã‚‹ãŒã€<br>
  äºˆæ¸¬ãƒ»ç†è§£ã®å½¹ã«ã¯ç«‹ãŸãªããªã‚‹ã€‚

```{r saturated-model, echo = FALSE, fig.height = 4, fig.width = 11}
n = 16L
true_coef = c(0.1, 0.2)
df_plant = tibble::tibble(
  x = runif(n, 7, 12.5),
  lambda = exp(true_coef[1] + true_coef[2] * x),
  y = rpois(n, lambda)
) %>% tibble::rownames_to_column("id")

models = df_plant %>% modelr::fit_with(glm, family = "poisson", modelr::formulas(~y,
  null = ~ 1,
  x = ~ x,
  saturated = ~ id
))
labels = setNames(sprintf("logLik = %.1f", purrr::map_dbl(models, logLik)), names(models))

p_plant = df_plant %>%
  modelr::add_predictions(models$null) %>%
  ggplot() + aes(x, y) +
  geom_line(aes(y = exp(pred)), color = "#3366ff", size = 2, alpha = 0.7) +
  geom_point(shape = 16, alpha = 0.6) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), legend.position = "none")

p_null = p_plant +
  labs(title = "null model") +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = labels[["null"]], color = "#3366ff", size = 6)
p_x = p_plant %+% modelr::add_predictions(df_plant, models$x) +
  labs(title = expression(y %~% beta[0] + beta[1] * x)) +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = labels[["x"]], color = "#3366ff", size = 6)
p_saturated = p_plant %+% modelr::add_predictions(df_plant, models$saturated) +
  labs(title = "saturated model") +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = labels[["saturated"]], color = "#3366ff", size = 6)

cowplot::plot_grid(p_null, p_x, p_saturated, nrow = 1L)
```

**å¸°ç„¡ãƒ¢ãƒ‡ãƒ«**: èª¬æ˜å¤‰æ•°ãªã—ã€‚åˆ‡ç‰‡ã®ã¿ã€‚<br>
**é£½å’Œãƒ¢ãƒ‡ãƒ«**: ãƒ‡ãƒ¼ã‚¿ç‚¹ã®æ•° â‰¤ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ•°ã€‚â€œãƒ‡ãƒ¼ã‚¿èª­ã¿ä¸Šã’â€çš„ãƒ¢ãƒ‡ãƒ«


---
## ç„¡é§„ãªèª¬æ˜å¤‰æ•°ã‚’åŠ ãˆã¦ã‚‚å°¤åº¦ã¯ä¸ŠãŒã‚‹

ã‚ã‚‹æ¤ç‰©ãŒä½œã‚‹ç¨®ã®æ•° $y$ ã¯å€‹ä½“ã®ã‚µã‚¤ã‚º $x$ ã«å¿œã˜ã¦å¢—ãˆã‚‹ã€‚<br>
è¦³å¯Ÿæ™‚ã«ç€ã¦ãŸæœã®è‰² $x_2$ ã‚’è¿½åŠ ã™ã‚‹ã¨å°¤åº¦ãŒä¸ŠãŒã‚‹......?

```{r many-models, echo = FALSE, fig.height = 7, fig.width = 7}
set.seed(24601)
n = 120L
true_coef = c(1, 0.12, 0)
df_plant = tibble::tibble(
  x = runif(n, 7, 12.5),
  x2 = sample(c(FALSE, TRUE), n, replace = TRUE),
  lambda = exp(true_coef[1] + true_coef[2] * x + true_coef[3] * x2),
  y = rpois(n, lambda)
) %>% tibble::rownames_to_column("id")

models = df_plant %>% modelr::fit_with(glm, family = "poisson", modelr::formulas(~y,
  null = ~ 1,
  x = ~ x,
  x2 = ~ x2,
  both = ~ x + x2,
  saturated = ~ id
))
labels = setNames(sprintf("logLik = %.1f", purrr::map_dbl(models, logLik)), names(models))

p_plant = df_plant %>%
  modelr::add_predictions(models$null) %>%
  ggplot() + aes(x, y) +
  geom_line(aes(y = exp(pred)), size = 1.5, alpha = 0.6) +
  geom_point(shape = 16, alpha = 0.6) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), legend.position = "none")

p_null = p_plant +
  labs(title = "null model") +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = labels[["null"]], color = "#3366ff", size = 6)
p_x = p_plant %+% (df_plant %>% modelr::add_predictions(models$x)) +
  labs(title = expression(y %~% beta[0] + beta[1] * x)) +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = labels[["x"]], color = "#3366ff", size = 6)
p_x2 = p_plant %+% (df_plant %>% modelr::add_predictions(models$x2)) %+%
  aes(color = x2, group = x2) +
  labs(title = expression(y %~% beta[0] + beta[2] * x[2])) +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = labels[["x2"]], color = "#3366ff", size = 6)
p_both = p_plant %+% (df_plant %>% modelr::add_predictions(models$both)) %+%
  aes(color = x2, group = x2) +
  labs(title = expression(y %~% beta[0] + beta[1] * x + beta[2] * x[2])) +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = labels[["both"]], color = "#3366ff", size = 6)

cowplot::plot_grid(p_null, p_x, p_x2, p_both, nrow = 2L)
```



---
## AIC: èµ¤æ± æƒ…å ±é‡åŸºæº–

<p>\[\begin{split}
\text{AIC} = -2 (\log L^* - k) = -2 \log L^* + 2k
\end{split}\]</p>

- AICãŒå°ã•ã„ã»ã©äºˆæ¸¬ç²¾åº¦ã®è‰¯ã„ãƒ¢ãƒ‡ãƒ«ã€‚
    - å°¤åº¦ã¯ä¸Šã’ãŸã„ã€‚
    - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•° $k$ ãŒå¢—ãˆã‚‹ã¨ãƒšãƒŠãƒ«ãƒ†ã‚£ã€‚
- ã©ã®ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã™ã‚‹å½“ã¦ã¯ã¾ã‚Šã‚’ç›®æŒ‡ã™ã‹ã¨ã„ã†è¦³ç‚¹
    - ã€Œæ‰‹å…ƒã®ãƒ‡ãƒ¼ã‚¿ã€ã«å¯¾ã™ã‚‹å¯¾æ•°å°¤åº¦ã¯ $\log L^*$<br>
    - ã€ŒçœŸã®ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‹ã‚‰å‡ºã¦ãã‚‹æœªæ¥ã®ãƒ‡ãƒ¼ã‚¿ã€ã«å¯¾ã™ã‚‹<br>
      å¹³å‡å¯¾æ•°å°¤åº¦ã®æ¨å®šé‡ã¯ $(\log L^* - k)$<br>
      (Kullback--Leibleræƒ…å ±é‡ã‚’ä½¿ã£ã¦å°å‡ºã™ã‚‹ã‚‰ã—ã„)


???
https://www.slideshare.net/logics-of-blue/1-6aic


---
## ç„¡é§„ãªèª¬æ˜å¤‰æ•°ã®è¿½åŠ ã§AICå¢—åŠ 

ã‚ã‚‹æ¤ç‰©ãŒä½œã‚‹ç¨®ã®æ•° $y$ ã¯å€‹ä½“ã®ã‚µã‚¤ã‚º $x$ ã«å¿œã˜ã¦å¢—ãˆã‚‹ã€‚<br>
è¦³å¯Ÿæ™‚ã«ç€ã¦ãŸæœã®è‰² $x_2$ ã‚’è¿½åŠ ã—ãŸãƒ¢ãƒ‡ãƒ«ã¯AICãŒå¢—åŠ ã€‚

```{r many-models-aic, echo = FALSE, fig.height = 7, fig.width = 7}
labels = setNames(sprintf("AIC = %.1f", purrr::map_dbl(models, AIC)), names(models))
p_null = p_plant +
  labs(title = "null model") +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = labels[["null"]], color = "#3366ff", size = 6)
p_x = p_plant %+% (df_plant %>% modelr::add_predictions(models$x)) +
  labs(title = expression(y %~% beta[0] + beta[1] * x)) +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = labels[["x"]], color = "#3366ff", size = 6)
p_x2 = p_plant %+% (df_plant %>% modelr::add_predictions(models$x2)) %+%
  aes(color = x2, group = x2) +
  labs(title = expression(y %~% beta[0] + beta[2] * x[2])) +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = labels[["x2"]], color = "#3366ff", size = 6)
p_both = p_plant %+% (df_plant %>% modelr::add_predictions(models$both)) %+%
  aes(color = x2, group = x2) +
  labs(title = expression(y %~% beta[0] + beta[1] * x + beta[2] * x[2])) +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = labels[["both"]], color = "#3366ff", size = 6)
cowplot::plot_grid(p_null, p_x, p_x2, p_both, nrow = 2L)
```

---
## ã»ã‹ã®æƒ…å ±é‡åŸºæº–

- $\text{BIC} = -2 \log L^* + k \log n$
    - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•° $k$ ã§ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’ä»˜ã‘ã‚‹ã®ã¯AICã¨åŒã˜ã€‚
    - ãƒ‡ãƒ¼ã‚¿ã®è¦³æ¸¬æ•° $n$ ã«ä¾å­˜ã™ã‚‹ç‚¹ã§AICã¨ç•°ãªã‚‹ã€‚<br>
      æ„Ÿè¦šã¨ã—ã¦ã¯ã€ŒAICã¯ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã«ã‚ˆã‚‹ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒç„¡ã„ã€
    - (å‘¨è¾ºå°¤åº¦ã®æœ€å¤§åŒ–ã¨ã„ã†è¦³ç‚¹ã§å°å‡ºã™ã‚‹ã‚‰ã—ã„)
- [WAIC](http://watanabe-www.math.dis.titech.ac.jp/users/swatanab/waic2011.html),
  [WBIC](http://watanabe-www.math.dis.titech.ac.jp/users/swatanab/wbic2012.html)
    - AIC, BICã‚’ä¸€èˆ¬åŒ–ã—ã€åºƒãä½¿ãˆã‚‹ã‚ˆã†ã«ã—ãŸã‚‚ã®ã€‚
    - ç†æƒ³çš„ãªæ¡ä»¶ã§ã¯ãã‚Œãã‚ŒAIC, BICã¨ã»ã¼åŒã˜ã€‚<br>
      ãã†ã˜ã‚ƒãªã„å ´åˆ(ç¾å®Ÿçš„ã«ã¯å¸¸ã«)ã“ã¡ã‚‰ãŒå„ªä½ã€‚
    - WAICã¯äºˆæ¸¬ã®è‰¯ã•ã€WBICã¯çœŸã®ãƒ¢ãƒ‡ãƒ«ã¸ã®è¿‘ã•ã€ã‚’è¡¨ã™ã€‚


---
## ãƒ¢ãƒ‡ãƒ«é¸æŠã®å¿ƒæ§‹ãˆ

ã€Œæ­£ã—ã„ã€ã‚‚ã®ã‚’é¸ã¹ã‚‹ã‚ã‘ã§ã¯ãªã„ã€‚<br>
äºˆæ¸¬ãƒ»ç†è§£ã« useful ãªã‚‚ã®ã‚’ä½•ã‚‰ã‹ã®åŸºæº–ã§é¸ã¶ã ã‘ã€‚

> All models are wrong, but some are useful. --- George E. P. Box

<figure>
<img src="../tokiomarine2021/math-model.drawio.svg" width="600"><br>
<figcaption><cite>ã€Œãƒ‡ãƒ¼ã‚¿åˆ†æã®ãŸã‚ã®æ•°ç†ãƒ¢ãƒ‡ãƒ«å…¥é–€ã€æ±Ÿå´è²´è£• 2020 ã‚ˆã‚Šæ”¹å¤‰</cite></figcaption>
</figure>


---
## ç¾å®Ÿçš„ãªæ³¨æ„ç‚¹ãƒ»æ‚©ã¿ã©ã“ã‚

- å¤šé‡å…±ç·šæ€§(multicollinearity):
    - èª¬æ˜å¤‰æ•°åŒå£«ãŒå¼·ã„ç›¸é–¢é–¢ä¿‚ã«ã‚ã‚‹
- å¤‰æ•°å¤‰æ›:
    - æ°—å®‰ãã‚„ã‚‹ã¹ãã˜ã‚ƒãªã„ã‘ã©ã€å¯¾æ•°å¤‰æ›ãªã©ã—ã°ã—ã°æœ‰ç”¨
    - å‰²ã‚Šç®—ã—ãŸå€¤ã¯å±é™º
- äº¤äº’ä½œç”¨ã‚’å…¥ã‚Œã‚‹ã¨è§£é‡ˆãŒé›£ã—ããªã‚‹ã€‚


---
## äº¤äº’ä½œç”¨

ã‚ã‚‹èª¬æ˜å¤‰æ•°ã®åŠ¹æœãŒã€åˆ¥ã®èª¬æ˜å¤‰æ•°ã«ã‚ˆã£ã¦ç•°ãªã‚‹ã€‚<br>
e.g., ãƒ“ãƒ¼ãƒ«å£²ä¸Šã®æ¸©åº¦ä¾å­˜æ€§ãŒå¤©æ°—ã«ã‚ˆã£ã¦ç•°ãªã‚‹ã€‚

<div class="column-container">
  <div class="column" style="flex-shrink: 1.0; padding-top: 0.1rem;">

| å¤©æ°— | $x_1$ |
| ---- | :---: |
| â˜€ï¸ æ™´ã‚Œ | 1 |
| â˜”ï¸ é›¨ | 0 |

<p>\[\begin{split}
y_i &= \mathcal{N}(\mu_i,\sigma^2) \\
\mu_i &= \beta_0 + \beta_1 x_{1i} + \beta_2 x_{2i} + \beta_{1,2} x_{1i} x_{2i}
\end{split}\]</p>

é›¨ã®æ—¥ã¯ $x_{1i} = 0$ ã®ãŸã‚ $\beta_0,~\beta_2$ ã®é …ã ã‘ã€‚<br>
æ™´ã‚Œã®æ—¥ã¯ãã‚Œã«åŠ ãˆã¦ $\beta_1,~\beta_{1,2}$ ã®é …ã‚‚ã€‚

  </div>
  <div class="column" style="flex-shrink: 1.3;">

```{r interaction, echo = FALSE, fig.height = 4.5, fig.width = 4.5}
n = 200L
coef = c(70, 3, 100, -2)
weather_levels = c("sunny", "rainy")
df_beer = tibble::tibble(
    temperature = runif(n, 8, 32),
    weather = factor(sample(weather_levels, n, TRUE), levels = weather_levels)
  ) %>%
  dplyr::mutate(name = weather, value = 1L) %>%
  tidyr::pivot_wider(values_fill = 0L) %>%
  dplyr::mutate(mu = coef[1] * sunny + coef[2] * temperature + coef[3] * rainy + coef[4] * temperature * rainy) %>%
  dplyr::mutate(beer_sales = rnorm(n, mu, 10))

lm_int = lm(beer_sales ~ temperature * weather, df_beer)
df_pred = tidyr::crossing(temperature = seq(8, 32, 2), weather = factor(weather_levels, levels = weather_levels)) %>%
  modelr::add_predictions(lm_int) %>%
  dplyr::mutate(y_pred = pred)

ggplot(df_beer) + aes(temperature, beer_sales, color = weather) +
  geom_line(data = df_pred, aes(y = y_pred, group = weather), alpha = 0.7, size = 2) +
  geom_point(alpha = 0.6, shape = 16, size = 3) +
  scale_color_viridis_d(direction = -1, guide = guide_legend(title = NULL)) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank(),
        legend.position = c(0.01, 0.99), legend.justification = c(0, 1))
```

  </div>
</div>


è§£é‡ˆãŒä¸€æ°—ã«é›£ã—ããªã‚‹ã®ã§ã‚€ã‚„ã¿ã«ä½¿ã‚ãªã„ã€‚

---
## ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«åº§å­¦ã¾ã¨ã‚

- ä½•ã¯ã¨ã‚‚ã‚ã‚Œæ•£å¸ƒå›³ã‚’æã
- é©åˆ‡ãªç¢ºç‡åˆ†å¸ƒãƒ»ãƒªãƒ³ã‚¯é–¢æ•°ãƒ»èª¬æ˜å¤‰æ•°ã‚’è€ƒãˆã‚‹
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æœ€å°¤æ¨å®šã™ã‚‹
- å°¤åº¦ã¯ã€Œæ‰‹å…ƒã®ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚ã¦ã¯ã¾ã‚Šã€
- ãƒ¢ãƒ‡ãƒ«ã‚’æ¯”è¼ƒã™ã‚‹ã¨ãã¯æƒ…å ±é‡åŸºæº–ã‚’å‚è€ƒã«ã™ã‚‹


---
## penguinsãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ

<a href="https://allisonhorst.github.io/palmerpenguins/">
<cite>https://allisonhorst.github.io/palmerpenguins/</cite><br>
<img src="/slides/image/rstats/lter_penguins.png" width="45%">
<img src="/slides/image/rstats/culmen_depth.png" width="45%">
</a>

```r
# install.packages("palmerpenguins")
library(palmerpenguins)
print(penguins)
penguins_colors = c(Adelie = "darkorange", Chinstrap = "purple", Gentoo = "cyan4")
```

---
## penguinsãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ

<a href="https://allisonhorst.github.io/palmerpenguins/">
<cite>https://allisonhorst.github.io/palmerpenguins/</cite><br>
<img src="/slides/image/rstats/lter_penguins.png" width="45%">
<img src="/slides/image/rstats/culmen_depth.png" width="45%">
</a>

```{r penguins, echo = FALSE, fig.height = 4.5, fig.width = 4.5}
if (!require(palmerpenguins, quietly = TRUE)) {
  install.packages("palmerpenguins")
  library(palmerpenguins)
}
penguins_colors = c(Adelie = "darkorange", Chinstrap = "purple", Gentoo = "cyan4")
print(penguins)
```

---
## å˜å›å¸°ã®ç·´ç¿’: 1. ã¾ãšä½œå›³

ã©ã†ã‚„ã‚‰ã€é‡ã„ãƒšãƒ³ã‚®ãƒ³ã»ã©ç¿¼é•·ã‚‚é•·ã„ã€‚

```{r penguins-weight, fig.height = 5, fig.width = 5, warning = FALSE}
p_penweight = ggplot(penguins) +
  aes(body_mass_g, flipper_length_mm) +
  geom_point(shape = 16, alpha = 0.66) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank())
p_penweight
```


---
## å˜å›å¸°ã®ç·´ç¿’: 2. ãƒ¢ãƒ‡ãƒ«ä½œæˆã€ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°

```{r penguins-fit1}
fit1 = glm(flipper_length_mm ~ body_mass_g, data = penguins)
broom::tidy(fit1)
broom::glance(fit1)
```

---
## å˜å›å¸°ã®ç·´ç¿’: 3. ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°çµæœã‚’ä½œå›³

$y = 136.7 + 0.0153 x$

```{r penguins-weight-glm, fig.height = 5, fig.width = 5, warning = FALSE}
added1 = modelr::add_predictions(penguins, fit1)
p1 = p_penweight +
  geom_line(aes(y = pred), data = added1, size = 1, color = "#3366ff")
p1
```

---
## é‡å›å¸°ã®ç·´ç¿’: 1. ã¾ãšä½œå›³

é‡ã„ãƒšãƒ³ã‚®ãƒ³ã»ã©ç¿¼é•·ã‚‚é•·ã„ã€‚ç¿¼é•·ã¯ç¨®ã«ã‚ˆã£ã¦ã‚‚é•ã†ã‹ã‚‚ã€‚

```{r penguins-weight-sp, fig.height = 5, fig.width = 7, warning = FALSE}
p_penweight_color = p_penweight + aes(color = species) +
  scale_color_manual(values = penguins_colors)
p_penweight_color
```


---
## é‡å›å¸°ã®ç·´ç¿’: 2. ãƒ¢ãƒ‡ãƒ«ä½œæˆã€ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°

Adelieã‚’åŸºæº–ã«ã€Chinstrapã¨Gentooã¯ãã‚Œã‚ˆã‚Šé•·ã‚ã€‚<br>
ä½“é‡ã®åŠ¹æœã¯å˜å›å¸°ã®ã¨ãã‚ˆã‚Šå°ã•ã„ã€‚

```{r penguins-fit2}
fit2 = glm(flipper_length_mm ~ body_mass_g + species, data = penguins)
broom::tidy(fit2)
broom::glance(fit2)
```

---
## é‡å›å¸°ã®ç·´ç¿’: 3. ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°çµæœã‚’ä½œå›³

```{r penguins-weight-sp-glm, fig.height = 5, fig.width = 7, warning = FALSE}
added2 = modelr::add_predictions(penguins, fit2)
p2 = p_penweight_color +
  geom_line(aes(y = pred), data = added2, size = 1)
p2
```

**å‚¾ã**ã‚‚ç¨®ã«ã‚ˆã£ã¦é•ã†ã‹ã‚‚ã€‚**äº¤äº’ä½œç”¨**ã‚’å…¥ã‚Œã¦ã¿ãŸã„ã€‚


---
## äº¤äº’ä½œç”¨ã®ç·´ç¿’: ãƒ¢ãƒ‡ãƒ«ä½œæˆã€ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°

Adelieã‚’åŸºæº–ã«ã€Chinstrapã®å‚¾ããŒçµæ§‹é•ã†ã€‚<br>
åˆ‡ç‰‡ã®é•ã„ã¯è§£é‡ˆã—ã«ãããªã£ãŸã€‚

```{r penguins-fit3}
fit3 = glm(flipper_length_mm ~ body_mass_g * species, data = penguins)
broom::tidy(fit3)
broom::glance(fit3)
```

---
## äº¤äº’ä½œç”¨ã®ç·´ç¿’: ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°çµæœã‚’ä½œå›³

```{r penguins-interaction, fig.height = 5, fig.width = 7, warning = FALSE}
added3 = modelr::add_predictions(penguins, fit3)
p3 = p_penweight_color +
  geom_line(aes(y = pred), data = added3, size = 1)
p3
```

---
## ã“ã“ã¾ã§ã®3ã¤ã®ãƒ¢ãƒ‡ãƒ«ã§ã©ã‚ŒãŒã„ã„ã‹ï¼Ÿ

AICã§é¸ã¶ãªã‚‰äº¤äº’ä½œç”¨å…¥ã‚Šé‡å›å¸°ã®ãŒè‰¯ã•ãã†ã€‚

```r
AIC(fit1, fit2, fit3)$AIC
```
```{r penguins-aic, echo = FALSE, fig.height = 4, fig.width = 11, warning = FALSE}
labels = sprintf("AIC = %.1f", AIC(fit1, fit2, fit3)$AIC)
cowplot::plot_grid(p1 + labs(title = labels[1]),
                   p2 + labs(title = labels[2]) + theme(legend.position = "none"),
                   p3 + labs(title = labels[3]) + theme(legend.position = "none"), nrow = 1L)
```


---
## GLMã®ç·´ç¿’

ğŸ”°ã‚¯ãƒãƒã‚·ã®é•·ã•ã¨æ·±ã•ã§åŒã˜è§£æã‚’ã‚„ã£ã¦ã¿ã‚ˆã†ã€‚

```{r penguins-bill, echo = FALSE, fig.height = 4, fig.width = 11, warning = FALSE}
p_bill = penguins %>%
  ggplot() + aes(bill_length_mm, bill_depth_mm) +
  geom_point(shape = 16, alpha = 0.66) +
  scale_color_manual(values = penguins_colors) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank())

fit1 = glm(bill_depth_mm ~ bill_length_mm, data = penguins)
fit2 = glm(bill_depth_mm ~ bill_length_mm + species, data = penguins)
fit3 = glm(bill_depth_mm ~ bill_length_mm + species + bill_length_mm:species, data = penguins)
p1 = p_bill +
  geom_line(aes(y = pred), data = modelr::add_predictions(penguins, fit1), size = 1, color = "#3366ff")
p2 = p_bill + aes(color = species) +
  geom_line(aes(y = pred), data = modelr::add_predictions(penguins, fit2), size = 1)
p3 = p_bill + aes(color = species) +
  geom_line(aes(y = pred), data = modelr::add_predictions(penguins, fit3), size = 1)
labels = sprintf("AIC = %.1f", AIC(fit1, fit2, fit3)$AIC)
cowplot::plot_grid(p1 + labs(title = labels[1]),
                   p2 + labs(title = labels[2]) + theme(legend.position = "none"),
                   p3 + labs(title = labels[3]) + theme(legend.position = "none"), nrow = 1L)
```

ğŸ”°ä½™è£•ãŒã‚ã£ãŸã‚‰æ€§åˆ¥ã‚„å¹´ãªã©ã‚‚èª¬æ˜å¤‰æ•°ã«å…¥ã‚Œã¦ã¿ã‚ˆã†ã€‚


---
## ç¢ºç‡åˆ†å¸ƒã¨ãƒªãƒ³ã‚¯é–¢æ•°ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã—ãŸã„

ä½•ã‚‚æŒ‡å®šã—ãªã„å ´åˆã¯æ­£è¦åˆ†å¸ƒãƒ»æ’ç­‰ãƒªãƒ³ã‚¯ã ã£ãŸ:
```{r glm-default-family}
formula = flipper_length_mm ~ body_mass_g
fit1 = glm(formula, data = penguins)
fit1$family
```

ã“ã†æ›¸ã„ãŸã®ã¨åŒã˜:
```r
glm(formula, data = penguins, family = gaussian(link = identity))
```

åˆ©ç”¨å¯èƒ½ãªç¢ºç‡åˆ†å¸ƒãƒªãƒ³ã‚¯é–¢æ•°ã¯ `?family` ãªã©ã‚’å‚ç…§ã€‚


---
## nå€‹ã®ã†ã¡yå€‹ç”Ÿå­˜ã€‚äºŒé …åˆ†å¸ƒã«å¾“......ã‚ãªã„ï¼

æ¤ç‰©100å€‹ä½“ã‹ã‚‰8å€‹ãšã¤ç¨®å­ã‚’å–ã£ã¦æ¤ãˆãŸã‚‰å…¨ä½“ã§åŠåˆ†ã¡ã‚‡ã„ç™ºèŠ½ã€‚<br>
è¦ª1å€‹ä½“ã‚ãŸã‚Šã®ç”Ÿå­˜æ•°ã¯<span style="color: #3366ff;">n=8ã®äºŒé …åˆ†å¸ƒ</span>ã«ãªã‚‹ã¯ãšã ã‘ã©ã€<br>
æ¥µç«¯ãªå€¤(å…¨éƒ¨æ­»äº¡ã€å…¨éƒ¨ç”Ÿå­˜)ãŒå¤šã‹ã£ãŸã€‚å€‹ä½“å·®ï¼Ÿ

```{r overdispersion, echo = FALSE, fig.height = 5, fig.width = 6, warning = FALSE}
ninds = 100L
mu_ind = 0.5
sd_ind = 3
df_od = tibble::tibble(
  z = rnorm(ninds, mu_ind, sd_ind),
  p = wtl::sigmoid(z),
  y = rbinom(ninds, 8L, p))
sum_y = sum(df_od$y)
p_hat = sum_y / 800
tidy_od = df_od %>%
  dplyr::count(y, name = "observed") %>%
  dplyr::mutate(expected = ninds * dbinom(y, 8, p_hat)) %>%
  tidyr::pivot_longer(!y, names_to = "key", values_to = "count") %>%
  dplyr::mutate(width = ifelse(key == "expected", 0.8, 0.4), alpha = ifelse(key == "expected", 0.5, 1))
# label = expression(hat(p) == paste(sprintf("%d/800 = %.2f", sum_y, p_hat)))
label = bquote(hat(p) == .(paste(sprintf("%d/800 = %.2f", sum_y, p_hat))))
tidy_od %>%
  ggplot() + aes(y, count) +
  geom_col(aes(fill = key, width = width, alpha = alpha), position = "identity") +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = label, color = "#3366ff", size = 6) +
  scale_alpha_identity() +
  scale_fill_manual(values = c(observed = "#333333", expected = "#3366ff")) +
  coord_cartesian(xlim = c(0, 8)) +
  labs(x = "# survived seeds") +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank(),
        legend.title = element_blank(), legend.position = "top")
```

ã‚‚ã£ã¨æŸ”è»Ÿã«ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã—ãŸã„

---
## ã¡ã‚‡ã£ã¨ãšã¤ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã‚’ç™ºå±•ã•ã›ã¦ã„ã

**ç·šå½¢ãƒ¢ãƒ‡ãƒ« LM** (å˜ç´”ãªç›´ç·šã‚ã¦ã¯ã‚)

<span style="color: #888888;">&nbsp; &nbsp; â†“ ã„ã‚ã‚“ãª<strong>ç¢ºç‡åˆ†å¸ƒ</strong>ã‚’æ‰±ã„ãŸã„</span>

**ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ« GLM**

<span style="color: #888888;">&nbsp; &nbsp; â†“ å€‹ä½“å·®ãªã©ã®å¤‰é‡åŠ¹æœã‚’æ‰±ã„ãŸã„</span>

**ä¸€èˆ¬åŒ–ç·šå½¢æ··åˆãƒ¢ãƒ‡ãƒ« GLMM**

<span style="color: #888888;">&nbsp; &nbsp; â†“ ã‚‚ã£ã¨è‡ªç”±ãªãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã‚’ï¼</span>

**éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ« HBM**

<cite>[ãƒ‡ãƒ¼ã‚¿è§£æã®ãŸã‚ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€](https://amzn.to/33suMIZ) ä¹…ä¿æ‹“å¼¥ 2012 ã‚ˆã‚Šæ”¹å¤‰</cite>



---
## çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€ã¾ã¨ã‚

- ä½•ã¯ã¨ã‚‚ã‚ã‚Œä½œå›³ã—ã¦ä¿¯ç°
- GLMã¯çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã®è€ƒãˆæ–¹ã®æ ¹å¹¹
    - ç¢ºç‡åˆ†å¸ƒãƒ»ãƒªãƒ³ã‚¯é–¢æ•°ãƒ»èª¬æ˜å¤‰æ•°
    - å°¤åº¦ãƒ»æœ€å°¤æ³•ã«ã‚ˆã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¨å®š
    - æƒ…å ±é‡åŸºæº–ãªã©ã«ã‚ˆã‚‹ãƒ¢ãƒ‡ãƒ«é¸æŠ
- ã‚ˆã‚ŠæŸ”è»Ÿãªãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã«ã¤ã„ã¦ä»Šå›ã¯çœç•¥
    - ä¸€èˆ¬åŒ–ç·šå½¢æ··åˆãƒ¢ãƒ‡ãƒ« (GLMM)
    - éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ« (HBM)
    - ãƒ•ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®éå»è³‡æ–™:
      [çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°æ¦‚è«– DSHC 2021](/slides/tokiomarine2021/)

---
## å‚è€ƒæ–‡çŒ®

- [ãƒ‡ãƒ¼ã‚¿è§£æã®ãŸã‚ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€](https://amzn.to/33suMIZ) ä¹…ä¿æ‹“å¼¥ 2012
- [Stanã¨Rã§ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°](https://amzn.to/3uwx7Pb) æ¾æµ¦å¥å¤ªéƒ 2016
- [Rã¨Stanã§ã¯ã˜ã‚ã‚‹ ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿åˆ†æå…¥é–€](https://amzn.to/3o1eCzP) é¦¬å ´çœŸå“‰ 2019
- [ãƒ‡ãƒ¼ã‚¿åˆ†æã®ãŸã‚ã®æ•°ç†ãƒ¢ãƒ‡ãƒ«å…¥é–€](https://amzn.to/3uCxTKo) æ±Ÿå´è²´è£• 2020
- [åˆ†æè€…ã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿è§£é‡ˆå­¦å…¥é–€](https://amzn.to/3uznzCK) æ±Ÿå´è²´è£• 2020
- [çµ±è¨ˆå­¦ã‚’å“²å­¦ã™ã‚‹](https://amzn.to/3ty80Kv) å¤§å¡šæ·³ 2020
- [ç§‘å­¦ã¨ãƒ¢ãƒ‡ãƒ«---ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å“²å­¦ å…¥é–€](https://amzn.to/2Q0f6JQ) Michael Weisberg 2017<br>
  (åŸè‘—: [Simulation and Similarity](https://amzn.to/3bdvhuI) 2013)
