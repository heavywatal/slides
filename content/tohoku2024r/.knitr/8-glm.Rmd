```{r, setup-common}
#| file: "setup.R"
#| echo: false
#| results: "asis"
```
```{r, setup-local}
#| include: false
#| cache: false
knitr::knit_exit()
```

---
## çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã®ãŠå“æ›¸ã

<figure style="float: right;">
<a href="https://kuboweb.github.io/-kubo/ce/IwanamiBook.html">
<img src="../tokiomarine2021/image/kubo-book.jpg" width="280" alt="ãƒ‡ãƒ¼ã‚¿è§£æã®ãŸã‚ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€ ä¹…ä¿æ‹“å¼¥ 2012">
</a>
</figure>

ä¹…ä¿å…ˆç”Ÿã®"ç·‘æœ¬"ã“ã¨<br>
ã€Œãƒ‡ãƒ¼ã‚¿è§£æã®ãŸã‚ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€ã€<br>
ã‚’ãƒ™ãƒ¼ã‚¹ã«å›å¸°åˆ†æã®æ¦‚è¦ã‚’ç´¹ä»‹ã€‚

1. ã‚¤ãƒ³ãƒˆãƒ­ [(#7 å‰å›)](7-distribution.html)
1. çµ±è¨ˆãƒ¢ãƒ‡ãƒ«ã®åŸºæœ¬
    - ç¢ºç‡å¤‰æ•°ãƒ»**ç¢ºç‡åˆ†å¸ƒ** ğŸ‘ˆ ä¸»å½¹
    - å°¤åº¦ãƒ»æœ€å°¤æ¨å®š
1. ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã€æ··åˆãƒ¢ãƒ‡ãƒ« [(#8 ä»Šå›)](8-glm.html)
1. <del>ãƒ™ã‚¤ã‚ºçµ±è¨ˆã€éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«</del> (ä»Šå›ã¯ã“ã“ã¾ã§ã‚„ã‚‰ãªã„)

å›å¸°ã®ã‚­ãƒ¢ã¯**ç·šã§ã¯ãªãåˆ†å¸ƒ**ã€‚

<hr>
<cite>

[Data Science Hill Climb 2021 (æ±äº¬æµ·ä¸Š) ã§ã®è¬›ç¾© (~6æ™‚é–“)](https://heavywatal.github.io/slides/tokiomarine2021/)
ã®æ¼”ç¿’ç„¡ã—æŠœç²‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (~2æ™‚é–“ x 2å›)ã€‚

</cite>


---
## ä½•ã§ã‚‚ã‹ã‚“ã§ã‚‚ç›´ç·šã‚ã¦ã¯ã‚ã§ã¯ã‚ˆã‚ã—ããªã„

<img `r src_alt_fig_chunk("glm-better")`>

- è¦³å¯Ÿãƒ‡ãƒ¼ã‚¿ã¯å¸¸ã«**æ­£ã®å€¤**ãªã®ã«äºˆæ¸¬ãŒè² ã«çªå…¥ã—ã¦ãªã„ï¼Ÿ
- **ç¸¦è»¸ã¯æ•´æ•°**ã€‚ã—ã‹ã‚‚ã®**ã°ã‚‰ã¤ã**ãŒæ¨ªè»¸ã«å¿œã˜ã¦å¤‰åŒ–ï¼Ÿ
- **ãƒ‡ãƒ¼ã‚¿ã«åˆã‚ã›ãŸçµ±è¨ˆãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã†ã¨ãƒã‚·**


---
## ã“ã“ã¾ã§è¦‹ã¦ããŸçµ±è¨ˆãƒ¢ãƒ‡ãƒ«

ç¢ºç‡å¤‰æ•°$X$ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿$\theta$ã®ç¢ºç‡åˆ†å¸ƒ$f$ã«â€œå¾“ã†â€:&nbsp;
$X \sim f(\theta) $

e.g., ã‚ã‚‹æ¤ç‰©ãŒä½œã‚‹ç¨®ã®æ•°$X$ã¯å¹³å‡å€¤$\lambda$ã®ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒã«å¾“ã†:

<div>\[\begin{split}
X \sim \text{Poisson}(\lambda)
\end{split}\]</div>

```{r, df-poisson-playback}
#| echo: false
set.seed(24601)
df_rpois = tibble::tibble(X = rpois(50L, 3))
max_x = 11L
df_dpois = tibble(X = seq(0, max_x), Prob = dpois(X, mean(df_rpois$X)))
```

```{r, only-dist}
#| echo: false
#| fig.height: 4
#| fig.width: 4
p_pois = ggplot(df_rpois) + aes(X) +
  geom_bar(aes(y = after_stat(prop)), width = 0.3) +
  geom_col(data = df_dpois, aes(y = Prob), alpha = 0.5, fill = "#56B4E9") +
  theme_bw(base_size = 18)
p_pois +
  theme(panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(), axis.ticks = element_blank())
```

ã“ã‚Œã‚’ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«(GLM)ã¨ã—ã¦è¦‹ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã€‚


---
## ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«(GLM)ã¨ã—ã¦è¨˜è¿°ã—ã¦ã¿ã‚‹

å€‹ä½“$i$ã®ç¨®å­æ•°$y_i$ã¯å¹³å‡å€¤$\lambda_i$ã®ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒã«å¾“ã†ã€‚<br>
å¹³å‡å€¤$\lambda_i$ã¯**ä»–ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‰ãš$\beta_0$ã§ä¸€å®š**ã€‚

<div>\[\begin{split}
y_i &\sim \text{Poisson}(\lambda_i) \\
\lambda_i &= \beta_0
\end{split}\]</div>

```{r, glm-without-x}
#| echo: false
#| fig.height: 4
#| fig.width: 4
p_pois +
  labs(x = "y") +
  coord_flip() +
  theme(panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(), axis.ticks = element_blank())
```

ç¨®å­æ•°ã‚’Yè»¸ã«ã—ã¦ã€å¼ã‚’2ã¤ã«åˆ†ã‘ãŸã ã‘...?<br>
**èª¬æ˜å¤‰æ•°**ã‚’å«ã‚€ãƒ¢ãƒ‡ãƒ«ã‚’è¦‹ã‚Œã°ã”åˆ©ç›ŠãŒåˆ†ã‹ã‚‹ã‹ã‚‚ã€‚

---
## èª¬æ˜å¤‰æ•°ãŒ1ã¤ã‚ã‚‹ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«

å€‹ä½“$i$ã®ç¨®å­æ•°$y_i$ã¯å¹³å‡å€¤$\lambda_i$ã®ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒã«å¾“ã†ã€‚<br>
å¹³å‡å€¤ã®å¯¾æ•°$\log(\lambda_i)$ã¯**ãã®å€‹ä½“ã®å¤§ãã•$x_i$ã«æ¯”ä¾‹**ã™ã‚‹ã€‚

<div class="column-container">
  <div class="column" style="flex-shrink: 1.0;">

<figure style="margin-block: 1em 0;">
<img src="../tokiomarine2021/glm.drawio.svg" width="600"><br>
</figure>

  </div>
  <div class="column" style="flex-shrink: 1.0;">

```{r, df-seeds}
#| include: false
#| cache.vars: ["df_seeds", "a", "b"]
set.seed(24601)
n = 300L
a = 3
b = -3
df_seeds = tibble::tibble(
  body_mass = runif(n, 0.4, 1.7),
  num_seeds = rpois(n, exp(a * body_mass + b))
) |>
  print()
```
```{r, glm-poisson}
#| echo: false
#| cache.vars: []
#| fig.height: 5
#| fig.width: 5
x_breaks = c(0.5, 1.0, 1.5)
df_ridges = tidyr::crossing(x = x_breaks, y = seq_len(30L) - 1L) |>
  dplyr::mutate(density = dpois(y, exp(a * x + b))) |>
  dplyr::filter(density > 1e-4)
df_bars = df_ridges |> wtl::ridges2bars(y, density)

p_pois = ggplot(df_seeds) + aes(body_mass, num_seeds) +
  geom_point(alpha = 0.5, shape = 16, size = 2) +
  scale_x_continuous(breaks = x_breaks) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank())

p_pois +
  stat_smooth(formula = y ~ x, method = glm, method.args = list(family = poisson), se = FALSE) +
  ggridges::geom_vridgeline(aes(x, y, width = density * 0.5, group = x),
    data = df_bars, fill = "#56B4E9AA", linetype = 0)
```

  </div>
</div>

ã“ã®å ´åˆã¯**å˜å›å¸°**ã€‚èª¬æ˜å¤‰æ•°ãŒè¤‡æ•°ã‚ã‚‹ã¨**é‡å›å¸°**ã€‚


---
## è¤‡æ•°ã®èª¬æ˜å¤‰æ•°ã‚’åŒæ™‚ã«æ‰±ã†é‡å›å¸°

<p>\[\begin{split}
y_i &\sim \text{Poisson}(\lambda_i) \\
\log(\lambda_i) &= \beta_0 + \beta_1 x_{1i} + \beta_2 x_{2i} + \ldots
\end{split}\]</p>

æ°—æ¸©ã‚‚æ¹¿åº¦ã‚‚é«˜ã„ã»ã©ãƒ“ãƒ¼ãƒ«ãŒå£²ã‚Œã‚‹æ¶ç©ºãƒ‡ãƒ¼ã‚¿:

```{r, df-beer}
#| include: false
#| cache.vars: "df_beer"
set.seed(24601)
n = 200L
true_coef = c(3, 0.05, 0.006)
df_beer = tibble::tibble(
  temperature = runif(n, 8, 32),
  humidity = runif(n, 20, 80),
  beer_sales = rpois(n, exp(true_coef[1] + true_coef[2] * temperature + true_coef[3] * humidity))
) |>
  print()
```
```{r, multiple-regression}
#| echo: false
#| cache.vars: []
#| fig.height: 5
#| fig.width: 10
glm_multi = glm(beer_sales ~ temperature + humidity, family = poisson, data = df_beer)

df_pred = tidyr::crossing(temperature = seq(8, 32, 2), humidity = seq(20, 80, 5)) |>
  modelr::add_predictions(glm_multi, type = "response")

p1 = ggplot(df_beer) + aes(temperature, beer_sales, color = humidity) +
  geom_line(data = df_pred, aes(y = pred, group = humidity), alpha = 0.7) +
  geom_point(alpha = 0.5) +
  scale_color_viridis_c(option = "cividis", direction = -1) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(),
        legend.position = c(0.01, 0.99), legend.justification = c(0, 1))
p2 = ggplot(df_beer) + aes(humidity, beer_sales, color = temperature) +
  geom_line(data = df_pred, aes(y = pred, group = temperature), alpha = 0.7) +
  geom_point(alpha = 0.5) +
  scale_color_viridis_c(option = "turbo") +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(),
        legend.position = c(0.01, 0.99), legend.justification = c(0, 1))

cowplot::plot_grid(p1, p2, nrow = 1L)
```

ã»ã‹ã®**ç¢ºç‡åˆ†å¸ƒ**ã¨**ãƒªãƒ³ã‚¯é–¢æ•°**ã‚’ä½¿ã†ä¾‹ã‚’è¦‹ã¦ã¿ã‚ˆã†ã€‚


---
## ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°

- ç¢ºç‡åˆ†å¸ƒ: **äºŒé …åˆ†å¸ƒ**
- ãƒªãƒ³ã‚¯é–¢æ•°: $\text{logit}(p) = \log \frac {p} {1 - p}$

ä½•ã‹ã®æˆå¦ã«å¯¾ã™ã‚‹ä½•ã‹ã®å› å­ã®å½±éŸ¿ã€ã¨ã‹

<div class="column-container">
  <div class="column" style="flex-shrink: 1.0; padding-top: 1rem;">

å®¢10äººä¸­$y_i$äººãŒãƒ“ãƒ¼ãƒ«ã‚’æ³¨æ–‡ã€‚<br>
ãã®æ—¥$i$ã®æ°—æ¸©$x_i$ã«ã‚ˆã£ã¦å‰²åˆãŒå¤‰åŒ–ã€‚

<p>\[\begin{split}
y_i &\sim \text{Binomial}(n,~p_i) \\
\text{logit}(p_i) &= \beta_0 + \beta_1 x_i \\
p_i &= \frac 1 {1 + e^{-(\beta_0 + \beta_1 x_i)}}
\end{split}\]</p>

ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯é–¢æ•°â†‘

  </div>
  <div class="column" style="flex-shrink: 1.0;">

```{r, df-logistic}
#| include: false
#| cache.vars: ["df_logistic", "n"]
set.seed(24601)
sigmoid = function(x, gain = 1) {1 / (1 + exp(-gain * x))}
nrep = 200L
n = 10L
df_logistic = tibble::tibble(
  x = runif(nrep, -10, 35),
  logit_p = -3 + 0.3 * x,
  p = sigmoid(logit_p),
  y = rbinom(nrep, n, p),
  response = matrix(c(y, n - y), ncol = 2)
) |>
  print()
```
```{r, glm-logistic}
#| echo: false
#| cache.vars: []
#| fig.height: 5
#| fig.width: 5
glm_logistic = glm(response ~ x, df_logistic, family = binomial)
df_pred = df_logistic |>
  modelr::add_predictions(glm_logistic, type = "response") |>
  dplyr::mutate(pred = n * pred)

coef = glm_logistic$coefficients

x_breaks = c(-10, 0, 10, 20, 30)
df_ridges = tidyr::crossing(x = x_breaks, y = seq.int(0, n)) |>
  dplyr::mutate(p = sigmoid(coef[1] + coef[2] * x), density = dbinom(y, n, p)) |>
  dplyr::filter(density > 1e-4)
df_bars = df_ridges |> wtl::ridges2bars(y, density)

ggplot(df_pred) + aes(x, y) +
  geom_point(alpha = 0.5, shape = 16) +
  ggridges::geom_vridgeline(data = df_bars, aes(width = density * 6, group = x), fill = "#56B4E9AA", linetype = 0) +
  geom_line(aes(y = pred), linewidth = 2, color = "#3366ff") +
  scale_x_continuous(breaks = x_breaks) +
  scale_y_continuous(breaks = seq.int(0, 10)) +
  labs(x = "temperature", y = "beer_sales") +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank(), panel.grid.major.y = element_blank())
```

  </div>
</div>

???
ãƒ­ã‚¸ãƒƒãƒˆ = å¯¾æ•°ã‚ªãƒƒã‚º
ã‚ªãƒƒã‚º = å¤±æ•—ã®ä½•å€æˆåŠŸã—ã‚„ã™ã„ã‹
XãŒ1å¢—ãˆã‚‹ã¨ã‚ªãƒƒã‚ºãŒe^aå€ã«å¢—ãˆã‚‹ã€‚


---
## ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸° (ç‹­ç¾©)

- ç¢ºç‡åˆ†å¸ƒ: **ãƒ™ãƒ«ãƒŒãƒ¼ã‚¤åˆ†å¸ƒ** ($n = 1$ ã®äºŒé …åˆ†å¸ƒ)
- ãƒªãƒ³ã‚¯é–¢æ•°: $\text{logit}(p) = \log \frac {p} {1 - p}$

ä½•ã‹ã®æˆå¦ã«å¯¾ã™ã‚‹ä½•ã‹ã®å› å­ã®å½±éŸ¿ã€ã¨ã‹

<div class="column-container">
  <div class="column" style="flex-shrink: 1.0; padding-top: 1rem;">

é¢¨ãŒå¹ã‘ã°æ¡¶å±‹ãŒå„²ã‹ã‚‹ã€‚

<p>\[\begin{split}
y_i &\sim \text{Bernoulli}(p_i) \\
  &= \text{Binomial}(1,~p_i) \\
\text{logit}(p_i) &= \beta_0 + \beta_1 x_i \\
p_i &= \frac 1 {1 + e^{-(\beta_0 + \beta_1 x_i)}}
\end{split}\]</p>

ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯é–¢æ•°â†‘

  </div>
  <div class="column" style="flex-shrink: 1.0;">

```{r, df-wind}
#| include: false
#| cache.vars: "df_wind"
set.seed(24601)
n = 200
df_wind = tibble::tibble(
  max_wind = runif(n, 0, 40),
  bucket_sales = rbinom(n, 1L, sigmoid(max_wind - 20, 0.2)) + 0L) |>
  print()
```
```{r, wind}
#| echo: false
#| cache.vars: []
#| fig.height: 4
#| fig.width: 5
glm_bernoulli = glm(bucket_sales ~ max_wind, df_wind, family = "binomial")

coef = glm_bernoulli$coefficients
x_breaks = c(0, 10, 20, 30, 40)
df_ridges = tidyr::crossing(x = x_breaks, y = c(0, 1)) |>
  dplyr::mutate(p = sigmoid(coef[1] + coef[2] * x), density = dbinom(y, 1, p)) |>
  dplyr::filter(density > 1e-4)
df_bars = df_ridges |> wtl::ridges2bars(y, density, width = 0.2)

df_wind |>
  modelr::add_predictions(glm_bernoulli, type = "response") |>
  ggplot() + aes(max_wind, bucket_sales) +
  geom_point(alpha = 0.3, shape = 124, size = 6) +
  ggridges::geom_vridgeline(aes(x, y, width = density * 6, group = x),
    data = df_bars, fill = "#56B4E9AA", linetype = 0) +
  geom_line(aes(y = pred), color = "#3366ff") +
  scale_y_continuous(breaks = c(0, 1)) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank(), panel.grid.major.y = element_blank())
```

  </div>
</div>


---
## ä¸€èˆ¬ç·šå½¢ãƒ¢ãƒ‡ãƒ« (â€œåŒ–â€ç„¡ã—) ã¯GLMã®ä¸€ç¨®

- ç¢ºç‡åˆ†å¸ƒ: **æ­£è¦åˆ†å¸ƒ**
- ãƒªãƒ³ã‚¯é–¢æ•°: **æ’ç­‰é–¢æ•°**(ãªã«ã‚‚ã›ãšãã®ã¾ã¾)

<div class="column-container">
  <div class="column" style="flex-shrink: 1.0; padding-top: 1rem;">

<p>\[\begin{split}
y_i &\sim \mathcal{N}(\mu_i,~\sigma^2) \\
\text{identity}(\mu_i) &= \beta_0 + \beta_1 x_i
\end{split}\]</p>

  </div>
  <div class="column" style="flex-shrink: 1.0;">

```{r, df-weight}
#| include: false
#| cache.vars: "df_weight"
set.seed(19937)
n = 50
df_weight = tibble::tibble(
  height = rnorm(n, 1.70, 0.05),
  bmi = rnorm(n, 22, 1),
  weight = bmi * (height**2)
) |>
  print()
```
```{r, glm-weight}
#| echo: false
#| cache.vars: []
#| fig.height: 4
#| fig.width: 4
fit = lm(weight ~ height, df_weight)
coef = coef(fit)

x_breaks = c(1.65, 1.7, 1.75)
df_ridges = tidyr::crossing(height = x_breaks, weight = seq(50, 80, 0.2)) |>
  dplyr::mutate(density = dnorm(weight, coef[1] + coef[2] * height, 1.8)) |>
  dplyr::filter(density > 1e-4)

ggplot(df_weight) + aes(height, weight) +
  geom_point(alpha = 0.5, shape = 16, size = 2) +
  ggridges::geom_vridgeline(aes(width = density * 0.08, group = height),
    data = df_ridges, fill = "#56B4E9AA", linetype = 0) +
  stat_smooth(method = lm, formula = y ~ x, se = FALSE) +
  scale_x_continuous(breaks = x_breaks) +
  theme_bw(base_size = 20) + theme(panel.grid.minor = element_blank(), panel.grid.major.y = element_blank())
```

  </div>
</div>

æœ€å°äºŒä¹—æ³•ã®ç›´ç·šã‚ã¦ã¯ã‚ã¨çµæœçš„ã«åŒã˜ã«ãªã‚‹ã€‚

<small style="color: #999999;">å˜å›å¸°ãƒ»é‡å›å¸°ã¨è¨€ã£ãŸã¨ãä¸€èˆ¬ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã‚’å‰æã¨ã™ã‚‹äººã‚‚ã„ã‚‹ã€‚</small>

---
## åˆ†æ•£åˆ†æ (<u>An</u>alysis <u>o</u>f <u>va</u>riance, ANOVA) as GLM

**è³ªçš„ãªèª¬æ˜å¤‰æ•°**ã‚’æŒã¤**æ­£è¦åˆ†å¸ƒãƒ»æ’ç­‰ãƒªãƒ³ã‚¯**ã®GLMã€ã¨è§£é‡ˆå¯èƒ½ã€‚<br>
<span title="ãƒ€ãƒŸãƒ¼å¤‰æ•°ã¨ã‚‚å‘¼ã°ã‚Œã‚‹">**æŒ‡ç¤ºå¤‰æ•°**</span> (0 or 1) ã«å¤‰æ›ã—ã¦ã‹ã‚‰é‡å›å¸°ã™ã‚‹ã€‚

<div class="column-container">
  <div class="column" style="flex-shrink: 1.0; padding-top: 1rem;">

| å¤©æ°— | â†’ | $x_1$ â˜€ï¸ æ™´ã‚Œ | $x_2$ â˜”ï¸ é›¨ |
| ---- | :-: | :---: | :---: |
| â˜ï¸ ãã‚‚ã‚Š | | 0 | 0 |
| â˜€ï¸ æ™´ã‚Œ | | 1 | 0 |
| â˜”ï¸ é›¨ | | 0 | 1 |

<p>\[\begin{split}
y_i &\sim \mathcal{N}(\mu_i,\sigma^2) \\
\mu_i &= \beta_0 + \beta_1 x_{1i} + \beta_2 x_{2i}
\end{split}\]</p>

  </div>
  <div class="column" style="flex-shrink: 1.3;">

```{r, df-ancova}
#| include: false
#| cache.vars: ["df_ancova", "weather_levels"]
set.seed(19937)
n = 200L
b = c(70, 3, 20, -20)  # true coef
weather_levels = c("sunny", "cloudy", "rainy")
df_ancova = tibble::tibble(
    temperature = runif(n, 8, 32),
    weather = factor(sample(weather_levels, n, TRUE), levels = weather_levels)
  ) |>
  dplyr::mutate(name = weather, value = 1L) |>
  tidyr::pivot_wider(values_fill = 0L) |>
  dplyr::select(!cloudy) |>
  dplyr::mutate(mu = b[1] + b[2] * temperature + b[3] * sunny + b[4] * rainy) |>
  dplyr::mutate(beer_sales = rnorm(n, mu, 10)
) |>
  print()
```

```{r, glm-anova}
#| echo: false
#| cache.vars: []
#| fig.height: 4.5
#| fig.width: 4.5
lm_anova = lm(beer_sales ~ weather, df_ancova)
df_ridges = tidyr::crossing(weather = factor(weather_levels, levels = weather_levels), beer_sales = seq(50, 200, 1)) |>
  modelr::add_predictions(lm_anova) |>
  dplyr::mutate(density = dnorm(beer_sales, pred, 10)) |>
  dplyr::filter(density > 1e-4)

tidy_anova = broom::tidy(lm_anova)

avgs = tidyr::crossing(weather = factor(weather_levels, levels = weather_levels)) |>
  modelr::add_predictions(lm_anova) |>
  tibble::deframe()

dfl = tibble::tribble(
  ~x, ~xend, ~y, ~yend,
  -Inf, Inf, avgs["cloudy"], avgs["cloudy"],
  1.5, 2.5, avgs["sunny"], avgs["sunny"],
  2.5, 3.5, avgs["rainy"], avgs["rainy"]
)

dfa = tibble::tribble(
  ~x, ~xend, ~y, ~yend,
  1.75, 1.75, avgs["cloudy"], avgs["sunny"],
  2.75, 2.75, avgs["cloudy"], avgs["rainy"]
)

dfs = tibble::tribble(
  ~x, ~y, ~label,
  0.6, avgs["cloudy"] + (avgs["sunny"] - avgs["cloudy"]) * 0.3, "beta[0]",
  1.55, (avgs["cloudy"] + avgs["sunny"]) / 2, "beta[1]",
  2.55, (avgs["cloudy"] + avgs["rainy"]) / 2, "beta[2]"
)

set.seed(1)
.arr = grid::arrow(length = grid::unit(0.1, "inches"))
df_ancova |>
  ggplot() + aes(weather, beer_sales, color = weather) +
  ggridges::geom_vridgeline(aes(width = density * 6, group = weather),
    data = df_ridges, fill = "#56B4E9AA", linetype = 0) +
  annotate("segment", x = dfl$x, xend = dfl$xend, y = dfl$y, yend = dfl$yend, color = "#56B4E9AA") +
  annotate("segment", x = dfa$x, xend = dfa$xend, y = dfa$y, yend = dfa$yend, arrow = .arr, color = "#56B4E9AA") +
  annotate("text", x = dfs$x, y = dfs$y, label = dfs$label, parse = TRUE, size = 6, color = "#56B4E9AA") +
  geom_jitter(width = 0.08, height = 0, alpha = 0.66, shape = 16, size = 3) +
  scale_color_viridis_d(direction = -1, guide = guide_legend(title = NULL)) +
  scale_x_discrete(limits = c("cloudy", "sunny", "rainy")) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), panel.grid.major.y = element_blank(),
        legend.position = "none")
```

  </div>
</div>

ãã‚‚ã‚Šâ˜ï¸ $\beta_0$ ã‚’åŸºæº–ã«ã€æ™´ã‚Œã®åŠ¹æœâ˜€ï¸ $\beta_1$ ã¨é›¨ã®åŠ¹æœâ˜”ï¸ $\beta_2$ ãŒæ±‚ã¾ã‚‹ã€‚

GLMãªã‚‰ç¢ºç‡åˆ†å¸ƒãƒ»ãƒªãƒ³ã‚¯é–¢æ•°ã‚’å¤‰ãˆã¦ã‚‚ã£ã¨æŸ”è»Ÿã«ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã§ãã‚‹ã€‚


---
## å…±åˆ†æ•£åˆ†æ (<u>An</u>alysis of <u>cova</u>riance, ANCOVA) as GLM

**è³ªçš„å¤‰æ•°ã¨é‡çš„å¤‰æ•°ã‚’ä¸¡æ–¹**å«ã‚€GLMã€ã¨è§£é‡ˆå¯èƒ½ã€‚<br>
æ­£è¦åˆ†å¸ƒãƒ»ç­‰åˆ†æ•£ãƒ»æ’ç­‰ãƒªãƒ³ã‚¯ãªã©ãŒä»®å®šã•ã‚Œã‚‹ã€‚


<div class="column-container">
  <div class="column" style="flex-shrink: 1.0; padding-top: 1rem;">

| å¤©æ°— | â†’ | $x_1$ â˜€ï¸ æ™´ã‚Œ | $x_2$ â˜”ï¸ é›¨ |
| ---- | :-: | :---: | :---: |
| â˜ï¸ ãã‚‚ã‚Š | | 0 | 0 |
| â˜€ï¸ æ™´ã‚Œ | | 1 | 0 |
| â˜”ï¸ é›¨ | | 0 | 1 |

<p>\[\begin{split}
y_i &\sim \mathcal{N}(\mu_i,\sigma^2) \\
\mu_i &= \beta_0 + \beta_1 x_{1i} + \beta_2 x_{2i} + \beta_3 x_{3i}
\end{split}\]</p>

  </div>
  <div class="column" style="flex-shrink: 1.3;">


```{r, glm-ancova}
#| echo: false
#| cache.vars: []
#| fig.height: 4.5
#| fig.width: 4.5
lm_ancova = lm(beer_sales ~ temperature + weather, df_ancova)
df_pred = tidyr::crossing(temperature = seq(8, 32, 2), weather = factor(weather_levels, levels = weather_levels)) |>
  modelr::add_predictions(lm_ancova, type = "response")

ggplot(df_ancova) + aes(temperature, beer_sales, color = weather) +
  geom_line(data = df_pred, aes(y = pred, group = weather), alpha = 0.7, linewidth = 2) +
  geom_point(alpha = 0.6, shape = 16, size = 3) +
  scale_color_viridis_d(direction = -1, guide = guide_legend(title = NULL)) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(),
        legend.position = c(0.01, 0.99), legend.justification = c(0, 1))
```

  </div>
</div>

GLMãªã‚‰ç¢ºç‡åˆ†å¸ƒãƒ»ãƒªãƒ³ã‚¯é–¢æ•°ã‚’å¤‰ãˆã¦ã‚‚ã£ã¨æŸ”è»Ÿã«ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã§ãã‚‹ã€‚


---
## äº¤äº’ä½œç”¨

ã‚ã‚‹èª¬æ˜å¤‰æ•°ã®åŠ¹æœãŒã€åˆ¥ã®èª¬æ˜å¤‰æ•°ã«ã‚ˆã£ã¦ç•°ãªã‚‹ã€‚<br>
e.g., ãƒ“ãƒ¼ãƒ«å£²ä¸Šã®æ¸©åº¦ä¾å­˜æ€§ãŒå¤©æ°—ã«ã‚ˆã£ã¦ç•°ãªã‚‹ã€‚

<div class="column-container">
  <div class="column" style="flex-shrink: 1.0; padding-top: 0.1rem;">

| å¤©æ°— | $x_1$ |
| ---- | :---: |
| â˜€ï¸ æ™´ã‚Œ | 1 |
| â˜”ï¸ é›¨ | 0 |

<p>\[\begin{split}
y_i &\sim \mathcal{N}(\mu_i,\sigma^2) \\
\mu_i &= \beta_0 + \beta_1 x_{1i} + \beta_2 x_{2i} + \beta_{1,2} x_{1i} x_{2i}
\end{split}\]</p>

é›¨ã®æ—¥ã¯ $x_{1i} = 0$ ã®ãŸã‚ $\beta_0,~\beta_2$ ã®é …ã ã‘ã€‚<br>
æ™´ã‚Œã®æ—¥ã¯ãã‚Œã«åŠ ãˆã¦ $\beta_1,~\beta_{1,2}$ ã®é …ã‚‚ã€‚

  </div>
  <div class="column" style="flex-shrink: 1.3;">

```{r, df-interact}
#| include: false
#| cache.vars: ["df_interact", "weather_levels"]
set.seed(19937)
n = 200L
b = c(70, 3, 100, -2)  # true coef
weather_levels = c("sunny", "rainy")
df_interact = tibble::tibble(
    temperature = runif(n, 8, 32),
    weather = factor(sample(weather_levels, n, TRUE), levels = weather_levels)
  ) |>
  dplyr::mutate(name = weather, value = 1L) |>
  tidyr::pivot_wider(values_fill = 0L) |>
  dplyr::mutate(mu = b[1] * sunny + b[2] * temperature + b[3] * rainy + b[4] * temperature * rainy) |>
  dplyr::mutate(beer_sales = rnorm(n, mu, 10)) |>
  print()
```
```{r, interaction}
#| echo: false
#| cache.vars: []
#| fig.height: 4.5
#| fig.width: 4.5
lm_int = lm(beer_sales ~ temperature * weather, df_interact)
df_pred = tidyr::crossing(temperature = seq(8, 32, 2), weather = factor(weather_levels, levels = weather_levels)) |>
  modelr::add_predictions(lm_int, type = "response")

ggplot(df_interact) + aes(temperature, beer_sales, color = weather) +
  geom_line(data = df_pred, aes(y = pred, group = weather), alpha = 0.7, linewidth = 2) +
  geom_point(alpha = 0.6, shape = 16, size = 3) +
  scale_color_viridis_d(direction = -1, guide = guide_legend(title = NULL)) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank(),
        legend.position = c(0.01, 0.99), legend.justification = c(0, 1))
```

  </div>
</div>


è§£é‡ˆãŒä¸€æ°—ã«é›£ã—ããªã‚‹ã®ã§ã‚€ã‚„ã¿ã«ä½¿ã‚ãªã„ã€‚



---
## ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«(GLM)ãµã‚Šã‹ãˆã‚Š

ç¢ºç‡åˆ†å¸ƒãƒ»ãƒªãƒ³ã‚¯é–¢æ•°ã‚’å¤‰ãˆã¦æŸ”è»Ÿã«ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã§ãã‚‹ã€‚<br>
ç‰¹å®šã®çµ„ã¿åˆã‚ã›ã«ã¯åå‰ãŒã‚ã‚‹ã€‚

| åå‰ | ç¢ºç‡åˆ†å¸ƒ | ãƒªãƒ³ã‚¯é–¢æ•° | èª¬æ˜å¤‰æ•° |
| ---- | -------- | -------- | -------- |
|ãƒã‚¢ã‚½ãƒ³å›å¸°|ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒ|log| |
|ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°|äºŒé …åˆ†å¸ƒ|logit| |
|ä¸€èˆ¬ç·šå½¢å›å¸°|æ­£è¦åˆ†å¸ƒ|æ’ç­‰| |
|åˆ†æ•£åˆ†æ|æ­£è¦åˆ†å¸ƒ|æ’ç­‰|è³ªçš„å¤‰æ•°|
|å…±åˆ†æ•£åˆ†æ|æ­£è¦åˆ†å¸ƒ|æ’ç­‰|è³ªçš„å¤‰æ•°+é‡çš„å¤‰æ•°|

ãƒªãƒ³ã‚¯é–¢æ•°ã‚’ã‚‚ã†å°‘ã—ã ã‘æ˜ã‚Šä¸‹ã’ãŸã„ã€‚


---
## ãƒªãƒ³ã‚¯é–¢æ•°

çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã«ãŠã„ã¦ã€Œã¾ã£ã™ãä»¥å¤–ã‚‚è¡¨ç¾ã§ãã‚‹ã€æ„å‘³

$\text{identity}(\mu_i)$
: $\mu_i = \beta_0 + \beta_1 x_{1i} + \beta_2 x_{2i} + \ldots$
: èª¬æ˜å¤‰æ•°ã®åŠ¹æœãŒ**è¶³ã—ç®—**çš„ã«åƒãã€‚

$\log(\lambda_i)$
: $\lambda_i = e^{\beta_0 + \beta_1 x_{1i} + \beta_2 x_{2i} + \ldots} = e^{\beta_0} \times e^{\beta_1 x_{1i}} \times e^{\beta_2 x_{2i}} \times \ldots$
: èª¬æ˜å¤‰æ•°ã®åŠ¹æœãŒ**æ›ã‘ç®—**çš„ã«åƒãã€‚<br>
  e.g., $\Delta x_1$ å¢—ãˆã‚‹ã¨ $e^{\beta_1 \Delta x_{1}}$ å€ã«ãªã‚‹

$\text{logit}(p_i)$
: $p_i = \frac 1 {1 + e^{-(\beta_0 + \beta_1 x_i + \ldots)}} $ (ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯é–¢æ•°)
: èª¬æ˜å¤‰æ•°ã®åŠ¹æœãŒ**é ­æ‰“ã¡**ã«ãªã‚‹ã€‚<br>
  e.g., $\lim_{x \to -\infty} p = 0;~\lim_{x \to \infty} p = 1$

ã»ã‹ã« `probit`, `inverse`, `sqrt`, etc.


---
## Rã«ãŠã‘ã‚‹GLMã®ã‚„ã‚Šã‹ãŸ

ç›´ç·šå›å¸°ã®ã¨ãã® `lm` ã¨ã»ã¼åŒã˜ã€‚

```{r, glm}
formula = weight ~ height
fit = glm(formula, data = df_weight)
coef(fit)
```

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ­£è¦åˆ†å¸ƒãƒ»æ’ç­‰ãƒªãƒ³ã‚¯ã§ `lm` ã¨åŒã˜çµæœã€‚<br>
`family=` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ç¢ºç‡åˆ†å¸ƒã¨ãƒªãƒ³ã‚¯é–¢æ•°ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š:
```r
glm(formula, family = gaussian(link = identity), data = mydata)
glm(formula, family = poisson(link = log), data = mydata)
glm(formula, family = binomial(link = logit), data = mydata)
```

See [`?family`](https://stat.ethz.ch/R-manual/R-patched/library/stats/html/family.html) for more details.


---
## ğŸ”° ã¨ã«ã‹ãGLMã‚’ä½¿ã£ã¦ã¿ã‚‹ç·´ç¿’

ã¨ã‚Šã‚ãˆãšå½“ã¦ã¯ã‚ã¨ä½œå›³ã ã‘ã€‚<br>
çµæœã®è§£é‡ˆã‚„ãƒ¢ãƒ‡ãƒ«ã®è©•ä¾¡ã¯ã“ã®å¾Œã€‚

```{r, generate-df-weight}
#| ref.label: "df-weight"
#| echo: -1
#| cache.vars: []
```

---
## ğŸ”° ã¨ã«ã‹ãGLMã‚’ä½¿ã£ã¦ã¿ã‚‹ç·´ç¿’ è§£ç­”ä¾‹

```{r, glm-df-weight}
#| fig.width: 4
#| fig.height: 4
fit_wh = glm(weight ~ height, family = gaussian(link = identity), data = df_weight)
coef(fit_wh)
df_fit_wh = modelr::add_predictions(df_weight, fit_wh, type = "response")
ggplot(df_fit_wh) +
  aes(height, weight) +
  geom_point() +
  geom_line(aes(y = pred), linewidth = 1, color = "#3366ff")
```

---
## ğŸ”° ãƒã‚¢ã‚½ãƒ³å›å¸°

```{r, generate-df-seeds}
#| ref.label: "df-seeds"
#| echo: -1
#| cache.vars: []
```

---
## ğŸ”° é‡å›å¸°

`pred` ã§å›å¸°ç·šã‚’å¼•ãã«ã¯ `add_predictions()` ã®ä½¿ã„æ–¹ã«å·¥å¤«ãŒå¿…è¦ã€‚<br>
ã¨ã‚Šã‚ãˆãš `geom_point()` ã§"å›å¸°ç‚¹ã€…"ã‚’è¡¨ç¤ºã—ã¦ã¿ã‚‹ã¨ã“ã¾ã§ã§å¯ã¨ã™ã‚‹ã€‚

```{r, generate-df-beer}
#| ref.label: "df-beer"
#| echo: -1
#| cache.vars: []
```

---
## ğŸ”° ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°

æ¬¡ãƒšãƒ¼ã‚¸ã«ãƒ’ãƒ³ãƒˆã€‚

```{r, generate-df-logistic}
#| ref.label: "df-logistic"
#| echo: -1
#| cache.vars: []
```

---
## ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ã®ãƒ’ãƒ³ãƒˆ

å·¦è¾ºã®å¿œç­”å¤‰æ•°ã«æŒ‡å®šã§ãã‚‹ã®ã¯ã ã„ãŸã„æ¬¡ã®2ç¨®é¡:
- æˆåŠŸã‚’1ã€å¤±æ•—ã‚’0ã§è¡¨ã™æ•´æ•°vector (ç‹­ç¾©ã®ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°)
- 1åˆ—ç›®ãŒæˆåŠŸå›æ•°ã€2åˆ—ç›®ãŒå¤±æ•—å›æ•°ã®æ•´æ•°matrix

ä»Šå›ã®å ´åˆã€æˆåŠŸå›æ•° `y` ã ã‘ã‚’formulaã«å…¥ã‚Œã‚‹ã¨æ€’ã‚‰ã‚Œã‚‹
```{r, logistic-error}
#| error: true
glm(y ~ x, df_logistic, family = binomial)
```
ã®ã§å¤±æ•—å›æ•°ã‚‚ãƒ¢ãƒ‡ãƒ«ã«å«ã‚€ã‚ˆã† `response ~ x` ã¨ã™ã‚‹ã€‚

(ä»Šå›ã®ã‚ˆã†ã«è©¦è¡Œå›æ•°ãŒ10å›å›ºå®šã˜ã‚ƒãªãã¦ã‚‚ä½¿ãˆã‚‹ã€ã¨ã„ã†ã“ã¨)


---
## ğŸ”° å…±åˆ†æ•£åˆ†æ: GLM with è³ªçš„å¤‰æ•° + é‡çš„å¤‰æ•°

ã¾ãšã¯weatherã ã‘ã§åˆ†æ•£åˆ†æã€æ¬¡ã«temperatureã‚’å…¥ã‚Œã¦å…±åˆ†æ•£åˆ†æã€‚

```{r, generate-df-ancova}
#| ref.label: "df-ancova"
#| echo: -1
#| cache.vars: []
```

---
## ğŸ”° äº¤äº’ä½œç”¨


```{r, generate-df-interact}
#| ref.label: "df-interact"
#| echo: -1
#| cache.vars: []
```

---
## ãƒ‡ãƒ¼ã‚¿ã¯ã²ã¨ã¤ã€ãƒ¢ãƒ‡ãƒ«ã¯ãŸãã•ã‚“

ã©ã†é¸ã¶ï¼Ÿ

1. ãƒ¡ã‚«ãƒ‹ã‚ºãƒ çš„ã«ç´å¾—ã§ãã‚‹ã‚‚ã®ã‚’é¸ã¶
    - ãƒã‚¢ã‚½ãƒ³éç¨‹ã®**ã‚«ã‚¦ãƒ³ãƒˆ**ãªã‚‰ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒã€**é–“éš”**ãªã‚‰ã‚¬ãƒ³ãƒåˆ†å¸ƒ
    - nå›ä¸­kå›ã®ã‚ˆã†ã«**å‰²åˆçš„ãªã‚«ã‚¦ãƒ³ãƒˆ**ãªã‚‰äºŒé …åˆ†å¸ƒ
1. ãƒ‡ãƒ¼ã‚¿ã‚’å¯è¦–åŒ–ã—ã¦ã¿ã¦ã€ãã‚Œã£ã½ã„å½¢ãƒ»æ€§è³ªã®ã‚‚ã®ã‚’é¸ã¶
    - **å·¦å³å¯¾ç§°ã®ã²ã¨å±±**ãªã‚‰ã¨ã‚Šã‚ãˆãšæ­£è¦åˆ†å¸ƒ
    - **è² ã®å€¤ã‚’å–ã‚‰ãªã„**ãªã‚‰ã‚¬ãƒ³ãƒåˆ†å¸ƒ
    - ç›´ç·šçš„ã‹ã€æŒ‡æ•°é–¢æ•°çš„ã‹ã€é ­æ‰“ã¡ã‹ã€ãªã©ãªã©

å®¢è¦³çš„ãªæŒ‡æ¨™ã‚‚ã»ã—ã„ã€‚<br>
ãƒ¢ãƒ‡ãƒ«ã®å°¤ã‚‚ã‚‰ã—ã•ã¨ã„ãˆã°...


---
## <ruby>å°¤<rt>ã‚†ã†</rt>åº¦</ruby> (likelihood)

**ã‚ã‚‹ãƒ¢ãƒ‡ãƒ«$M$ã®ä¸‹ã§ãã®ãƒ‡ãƒ¼ã‚¿$D$ãŒè¦³å¯Ÿã•ã‚Œã‚‹ç¢ºç‡**:<br>
$\text{Prob}(D \mid M)$

ãƒ‡ãƒ¼ã‚¿$D$ã‚’å›ºå®šã—ã€ãƒ¢ãƒ‡ãƒ«$M$ã®é–¢æ•°ã¨ã¿ãªã—ãŸã‚‚ã®ãŒ**å°¤åº¦é–¢æ•°**:<br>
$L(M \mid D)$

ãƒ¢ãƒ‡ãƒ«ã®æ§‹é€ ã‚‚å›ºå®šã—ã¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿$\theta$ã ã‘å‹•ã‹ã™å ´åˆã¯ã“ã†æ›¸ã:<br>
$L(\theta \mid D)$ or $L(\theta)$

**å¯¾æ•°å°¤åº¦** $\log L$ ã®å½¢ã«ã—ãŸã»ã†ãŒã„ã‚ã„ã‚ä¾¿åˆ©ã€‚

<hr>

å„ãƒ¢ãƒ‡ãƒ«ã§æœ€é©ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¢ã—ã¦ã€æ¯”è¼ƒ:<br>
$\log L^* (M_1) \text{ vs. } \log L^* (M_2) \text{ vs. } \log L^* (M_3) \ldots$

```{r, llf}
broom::glance(fit)
```

---
## ãŸã—ã‹ã«å°¤åº¦ã¯ã‚ã¦ã¯ã¾ã‚Šã®è‰¯ã•ã‚’è¡¨ã—ã¦ãã†

ã“ã®å ´åˆã¯ç›´ç·šå›å¸°ã‚ˆã‚Šã‚‚ãƒã‚¢ã‚½ãƒ³å›å¸°ãŒè‰¯ã•ãã†:

```{r, compare-loglik}
#| echo: false
#| fig.height: 5
#| fig.width: 9
models = setNames(nm = c("gaussian", "poisson")) |> purrr::map(~{
  glm(num_seeds ~ body_mass, family = .x, data = df_seeds)
})

x_breaks = c(0.5, 1.0, 1.5)
df_lm = tidyr::crossing(body_mass = x_breaks, num_seeds = seq(-5, 20, 0.1)) |>
  modelr::add_predictions(models[["gaussian"]], type = "response") |>
  dplyr::mutate(density = dnorm(num_seeds, pred, 1.4)) |>
  dplyr::filter(density > 1e-4)

p_pois = ggplot(df_seeds) + aes(body_mass, num_seeds) +
  ggridges::geom_vridgeline(data = df_lm, aes(width = density * 0.4, group = body_mass), linetype = 0, alpha = 0) +
  geom_point(alpha = 0.5, shape = 16, size = 2) +
  scale_x_continuous(breaks = x_breaks) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank())

label = sprintf("logLik = %.1f", broom::glance(models[["gaussian"]])$logLik)
p_lm = p_pois +
  labs(title = "gaussian, identity link") +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = label, color = "#3366ff", size = 8) +
  stat_smooth(formula = y ~ x, method = lm, se = FALSE) +
  ggridges::geom_vridgeline(aes(width = density * 0.4, group = body_mass),
    data = df_lm, fill = "#56B4E9AA", linetype = 0)
# p_lm

df_ridges = tidyr::crossing(body_mass = x_breaks, num_seeds = seq_len(30L) - 1L) |>
  modelr::add_predictions(models[["poisson"]], type = "response") |>
  dplyr::mutate(density = dpois(num_seeds, pred)) |>
  dplyr::filter(density > 1e-4)
df_bars = df_ridges |> wtl::ridges2bars(num_seeds, density)

label = sprintf("logLik = %.1f", broom::glance(models[["poisson"]])$logLik)
p_poisson = p_pois +
  labs(title = "poisson, log link") +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = label, color = "#3366ff", size = 8) +
  stat_smooth(formula = y ~ x, method = glm, method.args = list(family = poisson), se = FALSE) +
  ggridges::geom_vridgeline(aes(width = density * 0.5, group = body_mass),
    data = df_bars, fill = "#56B4E9AA", linetype = 0)
# p_poisson

cowplot::plot_grid(p_lm, p_poisson, nrow = 1L)
```

ã“ã®èª¿å­ã§ã€ã‚ˆã‚Šå°¤åº¦ã®é«˜ã„ãƒ¢ãƒ‡ãƒ«ã‚’æ¢ã—ã¦ã„ã‘ã°ã„ã„ã ã‚ã†ã‹ï¼Ÿ

---
## ã‚ã¦ã¯ã¾ã‚ŠãŒè‰¯ã‘ã‚Œã°ã„ã„ã£ã¦ã‚‚ã‚“ã§ã‚‚ãªã„

éå‰°é©åˆ / éå­¦ç¿’ / overfitting
: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¢—ã‚„ã›ã°**ç¾ãƒ‡ãƒ¼ã‚¿ã¸ã®**é©åˆåº¦ãƒ»å°¤åº¦ã‚’é«˜ãã§ãã‚‹ãŒã€<br>
  äºˆæ¸¬ãƒ»ç†è§£ã®å½¹ã«ã¯ç«‹ãŸãªããªã‚‹ã€‚

```{r, saturated-model}
#| echo: false
#| fig.height: 4
#| fig.width: 11
#| cache.vars: []
set.seed(19937)
n = 16L
true_coef = c(0.1, 0.2)
df_plant = tibble::tibble(
  x = runif(n, 7, 12.5),
  lambda = exp(true_coef[1] + true_coef[2] * x),
  y = rpois(n, lambda)
) |> tibble::rownames_to_column("id")

models = df_plant |> modelr::fit_with(glm, family = "poisson", modelr::formulas(~y,
  null = ~ 1,
  x = ~ x,
  saturated = ~ id
))
labels = setNames(sprintf("logLik = %.1f", purrr::map_dbl(models, logLik)), names(models))

p_plant = df_plant |>
  modelr::add_predictions(models$null, type = "response") |>
  ggplot() + aes(x, y) +
  geom_line(aes(y = pred), color = "#3366ff", linewidth = 2, alpha = 0.7) +
  geom_point(shape = 16, alpha = 0.6) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), legend.position = "none")

p_null = p_plant +
  labs(title = "null model") +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2,
    label = labels[["null"]], color = "#3366ff", size = 6)
p_x = p_plant %+% modelr::add_predictions(df_plant, models$x, type = "response") +
  labs(title = expression(y %~% beta[0] + beta[1] * x)) +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2,
    label = labels[["x"]], color = "#3366ff", size = 6)
p_saturated = p_plant %+% modelr::add_predictions(df_plant, models$saturated, type = "response") +
  labs(title = "saturated model") +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2,
    label = labels[["saturated"]], color = "#3366ff", size = 6)

cowplot::plot_grid(p_null, p_x, p_saturated, nrow = 1L)
```

**å¸°ç„¡ãƒ¢ãƒ‡ãƒ«**: èª¬æ˜å¤‰æ•°ãªã—ã€‚åˆ‡ç‰‡ã®ã¿ã€‚<br>
**é£½å’Œãƒ¢ãƒ‡ãƒ«**: ãƒ‡ãƒ¼ã‚¿ç‚¹ã®æ•° â‰¤ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ•°ã€‚â€œãƒ‡ãƒ¼ã‚¿èª­ã¿ä¸Šã’â€çš„ãƒ¢ãƒ‡ãƒ«


---
## ç„¡é§„ãªèª¬æ˜å¤‰æ•°ã‚’åŠ ãˆã¦ã‚‚å°¤åº¦ã¯ä¸ŠãŒã‚‹

ã‚ã‚‹æ¤ç‰©ãŒä½œã‚‹ç¨®ã®æ•° $y$ ã¯å€‹ä½“ã®ã‚µã‚¤ã‚º $x$ ã«å¿œã˜ã¦å¢—ãˆã‚‹ã€‚<br>
è¦³å¯Ÿæ™‚ã«ç€ã¦ãŸæœã®è‰² $x_2$ ã‚’è¿½åŠ ã™ã‚‹ã¨å°¤åº¦ãŒä¸ŠãŒã‚‹......?

```{r, many-models}
#| echo: false
#| fig.height: 7
#| fig.width: 7
#| cache.vars: ["df_plant", "models", "p_plant"]
set.seed(24601)
n = 120L
true_coef = c(1, 0.12, 0)
df_plant = tibble::tibble(
  x = runif(n, 7, 12.5),
  x2 = sample(c(FALSE, TRUE), n, replace = TRUE),
  lambda = exp(true_coef[1] + true_coef[2] * x + true_coef[3] * x2),
  y = rpois(n, lambda)
) |> tibble::rownames_to_column("id")

models = df_plant |> modelr::fit_with(glm, family = "poisson", modelr::formulas(~y,
  null = ~ 1,
  x = ~ x,
  x2 = ~ x2,
  both = ~ x + x2,
  saturated = ~ id
))
labels = setNames(sprintf("logLik = %.1f", purrr::map_dbl(models, logLik)), names(models))

p_plant = df_plant |>
  modelr::add_predictions(models$null, type = "response") |>
  ggplot() + aes(x, y) +
  geom_line(aes(y = pred), linewidth = 1.5, alpha = 0.6) +
  geom_point(shape = 16, alpha = 0.6) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), legend.position = "none")

p_null = p_plant +
  labs(title = "null model") +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = labels[["null"]], color = "#3366ff", size = 6)
p_x = p_plant %+% (df_plant |> modelr::add_predictions(models$x, type = "response")) +
  labs(title = expression(y %~% beta[0] + beta[1] * x)) +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = labels[["x"]], color = "#3366ff", size = 6)
p_x2 = p_plant %+% (df_plant |> modelr::add_predictions(models$x2, type = "response")) %+%
  aes(color = x2, group = x2) +
  labs(title = expression(y %~% beta[0] + beta[2] * x[2])) +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = labels[["x2"]], color = "#3366ff", size = 6)
p_both = p_plant %+% (df_plant |> modelr::add_predictions(models$both, type = "response")) %+%
  aes(color = x2, group = x2) +
  labs(title = expression(y %~% beta[0] + beta[1] * x + beta[2] * x[2])) +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = labels[["both"]], color = "#3366ff", size = 6)

cowplot::plot_grid(p_null, p_x, p_x2, p_both, nrow = 2L)
```



---
## AIC: èµ¤æ± æƒ…å ±é‡åŸºæº–

<p>\[\begin{split}
\text{AIC} = -2 (\log L^* - k) = -2 \log L^* + 2k
\end{split}\]</p>

- **AICãŒå°ã•ã„ã»ã©äºˆæ¸¬ç²¾åº¦ã®è‰¯ã„ãƒ¢ãƒ‡ãƒ«**ã€‚
    - å°¤åº¦ã¯ä¸Šã’ãŸã„ã€‚
    - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•° $k$ ãŒå¢—ãˆã‚‹ã¨ãƒšãƒŠãƒ«ãƒ†ã‚£ã€‚
- ã©ã®ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã™ã‚‹å½“ã¦ã¯ã¾ã‚Šã‚’ç›®æŒ‡ã™ã‹ã¨ã„ã†è¦³ç‚¹
    - ã€Œæ‰‹å…ƒã®ãƒ‡ãƒ¼ã‚¿ã€ã«å¯¾ã™ã‚‹å¯¾æ•°å°¤åº¦ã¯ $\log L^*$<br>
    - ã€ŒçœŸã®ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‹ã‚‰å‡ºã¦ãã‚‹æœªæ¥ã®ãƒ‡ãƒ¼ã‚¿ã€ã«å¯¾ã™ã‚‹<br>
      å¹³å‡å¯¾æ•°å°¤åº¦ã®æ¨å®šé‡ã¯ $(\log L^* - k)$<br>
      (Kullback--Leibleræƒ…å ±é‡ã‚’ä½¿ã£ã¦å°å‡ºã™ã‚‹ã‚‰ã—ã„)


```{r, print-llf}
#| ref.label: "llf"
```

???
https://www.slideshare.net/logics-of-blue/1-6aic


---
## ç„¡é§„ãªèª¬æ˜å¤‰æ•°ã®è¿½åŠ ã§AICå¢—åŠ 

ã‚ã‚‹æ¤ç‰©ãŒä½œã‚‹ç¨®ã®æ•° $y$ ã¯å€‹ä½“ã®ã‚µã‚¤ã‚º $x$ ã«å¿œã˜ã¦å¢—ãˆã‚‹ã€‚<br>
è¦³å¯Ÿæ™‚ã«ç€ã¦ãŸæœã®è‰² $x_2$ ã‚’è¿½åŠ ã—ãŸãƒ¢ãƒ‡ãƒ«ã¯AICãŒå¢—åŠ ã€‚

```{r, many-models-aic}
#| echo: false
#| fig.height: 7
#| fig.width: 7
labels = setNames(sprintf("AIC = %.1f", purrr::map_dbl(models, AIC)), names(models))
p_null = p_plant +
  labs(title = "null model") +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = labels[["null"]], color = "#3366ff", size = 6)
p_x = p_plant %+% (df_plant |> modelr::add_predictions(models$x, type = "response")) +
  labs(title = expression(y %~% beta[0] + beta[1] * x)) +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = labels[["x"]], color = "#3366ff", size = 6)
p_x2 = p_plant %+% (df_plant |> modelr::add_predictions(models$x2, type = "response")) %+%
  aes(color = x2, group = x2) +
  labs(title = expression(y %~% beta[0] + beta[2] * x[2])) +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = labels[["x2"]], color = "#3366ff", size = 6)
p_both = p_plant %+% (df_plant |> modelr::add_predictions(models$both, type = "response")) %+%
  aes(color = x2, group = x2) +
  labs(title = expression(y %~% beta[0] + beta[1] * x + beta[2] * x[2])) +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = labels[["both"]], color = "#3366ff", size = 6)
cowplot::plot_grid(p_null, p_x, p_x2, p_both, nrow = 2L)
```

---
## ã»ã‹ã®æƒ…å ±é‡åŸºæº–

- $\text{BIC} = -2 \log L^* + k \log n$
    - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•° $k$ ã§ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’ä»˜ã‘ã‚‹ã®ã¯AICã¨åŒã˜ã€‚
    - ãƒ‡ãƒ¼ã‚¿ã®è¦³æ¸¬æ•° $n$ ã«ä¾å­˜ã™ã‚‹ç‚¹ã§AICã¨ç•°ãªã‚‹ã€‚<br>
      æ„Ÿè¦šã¨ã—ã¦ã¯ã€ŒAICã¯ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã«ã‚ˆã‚‹ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒç„¡ã„ã€
    - (å‘¨è¾ºå°¤åº¦ã®æœ€å¤§åŒ–ã¨ã„ã†è¦³ç‚¹ã§å°å‡ºã™ã‚‹ã‚‰ã—ã„)
- [WAIC](http://watanabe-www.math.dis.titech.ac.jp/users/swatanab/waic2011.html),
  [WBIC](http://watanabe-www.math.dis.titech.ac.jp/users/swatanab/wbic2012.html)
    - AIC, BICã‚’ä¸€èˆ¬åŒ–ã—ã€åºƒãä½¿ãˆã‚‹ã‚ˆã†ã«ã—ãŸã‚‚ã®ã€‚
    - ç†æƒ³çš„ãªæ¡ä»¶ã§ã¯ãã‚Œãã‚ŒAIC, BICã¨ã»ã¼åŒã˜ã€‚<br>
      ãã†ã˜ã‚ƒãªã„å ´åˆ(ç¾å®Ÿçš„ã«ã¯å¸¸ã«)ã“ã¡ã‚‰ãŒå„ªä½ã€‚
    - WAICã¯äºˆæ¸¬ã®è‰¯ã•ã€WBICã¯çœŸã®ãƒ¢ãƒ‡ãƒ«ã¸ã®è¿‘ã•ã€ã‚’è¡¨ã™ã€‚


---
## ãƒ¢ãƒ‡ãƒ«é¸æŠã®å¿ƒæ§‹ãˆ

ã€Œæ­£ã—ã„ã€ã‚‚ã®ã‚’é¸ã¹ã‚‹ã‚ã‘ã§ã¯ãªã„ã€‚<br>
äºˆæ¸¬ãƒ»ç†è§£ã« useful ãªã‚‚ã®ã‚’ä½•ã‚‰ã‹ã®åŸºæº–ã§é¸ã¶ã ã‘ã€‚

> All models are wrong, but some are useful. --- George E. P. Box

<figure>
<img src="../tokiomarine2021/math-model.drawio.svg" width="900"><br>
<figcaption><cite>ã€Œãƒ‡ãƒ¼ã‚¿åˆ†æã®ãŸã‚ã®æ•°ç†ãƒ¢ãƒ‡ãƒ«å…¥é–€ã€æ±Ÿå´è²´è£• 2020 ã‚ˆã‚Šæ”¹å¤‰</cite></figcaption>
</figure>


---
## ç¾å®Ÿçš„ãªæ³¨æ„ç‚¹ãƒ»æ‚©ã¿ã©ã“ã‚

- å¤šé‡å…±ç·šæ€§(multicollinearity):
    - èª¬æ˜å¤‰æ•°åŒå£«ãŒå¼·ã„ç›¸é–¢é–¢ä¿‚ã«ã‚ã‚‹
- å¤‰æ•°å¤‰æ›:
    - æ°—å®‰ãã‚„ã‚‹ã¹ãã˜ã‚ƒãªã„ã‘ã©ã€å¯¾æ•°å¤‰æ›ãªã©ã—ã°ã—ã°æœ‰ç”¨
    - å‰²ã‚Šç®—ã—ãŸå€¤ã¯å±é™º
- äº¤äº’ä½œç”¨ã‚’å…¥ã‚Œã‚‹ã¨è§£é‡ˆãŒé›£ã—ããªã‚‹ã€‚


---
## ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«åº§å­¦ã¾ã¨ã‚

- ä½•ã¯ã¨ã‚‚ã‚ã‚Œæ•£å¸ƒå›³ã‚’æã
- é©åˆ‡ãªç¢ºç‡åˆ†å¸ƒãƒ»ãƒªãƒ³ã‚¯é–¢æ•°ãƒ»èª¬æ˜å¤‰æ•°ã‚’è€ƒãˆã‚‹
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æœ€å°¤æ¨å®šã™ã‚‹
- å°¤åº¦ã¯ã€Œæ‰‹å…ƒã®ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚ã¦ã¯ã¾ã‚Šã€
- ãƒ¢ãƒ‡ãƒ«ã‚’æ¯”è¼ƒã™ã‚‹ã¨ãã¯æƒ…å ±é‡åŸºæº–ã‚’å‚è€ƒã«ã™ã‚‹



---
## penguinsãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ

<a href="https://allisonhorst.github.io/palmerpenguins/">
<cite>https://allisonhorst.github.io/palmerpenguins/</cite><br>
<img src="/slides/image/rstats/lter_penguins.png" width="45%">
<img src="/slides/image/rstats/culmen_depth.png" width="45%">
</a>

```r
install.packages("palmerpenguins")
library(palmerpenguins)
penguins_colors = c(Adelie = "darkorange", Chinstrap = "purple", Gentoo = "cyan4")
print(penguins)
```
```{r, penguins}
#| include: false
withr::local_package("palmerpenguins")
penguins_colors = c(Adelie = "darkorange", Chinstrap = "purple", Gentoo = "cyan4")
```

---
## penguinsãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ

<a href="https://allisonhorst.github.io/palmerpenguins/">
<cite>https://allisonhorst.github.io/palmerpenguins/</cite><br>
<img src="/slides/image/rstats/lter_penguins.png" width="45%">
<img src="/slides/image/rstats/culmen_depth.png" width="45%">
</a>

```{r, penguins-print}
#| echo: false
print(penguins)
```

---
## æ¬ æå€¤ã®ã‚ã‚‹è¡Œã‚’å–ã‚Šé™¤ã„ã¦ãŠã

æ€§åˆ¥ã¯ã¨ã‚Šã‚ãˆãšä½¿ã‚ãªã„ã®ã§ã€ä½“é•·é–¢é€£ã ã‘ã§ã‚‚ã€‚

```{r, penguins-dropna}
penguins |> dplyr::filter(dplyr::if_any(everything(), is.na))
penguins_dropna = penguins |> tidyr::drop_na(body_mass_g)
dim(penguins_dropna)
```

---
## ğŸ”° penguinsã§GLMã®ç·´ç¿’

æ¬¡ã®èª²é¡Œã‚’è§£ã„ã¦ã¿ã‚ˆã†ã€‚<br>
(æ¬¡ãƒšãƒ¼ã‚¸ä»¥é™ã«è§£ç­”ã€‚ã¾ãšã¯è‡ªåŠ›ã§ã€‚)

1. `body_mass_g` ã‚’æ¨ªè»¸ã€ `flipper_length_mm` ã‚’ç¸¦è»¸ã«ã€ã¾ãšä½œå›³ã€‚
1. å˜å›å¸°ã—ã¦ã€åˆ‡ç‰‡ã¨å‚¾ãã‚’æ±‚ã‚ã‚‹ã€‚ãã—ã¦ä½œå›³ã€‚
1. `species` ã§è‰²åˆ†ã‘ã—ã¦ä½œå›³ã€‚
1. `species` ã‚‚èª¬æ˜å¤‰æ•°ã«åŠ ãˆã¦é‡å›å¸°ã—ã€åˆ‡ç‰‡ã¨å‚¾ãã‚’æ±‚ã‚ã‚‹ã€‚ãã—ã¦ä½œå›³ã€‚
1. ä½™è£•ãŒã‚ã‚Œã°ã€ã‚¯ãƒãƒã‚·ã®é•·ã•ã¨æ·±ã•ã‚’ç¸¦æ¨ªè»¸ã«ã—ã¦åŒæ§˜ã®è§£æã€‚


---
## å˜å›å¸°ã®ç·´ç¿’: 1. ã¾ãšä½œå›³

ã©ã†ã‚„ã‚‰ã€é‡ã„ãƒšãƒ³ã‚®ãƒ³ã»ã©ç¿¼é•·ã‚‚é•·ã„ã€‚

```{r, penguins-weight}
#| fig.height: 4.5
#| fig.width: 4.5
p_penweight = ggplot(penguins_dropna) +
  aes(body_mass_g, flipper_length_mm) +
  geom_point(shape = 16, alpha = 0.66) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank())
p_penweight
```


---
## å˜å›å¸°ã®ç·´ç¿’: 2. ãƒ¢ãƒ‡ãƒ«ä½œæˆã€ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°

ã¨ã‚Šã‚ãˆãšãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ­£è¦åˆ†å¸ƒãƒ»æ’ç­‰ãƒªãƒ³ã‚¯ã€‚
$y = 136.7 + 0.0153 x$

```{r, penguins-fit1}
fit1 = glm(flipper_length_mm ~ body_mass_g, data = penguins_dropna)
broom::tidy(fit1)
broom::glance(fit1)
```

---
## å˜å›å¸°ã®ç·´ç¿’: 3. ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°çµæœã‚’ä½œå›³

çµæœã¨ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰äºˆæ¸¬å€¤ã‚’ä½œã£ã¦å›å¸°ç·šã‚’å¼•ãã€‚

```{r, penguins-weight-glm}
#| fig.height: 5
#| fig.width: 5
added1 = modelr::add_predictions(penguins_dropna, fit1, type = "response")
p1 = p_penweight +
  geom_line(aes(y = pred), data = added1, linewidth = 1, color = "#3366ff")
p1
```

---
## é‡å›å¸°ã®ç·´ç¿’: 1. ã¾ãšä½œå›³

ç¨®ã«ã‚ˆã£ã¦è‰²åˆ†ã‘ã—ã¦ã¿ã‚‹ã¨ã€å‚¾å‘ã®é•ã„ãŒè¦‹ãˆã‚‹ã€‚

```{r, penguins-weight-sp}
#| fig.height: 5
#| fig.width: 7
p_penweight_color = p_penweight + aes(color = species) +
  scale_color_manual(values = penguins_colors)
p_penweight_color
```


---
## é‡å›å¸°ã®ç·´ç¿’: 2. ãƒ¢ãƒ‡ãƒ«ä½œæˆã€ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°

Adelieã‚’åŸºæº–ã«ã€Chinstrapã¨Gentooã¯ãã‚Œã‚ˆã‚Šé•·ã‚ã€‚<br>
ä½“é‡ã®åŠ¹æœã¯å˜å›å¸°ã®ã¨ã(0.0153)ã‚ˆã‚Šå°ã•ã„ã€‚

```{r, penguins-fit2}
fit2 = glm(flipper_length_mm ~ body_mass_g + species, data = penguins_dropna)
broom::tidy(fit2)
broom::glance(fit2)
```

---
## é‡å›å¸°ã®ç·´ç¿’: 3. ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°çµæœã‚’ä½œå›³

```{r, penguins-weight-sp-glm}
#| fig.height: 5
#| fig.width: 7
added2 = modelr::add_predictions(penguins_dropna, fit2, type = "response")
p2 = p_penweight_color +
  geom_line(aes(y = pred), data = added2, linewidth = 1)
p2
```

**å‚¾ã**ã‚‚ç¨®ã«ã‚ˆã£ã¦é•ã†ã‹ã‚‚ã€‚**äº¤äº’ä½œç”¨**ã‚’å…¥ã‚Œã¦ã¿ãŸã„ã€‚


---
## äº¤äº’ä½œç”¨ã®ç·´ç¿’: ãƒ¢ãƒ‡ãƒ«ä½œæˆã€ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°

Adelieã‚’åŸºæº–ã«ã€Chinstrapã®å‚¾ããŒçµæ§‹é•ã†ã€‚<br>
åˆ‡ç‰‡ã®é•ã„ã¯è§£é‡ˆã—ã«ãããªã£ãŸã€‚

```{r, penguins-fit3}
fit3 = glm(flipper_length_mm ~ body_mass_g * species, data = penguins_dropna)
broom::tidy(fit3)
broom::glance(fit3)
```

---
## äº¤äº’ä½œç”¨ã®ç·´ç¿’: ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°çµæœã‚’ä½œå›³

```{r, penguins-interaction}
#| fig.height: 5
#| fig.width: 7
added3 = modelr::add_predictions(penguins_dropna, fit3, type = "response")
p3 = p_penweight_color +
  geom_line(aes(y = pred), data = added3, linewidth = 1)
p3
```

---
## ã“ã“ã¾ã§ã®3ã¤ã®ãƒ¢ãƒ‡ãƒ«ã§ã©ã‚ŒãŒã„ã„ã‹ï¼Ÿ

AICã§é¸ã¶ãªã‚‰äº¤äº’ä½œç”¨å…¥ã‚Šé‡å›å¸°ãŒè‰¯ã•ãã†ã€‚

```{r, penguins-aic}
#| fig.height: 4
#| fig.width: 11
labels = sprintf("AIC = %.1f", AIC(fit1, fit2, fit3)$AIC)
cowplot::plot_grid(p1 + labs(title = labels[1]),
                   p2 + labs(title = labels[2]) + theme(legend.position = "none"),
                   p3 + labs(title = labels[3]) + theme(legend.position = "none"), nrow = 1L)
```


---
## ä½™è£•ãŒã‚ã£ãŸã‚‰è¿½åŠ ã®ç·´ç¿’

ğŸ”°ã‚¯ãƒãƒã‚·ã®é•·ã•ã¨æ·±ã•ã§åŒã˜è§£æã‚’ã‚„ã£ã¦ã¿ã‚ˆã†ã€‚

```{r, penguins-bill}
#| echo: false
#| fig.height: 4
#| fig.width: 11
#| cache.vars: [p_bill]
p_bill = penguins_dropna |>
  ggplot() + aes(bill_length_mm, bill_depth_mm) +
  geom_point(shape = 16, alpha = 0.66) +
  scale_color_manual(values = penguins_colors) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank())

fit1 = glm(bill_depth_mm ~ bill_length_mm, data = penguins_dropna)
fit2 = glm(bill_depth_mm ~ bill_length_mm + species, data = penguins_dropna)
fit3 = glm(bill_depth_mm ~ bill_length_mm + species + bill_length_mm:species, data = penguins_dropna)
d1 = modelr::add_predictions(penguins_dropna, fit1, type = "response")
d2 = modelr::add_predictions(penguins_dropna, fit2, type = "response")
d3 = modelr::add_predictions(penguins_dropna, fit3, type = "response")
p1 = p_bill + geom_line(aes(y = pred), d1, linewidth = 1, color = "#3366ff")
p2 = p_bill + aes(color = species) + geom_line(aes(y = pred), d2, linewidth = 1)
p3 = p_bill + aes(color = species) + geom_line(aes(y = pred), d3, linewidth = 1)
labels = sprintf("AIC = %.1f", AIC(fit1, fit2, fit3)$AIC)
cowplot::plot_grid(p1 + labs(title = labels[1]),
                   p2 + labs(title = labels[2]) + theme(legend.position = "none"),
                   p3 + labs(title = labels[3]) + theme(legend.position = "none"), nrow = 1L)
```

```{r, penguins-multiple}
#| echo: false
#| include: false
fit4 = glm(bill_depth_mm ~ bill_length_mm + sex, data = penguins)
broom::tidy(fit4)
broom::glance(fit4)
added4 = modelr::add_predictions(penguins, fit4)
p_bill + geom_line(aes(y = pred, color = sex), data = added4, linewidth = 1) +
  scale_color_discrete()
```


---
## ğŸ”° 4æ—¥ç›®ã®èª²é¡Œ2: æ¶ç©ºãƒ‡ãƒ¼ã‚¿ã§GLM

å®¿å±‹ã®ä¸»äººãŒå®¿æ³Šå®¢ã®å†’é™ºè€…ã«è©±ã‚’èã„ã¦ãƒ‡ãƒ¼ã‚¿ã‚’é›†ã‚ãŸã€‚<br>
å†’é™ºè€…ã®**ãƒ¬ãƒ™ãƒ«**ã€**è·æ¥­**ã€é€šã£ã¦ããŸ**ãƒ«ãƒ¼ãƒˆ**ã€é­”ç‰©ã¨ã®**é­é‡å›æ•°**ã€‚<br>
ã“ã‚Œã‚‰ã®å¤‰æ•°ã®é–“ã«ã€ãªã‚“ã‚‰ã‹ã®é–¢ä¿‚ã¯è¦‹ã‚‰ã‚Œã‚‹ã ã‚ã†ã‹ï¼Ÿ

[adventure.tsv](adventure.tsv)

```{r, adventure-data}
#| echo: false
set.seed(19937)
samplesize = 1000L
b0 = 0.7
b1 = 0.01
b2 = -0.5
b3 = 0.02
b12 = 0.03

dfraw = tibble::tibble(
  level = sample.int(50L, samplesize, replace = TRUE),
  is_mage = rbinom(samplesize, 1, 0.4),
  via_cave = rbinom(samplesize, 1, ifelse(is_mage, 0.5, 0.3)),
  lambda = exp(b0 + b1 * level + b2 * is_mage + b3 * via_cave + b12 * level * is_mage),
  encounter = rpois(samplesize, lambda)
)

dfout = dfraw |> dplyr::mutate(
    job = ifelse(is_mage, "mage", "fighter"),
    route = ifelse(via_cave, "cave", "field"),
    .before = encounter
  ) |>
  dplyr::select(!lambda & !is_mage & !via_cave)

readr::write_tsv(dfout, "../adventure.tsv") |> print()
```

```{r, adventure-analysis}
#| include: false
fit = glm(encounter ~ level + job + route + level:job, data = dfout, family = poisson)
summary(fit)
df_pred = modelr::add_predictions(dfout, fit, type = "response")

p_enc = ggplot(df_pred) +
  aes(level, encounter, color = job) +
  geom_point() +
  geom_line(aes(y = pred)) +
  facet_wrap(vars(route))

p_route = ggplot(df_pred) +
  aes(job, fill = job) +
  geom_bar() +
  facet_wrap(vars(route))
```

---
## ğŸ”° æœ€çµ‚èª²é¡Œ: ã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’æ‹¾ã£ã¦è§£æã—ã‚ˆã†ã€‚

- [e-Stat](https://www.e-stat.go.jp/): æ”¿åºœçµ±è¨ˆã®ç·åˆçª“å£
- [data.go.jp ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã‚µã‚¤ãƒˆ](https://www.data.go.jp/data/dataset?res_format=CSV): ä¸­å¤®çœåº
- [BODIKã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã‚µã‚¤ãƒˆ](https://odcs.bodik.jp/): åœ°æ–¹è‡ªæ²»ä½“
- [æ°—è±¡åº](https://www.data.jma.go.jp/gmd/risk/obsdl/index.php)
- [DATA.GOV](https://www.data.gov/): U.S. Governmentâ€™s open data
- ã»ã‹ã€ãªã‚“ã§ã‚‚èˆˆå‘³ã®ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿

ç™ºè¡¨ãƒ»ãƒ¬ãƒãƒ¼ãƒˆã®æ¡ä»¶
: æœ€ä½1æšã®å›³ã¨ã€ãã“ã«è‡³ã‚‹å‰å‡¦ç†ï¼‹å¯è¦–åŒ–ã®ã‚³ãƒ¼ãƒ‰ã€‚
: ã‚°ãƒ©ãƒ•ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹ã“ã¨ã‚’ä¸€è¨€ã€‚
: GLMã§å¤‰æ•°é–“ã®é–¢ä¿‚ã‚’è€ƒå¯Ÿã§ãã‚‹ã¨ãªãŠã‚ˆã—ã€‚

é€±æ˜ã‘ã«ç­å†…ã§è©±ã—åˆã£ã¦ãƒ™ã‚¹ãƒˆ2ã‚’é¸ã³ã€å…¨ä½“ã«å‘ã‘ã¦ç™ºè¡¨ã€‚


---
## ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã¾ã¨ã‚

- ä½•ã¯ã¨ã‚‚ã‚ã‚Œä½œå›³ã—ã¦ä¿¯ç°
- GLMã¯çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã®è€ƒãˆæ–¹ã®æ ¹å¹¹
    - ç¢ºç‡åˆ†å¸ƒãƒ»ãƒªãƒ³ã‚¯é–¢æ•°ãƒ»èª¬æ˜å¤‰æ•°
    - å°¤åº¦ãƒ»æœ€å°¤æ³•ã«ã‚ˆã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¨å®š
    - æƒ…å ±é‡åŸºæº–ãªã©ã«ã‚ˆã‚‹ãƒ¢ãƒ‡ãƒ«é¸æŠ












---
## ä»Šå›ã®ãŠå“æ›¸ã

âœ… ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã®å¿ƒå¾—
- é‡è‰¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€é›£ã—ã•
- è‡ªåˆ†ãŒä¸€æ¬¡ãƒ‡ãƒ¼ã‚¿ã‚’ä½œã‚‹ã¨ãã«æ°—ã‚’ã¤ã‘ã‚‹ã“ã¨

â¬œ ãƒ‡ãƒ¼ã‚¿è§£é‡ˆã®å¿ƒå¾— (ç†è«–ã‚„æ‰‹æ³•ã®è©³ç´°ã«ã¯è§¦ã‚Œãªã„)
- èª¤å·® (ãƒã‚¤ã‚¢ã‚¹ã€ã°ã‚‰ã¤ã)
- çµ±è¨ˆçš„ä»®èª¬æ¤œå®š
- å› æœé–¢ä¿‚ã¨ç›¸é–¢é–¢ä¿‚



---
## Garbage in, garbage out

ã©ã‚“ãªã«ç´ æ™´ã‚‰ã—ã„çµ±è¨ˆå‡¦ç†ã‚’ã—ã‚ˆã†ã¨ã‚‚ã€ãƒ‡ãƒ¼ã‚¿ãŒã‚´ãƒŸãªã‚‰çµè«–ã‚‚ã‚´ãƒŸã€‚

<figure>
<img src="../tohoku2022r/image/garbage-in-garbage-out.drawio.svg" width="1200">
</figure>

- ç›®çš„ã«å¿œã˜ã¦ã¡ã‚ƒã‚“ã¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¡ã‚‹ã“ã¨ãŒé‡è¦ï¼
- ä½•ãŒãƒ‡ãƒ¼ã‚¿ã‚’æ‚ªãã—ã¦ã—ã¾ã†ã®ã‹ã€è¦‹ã¦ã„ã“ã†


---
## è¦³æ¸¬ã«ã¯å¿…ãšä½•ã‚‰ã‹ã®æ­ªã¿ãŒã‚ã‚‹

ç¾è±¡ãƒ»æ¯é›†å›£ã®æ€§è³ªã‚’çŸ¥ã‚ŠãŸã„ã‘ã©ã€ãã®ã‚‚ã®ã¯æ¸¬ã‚Œãªã„ã€‚<br>
: è³ªçš„ãªå•é¡Œ â†’ æ¸¬ã‚Œã‚‹å´é¢ã ã‘æ¸¬ã‚‹ã—ã‹ãªã„
: é‡çš„ãªå•é¡Œ â†’ ä¸€éƒ¨ã®æ¨™æœ¬ã‚’æŠ½å‡ºã—ã¦æ¸¬ã‚‹ã—ã‹ãªã„

<figure>
<img src="../tohoku2022r/image/math-model-biased.drawio.svg" width="1080"><br>
<figcaption><cite>ã€Œãƒ‡ãƒ¼ã‚¿åˆ†æã®ãŸã‚ã®æ•°ç†ãƒ¢ãƒ‡ãƒ«å…¥é–€ã€æ±Ÿå´è²´è£• 2020 ã‚ˆã‚Šæ”¹å¤‰</cite></figcaption>
</figure>


---
## 2ç¨®é¡ã®èª¤å·®

ç³»çµ±çš„èª¤å·® systematic error / ãƒã‚¤ã‚¢ã‚¹ bias
: ä¸€å®šã®å‚¾å‘ã‚’ã‚‚ã£ã¦ç”Ÿã˜ã‚‹èª¤å·®ã€‚åŸå› ã‚’ç‰¹å®šã—ã¦å¯¾å‡¦ã€‚

å¶ç„¶èª¤å·® random error
: å¶ç„¶ç”Ÿã˜ã¦ã—ã¾ã†ã°ã‚‰ã¤ãã€‚è¨ˆæ¸¬ã‚’ç¹°ã‚Šè¿”ã—ã¦å¯¾å‡¦ã€‚

e.g., æœã‚’ç€ãŸã¾ã¾ä½“é‡æ¸¬å®šã‚’10å›ç¹°ã‚Šè¿”ã™ â†’ ã©ã‚Œã‚‚é•ã†å€¤

<figure>
<img src="../tohoku2022r/image/error-random-systematic.drawio.svg" width="640"><br>
<figcaption><cite>ã€Œåˆ†æè€…ã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿è§£é‡ˆå­¦å…¥é–€ã€æ±Ÿå´è²´è£• 2020 ã‚ˆã‚Šæ”¹å¤‰</cite></figcaption>
</figure>


---
## é¸æŠãƒã‚¤ã‚¢ã‚¹

<figure style="position: absolute; top: 40px; right: 40px;"><a href="https://en.wikipedia.org/wiki/Survivorship_bias">
<img src="/slides/image/free/Survivorship-bias.svg" width="400"><br>
<figcaption class="url">https://en.wikipedia.org/wiki/Survivorship_bias</figcaption>
</a></figure>

ãƒ‡ãƒ¼ã‚¿ã®æ¡ã‚Œã‹ãŸãŒçµæœã«å‚¾å‘ã‚’ã‚‚ãŸã‚‰ã—ã¦ã—ã¾ã†ã€‚

ç”Ÿå­˜(è€…)ãƒã‚¤ã‚¢ã‚¹
: ç”Ÿãæ®‹ã£ãŸã‚‚ã®ã ã‘ãŒãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦è¦³æ¸¬ã•ã‚Œã‚‹ã€‚
: å¸°é‚„ã—ãŸå¤šæ•°ã®æˆ¦é—˜æ©Ÿâœˆï¸âœˆï¸ã®æå‚·ã®åˆ†å¸ƒ(å³å›³)ã€‚<br>
  è¢«å¼¾ â†’ **<span style="color: #bb0000;">ç”Ÿé‚„ â†’ è¦³æ¸¬ã•ã‚Œã‚‹</span>**<br>
  è¢«å¼¾ â†’ **å¢œè½ â†’ è¦³æ¸¬ã•ã‚Œãªã„**<br>
  æå‚·ãŒè¦³å¯Ÿã•ã‚Œãªã‹ã£ãŸå ´æ‰€ã‚’ã‚€ã—ã‚è£œå¼·ã™ã¹ãã€‚

ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãƒã‚¤ã‚¢ã‚¹
: ã‚µãƒ³ãƒ—ãƒ«å¯¾è±¡ã‚’æ±ºã‚ãŸæ™‚ç‚¹ã§åã£ã¦ã„ã‚‹ã€‚
: ğŸ“é›»è©±ã§ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆèª¿æŸ» â†’
  é›»è©±æ©Ÿã‚’æŒã¦ã‚‹è£•ç¦ãªäººã€ãã®æ™‚é–“ã«é€šè©±ã§ãã‚‹äººã€
  çŸ¥ã‚‰ãªã„ç•ªå·ã‹ã‚‰ã§ã‚‚å‡ºã‚‹äººã€èª¿æŸ»ã—ã¦ã„ã‚‹æ–°èç¤¾ã«å…±æ„Ÿã—ã¦ã„ã‚‹äººã€‚

ğŸ”° ç”Ÿç‰©å­¦ç ”ç©¶ã«ãŠã‘ã‚‹é¸æŠãƒã‚¤ã‚¢ã‚¹ã«ã¯ã©ã†ã„ã†ã‚‚ã®ãŒã‚ã‚Šãã†ï¼Ÿ

---
## æ¸¬å®šåŸºæº–ã«é–¢ã™ã‚‹ãƒã‚¤ã‚¢ã‚¹ã®ä¾‹

åŸºæº–ãŒæƒã£ã¦ã„ãªã„
: å›½æ°‘1äººã‚ãŸã‚Šã®å¼è­·å£«æ•°ã‚’å›½éš›æ¯”è¼ƒã™ã‚‹ã¨æ—¥æœ¬ãŒå°‘ãªã„ã€‚<br>
  è«¸å¤–å›½ã§ã¯ç¨ç†å£«ã‚„å¸æ³•æ›¸å£«ã‚’å¼è­·å£«ã«å«ã‚ã¦é›†è¨ˆã—ã¦ã„ã‚‹ã€‚

åŸºæº–ãŒæ™‚é–“ã¨ã¨ã‚‚ã«å¤‰åŒ–
: è‡ªé–‰ç—‡ã¨è¨ºæ–­ã•ã‚ŒãŸå…ç«¥ã®æ•°ã¯**è¦‹ã‹ã‘ä¸Š**å¹´ã€…å¢—ãˆã¦ã„ã‚‹ã€‚<br>
  è¨ºæ–­åŸºæº–ã®å¤‰æ›´ã€ç—…æ°—ã®çŸ¥ååº¦å‘ä¸ŠãŒä¸»ãªåŸå› ã€‚<br>
  (è¦ªã®é«˜é½¢åŒ–ã®å¯„ä¸ã‚’ç¤ºå”†ã™ã‚‹ç ”ç©¶ã‚‚ã‚ã‚‹ã‚‰ã—ã„)

---
## ãƒ‡ãƒ¼ã‚¿ã®æ‰±ã„ã«èµ·å› ã™ã‚‹ãƒã‚¤ã‚¢ã‚¹

ãƒã‚§ãƒªãƒ¼ãƒ»ãƒ”ãƒƒã‚­ãƒ³ã‚° ğŸ’
: è‡ªåˆ†ã®ä»®èª¬ã¨çŸ›ç›¾ã™ã‚‹æƒ…å ±ã‚’ç„¡è¦–ã—ã€éƒ½åˆã®ã„ã„æƒ…å ±ã ã‘é›†ã‚ã‚‹ã“ã¨ã€‚
: [ç ”ç©¶æ´»å‹•ã«ãŠã‘ã‚‹3ã¤ã®ä¸æ­£](https://www.mext.go.jp/b_menu/shingi/gijyutu/gijyutu12/houkoku/attach/1334660.htm)ã®ã†ã¡**æ”¹ç«„**ã«ã‚ãŸã‚‹ã€‚

ç¢ºè¨¼ãƒã‚¤ã‚¢ã‚¹
: ç„¡æ„è­˜ã«ãƒã‚§ãƒªãƒ¼ãƒ»ãƒ”ãƒƒã‚­ãƒ³ã‚°ã—ã¦ã—ã¾ã†å¿ƒç†çš„å‚¾å‘ã€‚
: æ‚ªæ°—ãªãã‚„ã£ã¦ã—ã¾ã‚ãªã„ã‚ˆã†ã€è‡ªè¦šã‚’æŒã¤ã“ã¨ãŒå¤§äº‹ã€‚

è¡¨ã«æ•°å­—ã€è£ã«ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆãŒæ›¸ã„ã¦ã‚ã‚‹ã‚«ãƒ¼ãƒ‰ã€‚<br>
ã€Œå¶æ•°ã®è£ã¯å¿…ãšAã€ã¨ã„ã†æ³•å‰‡ãŒã‚ã‚‹ã‹ï¼Ÿã€<br>
ã“ã‚Œã‚’ç¢ºã‹ã‚ã‚‹ã«ã¯æ¬¡ã®4æšã®ã†ã¡ã©ã‚Œã‚’è£è¿”ã›ã°ã„ã„ã‹ï¼Ÿ

```{r, four-cards}
#| echo: false
#| fig.width: 6
#| fig.height: 2
n = 20
g = (1 + sqrt(5)) / 2
card = tibble::tibble(x = c(0, 1, 1, 0), y = c(0, 0, g, g))
dplyr::bind_rows(
  card |> dplyr::mutate(id = 0),
  card |> dplyr::mutate(id = 1, x = x + 1.1),
  card |> dplyr::mutate(id = 2, x = x + 2.2),
  card |> dplyr::mutate(id = 3, x = x + 3.3)
) |>
  ggplot() + aes(x, y) +
  geom_polygon(aes(group = id), fill = NA, color = "#333333") +
  scale_fill_identity() +
  annotate("text", x = c(0.5, 1.6, 2.7, 3.8), y = g / 2, label = c("1", "2", "A", "B"), size = 20) +
  coord_fixed() +
  theme_void()
```

???
è«–ç†å­¦çš„ãªæ­£è§£ã¯2, Bã€‚



---
## ãŸã¾ãŸã¾ç”Ÿã˜ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚‚æ„å‘³ã‚’è¦‹å‡ºã—ãŒã¡

å‰å¾Œå³å› æœã®èª¤è¬¬
: ãŸã¾ãŸã¾å‰å¾Œã§ç”Ÿã˜ãŸç¾è±¡ã«å› æœé–¢ä¿‚ãŒã‚ã‚‹ã¨æ€ã„ãŒã¡

ã‚®ãƒ£ãƒ³ãƒ–ãƒ©ãƒ¼ã®èª¤è¬¬
: Nå›ã‚‚é€£ç¶šã§è£ãŒå‡ºãŸã‚‰ã€æ¬¡ã¯è¡¨ãŒå‡ºã‚„ã™ã„ã¨æ€ã„ãŒã¡

```{r, random-pattern}
#| echo: false
#| fig.width: 4
#| fig.height: 4
set.seed(19937)
n = 20
tibble::tibble(x = runif(n), y = runif(n)) |>
  ggplot() + aes(x, y) +
  geom_point(shape = 16, size = 3, alpha = 0.66) +
  coord_fixed(xlim = c(0, 1), ylim = c(0, 1), expand = FALSE) +
  theme_minimal()
```

---
## ãƒ‡ãƒ¼ã‚¿è§£é‡ˆã«é–¢ã‚ã‚‹èªçŸ¥ãƒã‚¤ã‚¢ã‚¹

åˆ©ç”¨å¯èƒ½æ€§ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯
: æ€ã„æµ®ã‹ã³ã‚„ã™ã„ã‚‚ã®ã»ã©éå¤§è©•ä¾¡ã—ãŒã¡
: e.g., 1æ–‡å­—ç›®ãŒkã®å˜èªã€3æ–‡å­—ç›®ãŒkã®å˜èªã€å¤šã„ã®ã¯ã©ã£ã¡ï¼Ÿ

ä»£è¡¨æ€§ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯
: ã‚¹ãƒ†ãƒ¬ã‚ªã‚¿ã‚¤ãƒ—ã‚’éå¤§è©•ä¾¡ã—ãŒã¡
: e.g., ãƒªãƒ³ãƒ€ã¯31æ­³ã®ç‹¬èº«å¥³æ€§ã€‚ç‡ç›´ã§è¡æ˜ã€‚å¤§å­¦ã§ã¯å“²å­¦å°‚æ”»ã€‚
  äººç¨®å·®åˆ¥ã‚„ç¤¾ä¼šæ­£ç¾©ãªã©ã«æ·±ãé–¢å¿ƒã‚’æŒã¡ã€å­¦ç”Ÿæ™‚ä»£ã«ã¯åæ ¸ãƒ‡ãƒ¢ã«ã‚‚å‚åŠ ã€‚<br>
  ç¾åœ¨ã®ãƒªãƒ³ãƒ€ã¯æ¬¡ã®ã©ã¡ã‚‰ã§ã‚ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã‹ï¼Ÿ
  1. ãƒªãƒ³ãƒ€ã¯éŠ€è¡Œå“¡ã¨ã—ã¦åƒã„ã¦ã„ã‚‹ã€‚
  1. ãƒªãƒ³ãƒ€ã¯éŠ€è¡Œå“¡ã¨ã—ã¦åƒããªãŒã‚‰ã€ãƒ•ã‚§ãƒŸãƒ‹ã‚¹ãƒˆé‹å‹•ã«å‚åŠ ã—ã¦ã„ã‚‹ã€‚

èªçŸ¥ãƒã‚¤ã‚¢ã‚¹ãƒ»èª¤è¬¬ã¯ã»ã‹ã«ã‚‚ã„ã‚ã„ã‚ã‚ã‚‹ã€‚<br>
ãƒ‡ãƒ¼ã‚¿è§£æã¨ã¯é–¢ä¿‚ãªãã€çŸ¥ã£ã¦ãŠãã®ã¯æ‚ªããªã„ã€‚

???

https://lambtani.hatenablog.jp/entry/2017/05/18/032108



---
## å¶ç„¶èª¤å·®ã«ã‚ˆã‚‹ã°ã‚‰ã¤ãæ–¹ = ç¢ºç‡åˆ†å¸ƒ

æ¬¡å› [7. çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°1](7-distribution.html) ã§ã‚„ã‚Šã¾ã™ã€‚

èƒŒå¾Œã«ã‚ã‚‹ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã«ã‚ˆã£ã¦ã„ã‚ã‚“ãªå½¢ã«ãªã‚‹ã€‚

<iframe width="600" height="450" src="./7-distribution.html#/33"></iframe>


---
## åˆ†å¸ƒã‚’ç‰¹å¾´ã¥ã‘ã‚‹ä»£è¡¨å€¤ central tendency

<div class="column-container">
  <div class="column" style="flex-shrink: 1.6;">

å¹³å‡å€¤ mean
: å’Œã‚’è¦³å¯Ÿæ•°ã§å‰²ã‚‹

ä¸­å¤®å€¤ median
: é †ã«ä¸¦ã¹ã¦çœŸã‚“ä¸­

æœ€é »å€¤ mode
: æœ€ã‚‚é »åº¦ãŒé«˜ã„å€¤

  </div>
  <div class="column">
  <a href="https://www.mhlw.go.jp/toukei/list/20-21.html">
  <img src="../tohoku2022r/image/hist-income-japan-2019.png" width="100%" style="">
  <figcaption><cite>æ‰€å¾—é‡‘é¡éšç´šåˆ¥ä¸–å¸¯æ•°ã®é »åº¦åˆ†å¸ƒ åšç”ŸåŠ´åƒçœ å›½æ°‘ç”Ÿæ´»åŸºç¤èª¿æŸ» 2019</cite></figcaption>
  </a>
  </div>
</div>

ç›®çš„ã‚„çŠ¶æ³ã«å¿œã˜ã¦ä½¿ã„åˆ†ã‘ã‚ˆã†ã€‚

å¤–ã‚Œå€¤ã«å¯¾ã™ã‚‹å¿œç­”
: ã‚‚ã—ç·è³‡ç”£é¡20å…†å††ã®å¤§å¯Œè±ªãŒé³¥å–çœŒã«å¼•ã£è¶Šã—ã¦ããŸã‚‰<br>
  â†’ çœŒæ°‘ã®**å¹³å‡**è³‡ç”£ã¯4000ä¸‡å††ä¸Šæ˜‡ã€‚**ä¸­å¤®å€¤**ãƒ»**æœ€é »å€¤**ã¯ã»ã¼ãã®ã¾ã¾ã€‚

---
## ã°ã‚‰ã¤ãã‚’æ‰ãˆã‚‹è¨˜è¿°çµ±è¨ˆé‡

åˆ†æ•£ variance
: å¹³å‡å€¤ã‹ã‚‰ã®å·®ã®è‡ªä¹—ã®å¹³å‡ã€‚ $\frac 1 n \sum _i ^n (X_i - \bar X)^2$
: ã“ã‚Œã®å¹³æ–¹æ ¹ãŒ**æ¨™æº–åå·® (standard deviation)**ã€‚

Percentile, Quantile (å››åˆ†ä½)
: å°ã•ã„é †ã«ãªã‚‰ã¹ã¦ä¸Šä½ä½•%ã«ã‚ã‚‹ã‹ã€‚
: ä¸­å¤®å€¤ = 50th percentile = ç¬¬äºŒå››åˆ†ä½(Q2)

```{r, quantile}
#| fig.width: 10
#| fig.height: 4
#| echo: false
set.seed(24601)
df = tibble::tibble(x = rnorm(200)) |>
  dplyr::filter(abs(x) < 2) |>
  dplyr::mutate(x = x + 3)
probs = c(min = 0, Q1 = 0.25, Q2 = 0.5, Q3 = 0.75, max = 1)
dfq = df |>
  dplyr::reframe(x = quantile(x, probs)) |>
  dplyr::mutate(name = names(probs), percent = sprintf("%d%%", 100 * probs))

p_hist = ggplot(df) + aes(x) +
  geom_histogram(bins = 30) +
  theme_void()
built = ggplot_build(p_hist)
bdata = built$data[[1]]
xlim = bdata |> dplyr::select(xmin, xmax) |> range()
p_box = ggplot(df) + aes(x) +
  geom_boxplot() +
  geom_rug(sides = "t", length = unit(0.06, "npc"), alpha = 0.66) +
  geom_point(data = dfq, aes(y = -0.6), shape = 17, size = 4) +
  geom_text(data = dfq, aes(y = -0.75, label = name), size = 5) +
  geom_text(data = dfq, aes(y = -0.95, label = percent), size = 5) +
  coord_cartesian(xlim = xlim, ylim = c(-1.2, 0.5)) +
  theme_void()
cowplot::plot_grid(p_hist, p_box, ncol = 1L)
```



---
## è¨˜è¿°çµ±è¨ˆé‡ã«é ¼ã‚Šã™ããšåˆ†å¸ƒã‚’å¯è¦–åŒ–ã™ã‚‹

åŒã˜ãƒ‡ãƒ¼ã‚¿ã§ã‚‚è¦‹ã›æ–¹ã§å°è±¡ãƒ»æƒ…å ±é‡ãŒå¤‰ã‚ã‚‹ã€‚

```{r, visualize-distribution}
#| echo: false
#| fig.width: 9
#| fig.height: 6
df = mpg |> dplyr::mutate(y = hwy)
df_mean = df |> dplyr::summarize(y = mean(y))
p0 = ggplot(df) + aes(y = y) +
  theme_classic() +
  theme(axis.title = element_blank(), axis.text.x = element_blank(), axis.ticks = element_blank())

ylim = c(0, max(df$y))
coord_y = coord_cartesian(ylim = ylim)
coord_one = coord_cartesian(ylim = ylim, xlim = c(-1, 1))

pcol = p0 + aes(x = 0) +
  geom_col(data = df_mean, fill = "#999999") +
  stat_summary(fun.data = wtl::mean_sd, geom = "linerange")

set.seed(1)
cowplot::plot_grid(nrow = 2L,
  pcol + coord_one,
  p0 + geom_boxplot() + coord_one,
  p0 + geom_density(fill = "#999999", color = NA) + coord_y,
  p0 + geom_histogram(fill = "#999999", bins = 30L) + coord_y,
  p0 + geom_jitter(aes(x = 0), height = 0, shape = 16, alpha = 0.3, stroke = 0) + coord_one,
  p0 + geom_violin(aes(x = 0), fill = "#999999", color = NA) + coord_one,
  p0 + geom_dotplot(aes(x = 0), binaxis = "y", binwidth = 1, stackratio = 0.8,
    stroke = 0, alpha = 0.66, stackdir = "center") + coord_y,
  p0 + geom_dotplot(aes(x = 0), binaxis = "y", binwidth = 1, stackratio = 0.8,
    stroke = 0, alpha = 0.66) + coord_y
)
```


---
## 2ã¤ã®é‡ã®é–¢ä¿‚æ€§: å¤§å°ã®æ¯”è¼ƒ

ã°ã‚‰ã¤ãã®åº¦åˆã„ã‚‚åŠ å‘³ã—ã¦åˆ¤æ–­ã™ã‚‹ã€‚

<div class="column-container" style="padding-left: 10px;">
<div class="column" style="flex-shrink: 1.1;">
è¦³æ¸¬å€¤1ã¤ãšã¤ã€‚<br>
ãŸã¾ãŸã¾ã‹ã‚‚ã€‚
</div>
<div class="column" style="flex-shrink: 1;">
ã°ã‚‰ã¤ãå¤§ãã„ã€‚<br>
BãŒé«˜ã„ã®ã‚‚ãŸã¾ãŸã¾?
</div>
<div class="column" style="flex-shrink: 1;">
ã°ã‚‰ã¤ãå°ã•ã„ã€‚<br>
Aã¨Bã«ã¯å·®ãŒã‚ã‚Šãã†ã€‚
</div>
</div>

```{r, comparison}
#| fig.width: 11
#| fig.height: 4
#| echo: false
set.seed(19937)
n = 20
df1 = tibble::tibble(x = c("A", "B"), y = c(42, 51))
df2 = dplyr::bind_rows(
  tibble::tibble(x = "A", y = runif(n, 42 - 20, 42 + 20)),
  tibble::tibble(x = "B", y = runif(n, 51 - 20, 51 + 20)))
df3 = dplyr::bind_rows(
  tibble::tibble(x = "A", y = rnorm(n, 42, 1)),
  tibble::tibble(x = "B", y = rnorm(n, 51, 1)))
.lim = c(0, max(df2$y, df3$y))
.th = list(coord_cartesian(ylim = .lim),
  theme_classic(base_size = 20),
  theme(legend.position = "none", axis.title = element_blank()))

p1 = ggplot(df1) + aes(x, y, color = x) +
  geom_point(shape = 16, size = 5) +
  .th
p2 = ggplot(df2) + aes(x, y, color = x) +
  geom_jitter(height = 0, width = 0.2, shape = 16, size = 4, alpha = 0.66) +
  .th
cowplot::plot_grid(p1, p2, p2 %+% df3, nrow = 1)
```

ã€Œã“ã‚“ãªã“ã¨ãŒãŸã¾ãŸã¾èµ·ã“ã‚‹ç¢ºç‡ã¯ã™ã”ãä½ã„ã§ã™ï¼ã€<br>
ã‚’ã¡ã‚ƒã‚“ã¨ç¤ºã™æ‰‹ç¶šããŒ**çµ±è¨ˆçš„ä»®èª¬æ¤œå®š**â†’


---
## ç›®çš„ã‚„ãƒ‡ãƒ¼ã‚¿ã«å¿œã˜ã¦æ­£ã—ã„æ¤œå®šã‚’é¸ã¶

ä¾‹ãˆã°ã€Œ2ã¤ã®é‡ã®å¤§å°ã‚’æ¯”è¼ƒã—ãŸã„ã€ã ã‘ã§ã‚‚ã„ãã¤ã‹ã‚ã‚‹ã€‚<br>
ä»Šå›ã¯é¸å®šã«ã¯æ·±å…¥ã‚Šã›ãšã€æ¤œå®šã®è€ƒãˆæ–¹ã ã‘è§¦ã‚Œã¦ãŠãã€‚

<figure><a href="https://comicalcommet.github.io/r-training-2023/">
<img src="/slides/image/rstats/comicalcommet-test-chart.jpg" width="90%">
<figcaption><cite>
ã€ŒRã‚’ç”¨ã„ãŸãƒ‡ãƒ¼ã‚¿è§£æã®åŸºç¤ã¨å¿œç”¨ã€çŸ³å·ç”±å¸Œã•ã‚“@åå¤å±‹å¤§
</cite></figcaption>
</a></figure>


---
## çµ±è¨ˆçš„ä»®èª¬æ¤œå®šã®è€ƒãˆæ–¹

ğŸ²ã‚µã‚¤ã‚³ãƒ­ã‚’**10å›**æŒ¯ã£ãŸã‚‰**9å›**ã‚‚6ã®ç›®ãŒå‡ºãŸãã€‚ã‚¤ã‚«ã‚µãƒã˜ã‚ƒãªã„ã‹ï¼Ÿ

å¸°ç„¡ä»®èª¬
: 6ã®ç›®ãŒå‡ºã‚‹ç¢ºç‡ = 1/6ã€‚æ™®é€šã®ã‚µã‚¤ã‚³ãƒ­ã§ã™ã€‚

å¯¾ç«‹ä»®èª¬
: 6ã®ç›®ãŒå‡ºã‚‹ç¢ºç‡ â‰  1/6ã€‚ã‚¤ã‚«ã‚µãƒã§ã™ã€‚

<div>\[\begin{split}
p = \binom {10} {9} \times {\frac 1 6} ^ {9} \times {\frac 5 6} ^ 1 + {\frac 1 6} ^ {10}
  = 8.43 \times 10 ^ {-7}
\end{split}\]</div>

1. å¸°ç„¡ä»®èª¬ã®ã‚‚ã¨ã§ä»Šå›ã®ãƒ‡ãƒ¼ã‚¿ä»¥ä¸Šã«æ¥µç«¯ãªå€¤ãŒå¾—ã‚‰ã‚Œã‚‹ç¢ºç‡*p*ã‚’è¨ˆç®—
1. ã“ã® ***p*-value** ãŒ**æœ‰æ„æ°´æº–(å±é™ºç‡)**$\alpha$ã‚ˆã‚Šä½ã„å ´åˆã€å¸°ç„¡ä»®èª¬ã‚’æ£„å´<br>
   (å¤§æ¦‚ $\alpha$ = 0.05 ã¨ã‹ 0.01 ã¨ã‹ã€‚äºˆã‚æ±ºã‚ã¦ãŠãã€‚)
1. å¯¾ç«‹ä»®èª¬ã‚’æ¡æŠã€‚6ã®ç›®ã®å‡ºã‚‹ç¢ºç‡ã¯1/6ã¨**æœ‰æ„ã«ç•°ãªã‚‹**ã€‚

```{r, test-dice-hidden}
#| include: false
n = 10
k = 9
p = 1 / 6
pbinom(k - 1, n, p, lower.tail = FALSE)
x = seq(k, n)
stopifnot(all.equal(dbinom(x, n, p), choose(n, x) * p ** x * (1 - p) ** (n - x)))
stopifnot(all.equal(sum(dbinom(x, n, p)), pbinom(k - 1, n, p, lower.tail = FALSE)))
```

---
## çµ±è¨ˆçš„ä»®èª¬æ¤œå®šã®è€ƒãˆæ–¹

ğŸ²ã‚µã‚¤ã‚³ãƒ­ã‚’**12å›**æŒ¯ã£ãŸã‚‰**4å›**ã‚‚6ã®ç›®ãŒå‡ºãŸãã€‚<br>
ã“ã‚Œã‚‚1/6ã‚ˆã‚Šã¯é«˜ã„ã‘ã©ã€ã‚¤ã‚«ã‚µãƒã®ãƒ€ã‚¤ã‚¹ã‹ãªï¼Ÿ

<span style="color: #990000;">å¸°ç„¡ä»®èª¬ã®ã‚‚ã¨ã§12å›ä¸­4å›ä»¥ä¸Š6ãŒå‡ºã‚‹ç¢ºç‡: $p = 0.125 > \alpha$</span><br>

å¸°ç„¡ä»®èª¬ã‚’æ£„å´ã§ããšã€‚6ã®ç›®ã®å‡ºã‚‹ç¢ºç‡ãŒ1/6ã¨**æœ‰æ„ã«ç•°ãªã‚‹ã¨ã¯è¨€ãˆãªã„**ã€‚

```{r, test-dice}
#| echo: false
#| fig.height: 4
#| fig.width: 6
X = 4L
n = 12L
tibble::tibble(x = seq.int(0L, n), Probability = dbinom(x, n, 1 / 6)) |>
  dplyr::mutate(color = ifelse(x >= X, "#990000", "#666666")) |>
  ggplot() + aes(x, Probability, fill = color) +
  geom_col() +
  scale_fill_identity() +
  theme_classic(base_size = 20)
# pbinom(X - 1L, n, 1 / 6, lower.tail = FALSE)
# sum(dbinom(seq(X, n), n, 1 / 6))
```

å¹³ãŸãè¨€ãˆã°ã€Œæ™®é€šã®ã‚µã‚¤ã‚³ãƒ­ã§ã‚‚ãã‚“ãªã«çã—ã„å‡ºç›®ã˜ã‚ƒãªã„ã€


---
## å¤šé‡æ¤œå®šã§å½é™½æ€§ã®ãƒªã‚¹ã‚¯ãŒä¸Šæ˜‡

å±é™ºç‡$\alpha=0.05$ã®æ¤œå®šã¯ã€æœ€å¤§5%ã®ç¢ºç‡ã§èª¤ã£ã¦å¸°ç„¡ä»®èª¬ã‚’æ£„å´(**å½é™½æ€§**)ã€‚<br>
åŒæ§˜ã®æ¤œå®šã‚’10å›ã‚„ã‚‹ã¨ã€ãã®ã†ã¡å°‘ãªãã¨ã‚‚1ã¤ã§å½é™½æ€§ã«ãªã‚‹ç¢ºç‡ã¯<br>
$1 - (1 - 0.05)^{10} \approx 0.40$ ã¾ã§ä¸Šæ˜‡ã€‚<br>

```{r, multiple-tests}
#| fig.width: 11
#| fig.height: 4.2
#| echo: false
# 1 - (1 - 0.05) ** 10
set.seed(1279)
nsam = 10L
nrep = 20L
y = split(rnorm(nsam * nrep * 2), ceiling(seq_len(nsam * nrep * 2) / nsam))
df = tidyr::crossing(repl = seq_len(nrep), x = c("A", "B")) |>
  dplyr::mutate(y = y) |>
  tidyr::unnest(y)
dfp = df |>
  tidyr::nest(data = !repl) |>
  dplyr::mutate(p = purrr::map_dbl(data, ~ t.test(y ~ x, data = .x)$p.value)) |>
  dplyr::select(!data) |>
  dplyr::mutate(x = 1.5, y = Inf, label = ifelse(p < 0.05, sprintf("p = %.3f", p), ""))
df |>
  ggplot() + aes(x, y) +
  geom_boxplot(aes(fill = x)) +
  geom_text(data = dfp, aes(label = label), hjust = 0.5, vjust = 1.2) +
  facet_wrap(vars(repl), nrow = 2L) +
  theme_bw() +
  theme(legend.position = "none")
```

å¤šé‡æ¯”è¼ƒè£œæ­£
: æ¤œå®šã‚’ç¹°ã‚Šè¿”ã—ãŸã¶ã‚“ã ã‘åŸºæº–ã‚’å³ã—ãã—ã¦å½é™½æ€§ç‡ã‚’æŠ‘ãˆã‚‹ã“ã¨ã€‚
: Bonferroniæ³•ã€Holmæ³•ã€Benjamini and Hochbergæ³•ãªã©ã€‚


---
## åºƒãã¦æ·±ã„çµ±è¨ˆè§£æã®ä¸–ç•Œ

> ãƒ‡ãƒ¼ã‚¿ã®è’æ³¢ã‚’æ³³ããã£ã¦ã‚‚ã©ã“ã«ã‚‚ã€Œç©¶æ¥µã®çœŸå®Ÿã€ãªã©ã‚ã‚Šã¯ã—ãªã„ã®ã ã€‚
> çµ±è¨ˆå­¦ã¯ãã®ã¨ããã®å ´ã‹ãã‚Šã§ã®ã€Œæœ€è‰¯ã®çµè«–ã€ã‚’å°ããŸã‚ã®æ–¹ä¾¿ã«éããªã„ã®ã ã€‚
> ------ [ä¸‰ä¸­ä¿¡å®ã€Œçµ±è¨ˆæ€è€ƒã®ä¸–ç•Œã€](https://amzn.to/3urpls1)

<figure style="margin-top: -1em;">
<a href="http://leeswijzer.org/R/R-top.html">
<img src="/slides/image/rstats/Mandala2004-small.jpg" width="80%">
<figcaption><cite>ã€Œå¤§çµ±è¨ˆæ›¼è¼ç¾…ã€ä¸‰ä¸­ä¿¡å®</cite></figcaption>
</a>
</figure>




<!--  -->


---
## 2ã¤ã®é‡ã®é–¢ä¿‚æ€§: ç›¸é–¢é–¢ä¿‚ã¨å› æœé–¢ä¿‚

<style>
.spurious {color: #fde725;}
.correlation {color: #35B779;}
.causality-wrong {color: #31688e;}
.causality {color: #440154;}
</style>

<div class="column-container">
<div class="column" style="flex-shrink: 1;">

<span class="correlation">ç›¸é–¢é–¢ä¿‚</span>
: ã‚ã‚‹å€¤ãŒå¤§ãã„ã»ã©ã€åˆ¥ã®å€¤ã‚‚å¤§ãã„orå°ã•ã„ã€‚
: e.g., æ•°å­¦ã®æˆç¸¾ã¨ç‰©ç†ã®æˆç¸¾ã€‚

<span class="causality">å› æœé–¢ä¿‚</span>
: ã‚ã‚‹äº‹è±¡ãŒåˆ¥ã®äº‹è±¡ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ã€‚
: e.g., 1æ™‚é–“å‹‰å¼·ã™ã‚‹ã”ã¨ã«æˆç¸¾ãŒ3ç‚¹ä¼¸ã³ã‚‹ã€‚

</div>
<div class="column" style="flex-shrink: 1.8;">

```{r, causal-relationship}
#| echo: false
#| fig.width: 3.2
#| fig.height: 3.2
set.seed(19937)
n = 40L
tibble::tibble(
  study_time = runif(n, 0, 40),
  score = pmin(rnorm(n, 3 * study_time, 10), 100)) |>
  ggplot() +
  aes(study_time, score) +
  geom_point(shape = 16, alpha = 0.66, size = 3) +
  stat_smooth(method = lm, formula = y ~ x + 0, se = FALSE, color = "#440154", size = 2, alpha = 0.7) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_blank(), axis.ticks = element_blank())
```

</div>
</div>


<hr>

- <span class="causality">å› æœé–¢ä¿‚</span>ãŒã‚ã‚Œã°<span class="correlation">ç›¸é–¢é–¢ä¿‚</span>ã¨ã—ã¦è¡¨ã‚Œã‚‹
- **<span class="correlation">ç›¸é–¢é–¢ä¿‚</span>ãŒã‚ã‚‹ã‹ã‚‰ã¨ã„ã£ã¦<span class="causality">å› æœé–¢ä¿‚</span>ã‚‚ã‚ã‚‹ã¨ã¯é™ã‚‰ãªã„**â†’


---
## å› æœãƒ»ç›¸é–¢ã‚’è¦‹èª¤ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³1: äº¤çµ¡å› å­

**èª¤:** ğŸ¦ã‚¢ã‚¤ã‚¹ã®å£²ã‚Šä¸Šã’ãŒå¢—ãˆã‚‹ã»ã©ğŸºãƒ“ãƒ¼ãƒ«ã®å£²ã‚Šä¸Šã’ãŒå¢—ãˆã‚‹ã€‚

**æ­£:** ğŸ¦ã‚¢ã‚¤ã‚¹ã‚‚ğŸºãƒ“ãƒ¼ãƒ«ã‚‚**æ°—æ¸©ãŒé«˜ã„ã»ã©**å£²ã‚Œã‚‹ã€‚

<div class="column-container">
  <div class="column" style="flex-shrink: 1.2;">

```{r, confounding-factor}
#| echo: false
#| fig.width: 4
#| fig.height: 4
set.seed(19937)
n = 40L
tibble::tibble(
  temperature = runif(n, 0, 40),
  beer_sales = rpois(n, temperature * 1.3),
  icecream_sales = rpois(n, temperature)) |>
  ggplot() +
  aes(icecream_sales, beer_sales) +
  geom_point(shape = 16, alpha = 0.66, size = 3) +
  stat_smooth(method = lm, formula = y ~ x, se = FALSE, color = "#358779", size = 2, alpha = 0.7) +
  theme_classic(base_size = 20) +
  theme(axis.text = element_blank(), axis.ticks = element_blank())
```

</div>
<div class="column" style="flex-shrink: 1;">

<figure>
<img src="../tohoku2022r/image/hermeneutics-4-1-3.drawio.svg" width="750">
</figure>

</div>
</div>


---
## å› æœãƒ»ç›¸é–¢ã‚’è¦‹èª¤ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³2: é€†ã®å› æœé–¢ä¿‚

**èª¤:** <span class="causality-wrong">è­¦å¯Ÿå®˜ãŒå¤šã„ã»ã©çŠ¯ç½ªãŒå¢—ãˆã‚‹ã€‚</span>

**æ­£:** <span class="causality">çŠ¯ç½ªãŒå¤šã„ã‹ã‚‰è­¦å¯Ÿå®˜ãŒå¤šãé…å‚™ã•ã‚Œã‚‹ã€‚</span>

<br>

## å› æœãƒ»ç›¸é–¢ã‚’è¦‹èª¤ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³3: é¸æŠãƒã‚¤ã‚¢ã‚¹

(x + y) ãŒä¸€å®šã®å¹…ã«åã¾ã‚‹ã‚ˆã†ãªãƒšã‚¢ã ã‘ã‚’é›†ã‚ã¦ã—ã¾ã†ã¨ã‹

```{r, spurious-correlation-selection-bias}
#| echo: false
#| fig.width: 4
#| fig.height: 4
set.seed(19937)
n = 256
tibble::tibble(x = runif(n), y = runif(n)) |>
  dplyr::mutate(sampled = abs(x + y - 1) < 0.2) |>
  dplyr::mutate(color = ifelse(sampled, "#fde725", "#aaaaaa")) |>
  ggplot() +
  aes(x, y) +
  geom_point(aes(color = color), shape = 16, size = 3, alpha = 1) +
  scale_color_identity() +
  coord_fixed() +
  theme_classic(base_size = 20) +
  theme(axis.text = element_blank(), axis.ticks = element_blank())
```


---
## å› æœãƒ»ç›¸é–¢ã‚’è¦‹èª¤ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³4: å¤–ã‚Œå€¤ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—æ§‹é€ 

**å°‘æ•°ã®å¤–ã‚Œå€¤**ã‚„**ã‚°ãƒ«ãƒ¼ãƒ—æ§‹é€ **ã«ã‚ˆã£ã¦ç›¸é–¢ä¿‚æ•°rãŒè·³ã­ä¸ŠãŒã‚Šã†ã‚‹ã€‚

```{r, correlation-lies}
#| echo: false
#| fig.width: 11
#| fig.height: 3.6
set.seed(19937)
n = 32
df = tibble::tibble(x = rnorm(n), y = rnorm(n))
df_outlier = df |> dplyr::bind_rows(data.frame(x = 10, y = 10))
df_subgroups = df |> dplyr::bind_rows(df + 8)
.lim = range(df_outlier, df_subgroups)

.make_label_cor = function(df) {
  r = cor(df[["x"]], df[["y"]])
  sprintf("r = %.2f", r)
}
# .make_label_cor(df_usbb)

.plot_cor = function(df) {
  ggplot(df) + aes(x, y) +
    geom_point(shape = 16, size = 3, alpha = 0.66) +
    stat_smooth(method = lm, formula = y ~ x, se = FALSE, size = 3, color = "#fde725") +
    annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, size = 8, label = .make_label_cor(df)) +
    coord_fixed(xlim = .lim, ylim = .lim) +
    theme_classic(base_size = 20) +
    theme(axis.text = element_blank(), axis.ticks = element_blank())
}

cowplot::plot_grid(
  .plot_cor(df),
  .plot_cor(df_outlier),
  .plot_cor(df_subgroups),
  nrow = 1L
)
```


---
## å› æœãƒ»ç›¸é–¢ã‚’è¦‹èª¤ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³5: å¶ç„¶

ãƒ‹ã‚³ãƒ©ã‚¹ãƒ»ã‚±ã‚¤ã‚¸ã®æ˜ ç”»å‡ºæ¼”ãŒå¢—ãˆã‚‹ã»ã©æººæ­»ã™ã‚‹äººãŒå¢—ãˆã‚‹ï¼Ÿ

<figure>
<img src="../tohoku2022r/image/nicholas-cage-drowned.svg" width="1200">
<figcaption><cite>
<a href="https://www.tylervigen.com/spurious-correlations">https://www.tylervigen.com/spurious-correlations</a>
</cite></figcaption>
</figure>

ã“ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã«ã¯ã‚¸ãƒ§ãƒ¼ã‚¯ã¨ã—ã¦ã“ã†ã—ãŸä¾‹ãŒå¤šæ•°é›†ã‚ã‚‰ã‚Œã¦ã„ã‚‹â†‘


---
## å¤‰æ•°é–“ã®é–¢ä¿‚æ€§ã¾ã¨ã‚

<figure>
<img src="../tohoku2022r/image/hermeneutics-4-1-5.drawio.svg" width="1200">
<figcaption><cite>
<a href="https://amzn.to/3uznzCK">ã€Œåˆ†æè€…ã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿è§£é‡ˆå­¦å…¥é–€ã€æ±Ÿå´è²´è£• 2020</a>ã‚ˆã‚Šæ”¹å¤‰
</cite></figcaption>
</figure>

<hr>

- **<span class="correlation">ç›¸é–¢é–¢ä¿‚</span>ãŒã‚ã‚‹ã‹ã‚‰ã¨ã„ã£ã¦<span class="causality">å› æœé–¢ä¿‚</span>ã‚‚ã‚ã‚‹ã¨ã¯é™ã‚‰ãªã„**ã€‚
- <span class="causality-wrong">é€†ã®å› æœé–¢ä¿‚</span>ã‚„<span class="spurious">è¦‹ã›ã‹ã‘ã®ç›¸é–¢</span>ã«ã‚‚è¦æ³¨æ„ã€‚

ğŸ”° ã“ã‚Œã‚‰4ã¤ã®é–¢ä¿‚æ€§ã«è©²å½“ã™ã‚‹äº‹ä¾‹ã‚’ãã‚Œãã‚Œ1ã¤ä»¥ä¸Šæ¢ã—ã¦ã¿ã‚ˆã†ã€‚

???
16--17ä¸–ç´€ã€æ€ªæˆ‘ã‚’ã—ãŸã‚‰æ­¦å™¨ã«è»Ÿè†ã‚’å¡—ã‚‹ã¨æ—©ãæ²»ã‚‹ã¨ã„ã†è¿·ä¿¡ã€‚
è³ªã®ä½ã„è»Ÿè†ã‚’å‚·å£ã«å¡—ã‚‰ãªã„ã“ã¨ãŒãƒ—ãƒ©ã‚¹ã«åƒã„ãŸã¨ã„ã†ã®ãŒçœŸç›¸ã€‚



---
## ğŸ”° 3æ—¥ç›®ã®èª²é¡Œ2

æ›¸ç±ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚µã‚¤ãƒˆã€ãƒ–ãƒ­ã‚°è¨˜äº‹ãªã©ã‚’æ¤œç´¢ã—ã€<br>
**è‰¯ããªã„ãƒ‡ãƒ¼ã‚¿è§£æã®ä¾‹**ã‚’æ¢ã—ã¦**æ”¹å–„æ¡ˆ**ã‚’æŒ™ã’ã‚ˆã†ã€‚

1. ãƒ‡ãƒ¼ã‚¿ã®é›†ã‚æ–¹(ã‚µãƒ³ãƒ—ãƒ«ã®é¸ã³æ–¹)ãŒåã£ã¦ã„ã¦è‰¯ããªã„ä¾‹
1. ãƒ‡ãƒ¼ã‚¿ã®è§£é‡ˆ(ç›¸é–¢ã‚„å› æœ)ã‚’èª¤ã£ã¦ã„ã‚‹ä¾‹
1. å›³ã®æãæ–¹ã§å˜˜ã‚’ã¤ã„ã¦ã„ã‚‹ä¾‹ (èª‡å¼µã€å°è±¡æ“ä½œ)
1. ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’å…¬é–‹ã—ã¦ãã‚Œã‚‹ã®ã¯ã„ã„ã‘ã©å½¢å¼ãŒæ±šãã¦ä½¿ã„ã«ãã„ä¾‹

ãã‚Œãã‚Œã®ä¾‹ã«ã¤ã„ã¦ã€ä¸‹è¨˜ã®é …ç›®ã‚’å ±å‘Šã—ã¦ãã ã•ã„:

- å‡ºå…¸ã€‚URLã‚„æ›¸ç±åã€‚
- ãƒ‡ãƒ¼ã‚¿ã®æ¦‚è¦ã€æ›¸ãæ‰‹ã®ä¸»å¼µã€‚
- ã“ã“ãŒè‰¯ããªã„ã®ã§ã€ã“ã†æ”¹å–„ã™ã¹ãã€‚












---
## ä»Šæ—¥ã®æ®‹ã‚Šæ™‚é–“

- ç­ã‚„TAã«ç›¸è«‡ã—ã€æ¶ˆåŒ–ã—ãã‚Œãªã‹ã£ãŸéƒ¨åˆ†ã‚’ãªã‚‹ã¹ãè§£æ¶ˆã™ã‚‹ã€‚
- ã¾ãšã¯å€‹äººã§èª²é¡Œ1ã¨2ã«å–ã‚Šçµ„ã¿ã€ã‚ã‚‹ç¨‹åº¦ã§ããŸã‚‰ç­å†…ã§è¦‹ã›åˆã†ã€‚
- æœ€çµ‚èª²é¡Œã«å‘ã‘ã¦è©±ã—åˆã£ãŸã‚Šã€‚


---
## å‚è€ƒæ–‡çŒ®

- [ãƒ‡ãƒ¼ã‚¿è§£æã®ãŸã‚ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€](https://amzn.to/33suMIZ) ä¹…ä¿æ‹“å¼¥ 2012
- [ãƒ‡ãƒ¼ã‚¿åˆ†æã®ãŸã‚ã®æ•°ç†ãƒ¢ãƒ‡ãƒ«å…¥é–€](https://amzn.to/3uCxTKo) æ±Ÿå´è²´è£• 2020
- [åˆ†æè€…ã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿è§£é‡ˆå­¦å…¥é–€](https://amzn.to/3uznzCK) æ±Ÿå´è²´è£• 2020
- [çµ±è¨ˆå­¦ã‚’å“²å­¦ã™ã‚‹](https://amzn.to/3ty80Kv) å¤§å¡šæ·³ 2020
- [ç§‘å­¦ã¨ãƒ¢ãƒ‡ãƒ«---ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å“²å­¦ å…¥é–€](https://amzn.to/2Q0f6JQ) Michael Weisberg 2017<br>
  (åŸè‘—: [Simulation and Similarity](https://amzn.to/3bdvhuI) 2013)

`r .meta$next_link`
