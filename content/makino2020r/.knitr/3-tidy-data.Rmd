+++
url = "makino2020r/3-tidy-data.html"
title = "Tidying and transforming data with R â€” Hands-on R Lecture for Makino Lab"
linktitle = "Tidying and transforming data with R"
date = 2020-06-03T13:30:00+09:00
type = "reveal"
draft = false
+++

<link rel="stylesheet" href="style.css">

# [Hands-on Introduction to R 2020](.)

<div class="author">
å²©åµœ èˆª (Watal M. Iwasaki)
</div>

<div class="affiliation">
æ±åŒ—å¤§å­¦ ç”Ÿå‘½ç§‘å­¦ç ”ç©¶ç§‘ é€²åŒ–ã‚²ãƒãƒŸã‚¯ã‚¹åˆ†é‡
</div>

<ol start="0">
<li><a href="0-why-r.html">Why do we use R?</a>
<li><a href="1-basic-r.html">R basics</a>
<li><a href="2-ggplot.html">Visualization with R</a>
<li class="current-deck"><a href="3-tidy-data.html">Tidying and transforming data with R</a>
<li><a href="4-statistics.html">Statistical analysis with R</a>
</ol>

<div class="footnote">
è³‡æ–™ä½œæˆå”åŠ›: çŸ³å·ç”±å¸Œ (åå¤å±‹å¤§å­¦ ç†å­¦ç ”ç©¶ç§‘ è„³å›è·¯æ§‹é€ å­¦ è¬›å¸«)<br>
2020-06-03
</div>

```{r setup-global, include=FALSE, code=readLines("setup.R")}
```

```{r setup-local, include=FALSE}
library(ggplot2)
library(tibble)
library(dplyr)
library(tidyr)
library(purrr)
library(stringr)
library(readr)
library(forcats)
library(lubridate)
knitr::opts_chunk$set(cache = FALSE)
anscombe = tibble::as_tibble(anscombe)
```

---
## ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ãã ã•ã„

```r
update.packages()
```

Rã‚’å†èµ·å‹•ã—ã¦ã„ã¤ã‚‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸èª­ã¿è¾¼ã¿
```r
library(tidyverse)
```
```
â”€â”€ Attaching packages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tidyverse 1.3.0 â”€â”€
âœ” ggplot2 3.3.1     âœ” purrr   0.3.4
âœ” tibble  3.0.1     âœ” dplyr   1.0.0
âœ” tidyr   1.1.0     âœ” stringr 1.4.0
âœ” readr   1.3.1     âœ” forcats 0.5.0
â”€â”€ Conflicts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tidyverse_conflicts() â”€â”€
âœ– dplyr::filter() masks stats::filter()
âœ– dplyr::lag()    masks stats::lag()
```

æœ€è¿‘ã§ãŸ **dplyr â‰¥1.0.0** ã¨ **tidyr â‰¥1.1.0** ã‚’ä½¿ã†ã€‚


---
## ãƒ‡ãƒ¼ã‚¿è§£æã®ãŠãŠã¾ã‹ãªæµã‚Œ

1. ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ç’°å¢ƒã®æ•´å‚™
1. ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã€èª­ã¿è¾¼ã¿
1. æ¢ç´¢çš„ãƒ‡ãƒ¼ã‚¿è§£æ
    - **å‰å‡¦ç†ã€åŠ å·¥** (åœ°å‘³ã€‚æ„å¤–ã¨é‡ã„ã€‚ä»Šå›ã®ä¸»é¡Œ)
    - å¯è¦–åŒ–ã€ä»®èª¬ç”Ÿæˆ (æ´¾æ‰‹ï¼æ¥½ã—ã„ï¼[å‰å›ã®ä¸»é¡Œ](2-ggplot.html))
    - çµ±è¨ˆè§£æã€ä»®èª¬æ¤œè¨¼ (ã¿ã‚“ãªå‹‰å¼·ã—ãŸãŒã‚‹)
1. å ±å‘Šã€ç™ºè¡¨

<figure>
<a href="https://r4ds.had.co.nz/introduction.html">
<img src="/slides/image/r4ds/data-science.png">
<figcaption class="url">https://r4ds.had.co.nz/introduction.html</figcaption>
</a>
</figure>


---
## å¯è¦–åŒ–ã ã„ã˜ã€‚ã‚ã‹ã£ãŸã€‚

æƒ…å ±ã®æ•´ç† â†’ **æ­£ã—ã„è§£æãƒ»æ–°ã—ã„ç™ºè¦‹ãƒ»ä»®èª¬ç”Ÿæˆ**

<figure>
<a href="https://r4ds.had.co.nz/explore-intro.html">
<img src="/slides/image/r4ds/data-science-explore.png">
<figcaption class="url">https://r4ds.had.co.nz/explore-intro.html</figcaption>
</a>
</figure>

ã§ã‚‚**ãƒ‡ãƒ¼ã‚¿åˆ†æã«è²»ã‚„ã™åŠ´åŠ›ã®8å‰²ã¯å‰å‡¦ç†**ã‚‰ã—ã„ã‚ˆã€‚ã€‚ã€‚


---
## æ©Ÿæ¢°å‡¦ç†ã—ã‚„ã™ã„å½¢ vs äººãŒèª­ã¿æ›¸ãã—ã‚„ã™ã„å½¢

ä½œå›³ã‚„è§£æã«ä½¿ãˆã‚‹ãƒ‡ãƒ¼ã‚¿å½¢å¼ã¯ã»ã¼æ±ºã¾ã£ã¦ã‚‹
: `ggplot(data, ...)`, `glm(..., data, ...)`, ...

å‡ºç™ºç‚¹ã¨ãªã‚‹ãƒ‡ãƒ¼ã‚¿ã¯ã•ã¾ã–ã¾
: å®Ÿé¨“ãƒãƒ¼ãƒˆã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒãƒ¼ãƒˆã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€...

> Happy families are all alike;<br>
> every unhappy family is unhappy in its own way<br>
> --- Leo Tolstoy "Anna Karenina"

> tidy datasets are all alike,<br>
> but every messy dataset is messy in its own way<br>
> --- Hadley Wickham, creator of tidyverse


---
## æ•´ç„¶ãƒ‡ãƒ¼ã‚¿ tidy data

- **ç¸¦1åˆ—**ã¯1ã¤ã®**å¤‰æ•°**
- **æ¨ª1è¡Œ**ã¯1ã¤ã®**è¦³æ¸¬**
- **1ã‚»ãƒ«**ã¯1ã¤ã®**å€¤**

<cite style="display: block; text-align: right;">
<a class="url" href="https://r4ds.had.co.nz/tidy-data.html">https://r4ds.had.co.nz/tidy-data.html</a>
</cite>

```{r tidy_example}
print(diamonds)
```

---
## æ•´ç„¶ãƒ‡ãƒ¼ã‚¿ tidy data &nbsp; vs &nbsp; é›‘ç„¶ãƒ‡ãƒ¼ã‚¿ messy data

<div class="column-container">
  <div class="column" style="flex-shrink: 1.1;">
    <img src="/slides/image/fnshr/tidy-data-ex1.png" height="550" style="vertical-align: top;">
  </div>
  <div class="column">
    <img src="/slides/image/fnshr/messy-data-ex1.png" width="300" style="transform: translate(-14px, 0);">
    <div style="position: absolute; top: 440px;">
    ç¸¦1åˆ—ã¯1ã¤ã®å¤‰æ•°<br>
    æ¨ª1è¡Œã¯1ã¤ã®è¦³æ¸¬<br>
    1ã‚»ãƒ«ã¯1ã¤ã®å€¤<br>
    </div>
  </div>
</div>
<cite style="position: absolute; bottom: 18px; right: 24px;">
<a class="url" href="https://id.fnshr.info/2017/01/09/tidy-data-intro/">
è¥¿åŸå²æšã€Œæ•´ç„¶ãƒ‡ãƒ¼ã‚¿ã¨ã¯ä½•ã‹ã€https://id.fnshr.info/2017/01/09/tidy-data-intro/
</a>
</cite>

---
## æ•´ç„¶ãƒ‡ãƒ¼ã‚¿ tidy data &nbsp; vs &nbsp; é›‘ç„¶ãƒ‡ãƒ¼ã‚¿ messy data

<div class="column-container">
  <div class="column" style="flex-shrink: 1.1;">
    <img src="/slides/image/fnshr/tidy-data-ex1-var.png" height="580" style="vertical-align: top;">
  </div>
  <div class="column">
    <img src="/slides/image/fnshr/messy-data-ex1-var.png" width="420" style="transform: translate(-36px, -10px);">
    <div style="position: absolute; top: 440px;">
    <strong>ç¸¦1åˆ—ã¯1ã¤ã®å¤‰æ•°</strong><br>
    æ¨ª1è¡Œã¯1ã¤ã®è¦³æ¸¬<br>
    1ã‚»ãƒ«ã¯1ã¤ã®å€¤<br>
    </div>
  </div>
</div>
<cite style="position: absolute; bottom: 18px; right: 24px;">
<a class="url" href="https://id.fnshr.info/2017/01/09/tidy-data-intro/">
è¥¿åŸå²æšã€Œæ•´ç„¶ãƒ‡ãƒ¼ã‚¿ã¨ã¯ä½•ã‹ã€https://id.fnshr.info/2017/01/09/tidy-data-intro/
</a>
</cite>

---
## æ•´ç„¶ãƒ‡ãƒ¼ã‚¿ tidy data &nbsp; vs &nbsp; é›‘ç„¶ãƒ‡ãƒ¼ã‚¿ messy data

<div class="column-container">
  <div class="column" style="flex-shrink: 1.1;">
    <img src="/slides/image/fnshr/tidy-data-ex1-obs.png" height="530" style="vertical-align: top;">
  </div>
  <div class="column">
    <img src="/slides/image/fnshr/messy-data-ex1-obs.png" width="300" style="transform: translate(-24px, 0);">
    <div style="position: absolute; top: 440px;">
    ç¸¦1åˆ—ã¯1ã¤ã®å¤‰æ•°<br>
    <strong>æ¨ª1è¡Œã¯1ã¤ã®è¦³æ¸¬</strong><br>
    1ã‚»ãƒ«ã¯1ã¤ã®å€¤<br>
    </div>
  </div>
</div>
<cite style="position: absolute; bottom: 18px; right: 24px;">
<a class="url" href="https://id.fnshr.info/2017/01/09/tidy-data-intro/">
è¥¿åŸå²æšã€Œæ•´ç„¶ãƒ‡ãƒ¼ã‚¿ã¨ã¯ä½•ã‹ã€https://id.fnshr.info/2017/01/09/tidy-data-intro/
</a>
</cite>

---
## æ•´ç„¶ãƒ‡ãƒ¼ã‚¿ tidy data &nbsp; vs &nbsp; é›‘ç„¶ãƒ‡ãƒ¼ã‚¿ messy data

<div class="column-container">
  <div class="column" style="flex-shrink: 1.1;">
    <img src="/slides/image/fnshr/tidy-data-ex1-obs.png" height="530" style="vertical-align: top;">
  </div>
  <div class="column">
    <img src="/slides/image/fnshr/messy-data-ex1-val.png" width="300" style="transform: translate(-14px, 4px);">
    <div style="position: absolute; top: 440px;">
    ç¸¦1åˆ—ã¯1ã¤ã®å¤‰æ•°<br>
    æ¨ª1è¡Œã¯1ã¤ã®è¦³æ¸¬<br>
    <strong>1ã‚»ãƒ«ã¯1ã¤ã®å€¤</strong><br>
    </div>
  </div>
</div>
<cite style="position: absolute; bottom: 18px; right: 24px;">
<a class="url" href="https://id.fnshr.info/2017/01/09/tidy-data-intro/">
è¥¿åŸå²æšã€Œæ•´ç„¶ãƒ‡ãƒ¼ã‚¿ã¨ã¯ä½•ã‹ã€https://id.fnshr.info/2017/01/09/tidy-data-intro/
</a>
</cite>


---
## æ•´ç„¶ãƒ‡ãƒ¼ã‚¿ã®ã”åˆ©ç›Šã®ä¸€ä¾‹

xè»¸ã€yè»¸ã€è‰²åˆ†ã‘ã€ãƒ‘ãƒãƒ«åˆ†ã‘ãªã©ã‚’åˆ—ã®åå‰ã§æŒ‡å®šã—ã¦ç°¡å˜ä½œå›³:

```{r aes-map, fig.height=6, fig.width=9}
ggplot(diamonds) + aes(x = carat, y = price) +
  geom_point(mapping = aes(color = color, size = clarity)) +
  facet_wrap(~ cut)
```


---
## ç›®æ¨™: ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’ä¸‹ã”ã—ã‚‰ãˆã—ã¦é£Ÿã¹ã‚„ã™ã„å½¢ã«

```{r messy_example}
VADeaths
```

â†“ ä¸‹ã”ã—ã‚‰ãˆ: ä½œå›³ãƒ»è§£æã§ä½¿ã„ã‚„ã™ã„æ•´ç„¶ãƒ‡ãƒ¼ã‚¿ã«

```{r tidy_vadeaths, echo=FALSE}
VADeaths %>%
  as.data.frame() %>%
  rownames_to_column("age") %>%
  pivot_longer(-age, names_to = c("region", "sex"), names_sep = " ", values_to = "death") %>%
  separate(age, c("lbound", "ubound"), convert = TRUE)
```


---
## å‰å‡¦ç†ã¯å¤§ãã2ã¤ã«åˆ†ã‘ã‚‰ã‚Œã‚‹

- **ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å¯¾è±¡ã¨ã™ã‚‹å‡¦ç†** ğŸ‘ˆ
    - ä½¿ã„ãŸã„éƒ¨åˆ†ã ã‘æŠ½å‡º
    - ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ç‰¹å¾´ã‚’è¦ç´„
    - å¤§ãã„é †ã«ä¸¦ã¹æ›¿ãˆ
    - ç•°ãªã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã®çµåˆ
    - å¤‰å½¢: ç¸¦é•· â†” æ¨ªåºƒ
- ãƒ‡ãƒ¼ã‚¿å†…å®¹ã‚’å¯¾è±¡ã¨ã™ã‚‹å‡¦ç†
    - æ•°å€¤ã‚’å¤‰æ›ã™ã‚‹ (e.g., å¯¾æ•°ã€åº§æ¨™ç³»)
    - å¤‰æ›: é€£ç¶šå¤‰æ•° â†” ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ«å¤‰æ•° â†” ãƒ€ãƒŸãƒ¼å¤‰æ•°
    - å¤–ã‚Œå€¤ãƒ»æ¬ æå€¤ã«å¯¾å‡¦
    - æ–‡å­—åˆ—ã‹ã‚‰æ•°å€¤ã‚„æ—¥æ™‚ã‚’æŠœãå‡ºã™

<cite style="display: block; text-align: right;"><a href="https://www.amazon.co.jp/dp/4774196479/ref=as_li_ss_tl?ie=UTF8&linkCode=ll1&tag=heavywatal-22&linkId=8a3fd4e9a0c944b1b41242bbab8d147b">
æœ¬æ©‹æ™ºå…‰ã€Œå‰å‡¦ç†å¤§å…¨ã€
</a></cite>

---
## tidyverseã«ä¾¿åˆ©ãªé“å…·ãŒæƒã£ã¦ã‚‹

<a href="https://www.tidyverse.org/">
<img src="/slides/image/rstats/hex-badges.png" width="260" align="right">
</a>

Rã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ‰‹ã«æ‰±ã†ãŸã‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç¾¤

```{r tidyverse, eval=FALSE}
install.packages("tidyverse")
library(tidyverse)
# core packages are loaded
```

- çµ±ä¸€çš„ãªä½¿ã„å‹æ‰‹
- ã‚·ãƒ³ãƒ—ãƒ«ãªé–¢æ•°ã‚’ç¹‹ã’ã¦ä½¿ã†ãƒ‡ã‚¶ã‚¤ãƒ³

<figure>
<a href="https://r4ds.had.co.nz/introduction.html">
<img src="/slides/image/r4ds/data-science.png">
<figcaption class="url">https://r4ds.had.co.nz/introduction.html</figcaption>
</a>
</figure>

data.frameå‡¦ç†ã«ä½¿ã†ã®ã¯ä¸»ã« [dplyr](/rstats/dplyr.html) ã¨ [tidyr](/rstats/tidyr.html)


---
## ã“ã®ãƒãƒ³ã‚ºã‚ªãƒ³Rå…¥é–€ã®ç›®æ¨™

### âœ… <strike>å†ç¾å¯èƒ½ãªè§£æã‚’æ¥½ã«ã‚„ã‚ŠãŸã„</strike>

### â¬œ ã‚ã‚Œã‚‚ã“ã‚Œã‚‚Rã§ã§ããã†ï¼

### â¬œ ã‚„ã‚ŠãŸããªã£ãŸã‚‰ã“ã†ã‚„ã£ã¦èª¿ã¹ã‚Œã°ã„ã„ã‚“ã ãª

<br>
That's all.
ã“ã®3ç‚¹ã•ãˆæŠ¼ã•ãˆã‚Œã°ã€å€‹ã€…ã®æ–¹æ³•ã¯è¦šãˆãªãã¦ã‚‚å¤§ä¸ˆå¤«ã€‚<br>

(ä»Šæ—¥ã¯çµæ§‹ç››ã‚Šæ²¢å±±ãªã®ã§å¿µã®ãŸã‚å†æ²)


---
## dplyr --- data.frameã®é«˜é€Ÿå‡¦ç†æ‹…å½“

<a href="https://dplyr.tidyverse.org/">
<img src="/_img/hex-stickers/dplyr.webp" width="120" align="right">
</a>

ã‚·ãƒ³ãƒ—ãƒ«ãªé–¢æ•°ãŒãŸãã•ã‚“ã€‚ç¹‹ã’ã¦ä½¿ã† (piping)

æŠ½å‡º
: åˆ—: `select()`,
: è¡Œ: `filter()`, `distinct()`, `slice()`

è¦ç´„ãƒ»é›†è¨ˆ
: `group_by()`, `summarize()`, `count()`

ã‚½ãƒ¼ãƒˆ
: `arrange()`

çµåˆ
: è¡Œæ–¹å‘: `bind_rows()`
: åˆ—æ–¹å‘: `left_join()`, `inner_join()`, `full_join()`

åˆ—ã®è¿½åŠ ãƒ»å¤‰æ›´
: `mutate()`, `rename()`


---
## dplyrã‚’ä½¿ã£ã¦ã¿ã‚‹æº–å‚™

ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚“ã§ã€ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã¦ã¿ã‚‹
```r
# install.packages("tidyverse")
library(tidyverse)
print(diamonds)
View(diamonds)  # RStudio
```

```{r dplyr-diamonds, echo=FALSE}
print(diamonds)
```


---
## dplyr ä½¿ç”¨ä¾‹

å°ã•ãªé–¢æ•°ã‚’ç¹‹ã’ã¦ä½¿ã†æµã‚Œä½œæ¥­:
```{r dplyr}
result = diamonds %>%              # ç”Ÿãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‡ºç™ºã—ã¦
  select(carat, cut, price) %>%    # åˆ—ã‚’æŠ½å‡ºã—ã¦
  filter(carat > 1) %>%            # è¡Œã‚’æŠ½å‡ºã—ã¦
  group_by(cut) %>%                # ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦
  summarize(mean(price)) %>%       # å¹³å‡ã‚’è¨ˆç®—
  print()                          # è¡¨ç¤ºã—ã¦ã¿ã‚‹
```

ã“ã®è¦‹æ…£ã‚Œã¬è¨˜å· `%>%` ã¯ä½•ï¼Ÿ

---
## Pipe operator (ãƒ‘ã‚¤ãƒ—æ¼”ç®—å­) `%>%`

ãƒ‘ã‚¤ãƒ—ã®å·¦å´ã®å¤‰æ•°ã‚’ã€å³å´ã®é–¢æ•°ã®ç¬¬ä¸€å¼•æ•°ã«ã­ã˜è¾¼ã‚€:
```r
diamonds %>% filter(carat > 1)
filter(diamonds, carat > 1)     # ã“ã‚Œã¨åŒã˜

# å‰å‡¦ç†ã®æµã‚Œä½œæ¥­ã«ä¾¿åˆ©:
diamonds %>% select(carat, price) %>% filter(carat > 1) %>% ...
#   data %>%  do_A()  %>%  do_B()  %>%  do_C()  %>% ...
```

[å•] ãƒ‘ã‚¤ãƒ—ã‚’ä½¿ã‚ãªã„å½¢ã«æ›¸ãæ›ãˆã‚ˆã†:
```{r letters}
seq_len(6) %>% sum()
letters %>% toupper() %>% head(3)
```

[è§£ç­”ä¾‹]
```r
sum(seq_len(6))
head(toupper(letters), 3)
```

---
## ãƒ‘ã‚¤ãƒ—æ¼”ç®—å­ `%>%` ã‚’ä½¿ã‚ãªã„æ–¹æ³•

ğŸ˜ ä¸€æ™‚å¤‰æ•°ã‚’ã‚¤ãƒã‚¤ãƒä½œã‚‹:
```{r pipe-tmp-var}
tmp1 = select(diamonds, carat, cut, price)   # åˆ—ã‚’æŠ½å‡ºã—ã¦
tmp2 = filter(tmp1, carat > 1)               # è¡Œã‚’æŠ½å‡ºã—ã¦
tmp3 = group_by(tmp2, cut)                   # ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦
result = summarize(tmp3, mean(price))        # å¹³å‡ã‚’è¨ˆç®—
```

ğŸ˜ åŒã˜åå‰ã‚’ä½¿ã„å›ã™:
```{r pipe-recursive-assign}
result = select(diamonds, carat, cut, price) # åˆ—ã‚’æŠ½å‡ºã—ã¦
result = filter(result, carat > 1)           # è¡Œã‚’æŠ½å‡ºã—ã¦
result = group_by(result, cut)               # ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦
result = summarize(result, mean(price))      # å¹³å‡ã‚’è¨ˆç®—
```

ã©ã¡ã‚‰ã‚‚æ‚ªããªã„ã€‚
ä½•åº¦ã‚‚å¤‰æ•°åã‚’å…¥åŠ›ã™ã‚‹ã®ãŒã‚„ã‚„å†—é•·ã€‚


---
## ãƒ‘ã‚¤ãƒ—æ¼”ç®—å­ `%>%` ã‚’ä½¿ã‚ãªã„æ–¹æ³•

ğŸ˜« ä¸€æ™‚å¤‰æ•°ã‚’ä½¿ã‚ãšã«:
```{r pipe-nest}
result = summarize(                    # å¹³å‡ã‚’è¨ˆç®—
    group_by(                            # ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦
      filter(                              # è¡Œã‚’æŠ½å‡ºã—ã¦
        select(diamonds, carat, cut, price), # åˆ—ã‚’æŠ½å‡ºã—ã¦
        carat > 1),                        # è¡Œã‚’æŠ½å‡ºã—ã¦
      cut),                              # ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦
    mean(price))                       # å¹³å‡ã‚’è¨ˆç®—
```

ğŸ¤ª æ”¹è¡Œã•ãˆã›ãšã«:
```{r pipe-oneliner}
result = summarize(group_by(filter(select(diamonds, carat, cut, price), carat > 1), cut), mean(price))
```

è«–ç†ã®æµã‚Œã¨ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®æµã‚ŒãŒåˆã‚ãšã€ç›®ãŒè¡Œã£ãŸã‚Šæ¥ãŸã‚Šã€‚<br>
ã•ã£ãã®ã»ã†ãŒãœã‚“ãœã‚“ãƒã‚·ã€‚

---
## ãƒ‘ã‚¤ãƒ—æ¼”ç®—å­ `%>%` ã‚’ä½¿ãŠã†

ğŸ˜ æ…£ã‚Œã‚Œã°ã€è«–ç†ã®æµã‚Œã‚’è¿½ã„ã‚„ã™ã„:
```{r eg-pipe}
result = diamonds %>%
  select(carat, cut, price) %>%    # åˆ—ã‚’æŠ½å‡ºã—ã¦
  filter(carat > 1) %>%            # è¡Œã‚’æŠ½å‡ºã—ã¦
  group_by(cut) %>%                # ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦
  summarize(mean(price)) %>%       # å¹³å‡ã‚’è¨ˆç®—
  print()                          # è¡¨ç¤ºã—ã¦ã¿ã‚‹
```

æ…£ã‚Œã‚‹ã¾ã§ã¯ã¡ã‚‡ã£ã¨å¤§å¤‰ã‹ã‚‚ã€‚
ç„¡ç†ã—ã¦ä½¿ã‚ãªãã¦ã‚‚å¤§ä¸ˆå¤«ã€‚


---
## åˆ—ã®æŠ½å‡º: `select()`

**åˆ—ã®ç•ªå·**ã§æŒ‡å®š:
```{r select-number}
result = diamonds %>%
  select(1, 2, 7) %>%
  print()
```

åˆ¥è§£: `diamonds[, c(1, 2, 7)]`


---
## åˆ—ã®æŠ½å‡º: `select()`

**åˆ—ã®åå‰**ã§æŒ‡å®š:
```{r select-name}
result = diamonds %>%
  select(carat, cut, price) %>%
  print()
```

åˆ¥è§£: `diamonds %>% select(c("carat", "cut", "price"))`<br>
åˆ¥è§£: `diamonds[, c("carat", "cut", "price")]`


---
## åˆ—ã®æŠ½å‡º: `select()`

**æ¨ã¦ã‚‹åˆ—**ã‚’ãƒã‚¤ãƒŠã‚¹æŒ‡å®š:
```{r select-negative}
result = diamonds %>%
  select(-carat, -cut, -price) %>%
  print()
```

---
## åˆ—ã®æŠ½å‡º: `select()`

åå‰ã®**éƒ¨åˆ†ä¸€è‡´**ã§æŒ‡å®š:
```{r select-matches}
result = diamonds %>%
  select(starts_with("c")) %>%
  print()
```

See `?dplyr_tidy_select` or [tidyselect helpers](https://tidyselect.r-lib.org/reference/select_helpers.html) for more details.


---
## åˆ—ã®æŠ½å‡º: `select()`

**åˆ—ã®å‹**ã§æŒ‡å®š:
```{r select-where}
result = diamonds %>%
  select(where(is.numeric)) %>%
  print()
```

See `?dplyr_tidy_select` or [`tidyselect::where`](https://tidyselect.r-lib.org/reference/where.html) for more details.


---
## è¡Œã®æŠ½å‡º: `filter()`

ç­‰å· `==` ã§**å®Œå…¨ä¸€è‡´ã™ã‚‹è¡Œ**ã®ã¿æ®‹ã™:
```{r filter-exact}
result = diamonds %>%
  filter(cut == "Ideal") %>%
  print()
```

åˆ¥è§£: `diamonds[diamonds[["cut"]] == "Ideal", ]`


---
## è¡Œã®æŠ½å‡º: `filter()`

ä¸ç­‰å·ã§**ä¸€è‡´ã—ãªã„è¡Œ**ã®ã¿æ®‹ã™:
```{r filter-unequal}
result = diamonds %>%
  filter(cut != "Ideal") %>%
  print()
```

ä¸ç­‰å·: `!=`, `<`, `<=`, `>`, `>=`

---
## è¡Œã®æŠ½å‡º: `filter()`

è¤‡æ•°ã®å€¤ã®ã†ã¡**ã©ã‚Œã‹ã«ä¸€è‡´ã™ã‚‹è¡Œ**ã®ã¿æ®‹ã™:
```{r filter-in}
result = diamonds %>%
  filter(cut %in% c("Ideal", "Good")) %>%
  print()
```

---
## è¡Œã®æŠ½å‡º: `filter()`

2ã¤ã®æ¡ä»¶ã‚’**ä¸¡æ–¹æº€ãŸã™è¡Œ**ã®ã¿æ®‹ã™ (AND):
```{r filter-and}
result = diamonds %>%
  filter(carat > 2 & price < 14000) %>%
  print()
```

---
## è¡Œã®æŠ½å‡º: `filter()`

2ã¤ã®æ¡ä»¶ã®**ã„ãšã‚Œã‹ã‚’æº€ãŸã™è¡Œ**ã®ã¿æ®‹ã™ (OR):
```{r filter-or}
result = diamonds %>%
  filter(carat > 2 | price < 14000) %>%
  print()
```

---
## ä¸Šä½/ä¸‹ä½ã®è¡Œã®æŠ½å‡º: `slice_max()`, `slice_min()`

æŒ‡å®šã—ãŸåˆ—ã®å€¤ãŒ**å¤§ãã„é †**ã«æŠ½å‡º:
```{r slice_max}
result = diamonds %>%
  slice_max(price, n = 5L) %>%
  print()
```

**å‰²åˆã‚’æŒ‡å®š**ã™ã‚‹ãªã‚‰ `n` ã®ä»£ã‚ã‚Šã« `prop = 0.05`


---
## ä¸Šä½/ä¸‹ä½ã®è¡Œã®æŠ½å‡º: `slice_max()`, `slice_min()`

æŒ‡å®šã—ãŸåˆ—ã®å€¤ãŒ**å¤§ãã„é †**ã«**å„ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰**æŠ½å‡º:
```{r group_slice_max}
result = diamonds %>%
  group_by(cut) %>%
  slice_max(price, n = 2L) %>%
  print()
```

**å‰²åˆã‚’æŒ‡å®š**ã™ã‚‹ãªã‚‰ `n` ã®ä»£ã‚ã‚Šã« `prop = 0.05`


---
## å…ˆé ­/æœ«å°¾ã®è¡Œã®æŠ½å‡º: `slice_head()`, `slice_tail()`

**å„ã‚°ãƒ«ãƒ¼ãƒ—ã®å…ˆé ­**ã‚’æŠ½å‡º:
```{r group_slice_head}
result = diamonds %>%
  group_by(cut) %>%
  slice_head(n = 3L) %>%
  print()
```

**å‰²åˆã‚’æŒ‡å®š**ã™ã‚‹ãªã‚‰ `n` ã®ä»£ã‚ã‚Šã« `prop = 0.05`


---
## ãƒ©ãƒ³ãƒ€ãƒ ã«è¡Œã®æŠ½å‡º: `slice_sample()`

**è¡Œæ•°ã‚’æŒ‡å®š**ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ ã‚µãƒ³ãƒ—ãƒ«:
```{r slice_sample}
result = diamonds %>%
  group_by(cut) %>%
  slice_sample(n = 3L, replace = FALSE) %>%
  print()
```

**å‰²åˆã‚’æŒ‡å®š**ã™ã‚‹ãªã‚‰ `prop =` ã‚’ä½¿ã†ã€‚


---
## Xç•ªç›®ã®è¡Œã®æŠ½å‡º: `slice()`

**å„ã‚°ãƒ«ãƒ¼ãƒ—ã®Xç•ªç›®ã®è¡Œ**ã‚’æŠ½å‡º:
```{r group_slice}
result = diamonds %>%
  group_by(cut) %>%
  slice(c(1, 2, 9)) %>%
  print()
```


---
## é‡è¤‡è¡Œã®é™¤å»: `distinct()`

æŒ‡å®šã—ãŸåˆ—ã«é–¢ã—ã¦ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè¡Œã®ã¿æ®‹ã™:
```{r distinct}
result = diamonds %>%
  distinct(cut, color) %>%
  print()
```

`.keep_all = TRUE`
ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹ã¨æŒ‡å®šã—ãªã‹ã£ãŸåˆ—ã‚‚æ®‹ã›ã‚‹ã€‚

---
## è¦ç´„ãƒ»é›†è¨ˆ: `summarize()`

åˆ—ã®**åˆè¨ˆã€å¹³å‡ã€æœ€å¤§**ãªã©ã‚’æ±‚ã‚ã‚‹:
```{r summarize}
result = diamonds %>%
  summarize(sum(carat), mean(carat), max(price)) %>%
  print()
```

vectorã‚’å—ã‘å–ã£ã¦1ã¤ã®å€¤ã‚’è¿”ã™é›†ç´„é–¢æ•°:<br>
`min()`, `max()`, `mean()`, `median()`, `var()`, `sd()`, etc.


---
## è¦ç´„ãƒ»é›†è¨ˆ: `summarize()`

åˆ—ã®å€¤ã‚’**ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«**é›†è¨ˆã™ã‚‹:
```{r group_summarize}
result = diamonds %>%
  group_by(cut) %>%
  summarize(avg_carat = mean(carat),
            max_price = max(price)) %>%
  print()
```


---
## è¦ç´„ãƒ»é›†è¨ˆ: `summarize()` ç™ºå±•ç·¨

è¤‡æ•°ã®åˆ—ã®è¤‡æ•°ã®å€¤ã‚’æŸ”è»Ÿã«é›†è¨ˆã™ã‚‹:
```{r group_summarize_across}
result = diamonds %>%
  group_by(cut) %>%
  summarize(across(where(is.numeric), range)) %>%
  print()
```

`across()` ã‚‚ `where()` ã‚‚è¤‡æ•°è¡Œå‡ºåŠ›ã‚‚ dplyr 1.0.0 æ–°æ©Ÿèƒ½


---
## è¦ç´„ãƒ»é›†è¨ˆ: `count()`

æŒ‡å®šã—ãŸåˆ—ã®çµ„ã¿åˆã‚ã›å‡ºç¾æ•°ã‚’æ•°ãˆã‚‹:
```{r count}
result = diamonds %>%
  count(cut, color) %>%
  print()
```

`diamonds %>% group_by(cut, color) %>% tally()` ã¨åŒã˜ã€‚


---
## è¡Œã®ã‚½ãƒ¼ãƒˆ: `arrange()`

æŒ‡å®šã—ãŸåˆ—ã®å€¤ãŒ**å°ã•ã„é †ã«ä¸Šã‹ã‚‰**ä¸¦ã¹ã‚‹:
```{r arrange}
result = diamonds %>%
  arrange(color, desc(carat)) %>%  # è‰²ã®æ˜‡é †ã€‚è‰²ãŒåŒã˜ãªã‚‰å¤§ãã•é™é †
  print()
```

é€†ã«ã™ã‚‹ã«ã¯ `desc()` ã‚’ä½¿ã†ã€‚


---
## åˆ—ã®ä¸¦ã³æ›¿ãˆ: `relocate()`

æŒ‡å®šã—ãŸåˆ—ã‚’å·¦ç«¯ã«ç§»å‹•:
```{r relocate}
result = diamonds %>%
  relocate(carat, price, clarity) %>%
  print()
```

`.before`, `.after` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§å¾®èª¿æ•´ã‚‚å¯èƒ½ã€‚


---
## è¡Œã®çµåˆ: `bind_rows()`

ä¾‹ã€‚å…ˆé ­ã¨æœ«å°¾ã‚’6è¡Œãšã¤å–ã£ã¦ã²ã¨ã¤ã®è¡¨ã«çµåˆã™ã‚‹:
```{r bind_rows}
bind_rows(head(diamonds), tail(diamonds))
```


---
## å…±é€šã™ã‚‹åˆ—ã§çµåˆ: `full_join()`

ä»–æ–¹ã«ç„¡ã„éƒ¨åˆ†ã‚’ `NA` ã§è£œå®Œã—ã¦**å·¦å³ã¨ã‚‚å…¨è¡Œ**ä¿æŒ:
```{r full_join}
full_join(band_members, band_instruments, by = "name")
```
```
band_members          band_instruments
   name    band          name  plays
  <chr>   <chr>         <chr>  <chr>
1  Mick  Stones       1  John guitar
2  John Beatles       2  Paul   bass
3  Paul Beatles       3 Keith guitar
```

---
## å…±é€šã™ã‚‹åˆ—ã§çµåˆ: `left_join()`

å³å´ã«ç„¡ã„éƒ¨åˆ†ã‚’ `NA` ã§è£œå®Œã—ã¦**å·¦å´ã ã‘å…¨è¡Œ**ä¿æŒ:
```{r left_join}
left_join(band_members, band_instruments, by = "name")
```
```
band_members          band_instruments
   name    band          name  plays
  <chr>   <chr>         <chr>  <chr>
1  Mick  Stones       1  John guitar
2  John Beatles       2  Paul   bass
3  Paul Beatles       3 Keith guitar
```

ãã®é€†ã¯ `right_join()`

---
## å…±é€šã™ã‚‹åˆ—ã§çµåˆ: `inner_join()`

å·¦å³ã¨ã‚‚ã«**å…±é€šã™ã‚‹å€¤ã®ã‚ã‚‹è¡Œã ã‘**ä¿æŒ:
```{r inner_join}
inner_join(band_members, band_instruments, by = "name")
```
```
band_members          band_instruments
   name    band          name  plays
  <chr>   <chr>         <chr>  <chr>
1  Mick  Stones       1  John guitar
2  John Beatles       2  Paul   bass
3  Paul Beatles       3 Keith guitar
```

---
## joinã¾ã¨ã‚

<figure>
<a href="https://r4ds.had.co.nz/relational-data.html#mutating-joins">
<img src="/slides/image/r4ds/join.png" height="550">
<br>
<figcaption class="url">https://r4ds.had.co.nz/relational-data.html#mutating-joins</figcaption>
</a>
</figure>


---
## joinä¾‹é¡Œ: `nycflights13` ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ

é–¢é€£ã™ã‚‹data.frameã‚’ã„ã‚ã„ã‚ãªæ–¹æ³•ã§çµåˆã—ã¦ã¿ã‚ˆã†ã€‚

```r
install.packages("nycflights13")
library(nycflights13)
data(package = "nycflights13")
# airlines, airports, flights, planes, weather
```

<figure>
<a href="https://r4ds.had.co.nz/relational-data.html#nycflights13-relational">
<img src="/slides/image/r4ds/relational-nycflights.png" height="320">
<br>
<figcaption class="url">https://r4ds.had.co.nz/relational-data.html#nycflights13-relational</figcaption>
</a>
</figure>


---
## æ–°ã—ã„åˆ—ã®è¿½åŠ : `mutate()`

æ—¢å­˜ã®åˆ—åã‚’æŒ‡å®šã™ã‚‹ã¨ä¸Šæ›¸ã:
```{r mutate}
result = diamonds %>%
  mutate(ratio = price / carat,
         price = price * 108.36) %>%
  print()
```


---
## tidyr --- data.frameã®å¤‰å½¢ãƒ»æ•´å½¢æ‹…å½“

<a href="https://tidyr.tidyverse.org/">
<img src="/_img/hex-stickers/tidyr.webp" width="120" align="right">
</a>

æ¨ªåºƒã‹ã‚‰ç¸¦é•·ã«
: `pivot_longer()`, <strike><code>gather()</code></strike>

ç¸¦é•·ã‹ã‚‰æ¨ªåºƒã«
: `pivot_wider()`, <strike><code>spread()</code></strike>

åˆ—ã‚’åˆ†é›¢ã€çµåˆ
: `separate()`, `unite()`

å…¥ã‚Œå­æ§‹é€ ã‚’ã¤ãã‚‹ã€è§£æ¶ˆã™ã‚‹
: `nest()`, `unnest()`

*etc.*


---
## `pivot_longer()` æ¨ªåºƒã‹ã‚‰ç¸¦é•·ã«

è¤‡æ•°åˆ—ã«ã¾ãŸãŒã‚‹å€¤ã‚’1åˆ—ã«ã™ã‚‹ã€‚<br>
ãã®ãƒ©ãƒ™ãƒ«ã‚‚åˆã‚ã›ã¦ç§»å‹•ã€‚

<figure>
<a href="https://r4ds.had.co.nz/tidy-data.html#gathering">
<img src="/slides/image/r4ds/tidy-gather.png" width="800">
<br>
<figcaption class="url">https://r4ds.had.co.nz/tidy-data.html#gathering</figcaption>
</a>
</figure>

---
## `pivot_longer()` æ¨ªåºƒã‹ã‚‰ç¸¦é•·ã«

è¤‡æ•°åˆ—ã«ã¾ãŸãŒã‚‹å€¤ã‚’1åˆ—ã«ã™ã‚‹(ã“ã“ã§ã¯`value`)ã€‚<br>
ãã®ãƒ©ãƒ™ãƒ«ã‚‚åˆã‚ã›ã¦ç§»å‹•(ã“ã“ã§ã¯`item`)ã€‚

```{r pivot_longer}
iris_long = iris %>% head(2L) %>%    # æœ€åˆã®2è¡Œã ã‘
  rowid_to_column("id") %>%          # IDåˆ—ã‚’è¿½åŠ 
  print() %>%                        # é€”ä¸­çµŒéã‚’è¡¨ç¤º
  pivot_longer(2:5, names_to = "item", values_to = "value") %>%
  print()                            # 2â€“5åˆ—ç›®ã®å€¤ã‚’ç§»å‹•
```


---
## `pivot_wider()` ç¸¦é•·ã‹ã‚‰æ¨ªåºƒã«

1åˆ—ã«åã¾ã£ã¦ã„ãŸå€¤ã‚’è¤‡æ•°åˆ—ã®è¡Œåˆ—ã«å¤‰æ›ã€‚<br>
ãã®ãƒ©ãƒ™ãƒ«ã‚’åˆ—ã®åå‰ã«ã™ã‚‹ã€‚

<figure>
<a href="https://r4ds.had.co.nz/tidy-data.html#spreading">
<img src="/slides/image/r4ds/tidy-spread.png" height="480">
<br>
<figcaption class="url">https://r4ds.had.co.nz/tidy-data.html#spreading</figcaption>
</a>
</figure>

---
## `pivot_wider()` ç¸¦é•·ã‹ã‚‰æ¨ªåºƒã«

1åˆ—ã«åã¾ã£ã¦ã„ãŸå€¤ã‚’è¤‡æ•°åˆ—ã®è¡Œåˆ—ã«å¤‰æ›(`value`)ã€‚<br>
ãã®ãƒ©ãƒ™ãƒ«ã‚’åˆ—ã®åå‰ã«ã™ã‚‹(`item`)ã€‚

```{r spread}
iris_long %>% print() %>%                    # ã•ã£ãç¸¦é•·ã«ã—ãŸã‚„ã¤
  pivot_wider(names_from = item, values_from = value)  # æ¨ªåºƒã«æˆ»ã™
```

---
## `separate()` åˆ—ã‚’åˆ†é›¢

<figure>
<a href="https://r4ds.had.co.nz/tidy-data.html#separate">
<img src="/slides/image/r4ds/tidy-separate.png" width="800">
<br>
<figcaption class="url">https://r4ds.had.co.nz/tidy-data.html#separate</figcaption>
</a>
</figure>

---
## `separate()` åˆ—ã‚’åˆ†é›¢

```{r separate}
iris_long %>% print() %>%
  separate(item, c("part", "measure")) # åˆ—ã‚’åˆ†é›¢
```

---
## `unite()` åˆ—ã‚’èåˆ

<figure>
<a href="https://r4ds.had.co.nz/tidy-data.html#unite">
<img src="/slides/image/r4ds/tidy-unite.png" width="800">
<br>
<figcaption class="url">https://r4ds.had.co.nz/tidy-data.html#unite</figcaption>
</a>
</figure>

---
## `nest()` å…¥ã‚Œå­ã«ã™ã‚‹

ã‚°ãƒ«ãƒ¼ãƒ—æ¯ã«data.frameã‚’åŒºåˆ‡ã£ã¦listå‹ã®åˆ—ã«å…¥ã‚Œã‚‹ã€‚

<figure>
<a href="https://www.tidyverse.org/articles/2019/09/tidyr-1-0-0/">
<img src="/slides/image/rstats/nest-pack-chop.png" height="500">
<br>
<figcaption class="url">https://www.tidyverse.org/articles/2019/09/tidyr-1-0-0/</figcaption>
</a>
</figure>

---
## `nest()` å…¥ã‚Œå­ã«ã™ã‚‹

ã‚°ãƒ«ãƒ¼ãƒ—æ¯ã«data.frameã‚’åŒºåˆ‡ã£ã¦listå‹ã®åˆ—ã«å…¥ã‚Œã‚‹ã€‚

```{r nest}
iris_nested = as_tibble(iris) %>%
  nest(data = -Species) %>% print()
iris_nested$data[[1L]]
```

---
## ä¾‹é¡Œ1: `VADeaths` ã‚’ç¸¦é•·ã«ã—ãŸã„

```{r vadeaths_df, results="hold"}
as.data.frame(VADeaths)                  # data.frameã«å¤‰æ›
                                         # è¡Œåã‚’åˆ—ã«
                                         # ç¸¦é•·ã«å¤‰å½¢ã—ãŸã„
```

---
## ä¾‹é¡Œ1: `VADeaths` ã‚’ç¸¦é•·ã«ã—ãŸã„

```{r vadeaths_rownames, results="hold"}
as.data.frame(VADeaths) %>%              # data.frameã«å¤‰æ›
  rownames_to_column("age")              # è¡Œåã‚’åˆ—ã«
                                         # ç¸¦é•·ã«å¤‰å½¢ã—ãŸã„
```

---
## ä¾‹é¡Œ1: `VADeaths` ã‚’ç¸¦é•·ã«ã—ãŸã„

```{r vadeaths_longer, results="hold"}
as.data.frame(VADeaths) %>%              # data.frameã«å¤‰æ›
  rownames_to_column("age") %>%          # è¡Œåã‚’åˆ—ã«
  pivot_longer(-age, values_to = "death")     # ageä»¥å¤–ã‚’ç§»å‹•ã—ã¦ç¸¦é•·åŒ–
                                         # æ–°ã—ã„nameåˆ—ã‚’åˆ†å‰²
```

---
## ä¾‹é¡Œ1: `VADeaths` ã‚’ç¸¦é•·ã«ã—ãŸã„

```{r vadeaths_region_sex, results="hold"}
as.data.frame(VADeaths) %>%              # data.frameã«å¤‰æ›
  rownames_to_column("age") %>%          # è¡Œåã‚’åˆ—ã«
  pivot_longer(-age, values_to = "death") %>% # ageä»¥å¤–ã‚’ç§»å‹•ã—ã¦ç¸¦é•·åŒ–
  separate(name, c("region", "sex"))     # æ–°ã—ã„nameåˆ—ã‚’åˆ†å‰²
```

---
## ä¾‹é¡Œ1: `VADeaths` ã‚’ç¸¦é•·ã«ã—ãŸã„

```{r vadeaths_age, results="hold"}
va_deaths = as.data.frame(VADeaths) %>%  # data.frameã«å¤‰æ›
  rownames_to_column("age") %>%          # è¡Œåã‚’åˆ—ã«
  pivot_longer(-age, values_to = "death") %>% # ageä»¥å¤–ã‚’ç§»å‹•ã—ã¦ç¸¦é•·åŒ–
  separate(name, c("region", "sex")) %>% # æ–°ã—ã„nameåˆ—ã‚’åˆ†å‰²
  separate(age, c("lbound", "ubound"), "-", convert = TRUE) %>%
  print()                                # ä¸‹é™ã¨ä¸Šé™ã‚’åˆ†é›¢
```

---
## ä¾‹é¡Œ1: `VADeaths` åˆ¥è§£

```{r vadeaths_pivot, results="hold"}
va_deaths = as.data.frame(VADeaths) %>%  # data.frameã«å¤‰æ›
  rownames_to_column("age") %>%          # è¡Œåã‚’åˆ—ã«
  pivot_longer(                          # ç¸¦é•·ã«å¤‰å½¢ã—ãŸã„
    -age,                                # ageä»¥å¤–ã®åˆ—ã«å…¥ã£ã¦ã‚‹å€¤ã‚’ç§»å‹•
    names_to = c("region", "sex"),       # å…ƒã®åˆ—åã‚’2ã¤ã«åˆ†é›¢
    names_sep = " ",                     # ã‚¹ãƒšãƒ¼ã‚¹ã§åˆ‡ã‚‹
    values_to = "death") %>%             # å€¤ã®è¡Œãå…ˆã®åˆ—å
  separate(age, c("lbound", "ubound"), "-", convert = TRUE) %>%
  print()                                # ä¸‹é™ã¨ä¸Šé™ã‚’åˆ†é›¢
```

---
## ä¾‹é¡Œ1: `VADeaths` ä½œå›³ä¾‹

```{r vadeaths_plot, fig.height = 5, fig.width = 10}
ggplot(va_deaths) +
  aes(lbound, death) +
  geom_point(aes(color = sex, shape = region), size = 5) +
  theme_classic(base_size = 16)
```

---
## ä¾‹é¡Œ2: `anscombe`

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r anscombe, results="hold"}
anscombe %>%
  rowid_to_column("id")              # IDã‚’ã¤ã‘ã¦ãŠã
                                     # x y ã§å§‹ã¾ã‚‹åˆ—ã®å€¤ã‚’ç§»ã—ã¦ç¸¦é•·ã«
```

ggplot does not accept this format. Let's transform it.


---
## ä¾‹é¡Œ2: `anscombe`

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r anscombe_longer, results="hold"}
anscombe %>%
  rowid_to_column("id") %>%          # IDã‚’ã¤ã‘ã¦ãŠã
  pivot_longer(matches("^x|y"))      # x y ã§å§‹ã¾ã‚‹åˆ—ã®å€¤ã‚’ç§»ã—ã¦ç¸¦é•·ã«

                                     # nameåˆ—ã‚’åˆ†å‰²
```

---
## ä¾‹é¡Œ2: `anscombe`

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r anscombe_separate, results="hold"}
anscombe %>%
  rowid_to_column("id") %>%          # IDã‚’ã¤ã‘ã¦ãŠã
  pivot_longer(matches("^x|y")) %>%  # x y ã§å§‹ã¾ã‚‹åˆ—ã®å€¤ã‚’ç§»ã—ã¦ç¸¦é•·ã«
  separate(name, c("axis", "group"), 1L, convert = TRUE)
                                     # nameåˆ—ã‚’åˆ†å‰²
```

---
## ä¾‹é¡Œ2: `anscombe`

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r anscombe_wider, results="hold"}
tidy_anscombe = anscombe %>%
  rowid_to_column("id") %>%          # IDã‚’ã¤ã‘ã¦ãŠã
  pivot_longer(matches("^x|y")) %>%  # x y ã§å§‹ã¾ã‚‹åˆ—ã®å€¤ã‚’ç§»ã—ã¦ç¸¦é•·ã«
  separate(name, c("axis", "group"), 1L, convert = TRUE) %>%
                                     # nameåˆ—ã‚’åˆ†å‰²
  pivot_wider(names_from = axis, values_from = value) %>%
                                     # axisåˆ—å†…ã® x y ã‚’åˆ—ã«ã—ã¦æ¨ªåºƒåŒ–
  arrange(group) %>%                 # ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ä¸¦ã¹ã‚‹
  print()                            # ggplotã—ãŸã„å½¢ï¼
```

---
## ä¾‹é¡Œ2: `anscombe` åˆ¥è§£

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r anscombe_pivot}
tidy_anscombe = anscombe %>%
  pivot_longer(                       # ç¸¦é•·ã«å¤‰å½¢ã—ãŸã„
    everything(),                     # ã™ã¹ã¦ã®åˆ—ã«ã¤ã„ã¦
    names_to = c(".value", "group"),  # æ–°ã—ã„åˆ—å
    names_sep = 1L,                   # åˆ‡ã‚‹ä½ç½®
    names_transform = list(group = as.integer)) %>% # å‹å¤‰æ›
  arrange(group) %>%                  # ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ä¸¦ã¹ã‚‹
  print()                             # ggplotã—ãŸã„å½¢ï¼
```


---
## ä¾‹é¡Œ2: `anscombe` ä½œå›³ä¾‹

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r plot_anscombe, fig.height=3, fig.width=10, out.width="98%"}
ggplot(tidy_anscombe) + aes(x, y) +
  geom_point(size = 3) +
  stat_smooth(method = lm, formula = y ~ x, se = FALSE, fullrange = TRUE) +
  facet_wrap(~ group, nrow = 1L)
```

---
## ä¾‹é¡Œ2: `anscombe` è¦ç´„

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r summarize_anscombe}
tidy_anscombe %>%
  group_by(group) %>%   # groupåˆ—ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦
  summarize(            # x, yåˆ—ã‚’ä½¿ã£ã¦summarize
    mean_x = mean(x),
    mean_y = mean(y),
    sd_x = sd(x),
    sd_y = sd(y),
    cor_xy = cor(x, y)
  )
```



<!-- ###################################################################### -->



---
## å‰å‡¦ç†ã¯å¤§ãã2ã¤ã«åˆ†ã‘ã‚‰ã‚Œã‚‹

- ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å¯¾è±¡ã¨ã™ã‚‹å‡¦ç†
    - ä½¿ã„ãŸã„éƒ¨åˆ†ã ã‘æŠ½å‡º --- `select()`, `filter()`
    - ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ç‰¹å¾´ã‚’è¦ç´„ --- `group_by()`, `summarize()`
    - å¤§ãã„é †ã«ä¸¦ã¹æ›¿ãˆ --- `arrange()`
    - ç•°ãªã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã®çµåˆ --- `*_join()`
    - å¤‰å½¢: ç¸¦é•· â†” æ¨ªåºƒ --- `pivot_longer()`, `pivot_wider()`
- **ãƒ‡ãƒ¼ã‚¿å†…å®¹ã‚’å¯¾è±¡ã¨ã™ã‚‹å‡¦ç†** ğŸ‘ˆ
    - æ•°å€¤ã‚’å¤‰æ›ã™ã‚‹ (e.g., å¯¾æ•°ã€åº§æ¨™ç³»)
    - å¤‰æ›: é€£ç¶šå¤‰æ•° â†” ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ«å¤‰æ•° â†” ãƒ€ãƒŸãƒ¼å¤‰æ•°
    - å¤–ã‚Œå€¤ãƒ»æ¬ æå€¤ã«å¯¾å‡¦
    - æ–‡å­—åˆ—ã‹ã‚‰æ•°å€¤ã‚„æ—¥æ™‚ã‚’æŠœãå‡ºã™

<cite style="display: block; text-align: right;"><a href="https://www.amazon.co.jp/dp/4774196479/ref=as_li_ss_tl?ie=UTF8&linkCode=ll1&tag=heavywatal-22&linkId=8a3fd4e9a0c944b1b41242bbab8d147b">
æœ¬æ©‹æ™ºå…‰ã€Œå‰å‡¦ç†å¤§å…¨ã€
</a></cite>

---
## å¤‰æ•°/ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‹ (å…ˆé€±ã®ãŠã•ã‚‰ã„)

- **`vector`: åŸºæœ¬å‹ã€‚ä¸€æ¬¡å…ƒã®é…åˆ—ã€‚** (ğŸ‘ˆä»Šå›ã®ä¸»å½¹)
    - `logical`: è«–ç†å€¤ (`TRUE` or `FALSE`)
    - `numeric`: æ•°å€¤ (æ•´æ•° `42L` or å®Ÿæ•° `3.1416`)
    - `character`: æ–‡å­—åˆ— (`"a string"`)
    - `factor`: å› å­ (æ–‡å­—åˆ—ã£ã½ã„ã‘ã©å¾®å¦™ã«é•ã†)
- `array`: å¤šæ¬¡å…ƒé…åˆ—ã€‚`vector`åŒæ§˜ã€å…¨è¦ç´ ãŒåŒã˜å‹ã€‚
    - `matrix`: è¡Œåˆ— = äºŒæ¬¡å…ƒã®é…åˆ—ã€‚
- `list`: ç•°ãªã‚‹å‹ã§ã‚‚è©°ã‚è¾¼ã‚ã‚‹å¤ªã£è…¹ãƒ™ã‚¯ãƒˆãƒ«ã€‚
- `data.frame`: åŒã˜é•·ã•ã®ãƒ™ã‚¯ãƒˆãƒ«ã‚’ä¸¦ã¹ãŸé•·æ–¹å½¢ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã€‚é‡è¦ã€‚** <br>
  `tibble` ã¨ã‹ `tbl_df` ã¨å‘¼ã°ã‚Œã‚‹äºœç¨®ã‚‚ã‚ã‚‹ã‘ã©ã»ã¼åŒã˜ã€‚


---
## vector: ä¸€æ¬¡å…ƒã®é…åˆ— (å…ˆé€±ã®ãŠã•ã‚‰ã„)

1å€‹ã®å€¤ã§ã‚‚ãƒ™ã‚¯ãƒˆãƒ«æ‰±ã„ã€‚<br>
ãƒ™ã‚¯ãƒˆãƒ«ã®å„è¦ç´ ã«ä¸€æ°—ã«è¨ˆç®—ã‚’é©ç”¨ã§ãã‚‹ã€‚

```{r vector}
x = c(1, 2, 9)  # é•·ã•3ã®æ•°å€¤ãƒ™ã‚¯ãƒˆãƒ«
x + x           # åŒã˜é•·ã•åŒå£«ã®è¨ˆç®—
y = 10          # é•·ã•1ã®æ•°å€¤ãƒ™ã‚¯ãƒˆãƒ«
x + y           # é•·ã•3 + é•·ã•1 = é•·ã•3 (ãã‚Œãã‚Œè¶³ã—ç®—)
sqrt(x)         # square root
```


---
## data.frameã¯åˆ—vectorã®é›†ã¾ã‚Š

å†…å®¹ã‚’å¤‰æ›´ã™ã‚‹æ–¹æ³•ã¯ã„ãã¤ã‹ã‚ã‚‹ã€‚<br>
`diamonds[["price"]]` ã‚’ãƒ‰ãƒ«ã‹ã‚‰å††ã«å¤‰æ›ã™ã‚‹ä¾‹:

```{r dfcolumn}
dia = diamonds    # åˆ¥åã‚³ãƒ”ãƒ¼

# dollaræ¼”ç®—å­ã§æŒ‡å®š
dia$price = 109.58 * dia$price

# åå‰ã‚’æ–‡å­—åˆ—ã§æŒ‡å®š
dia[["price"]] = 109.58 * dia[["price"]]

# dplyr::mutate with pipe
dia = diamonds %>%
  mutate(price = 109.58 * price)
```

1ç™ºãªã‚‰ã©ã‚Œã§ã‚‚ã„ã„ã€‚æµã‚Œä½œæ¥­ã«ã¯ `mutate()` ãŒä¾¿åˆ©ã€‚


---
## æ•°å€¤: numericå‹

æ™®é€šã¯å€ç²¾åº¦æµ®å‹•å°æ•°ç‚¹å‹ `double` ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹:

```{r numeric}
answer = 42
typeof(answer)
```

æ˜ç¤ºçš„ã«å¤‰æ›ã—ãŸã‚Šæœ«å°¾ã«Lã‚’ä»˜ã‘ã‚‹ã“ã¨ã§æ•´æ•°æ‰±ã„ã‚‚ã§ãã‚‹:

```{r integer}
typeof(as.integer(answer))
whoami = 24601L
typeof(whoami)
```

---
## æ§˜ã€…ãªæ•°å­¦é–¢æ•°

ãƒ™ã‚¯ãƒˆãƒ«ã‚’å—ã‘å–ã‚Šã€ãã‚Œãã‚Œã®è¦ç´ ã«é©ç”¨

```{r math}
x = c(1, 2, 3)
sqrt(x)
log(x)
log10(x)
exp(x)
```

<div style="text-align: right;">
<a class="url" href="https://stat.ethz.ch/R-manual/R-patched/library/base/html/00Index.html">
https://stat.ethz.ch/R-manual/R-patched/library/base/html/00Index.html
</a></div>

---
## æ­£è¦åŒ– (z-score normalization)

å¹³å‡=0ã€æ¨™æº–åå·®=1ã€ã«ãªã‚‹ã‚ˆã†ã«:

```{r z-score}
result = diamonds %>%
  mutate(depth = scale(depth)) %>%
  print()
```

`depth = (depth - mean(depth)) / sd(depth)` ã¨åŒã˜ã€‚


---
## æ­£è¦åŒ– (min-max normalization)

æœ€å°=0ã€æœ€å¤§=1ã€ã«ãªã‚‹ã‚ˆã†ã«:

```{r min-max}
result = diamonds %>%
  mutate(depth = (depth - min(depth)) / (max(depth) - min(depth))) %>%
  print()
```

å¤–ã‚Œå€¤ã®å½±éŸ¿ã‚’å¤§ããå—ã‘ã‚‹ã“ã¨ã«æ³¨æ„ã€‚


---
## å¤–ã‚Œå€¤ã®é™¤å»

å¹³å‡å€¤ã‹ã‚‰æ¨™æº–åå·®ã®3å€ä»¥ä¸Šé›¢ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚’å–ã‚Šé™¤ãä¾‹:

```{r outlier}
result = diamonds %>%
  filter(abs(depth - mean(depth)) / sd(depth) < 3) %>%
  print()
```

å”¯ä¸€ã®æ–¹æ³•ã§ã¯ãªã„ã—ã€ãã‚‚ãã‚‚ã‚„ã‚‹ã¹ãã‹ã©ã†ã‹ã‚‚è¦æ¤œè¨


---
## æ¬ æå€¤ã®é™¤å» `tidyr::drop_na()`

(æŒ‡å®šã—ãŸåˆ—ã«) `NA` ãŒå«ã¾ã‚Œã¦ã‚‹è¡Œã‚’å‰Šé™¤ã™ã‚‹ã€‚

```{r drop_na}
df = tibble(x = c(1, 2, NA), y = c("a", NA, "b"))
df %>% drop_na()
```

å•: `starwars` ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§è©¦ã—ã¦ã¿ã‚ˆã†

```{r starwars-drop, echo=FALSE}
starwars
```

---
## æ¬ æå€¤ã®è£œå®Œ `tidyr::replace_na()`

æ¬ æå€¤ `NA` ã‚’ä»»æ„ã®å€¤ã§ç½®ãæ›ãˆã‚‹ã€‚

```{r replace_na}
df = tibble(x = c(1, 2, NA), y = c("a", NA, "b"))
df %>% replace_na(list(x = 0, y = "unknown"))
```

å•: `starwars` ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§è©¦ã—ã¦ã¿ã‚ˆã†


---
## æ¬ æå€¤ã®è£œå®Œ `dplyr::coalesce()`

å…ˆã«æŒ‡å®šã—ãŸåˆ—ãŒ `NA` ãªã‚‰æ¬¡ã®åˆ—ã®å€¤ã‚’æ¡ç”¨:

```{r coalesce}
y = c(1, 2, NA, NA, 5)
z = c(NA, NA, 3, 4, 5)
coalesce(y, z)
```

å‹ãŒç•°ãªã‚‹ã¨æ€’ã‚‰ã‚Œã‚‹:
```{r coalesce-type}
df = tibble(x = c(1, 2, NA), y = c("a", NA, "b"))
df %>%
  mutate(z = coalesce(x, y))
```

å•: `starwars` ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§è©¦ã—ã¦ã¿ã‚ˆã†


---
## æ¬ æå€¤ã¨ã¿ãªã™ `dplyr::na_if()`

ç‰¹å®šã®å€¤ã‚’ `NA` ã«ç½®ãæ›ãˆã‚‹:

```{r na_if}
df %>%
  mutate(x = na_if(x, 1), y = na_if(y, "a"))
```

å•: `starwars` ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§è©¦ã—ã¦ã¿ã‚ˆã†



---
## æ–‡å­—åˆ—

ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚€ã€‚ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚‚ä½¿ãˆã‚‹ã€‚

```{r string}
x = "This is a string"
y = 'If I want to include a "quote" inside a string, I use single quotes'
```

é–‰ã˜ãã³ã‚Œã‚‹ã¨å¤‰ãªçŠ¶æ…‹ã«ãªã‚‹ã®ã§ã€è½ã¡ç€ã„ã¦ <kbd>esc</kbd> or <kbd>ctrl</kbd><kbd>c</kbd>

```
> "This is a string without a closing quote
+
+
+ HELP I'M STUCK
```

<div style="text-align: right;">
<a class="url" href=https://r4ds.had.co.nz/strings.html>
https://r4ds.had.co.nz/strings.html
</a></div>

---
## Rå‚™ãˆä»˜ã‘ã®æ–‡å­—åˆ—æ©Ÿèƒ½ã¯ä½¿ã„ã«ãã„

-   ä½•ã‚’ã‚„ã‚‹é–¢æ•°ãªã®ã‹åå‰ã‹ã‚‰åˆ†ã‹ã‚Šã«ãã„<br>
    `grep`, `grepl`, `regexpr`, `gregexpr`, `regexec`<br>
    `sub`, `gsub`, `substr`, `substring`
-   ç¬¬ä¸€å¼•æ•°ã¯å¯¾è±¡æ–‡å­—åˆ—ï¼Ÿæ¤œç´¢ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼Ÿé–¢æ•°ã”ã¨ã«é•ã†ã€‚
-   `NA` ã«å¯¾ã™ã‚‹æŒ™å‹•ãŒå¾®å¦™


---
## stringr --- æ–‡å­—åˆ—å‡¦ç†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

<a href="https://stringr.tidyverse.org/">
<img src="/_img/hex-stickers/stringr.webp" width="120" align="right">
</a>

-   tidyverseã®ä¸€éƒ¨
-   ä½•ã‚’ã‚„ã‚‹é–¢æ•°ãªã®ã‹åå‰ã‹ã‚‰åˆ†ã‹ã‚Šã‚„ã™ã„
-   å¯¾è±¡æ–‡å­—åˆ—ãŒä¸€è²«ã—ã¦ç¬¬ä¸€å¼•æ•°ã§ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒäºŒç•ªç›®
-   å¼•æ•°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å„è¦ç´ ã®åå‰ã‚„ä½ç½®ã‚’ä¿æŒã™ã‚‹
    -   é•·ã•ã‚¼ãƒ­ã®å…¥åŠ›ã‹ã‚‰ã¯é•·ã•ã‚¼ãƒ­ã®å‡ºåŠ›
    -   å…¥åŠ›ã« `NA` ãŒå«ã¾ã‚Œã‚‹å ´åˆã¯å¯¾å¿œã™ã‚‹å‡ºåŠ›ã‚‚ `NA`
-   [ICUæ­£è¦è¡¨ç¾](http://userguide.icu-project.org/strings/regexp) ã®ä»•æ§˜ãŒæ˜ç¢º
-   [ãƒãƒ¼ãƒˆã‚·ãƒ¼ãƒˆ](https://github.com/rstudio/cheatsheets/raw/master/strings.pdf)


---
## æ–‡å­—åˆ—åŸºæœ¬æ“ä½œ

```{r str_length}
fruit4 = head(fruit, 4L) %>% print()
str_length(fruit4)            # é•·ã•
str_sub(fruit4, 2, 4)         # éƒ¨åˆ†åˆ—
str_c(1:4, " ", fruit4, "!")  # çµåˆ
```


---
## ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã€æ­£è¦è¡¨ç¾

å˜ç´”ãªä¸€è‡´ã ã‘ã˜ã‚ƒãªãã€ã„ã‚ã‚“ãªæ¡ä»¶ã§ãƒãƒƒãƒãƒ³ã‚°ã§ãã‚‹:

```{r pattern}
# aã§å§‹ã¾ã‚‹
str_subset(fruit, "^a")

# rã§çµ‚ã‚ã‚‹
str_subset(fruit, "r$")

# è‹±æ•°å­—3-4æ–‡å­—
str_subset(fruit, "^\\w{3,4}$")
```


---
## æ­£è¦è¡¨ç¾: ã‚ˆãä½¿ã†ç‰¹æ®Šæ–‡å­—

| ãƒ¡ã‚¿æ–‡å­— | æ„å‘³ | &emsp;&emsp;&emsp; | æ¼”ç®—å­ | æ„å‘³ |
| ---- | ---- | --- | ---- | ---- |
| `\d` | æ•°å­—   | | `?`  | 0å›ã‹1å› |
| `\s` | ç©ºç™½   | | `*`  | 0å›ä»¥ä¸Šç¹°ã‚Šè¿”ã— |
| `\w` | è‹±æ•°å­— | | `+`  | 1å›ä»¥ä¸Šç¹°ã‚Šè¿”ã— |
| `.`  | ä½•ã§ã‚‚ | | `{n,m}` | nå›ä»¥ä¸Šmå›ä»¥ä¸‹ |
| `^`  | è¡Œé ­   | | `XXX(?=YYY)`  | YYYã«å…ˆç«‹ã¤XXX |
| `$`  | è¡Œæœ«   | | `(?<=YYY)XXX`  | YYYã«ç¶šãXXX |

Ræ–‡å­—åˆ—ã§ã¯ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’é‡ã­ã‚‹å¿…è¦ãŒã‚ã‚‹, e.g., `"\\d"`.<br>
`\D`, `\S`, `W` ã®ã‚ˆã†ã«å¤§æ–‡å­—ã«ã™ã‚‹ã¨åè»¢ã€‚

<div style="text-align: right;"><a class="url" href="http://userguide.icu-project.org/strings/regexp">
http://userguide.icu-project.org/strings/regexp
</a></div>

å•: `str_subset(fruit, "PATTERN")` ã‚’ã„ã‚ã„ã‚è©¦ã—ã¦ã¿ã‚ˆã†


---
## æ¤œå‡º `str_detect()`

ãƒãƒƒãƒã™ã‚‹ã‹ã©ã†ã‹ `TRUE`/`FALSE` ã‚’è¿”ã™ã€‚
```{r str_detect}
fruit4 = head(fruit, 4L)
str_detect(fruit4, "^a")
```

å•: `starwars` ã® `name` åˆ—ã§ `filter()` ã—ã¦ã¿ã‚ˆã†

```{r starwars-detect, echo=FALSE}
starwars
```

---
## æŠ½å‡º `str_extract()`

ãƒãƒƒãƒã—ãŸéƒ¨åˆ†æ–‡å­—åˆ—ã‚’å–ã‚Šå‡ºã™ã€‚ã—ãªã‹ã£ãŸè¦ç´ ã«ã¯ `NA`ã€‚
```{r str_extract}
fruit4 = head(fruit, 4L)
str_extract(fruit4, "^a..")
```

å•: `diamonds` ã® `clarity` åˆ—ã‹ã‚‰æ•°å­—ã‚’å–ã‚Šé™¤ã„ã¦ã¿ã‚ˆã†

```{r diamonds-extract, echo=FALSE}
diamonds
```


---
## ç½®æ› `str_replace()`

ã‚«ãƒƒã‚³ `()` ã§å›²ã‚“ã ãƒãƒƒãƒãƒ³ã‚°ã¯å¾Œã§å‚ç…§ã§ãã‚‹:
```{r str_replace}
fruit4 = head(fruit, 4L)
str_replace(fruit4, "..$", "!!")
str_replace(fruit4, "(..)$", "!!\\1")
```

å•: `starwars` ã® `name` åˆ—ã®æ•°å­—ã‚’å…¨éƒ¨ã‚¼ãƒ­ã«ã—ã¦ã¿ã‚ˆã†

```{r starwars-replace, echo=FALSE}
starwars
```


---
## å½¢å¼ã‚’å¤‰ãˆã‚‹ãƒ»æ•´ãˆã‚‹

```{r upperlower}
fruit4 = head(fruit, 4L)
str_to_upper(fruit4)              # å¤§æ–‡å­—ã«
str_pad(fruit4, 8, "left", "_")   # å¹…ã‚’åŸ‹ã‚ã‚‹
```

[`stringi`](http://www.gagolewski.com/software/stringi/) ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ã•ã‚‰ã«å¤šæ©Ÿèƒ½
```{r stringi}
stringi::stri_trans_nfkc("ï½¶ï¾€ï½¶ï¾…")  # åŠè§’ã‚«ãƒŠã‚’å…¨è§’ã«
```

---
## æ–‡å­—åˆ—ã‹ã‚‰åˆ¥ã®å‹ã«

<a href="https://readr.tidyverse.org/">
<img src="/_img/hex-stickers/readr.webp" width="120" align="right">
</a>

ã“ã‚Œã¯stringrã§ã¯ãªãreadrã®æ‹…å½“:

```{r parse-character}
parse_number(c("p = 0.02 *", "N_A = 6e23"))
parse_double(c("0.02", "6e23"))   # ç•°ç‰©ã«ã¯è­¦å‘Š
parse_logical(c("1", "true", "0", "false"))
parse_date("2020-06-03")
```

---
## å› å­å‹ `factor`

ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ«å¤‰æ•°ã‚’æ‰±ã†ãŸã‚ã®å‹ã€‚æ–‡å­—åˆ—ã£ã½ã„ã‘ã©ä¸­èº«ã¯æ•°ã€‚

```{r iris}
iris = tibble::as_tibble(iris) %>% print()
levels(iris[["Species"]])
```

<div style="text-align: right;"><a class="url" href="https://r4ds.had.co.nz/factors.html">
https://r4ds.had.co.nz/factors.html
</a></div>


---
## å› å­å‹ `factor`: æ–‡å­—åˆ—ã¨ã®é•ã„1

å–ã‚Šã†ã‚‹å€¤ (levels) ãŒæ—¢çŸ¥ã€‚

typoãŒã‚ã‚‹ã¨ `NA` æ‰±ã„ã€‚

```{r factor}
month_levels = c(
  "Jan", "Feb", "Mar", "Apr", "May", "Jun",
  "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
)
x2 = c("Dec", "Apr", "Jam", "Mar")
factor(x2, levels = month_levels)
```

---
## å› å­å‹ `factor`: æ–‡å­—åˆ—ã¨ã®é•ã„2

é †åºãŒã‚ã‚‹ã€‚

æ–‡å­—åˆ—ã‚’ã‚½ãƒ¼ãƒˆã™ã‚‹ã¨å½“ç„¶ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã«ãªã‚‹ã‘ã©ã€<br>
å› å­å‹ã«ã¯ãã†ã˜ã‚ƒãªã„é †åºã‚’æŒãŸã›ã‚‰ã‚Œã‚‹:

```{r sort}
x1 = c("Dec", "Apr", "Jan", "Mar")
sort(x1)
y1 = factor(x1, levels = month_levels)
as.integer(y1)
```


---
## å› å­å‹ `factor`: é †åºã®æƒ…å ±ã¯ä½œå›³ã§ç”Ÿãã‚‹

æ–‡å­—åˆ—ãªã‚‰ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã€å› å­å‹ãªã‚‰ä»»æ„æŒ‡å®šå¯èƒ½ã€‚<br>
é »åº¦é †ã«ã™ã‚‹ä¾‹:

```{r fct_infreq, fig.height = 4}
diamonds %>%
  mutate(color = fct_infreq(color)) %>%
  ggplot() + aes(x = color) +
  geom_bar() + coord_flip()
```

---
## tidyverse ã®å› å­å‹æ‹…å½“ã¯ forcats

<a href="https://forcats.tidyverse.org/">
<img src="/_img/hex-stickers/forcats.webp" width="120" align="right">
</a>

- `fct_reorder()`: åˆ¥ã®å¤‰æ•°ã«å¿œã˜ã¦é †åºã‚’ä¸¦ã¹æ›¿ãˆ
- `fct_infreq()`: é »åº¦ã«å¿œã˜ã¦é †åºã‚’ä¸¦ã¹æ›¿ãˆ
- `fct_relevel()`: ã™ã¹ã¦æ‰‹å‹•ã§å†è¨­å®š
- `fct_lump()`: å°‘ãªã™ãã‚‹ã‚«ãƒ†ã‚´ãƒªã‚’"ãã®ä»–"ã¨ã—ã¦ã¾ã¨ã‚ã‚‹


---
## ãƒ€ãƒŸãƒ¼å¤‰æ•°ã«å¤‰æ›

ã‚¤ãƒã‚¼ãƒ­ã®å€¤ã‚’æŒãŸã›ã¦æ¨ªåºƒã«å¤‰å½¢ã™ã‚‹ã®ã¨ç­‰ä¾¡ã€‚

```{r dummy}
iris %>%
  rowid_to_column() %>% select(-starts_with("Sepal")) %>%
  mutate(value = 1L) %>%
  pivot_wider(names_from = Species, values_from = value, values_fill = c(value = 0L))
```

å•: ã“ã‚Œã®é€†å‘ãã‚’ã‚„ã£ã¦ã¿ã‚ˆã†


---
## æ—¥æ™‚å‹: POSIXct, POSIXlt

- POSIXct: ã‚¨ãƒãƒƒã‚¯ã‹ã‚‰ã®çµŒéç§’æ•°ã€‚æ¯”è¼ƒã‚„å·®åˆ†ãªã©ã‚’å–ã‚Šã‚„ã™ã„ã€‚
- POSIXlt: list(å¹´, æœˆ, æ—¥, æ™‚, åˆ†, ç§’)ã€‚å˜ä½ã”ã¨ã«æŠœãå‡ºã—ã‚„ã™ã„ã€‚

```{r datetime}
now = "2020-06-03 13:00:00"
ct = as.POSIXct(now)
unclass(ct)
lt = as.POSIXlt(now)
unclass(lt) %>% as_tibble()
```

ç´ ã®Rã§ã‚‚æ‰±ãˆã‚‹ã‘ã© lubridate ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã†ã¨ã‚‚ã£ã¨æ¥½ã«ã€‚

---
## lubridate --- æ—¥æ™‚å‹å‡¦ç†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

<a href="https://lubridate.tidyverse.org/">
<img src="/_img/hex-stickers/lubridate.webp" width="120" align="right">
</a>

æ—¥æ™‚å‹ã¸ã®å¤‰æ›:
```{r lubridate-parse}
ymd(c("20200603", "2020-06-03", "20/6/3"))
```

æ—¥æ™‚å‹ã‹ã‚‰å˜ä½ã”ã¨ã«å€¤ã‚’å–å¾—:
```{r lubridate-get}
today = ymd(20200603)
month(today)
wday(today, label = TRUE)
```

[ãƒãƒ¼ãƒˆã‚·ãƒ¼ãƒˆ](https://github.com/rstudio/cheatsheets/raw/master/lubridate.pdf)

---
## çµ‚ç›¤ã®ã¾ã¨ã‚

- vectorã«ã¯å‹ãŒã‚ã‚‹: æ–‡å­—åˆ—ã€æ•°å€¤ã€å› å­ã€æ—¥æ™‚ã€etc.
- æ–‡å­—åˆ—ã‚’æ‰±ã†ã«ã¯ [stringr](https://stringr.tidyverse.org/)
    - æ­£è¦è¡¨ç¾ã¯å¼·åŠ›ãƒ»æ±ç”¨çš„
- å› å­ã‚’æ‰±ã†ã«ã¯ [forcats](https://forcats.tidyverse.org/)
    - çŸ¥ã£ã¦ãŠãã¨ä½œå›³ã§æœ‰åˆ©
- æ—¥æ™‚ã‚’æ‰±ã†ã«ã¯ [lubridate](https://lubridate.tidyverse.org/)

å„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒãƒ¼ãƒˆã‚·ãƒ¼ãƒˆ.pdfã‚’æ‰‹å…ƒã«æŒã£ã¦ãŠãã¨ä¾¿åˆ©ã€‚

---
## Reference

R for Data Science --- Hadley Wickham and Garrett Grolemund
: <https://r4ds.had.co.nz/>,
  [Paperback](https://amzn.to/2tbRmVc),
  [æ—¥æœ¬èªç‰ˆæ›¸ç±(Rã§ã¯ã˜ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ã‚¹)](https://amzn.to/2yyFRKt)

- [æœ¬æ©‹æ™ºå…‰ã€Œå‰å‡¦ç†å¤§å…¨ã€](https://www.amazon.co.jp/dp/4774196479/ref=as_li_ss_tl?ie=UTF8&linkCode=ll1&tag=heavywatal-22&linkId=8a3fd4e9a0c944b1b41242bbab8d147b)
- [æ¾æ‘ã‚‰ã€ŒRãƒ¦ãƒ¼ã‚¶ã®ãŸã‚ã®RStudio[å®Ÿè·µ]å…¥é–€ã€(å®‡å®™æœ¬)](https://amzn.to/3eBprm5)

æ•´ç„¶ãƒ‡ãƒ¼ã‚¿ã¨ã¯ä½•ã‹ --- [@f_nisihara](https://twitter.com/f_nisihara)
: [Speaker Deck](https://speakerdeck.com/fnshr/zheng-ran-detatutenani),
  [Colorless Green Ideas](https://id.fnshr.info/2017/01/09/tidy-data-intro/)

Official documents:
: [tidyverse](https://www.tidyverse.org/),
  [dplyr](https://dplyr.tidyverse.org/),
  [tidyr](https://tidyr.tidyverse.org/),
  [purrr](https://purrr.tidyverse.org/),
  [tibble](https://tibble.tidyverse.org/),
  [readr](https://readr.tidyverse.org/),
  [stringr](https://stringr.tidyverse.org/),
  [forcats](https://forcats.tidyverse.org/),
  [lubridate](https://lubridate.tidyverse.org/)

Older versions
: ã€Œ[Rã«ã‚„ã‚‰ã›ã¦æ¥½ã—ã‚ˆã† â€” ãƒ‡ãƒ¼ã‚¿ã®å¯è¦–åŒ–ã¨ä¸‹ã”ã—ã‚‰ãˆ](https://heavywatal.github.io/slides/nagoya2018/)ã€
   å²©åµœèˆª 2018
: ã€ŒRã‚’ç”¨ã„ãŸãƒ‡ãƒ¼ã‚¿è§£æã®åŸºç¤ã¨å¿œç”¨ã€çŸ³å·ç”±å¸Œ 2019 åå¤å±‹å¤§å­¦
: ã€Œ[Rã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿å‰å‡¦ç†å®Ÿç¿’](https://heavywatal.github.io/slides/tmd2019/)ã€
   å²©åµœèˆª 2019 æ±äº¬åŒ»ç§‘æ­¯ç§‘å¤§

<a href="4-statistics.html" rel="next" class="readmore">
4. Statistical analysis with R
</a>
