```{r, setup-common}
#| file: "setup.R"
#| echo: false
#| results: "asis"
```
```{r, setup-local}
#| include: false
#| cache: false
```


---
## ä½œæ¥­å†é–‹ã€å‡ºæ¬ ç¢ºèª

1. `r-training-2025.Rproj` ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã€‚\
   æ­£ã—ã„ working directory ã§RStudioãŒèµ·å‹•ã•ã‚Œã‚‹ã€‚
1. [åˆæ—¥ã¨åŒã˜æ‰‹é †](1-introduction.html#/28)ã§å‡ºæ¬ ç¢ºèªã€‚
1. ä»Šæ—¥ã®ã¶ã‚“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ–°è¦ä½œæˆã—ã€å¥½ããªåå‰ã§ä¿å­˜ã€‚
1. [tidyverseã®èª­ã¿è¾¼ã¿](2-visualization.html#/23)ã‚„[ãƒ‘ãƒ¬ãƒƒãƒˆè¨­å®š](2-visualization.html#/36)ãªã©ã€
   ãŠã¾ã˜ãªã„ã‚’ã¾ãšå®Ÿè¡Œã€‚


---
## ã“ã®å®Ÿç¿’ã®ç›®æ¨™

### âœ… <del>ç”Ÿç‰©å­¦ç ”ç©¶ã«ã¯ãƒ‡ãƒ¼ã‚¿ã¨ãƒ¢ãƒ‡ãƒ«ãŒå¿…é ˆã ã¨èªè­˜</del>

### âœ… <del>å†ç¾å¯èƒ½ãªè§£æã‚’æ¥½ã«ã‚„ã‚ŠãŸã„æ°—æŒã¡ã«ãªã‚‹</del>

### âœ… <del>å¿…è¦ãªæ–¹æ³•ã‚’èª¿ã¹ã€å®Ÿè·µã™ã‚‹åŠ›ã‚’ã¤ã‘ã‚‹</del>

### â¬œ ãƒ‡ãƒ¼ã‚¿è§£æã®åŸºæœ¬ã«è§¦ã‚Œã‚‹

<hr>

å€‹ã€…ã®æ–¹æ³•ã¯è¦šãˆãªãã¦ã‚‚å¤§ä¸ˆå¤«ï¼\
å¿˜ã‚Œã¦ã¯èª¿ã¹ã€ã‚’ä½•åº¦ã‚‚ç¹°ã‚Šè¿”ã—ãªãŒã‚‰æŸ“ã¿è¾¼ã¾ã›ã¦ã„ã“ã†ã€‚

---
## ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦ã‚„ã‚ŠãŸã„ã“ã¨

- ç¾è±¡ã‚’**ç†è§£**ã—ãŸã„
- å°†æ¥ã‚’**äºˆæ¸¬**ã—ãŸã„
- ã‚‚ã®ã‚’**åˆ†é¡ãƒ»åˆ¤åˆ¥**ã—ãŸã„
- æŒ™å‹•ã‚’**åˆ¶å¾¡**ã—ãŸã„
- æ–°ã—ã„ä½•ã‹ã‚’**ç”Ÿæˆ**ã—ãŸã„

ãã®ãŸã‚ã«è§£æã¯å¿…è¦ï¼Ÿ
æœªåŠ å·¥ã®ç”Ÿãƒ‡ãƒ¼ã‚¿ã“ãå®ï¼Ÿ


---
## åˆæ—¥ã‚’æŒ¯ã‚Šè¿”ã‚‹

<iframe width="600" height="450" src="./1-introduction.html#/5"></iframe>
<iframe width="600" height="450" src="./1-introduction.html#/6"></iframe>
<iframe width="600" height="450" src="./1-introduction.html#/7"></iframe>
<iframe width="600" height="450" src="./1-introduction.html#/8"></iframe>


---
## ãƒ‡ãƒ¼ã‚¿ç§‘å­¦ã«ãŠã‘ã‚‹æ•°ç†ãƒ¢ãƒ‡ãƒ«

ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚’ã†ã¾ãçœŸä¼¼ã§ããã†ãªä»®å®šã®æ•°å¼è¡¨ç¾ã€‚\
e.g., å¤§ãã„ã»ã©é«˜ãå£²ã‚Œã‚‹: $\text{price} = A \times \text{carat} + B + \epsilon$

```{r, lm-diamonds}
#| echo: false
#| fig.height: 5
#| fig.width: 6
diamonds |>
  dplyr::filter(clarity %in% c("I1", "SI2", "IF")) |>
  ggplot(aes(carat, price)) +
  geom_point(alpha = 0.3, size = 3) +
  stat_smooth(formula = y ~ x, method = lm, se = FALSE) +
  coord_cartesian(ylim = c(0, 20000)) +
  labs(title = "Diamonds") +
  theme_classic(base_size = 22)
```

æ–°ã—ãæ¡ã‚ŒãŸãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰ã®ä¾¡æ ¼äºˆæƒ³ã¨ã‹ã«ã‚‚ä½¿ãˆã‚‹ã€‚

ã“ã®ã‚ˆã†ã«ã€ŒYã‚’Xã®é–¢æ•°ã¨ã—ã¦è¡¨ã™ã€ã‚ˆã†ãªãƒ¢ãƒ‡ãƒ«ã‚’**å›å¸°**ã¨å‘¼ã¶ã€‚


---
## ã¡ã‚‡ã£ã¨ãšã¤ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã‚’ç™ºå±•ã•ã›ã¦ã„ã

<figure style="float: right;">
<a href="https://kuboweb.github.io/-kubo/ce/IwanamiBook.html">
<img src="../tokiomarine2021/image/kubo-book.jpg" width="360" alt="ãƒ‡ãƒ¼ã‚¿è§£æã®ãŸã‚ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€ ä¹…ä¿æ‹“å¼¥ 2012">
</a>
</figure>

**ç·šå½¢ãƒ¢ãƒ‡ãƒ« LM** (å˜ç´”ãªç›´ç·šã‚ã¦ã¯ã‚)ã€€[(ğŸ‘ˆ #7 ä»Šå›)](7-distribution.html)

<span style="color: #888888;">&nbsp; &nbsp; â†“ ã„ã‚ã‚“ãªç¢ºç‡åˆ†å¸ƒã‚’æ‰±ã„ãŸã„</span>

**ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ« GLM** [(#8 æ¬¡å›)](8-glm.html)

<span style="color: #888888;">&nbsp; &nbsp; â†“ å€‹ä½“å·®ãªã©ã®å¤‰é‡åŠ¹æœã‚’æ‰±ã„ãŸã„</span>

**ä¸€èˆ¬åŒ–ç·šå½¢æ··åˆãƒ¢ãƒ‡ãƒ« GLMM**

<span style="color: #888888;">&nbsp; &nbsp; â†“ ã‚‚ã£ã¨è‡ªç”±ãªãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã‚’ï¼</span>

**éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ« HBM**

<cite>[ãƒ‡ãƒ¼ã‚¿è§£æã®ãŸã‚ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€](https://amzn.to/33suMIZ) ä¹…ä¿æ‹“å¼¥ 2012 ã‚ˆã‚Šæ”¹å¤‰</cite>

<hr>
<cite>

[Data Science Hill Climb 2024 (æ±äº¬æµ·ä¸Š) ã§ã®è¬›ç¾© (~12æ™‚é–“)](https://heavywatal.github.io/slides/tokiomarine2024/)
ã®æŠœç²‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (~2æ™‚é–“)ã€‚

</cite>


---
## å›å¸°ãƒ¢ãƒ‡ãƒ«ã®2æ®µéš

1. Define a **family of models**: ã ã„ãŸã„ã©ã‚“ãªå½¢ã‹ã€å¼ã‚’ãŸã¦ã‚‹
    - ç›´ç·š: $y = a_1 + a_2 x$
    - å¯¾æ•°: $\log(y) = a_1 + a_2 x$
    - äºŒæ¬¡æ›²ç·š: $y = a_1 + a_2 x^2$

2. Generate a **fitted model**: ãƒ‡ãƒ¼ã‚¿ã«åˆã†ã‚ˆã†ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´
    - $y = 3x + 7$
    - $y = 9x^2$

<cite>
<a href="https://r4ds.had.co.nz/model-basics.html" class="url">https://r4ds.had.co.nz/model-basics.html</a>
</cite>

---
## ãŸã¶ã‚“èº«é•·ãŒé«˜ã„ã»ã©ä½“é‡ã‚‚é‡ã„

ãªã‚“ã¨ãªã $y = a x + b$ ã§ã„ã„ç·šãŒå¼•ã‘ãã†\
&nbsp;

```{r, df-linear}
#| echo: false
set.seed(19937)
n = 50
df_weight = tibble::tibble(
  height = rnorm(n, 1.70, 0.05),
  bmi = rnorm(n, 22, 1),
  weight = bmi * (height**2)
)
```
```{r, weight-height}
#| echo: false
#| fig.height: 5.5
#| fig.width: 5.5
p_weight = ggplot(df_weight) +
  aes(height, weight) +
  geom_point(alpha = 0.5) +
  theme_bw(base_size = 22) +
  theme(panel.grid = element_blank())
p_weight
```


---
## ãŸã¶ã‚“èº«é•·ãŒé«˜ã„ã»ã©ä½“é‡ã‚‚é‡ã„

ãªã‚“ã¨ãªã $y = a x + b$ ã§ã„ã„ç·šãŒå¼•ã‘ãã†\
ã˜ã‚ƒã‚å‚¾ã *a* ã¨åˆ‡ç‰‡ *b*ã€ã©ã†æ±ºã‚ã‚‹ï¼Ÿ

```{r, weight-lines}
#| echo: false
#| fig.height: 5.5
#| fig.width: 5.5
set.seed(19937)
df_ab = tibble(intercept = runif(n, -50, 50), slope = runif(n, -200, 200)) |>
  dplyr::mutate(intercept = intercept - 1.7 * slope + 50)
p_weight +
  geom_abline(data = df_ab, aes(intercept = intercept, slope = slope), color = "#3366ff", alpha = 0.5)
```


---
## æœ€å°äºŒä¹—æ³• (Ordinary Least Square: OLS)

<span style="color: #3366ff">å›å¸°ç›´ç·š</span>ã‹ã‚‰ã®<strong style="color: #E69F00">æ®‹å·®</strong>å¹³æ–¹å’Œ(RSS)ã‚’æœ€å°åŒ–ã™ã‚‹ã€‚

```{r, weight-residual}
#| echo: false
#| fig.height: 5.5
#| fig.width: 11
predict_weight = function(parameters, data) {
  parameters[1] + parameters[2] * data$height
}

add_pred_weight = function(data, parameters) {
  dplyr::mutate(data, pred = predict_weight(param1, data = data))
}

rss_weight = function(parameters, data) {
  pred = predict_weight(parameters, data)
  sqdev = (data[["weight"]] - pred)**2
  sum(sqdev)
}
# rss_weight(c(40, -5), df_weight)

param1 = c(10, 30)
lm_weight = lm(weight ~ height, data = df_weight)
rss1 = rss_weight(param1, df_weight)
rss2 = rss_weight(lm_weight$coefficients, df_weight)
stopifnot(abs(sum(lm_weight$residuals**2) - rss2) < 1e-6)

p1 = p_weight %+%
  add_pred_weight(df_weight, param1) +
  geom_line(aes(y = pred), color = "#3366ff") +
  geom_linerange(aes(ymin = weight, ymax = pred), color = "#E69F00")
p2 = p1 %+%
  (df_weight |> modelr::add_predictions(lm_weight))
cowplot::plot_grid(nrow = 1L,
  p1 + annotate("text", x = -Inf, y = Inf, label = sprintf("RSS = %.1f", rss1), size = 8, hjust = -0.1, vjust = 2),
  p2 + annotate("text", x = -Inf, y = Inf, label = sprintf("RSS = %.1f", rss2), size = 8, hjust = -0.1, vjust = 2))
```



---
## æ®‹å·®å¹³æ–¹å’Œ(RSS)ãŒæœ€å°ã¨ãªã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¢ã›

ãƒ©ãƒ³ãƒ€ãƒ ã«è©¦ã—ã¦ã¿ã¦ã€ä¸Šä½ã®ã‚‚ã®ã‚’æ¡ç”¨ã€‚\
ã“ã®ç¨‹åº¦ã®è©¦è¡Œå›æ•°ã§ã¯è¶³ã‚Šãªãã†ã€‚

```{r, weight-goodlines}
#| echo: false
#| fig.height: 5.5
#| fig.width: 11
set.seed(19937)
n = 200
df_ab_random = tibble::tibble(intercept = runif(n, -200, 100), slope = runif(n, 0, 150)) |>
  dplyr::mutate(rss = purrr::map2_dbl(intercept, slope, ~ rss_weight(c(.x, .y), data = df_weight)))
p_ab = ggplot(df_ab_random) +
  aes(intercept, slope) +
  geom_point(data = \(x) dplyr::filter(x, rank(rss) < 6), shape = 1, size = 4) +
  geom_point(aes(color = log10(rss))) +
  theme_bw(base_size = 20) +
  theme(panel.grid = element_blank(), legend.position = c(0.99, 0.99), legend.justification = c(1, 1))

df_randmin = df_ab_random |> dplyr::slice_min(rss, n = 5)
p2 = p_weight + geom_abline(
  aes(slope = slope, intercept = intercept),
  data = df_randmin, color = "#3366ff", alpha = 0.5
)
cowplot::plot_grid(p_ab, p2, nrow = 1L)
```

---
## æ®‹å·®å¹³æ–¹å’Œ(RSS)ãŒæœ€å°ã¨ãªã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¢ã›

**ã‚°ãƒªãƒƒãƒ‰ã‚µãƒ¼ãƒ**: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç©ºé–“ã®ä¸€å®šç¯„å›²å†…ã‚’å‡ç­‰ã«è©¦ã™ã€‚\
ã•ã£ãã®ãƒ©ãƒ³ãƒ€ãƒ ã‚ˆã‚Šã¯ã¡ã‚‡ã£ã¨ãƒã‚·ã‹ã€‚

```{r, weight-grid}
#| echo: false
#| fig.height: 5.5
#| fig.width: 11
df_ab_grid = tidyr::crossing(intercept = seq(-100, -30, 4), slope = seq(50, 100, 4)) |>
  dplyr::mutate(rss = purrr::map2_dbl(intercept, slope, ~ rss_weight(c(.x, .y), data = df_weight)))

p1 = p_ab %+% df_ab_grid

df_gridmin = df_ab_grid |> dplyr::slice_min(rss, n = 5)
p2 = p_weight + geom_abline(
  aes(slope = slope, intercept = intercept),
  data = df_gridmin, color = "#3366ff", alpha = 0.5
)
cowplot::plot_grid(p1, p2, nrow = 1L)
```

ã“ã†ã—ãŸ**æœ€é©åŒ–**ã®æ‰‹æ³•ã¯ã„ã‚ã„ã‚ã‚ã‚‹ã‘ã©ã€ã“ã“ã§ã¯æ‰±ã‚ãªã„ã€‚


---
## ã“ã‚Œãã‚‰ã„ãªã‚‰ä¸€ç¬ã§è¨ˆç®—ã—ã¦ã‚‚ã‚‰ãˆã‚‹

```{r, lm}
par_init = c(intercept = 0, slope = 0)
result = optim(par_init, fn = rss_weight, data = df_weight)
result$par
```

```{r, weight-lm}
#| echo: false
#| fig.height: 4
#| fig.width: 4
label = sprintf("y = %.1f x + %.1f", result$par["slope"], result$par["intercept"])
p_weight +
  stat_smooth(formula = y ~ x, method = lm, se = FALSE, color = "#3366ff", alpha = 0.5) +
  annotate("text", x = -Inf, y = Inf, hjust = -0.1, vjust = 2, label = label)
```

ä¸Šè¨˜ã‚³ãƒ¼ãƒ‰ã¯æœ€é©åŒ–ä¸€èˆ¬ã®æ›¸ãæ–¹ã€‚\
å›å¸°ãŒç›®çš„ãªã‚‰æ¬¡ãƒšãƒ¼ã‚¸ã®ã‚ˆã†ã«ã™ã‚‹ã®ãŒæ¥½ â†’

---
## `lm()` ã§ç›´ç·šã‚ã¦ã¯ã‚ã—ã¦ã¿ã‚‹

```{r, lm-mpg}
#| fig.height: 3
#| fig.width: 3
fit = lm(data = mpg, formula = hwy ~ displ)
broom::tidy(fit)

mpg_added = modelr::add_predictions(mpg, fit, type = "response")
ggplot(mpg_added) + aes(displ, hwy) + geom_point() +
  geom_line(aes(y = pred), linewidth = 1, color = "#3366ff")
```

ğŸ”° `diamonds` ã¨ `iris` ã§ã‚‚ `lm()` ã‚’è©¦ã—ã¦ã¿ã‚ˆã†ã€‚


---
## ä½•ã§ã‚‚ã‹ã‚“ã§ã‚‚ç›´ç·šã‚ã¦ã¯ã‚ã§ã¯ã‚ˆã‚ã—ããªã„

```{r, df-pois}
#| echo: false
set.seed(24601)
n = 300L
a = 3
b = -3
df_pois = tibble::tibble(
  body_mass = runif(n, 0.4, 1.7),
  num_seeds = rpois(n, exp(a * body_mass + b))
)
```
```{r, lm-bad}
#| echo: false
#| fig.height: 5.5
#| fig.width: 5.5
x_breaks = c(0.5, 1.0, 1.5)
coeff = lm(num_seeds ~ body_mass, data = df_pois)$coefficients
df_lm = tidyr::crossing(body_mass = x_breaks, num_seeds = seq(-5, 20, 0.1)) |>
  dplyr::mutate(density = dnorm(num_seeds, coeff[1] + coeff[2] * body_mass, 1.4)) |>
  dplyr::filter(density > 1e-4)

p_pois = ggplot(df_pois) +
  aes(body_mass, num_seeds) +
  ggridges::geom_vridgeline(data = df_lm, aes(width = density * 0.4, group = body_mass), linetype = 0, alpha = 0) +
  geom_point(alpha = 0.5, shape = 16, size = 2) +
  scale_x_continuous(breaks = x_breaks) +
  coord_cartesian(ylim = c(-5, 15)) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank())
p_pois + stat_smooth(formula = y ~ x, method = lm, se = FALSE)
```

- è¦³å¯Ÿãƒ‡ãƒ¼ã‚¿ã¯å¸¸ã«**æ­£ã®å€¤**ãªã®ã«äºˆæ¸¬ãŒè² ã«çªå…¥ã—ã¦ãªã„ï¼Ÿ
- **ç¸¦è»¸ã¯æ•´æ•°**ã€‚ã—ã‹ã‚‚ã®**ã°ã‚‰ã¤ã**ãŒæ¨ªè»¸ã«å¿œã˜ã¦å¤‰åŒ–ï¼Ÿ


---
## ä½•ã§ã‚‚ã‹ã‚“ã§ã‚‚ç›´ç·šã‚ã¦ã¯ã‚ã§ã¯ã‚ˆã‚ã—ããªã„

```{r, glm-better}
#| echo: false
#| fig.height: 5.5
#| fig.width: 11
p_lm = p_pois +
  stat_smooth(formula = y ~ x, method = lm, se = FALSE) +
  ggridges::geom_vridgeline(aes(width = density * 0.4, group = body_mass), df_lm,
                            fill = "#56B4E9AA", linetype = 0)
# p_lm

df_ridges = tidyr::crossing(body_mass = x_breaks, num_seeds = seq_len(30L) - 1L) |>
  dplyr::mutate(density = dpois(num_seeds, exp(a * body_mass + b))) |>
  dplyr::filter(density > 1e-4)
df_bars = df_ridges |> wtl::ridges2bars(num_seeds, density)

p_poisson = p_pois +
  stat_smooth(formula = y ~ x, method = glm, method.args = list(family = poisson), se = FALSE) +
  ggridges::geom_vridgeline(aes(width = density * 0.5, group = body_mass), df_bars,
                            fill = "#56B4E9AA", linetype = 0)
# p_poisson

cowplot::plot_grid(p_lm, p_poisson, nrow = 1L)
```

- è¦³å¯Ÿãƒ‡ãƒ¼ã‚¿ã¯å¸¸ã«**æ­£ã®å€¤**ãªã®ã«äºˆæ¸¬ãŒè² ã«çªå…¥ã—ã¦ãªã„ï¼Ÿ
- **ç¸¦è»¸ã¯æ•´æ•°**ã€‚ã—ã‹ã‚‚ã®**ã°ã‚‰ã¤ã**ãŒæ¨ªè»¸ã«å¿œã˜ã¦å¤‰åŒ–ï¼Ÿ
- **ãƒ‡ãƒ¼ã‚¿ã«åˆã‚ã›ãŸçµ±è¨ˆãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã†ã¨ãƒã‚·**


---
## ã¡ã‚‡ã£ã¨ãšã¤ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã‚’ç™ºå±•ã•ã›ã¦ã„ã

**ç·šå½¢ãƒ¢ãƒ‡ãƒ« LM** (å˜ç´”ãªç›´ç·šã‚ã¦ã¯ã‚)

<span style="color: #888888;">&nbsp; &nbsp; â†“ ã„ã‚ã‚“ãª<span class="fragment highlight-blue custom bold">ç¢ºç‡åˆ†å¸ƒ</span>ã‚’æ‰±ã„ãŸã„</span>

**ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ« GLM**

<span style="color: #888888;">&nbsp; &nbsp; â†“ å€‹ä½“å·®ãªã©ã®å¤‰é‡åŠ¹æœã‚’æ‰±ã„ãŸã„</span>

**ä¸€èˆ¬åŒ–ç·šå½¢æ··åˆãƒ¢ãƒ‡ãƒ« GLMM**

<span style="color: #888888;">&nbsp; &nbsp; â†“ ã‚‚ã£ã¨è‡ªç”±ãªãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã‚’ï¼</span>

**éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ« HBM**

<cite>[ãƒ‡ãƒ¼ã‚¿è§£æã®ãŸã‚ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€](https://amzn.to/33suMIZ) ä¹…ä¿æ‹“å¼¥ 2012 ã‚ˆã‚Šæ”¹å¤‰</cite>


---
## ç¢ºç‡åˆ†å¸ƒ

ç™ºç”Ÿã™ã‚‹äº‹è±¡(å€¤)ã¨é »åº¦ã®é–¢ä¿‚ã€‚

æ‰‹å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚’æ•°ãˆã¦ä½œã‚‹ã®ãŒ**çµŒé¨“åˆ†å¸ƒ**\
e.g., ã‚µã‚¤ã‚³ãƒ­ã‚’12å›æŠ•ã’ãŸçµæœã€å­¦ç”Ÿ1000äººã®èº«é•·

```{r, distribution}
#| echo: false
#| fig.height: 4.4
#| fig.width: 8.8
set.seed(19937)
p1 = tibble::tibble(face = sample.int(6, 12, replace = TRUE)) |>
  ggplot() +
  aes(face) +
  geom_bar(aes(y = after_stat(prop))) +
  scale_x_continuous(breaks = seq_len(6L)) +
  theme_bw(base_size = 20) +
  theme(
    panel.grid.minor.y = element_blank(), panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank(),
    axis.ticks = element_blank()
  )

p2 = tibble::tibble(height = rnorm(1000L, c(160, 170), 5.5)) |>
  ggplot() +
  aes(height) +
  geom_histogram(aes(y = after_stat(density)), binwidth = 1, boundary = 0) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor.x = element_blank(), axis.ticks = element_blank())
cowplot::plot_grid(p1, p2, nrow = 1L)
```

ä¸€æ–¹ã€å°‘æ•°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨æ•°å¼ã§ä½œã‚‹ã®ãŒ**ç†è«–åˆ†å¸ƒ**ã€‚\
(ã“ã¡ã‚‰ã‚’å˜ã«ã€Œç¢ºç‡åˆ†å¸ƒã€ã¨å‘¼ã¶ã“ã¨ãŒå¤šã„å°è±¡ï¼‰


---
## åˆ†å¸ƒã‚’ç‰¹å¾´ã¥ã‘ã‚‹ä»£è¡¨å€¤ central tendency

<div class="column-container">
  <div class="column" style="flex-shrink: 1.6;">

å¹³å‡å€¤ mean
: å’Œã‚’è¦³å¯Ÿæ•°ã§å‰²ã‚‹

ä¸­å¤®å€¤ median
: é †ã«ä¸¦ã¹ã¦çœŸã‚“ä¸­

æœ€é »å€¤ mode
: æœ€ã‚‚é »åº¦ãŒé«˜ã„å€¤

  </div>
  <div class="column">
  <a href="https://www.mhlw.go.jp/toukei/list/20-21.html">
  <img src="../tohoku2025r/image/hist-income-japan-2022.png" width="100%" style="">
  <figcaption><cite>æ‰€å¾—é‡‘é¡éšç´šåˆ¥ä¸–å¸¯æ•°ã®é »åº¦åˆ†å¸ƒ åšç”ŸåŠ´åƒçœ å›½æ°‘ç”Ÿæ´»åŸºç¤èª¿æŸ» 2019</cite></figcaption>
  </a>
  </div>
</div>

ç›®çš„ã‚„çŠ¶æ³ã«å¿œã˜ã¦ä½¿ã„åˆ†ã‘ã‚ˆã†ã€‚

å¤–ã‚Œå€¤ã«å¯¾ã™ã‚‹å¿œç­”
: ã‚‚ã—ç·è³‡ç”£é¡20å…†å††ã®å¤§å¯Œè±ªãŒé³¥å–çœŒã«å¼•ã£è¶Šã—ã¦ããŸã‚‰\
  â†’ çœŒæ°‘ã®**å¹³å‡**è³‡ç”£ã¯4000ä¸‡å††ä¸Šæ˜‡ã€‚**ä¸­å¤®å€¤**ãƒ»**æœ€é »å€¤**ã¯ã»ã¼ãã®ã¾ã¾ã€‚

---
## ã°ã‚‰ã¤ãã‚’æ‰ãˆã‚‹è¨˜è¿°çµ±è¨ˆé‡

åˆ†æ•£ variance
: å¹³å‡å€¤ã‹ã‚‰ã®å·®ã®è‡ªä¹—ã®å¹³å‡ã€‚ $\frac 1 n \sum _i ^n (X_i - \bar X)^2$
: ã“ã‚Œã®å¹³æ–¹æ ¹ãŒ**æ¨™æº–åå·® (standard deviation)**ã€‚

Percentile, Quantile (å››åˆ†ä½)
: å°ã•ã„é †ã«ãªã‚‰ã¹ã¦ä¸Šä½ä½•%ã«ã‚ã‚‹ã‹ã€‚
: ä¸­å¤®å€¤ = 50th percentile = ç¬¬äºŒå››åˆ†ä½(Q2)

```{r, quantile}
#| fig.width: 12
#| fig.height: 4
#| echo: false
set.seed(24601)
df = tibble::tibble(x = rnorm(200)) |>
  dplyr::filter(abs(x) < 2) |>
  dplyr::mutate(x = x + 3)
probs = c(min = 0, Q1 = 0.25, Q2 = 0.5, Q3 = 0.75, max = 1)
dfq = df |>
  dplyr::reframe(x = quantile(x, probs)) |>
  dplyr::mutate(name = names(probs), percent = sprintf("%d%%", 100 * probs))

p_hist = ggplot(df) + aes(x) +
  geom_histogram(bins = 30) +
  theme_void()
built = ggplot_build(p_hist)
bdata = built$data[[1]]
xlim = bdata |> dplyr::select(xmin, xmax) |> range()
p_box = ggplot(df) + aes(x) +
  geom_boxplot() +
  geom_rug(sides = "t", length = unit(0.06, "npc"), alpha = 0.66) +
  geom_point(data = dfq, aes(y = -0.6), shape = 17, size = 4) +
  geom_text(data = dfq, aes(y = -0.78, label = name), size = 6) +
  geom_text(data = dfq, aes(y = -1.00, label = percent), size = 6) +
  coord_cartesian(xlim = xlim, ylim = c(-1.2, 0.5)) +
  theme_void()
cowplot::plot_grid(p_hist, p_box, ncol = 1L)
```


---
## è¨˜è¿°çµ±è¨ˆé‡ã«é ¼ã‚Šã™ããšåˆ†å¸ƒã‚’å¯è¦–åŒ–ã™ã‚‹

åŒã˜ãƒ‡ãƒ¼ã‚¿ã§ã‚‚è¦‹ã›æ–¹ã§å°è±¡ãƒ»æƒ…å ±é‡ãŒå¤‰ã‚ã‚‹ã€‚

```{r, visualize-distribution}
#| echo: false
#| fig.width: 11
#| fig.height: 7
df = mpg |> dplyr::mutate(y = hwy)
df_mean = df |> dplyr::summarize(y = mean(y))
p0 = ggplot(df) + aes(y = y) +
  theme_classic() +
  theme(axis.title = element_blank(), axis.text.x = element_blank(), axis.ticks = element_blank())

ylim = c(0, max(df$y))
coord_y = coord_cartesian(ylim = ylim)
coord_one = coord_cartesian(ylim = ylim, xlim = c(-1, 1))

pcol = p0 + aes(x = 0) +
  geom_col(data = df_mean, fill = "#999999") +
  stat_summary(fun.data = wtl::mean_sd, geom = "linerange")

set.seed(1)
cowplot::plot_grid(nrow = 2L,
  pcol + coord_one,
  p0 + geom_boxplot() + coord_one,
  p0 + geom_density(fill = "#999999", color = NA) + coord_y,
  p0 + geom_histogram(fill = "#999999", bins = 30L) + coord_y,
  p0 + geom_jitter(aes(x = 0), height = 0, shape = 16, alpha = 0.3, stroke = 0) + coord_one,
  p0 + geom_violin(aes(x = 0), fill = "#999999", color = NA) + coord_one,
  p0 + geom_dotplot(aes(x = 0), binaxis = "y", binwidth = 1, stackratio = 0.8,
    stroke = 0, alpha = 0.66, stackdir = "center") + coord_y,
  p0 + geom_dotplot(aes(x = 0), binaxis = "y", binwidth = 1, stackratio = 0.8,
    stroke = 0, alpha = 0.66) + coord_y
)
```


---
## ç¢ºç‡å¤‰æ•°$X$ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿$\theta$ã®ç¢ºç‡åˆ†å¸ƒ$f$ã«å¾“ã†...?

$X \sim f(\theta)$

e.g.,\
ã‚³ã‚¤ãƒ³ã‚’3æšæŠ•ã’ãŸã†ã¡è¡¨ã®å‡ºã‚‹æšæ•° $X$ ã¯**äºŒé …åˆ†å¸ƒã«å¾“ã†**ã€‚\
$X \sim \text{Binomial}(n = 3, p = 0.5)$

<div class="column-container">
  <div class="column" style="flex-shrink: 2.0;">

```{r, dbinom}
#| echo: false
#| fig.height: 3.5
#| fig.width: 3.5
size = 3L
p = 0.5
tibble(X = seq(0, 3), Prob = dbinom(X, size, p), obs = Inf) |>
  ggplot() +
  aes(X, Prob) +
  geom_col() +
  scale_y_continuous(breaks = c(0, 1), limits = c(0, 1)) +
  theme_bw(base_size = 22) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank(), axis.ticks = element_blank())
```

  </div>
  <div class="column" style="padding-top: 10px;">
\[\begin{split}
\Pr(X = k) &= \binom n k p^k (1 - p)^{n - k} \\
k &\in \{0, 1, 2, \ldots, n\}
\end{split}\]
  </div>
</div>

ä¸€ç·’ã«å®Ÿé¨“ã—ã¦ã¿ã‚ˆã†ã€‚

---
## è©¦è¡Œã‚’ç¹°ã‚Šè¿”ã—ã¦è¨˜éŒ²ã—ã¦ã¿ã‚‹

ã‚³ã‚¤ãƒ³ã‚’3æšæŠ•ã’ãŸã†ã¡è¡¨ã®å‡ºãŸæšæ•° $X$

è©¦è¡Œ1: **è¡¨** è£ **è¡¨** â†’ $X = 2$\
è©¦è¡Œ2: è£ è£ è£ â†’ $X = 0$\
è©¦è¡Œ3: **è¡¨** è£ è£ â†’ $X = 1$ ç¶šã‘ã¦ $2, 1, 3, 0, 2, \ldots$

```{r, rbinom}
#| echo: false
#| fig.height: 3
#| fig.width: 12
set.seed(19937)
size = 3L
p = 0.5
X = c(2L, 0L, 1L, 2L, 1L, 3L, 0L, 2L, rbinom(92L, size, p))
df_rbinom = purrr::map(c(1, 2, 3, 10, 100), \(n) {
  tibble::tibble(X = head(X, n)) |>
    dplyr::count(X, name = "k") |>
    dplyr::mutate(Freq = k / n, Repl = n)
}) |>
  purrr::list_rbind() |>
  dplyr::bind_rows(tibble(X = seq(0, 3), Freq = dbinom(X, size, p), Repl = Inf))
df_rbinom |>
  ggplot() +
  aes(X, Freq) +
  geom_col() +
  scale_y_continuous(breaks = c(0, 1), limits = c(0, 1)) +
  facet_wrap(vars(Repl), nrow = 1L, labeller = label_both) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank(), axis.ticks = element_blank())
```

<div style="text-align: right;">
è©¦è¡Œå›æ•°ã‚’å¢—ã‚„ã™ã»ã©<b>äºŒé …åˆ†å¸ƒ</b>ã®å½¢ã«è¿‘ã¥ãã€‚<br>
0ã¨3ã¯ãƒ¬ã‚¢ã€‚1ã¨2ãŒ3å€ã»ã©å‡ºã‚„ã™ã„ã‚‰ã—ã„ã€‚
</div>

---
## ã‚³ã‚¤ãƒ³ãƒˆã‚¹ã—ãªãã¦ã‚‚ $X$ ã‚‰ã—ãã‚‚ã®ã‚’ç”Ÿæˆã§ãã‚‹

- ã‚³ã‚¤ãƒ³ã‚’3æšæŠ•ã’ãŸã†ã¡è¡¨ã®å‡ºã‚‹æšæ•° $X$
- $n = 3, p = 0.5$ ã®äºŒé …åˆ†å¸ƒã‹ã‚‰ã‚µãƒ³ãƒ—ãƒ«ã™ã‚‹ä¹±æ•° $X$

<div class="column-container">
  <div class="column" style="flex-shrink: 2.0;">
<img `r src_alt_fig_chunk("dbinom")`>
  </div>
  <div class="column" style="padding-top: 10px;">
$X \sim \text{Binomial}(n = 3, p = 0.5)$

&nbsp;&nbsp; â†“ ã‚µãƒ³ãƒ—ãƒ«

{2, 0, 1, 2, 1, 3, 0, 2, ...}
  </div>
</div>

ã“ã‚Œã‚‰ã¯ã¨ã¦ã‚‚ã‚ˆãä¼¼ã¦ã„ã‚‹ã®ã§\
**ã€Œã‚³ã‚¤ãƒ³ã‚’næšæŠ•ã’ãŸã†ã¡è¡¨ã®å‡ºã‚‹æšæ•°ã¯äºŒé …åˆ†å¸ƒã«å¾“ã†ã€**\
ã¿ãŸã„ãªè¨€ã„æ–¹ã‚’ã™ã‚‹ã€‚é€†ã«è¨€ã†ã¨\
**ã€ŒäºŒé …åˆ†å¸ƒã¨ã¯nå›è©¦è¡Œã®ã†ã¡ã®æˆåŠŸå›æ•°ã‚’ç¢ºç‡å¤‰æ•°ã¨ã™ã‚‹åˆ†å¸ƒã€**\
ã®ã‚ˆã†ã«ç†è§£ã§ãã‚‹ã€‚

---
## çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã®ä¸€ç’°ã¨ã‚‚æ‰ãˆã‚‰ã‚Œã‚‹

ã‚³ã‚¤ãƒ³3æšæŠ•ã’ã‚’ç¹°ã‚Šè¿”ã—ã¦å¾—ãŸãƒ‡ãƒ¼ã‚¿ {2, 0, 1, 2, 1, 3, 0, 2, ...}

&nbsp;&nbsp; â†“ ãŸã£ãŸ2ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§è¨˜è¿°ã€‚æƒ…å ±ã‚’åœ§ç¸®ã€‚

$n = 3, p = 0.5$ ã®äºŒé …åˆ†å¸ƒã§èª¬æ˜ãƒ»å†ç¾ã§ãã‚‹ã

<figure>
<img src="../tokiomarine2021/math-model.drawio.svg" width="900">
<figcaption><cite>ã€Œãƒ‡ãƒ¼ã‚¿åˆ†æã®ãŸã‚ã®æ•°ç†ãƒ¢ãƒ‡ãƒ«å…¥é–€ã€æ±Ÿå´è²´è£• 2020 ã‚ˆã‚Šæ”¹å¤‰</cite></figcaption>
</figure>

ã“ã†ã„ã†ãµã†ã«ç¾è±¡ã¨å¯¾å¿œã—ãŸç¢ºç‡åˆ†å¸ƒã€ã»ã‹ã«ã‚‚ã‚ã‚‹ï¼Ÿ

???
ãŸã ã—ã€Œã“ã‚ŒãŒ3é€£ã‚³ã‚¤ãƒ³ãƒˆã‚¹ã®çœŸç†ã ã€ã§ã¯ãªã„ã€‚\
ã‚ãã¾ã§ã€Œã“ã†å˜ç´”åŒ–ã—ã¦ç†è§£ã§ããã†ãƒ»ä½¿ãˆãã†ã€ãªã ã‘ã€‚

ã»ã‹ã®ä»®å®š: ã‚³ã‚¤ãƒ³ãŒç«‹ã¤ã‹ã‚‚ã€‚åã£ãŸã‚³ã‚¤ãƒ³ã‹ã‚‚ã€‚ä¸¡è¡¨ã‹ã‚‚ã€‚

äºŒé …åˆ†å¸ƒã¯næšã‚³ã‚¤ãƒ³ãƒˆã‚¹ã‚’ãŸã£ãŸ2ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§èª¬æ˜ã™ã‚‹å„ªç§€ãƒ¢ãƒ‡ãƒ«


---
## æœ‰åãªç¢ºç‡åˆ†å¸ƒã€ãã‚Œã«ã€Œå¾“ã†ã€ã‚‚ã®

é›¢æ•£ä¸€æ§˜åˆ†å¸ƒ
: ã‚³ã‚¤ãƒ³ã®è¡¨è£ã€ã‚µã‚¤ã‚³ãƒ­ã®å‡ºç›®1â€“6

è² ã®äºŒé …åˆ†å¸ƒ (å¹¾ä½•åˆ†å¸ƒ if n = 1)
: æˆåŠŸç‡pã®è©¦è¡ŒãŒnå›æˆåŠŸã™ã‚‹ã¾ã§ã®å¤±æ•—å›æ•°

äºŒé …åˆ†å¸ƒ
: æˆåŠŸç‡pã€è©¦è¡Œå›æ•°nã®ã†ã¡ã®æˆåŠŸå›æ•°

ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒ
: å˜ä½æ™‚é–“ã‚ãŸã‚Šå¹³å‡$\lambda$å›èµ·ã“ã‚‹äº‹è±¡ã®ç™ºç”Ÿå›æ•°

ã‚¬ãƒ³ãƒåˆ†å¸ƒ (æŒ‡æ•°åˆ†å¸ƒ if k = 1)
: ãƒã‚¢ã‚½ãƒ³éç¨‹ã§kå›èµ·ã“ã‚‹ã¾ã§ã®å¾…ã¡æ™‚é–“

æ­£è¦åˆ†å¸ƒ
: ç¢ºç‡å¤‰æ•°ã®å’Œã€å¹³å‡å€¤ãªã©ã€‚

---
## é›¢æ•£ä¸€æ§˜åˆ†å¸ƒ

åŒã˜ç¢ºç‡ã§èµ·ã“ã‚‹né€šã‚Šã®äº‹è±¡ã®ã†ã¡XãŒèµ·ã“ã‚‹ç¢ºç‡

e.g., ã‚³ã‚¤ãƒ³ã®è¡¨è£ã€ã‚µã‚¤ã‚³ãƒ­ã®å‡ºç›®1â€“6

```{r, dunif}
#| echo: false
#| fig.height: 4
#| fig.width: 6
df_coin = tibble::tibble(X = c("head", "tail"), Prob = c(0.5, 0.5), group = "Coin")
df_dice = tibble::tibble(X = as.character(seq_len(6L)), Prob = rep(1 / 6, 6), group = "Dice")
dplyr::bind_rows(df_coin, df_dice) |>
  ggplot() +
  aes(X, Prob) +
  geom_col() +
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 1)) +
  facet_grid(cols = vars(group), scale = "free_x", space = "free_x") +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank(), axis.ticks = element_blank())
```

ğŸ”° ä¸€æ§˜åˆ†å¸ƒã«ãªã‚Šãã†ãªä¾‹ã‚’è€ƒãˆã¦ã¿ã‚ˆã†


---
## å¹¾ä½•åˆ†å¸ƒ $~\text{Geom}(p)$

æˆåŠŸç‡pã®è©¦è¡ŒãŒåˆã‚ã¦æˆåŠŸã™ã‚‹ã¾ã§ã®å¤±æ•—å›æ•°

e.g., ã‚³ã‚¤ãƒ³ãƒˆã‚¹ã§è¡¨ãŒå‡ºã‚‹ã¾ã§ã«ä½•å›è£ãŒå‡ºã‚‹ã‹

```{r, geometric}
#| echo: false
#| fig.height: 4
#| fig.width: 12
df = purrr::map(c(0.2, 0.5, 0.9), \(p) {
  tibble::tibble(p, X = seq(0, 25), Prob = dgeom(X, p))
}) |>
  purrr::list_rbind() |>
  dplyr::filter(Prob > 0.001)
x_br = c(seq.int(0, 10), seq.int(15, 100, 5))
ggplot(df) +
  aes(X, Prob) +
  scale_x_continuous(breaks = x_br) +
  scale_y_continuous(breaks = c(0, 1), limits = c(0, 1)) +
  geom_col() +
  facet_grid(cols = vars(p), scales = "free_x", space = "free_x", labeller = label_both) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank(), axis.ticks = element_blank())
```

\\[
\Pr(X = k \mid p) = p (1 - p)^k
\\]

ã€Œåˆã‚ã¦æˆåŠŸã™ã‚‹ã¾ã§ã®è©¦è¡Œå›æ•°ã€ã¨ã™ã‚‹å®šç¾©ã‚‚ã‚ã‚‹ã€‚

ğŸ”° å¹¾ä½•åˆ†å¸ƒã«ãªã‚Šãã†ãªä¾‹ã‚’è€ƒãˆã¦ã¿ã‚ˆã†

---
## è² ã®äºŒé …åˆ†å¸ƒ $~\text{NB}(n, p)$

æˆåŠŸç‡pã®è©¦è¡ŒãŒnå›æˆåŠŸã™ã‚‹ã¾ã§ã®å¤±æ•—å›æ•°Xã€‚
n = 1 ã®ã¨ãå¹¾ä½•åˆ†å¸ƒã¨ä¸€è‡´ã€‚

```{r, nbinom}
#| echo: false
#| fig.height: 3.8
#| fig.width: 12
p = 0.5
df = purrr::map(seq.int(1, 3), function(n) {
  tibble::tibble(X = seq.int(0, 10), Prob = dnbinom(X, n, p), n = n)
}) |>  purrr::list_rbind()
ggplot(df) +
  aes(X, Prob) +
  scale_x_continuous(breaks = df[["X"]]) +
  scale_y_continuous(breaks = c(0, 1), limits = c(0, 1)) +
  geom_col() +
  facet_grid(cols = vars(n), scales = "free_x", space = "free_x", labeller = label_both) +
  labs(title = paste0("p = ", p)) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank(), axis.ticks = element_blank())
```

\\[
\Pr(X = k \mid n,~p) = \binom {n + k - 1} k p^n (1 - p)^k
\\]

å¤±æ•—å›æ•°ã§ã¯ãªãè©¦è¡Œå›æ•°ã‚’å¤‰æ•°ã¨ã™ã‚‹å®šç¾©ã‚‚ã‚ã‚‹ã€‚

ğŸ”° è² ã®äºŒé …åˆ†å¸ƒã«ãªã‚Šãã†ãªä¾‹ã‚’è€ƒãˆã¦ã¿ã‚ˆã†

<!--
å¹³å‡$\lambda$ãŒã‚¬ãƒ³ãƒåˆ†å¸ƒã§ã°ã‚‰ã¤ã„ãŸãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒã€ã¨ã‚‚è§£é‡ˆã§ãã‚‹ã€‚\
($k \to \infty$ã§ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒã¨ä¸€è‡´)
-->

---
## äºŒé …åˆ†å¸ƒ $~\text{Binomial}(n,~p)$

ç¢ºç‡$p$ã§å½“ãŸã‚‹ã‚¯ã‚¸ã‚’$n$å›å¼•ã„ã¦Xå›å½“ãŸã‚‹ç¢ºç‡ã€‚å¹³å‡ã¯$np$ã€‚

```{r, dbinom-n}
#| echo: false
#| fig.height: 4
#| fig.width: 12
p = 0.25
df = purrr::map(2**seq.int(0, 4), \(n) {
  tibble::tibble(X = seq(0, n), Prob = dbinom(X, n, p), n = n)
}) |> purrr::list_rbind()
ggplot(df) +
  aes(X, Prob) +
  scale_x_continuous(breaks = df[["X"]]) +
  scale_y_continuous(breaks = c(0, 1), limits = c(0, 1)) +
  geom_col() +
  facet_grid(cols = vars(n), scales = "free_x", space = "free_x", labeller = label_both) +
  labs(title = paste0("p = ", p)) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank(), axis.ticks = element_blank())
```

\\[
\Pr(X = k \mid n,~p) = \binom n k p^k (1 - p)^{n - k}
\\]

ğŸ”° äºŒé …åˆ†å¸ƒã«ãªã‚Šãã†ãªä¾‹ã‚’è€ƒãˆã¦ã¿ã‚ˆã†


---
## ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒ $~\text{Poisson}(\lambda)$

å¹³å‡$\lambda$ã§å˜ä½æ™‚é–“(ç©ºé–“)ã‚ãŸã‚Šã«ç™ºç”Ÿã™ã‚‹äº‹è±¡ã®å›æ•°ã€‚

e.g., 1æ™‚é–“ã‚ãŸã‚Šã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ä»¶æ•°ã€ãƒ¡ãƒƒã‚·ãƒ¥åŒºç”»å†…ã®ç”Ÿç‰©å€‹ä½“æ•°

```{r, dpoisson}
#| echo: false
#| fig.height: 3.9
#| fig.width: 12
set.seed(19937)
lambda = c(1, 5, 10)
.arrow = grid::arrow(length = unit(0.1, "inches"), type = "closed")
p_poisson_process = tibble::tibble(y = rev(seq_along(lambda)), lambda) |>
  dplyr::mutate(time = purrr::map(lambda, ~ runif(.x * 3, 0, 3))) |>
  tidyr::unnest(time) |>
  ggplot() +
  aes(time, y) +
  annotate("segment", x = -0.1, xend = 3.1, y = 1:3, yend = 1:3, linewidth = 2, arrow = .arrow, linejoin = "mitre") +
  geom_point(aes(color = lambda, fill = lambda), size = 8, shape = 124, key_glyph = draw_key_rect) +
  scale_color_continuous(guide = NULL) +
  scale_fill_continuous(guide = guide_legend(label.position = "top", title.vjust = 1), breaks = lambda) +
  scale_y_continuous(limits = c(0.5, 3.5), breaks = NULL) +
  labs(y = NULL, x = "time (space)") +
  theme_bw(base_size = 20) +
  theme(
    axis.text.y = element_blank(), axis.ticks = element_blank(), panel.border = element_blank(),
    panel.grid.minor = element_blank(), legend.position = "top"
  )

p2 = tidyr::crossing(X = seq.int(0L, 20L), lambda) |>
  dplyr::mutate(Prob = dpois(X, lambda)) |>
  ggplot() +
  aes(X, Prob) +
  geom_col(aes(fill = lambda), position = "identity", alpha = 0.5) +
  theme_bw(base_size = 20) +
  theme(
    panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
    axis.ticks = element_blank(), legend.position = "none"
  )
cowplot::plot_grid(p_poisson_process, p2, nrow = 1L, rel_widths = c(4, 3))
```

\\[
\Pr(X = k \mid \lambda) = \frac {\lambda^k e^{-\lambda}} {k!}
\\]

äºŒé …åˆ†å¸ƒã®æ¥µé™ $(\lambda = np;~n \to \infty;~p \to 0)$ã€‚\
ã‚ã£ãŸã«èµ·ããªã„ã“ã¨ã‚’ä½•å›ã‚‚è©¦è¡Œã™ã‚‹ã‚ˆã†ãªæ„Ÿã˜ã€‚


---
## æŒ‡æ•°åˆ†å¸ƒ $~\text{Exp}(\lambda)$

ãƒã‚¢ã‚½ãƒ³éç¨‹ã®äº‹è±¡ã®ç™ºç”Ÿé–“éš”ã€‚å¹³å‡ã¯ $1 / \lambda$ ã€‚

e.g., ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å—ä¿¡é–“éš”ã€é“è·¯æ²¿ã„ã«è½ã¡ã¦ã‚‹æ‰‹è¢‹ã®é–“éš”

```{r, dexp}
#| echo: false
#| fig.height: 3.9
#| fig.width: 12
p2 = tidyr::crossing(x = seq(0, 3, length.out = 201), lambda) |>
  dplyr::mutate(Prob = dexp(x, rate = lambda)) |>
  ggplot() +
  aes(x, Prob) +
  geom_area(aes(fill = lambda, group = lambda), position = "identity", alpha = 0.5) +
  theme_bw(base_size = 20) +
  theme(
    panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
    axis.ticks = element_blank(), legend.position = "none"
  )
cowplot::plot_grid(p_poisson_process, p2, nrow = 1L, rel_widths = c(4, 3))
```

\\[
\Pr(x \mid \lambda) = \lambda e^{-\lambda x}
\\]

å¹¾ä½•åˆ†å¸ƒã®é€£ç¶šå€¤ç‰ˆã€‚

ğŸ”° ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒãƒ»æŒ‡æ•°åˆ†å¸ƒã«ãªã‚Šãã†ãªä¾‹ã‚’è€ƒãˆã¦ã¿ã‚ˆã†


---
## ã‚¬ãƒ³ãƒåˆ†å¸ƒ $~\text{Gamma}(k,~\lambda)$

ãƒã‚¢ã‚½ãƒ³éç¨‹ã®äº‹è±¡kå›ç™ºç”Ÿã¾ã§ã®å¾…ã¡æ™‚é–“

e.g., ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’2ã¤å—ä¿¡ã™ã‚‹ã¾ã§ã®å¾…ã¡æ™‚é–“

```{r, dgamma}
#| echo: false
#| fig.height: 3.9
#| fig.width: 12
p2 = tidyr::crossing(x = seq(0, 3, length.out = 201), lambda) |>
  dplyr::mutate(Prob = dgamma(x, rate = lambda, shape = 3)) |>
  ggplot() +
  aes(x, Prob) +
  geom_area(aes(fill = lambda, group = lambda), position = "identity", alpha = 0.5) +
  theme_bw(base_size = 20) +
  theme(
    panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
    axis.ticks = element_blank(), legend.position = "none"
  )
cowplot::plot_grid(p_poisson_process, p2, nrow = 1L, rel_widths = c(4, 3))
```

\\[
\Pr(x \mid k,~\lambda) = \frac {\lambda^k x^{k - 1} e^{-\lambda x}} {\Gamma(k)}
\\]

æŒ‡æ•°åˆ†å¸ƒã‚’kã®ã¶ã‚“å³ã«è†¨ã‚‰ã¾ã›ãŸæ„Ÿã˜ã€‚\
shapeãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ $k = 1$ ã®ã¨ãæŒ‡æ•°åˆ†å¸ƒã¨ä¸€è‡´ã€‚


---
## æ­£è¦åˆ†å¸ƒ $~\mathcal{N}(\mu,~\sigma)$

å¹³å‡ $\mu$ã€æ¨™æº–åå·® $\sigma$ ã®ç¾ã—ã„åˆ†å¸ƒã€‚ã‚ˆãç™»å ´ã™ã‚‹ã€‚\
e.g., $\mu = 50, ~\sigma = 10$ (æ¿ƒã„ç°è‰²ã«ãƒ‡ãƒ¼ã‚¿ã®95%, 99%ãŒå«ã¾ã‚Œã‚‹):

```{r, gaussian}
#| echo: false
#| fig.height: 5
#| fig.width: 12
ci = qnorm(c(0.005, 0.025, 0.975, 0.995), 50, 10)
tibble::tibble(x = seq(0, 100, 0.1), Prob = dnorm(x, 50, 10)) |>
  ggplot() +
  aes(x, Prob) +
  geom_area(alpha = 0.4) +
  geom_area(data = function(.x) {
    dplyr::filter(.x, dplyr::between(x, ci[2], ci[3]))
  }, alpha = 0.4) +
  geom_area(data = function(.x) {
    dplyr::filter(.x, dplyr::between(x, ci[1], ci[4]))
  }, alpha = 0.4) +
  theme_bw(base_size = 20) +
  theme(
    panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
    axis.ticks = element_blank(), legend.position = "none"
  )
```

\\[
\Pr(x \mid \mu,~\sigma) = \frac 1 {\sqrt{2 \pi \sigma^2}} \exp \left(\frac {-(x - \mu)^2} {2\sigma^2} \right)
\\]

---
## æ­£è¦åˆ†å¸ƒã«è¿‘ã¥ãã‚‚ã®ãŒã„ã‚ã„ã‚ã‚ã‚‹

æ¨™æœ¬å¹³å‡ã®åå¾©(**ä¸­å¿ƒæ¥µé™å®šç†**);
e.g., ä¸€æ§˜åˆ†å¸ƒ [0, 100) ã‹ã‚‰40ã‚µãƒ³ãƒ—ãƒ«

```{r, central-limit}
#| echo: false
#| fig.height: 3
#| fig.width: 12
set.seed(19937)
n = 40L
X = replicate(10000L, mean(runif(n, 0, 100)))
purrr::map(c(10, 100, 1000, 10000), \(n) {
  tibble::tibble(X = head(X, n), Repl = n)
}) |>
  purrr::list_rbind() |>
  ggplot() +
  aes(X) +
  geom_histogram(bins = 25) +
  facet_wrap(vars(Repl), nrow = 1L, scale = "free_y", labeller = label_both) +
  theme_bw(base_size = 20) +
  theme(
    panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(),
    axis.ticks = element_blank()
  )
```

å¤§ãã„$n$ã®äºŒé …åˆ†å¸ƒ

```{r, binom-normal}
#| echo: false
#| fig.height: 3
#| fig.width: 12
purrr::map(c(1, 4, 16, 64, 256), \(n) {
  tibble::tibble(X = seq(0, n), Prob = dbinom(X, n, 0.25), n = n) |>
    dplyr::filter(Prob > 1e-5)
}) |>
  purrr::list_rbind() |>
  ggplot() +
  aes(X, Prob) +
  geom_col(width = 1) +
  facet_wrap(vars(n), nrow = 1L, scale = "free", labeller = label_both) +
  theme_bw(base_size = 20) +
  theme(
    panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(),
    axis.ticks = element_blank()
  )
```

---
## æ­£è¦åˆ†å¸ƒã«è¿‘ã¥ãã‚‚ã®ãŒã„ã‚ã„ã‚ã‚ã‚‹

å¤§ãã„$\lambda$ã®ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒ

```{r, poisson-normal}
#| echo: false
#| fig.height: 2.5
#| fig.width: 12
purrr::map(c(1, 4, 16, 64, 256), \(lambda) {
  tibble::tibble(X = seq(0, 4 * lambda), Prob = dpois(X, lambda), lambda) |>
    dplyr::filter(Prob > 1e-5)
}) |>
  purrr::list_rbind() |>
  ggplot() +
  aes(X, Prob) +
  geom_col(width = 1) +
  facet_wrap(vars(lambda), nrow = 1L, scale = "free", labeller = label_both) +
  theme_bw(base_size = 20) +
  theme(
    panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(),
    axis.ticks = element_blank()
  )
```

å¹³å‡å€¤å›ºå®šãªã‚‰$k$ãŒå¤§ãããªã‚‹ã»ã©å·¦å³å¯¾ç§°ã«å°–ã‚‹ã‚¬ãƒ³ãƒåˆ†å¸ƒ

```{r, gamma-normal}
#| echo: false
#| fig.height: 3.8
#| fig.width: 12
.guide = guide_legend(reverse = TRUE, label.position = "left", label.hjust = 1)
tidyr::crossing(x = seq(0, 25, length.out = 300), k = 10**seq.int(0, 3)) |>
  dplyr::mutate(Prob = dgamma(x, rate = k / 10, shape = k)) |>
  ggplot() +
  aes(x, Prob) +
  geom_area(aes(fill = k, group = k), position = "identity", alpha = 0.5) +
  scale_fill_viridis_c(trans = "log10", guide = .guide) +
  coord_cartesian(xlim = c(0, 20)) +
  theme_bw(base_size = 20) +
  theme(
    panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
    axis.ticks = element_blank()
  )
```


---
## æœ‰åãªç¢ºç‡åˆ†å¸ƒå¯¾å¿œé–¢ä¿‚ãµã‚Šã‹ãˆã‚Š

<figure style="float: right;">
<img src="../tokiomarine2021/math-model.drawio.svg" width="420">
</figure>

é›¢æ•£ä¸€æ§˜åˆ†å¸ƒ
: ã‚³ã‚¤ãƒ³ã®è¡¨è£ã€ã‚µã‚¤ã‚³ãƒ­ã®å‡ºç›®1â€“6

è² ã®äºŒé …åˆ†å¸ƒ (å¹¾ä½•åˆ†å¸ƒ if n = 1)
: æˆåŠŸç‡pã®è©¦è¡ŒãŒnå›æˆåŠŸã™ã‚‹ã¾ã§ã®å¤±æ•—å›æ•°

äºŒé …åˆ†å¸ƒ
: æˆåŠŸç‡pã€è©¦è¡Œå›æ•°nã®ã†ã¡ã®æˆåŠŸå›æ•°

ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒ
: å˜ä½æ™‚é–“ã‚ãŸã‚Šå¹³å‡$\lambda$å›èµ·ã“ã‚‹äº‹è±¡ã®ç™ºç”Ÿå›æ•°

ã‚¬ãƒ³ãƒåˆ†å¸ƒ (æŒ‡æ•°åˆ†å¸ƒ if k = 1)
: ãƒã‚¢ã‚½ãƒ³éç¨‹ã§kå›èµ·ã“ã‚‹ã¾ã§ã®å¾…ã¡æ™‚é–“

æ­£è¦åˆ†å¸ƒ
: ç¢ºç‡å¤‰æ•°ã®å’Œã€å¹³å‡å€¤ã€‚ä½¿ã„å‹æ‰‹ãŒè‰¯ãã€ã‚ˆãç™»å ´ã™ã‚‹ã€‚


---
## ç¾å®Ÿã«ã¯ã€ç¢ºç‡åˆ†å¸ƒã«ã€Œå¾“ã‚ãªã„ã€ã“ã¨ãŒå¤šã„

æ¤ç‰©100å€‹ä½“ã‹ã‚‰8å€‹ãšã¤ç¨®å­ã‚’å–ã£ã¦æ¤ãˆãŸã‚‰å…¨ä½“ã§åŠåˆ†ã¡ã‚‡ã„ç™ºèŠ½ã€‚\
è¦ª1å€‹ä½“ã‚ãŸã‚Šã®ç”Ÿå­˜æ•°ã¯<span style="color: #56B4E9;">n=8ã®äºŒé …åˆ†å¸ƒ</span>ã«ãªã‚‹ã¯ãšã ã‘ã©ã€\
æ¥µç«¯ãªå€¤(å…¨éƒ¨æ­»äº¡ã€å…¨éƒ¨ç”Ÿå­˜)ãŒå¤šã‹ã£ãŸã€‚

```{r, df-seeds-od}
#| echo: false
set.seed(24601)
samplesize = 100L
df_seeds_od = tibble::tibble(
  z = rnorm(samplesize, 0.5, 3),
  p = wtl::sigmoid(z),
  y = rbinom(samplesize, 8L, p))
```
```{r, overdispersion}
#| echo: false
#| fig.height: 5
#| fig.width: 6
sum_y = sum(df_seeds_od$y)
p_hat = sum_y / 800
label = sprintf("hat(p) == %d/800 %%~~%% %.2f", sum_y, p_hat)
tidy_od = df_seeds_od |>
  dplyr::count(y, name = "observed") |>
  dplyr::mutate(expected = samplesize * dbinom(y, 8, p_hat))
ggplot(tidy_od) +
  geom_col(aes(y, observed), width = 0.4, fill = "#333333") +
  geom_col(aes(y, expected), tidy_od, fill = "#56B4E9", alpha = 0.5, width = 0.8) +
  annotate("text", label = label, parse = TRUE, color = "#56B4E9",
           x = -Inf, y = Inf, hjust = -0.1, vjust = 2, size = 6) +
  labs(x = "# survived seeds", y = "count") +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank(),
        legend.title = element_blank(), legend.position = "top")
```

ã€Œãã‚Œã¯ãªãœï¼Ÿã€ã¨è€ƒãˆã¦è¦å› ã‚’æ¢ã‚‹ã®ã‚‚çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã®ä»•äº‹ã€‚\
**ã€Œæ™®é€šã¯ã“ã‚Œã«å¾“ã†ã¯ãšã€ã‚’ç†è§£ã—ã¦ã“ã**ã§ãã‚‹æ€è€ƒã€‚


---
## ç–‘ä¼¼ä¹±æ•°ç”Ÿæˆå™¨ Pseudo Random Number Generator

ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ä¸Šã§ãƒ©ãƒ³ãƒ€ãƒ **ã£ã½ã„**æ•°å€¤ã‚’å‡ºåŠ›ã™ã‚‹è£…ç½®ã€‚\
å®Ÿéš›ã«ã¯**æ±ºå®šè«–çš„**ã«è¨ˆç®—ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€\
ã‚·ãƒ¼ãƒ‰(å‡ºç™ºç‚¹)ã¨å‘¼ã³å‡ºã—å›æ•°ãŒåŒã˜ãªã‚‰å‡ºã‚‹æ•°ã‚‚åŒã˜ã«ãªã‚‹ã€‚

```r
set.seed(42)
runif(3L)
# 0.9148060 0.9370754 0.2861395
runif(3L)
# 0.8304476 0.6417455 0.5190959
set.seed(42)
runif(6L)
# 0.9148060 0.9370754 0.2861395 0.8304476 0.6417455 0.5190959
```

ã‚·ãƒ¼ãƒ‰ã«é©å½“ãªå›ºå®šå€¤ã‚’ä¸ãˆã¦ãŠãã“ã¨ã§å†ç¾æ€§ã‚’ä¿ã¦ã‚‹ã€‚\
ãŸã ã—ã€Œã“ã®ã‚·ãƒ¼ãƒ‰ã˜ã‚ƒãªã„ã¨è‰¯ã„çµæœãŒå‡ºãªã„ã€ã¯ãƒ€ãƒ¡ã€‚

ã•ã¾ã–ã¾ãªã€Œåˆ†å¸ƒã«å¾“ã†ã€ä¹±æ•°ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã€‚

---
## ã„ã‚ã‚“ãªä¹±æ•°ã‚’ç”Ÿæˆãƒ»å¯è¦–åŒ–ã—ã¦æ„Ÿè¦šã‚’æ´ã‚‚ã†

```{r, try-prng}
#| eval: false
n = 100
x = sample.int(6, n, replace = TRUE)  # ä¸€æ§˜åˆ†å¸ƒ(æ•´æ•°)
x = runif(n, min = 0, max = 1)        # ä¸€æ§˜åˆ†å¸ƒ
x = rgeom(n, prob = 0.5)              # å¹¾ä½•åˆ†å¸ƒ
x = rbinom(n, size = 3, prob = 0.5)   # äºŒé …åˆ†å¸ƒ
x = rpois(n, lambda = 10)             # ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒ
x = rnorm(n, mean = 50, sd = 10)      # æ­£è¦åˆ†å¸ƒ
print(x)

p1 = ggplot(data.frame(x)) + aes(x)
p1 + geom_histogram() # for continuous values
p1 + geom_bar()       # for discrete values
```

ğŸ”° å°ã•ã„ `n` ã‹ã‚‰å¾ã€…ã«å¤§ããã—ã¦å¤‰åŒ–ã‚’ç¢ºèªã—ã‚ˆã†ã€‚

ğŸ”° ã»ã‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚‚ã„ã‚ã„ã‚å¤‰ãˆã¦å¤‰åŒ–ã‚’ç¢ºèªã—ã‚ˆã†ã€‚

ğŸ”° 1%ã®å½“ãŸã‚Šã‚’ç‹™ã£ã¦10é€£ã‚¬ãƒãƒ£ã‚’å›ã™äººãŒ100ä¸‡äººã„ãŸã‚‰ã€\
   å…¨éƒ¨ã¯ãšã‚Œã€1ã¤å½“ãŸã‚Šã€2ã¤å½“ãŸã‚Š... ã®äººã¯ã©ã‚Œãã‚‰ã„ã„ã‚‹ã‹ï¼Ÿ

(Quartoã§ã©ã†ã¾ã¨ã‚ã‚‹ã‹ã€è…•ã®è¦‹ã›æ‰€)

```{r, hidden-gacha}
#| include: false
x = rbinom(1000000, 10, 0.01)
p = ggplot(data.frame(x)) + aes(x) + geom_bar()
table(x)
```

---
## ãƒ‡ãƒ¼ã‚¿ã«åˆ†å¸ƒã‚’ã‚ã¦ã¯ã‚ãŸã„

ã‚ã‚‹æ¤ç‰©ã‚’50å€‹ä½“èª¿ã¹ã¦ã€ãã‚Œãã‚Œã®ç¨®å­æ•°Xã‚’æ•°ãˆãŸã€‚\
å€‹ä½“Aã¯ç¨®2å€‹ã€å€‹ä½“Bã¯ç¨®4å€‹ã€ã€ã€ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚º n = 50 ã®ãƒ‡ãƒ¼ã‚¿ã€‚

```{r, df-poisson}
#| echo: false
set.seed(24601)
df_rpois = tibble::tibble(X = rpois(50L, 3))
max_x = 11L
df_dpois = purrr::map(c(1, 3, 5), \(lambda) {
  tibble::tibble(lambda, X = seq.int(0L, max_x), Prob = dpois(X, lambda))
}) |> purrr::list_rbind()
```
```{r, poisson-seed}
#| echo: false
#| fig.height: 4
#| fig.width: 4.4
ggplot(df_rpois) +
  aes(X) +
  geom_bar(width = 0.4) +
  coord_cartesian(xlim = c(0, max_x)) +
  theme_bw(base_size = 20) +
  theme(
    panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(),
    axis.ticks = element_blank()
  )
```

ã‚«ã‚¦ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã ã‹ã‚‰<span class="fragment custom blur">ãƒã‚¢ã‚½ãƒ³</span>åˆ†å¸ƒã£ã½ã„ã€‚\
åˆ†å¸ƒã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ $\lambda$ ã¯ã©ã‚Œãã‚‰ã„ãŒã„ã„ã ã‚ã†ï¼Ÿ



---
## ãƒ‡ãƒ¼ã‚¿ã«åˆ†å¸ƒã‚’ã‚ã¦ã¯ã‚ãŸã„

ã‚ã‚‹æ¤ç‰©ã‚’50å€‹ä½“èª¿ã¹ã¦ã€ãã‚Œãã‚Œã®ç¨®å­æ•°Xã‚’æ•°ãˆãŸã€‚\
å€‹ä½“Aã¯ç¨®2å€‹ã€å€‹ä½“Bã¯ç¨®4å€‹ã€ã€ã€ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚º n = 50 ã®ãƒ‡ãƒ¼ã‚¿ã€‚

```{r, poisson-seed-lambda}
#| echo: false
#| fig.height: 4
#| fig.width: 12
p_pois = ggplot(df_rpois) +
  aes(X) +
  geom_bar(aes(y = after_stat(prop)), width = 0.4) +
  geom_col(data = df_dpois, aes(y = Prob), alpha = 0.5, fill = "#56B4E9") +
  facet_wrap(vars(lambda), nrow = 1L, labeller = label_both) +
  theme_bw(base_size = 20) +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(), axis.ticks = element_blank()
  )
p_pois
```

ã‚«ã‚¦ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã ã‹ã‚‰ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒã£ã½ã„ã€‚\
åˆ†å¸ƒã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ $\lambda$ ã¯ã©ã‚Œãã‚‰ã„ãŒã„ã„ã ã‚ã†ï¼Ÿ

é»’ãŒè¦³å¯Ÿãƒ‡ãƒ¼ã‚¿ã€‚<span style="color: #56B4E9;">é’ãŒãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒ</span>ã€‚
ã‚ˆãé‡ãªã‚‹ã®ã¯ $\lambda \approx 3$ ãã‚‰ã„ã‹ã€‚


---
## <ruby>å°¤<rt>ã‚†ã†</rt>åº¦</ruby> (likelihood)

<ruby>å°¤<rt>ã‚‚ã£ã¨</rt></ruby>ã‚‚ã‚‰ã—ã•ã€‚
ãƒ¢ãƒ‡ãƒ«ã®ã‚ã¦ã¯ã¾ã‚Šã®è‰¯ã•ã®å°ºåº¦ã®ã²ã¨ã¤ã€‚

**ã‚ã‚‹ãƒ¢ãƒ‡ãƒ«$M$ã®ä¸‹ã§ãã®ãƒ‡ãƒ¼ã‚¿$D$ãŒè¦³å¯Ÿã•ã‚Œã‚‹ç¢ºç‡**ã€‚\
å®šç¾©é€šã‚Šç´ ç›´ã«æ›¸ãã¨\
$\Pr(D \mid M)$

ãƒ‡ãƒ¼ã‚¿$D$ã‚’å›ºå®šã—ã€ãƒ¢ãƒ‡ãƒ«$M$ã®é–¢æ•°ã¨ã¿ãªã—ãŸã‚‚ã®ãŒ**å°¤åº¦é–¢æ•°**:\
$L(M \mid D)$

ãƒ¢ãƒ‡ãƒ«ã®æ§‹é€ ã‚‚å›ºå®šã—ã¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿$\theta$ã ã‘å‹•ã‹ã™å ´åˆã¯ã“ã†æ›¸ã:\
$L(\theta \mid D)$ ã¨ã‹ $L(\theta)$ ã¨ã‹


---
## å°¤åº¦ã‚’æ‰‹è¨ˆç®—ã§ãã‚‹ä¾‹

ã‚³ã‚¤ãƒ³ã‚’5æšæŠ•ã’ãŸçµæœ $D$: è¡¨ 4, è£ 1

è¡¨ãŒå‡ºã‚‹ç¢ºç‡ $p = 0.5$ ã¨ä»®å®š:
<div>\[\begin{split}
L(0.5 \mid D)
  &= \binom 5 1 \times \Pr(\text{è¡¨} \mid 0.5) ^ 4 \times \Pr(\text{è£} \mid 0.5) ^ 1 \\
  &= 5 \times 0.5 ^ 4 \times 0.5 ^ 1 = 0.15625
\end{split}\]</div>

è¡¨ãŒå‡ºã‚‹ç¢ºç‡ $p = 0.8$ ã¨ä»®å®š:
<div>\[\begin{split}
L(0.8 \mid D)
  &= \binom 5 1 \times \Pr(\text{è¡¨} \mid 0.8) ^ 4 \times \Pr(\text{è£} \mid 0.8) ^ 1 \\
  &= 5 \times 0.8 ^ 4 \times 0.2 ^ 1 = 0.4096
\end{split}\]</div>

$L(0.8 \mid D) > L(0.5 \mid D)$

$p = 0.8$ ã®ã»ã†ãŒã‚ˆã‚Šå°¤ã‚‚ã‚‰ã—ã„ã€‚



---
## ç¨®å­æ•°ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒã®ä¾‹ã§ã‚‚å°¤åº¦ã‚’è¨ˆç®—ã—ã¦ã¿ã‚‹

ã‚ã‚‹æ¤ç‰©ãŒä½œã£ãŸç¨®å­ã‚’æ•°ãˆã‚‹ã€‚$n = 50$å€‹ä½“ã¶ã‚“ã€‚

<div>\[\begin{split}
L(\lambda \mid D)
  = \prod _i ^n \Pr(X_i \mid \lambda)
  = \prod _i ^n \frac {\lambda ^ {X_i} e ^ {-\lambda}} {X_i !}
\end{split}\]</div>

```{r, poisson-seed-likelihood}
#| echo: false
#| fig.height: 4
#| fig.width: 12
df_likelihood = df_rpois |>
  dplyr::left_join(df_dpois, by = "X") |>
  dplyr::group_by(lambda) |>
  dplyr::summarize(L = prod(Prob)) |>
  dplyr::mutate(logL = log(L), label = sprintf("L(%.0f|D) = %.1e", lambda, L))
p_pois +
  geom_text(data = df_likelihood, aes(label = label), color = "#56B4E9",
            x = Inf, y = Inf, hjust = 1.1, vjust = 1.3, size = 6)
```

ã“ã®ä¸­ã§ã¯ $\lambda = 3$ ãŒã„ã„ã‘ã©ã€ã‚ˆã‚Šå°¤ã‚‚ã‚‰ã—ã„å€¤ã‚’æ±‚ã‚ãŸã„ã€‚

---
## æœ€å°¤æ¨å®š <u>M</u>aximum <u>L</u>ikelihood <u>E</u>stimation

æ‰±ã„ã‚„ã™ã„ **å¯¾æ•°å°¤åº¦** (log likelihood) ã«ã—ã¦ã‹ã‚‰è¨ˆç®—ã™ã‚‹ã€‚\
ä¸€éšå¾®åˆ†ãŒ0ã«ãªã‚‹ $\lambda$ ã‚’æ±‚ã‚ã‚‹ã¨...**æ¨™æœ¬å¹³å‡**ã¨ä¸€è‡´ã€‚

<div>\[\begin{split}
\log L(\lambda \mid D)
  &= \sum _i ^n \left[ X_i \log (\lambda) - \lambda - \log (X_i !) \right] \\
\frac {\mathrm d \log L(\lambda \mid D)} {\mathrm d \lambda}
  &= \frac 1 \lambda \sum _i ^n X_i - n = 0 \\
\hat \lambda &= \frac 1 n \sum _i ^n X_i
\end{split}\]</div>


```{r, poisson-mle}
#| echo: false
#| fig.height: 2.8
#| fig.width: 11
count_rpois = df_rpois |> dplyr::count(X)
calc_likelihood_rpois = function(lambda) {
  prod(dpois(count_rpois[["X"]], lambda)**count_rpois[["n"]])
}
X_mle = mean(df_rpois[["X"]])
L_mle = calc_likelihood_rpois(X_mle)
p_mle = tibble::tibble(lambda = seq(1, 5, 0.1), L = purrr::map_dbl(lambda, calc_likelihood_rpois)) |>
  dplyr::mutate(logL = log(L)) |>
  ggplot() +
  aes(lambda, logL) +
  geom_line() +
  geom_vline(xintercept = X_mle, color = "#56B4E9") +
  annotate("point", x = X_mle, y = log(L_mle), size = 3, color = "#56B4E9") +
  annotate("text", label = sprintf("lambda = %.2f", X_mle), color = "#56B4E9",
           x = Inf, y = Inf, hjust = 1.1, vjust = 1.2, size = 5) +
  labs(y = "log L") +
  theme_bw(base_size = 20) +
  theme(
    panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
    axis.ticks = element_blank()
  )

df_dpois = tibble(lambda = X_mle, X = seq(0, 11), Prob = dpois(X, lambda))
p_pois = ggplot(df_rpois) +
  aes(X) +
  geom_bar(aes(y = after_stat(prop)), width = 0.4) +
  geom_col(data = df_dpois, aes(y = Prob), alpha = 0.5, fill = "#56B4E9") +
  theme_bw(base_size = 20) +
  theme(
    panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
    panel.grid.major.x = element_blank(), axis.ticks = element_blank()
  )

cowplot::plot_grid(p_mle, p_pois, nrow = 1L, rel_widths = c(2, 1))
```

---
## æœ€å°¤æ¨å®šã‚’ä½¿ã£ã¦ã‚‚â€œçœŸã®Î»â€ã¯å¾—ã‚‰ã‚Œãªã„

ä»Šå›ã®ãƒ‡ãƒ¼ã‚¿ã¯çœŸã®ç”Ÿæˆãƒ«ãƒ¼ãƒ«â€œ$X \sim \text{Poisson}(\lambda = 3.0)$â€ã§ä½œã£ãŸã€‚\
ã€Œ50å€‹ä½“ã‚µãƒ³ãƒ—ãƒ«â†’æœ€å°¤æ¨å®šã€ã‚’1,000å›ç¹°ã‚Šè¿”ã—ã¦ã¿ã‚‹ã¨:

```{r, poisson-mle-repl}
#| echo: false
#| fig.height: 5
#| fig.width: 12
set.seed(19937)
nrep = 1000L
df_repl = tibble::tibble(X = rpois(50L * nrep, 3), repl = rep(seq_len(nrep), each = 50L))
df_sum = df_repl |>
  dplyr::group_by(repl) |>
  dplyr::summarize(lambda = mean(X))
df_minmax = dplyr::bind_rows(dplyr::slice_max(df_sum, lambda), dplyr::slice_min(df_sum, lambda))

p_repl = df_sum |>
  ggplot() +
  aes(lambda) +
  geom_histogram(bins = 25, center = 3) +
  annotate("point", x = df_minmax$lambda, y = 0, color = "#56B4E9", size = 8, alpha = 0.5) +
  labs(x = "estimated_lambda") +
  theme_bw(base_size = 20) +
  theme(
    panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
    axis.ticks = element_blank()
  )

df_dpois = tidyr::crossing(lambda = df_minmax$lambda, X = seq(0, 11)) |>
  dplyr::mutate(Prob = dpois(X, lambda))
p_minmax = df_repl |>
  dplyr::filter(repl %in% df_minmax$repl) |>
  dplyr::left_join(df_minmax, by = "repl") |>
  ggplot() +
  aes(X) +
  geom_bar(aes(y = after_stat(prop)), width = 0.4) +
  geom_col(data = df_dpois, aes(y = Prob), alpha = 0.5, fill = "#56B4E9") +
  facet_wrap(vars(lambda), ncol = 1L, labeller = label_both) +
  theme_bw(base_size = 20) +
  theme(
    panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
    panel.grid.major.x = element_blank(), axis.ticks = element_blank()
  )

cowplot::plot_grid(p_repl, p_minmax, nrow = 1L, rel_widths = c(2, 1))
```

ã‚µãƒ³ãƒ—ãƒ«ã®å–ã‚Œæ–¹ã«ã‚ˆã£ã¦ã¯ã‹ãªã‚Šã‚ºãƒ¬ãŸæ¨å®šã‚’ã—ã¦ã—ã¾ã†ã€‚\
(æ¨™æœ¬ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚ã¦ã¯ã¾ã‚Šã¯ã‹ãªã‚Šè‰¯ãè¦‹ãˆã‚‹ã®ã«ï¼)


---
## ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºã‚’å¢—ã‚„ã™ã»ã©ãƒã‚·ã«ã¯ãªã‚‹

â€œ$X \sim \text{Poisson}(\lambda = 3.0)$â€ã‹ã‚‰nã‚µãƒ³ãƒ—ãƒ«â†’æœ€å°¤æ¨å®šã‚’1,000å›ç¹°ã‚Šè¿”ã™:

```{r, poisson-mle-nsam}
#| echo: false
#| fig.height: 4
#| fig.width: 12
set.seed(19937)
nrep = 1000L
purrr::map(c(5, 50, 500, 5000), \(n) {
  tibble::tibble(X = rpois(n * nrep, 3), repl = rep(seq_len(nrep), each = n)) |>
    dplyr::group_by(repl) |>
    dplyr::summarize(estimated_lambda = mean(X)) |>
    dplyr::mutate(n = n)
}) |>
  purrr::list_rbind() |>
  ggplot() +
  aes(estimated_lambda) +
  geom_histogram(bins = 25, center = 3) +
  facet_wrap(vars(n), nrow = 1L, labeller = label_both) +
  theme_bw(base_size = 20) +
  theme(
    panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(),
    axis.ticks = element_blank()
  )
```

Q. ã˜ã‚ƒã‚ã©ã‚Œãã‚‰ã„ã®ã‚µãƒ³ãƒ—ãƒ«æ•°nã‚’ç¢ºä¿ã™ã‚Œã°ã„ã„ã®ã‹ï¼Ÿ\
A. æ¨å®šã—ãŸã„çµ±è¨ˆé‡ã¨ã‹ã€è¨±å®¹ã§ãã‚‹èª¤å·®ã¨ã‹ã«ã‚ˆã‚‹ã€‚


---
## ã™ã¹ã¦ã®ãƒ¢ãƒ‡ãƒ«ã¯é–“é•ã£ã¦ã„ã‚‹

ç¢ºç‡åˆ†å¸ƒãŒã„ã„æ„Ÿã˜ã«æœ€å°¤æ¨å®šã§ããŸã¨ã—ã¦ã‚‚ã€\
ãã‚Œã¯ã‚ãã¾ã§ãƒ¢ãƒ‡ãƒ«ã€‚ä»®å®šã€‚è¿‘ä¼¼ã€‚

> All models are wrong, but some are useful. --- George E. P. Box

<figure>
<img src="../tokiomarine2021/math-model.drawio.svg" width="900">
<figcaption><cite>ã€Œãƒ‡ãƒ¼ã‚¿åˆ†æã®ãŸã‚ã®æ•°ç†ãƒ¢ãƒ‡ãƒ«å…¥é–€ã€æ±Ÿå´è²´è£• 2020 ã‚ˆã‚Šæ”¹å¤‰</cite></figcaption>
</figure>


---
## çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã®é“å…· --- ã¾ã¨ã‚

- ä½•ã¯ã¨ã‚‚ã‚ã‚Œä½œå›³ã—ã¦ä¿¯ç°
- **ç¢ºç‡å¤‰æ•°** $X$
- **ç¢ºç‡åˆ†å¸ƒ** $X \sim f(\theta)$
    - **å°‘ãªã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿** $\theta$ ã§ã°ã‚‰ã¤ãã®æ§˜å­ã‚’è¡¨ç¾
    - **ã“ã®ç¾è±¡ã¯ã“ã®åˆ†å¸ƒã‚’ä½œã‚ŠãŒã¡(ã€œã«å¾“ã†)** ã¨ã„ã†çŸ¥è¦‹ãŒã‚ã‚‹
- **å°¤åº¦**
    - ã‚ã‚‹ãƒ¢ãƒ‡ãƒ«ã§ã“ã®ãƒ‡ãƒ¼ã‚¿ã«ãªã‚‹ç¢ºç‡ $\Pr(D \mid M)$
    - ãƒ‡ãƒ¼ã‚¿å›ºå®šã§ãƒ¢ãƒ‡ãƒ«æ¢ç´¢ â†’ **å°¤åº¦é–¢æ•°** $L(M \mid D),~L(\theta \mid D)$
    - å¯¾æ•°ã‚’å–ã£ãŸã»ã†ãŒæ‰±ã„ã‚„ã™ã„ â†’ **å¯¾æ•°å°¤åº¦** $\log L(M \mid D)$
    - ã“ã‚Œã‚’æœ€å¤§åŒ–ã™ã‚‹ã‚ˆã†ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ $\hat \theta$ æ¢ã— ï¼ **æœ€å°¤æ³•**


---
## ğŸ”° 4æ—¥ç›®ã®èª²é¡Œ1: å°¤åº¦

ã‚µã‚¤ã‚³ãƒ­ã‚’10å›æŒ¯ã£ãŸã‚‰6ã®ç›®ãŒ3å›å‡ºãŸã€‚

1. 6ã®ç›®ã®å‡ºã‚‹ç¢ºç‡ãŒ1/6ã ã¨ã—ãŸå ´åˆã®å°¤åº¦ã¯?

1. 6ã®ç›®ã®å‡ºã‚‹ç¢ºç‡ãŒ0.2ã ã¨ã—ãŸå ´åˆã®å°¤åº¦ã¯?

1. æ¨ªè»¸ã‚’6ã®ç›®ã®å‡ºã‚‹ç¢ºç‡ã€ç¸¦è»¸ã‚’å¯¾æ•°å°¤åº¦ã¨ã™ã‚‹ã‚°ãƒ©ãƒ•ã‚’æã“ã†ã€‚

1. ã“ã®ã‚µã‚¤ã‚³ãƒ­ã§6ã®ç›®ãŒå‡ºã‚‹ç¢ºç‡ã‚’æœ€å°¤æ¨å®šã—ã‚ˆã†ã€‚\
   æ•°å­¦ã§è§£ã‘ã‚Œã°å„ªã€‚Rã§è¦‹ã¤ã‘ã‚Œã°è‰¯ã€‚ç›®åˆ†é‡ãƒ»å‹˜ã§å¯ã€‚

ãƒ’ãƒ³ãƒˆ
: ç¢ºç‡pã§å½“ãŸã‚‹ã‚¯ã‚¸ã‚’nå›å¼•ã„ã¦kå›å½“ãŸã‚‹ç¢ºç‡ã€ã¨åŒã˜è¨ˆç®—ã‚’ä½¿ã†ã€‚
: æ•°å­¦ã® $\binom 5 2 = {}_5 \mathrm{C} _2 = 10$ ã¯Rã§ã¯ `choose(5, 2)` ã€‚


```{r, get-likelihood}
#| include: false
get_likelihood = function(p, k = 3, n = 10) {
  choose(n, k) * p ** k * (1 - p) ** (n - k)
  # dbinom(k, n, p)
}

get_likelihood(0.2)
```

---
## å‚è€ƒæ–‡çŒ®

- [ãƒ‡ãƒ¼ã‚¿è§£æã®ãŸã‚ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€](https://amzn.to/33suMIZ) ä¹…ä¿æ‹“å¼¥ 2012
- [Stanã¨Rã§ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°](https://amzn.to/3uwx7Pb) æ¾æµ¦å¥å¤ªéƒ 2016
- [Rã¨Stanã§ã¯ã˜ã‚ã‚‹ ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿åˆ†æå…¥é–€](https://amzn.to/3o1eCzP) é¦¬å ´çœŸå“‰ 2019
- [ãƒ‡ãƒ¼ã‚¿åˆ†æã®ãŸã‚ã®æ•°ç†ãƒ¢ãƒ‡ãƒ«å…¥é–€](https://amzn.to/3uCxTKo) æ±Ÿå´è²´è£• 2020
- [åˆ†æè€…ã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿è§£é‡ˆå­¦å…¥é–€](https://amzn.to/3uznzCK) æ±Ÿå´è²´è£• 2020
- [çµ±è¨ˆå­¦ã‚’å“²å­¦ã™ã‚‹](https://amzn.to/3ty80Kv) å¤§å¡šæ·³ 2020
- [ç§‘å­¦ã¨ãƒ¢ãƒ‡ãƒ«---ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å“²å­¦ å…¥é–€](https://amzn.to/2Q0f6JQ) Michael Weisberg 2017\
  (åŸè‘—: [Simulation and Similarity](https://amzn.to/3bdvhuI) 2013)

`r .meta$next_link`
