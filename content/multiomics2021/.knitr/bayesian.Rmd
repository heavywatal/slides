+++
url = "multiomics2021/bayesian.html"
title = "ãƒ™ã‚¤ã‚ºæ¨å®šã€éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ« â€” ãƒãƒ«ãƒNGSã‚ªãƒŸã‚¯ã‚¹è§£æç ”ç©¶ä¼š #10"
linktitle = "ãƒ™ã‚¤ã‚ºæ¨å®šã€éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«"
date = 2021-12-14T14:00:00+09:00
type = "reveal"
draft = false
+++

# [ç¢ºç‡åˆ†å¸ƒã‚’ç†è§£ã™ã‚‹çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€](.)

<div class="author">
å²©åµœ èˆª (Watal M. Iwasaki, PhD)
</div>

<div class="affiliation">
æ±åŒ—å¤§å­¦ ç”Ÿå‘½ç§‘å­¦ç ”ç©¶ç§‘ é€²åŒ–ã‚²ãƒãƒŸã‚¯ã‚¹åˆ†é‡ ç‰¹ä»»åŠ©æ•™<br>
(Graduate School of Life Sciences, Tohoku University)
</div>

<ol>
<li><a href="distribution.html">çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°åŸºç¤: ç¢ºç‡åˆ†å¸ƒã€å°¤åº¦</a>
<li><a href="glm.html">ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã€æ··åˆãƒ¢ãƒ‡ãƒ«</a>
<li class="current-deck"><a href="bayesian.html">ãƒ™ã‚¤ã‚ºçµ±è¨ˆã€éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«</a>
</ol>

<div class="footnote">
2021-12-14 æ±äº¬å¤§å­¦ ä¸­æˆ¸ç ” <a href="https://amedprime-nakatolab.github.io/Seminar/10.html">ãƒãƒ«ãƒNGSã‚ªãƒŸã‚¯ã‚¹è§£æç ”ç©¶ä¼š #10</a><br>
<a href="https://heavywatal.github.io/slides/multiomics2021/">https://heavywatal.github.io/slides/multiomics2021/</a>
</div>

```{r setup-global, include=FALSE, code=readLines("setup.R")}
```

```{r setup-local, include=FALSE}
library(ggplot2)
library(tibble)
library(dplyr)
library(tidyr)
knitr::opts_chunk$set(cache = TRUE)
```

---
## å…¨ä½“ã®æ§‹æˆ

<figure style="float: right;">
<a href="https://kuboweb.github.io/-kubo/ce/IwanamiBook.html">
<img src="../tokiomarine2021/image/kubo-book.jpg" width="280" alt="ãƒ‡ãƒ¼ã‚¿è§£æã®ãŸã‚ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€ ä¹…ä¿æ‹“å¼¥ 2012">
</a>
</figure>

ä¹…ä¿å…ˆç”Ÿã®"ç·‘æœ¬"ã“ã¨<br>
ã€Œãƒ‡ãƒ¼ã‚¿è§£æã®ãŸã‚ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€ã€<br>
ã‚’ãƒ™ãƒ¼ã‚¹ã«å›å¸°åˆ†æã®æ¦‚è¦ã‚’ç´¹ä»‹ã€‚

1. ã‚¤ãƒ³ãƒˆãƒ­ [(#7 9/30)](distribution.html)
1. çµ±è¨ˆãƒ¢ãƒ‡ãƒ«ã®åŸºæœ¬
    - ç¢ºç‡å¤‰æ•°ãƒ»**ç¢ºç‡åˆ†å¸ƒ** ğŸ‘ˆ ä¸»å½¹
    - å°¤åº¦ãƒ»æœ€å°¤æ¨å®š
1. ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã€æ··åˆãƒ¢ãƒ‡ãƒ« [(#10 12/14 å‰åŠ)](glm.html)
1. ãƒ™ã‚¤ã‚ºçµ±è¨ˆã€éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ« [(#10 12/14 å¾ŒåŠ)](bayesian.html)

å›å¸°ã®ã‚­ãƒ¢ã¯**ç·šã§ã¯ãªãåˆ†å¸ƒ**ã€‚

<hr>
<cite>

[Data Science Hill Climb 2021 (æ±äº¬æµ·ä¸Š) ã§ã®è¬›ç¾© (~6æ™‚é–“)](https://heavywatal.github.io/slides/tokiomarine2021/)
ã®æ¼”ç¿’ç„¡ã—æŠœç²‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (~2æ™‚é–“ x 2å›)ã€‚

</cite>


---
## ã‚³ã‚¤ãƒ³ãƒˆã‚¹4å›ã€ãŸã¾ãŸã¾è¡¨ãŒ1å›ã ã£ãŸã‚‰

<div class="column-container">
  <div class="column" style="flex-shrink: 1.0;">

æœ€å°¤æ¨å®š
: æ¨å®šçµæœã¯æœ€ã‚‚å°¤ã‚‚ã‚‰ã—ã„1ç‚¹ã€‚
: ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„ã¨ãéå‰°é©åˆæ°—å‘³ã€‚
: è¡¨ãŒå‡ºã‚‹ç¢ºç‡ p = 0.25 ã®ã‚³ã‚¤ãƒ³ã ã‚ã†ã€‚<br>
  (ä¿¡ã˜é›£ã„ã‘ã©ãƒ‡ãƒ¼ã‚¿ã¯ã“ã†è¨€ã£ã¦ã„ã‚‹)

<br>

ãƒ™ã‚¤ã‚ºæ¨å®š
: æ¨å®šçµæœã¯ç¢ºç‡åˆ†å¸ƒãã®ã‚‚ã®ã€‚
: ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„ãªã‚Šã®ä¸ç¢ºå®Ÿã•ã‚‚è¡¨ç¾ã€‚
: p = 0.25 ã‚‰ã¸ã‚“ã§ã‚ã‚‹ç¢ºç‡ã¯é«˜ã„ãŒã€<br>
  p = 0.6 ã¨ã‹ã§ã‚ã‚‹å¯èƒ½æ€§ã‚‚ã¾ã‚ã‚ã‚‹ã€‚

  </div>
  <div class="column" style="flex-shrink: 1.4;">

```{r freq-vs-bayes, echo = FALSE, fig.height = 4, fig.width = 4}
tibble::tibble(p = seq(0, 1, 0.01), logLik = dbinom(1, 4, p, log = TRUE)) %>%
  dplyr::filter(logLik > -1e6) %>%
  ggplot() + aes(p, logLik) +
  geom_line() +
  geom_point(data = function(.x) {dplyr::slice_max(.x, logLik)}, shape = 16, size = 5, color = "#3366ff") +
  geom_vline(data = function(.x) {dplyr::slice_max(.x, logLik)}, aes(xintercept = p), color = "#3366ff") +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank())

tibble::tibble(p = seq(0, 1, 0.01), Density = dbeta(p, 2, 4)) %>%
  ggplot() + aes(p, Density) +
  geom_area(fill = "#3366ff", alpha = 0.5) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank())
```

  </div>
</div>


---
## ã‚³ã‚¤ãƒ³ãƒˆã‚¹ã®å›æ•°ãŒå¢—ãˆã¦ã„ã£ãŸã‚‰

**æœ€å°¤æ¨å®š**: æ¨å®šå€¤ãŒçœŸã®å€¤ã«è¿‘ã¥ã„ã¦ã„ã

```{r coin-frequentist, echo = FALSE, fig.width = 11, fig.height = 3}
size = 1L; p = 0.5
X = c(0L, 0L, 0L, 1L, rbinom(496L, size, p))
df_rbinom = purrr::map_dfr(c(4, 20, 100, 500), ~{
  k = sum(head(X, .x))
  tibble::tibble(label = sprintf("%d / %d", k, .x), p = seq(0, 1, 0.01), logLik = dbinom(k, .x, p, log = TRUE))
}) %>%
  # dplyr::bind_rows(tibble(p = seq(0, 1, 0.01), logLik = dbinom(sum(head(X, .x)), .x, p, log = TRUE), Repl = Inf))
  dplyr::filter(logLik > -20) %>%
  dplyr::mutate(label = factor(label, levels = unique(label)))
df_rbinom %>%
  group_by(label) %>%
  ggplot() + aes(p, logLik) +
  geom_line() +
  geom_point(data = function(.x) {dplyr::slice_max(.x, logLik)}, shape = 16, size = 5, color = "#3366ff") +
  geom_vline(data = function(.x) {dplyr::slice_max(.x, logLik)}, aes(xintercept = p), color = "#3366ff") +
  facet_wrap(vars(label), nrow = 1L) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank())
```

**ãƒ™ã‚¤ã‚ºæ¨å®š**: ç¢ºç‡åˆ†å¸ƒãŒã©ã‚“ã©ã‚“å°–ã‚Šã€ç¢ºä¿¡ãŒå¼·ã¾ã‚‹

```{r coin-bayesian, echo = FALSE, fig.width = 11, fig.height = 3}
purrr::map_dfr(c(4, 20, 100, 500), ~{
  k = sum(head(X, .x))
  tibble::tibble(label = sprintf("%d / %d", k, .x), p = seq(0, 1, 0.01), Density = dbeta(p, k + 1, .x - k + 1))
}) %>%
  dplyr::mutate(label = factor(label, levels = unique(label))) %>%
  ggplot() + aes(p, Density) +
  geom_area(fill = "#3366ff", alpha = 0.5) +
  facet_wrap(vars(label), nrow = 1L) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank())
```

---
## ç¢ºç‡ãŠã•ã‚‰ã„

åŒæ™‚åˆ†å¸ƒ/çµåˆç¢ºç‡: <span style="font-weight: normal;"> <span style="color: #E69F00;">A</span>ã‹ã¤<span style="color: #0072B2;">B</span>ã®ç¢ºç‡</span>
: $\text{Prob}(\textcolor{#E69F00}{A}, \textcolor{#0072B2}{B}) = \text{Prob}(\textcolor{#E69F00}{A} \cap \textcolor{#0072B2}{B}) = \text{Prob}(\textcolor{#E69F00}{A}) \text{Prob}(\textcolor{#0072B2}{B})$

å‘¨è¾ºç¢ºç‡: <span style="font-weight: normal;"> <span style="color: #0072B2;">B</span>ã«ã‚ˆã‚‰ãš<span style="color: #E69F00;">A</span>ã«ãªã‚‹ç¢ºç‡</span>
: $\text{Prob}(\textcolor{#E69F00}{A}) = \sum_{\textcolor{#0072B2}{B}} \text{Prob}(\textcolor{#E69F00}{A}, \textcolor{#0072B2}{B})$

æ¡ä»¶ä»˜ãç¢ºç‡: <span style="font-weight: normal;"> <span style="color: #0072B2;">B</span>ã§ã‚ã‚‹æ¡ä»¶ã®ä¸‹ã§<span style="color: #E69F00;">A</span>ã«ãªã‚‹ç¢ºç‡ã€‚é‡è¦ã€‚</span>
: $\text{Prob}(\textcolor{#E69F00}{A} \mid \textcolor{#0072B2}{B}) = \frac {\text{Prob}(\textcolor{#E69F00}{A}, \textcolor{#0072B2}{B})} {\text{Prob}(\textcolor{#0072B2}{B})}$

```{r venn, echo = FALSE, fig.width = 6, fig.height = 3}
make_circle = function(radius, center, n = 100L) {
  tibble::tibble(theta = seq(0, 2 * pi, length.out = n + 1L)[-1]) %>%
    dplyr::mutate(x = radius * cos(theta) + center[1],
                  y = radius * sin(theta) + center[2])
}
#grDevices::palette.colors(palette = "Okabe-Ito")
ggplot() + aes(x, y) +
  geom_polygon(data = make_circle(5, c(0, 0)), fill = "#E69F00", alpha = 0.5) +
  geom_polygon(data = make_circle(1, c(4.3, 0)), fill = "#0072B2", alpha = 0.5) +
  coord_fixed(xlim = c(-7, 7)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank())
```


---
## æ¡ä»¶ä»˜ãç¢ºç‡ãŒã‚ˆãã‚ã‹ã‚‹å…·ä½“ä¾‹

<span style="color: #0072B2;">B Brewery</span>ã®ãƒ“ãƒ¼ãƒ«ãŒ<span style="color: #E69F00;">Awesome</span>ãªç¢ºç‡
: $\text{Prob}(\textcolor{#E69F00}{\text{Awesome}} \mid \textcolor{#0072B2}{\text{B Brewery}}) = \frac {\text{Prob}(\textcolor{#E69F00}{\text{Awesome}},~\textcolor{#0072B2}{\text{B Brewery}})} {\text{Prob}(\textcolor{#0072B2}{\text{B Brewery}})}$
: ã‹ãªã‚Šé«˜ã„ç¢ºç‡ã€‚è‰¯ã„é†¸é€ æ‰€ã€‚

<span style="color: #E69F00;">Awesome</span>ãªãƒ“ãƒ¼ãƒ«ãŒ<span style="color: #0072B2;">B Brewery</span>ã®ã‚‚ã®ã§ã‚ã‚‹ç¢ºç‡
: $\text{Prob}(\textcolor{#0072B2}{\text{B Brewery}} \mid \textcolor{#E69F00}{\text{Awesome}}) = \frac {\text{Prob}(\textcolor{#E69F00}{\text{Awesome}},~\textcolor{#0072B2}{\text{B Brewery}})} {\text{Prob}(\textcolor{#E69F00}{\text{Awesome}})}$
: ã‹ãªã‚Šä½ã„ç¢ºç‡ã€‚Awesomeãªãƒ“ãƒ¼ãƒ«ã¯ã»ã‹ã«ã‚‚ãŸã£ãã•ã‚“ã‚ã‚‹ã€‚

<img src="figure/venn-1.png" alt="plot of chunk venn">


---
## ãƒ™ã‚¤ã‚ºã®å®šç†

ä¹—æ³•å®šç†
: $\text{Prob}(\textcolor{#E69F00}{A},~\textcolor{#0072B2}{B}) = \text{Prob}(\textcolor{#E69F00}{A} \mid \textcolor{#0072B2}{B})~\text{Prob}(\textcolor{#0072B2}{B}) = \text{Prob}(\textcolor{#0072B2}{B} \mid \textcolor{#E69F00}{A})~\text{Prob}(\textcolor{#E69F00}{A})$

<a href="https://en.wikipedia.org/wiki/Thomas_Bayes">
<img src="../tokiomarine2021/image/Thomas_Bayes.gif" height="150" align="right"></a>

ç§»é …ã™ã‚‹ã ã‘ã§**ãƒ™ã‚¤ã‚ºã®å®šç†**:
<img src="../tokiomarine2021/bayes.drawio.svg" style="padding-left: 1rem;">

å®´ä¼šå ´ã«ãƒ“ãƒ¼ãƒ«ãŒé‹ã°ã‚Œã¦ããŸã€‚ã“ã‚Œã¯ã©ã“ã®ãƒ–ãƒ«ãƒ¯ãƒªãƒ¼ã®ï¼Ÿ

äº‹å‰ç¢ºç‡: $\text{Prob}(\textcolor{#0072B2}{B})$
: é£²ã‚€å‰ã€æ‰‹å…ƒã®ãƒ“ãƒ¼ãƒ«ãŒ<span style="color: #0072B2;">B Brewery</span>ã®ã§ã‚ã‚‹ç¢ºç‡ã€‚
: â†“ ğŸ» é£²ã‚“ã§ã¿ã¦æ›´æ–°

äº‹å¾Œç¢ºç‡: $\text{Prob}(\textcolor{#0072B2}{B} \mid \textcolor{#E69F00}{A})$
: é£²ã‚“ã§ã¿ã¦<span style="color: #E69F00;">Awesome</span>ã ã£ãŸãƒ“ãƒ¼ãƒ«ãŒ
  <span style="color: #0072B2;">B Brewery</span>ã®ã§ã‚ã‚‹ç¢ºç‡ã€‚


---
## ãƒ™ã‚¤ã‚ºã®å®šç† in æ„ŸæŸ“ç—‡æ¤œæŸ»

- æœ‰ç—…ç‡ $\text{Prob}(M)$ : 0.3% (ã“ã®åœ°åŸŸã®æ„ŸæŸ“è€…ã®å‰²åˆ; äº‹å‰ç¢ºç‡)
- æ„Ÿåº¦ $\text{Prob}(P \mid M)$ : 90% (æ„ŸæŸ“ã—ã¦ã‚‹äººã«é™½æ€§åˆ¤å®šãŒå‡ºã‚‹)
- ç‰¹ç•°åº¦ $\text{Prob}(N \mid \overline{M})$: 99% (æ„ŸæŸ“ã—ã¦ãªã„äººã«é™°æ€§åˆ¤å®šãŒå‡ºã‚‹)

$\text{Prob}(M \mid P)$ çœŸé™½æ€§ç‡(æ¤œæŸ»é™½æ€§ã®äººãŒå®Ÿéš›ã«æ„ŸæŸ“è€…ã§ã‚ã‚‹ç¢ºç‡)ã¯ï¼Ÿ

<div>\[\begin{split}
\text{Prob}(M \mid P)
  &= \frac {\text{Prob}(P \mid M)~\text{Prob}(M)} {\text{Prob}(P)} \\
  &= \frac {\text{Prob}(P \mid M)~\text{Prob}(M)}
           {\text{Prob}(P \mid M)~\text{Prob}(M) + (1 - \text{Prob}(N \mid \overline{M}))~\text{Prob}(\overline{M})} \\
  &= \frac {0.9 \times 0.003} {0.9 \times 0.003 + 0.01 \times 0.997} \approx 0.21
\end{split}\]</div>

æ„ŸæŸ“è€…ã‚’éš”é›¢ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ç›®çš„ã§ã¯ä½¿ã„ã‚‚ã®ã«ãªã‚‰ãªã„æ€§èƒ½ã€‚

ğŸ”° åŒæ§˜ã« $\text{Prob}(\overline{M} \mid N)$ çœŸé™°æ€§ç‡ã‚’è¨ˆç®—ã—ã¦ã¿ã‚ˆã†<br>
ğŸ”° è¨ˆç®—çµæœãŒæ¤œæŸ»æ€§èƒ½ã ã‘ã§ãªãæœ‰ç—…ç‡ã«ã‚‚ä¾å­˜ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã‚ˆã†

```{r infection-test, echo = FALSE, eval = FALSE, include = FALSE}
sensitivity = 0.9
specificity = 0.99
prevalence = 0.003
p_positive = (prevalence * sensitivity + (1 - prevalence) * (1 - specificity))
p_negative = ((1 - prevalence) * specificity + prevalence * (1 - sensitivity))
devnull = tibble::tibble(
  true_positive = prevalence * sensitivity / p_positive,
  false_positive = (1 - prevalence) * (1 - specificity) / p_positive,
  true_negative = (1 - prevalence) * specificity / p_negative,
  false_negative = prevalence * (1 - sensitivity) / p_negative,
)
```


---
## ãƒ™ã‚¤ã‚ºã®å®šç† in çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°

<p>
<img src="../tokiomarine2021/bayesian.drawio.svg">
</p>

ãƒ¢ãƒ‡ãƒ«$M$ã«å¯¾ã™ã‚‹ç¢ºä¿¡åº¦åˆã„ã‚’ãƒ‡ãƒ¼ã‚¿$D$ã«åŸºã¥ã„ã¦æ›´æ–°ã™ã‚‹ã€‚<br>
ãƒ¢ãƒ‡ãƒ«$M$ã‚’ä»®èª¬$H$ã‚„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿$\theta$ã«ç½®ãæ›ãˆã¦ã‚‚ã„ã„ã€‚

**å‘¨è¾ºå°¤åº¦**ã¯ã€Œç¢ºç‡åˆ†å¸ƒã®ç©åˆ†ã¯1ã€ã‚’æº€ãŸã™ãŸã‚ã®æ­£è¦åŒ–å®šæ•°ã¨ã¿ãªã›ã‚‹ã€‚<br>
æ¯”ä¾‹é–¢ä¿‚ã ã‘æŠœãå‡ºã—ã¦ã“ã†æ›¸ãã“ã¨ãŒå¤šã„:
<div>\[\begin{split}
\text{Prob}(M \mid D) &\propto \text{Prob}(D \mid M)~\text{Prob}(M) \\
\text{Prob}(H \mid D) &\propto \text{Prob}(D \mid H)~\text{Prob}(H) \\
\text{Prob}(\theta \mid D) &\propto \text{Prob}(D \mid \theta)~\text{Prob}(\theta)
\end{split}\]</div>


---
## è¡¨ãŒå‡ºã‚‹ç¢ºç‡ã®ãƒ™ã‚¤ã‚ºæ¨å®š: 1. äº‹å‰åˆ†å¸ƒ

ã‚³ã‚¤ãƒ³ãƒˆã‚¹ã‚’ç¹°ã‚Šè¿”ã—ã¦ã€è¡¨ãŒå‡ºã‚‹ç¢ºç‡pã‚’ãƒ™ã‚¤ã‚ºæ¨å®šã—ãŸã„ã€‚

äº‹å‰åˆ†å¸ƒã«ã¯**ãƒ™ãƒ¼ã‚¿åˆ†å¸ƒ**ã‚’æ¡ç”¨(ç†ç”±ã¯å¾Œã§åˆ†ã‹ã‚‹):
<div>\[\begin{split}
\text{Beta}(p \mid a, b) =
   \frac{\Gamma(a + b)}{\Gamma(a) \Gamma(b)} p^{a-1} (1 - p)^{b-1}
\end{split}\]</div>

åˆ†å¸ƒã®å½¢ã¯ $a,~b$ ã«ã‚ˆã£ã¦æ±ºã¾ã‚‹ã€‚<br>
ã‚¬ãƒ³ãƒé–¢æ•°ã®éƒ¨åˆ†ã¯å³ã¤ãè¦‹ãˆã‚‹ã‘ã©ãŸã ã®æ­£è¦åŒ–å®šæ•°ã€‚<br>
æŠ•ã’ã‚‹å‰ãªã®ã§ã¨ã‚Šã‚ãˆãšçœŸã£å¹³ã‚‰ã‚’ä»®å®š $\text{Beta}(p \mid a = 1, b = 1)$:

```{r prior-beta, echo = FALSE, fig.width = 3, fig.height = 3}
size = 1L; p = 0.5
X = c(0L, 0L, 0L, 1L, rbinom(496L, size, p))
df_beta = purrr::map_dfr(c(0, 1, 2, 3, 4, 20, 100, 500), ~{
  k = sum(head(X, .x))
  tibble::tibble(
    i = .x,
    label = sprintf("%d / %d", k, .x),
    p = seq(0, 1, 0.01),
    Density = dbeta(p, k + 1, .x - k + 1))
}) %>%
  dplyr::mutate(label = factor(label, levels = unique(label)))

df_beta %>%
  dplyr::filter(i == 0) %>%
  ggplot() + aes(p, Density) +
  geom_area(fill = "#3366ff", alpha = 0.5) +
  coord_cartesian(ylim = c(0, 3)) +
  labs(title = "Prior") +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank())
```

---
## è¡¨ãŒå‡ºã‚‹ç¢ºç‡ã®ãƒ™ã‚¤ã‚ºæ¨å®š: 2. å°¤åº¦é–¢æ•°

4å›æŠ•ã’ã¦è¡¨ãŒ1å›ã ã£ãŸã€ã¨ã„ã†ãƒ‡ãƒ¼ã‚¿ã§**å°¤åº¦**ã‚’è¨ˆç®—(**äºŒé …åˆ†å¸ƒ**):
<div>\[\begin{split}
\text{Binom}(1 \mid 4,~p) = \binom {1} {4} p^{1} (1 - p)^{3}
\end{split}\]</div>

ã“ã‚Œã«äº‹å‰åˆ†å¸ƒã‚’æ›ã‘ã¦æ­£è¦åŒ–ã—ãŸã‚‰äº‹å¾Œåˆ†å¸ƒã«ãªã‚‹ã¯ãšã€‚

<div class="column-container">
  <div class="column" style="flex-shrink: 2.0;">

```{r likelihood-binom, echo = FALSE, fig.width = 3, fig.height = 3}
tibble::tibble(p = seq(0, 1, 0.02), L = dbinom(1, 4, p)) %>%
  ggplot() + aes(p, L) +
  geom_line(color = "#3366ff", size = 2) +
  labs(title = "Likelihood") +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank())
```

  </div>
  <div class="column" style="flex-shrink: 4.0; padding-top: 3rem;">
  â¨‰
  </div>
  <div class="column" style="flex-shrink: 1.0;">
<p>
<img src="figure/prior-beta-1.png" alt="plot of chunk prior-beta">
</p>
  </div>
</div>


---
## è¡¨ãŒå‡ºã‚‹ç¢ºç‡ã®ãƒ™ã‚¤ã‚ºæ¨å®š: 3. äº‹å¾Œåˆ†å¸ƒ

ãªã‚“ã¨ã€äº‹å¾Œåˆ†å¸ƒã‚‚ãƒ™ãƒ¼ã‚¿åˆ†å¸ƒã«ãªã‚‹ã€‚

<div>\[\begin{split}
\text{Posterior}
  &\propto \text{Binom}(1 \mid 4,~p) \times \text{Beta}(p \mid  1, 1)\\
  &= \binom {1} {4} p^{1} (1 - p)^{3} \times
     \frac{\Gamma(1 + 1)}{\Gamma(1) \Gamma(1)} p^{1-1} (1 - p)^{1-1} \\
  &= C p^{2-1} (1 - p)^{4-1} \\
  &= \text{Beta}(p \mid 2, 4)
\end{split}\]</div>

ãƒ™ãƒ¼ã‚¿åˆ†å¸ƒã®å½¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿$a$ãŒè¡¨ã€$b$ãŒè£ã®å›æ•°åˆ†ã ã‘å¢—åŠ ã€‚

<div class="column-container">
  <div class="column" style="flex-shrink: 1.0;">

```{r posterior-beta, echo = FALSE, fig.width = 3, fig.height = 3}
df_beta %>%
  dplyr::filter(i == 4) %>%
  ggplot() + aes(p, Density) +
  geom_area(fill = "#3366ff", alpha = 0.5) +
  coord_cartesian(ylim = c(0, 3)) +
  labs(title = "Posterior") +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank())
```
  </div>
  <div class="column" style="flex-shrink: 4.0; padding-top: 3rem;">
  $\propto$
  </div>
  <div class="column" style="flex-shrink: 1.0">
<p>
<img src="figure/likelihood-binom-1.png" alt="plot of chunk likelihood-binom">
</p>
  </div>
  <div class="column" style="flex-shrink: 4.0; padding-top: 3rem;">
  â¨‰
  </div>
  <div class="column" style="flex-shrink: 1.0;">
<p>
<img src="figure/prior-beta-1.png" alt="plot of chunk prior-beta">
</p>
  </div>
</div>


---
## è¡¨ãŒå‡ºã‚‹ç¢ºç‡ã®ãƒ™ã‚¤ã‚ºæ¨å®š: 4. é€æ¬¡å­¦ç¿’

ã•ã£ãã®äº‹å¾Œåˆ†å¸ƒã‚’äº‹å‰åˆ†å¸ƒã¨ã—ã¦ã€ã•ã‚‰ã«ãƒ‡ãƒ¼ã‚¿ã‚’é›†ã‚ã‚‹ã€‚

ã‚³ã‚¤ãƒ³ãƒˆã‚¹4å›ã®ã†ã¡è¡¨1å›ã€ã«åŸºã¥ã**äº‹å‰åˆ†å¸ƒ**: $\text{Beta}(p \mid 2,~4)$

ã•ã‚‰ã«16å›æŠ•ã’ãŸã‚‰è¡¨ãŒ7å›ã€ã®**å°¤åº¦**: $\text{Binomial}(7 \mid 16,~p)$

**äº‹å¾Œåˆ†å¸ƒ**ã¯ã¾ãŸäº‹å‰åˆ†å¸ƒã¨åŒã˜å½¢ã«ãªã‚‹:

<div>\[\begin{split}
\text{Beta}(p \mid 9, 13) \propto
  \text{Binomial}(7 \mid 16,~p) \times \text{Beta}(p \mid 2, 4)
\end{split}\]</div>

ãƒ‡ãƒ¼ã‚¿ã‚’åŠ ãˆã‚‹ãŸã³ã«æ›´æ–°ã—ã¦ã„ã‘ã‚‹:

<img src="figure/coin-bayesian-1.png" alt="plot of chunk coin-bayesian">


---
## å…±å½¹äº‹å‰åˆ†å¸ƒ

äº‹å¾Œåˆ†å¸ƒãŒäº‹å‰åˆ†å¸ƒã¨åŒã˜å½¢ãªã®ã§è¨ˆç®—ã—ã‚„ã™ã„ã€ã¨ã„ã†çµ„ã¿åˆã‚ã›ã€‚

| å°¤åº¦é–¢æ•° | å…±å½¹äº‹å‰åˆ†å¸ƒ |
| ---------- | ------------ |
| äºŒé …åˆ†å¸ƒ | ãƒ™ãƒ¼ã‚¿åˆ†å¸ƒ |
| ãƒã‚¢ã‚½ãƒ³åˆ†å¸ƒ | ã‚¬ãƒ³ãƒåˆ†å¸ƒ |
| æ­£è¦åˆ†å¸ƒ | ã‚¬ãƒ³ãƒåˆ†å¸ƒ |
| æ­£è¦åˆ†å¸ƒ (åˆ†æ•£æ—¢çŸ¥) | æ­£è¦åˆ†å¸ƒ |

å…±å½¹äº‹å‰åˆ†å¸ƒã‚’ä½¿ã†ã“ã¨ãŒå¸¸ã«æ­£ã—ã„ã¨ã‚‚é™ã‚‰ãªã„ã€‚<br>
è¨ˆç®—ã‚³ã‚¹ãƒˆãŒã‹ã‹ã£ã¦ã‚‚**ç„¡æƒ…å ±äº‹å‰åˆ†å¸ƒ**ã‚’ä½¿ã†é¢¨æ½®ã€‚

---
## äº‹å¾Œåˆ†å¸ƒã‚’ç”¨ã„ãŸæ¨å®š

<div class="column-container">
  <div class="column" style="flex-shrink: 1.0;">

åŒºé–“æ¨å®š
: å¹…ã®ã‚ã‚‹æ¨å®šå€¤ã‚’æç¤º
: e.g., 95%ãƒ™ã‚¤ã‚ºç¢ºä¿¡åŒºé–“<br>
  (ç­‰è£¾äº‹å¾Œä¿¡ç”¨åŒºé–“, æœ€é«˜å¯†åº¦åŒºé–“)

ç‚¹æ¨å®š
: å€¤ã‚’1ç‚¹ã ã‘æç¤º
: e.g., MAP, MED, EAP

  </div>
  <div class="column" style="flex-shrink: 1.3;">

```{r integrate, echo = FALSE, fig.width = 6, fig.height = 4}
n_head = 6
n_total = 10
bound = qbeta(c(0.025, 0.975), n_head, n_total - n_head)
.f = function(.x) {dplyr::filter(.x, dplyr::between(p, bound[1], bound[2]))}
.g = function(.x) {dplyr::slice_max(.x, Density)}
tibble::tibble(p = seq(0, 1, 0.01), Density = dbeta(p, n_head, n_total - n_head)) %>%
  ggplot() + aes(p, Density) +
  geom_hline(yintercept = 0) +
  geom_line(color = "#3366ff", size = 1) +
  geom_area(data = .f, fill = "#3366ff", alpha = 0.5) +
  geom_vline(aes(xintercept = p), data = .g, color = "#3366ff", size = 1) +
  geom_point(data = .g, color = "#3366ff", size = 5, shape = 16) +
  scale_x_continuous(breaks = round(bound, 2)) +
  labs(title = sprintf("%d / %d", n_head, n_total)) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank(),
        panel.grid.major.y = element_blank(), panel.border = element_blank())
```

  </div>
</div>

ã‚³ã‚¤ãƒ³æŠ•ã’ãƒ¢ãƒ‡ãƒ«ã®ãƒ™ãƒ¼ã‚¿åˆ†å¸ƒã¯ç¾ã—ã„ä¾‹ã€‚<br>
â†’ è§£æçš„(æ•°å­¦çš„)ã«è§£ã‘ã‚‹ã€‚

å®Ÿè·µçš„ãªãƒ¢ãƒ‡ãƒ«ãƒ»äº‹å¾Œåˆ†å¸ƒã¯ã‚‚ã£ã¨è¤‡é›‘ã€‚<br>
â†’ ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã«é ¼ã£ã¦æ•°å€¤è¨ˆç®—: MCMC

???

- 95%ãƒ™ã‚¤ã‚ºç¢ºä¿¡åŒºé–“ (credible interval): çœŸã®å€¤ãŒ95%ã®ç¢ºç‡ã§å«ã¾ã‚Œã‚‹åŒºé–“ã€‚
- ç­‰è£¾äº‹å¾Œä¿¡ç”¨åŒºé–“ (equal-tailed interval): ä¸¡ç«¯ã‹ã‚‰2.5%ãšã¤å‰Šã‚‹
- æœ€é«˜å¯†åº¦åŒºé–“ (highest density interval): åˆ†å¸ƒå¯†åº¦ã«é–¾å€¤ã‚’è¨­ã‘ã‚‹
- äº‹å¾Œä¸­å¤®å€¤ (Posteriori <u>Med</u>ian: MED)
- äº‹å¾ŒæœŸå¾…å€¤ (<u>E</u>xpected <u>A</u> <u>P</u>osteriori: EAP)
- äº‹å¾Œç¢ºç‡æœ€å¤§å€¤ (<u>M</u>aximum <u>A</u> <u>P</u>osteriori: MAP)

ä¿¡é ¼åŒºé–“ (confidence interval)
é »åº¦ä¸»ç¾©ã®è€ƒãˆæ–¹ã«åŸºã¥ã„ã¦ã„ã¦ã€è§£é‡ˆãŒé›£ã—ã„ã€‚
ã€Œæ¨™æœ¬æŠ½å‡ºã‚’100å›ç¹°ã‚Šè¿”ã™ã¨ãã®ã†ã¡ã®95å›ã¯ãã®åŒºé–“ã«æ¯å¹³å‡ãŒå«ã¾ã‚Œã‚‹ã€
çœŸã®å€¤ã¯1ã¤ã«å®šã¾ã£ã¦ã„ã¦ã€ä¸ç¢ºå®Ÿæ€§ã¯æœ‰é™ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã«ç”±æ¥ã™ã‚‹ã€‚


---
## MCMC: <u>M</u>arcov <u>C</u>hain <u>M</u>onte <u>C</u>arlo

<a href="https://en.wikipedia.org/wiki/Andrey_Markov">
<img src="../tokiomarine2021/image/AAMarkov.jpg" height="180" align="right"></a>

ãƒãƒ«ã‚³ãƒ•é€£é–
: æ¬¡ã®æ™‚ç‚¹ã®æŒ™å‹•ãŒç¾åœ¨ã®å€¤ã ã‘ã§æ±ºå®šã•ã‚Œã‚‹ã‚ˆã†ãªç¢ºç‡éç¨‹ã€‚
: $\ldots \to X_{t - 2} \to X_{t - 1} \to X_{t} \to X_{t + 1}$
: $\text{Prob}(X_{t+1} \mid X_{t}, X_{t-1}, X_{t-2}, \ldots) = \text{Prob}(X_{t+1} \mid X_{t})$
: e.g., ã™ã”ã‚ã

ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•
: ä¹±æ•°ã‚’ç”¨ã„ãŸè¨ˆç®—æ–¹æ³•ã®ç·ç§°ã€‚
: <a href="https://en.wikipedia.org/wiki/Monte_Carlo_Casino">
  <img src="../tokiomarine2021/image/Real_Monte_Carlo_Casino.jpg" height="200"></a>
  <a href="https://en.wikipedia.org/wiki/Stanislaw_Ulam">
  <img src="../tokiomarine2021/image/Stanislaw_Ulam.jpg" height="200"></a>
  <a href="https://en.wikipedia.org/wiki/John_von_Neumann">
  <img src="../tokiomarine2021/image/John_von_Neumann.jpg" height="200"></a>
  <a href="https://en.wikipedia.org/wiki/Nicholas_Metropolis">
  <img src="../tokiomarine2021/image/Nicholas_Metropolis.png" height="200"></a>

???
ã‚¹ã‚¿ãƒ‹ã‚¹ãƒ¯ãƒ•ãƒ»ã‚¦ãƒ©ãƒ ãŒã‚½ãƒªãƒ†ã‚¢ã®æˆåŠŸç‡ã‚’è€ƒãˆã¦ãŸæ™‚ã«æ€ã„ã¤ã„ã¦ã€
åŒåƒšã®ã‚¸ãƒ§ãƒ³ãƒ»ãƒ•ã‚©ãƒ³ãƒ»ãƒã‚¤ãƒãƒ³ãŒè¨ˆç®—æ©Ÿä¸Šã§ã®å®Ÿç”¨ã¾ã§æŒã£ã¦ã£ãŸã€‚
ãƒ¢ãƒŠã‚³å…¬å›½ã®ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­åœ°åŒºã«å›½å–¶ã‚«ã‚¸ãƒãŒã‚ã£ã¦ã€
ã‚¦ãƒ©ãƒ ã®å”çˆ¶ãŒãã“ã§è² ã‘ã¦è¦ªæˆšã‹ã‚‰å€Ÿé‡‘ã—ãŸã“ã¨ã«ã¡ãªã‚“ã§
åŒåƒšã®ãƒ‹ã‚³ãƒ©ã‚¹ãƒ»ãƒ¡ãƒˆãƒ­ãƒãƒªã‚¹ãŒå‘½åã—ãŸã‚‰ã—ã„ã€‚

ãƒãƒ«ã‚³ãƒ•é€£é–
: ãƒãƒ«ã‚³ãƒ•éç¨‹ã®ã†ã¡ã€é›¢æ•£çš„ãªæ™‚é–“ã‚’è€ƒãˆã‚‹ã‚‚ã®ã€‚

ãƒãƒ«ã‚³ãƒ•éç¨‹
: ãƒãƒ«ã‚³ãƒ•æ€§ã‚’æŒã¤ç¢ºç‡éç¨‹

ãƒãƒ«ã‚³ãƒ•æ€§
: æ¬¡ã®æ™‚ç‚¹ã®æŒ™å‹•ãŒç¾åœ¨ã®å€¤ã ã‘ã§æ±ºå®šã•ã‚Œã€éå»ã®å€¤ã¨ç„¡é–¢ä¿‚


æœ€é©åŒ–ã§ã¯ãªãã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æ³•


---
## ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•ã¯ä¹±æ•°ã‚’ç”¨ã„ãŸè¨ˆç®—æ–¹æ³•

e.g., åŠå¾„1ã®å††ã®é¢ç©

é¢ç©4ã®æ­£æ–¹å½¢ã«400å€‹ã®ä¸€æ§˜ä¹±æ•°ã‚’æ‰“ã¡è¾¼ã‚“ã ã‚‰318å€‹ä¹—ã£ãŸ:<br>
$4 \times \frac {318} {400} = 3.18$

```{r circle, echo = FALSE, fig.width = 4, fig.height = 4}
n = 100L
points = tibble(x = runif(n, -1, 1), y = runif(n, -1, 1))
theta = seq(0, 2 * pi, length.out = 100)
ggplot(points) + aes(x, y) +
  annotate("polygon", x = cos(theta), y = sin(theta), fill = "#888888", alpha = 0.5) +
  geom_point(shape = 16, alpha = 0.5, size = 2) +
  geom_point(data = function(.x) dplyr::filter(.x, x ^ 2 + y ^ 2 < 1), color = "#3366ff", shape = 16, size = 2) +
  coord_fixed(xlim = c(-1, 1), ylim = c(-1, 1), expand = FALSE)  +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank())
```

æ•°å­¦ã‚’çŸ¥ã£ã¦ã„ã‚Œã° $\pi r ^ 2 \approx 3.14$

---
## å¤‰ãªåˆ†å¸ƒã‚‚ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•ã§æ‰±ãˆãã†

e.g., ç¢ºç‡å¯†åº¦åˆ†å¸ƒã«å¾“ã£ã¦å¤‰æ•°Xã‚’é›†ã‚ã‚‹(æ£„å´ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°)ã€‚

```{r mcpdf, echo = FALSE, fig.width = 11, fig.height = 6}
n = 800
df_point = tibble::tibble(p = runif(n, -0.2, 1.2), Density = runif(n, 0, 5)) %>%
  dplyr::mutate(accepted = Density < (dbeta(p, 4, 6) + dbeta(p, 70, 30)) / 2)
p_pdf = tibble::tibble(p = seq(0, 1, 0.01), Density = (dbeta(p, 4, 6) + dbeta(p, 70, 30)) / 2) %>%
  ggplot() + aes(p, Density) +
  geom_hline(yintercept = 0) +
  geom_area(fill = "#000000", alpha = 0.4) +
  geom_point(data = df_point %>% filter(!accepted), shape = 16, alpha = 0.5) +
  geom_point(data = df_point %>% filter(accepted), color = "#3366ff", shape = 16, size = 2, alpha = 1) +
  labs(x = "X") +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank(),
        panel.grid.major.y = element_blank(), panel.border = element_blank(),
        axis.text = element_blank())

p_accepted = tibble::tibble(p = runif(n), th = dbeta(p, 4, 6) + dbeta(p, 70, 30)) %>%
  dplyr::filter(runif(length(p), 0, max(th)) < th) %>%
  ggplot() + aes(p) +
  geom_hline(yintercept = 0) +
  coord_cartesian(xlim = c(-0.2, 1.2)) +
  geom_histogram(bins = 20, center = 0.5, fill = "#3366ff", alpha = 0.5) +
  labs(x = "X") +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank(),
        panel.grid.major.y = element_blank(), panel.border = element_blank(),
        axis.text = element_blank())

cowplot::plot_grid(p_pdf, p_accepted, nrow = 1L)
```

ã§ã‚‚ã€ãƒã‚ºãƒ¬ã®å€¤ã‚‚ã‘ã£ã“ã†å¼•ã„ã¦ã—ã¾ã†ã€‚


---
## æ¬¡å…ƒã®å‘ªã„: é«˜æ¬¡å…ƒã«ãªã‚‹ã»ã©å½“ãŸã‚Šã«ãããªã‚‹

(Næ¬¡å…ƒçƒã®ä½“ç© / Næ¬¡å…ƒã®ç«‹æ–¹ä½“) ã¯ã‚¼ãƒ­ã«è¿‘ã¥ã„ã¦ã„ãã€‚

<img src="figure/circle-1.png" width="210" align="right">

- 2æ¬¡å…ƒ: $\frac {\pi r ^ 2} {(2r) ^ 2} = \frac \pi 4 \approx 0.79$
- 3æ¬¡å…ƒ: $\frac {\frac 4 3 \pi r ^ 3} {(2r) ^ 3} = \frac \pi 6 \approx 0.52$
- Næ¬¡å…ƒ: $\frac {\frac {\pi ^ {N/2}} {\Gamma (N/2 + 1)} r ^ N} {(2r) ^ N} = \frac {\pi ^ {N/2}} {2^N \Gamma (N/2 + 1)} \to 0$

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¢—ãˆã‚‹ã¨è¨ˆç®—é‡(â‰ˆä¹±æ•°ã®ç„¡é§„æ’ƒã¡)ãŒæ€¥å¢—ã€‚

<hr>

å¯†åº¦ã®é«˜ã„ã€Œå½“ãŸã‚Šã€ä»˜è¿‘ã‚’åŠ¹ç‡ã‚ˆãæ¢ç´¢ã—ãŸã„ã€‚<br>
ã€Œå½“ãŸã‚Šã€ã¯ã€Œå½“ãŸã‚Šã€ã®è¿‘ãã«ã‚ã‚ŠãŒã¡ã ã‚ã†ã€‚<br>
â†’ ãƒãƒ«ã‚³ãƒ•é€£é–ãŒä½¿ãˆãã†


---
## Metropolis--Hastingsæ³• (MHæ³•)

0.  ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ $\theta$ ã®åˆæœŸå€¤ã‚’é¸ã¶
1.  $\theta$ ã‚’ã¡ã‚‡ã£ã¨å¢—æ¸›ã•ã›ã¦ $\theta_\text{new}$ ã‚’ä½œã‚‹
2.  ãã‚Œãã‚Œå°¤åº¦ã‚’è¨ˆç®—ã—ã€æ¯”è¼ƒã€‚
    - $L(\theta_\text{new}) \ge L(\theta)$ ãªã‚‰ $\theta_\text{new}$ ã‚’å³æ¡æŠ
    - $L(\theta_\text{new}) < L(\theta)$ ã§ã‚‚
      ç¢ºç‡ $r = \frac {L(\theta_\text{new})} {L(\theta)}$ ã§  $\theta_\text{new}$ ã‚’æ¡æŠ
3.  $\theta_\text{new}$ ãŒæ¡æŠã•ã‚ŒãŸã‚‰ $\theta$ ã‚’æ›´æ–°ã€‚æ‰‹é †1ã«æˆ»ã‚‹ã€‚

```{r metropolis, echo = FALSE, fig.width = 11, fig.height = 3.5}
n_head = 12
n_total = 20
dp = 0.02
df_point = tibble::tibble(p = seq(0.48, 0.64, dp), logLik = dbinom(n_head, n_total, p, log = TRUE))
offset = 0.005
df_arrow = df_point %>%
  dplyr::group_by(p) %>%
  dplyr::mutate(data = purrr::map_dfr(p, ~{
    pl = p + offset
    pr = p + dp - offset
    ll = dbinom(n_head, n_total, pl, log = TRUE)
    lr = dbinom(n_head, n_total, pr, log = TRUE)
    if (ll < lr) {
      data.frame(pbegin = pl, pend = pr, lbegin = ll, lend = lr)
    } else {
      data.frame(pbegin = pr, pend = pl, lbegin = lr, lend = ll)
    }
  })) %>%
  tidyr::unpack(data)

.ar = grid::arrow(angle = 20, length = grid::unit(0.11, "inches"), type = "closed")
.ar2 = grid::arrow(angle = 20, length = grid::unit(0.09, "inches"), type = "closed", ends = "first")
.aes = aes(pbegin, lbegin, xend = pend, yend = lend)
df_point %>%
  ggplot() + aes(p, logLik) +
  geom_segment(data = df_arrow, .aes, linejoin = "mitre", size = 1, position = position_nudge(0, +0.008), arrow = .ar) +
  geom_segment(data = df_arrow, .aes, linejoin = "mitre", size = 1, position = position_nudge(0, -0.008), arrow = .ar2, alpha = 0.33) +
  geom_point(size = 6, alpha = 0.6, shape = 16) +
  labs(x = expression(theta)) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank())
```

---
## æ¡æŠã•ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å€¤ã®è»Œè·¡

å°¤åº¦ãŒé«˜ã„æ–¹ã«ãŸã å‘ã‹ã†ã ã‘ã§ãªãã€çµæ§‹ã†ã‚ã¤ãã€‚<br>
é€šã£ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å€¤ã‚’é›†ã‚ã‚‹ã¨ã„ã„æ„Ÿã˜ã®åˆ†å¸ƒãŒå¾—ã‚‰ã‚Œã‚‹ã€‚

```{r metropolis-trajectory, echo = FALSE, fig.show = "animate", animation.hook = "gifski", interval = 0.2, fig.width = 12, fig.height = 6}
dp = 0.05
mh_sample = function(n, p0, n_head, n_total, dp) {
  p = p0
  lp = dbinom(n_head, n_total, p, log = FALSE)
  posterior = p
  for (i in seq.int(2L, n)) {
    p_new = p + sample(c(-dp, dp), 1)
    lp_new = suppressWarnings(dbinom(n_head, n_total, p_new, log = FALSE))
    if (is.nan(lp_new)) next
    if (lp_new > lp) {
      p = p_new
      lp = lp_new
    } else {
      if (runif(1L) < (lp_new / lp)) {
        p = p_new
        lp = lp_new
      }
    }
    posterior = c(posterior, p)
  }
  tibble::tibble(p = posterior) %>% tibble::rowid_to_column("t")
}
n = 1000
df_traj = mh_sample(n, 0.1, n_head, n_total, dp = dp)

p_traj = df_traj %>%
  ggplot() + aes(t, p) +
  geom_line() +
  coord_cartesian(xlim = c(0, n), ylim = c(0, 1)) +
  labs(title = "traceplot", y = expression(theta), x = "iterations") +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank())

p_hist = df_traj %>%
  ggplot() + aes(p) +
  geom_bar(width = 0.6 * dp) +
  coord_flip(xlim = c(0, 1)) +
  labs(title = "MCMC samples") +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank(),
        axis.title.y = element_blank(), axis.text.y = element_blank())

ymax = max(ggplot_build(p_hist)$data[[1]]$count)

for (i in seq.int(50, 1000, 50)) {
  df_traj_head = df_traj %>% head(i)
  p1 = p_traj %+% df_traj_head
  p2 = p_hist %+% df_traj_head + ylim(c(0, ymax))
  p = cowplot::plot_grid(p1, p2, nrow = 1L, rel_widths = c(4, 1))
  print(p)
}
```


---
## å°¤åº¦ã«æ¯”ä¾‹ã™ã‚‹äº‹å¾Œåˆ†å¸ƒã‹ã‚‰ã‚µãƒ³ãƒ—ãƒ«ã—ãŸã®ã¨ç­‰ä¾¡

å…¨ä½“ã«ã°ã‚‰æ’’ãæ£„å´ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‚ˆã‚Šã‚‚åŠ¹ç‡ã‚ˆãé›†ã‚ã‚‰ã‚Œã‚‹ã€‚<br>
ãŒã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿1ã¤ã®1æ¬¡å…ƒã§ã¯ã”åˆ©ç›Šã¯ã‚ã‹ã‚Šã«ãã„ã€‚

```{r propto-lik, echo = FALSE, fig.width = 11, fig.height = 4}
p_lik = tibble::tibble(p = seq(0, 1, 0.01), Likelihood = dbinom(n_head, n_total, p, log = FALSE)) %>%
  ggplot() + aes(p, Likelihood) +
  geom_hline(yintercept = 0) +
  geom_line(size = 2) +
  labs(title = "Likelihood", x = expression(theta)) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank(),
        panel.grid.major.y = element_blank(), panel.border = element_blank())

p_dens = tibble::tibble(p = seq(0, 1, 0.01), Density = dbeta(p, n_head, n_total - n_head)) %>%
  ggplot() + aes(p, Density) +
  geom_hline(yintercept = 0) +
  geom_area(alpha = 0.5) +
  labs(title = "Posterior", x = expression(theta)) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank(),
        panel.grid.major.y = element_blank(), panel.border = element_blank())

p_hist = df_traj %>% tail(-100) %>%
  ggplot() + aes(p) +
  geom_hline(yintercept = 0) +
  geom_bar(width = 0.6 * dp) +
  coord_cartesian(xlim = c(0, 1)) +
  labs(title = "MCMC samples", x = expression(theta), y = "Count") +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank(),
        panel.grid.major.y = element_blank(), panel.border = element_blank())

cowplot::plot_grid(p_lik, p_dens, p_hist, nrow = 1L)
```

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒè¤‡æ•°ã‚ã‚‹å ´åˆã¯ï¼Ÿ

???
ã“ã‚Œã¯ã€Œã‚³ã‚¤ãƒ³10å›æŠ•ã’ã¦6å›è¡¨ã€‚è¡¨ã®å‡ºã‚‹ç¢ºç‡pã¯ï¼Ÿã€ã¨ã„ã†ç°¡å˜ãªãƒ¢ãƒ‡ãƒ«ã€‚


---
## Gibbs Sampling

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒè¤‡æ•°ã®å ´åˆã€Œã»ã‹ã‚’å›ºå®šã—ã¦ã²ã¨ã¤æ›´æ–°ã€ã‚’ç¹°ã‚Šè¿”ã™ã€‚

e.g., äºŒæ¬¡å…ƒæ­£è¦åˆ†å¸ƒã€‚(-2, 2) ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã€‚

```{r gibbs, echo = FALSE, fig.show = "animate", animation.hook = "gifski", interval = 0.1, fig.width = 5, fig.height = 5}
gibbs_sample = function(n, rho) {
  x = double(n)
  y = double(n)
  x[1] = -2
  y[1] = 2
  for (i in seq.int(2, n)) {
    x[i] = rnorm(1, rho * y[i - 1], sqrt(1 - rho ** 2))
    y[i] = rnorm(1, rho * x[i], sqrt(1 - rho ** 2))
  }
  x = rep(x, each = 2)
  y = rep(y, each = 2)
  tibble::tibble(x = x[-1], y = y[-2 * n])
}

rho = 0.8
df_gibbs = gibbs_sample(40, rho)

p_tile = tidyr::crossing(x = seq(-3, 3, 0.05), y = x) %>%
  dplyr::mutate(z = x^2 + y^2 - 2 * rho * x * y,
                d = (1 / (2 * pi * sqrt(1 - rho ** 2))) * exp(-0.5 * z / (1 - rho ** 2))) %>%
  ggplot() + aes(x, y) +
  geom_tile(aes(fill = d)) +
  scale_fill_gradient(low = "#f8f8f8", high = "black") +
  coord_fixed(expand = FALSE) +
  theme_void() + theme(legend.position = "none")

for (i in seq.int(2L, nrow(df_gibbs), 2L)) {
  df_i = head(df_gibbs, i)
  p = p_tile +
    geom_path(data = df_i, color = "#3366ff", alpha = 0.5, size = 1) +
    geom_point(data = df_i, color = "#3366ff", alpha = 0.5, shape = 16)
  print(p)
}
```


---
## ä¸­é–“ã¾ã¨ã‚

- ãƒ™ã‚¤ã‚ºæ¨å®šã§ã¯ä¸ç¢ºå®Ÿæ€§ã‚‚è¡¨ç¾ã§ãã‚‹ã€‚
- ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã«é ¼ã£ãŸè¨ˆç®—æ–¹æ³•ã¨ã—ã¦ã®ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•ã€‚
- å¤šæ¬¡å…ƒã§ã‚‚åŠ¹ç‡ã‚ˆãã‚µãƒ³ãƒ—ãƒ«ã™ã‚‹ãŸã‚ã®MCMCã€‚

<hr>

ã“ã“ã‹ã‚‰ã€å®Ÿè¡Œã™ã‚‹ã«ã‚ãŸã£ã¦ã®æ³¨æ„ç‚¹ã‚’è¦‹ã¦ã„ãã€‚


---
## ä½•å›ã‚„ã£ã¦ã‚‚ä¼¼ãŸã‚ˆã†ãªçµæœã«ãªã£ã¦ã»ã—ã„

ä¹±æ•°ã‚„åˆæœŸå€¤ã«ã‚ˆã£ã¦å¶ã€…ã€ã˜ã‚ƒãªã„ã“ã¨ã‚’ç¢ºèªã—ãŸã„ã€‚

e.g., `chains = 3, iter = 600` ã€‚ã»ã¼åŒã˜ã¨ã“ã‚ã‚’ã†ã‚ã†ã‚:

```{r chains, echo = FALSE, fig.height = 5, fig.width = 12}
df_trace = tibble::tibble(init = c(0.1, 0.5, 0.9)) %>%
  dplyr::mutate(data = purrr::map(init, ~{mh_sample(600, .x, 18, 30, dp = 0.02)})) %>%
  tidyr::unnest(data) %>%
  dplyr::mutate(p = round(p, 2))
t_warmup = 200
p_trace = ggplot(df_trace) + aes(t, p, group = init) +
  geom_path(aes(color = as.factor(init)), size = 1) +
  scale_color_discrete(guide = NULL) +
  labs(title = "traceplot", y = expression(theta), x = "iterations") +
  coord_cartesian(ylim = c(0, 1)) +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank())

p_hist = df_trace %>%
  dplyr::mutate(init = as.factor(init)) %>%
  ggplot() + aes(p) +
  geom_bar(aes(fill = init), position = position_stack(reverse = TRUE)) +
  coord_flip(xlim = c(0, 1)) +
  labs(title = "MCMC samples") +
  theme_bw(base_size = 18) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank(),
        axis.title.y = element_blank(), axis.text.y = element_blank(),
        legend.position = "none")
cowplot::plot_grid(p_trace, p_hist, nrow = 1L, rel_widths = c(4, 1))
```

åæŸ(convergence)ã®åˆ¤å®šã«ã¤ã„ã¦ã¯å¾Œã»ã©ã€‚

---
## åˆæœŸå€¤ã®å½±éŸ¿ãŒæ¶ˆãˆã‚‹ã¾ã§ã‚¦ã‚©ãƒ¼ãƒŸãƒ³ã‚°ã‚¢ãƒƒãƒ—

å®šå¸¸åˆ†å¸ƒã®å±±ã«åˆ°é”ã—ã¦ã‹ã‚‰ãŒæœ¬ç•ªã€‚

e.g., `iter = 600, warmup = 200` ã§ç°è‰²ã®éƒ¨åˆ†ã‚’æ¨ã¦ã‚‹:

```{r warmup, echo = FALSE, fig.height = 5, fig.width = 12}
cowplot::plot_grid(
  p_trace + annotate("ribbon", x = c(0, t_warmup), ymin = Inf, ymax = -Inf, alpha = 0.3),
  p_hist %+% (df_trace %>% dplyr::mutate(init = as.factor(ifelse(t < t_warmup, NA, init)))),
  nrow = 1L, rel_widths = c(4, 1))
```

ã©ã‚Œãã‚‰ã„é•·ãæ¨ã¦ã‚‹ã¹ãã‹ã¯å ´åˆã«ã‚ˆã‚‹ã€‚


---
## é©åº¦ã«é–“å¼•ã„ã¦è‡ªå·±ç›¸é–¢ã‚’è»½æ¸›ã—ãŸã„

ç›´å‰ã®å€¤ã¨ä¼¼ã™ãã¦ã„ãŸã‚‰ç‹¬ç«‹ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦æ‰±ãˆãªã„ã®ã§ã€‚

e.g., `thin = 5` ã§5å›ã«1å›ã ã‘ã‚µãƒ³ãƒ—ãƒ«ã™ã‚‹:

```{r thin, echo = FALSE, fig.height = 5, fig.width = 7, message = FALSE}
p_trace +
  coord_cartesian(ylim = c(0, 1), xlim = c(200, 260)) +
  geom_point(data = function(.x) {dplyr::filter(.x, t %% 5 == 0)}, alpha = 0.6, size = 3, shape = 16)
```

é–“å¼•ã‹ãªãã¦ã‚‚å¤§ä¸ˆå¤«ãªå ´åˆã‚‚ã€é–“å¼•ã„ã¦ã‚‚è§£æ±ºã—ãªã„å ´åˆã‚‚ã‚ã‚‹ã€‚



---
## åæŸåˆ¤å®š

- è¤‡æ•°chainsãƒ»è¤‡æ•°åˆæœŸå€¤ã§å®Ÿè¡Œã—ã€è»Œè·¡ã‚„åˆ†å¸ƒã‚’å¯è¦–åŒ–
- Gelman-Rubinçµ±è¨ˆé‡ $\hat R < 1.05$
- Effective Sample Size (ESS) $N_\text{eff} > 100$ per chain

```{r convergence, echo = FALSE, fig.height = 3, fig.width = 11, message = FALSE, warning = FALSE}
data = list(x = rep(10L, 10L))
data$N = length(data$x)
model_yes = rstan::stan_model("converge-yes.stan")
model_no = rstan::stan_model("converge-no.stan")
fit_yes = rstan::sampling(model_yes, data = data)
fit_no = rstan::sampling(model_no, data = data)
s = rstan::summary(fit_yes, pars = "lambda")$summary
template = "Rhat = %.4f, n_eff = %.1f"
label_yes = sprintf(template, s[, "Rhat"], s[, "n_eff"])
s = rstan::summary(fit_no, pars = "lambda")$summary
label_no = sprintf(template, s[, "Rhat"], s[, "n_eff"])
p1 = rstan::stan_trace(fit_yes, pars = "lambda") + labs(title = label_yes)
p2 = rstan::stan_trace(fit_no, pars = "lambda") + labs(title = label_no)
cowplot::plot_grid(p1, p2, nrow = 1L)
```

```
Warning: The largest R-hat is ***, indicating chains have not mixed.
Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
http://mc-stan.org/misc/warnings.html
```

???
https://ill-identified.hatenablog.com/entry/2020/05/21/001158


---
## åæŸãƒ»è‡ªå·±ç›¸é–¢ãŒæ‚ªã„å ´åˆã«ã©ã†æ”¹å–„ã™ã‚‹ã‹

- å°æ‰‹å…ˆã®å¯¾å‡¦
    - warmupã¨iterã‚’ã‚‚ã£ã¨é•·ãã™ã‚‹
    - thinã‚’å¤§ããã—ã¦é–“å¼•ã
- ã¡ã‚‡ã£ã¨å¤§æ›ã‹ã‚Š
    - ãƒ¢ãƒ‡ãƒ«ã‚’è¦‹ç›´ã™
    - ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’è¦‹ç›´ã™
    - ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãƒ»ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’å¤‰ãˆã‚‹

---
##  MCMCã®æ–¹æ³•ã„ã‚ã„ã‚

æ¡æŠç‡ã‚’é«˜ã‚ã€æ—©ãåæŸã™ã‚‹ã‚ˆã†ã«æ”¹è‰¯ã•ã‚Œã¦ãã¦ã„ã‚‹ã€‚

- Metropolis--Hastingsæ³•
    - Gibbs Sampling
    - Hamiltonian Monte Carlo (HMC)
        - No-U-Turn Sampler (NUTS)


---
## MCMCã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢

- [BUGS](https://www.mrc-bsu.cam.ac.uk/software/bugs/)
    - ã‚¯ãƒ­ãƒ¼ã‚ºãƒ‰ã‚½ãƒ¼ã‚¹ã§ã€ã»ã¼Windowså°‚ç”¨ã€‚
- [JAGS](https://mcmc-jags.sourceforge.io/)
    - ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã§ã€ã•ã¾ã–ã¾ãªOSãƒ»è¨€èªã‹ã‚‰åˆ©ç”¨å¯èƒ½ã€‚
    - ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚„ç”¨ä¾‹ãŒä¸è¶³ã€‚
- [**Stan**](https://mc-stan.org/) ğŸ‘ˆ
    - ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã§ã€ã•ã¾ã–ã¾ãªOSãƒ»è¨€èªã‹ã‚‰åˆ©ç”¨å¯èƒ½ã€‚
    - é–‹ç™ºã‚‚åˆ©ç”¨ã‚‚æ´»ç™ºã€‚ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚„ç”¨ä¾‹ã‚‚å……å®Ÿã€‚
    - HMC/NUTSã«ã‚ˆã‚Šæ—©ãåæŸã€‚
- [PyMC3](https://docs.pymc.io/)
- [NumPyro](https://num.pyro.ai/)
- [TensorFlow Probability](https://www.tensorflow.org/probability/)


---
## Stan

<a href="https://mc-stan.org/">
<img src="/slides/image/stan/logo_name.png" width="120" align="right">
</a>

- Stanè¨€èªã§ãƒ¢ãƒ‡ãƒ«ã‚’æ›¸ã
- C++ã‚’ä»‹ã—ã¦æ©Ÿæ¢°èªã«ç¿»è¨³(ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«)ã™ã‚‹ã®ã§é«˜é€Ÿ
- Rã‚„Pythonãªã©ã‹ã‚‰å‘¼ã³å‡ºã—ã¦ä½¿ã†ã®ãŒä¾¿åˆ©

```r
# install.packages("rstan")
library(rstan)
rstan_options(auto_write = TRUE)
```

---
## ãŠãŠã¾ã‹ãªæµã‚Œ

```r
# ãƒ‡ãƒ¼ã‚¿æº–å‚™
mydata

# Stanè¨€èªã§æ›¸ã„ãŸãƒ¢ãƒ‡ãƒ«ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
model = rstan::stan_model(file = "model.stan")

# MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
fit = rstan::sampling(model, data = mydata)

# çµæœã‚’çœºã‚ã‚‹
print(fit)
rstan::stan_trace(fit)
rstan::stan_hist(fit)
rstan::stan_ac(fit)
```


---
## èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š: ãƒ‡ãƒ¼ã‚¿æº–å‚™

è¡¨ãŒå‡ºã‚‹ç¢ºç‡ $p=0.7$ ã®ã‚¤ã‚«ã‚µãƒã‚³ã‚¤ãƒ³ã‚’Nå›æŠ•ã’ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½œã‚‹ã€‚<br>
ã“ã® $p$ ã‚’Stanã§æ¨å®šã—ã¦ã¿ã‚ˆã†ã€‚

```{r stan-set-seed, echo = FALSE}
set.seed(42)
```
```{r stan-binom, fig.width = 4, fig.height = 4}
true_p = 0.7
N = 40L
mydata = list(N = N, x = rbinom(N, 1, true_p))
print(mydata)
```

Rãªã‚‰listå‹ã€Pythonãªã‚‰dictå‹ã«ã¾ã¨ã‚ã¦Stanã«æ¸¡ã™ã€‚


---
## èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š: Stanè¨€èªã§ãƒ¢ãƒ‡ãƒ«å®šç¾©

æ–‡å­—åˆ—ã¨ã—ã¦ä¿æŒã™ã‚‹ã‹ã€åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ã„ã¦ãŠã:

```{r read-binom-stan, code = 'cat(readr::read_file("binom.stan"))', echo = FALSE}
```

- ã„ãã¤ã‹ã®ãƒ–ãƒ­ãƒƒã‚¯ã«åˆ†ã‘ã¦è¨˜è¿°ã™ã‚‹:<br>
  R/Pythonã‹ã‚‰å—ã‘å–ã‚‹ `data`, æ¨å®šã™ã‚‹ `parameter`, æœ¬ä½“ã® `model`.
- æ•´æ•°å‹ `int`, å®Ÿæ•°å‹ `real`, ãã‚Œã‚‰ã®é…åˆ—ãŒã‚ã‚‹ã€‚
- ä¸‹é™ `lower`, ä¸Šé™ `upper` ã‚’è¨­å®šã§ãã‚‹ã€‚


---
## Stanè¨€èªã®7ç¨®ã®ãƒ–ãƒ­ãƒƒã‚¯

é †ç•ªå³å®ˆã€‚ã‚ˆãä½¿ã†ã®ã¯**å¤ªå­—ã®ã‚„ã¤**ã€‚

1. `functions {...}`
1. **`data {...}`**
1. `transformed data {...}`
1. **`parameters {...}`**
1. `transformed parameters {...}`
1. **`model {...}`**
1. `generated quantities {...}`

<https://mc-stan.org/docs/reference-manual/overview-of-stans-program-blocks.html>


---
## èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š: MCMCã‚µãƒ³ãƒ—ãƒ«

äºˆã‚å®Ÿè¡Œé€Ÿåº¦ã®é€Ÿã„æ©Ÿæ¢°èªã«ç¿»è¨³(ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«):

```{r stan-binom-model, fig.width = 4, fig.height = 4}
model = rstan::stan_model("binom.stan")
```

ã“ã‚Œã«çµæ§‹æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã§ã€å¤‰æ›´ãŒç„¡ã‘ã‚Œã°å†åˆ©ç”¨ã™ã‚‹ãŸã‚å…ˆã»ã©
`rstan_options(auto_write = TRUE)` ã—ã¦ãŠã„ãŸã€‚

<hr>

ãƒ¢ãƒ‡ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°:

```{r stan-binom-sample, fig.width = 4, fig.height = 3}
fit = rstan::sampling(model, data = mydata)
```

ã„ã‚ã„ã‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã‚ã‚‹ã‘ã©ã¨ã‚Šã‚ãˆãšãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§:<br>
`chains = 4`, `iter = 2000`, `warmup = floor(iter/2)`, `thin = 1`, ...

å•é¡ŒãŒã‚ã£ãŸã‚‰å®Ÿè¡Œçµ‚äº†æ™‚ã«è­¦å‘Šã—ã¦ãã‚Œã‚‹ã®ã§**ã¡ã‚ƒã‚“ã¨èª­ã‚€**ã€‚

---
## èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š: çµæœã‚’çœºã‚ã‚‹

$\hat R$ ã‚‚ã»ã¼1ã§ $N_\text{eff}$ ã‚‚å¤§ãã„ã®ã§ã‚ˆã•ãã†ã€‚<br>
å¿µã®ãŸã‚ trace plot ã‚‚ç¢ºèªã—ã¦ãŠã“ã†ã€‚

```{r stan-binom-fit, fig.width = 4, fig.height = 3}
print(fit)
```

ä¹±æ•°ã‚’ä½¿ã£ãŸè¨ˆç®—ãªã®ã§(ä¹±æ•°ã‚·ãƒ¼ãƒ‰ã‚’å›ºå®šã—ãªã„é™ã‚Š)æ¯å›å¤‰ã‚ã‚‹ã€‚


---
## èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š: trace plot ç¢ºèª

ã©ã®chainã‚‚ä¼¼ãŸç¯„å›²ã‚’å‹•ã„ã¦ã„ã¦ã€ã—ã£ã‹ã‚Šæ¯›è™«ã£ã½ã„:

```{r stan-binom-traceplot, fig.width = 11, fig.height = 4}
rstan::stan_trace(fit)
```

---
## èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š: è‡ªå·±ç›¸é–¢ã®ç¢ºèª

2--3ã‚¹ãƒ†ãƒƒãƒ—ãã‚‰ã„ã§è‡ªå·±ç›¸é–¢ãŒã»ã¼æ¶ˆãˆã‚‹ã®ã§å•é¡Œãªã—:

```{r stan-binom-ac, fig.width = 4, fig.height = 4}
rstan::stan_ac(fit, pars = c("p"))
```

---
## èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š: æ¨å®šçµæœç¢ºèª

ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºNãŒå°ã•ã„ã›ã„ã‹è£¾é‡ã®åºƒã„æ¨å®šçµæœã€‚<br>
çœŸã®$p$ã®å€¤ã‚‚å«ã¾ã‚Œã¦ã„ã‚‹:

```{r stan-binom-hist, fig.width = 4, fig.height = 4}
rstan::stan_hist(fit, bins = 30)
```

æ¬¡ã¯ã‚‚ã†å°‘ã—ã ã‘è¤‡é›‘ãªä¾‹ã‚’è¦‹ã¦ã¿ã‚ˆã†ã€‚

---
## ç·šå½¢å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: ãƒ‡ãƒ¼ã‚¿æº–å‚™

<a href="https://allisonhorst.github.io/palmerpenguins/">
<cite>https://allisonhorst.github.io/palmerpenguins/</cite><br>
<img src="/slides/image/rstats/lter_penguins.png" width="45%">
<img src="/slides/image/rstats/culmen_depth.png" width="45%">
</a>

```{r stan-penguins-glm, echo = FALSE, fig.width = 7, fig.height = 4, warning = FALSE}
if (!require(palmerpenguins, quietly = TRUE)) {
  install.packages("palmerpenguins")
  library(palmerpenguins)
}
penguins_colors = c(Adelie = "darkorange", Chinstrap = "purple", Gentoo = "cyan4")

p_penweight = penguins %>%
  ggplot() + aes(body_mass_g, flipper_length_mm) +
  geom_point(shape = 16, alpha = 0.66) +
  scale_color_manual(values = penguins_colors) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank())

fit1 = glm(flipper_length_mm ~ body_mass_g, data = penguins)
p_penweight +
  geom_line(aes(y = pred), data = modelr::add_predictions(penguins, fit1), size = 1, color = "#3366ff")
```


---
## ç·šå½¢å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: ãƒ‡ãƒ¼ã‚¿æº–å‚™

<a href="https://allisonhorst.github.io/palmerpenguins/">
<cite>https://allisonhorst.github.io/palmerpenguins/</cite><br>
<img src="/slides/image/rstats/lter_penguins.png" width="45%">
<img src="/slides/image/rstats/culmen_depth.png" width="45%">
</a>

`Stan does not support NA` ã¨æ€’ã‚‰ã‚Œã‚‹ã®ã§æ¬ æå€¤ã‚’å–ã‚Šé™¤ã„ã¦ãŠã:

```{r stan-penguins-bill-data, echo = FALSE, fig.width = 7, fig.height = 4}
data = penguins %>%
  dplyr::select(c("body_mass_g", "flipper_length_mm")) %>%
  tidyr::drop_na() %>%
  as.list()
data$N = length(data$body_mass_g)
str(data)
```

---
## å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: Stanè¨€èªã§ãƒ¢ãƒ‡ãƒ«å®šç¾©

åˆ‡ç‰‡ã€å‚¾ãã€ã°ã‚‰ã¤ãã‚’æ¨å®šã™ã‚‹:

```{r read-penguins-stan, code = 'cat(readr::read_file("penguins.stan"))', echo = FALSE}
```


---
## å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: MCMCã‚µãƒ³ãƒ—ãƒ«

äºˆã‚å®Ÿè¡Œé€Ÿåº¦ã®é€Ÿã„æ©Ÿæ¢°èªã«ç¿»è¨³(ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«):

```{r stan-penguins-model, fig.width = 4, fig.height = 4}
model = rstan::stan_model("penguins.stan")
```

ãƒ¢ãƒ‡ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°:

```{r stan-penguins-sample, fig.width = 4, fig.height = 3}
fit = rstan::sampling(model, data = data)
```

ã„ã‚ã„ã‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã‚ã‚‹ã‘ã©ã¨ã‚Šã‚ãˆãšãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§:<br>
`chains = 4`, `iter = 2000`, `warmup = floor(iter/2)`, `thin = 1`, ...

å•é¡ŒãŒã‚ã£ãŸã‚‰å®Ÿè¡Œçµ‚äº†æ™‚ã«è­¦å‘Šã—ã¦ãã‚Œã‚‹ã®ã§**ã¡ã‚ƒã‚“ã¨èª­ã‚€**ã€‚

---
## å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: çµæœã‚’çœºã‚ã‚‹

$\hat R$ ã‚‚ã»ã¼1ã§ $N_\text{eff}$ ã‚‚å¤§ãã„ã®ã§ã‚ˆã•ãã†ã€‚<br>
å¿µã®ãŸã‚ trace plot ã‚‚ç¢ºèªã—ã¦ãŠã“ã†ã€‚

```{r stan-penguins-fit, fig.width = 4, fig.height = 3}
print(fit)
```


---
## å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: trace plot ç¢ºèª

ã©ã®chainã‚‚ä¼¼ãŸç¯„å›²ã‚’å‹•ã„ã¦ã„ã¦ã€ã—ã£ã‹ã‚Šæ¯›è™«ã£ã½ã„:

```{r stan-penguins-traceplot, fig.width = 11, fig.height = 4}
rstan::stan_trace(fit)
```

---
## å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: è‡ªå·±ç›¸é–¢ã®ç¢ºèª

ã©ã‚Œã‚‚ã¾ã‚ã¾ã‚ã™ãæ¶ˆãˆã‚‹ã®ã§å•é¡Œãªã—:

```{r stan-penguins-ac, fig.width = 11, fig.height = 4}
rstan::stan_ac(fit, pars = c("intercept", "slope", "sigma"))
```

---
## å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: æ¨å®šçµæœç¢ºèª

æ­£è¦åˆ†å¸ƒã£ã½ã„ãã‚Œã„ãªå½¢:

```{r stan-penguins-hist, fig.width = 11, fig.height = 3}
rstan::stan_hist(fit, bins = 30)
```

ã“ã‚Œã‚‰ã®å€¤ã‚’ä½¿ã£ã¦ç‚¹æ¨å®šãƒ»åŒºé–“æ¨å®šã‚‚å¯èƒ½ã€‚


---
## å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: æ¨å®šçµæœã§å›å¸°

ç„¡äº‹ã«æœ€å°¤æ¨å®šã¨ä¼¼ãŸã‚ˆã†ãªç·šãŒå¼•ã‘ãŸã€‚

```{r stan-penguins-regression, fig.width = 4, fig.height = 4, warning = FALSE}
coef = rstan::get_posterior_mean(fit)[, "mean-all chains"]
p_penweight +
  geom_abline(intercept = coef["intercept"], slope = coef["slope"], size = 1, color = "#3366ff")
```

---
## ãƒ™ã‚¤ã‚ºæ¨å®šã‚’ä½¿ã£ãŸå›å¸°ã«ä¾¿åˆ©ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

[rstanarm](https://mc-stan.org/rstanarm/) + [tidybayes](https://mjskay.github.io/tidybayes)

- Stanè¨€èªã®ãƒ¢ãƒ‡ãƒ«ã‚’è‡ªåˆ†ã§æ›¸ã‹ãšã«æ¸ˆã‚€ã€‚
- ãƒ¢ãƒ‡ãƒ«ã®ä¸»è¦éƒ¨å“ãŒã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¸ˆã¿ãªã®ã§è©¦è¡ŒéŒ¯èª¤ã‚‚æ©Ÿæ•ã«ã€‚
- åŒºé–“æ¨å®šã®å¯è¦–åŒ–ã¾ã§ãŠä¸–è©±ã—ã¦ãã‚Œã‚‹ã€‚

```{r rstanarm-penguins, fig.width = 8, fig.height = 4, message = FALSE, warning = FALSE}
library(rstanarm)
library(tidybayes)
fit = rstanarm::stan_glm(flipper_length_mm ~ body_mass_g, family = gaussian(), data = penguins)
pred = penguins %>% tidyr::drop_na() %>% tidybayes::add_fitted_draws(fit)
p_penweight +
  ggdist::stat_lineribbon(aes(y = .value), data = pred, color = "#3366ff", size = 0.4) +
  scale_fill_brewer(palette = "Greys")
```


---
## rstanarmã‚’ä½¿ãˆã°é‡å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®šã‚‚ç°¡å˜

GLMã®ã‚ˆã†ãªæ›¸ãå‘³ã§æ›¸ã‘ã‚‹ã€‚

```{r rstanarm-penguins-multi, fig.width = 8, fig.height = 5, message = FALSE, warning = FALSE}
fit = rstanarm::stan_glm(flipper_length_mm ~ body_mass_g + species, family = gaussian(), data = penguins)
pred = penguins %>% tidyr::drop_na() %>% tidybayes::add_fitted_draws(fit)
p_penweight + aes(color = species, group = species) +
  ggdist::stat_lineribbon(aes(y = .value), data = pred, size = 0.4) +
  scale_color_manual(values = penguins_colors) +
  scale_fill_brewer(palette = "Greys")
```


---
## GLMMã§ç™»å ´ã—ãŸå€‹ä½“å·®ã‚’éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã§

<figure>
<a href="https://kuboweb.github.io/-kubo/ce/LinksGlm.html">
<img src="../tokiomarine2021/image/kubo-p2.png" width="100%">
<figcaption class="url">ä¹…ä¿ã•ã‚“ https://kuboweb.github.io/-kubo/ce/LinksGlm.html</figcaption>
</a>
</figure>


---
## GLMMã§ç™»å ´ã—ãŸå€‹ä½“å·®ã‚’éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã§

æ¤ç‰©100å€‹ä½“ã‹ã‚‰8å€‹ãšã¤ç¨®å­ã‚’å–ã£ã¦æ¤ãˆãŸã‚‰å…¨ä½“ã§åŠåˆ†ã¡ã‚‡ã„ç™ºèŠ½ã€‚<br>
è¦ª1å€‹ä½“ã‚ãŸã‚Šã®ç”Ÿå­˜æ•°ã¯<span style="color: #3366ff;">n=8ã®äºŒé …åˆ†å¸ƒ</span>ã«ãªã‚‹ã¯ãšã ã‘ã©ã€<br>
æ¥µç«¯ãªå€¤(å…¨éƒ¨æ­»äº¡ã€å…¨éƒ¨ç”Ÿå­˜)ãŒå¤šã‹ã£ãŸã€‚å€‹ä½“å·®ï¼Ÿ

<img src="figure/overdispersion-1.png" alt="plot of chunk overdispersion">


---
## éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ¡ãƒ¼ã‚¸å›³

äº‹å‰åˆ†å¸ƒã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã€ã•ã‚‰ã«äº‹å‰åˆ†å¸ƒã‚’è¨­å®šã™ã‚‹ã®ã§éšå±¤ãƒ™ã‚¤ã‚º

<figure>
<img src="../tokiomarine2021/hbm.drawio.svg">
</figure>


---
## ã•ã£ãã®å›³ã‚’Stanè¨€èªã§è¨˜è¿°ã™ã‚‹ã¨

ãŠçµµæããƒ¢ãƒ‡ãƒ«ã¨Stanãƒ¢ãƒ‡ãƒ«ã‚’è¦‹æ¯”ã¹ã¦ã¿ã‚ˆã†ã€‚

```{r read-glmm-stan, code = 'cat(readr::read_file("glmm.stan"))', echo = FALSE}
```

`inv_logit(a + r)` ãŒ p ã«ç›¸å½“ã€‚<br>
`10` ã¨ã‹ `0.01` ã¨ã‹ã€ã‚¨ã‚¤ãƒ¤ã£ã¨æ±ºã‚ã¦ã‚‹ã‚„ã¤ãŒè¶…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‚

---
## å¤‰é‡åŠ¹æœãŒå…¥ã£ãŸæ¨å®šçµæœ

```{r stan-glmm-prep, echo=FALSE, fig.width = 4, fig.height = 3, message = FALSE}
ninds = 100L
mu_ind = 0.5
sd_ind = 3
df_od = tibble::tibble(
  z = rnorm(ninds, mu_ind, sd_ind),
  p = wtl::sigmoid(z),
  y = rbinom(ninds, 8L, p))
# sum_y = sum(df_od$y)
# p_hat = sum_y / 800
# tidy_od = df_od %>%
#   dplyr::count(y, name = "observed") %>%
#   dplyr::mutate(expected = ninds * dbinom(y, 8, p_hat)) %>%
#   tidyr::pivot_longer(!y, names_to = "key", values_to = "count") %>%
#   dplyr::mutate(width = ifelse(key == "expected", 0.8, 0.4), alpha = ifelse(key == "expected", 0.5, 1))
data = list(y = df_od$y, N = ninds)
model = rstan::stan_model("glmm.stan")
fit = rstan::sampling(model, data = data)
```

```{r stan-glmm-print, echo = FALSE, fig.width = 4, fig.height = 3}
print(fit)
```

---
## æŠœç²‹ã—ã¦ä½œå›³ã€‚æ‚ªããªã„ã€‚

ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã®çœŸã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å€¤ã¯ $a = 0.5,~s = 3.0$ ã ã£ãŸã€‚

```{r stan-glmm, echo = FALSE, fig.width = 11, fig.height = 7}
.pars = c("a", "s", "r[1]", "r[2]")
p_trace = rstan::stan_trace(fit, pars = .pars, nrow = 1L) + coord_flip()
p_hist = rstan::stan_hist(fit, pars = .pars, nrow = 1L, bins = 30)
cowplot::plot_grid(p_trace, p_hist, ncol = 1L)
```


---
## äº‹å‰åˆ†å¸ƒã®é¸åˆ¥

1.  ã¨ã‚Šã‚ãˆãš**ç„¡æƒ…å ±äº‹å‰åˆ†å¸ƒ** $[-\infty, \infty]$ã€‚Stanã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€‚

1.  åæŸãŒæ‚ªã‹ã£ãŸã‚‰**å¼±æƒ…å ±äº‹å‰åˆ†å¸ƒ**ã‚’è©¦ã™ã€‚<br>
    äº‹å¾Œåˆ†å¸ƒã‚’æ›´æ–°ã—ã¦ã„ã£ãŸã¨ã**äº‹å‰åˆ†å¸ƒã£ã½ã•ãŒæ®‹ã‚‰ãªã„**ã®ãŒè‰¯ã„ã€‚

    - å–ã‚Šã†ã‚‹å€¤ã‚’é€ƒã™ã‚ˆã†ãªç‹­ã™ãã‚‹åˆ†å¸ƒã¯ãƒ€ãƒ¡ã€‚
    - ç‹­ã™ãã‚‹ã‚ˆã‚Šã¯ãƒã‚·ã ãŒã€åºƒã™ãã¦ã‚‚è‰¯ããªã„ã€‚
    - ä¸€æ§˜åˆ†å¸ƒ $[a, b]$ ã¯ä¸€è¦‹ç„¡æƒ…å ±ã£ã½ãã¦è‰¯ã•ãã†ã ãŒã€<br>
      äº‹å¾Œåˆ†å¸ƒã«è£¾é‡ãŒæ®‹ã£ãŸã‚Šçµ¶å£ãŒã§ããŸã‚Šã—ãŒã¡ãªã®ã§å¾®å¦™ã€‚

    ãŠã™ã™ã‚: **Student's tåˆ†å¸ƒ**ã€æ­£è¦åˆ†å¸ƒã€æŒ‡æ•°åˆ†å¸ƒãªã©ã€‚

<cite><https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations></cite>


---
## StanãŠã™ã™ã‚å¼±æƒ…å ±äº‹å‰åˆ†å¸ƒ: Student's tåˆ†å¸ƒ

Student's $t(\nu=\nu_0, \mu = 0, \sigma = \sigma_0)$

- è‡ªç”±åº¦ $\nu$: å°ã•ã„ã»ã©è£¾é‡ãŒåºƒã„ã€‚$3 \le \nu_0 \le 7 $ ã§é©å½“ã«å›ºå®šã€‚
- ã‚¹ã‚±ãƒ¼ãƒ« $\sigma$: ã€Œæ¨å®šã—ãŸã„å€¤ã¯$[-\sigma_0, \sigma_0]$ã«åã¾ã‚‹ã ã‚ã†ã€ã¨ã„ã†å€¤ã€‚

```{r student_t, echo = FALSE, fig.height = 5, fig.width = 10}
tidyr::crossing(x = seq(-5, 5, 0.05), df = c(1, 3, 7, Inf)) %>%
  dplyr::mutate(nu = as.factor(df), Density = dt(x, df)) %>%
  ggplot() + aes(x, Density, group = df) +
  geom_line(aes(color = nu), size = 1, alpha = 0.7) +
  scale_color_viridis_d(end = 0.88, direction = 1, guide = guide_legend(reverse = TRUE)) +
  scale_x_continuous(breaks = c(-1, 0, 1), labels = c(expression(-sigma), 0, expression(sigma))) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank(),
        panel.grid.major.y = element_blank())
```

æ­£ã®å€¤ã—ã‹å–ã‚‰ãªã„å ´åˆã¯ `<lower=0>` ã¨ã—ã¦å³åŠåˆ†ã ã‘ä½¿ã†ã¨ã‹ã€‚


---
## éç·šå½¢å›å¸°ã®ä¾‹: ãƒ‡ãƒ¼ã‚¿

åˆºæ¿€å¼·åº¦xã«å¯¾ã™ã‚‹å¿œç­”å¼·åº¦yã‚’20å€‹ä½“èª¿æŸ»ã€‚<br>
éå¯¾ç§°ãªã²ã¨å±±ã€‚å¿œç­”å¤‰æ•°ã‚‚èª¬æ˜å¤‰æ•°ã‚‚æ­£ã®å€¤ã€‚

<div>\[\begin{split}
y = ae ^ {-bx} - ce ^ {-dx}
\end{split}\]</div>

```{r non-linear, echo = FALSE, fig.width = 10, fig.height = 5}
expo = function(x, y0, lambda) y0 * exp(- lambda * x)

genfunc = function(params) {
  function(x) {
    expo(x, params["a"], params["b"]) - expo(x, params["c"], params["d"])
  }
}

params = c(a = 0.08, b = 0.01, c = 0.05, d = 0.05)
func = genfunc(params)
n_inds = 20L
sd_inds = 0.005
shape = 60
min_ipi = 5
intercept = sort(rnorm(n_inds, 0, sd_inds))
df = tidyr::crossing(id = seq_len(n_inds), x = seq(min_ipi, 105, 10)) %>%
  dplyr::mutate(y = rgamma(length(x), shape = shape, scale = (func(x) + intercept[id]) / shape))

p_base = ggplot(df) + aes(x, y) +
  geom_point(aes(color = id), alpha = 0.7, shape = 16, size = 3) +
  geom_line(aes(color = id, group = id), alpha = 0.2) +
  xlim(0, NA) + ylim(0, NA) +
  geom_function(fun = func) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank())

p_base
```

---
## éç·šå½¢å›å¸°ã®ä¾‹: Stanã‚³ãƒ¼ãƒ‰

```stan
data {
  int<lower=1> N;
  vector[N] x;
  vector[N] y;
  int id[N];
  int<lower=1> Ninds;
}

parameters {
  real a;
  real d;
  real<upper=a> c;
  real<upper=d> b;
  real shape;
  vector[Ninds] intercept;
}

model {
  vector[N] mu = a * exp(-b * x) - (a - c) * exp(-d * x) + intercept[id];
  y ~ gamma(shape, shape ./ mu);
  a ~ exponential(1);
  b ~ exponential(1);
  c ~ exponential(1);
  d ~ exponential(1);
  shape ~ exponential(0.001);
  intercept ~ normal(0, 0.005);
}
```


---
## ãƒ™ã‚¤ã‚ºæ¨å®šã¾ã¨ã‚

- æ¡ä»¶ä»˜ãç¢ºç‡ $\text{Prob}(B \mid A)$ ã®ç†è§£ãŒå¤§äº‹ã€‚
    - äº‹å¾Œåˆ†å¸ƒ $\propto$ å°¤åº¦ â¨‰ äº‹å‰åˆ†å¸ƒ
    - ç¢ºä¿¡åº¦åˆã„ã‚’ãƒ‡ãƒ¼ã‚¿ã§æ›´æ–°ã—ã¦ã„ãã€‚
- æ¨å®šçµæœã¯åˆ†å¸ƒãã®ã‚‚ã®ã€‚
    - ãã“ã‹ã‚‰ç‚¹æ¨å®šã‚‚åŒºé–“æ¨å®šã‚‚å¯èƒ½ã€‚
- è§£æçš„ã«è§£ã‘ãªã„å•é¡Œã¯è¨ˆç®—æ©Ÿã«ä¹±æ•°ã‚’æŒ¯ã‚‰ã›ã¦è§£ãã€‚
    - ç†è«–ãƒ»æŠ€è¡“ã®é€²æ­©ãŒç›®è¦šã¾ã—ã„ã€‚


---
## å›å¸°åˆ†æãµã‚Šã‹ãˆã‚Š

ã‚ˆã‚ŠæŸ”è»Ÿã«ãƒ¢ãƒ‡ãƒ«ã‚’è¨˜è¿°ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚è¨ˆç®—æ–¹æ³•ã‚‚å¤‰åŒ–ã€‚

<figure>
<a href="https://kuboweb.github.io/-kubo/ce/LinksGlm.html">
<img src="../tokiomarine2021/image/kubo-p2.png" width="100%">
<figcaption class="url">ä¹…ä¿ã•ã‚“ https://kuboweb.github.io/-kubo/ce/LinksGlm.html</figcaption>
</a>
</figure>


---
## å…¨ä½“ã¾ã¨ã‚

- çµ±è¨ˆã¨ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’ã†ã¾ãã¾ã¨ã‚ã€ãã‚Œã«åŸºã¥ã„ã¦æ¨è«–ã™ã‚‹ãŸã‚ã®æ‰‹æ³•ã€‚
- ãƒ¢ãƒ‡ãƒ«ã«ã¯**ç†è§£å¿—å‘**ã¨**å¿œç”¨å¿—å‘**ãŒã‚ã‚Šã€çµ±è¨ˆãƒ¢ãƒ‡ãƒ«ã¯å‰è€…å¯„ã‚Šã€‚
    - ã©ã¡ã‚‰ã‚‚å¤šå°‘ã¯åˆ†ã‹ã£ãŸä¸Šã§ä½¿ã„åˆ†ã‘ãŸã„ã€‚
    - ã©ã£ã¡ã«ã—ã‚çœŸã®æ­£ã—ã„ä½•ã‹ã§ã¯ãªã„ã€‚
- **ç¢ºç‡åˆ†å¸ƒ**ã¨ãã®èƒŒå¾Œã«ã‚ã‚‹**ç¢ºç‡éç¨‹**ã®ç†è§£ãŒé‡è¦ã€‚
    - ä¹±æ•°ç”Ÿæˆâ†’ä½œå›³ã‚’ç¹°ã‚Šè¿”ã—ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ´ã‚‚ã†ã€‚
    - MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‚‚äº‹å¾Œåˆ†å¸ƒã‹ã‚‰ã®ä¹±æ•°ç”Ÿæˆã€‚


---
## å‚è€ƒæ–‡çŒ®

- [ãƒ‡ãƒ¼ã‚¿è§£æã®ãŸã‚ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€](https://amzn.to/33suMIZ) ä¹…ä¿æ‹“å¼¥ 2012
- [Stanã¨Rã§ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°](https://amzn.to/3uwx7Pb) æ¾æµ¦å¥å¤ªéƒ 2016
- [Rã¨Stanã§ã¯ã˜ã‚ã‚‹ ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿åˆ†æå…¥é–€](https://amzn.to/3o1eCzP) é¦¬å ´çœŸå“‰ 2019
- [ãƒ‡ãƒ¼ã‚¿åˆ†æã®ãŸã‚ã®æ•°ç†ãƒ¢ãƒ‡ãƒ«å…¥é–€](https://amzn.to/3uCxTKo) æ±Ÿå´è²´è£• 2020
- [åˆ†æè€…ã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿è§£é‡ˆå­¦å…¥é–€](https://amzn.to/3uznzCK) æ±Ÿå´è²´è£• 2020
- [çµ±è¨ˆå­¦ã‚’å“²å­¦ã™ã‚‹](https://amzn.to/3ty80Kv) å¤§å¡šæ·³ 2020

<a href="." class="readmore">
ç›®æ¬¡ã«æˆ»ã‚‹
</a>
