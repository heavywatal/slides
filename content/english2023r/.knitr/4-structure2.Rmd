```{r, setup-common}
#| file: "setup.R"
#| echo: false
#| results: "asis"
```
```{r, setup-local}
#| include: false
#| cache: false
data(band_members, band_instruments, band_instruments2, package = "dplyr")
data(relig_income, population, world_bank_pop, us_rent_income, fish_encounters,
     table2, table3, table4a, table5, package = "tidyr")
```

---
## Learning data preparation in two categories

- **Processing data structure** day 3
    - Extract subsets
    - Summarize by group
    - Sort rows
    - **Combine tables** ğŸ‘ˆ day 4
    - **Pivot longer â†” wider**
- Processing data content <span style="color: #888888;">â€” day 5</span>
    - Type conversion: continuous vs discrete, factors, time
    - Mathematical conversion: logarithm, normalization
    - Handling outliers and missing values
    - Character manipulation: pattern matching


<cite style="display: block; text-align: right;"><a href="https://www.amazon.co.jp/dp/4774196479/ref=as_li_ss_tl?ie=UTF8&linkCode=ll1&tag=heavywatal-22&linkId=8a3fd4e9a0c944b1b41242bbab8d147b">
æœ¬æ©‹æ™ºå…‰ã€Œå‰å‡¦ç†å¤§å…¨ã€
</a></cite>

---
## dplyr --- plyer for data.frames

<a href="https://dplyr.tidyverse.org/">
<img src="/_img/hex-stickers/dplyr.webp" width="180" align="right">
</a>

A consistent set of verbs/functions for data manipulation.

Extract
: columns: `select()`,
: rows: `filter()`, `distinct()`, `slice()`

Aggregate
: `group_by()`, `summarize()`, `count()`

Reorder
: `arrange()`, `relocate()`

Modify/add columns
: `mutate()`, `rename()`

Join/bind
: rows: `bind_rows()`
: columns: `left_join()`, `inner_join()`, `full_join()`


---
## `bind_rows()` vertically

example to combine the extracted first and last 6 rows:
```{r, bind-rows}
dplyr::bind_rows(head(diamonds), tail(diamonds))
```

ğŸ”° `mpg` ã§åŒæ§˜ã«3è¡Œãšã¤å–ã£ã¦çµåˆã—ã¦ã¿ã‚ˆã†


---
## `bind_cols()` horizontally

example to combine two tables side-by-side:
```{r, bind-cols}
dplyr::bind_cols(band_members, band_instruments2)
```
```
band_members          band_instruments2
   name    band         artist  plays
  <chr>   <chr>          <chr>  <chr>
1  Mick  Stones       1   John guitar
2  John Beatles       2   Paul   bass
3  Paul Beatles       3  Keith guitar
```

**ä¸­èº«ãŒåˆã£ã¦ãªãã¦ã‚‚**è¡Œæ•°ãŒåˆã£ã¦ã‚Œã°æˆåŠŸã—ã¦ã—ã¾ã†ã€‚<br>
å…±é€šã™ã‚‹åˆ—ã‚’**ç³Šã—ã‚**ã«ã—ã¦çµåˆã—ãŸã„å ´åˆã¯ `*_join()` é–¢æ•° â†’


---
## å…±é€šã™ã‚‹åˆ—ã§çµåˆ: `full_join()`

ä»–æ–¹ã«ç„¡ã„éƒ¨åˆ†ã‚’ `NA` ã§è£œå®Œã—ã¦**å·¦å³ã¨ã‚‚å…¨è¡Œ**ä¿æŒ:
```{r, full-join}
dplyr::full_join(band_members, band_instruments, by = "name")
```
```
band_members          band_instruments
   name    band          name  plays
  <chr>   <chr>         <chr>  <chr>
1  Mick  Stones       1  John guitar
2  John Beatles       2  Paul   bass
3  Paul Beatles       3 Keith guitar
```

ğŸ”° çµåˆå‰ã¨çµåˆå¾Œã®è¡¨ã‚’æ‰‹å…ƒã§ã‚‚ç¢ºèªã—ã‚ˆã†

---
## å…±é€šã™ã‚‹åˆ—ã§çµåˆ: `full_join()`

çµåˆã«ä½¿ã†åˆ—ã®åå‰ãŒé•ã£ã¦ã¦ã‚‚å¤§ä¸ˆå¤«:
```{r, full-join-by}
dplyr::full_join(band_members, band_instruments2, by = c(name = "artist"))
```
```
band_members          band_instruments2
   name    band         artist  plays
  <chr>   <chr>          <chr>  <chr>
1  Mick  Stones       1   John guitar
2  John Beatles       2   Paul   bass
3  Paul Beatles       3  Keith guitar
```

ğŸ”° çµåˆå‰ã¨çµåˆå¾Œã®è¡¨ã‚’æ‰‹å…ƒã§ã‚‚ç¢ºèªã—ã‚ˆã†

---
## å…±é€šã™ã‚‹åˆ—ã§çµåˆ: `left_join()`

å³å´ã«ç„¡ã„éƒ¨åˆ†ã‚’ `NA` ã§è£œå®Œã—ã¦**å·¦å´ã ã‘å…¨è¡Œ**ä¿æŒ:
```{r, left-join}
dplyr::left_join(band_members, band_instruments, by = "name")
```
```
band_members          band_instruments
   name    band          name  plays
  <chr>   <chr>         <chr>  <chr>
1  Mick  Stones       1  John guitar
2  John Beatles       2  Paul   bass
3  Paul Beatles       3 Keith guitar
```

ãã®é€†ã¯ `right_join()`

ğŸ”° çµåˆå‰ã¨çµåˆå¾Œã®è¡¨ã‚’æ‰‹å…ƒã§ã‚‚ç¢ºèªã—ã‚ˆã†

---
## å…±é€šã™ã‚‹åˆ—ã§çµåˆ: `inner_join()`

å·¦å³ã¨ã‚‚ã«**å…±é€šã™ã‚‹å€¤ã®ã‚ã‚‹è¡Œã ã‘**ä¿æŒ:
```{r, inner-join}
dplyr::inner_join(band_members, band_instruments, by = "name")
```
```
band_members          band_instruments
   name    band          name  plays
  <chr>   <chr>         <chr>  <chr>
1  Mick  Stones       1  John guitar
2  John Beatles       2  Paul   bass
3  Paul Beatles       3 Keith guitar
```

ğŸ”° çµåˆå‰ã¨çµåˆå¾Œã®è¡¨ã‚’æ‰‹å…ƒã§ã‚‚ç¢ºèªã—ã‚ˆã†

---
## joinã¾ã¨ã‚

<div class="column-container">
<div class="column" style="flex-shrink: 1.4;">

<figure>
<a href="https://r4ds.hadley.nz/joins.html">
<img src="/slides/image/r4ds/join.png" height="820">
<br>
<figcaption class="url">https://r4ds.hadley.nz/joins.html</figcaption>
</a>
</figure>

</div>
<div class="column">

ç”Ÿå‘½ç§‘å­¦ã«ãŠã‘ã‚‹ `left_join()` ã®ä¾‹

å·¦: **èˆˆå‘³ã®ã‚ã‚‹éºä¼å­**ã®ç™ºç¾ãƒ‡ãƒ¼ã‚¿<br>
å³: **å…¨éºä¼å­**ã®ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±

&nbsp; â†“ `left_join`(by = "éºä¼å­å")

**èˆˆå‘³ã®ã‚ã‚‹éºä¼å­**ã®ç™ºç¾+ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

</div>
</div>

---
## practice joining: `nycflights13` dataset

ğŸ”° é–¢é€£ã™ã‚‹data.frameã‚’ã„ã‚ã„ã‚ãªæ–¹æ³•ã§çµåˆã—ã¦ã¿ã‚ˆã†ã€‚

```r
# install.packages("nycflights13")
library(nycflights13)
data(package = "nycflights13")
# airlines, airports, flights, planes, weather
```

<figure>
<a href="https://r4ds.hadley.nz/joins.html#fig-flights-relationships">
<img src="/slides/image/r4ds/relational-nycflights.png" height="480">
<br>
<figcaption class="url">https://r4ds.hadley.nz/joins.html#fig-flights-relationships</figcaption>
</a>
</figure>


---
## tidyr --- data.frameã®å¤‰å½¢ãƒ»æ•´å½¢æ‹…å½“

<a href="https://tidyr.tidyverse.org/">
<img src="/_img/hex-stickers/tidyr.webp" width="180" align="right">
</a>

æ¨ªåºƒã‹ã‚‰ç¸¦é•·ã«
: `pivot_longer()`, <del><code>gather()</code></del>

ç¸¦é•·ã‹ã‚‰æ¨ªåºƒã«
: `pivot_wider()`, <del><code>spread()</code></del>

åˆ—ã‚’åˆ†é›¢ã€çµåˆ
: `separate()`, `unite()`

å…¥ã‚Œå­æ§‹é€ ã‚’ã¤ãã‚‹ã€è§£æ¶ˆã™ã‚‹
: `nest()`, `unnest()`

*etc.*

- ã“ã†ã„ã†å¤‰å½¢ãªã—ã§ãã®ã¾ã¾ä½¿ãˆã‚‹ãƒ‡ãƒ¼ã‚¿ã¯æ¿€ãƒ¬ã‚¢
- ã‚¨ã‚¯ã‚»ãƒ«ã§ãƒãƒãƒãƒã‚„ã‚‰ãšã€tidyrã§æ‰‹ç¶šãã‚’è¨˜è¿°ã—ã‚ˆã†
- ã¡ã‚‡ã£ã¨ãƒãƒ¼ãƒ‰ãƒ«ã¯é«˜ã„ã‘ã©ã€ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã¨**å¼·ã„**ğŸ’ª

---
## `pivot_longer()` æ¨ªåºƒã‹ã‚‰ç¸¦é•·ã«

è¤‡æ•°åˆ—ã«ã¾ãŸãŒã‚‹å€¤ã‚’1åˆ—ã«ã™ã‚‹ã€‚<br>
ãã®ãƒ©ãƒ™ãƒ«ã‚‚åˆã‚ã›ã¦ç§»å‹•ã€‚

<figure>
<a href="https://r4ds.hadley.nz/data-tidy.html#sec-pivoting">
<img src="/slides/image/cheatsheet/tidyr-pivot_longer.png" width="900">
<br>
<figcaption class="url">https://r4ds.hadley.nz/data-tidy.html#sec-pivoting</figcaption>
</a>
</figure>

```r
table4a
pivot_longer(table4a, 2:3, names_to = "year", values_to = "cases")
```

ğŸ”° å¤‰å½¢å‰ã¨å¤‰å½¢å¾Œã‚’æ‰‹å…ƒã®Rã§ç¢ºèªã—ã¦ã¿ã‚ˆã†ã€‚


---
## `pivot_longer()` æ¨ªåºƒã‹ã‚‰ç¸¦é•·ã«: `relig_income` ã®ä¾‹

å®—æ•™ã¨åå…¥ã®é–¢ä¿‚ã‚’èª¿æŸ»ã—ãŸãƒ‡ãƒ¼ã‚¿ã€‚<br>
ä¸–å¸¯æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆãŒè¤‡æ•°åˆ—ã«ã¾ãŸãŒã£ã¦ã„ã‚‹ã€‚

```{r, relig-income}
print(relig_income)
```

---
## `pivot_longer()` æ¨ªåºƒã‹ã‚‰ç¸¦é•·ã«: `relig_income` ã®ä¾‹

å®—æ•™ã¨åå…¥ã®é–¢ä¿‚ã‚’èª¿æŸ»ã—ãŸãƒ‡ãƒ¼ã‚¿ã€‚<br>
ã“ã†ãªã£ã¦ãŸã‚‰ggplotã§ãã‚‹ã®ã«ã€‚

<div class="column-container">
<div class="column">

```{r, pivot-longer}
#| include: false
relig_long = relig_income[1:2, 1:4] |> print() |>
  tidyr::pivot_longer(!religion, names_to = "income", values_to = "count") |>
  print()
```
```{r, relig-long}
print(relig_long)
```

ğŸ”° æ¬¡ãƒšãƒ¼ã‚¸ã®ç­”ãˆã‚’è¦‹ãšè‡ªåŠ›ã§ã‚„ã£ã¦ã¿ã‚ˆã†

</div>
<div class="column">

```{r, relig-income-plot}
#| echo: false
#| fig.width: 4.5
#| fig.height: 6
relig_income |>
  tidyr::pivot_longer(!religion, names_to = "income", values_to = "count") |>
  dplyr::mutate(income = dplyr::na_if(income, "Don't know/refused")) |>
  dplyr::mutate(income = factor(income, levels = rev(unique(income)))) |>
  ggplot() +
  aes(religion, count) +
  geom_col(aes(fill = income), position = "fill") +
  scale_fill_viridis_d(na.value = "#cccccc") +
  scale_x_discrete(limits = rev(relig_income$religion)) +
  coord_flip() +
  theme_classic() +
  theme(axis.title = element_blank())
```

</div>
</div>

---
## `pivot_longer()` æ¨ªåºƒã‹ã‚‰ç¸¦é•·ã«: `relig_income` ã®ä¾‹

è¤‡æ•°åˆ—ã«ã¾ãŸãŒã£ã¦ã„ã‚‹ä¸–å¸¯æ•°ã‚«ã‚¦ãƒ³ãƒˆã‚’ `count` 1åˆ—ã«ç§»å‹•ã€‚<br>
åˆ—åã«ãªã£ã¦ãŸåå…¥å¸¯ã‚’ `income` åˆ—ã«ç§»å‹•ã€‚

```{r, pivot-longer}
```

ç§»å‹•ã™ã‚‹åˆ—ã‚’æŒ‡å®šã™ã‚‹ `!religion` ã®ã¨ã“ã‚ã¯ç›´æ¥ `2:10` ã¨ã‹ã‚‚å¯ã€‚


---
## `pivot_wider()` ç¸¦é•·ã‹ã‚‰æ¨ªåºƒã«

1åˆ—ã«åã¾ã£ã¦ã„ãŸå€¤ã‚’è¤‡æ•°åˆ—ã®è¡Œåˆ—ã«å¤‰æ›ã€‚<br>
ãã®ãƒ©ãƒ™ãƒ«ã‚’åˆ—ã®åå‰ã«ã™ã‚‹ã€‚

<figure>
<a href="https://r4ds.hadley.nz/data-tidy.html#widening-data">
<img src="/slides/image/cheatsheet/tidyr-pivot_wider.png" width="840">
<br>
<figcaption class="url">https://r4ds.hadley.nz/data-tidy.html#widening-data</figcaption>
</a>
</figure>

```r
pivot_wider(table2, names_from = type, values_from = count)
```

ğŸ”° å¤‰å½¢å‰ã¨å¤‰å½¢å¾Œã‚’æ‰‹å…ƒã®Rã§ç¢ºèªã—ã¦ã¿ã‚ˆã†ã€‚

---
## `pivot_wider()` ç¸¦é•·ã‹ã‚‰æ¨ªåºƒã«: `fish_encounters`

ç™ºä¿¡å™¨ã®ã¤ã„ãŸé­šãŒè¦³æ¸¬åœ°ç‚¹ã‚’é€šéã—ãŸã“ã¨ã‚’è¨˜éŒ²ã—ãŸãƒ‡ãƒ¼ã‚¿ã€‚<br>
æ—¢ã«ggplotã—ã‚„ã™ãã†ãªå½¢ã ã‘ã©ã€ã‚ãˆã¦1é­š1è¡Œã®æ¨ªåºƒã«ã—ãŸã„ã€‚

<div class="column-container">
<div class="column">

```{r, fish-encounters}
print(fish_encounters)
```

</div>
<div class="column">

```r
print(fish_wide)
```
```{r, fish-wide}
#| echo: false
fish_encounters |>
  tidyr::pivot_wider(names_from = station, values_from = seen)
```

</div>
</div>

ğŸ”° æ¬¡ãƒšãƒ¼ã‚¸ã®ç­”ãˆã‚’è¦‹ãšè‡ªåŠ›ã§ã‚„ã£ã¦ã¿ã‚ˆã†

---
## `pivot_wider()` ç¸¦é•·ã‹ã‚‰æ¨ªåºƒã«: `fish_encounters`

è¦³æ¸¬åœ°ç‚¹ `station` ã‚’åˆ—åã«ç§»å‹•ã€‚<br>
è¦³å¯Ÿã•ã‚ŒãŸã‹ã©ã†ã‹ `seen` ã‚’å„åˆ—ã«ç§»å‹•ã€‚å­˜åœ¨ã—ãªã‘ã‚Œã° `NA`

```{r, pivot-wider}
fish_encounters |>
  tidyr::pivot_wider(names_from = station, values_from = seen)
```

`values_fill = 0` ã¨ã™ã‚Œã° `NA` ã˜ã‚ƒãªã `0` ã§åŸ‹ã‚ã‚‰ã‚Œã‚‹ã€‚

---
## `pivot_wider()` ç¸¦é•·ã‹ã‚‰æ¨ªåºƒã«: ç·´ç¿’å•é¡Œ1

```{r, population}
print(population)
```

ğŸ”° 1å›½ã®ãƒ‡ãƒ¼ã‚¿ãŒ1è¡Œã«ãªã‚‹ã‚ˆã†ã«å¤‰å½¢ã—ã‚ˆã†â†“
```{r, wider-goal1}
#| echo: false
population |> tidyr::pivot_wider(names_from = "year", values_from = "population")
```

---
## `pivot_wider()` ç¸¦é•·ã‹ã‚‰æ¨ªåºƒã«: ç·´ç¿’å•é¡Œ2

```{r, population2}
print(population)
```

ğŸ”° 1å¹´ã®ãƒ‡ãƒ¼ã‚¿ãŒ1è¡Œã«ãªã‚‹ã‚ˆã†ã«å¤‰å½¢ã—ã‚ˆã†â†“
```{r, wider-goal2}
#| echo: false
population |> tidyr::pivot_wider(names_from = "country", values_from = "population")
```


---
## `pivot_wider()` ç¸¦é•·ã‹ã‚‰æ¨ªåºƒã«: ç·´ç¿’å•é¡Œ3

```{r, us-rent-income}
print(us_rent_income)
```

ğŸ”° `income` ã¨ `rent` ã®æ¨å®šå€¤ãŒãã‚Œãã‚Œåˆ—ã¨ãªã‚‹ã‚ˆã†ã«å¤‰å½¢ã—ã‚ˆã†
```{r, wider-goal3}
#| echo: false
us_rent_income |>
  dplyr::select(!moe) |>
  tidyr::pivot_wider(names_from = "variable", values_from = "estimate")
```


---
## `separate()` åˆ—ã‚’åˆ†é›¢

<figure>
<a href="https://r4ds.had.co.nz/tidy-data.html#separate">
<img src="/slides/image/cheatsheet/tidyr-separate.png" height="240">
<br>
<figcaption class="url">https://r4ds.had.co.nz/tidy-data.html#separate</figcaption>
</a>
</figure>

```{r, separate}
table3 |> tidyr::separate(rate, into = c("cases", "population"), sep = "/")
```

`sep` ã¯æŒ‡å®šã—ãªãã¦ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨˜å·ã‚„ç©ºç™½ã‚’èªè­˜ã—ã¦ãã‚Œã‚‹ã€‚

ğŸ”° å¤‰å½¢å‰ã¨å¤‰å½¢å¾Œã‚’æ‰‹å…ƒã®Rã§ç¢ºèªã—ã¦ã¿ã‚ˆã†ã€‚

---
## `unite()` åˆ—ã‚’èåˆ

<figure>
<a href="https://r4ds.had.co.nz/tidy-data.html#unite">
<img src="/slides/image/cheatsheet/tidyr-unite.png" height="240" style="vertical-align: top;">
<span style="display: inline-block; margin-inline: -2.7rem 0 ; transform: translate(0, 0.2em); color: #ffffff; background-color: #808080; padding: 0.05rem; font-size: 0.9em; font-weight: bold;">YEAR</span>
<br>
<figcaption class="url">https://r4ds.had.co.nz/tidy-data.html#unite</figcaption>
</a>
</figure>

```{r, unite}
table5 |> tidyr::unite(YEAR, century, year, sep = "") |>
  dplyr::mutate(YEAR = as.integer(YEAR))
```

**çµåˆç›´å¾Œã¯æ–‡å­—åˆ—**ã«ãªã£ã¦ã„ã‚‹ã®ã§æ•°å€¤ãªã‚‰å¿˜ã‚Œãšã«å¤‰æ›ã€‚

ğŸ”° å¤‰å½¢å‰ã¨å¤‰å½¢å¾Œã‚’æ‰‹å…ƒã®Rã§ç¢ºèªã—ã¦ã¿ã‚ˆã†ã€‚

---
## `separate()` / `unite()` ç·´ç¿’å•é¡Œ1

ğŸ”° `table3` ã® `rate` ã‚’åˆ†å‰²ã—ãŸã‚ã¨ã€ã¾ãŸå…ƒã«æˆ»ã—ã¦ã¿ã‚ˆã†ã€‚

ğŸ”° `table3` ã® `year` ã‚’åˆ†å‰²ã—ã¦ `table5` ã‚’ä½œã£ã¦ã¿ã‚ˆã†ã€‚

```{r, table3-practice}
print(table3)
```

---
## `separate()` / `unite()` ç·´ç¿’å•é¡Œ2

ğŸ”° `world_bank_pop` ã® `indicator` ã‚’3åˆ—ã«åˆ†å‰²ã—ã¦ã¿ã‚ˆã†ã€‚<br>
   (`sep = "."` ã‚’æŒ‡å®šã›ãšçœç•¥ã™ã‚‹ã€‚ç†ç”±ã¯æ–‡å­—åˆ—å‡¦ç†ã®å›ã§èª¬æ˜)

```{r, world-bank-pop-practice}
print(world_bank_pop)
```

---
## `nest()` å…¥ã‚Œå­ã«ã™ã‚‹

ã‚°ãƒ«ãƒ¼ãƒ—æ¯ã«data.frameã‚’åŒºåˆ‡ã£ã¦listå‹ã®åˆ—ã«å…¥ã‚Œã‚‹ã€‚

<figure>
<a href="https://www.tidyverse.org/blog/2019/09/tidyr-1-0-0/">
<img src="/slides/image/rstats/nest-pack-chop.png" height="600">
<br>
<figcaption class="url">https://www.tidyverse.org/blog/2019/09/tidyr-1-0-0/</figcaption>
</a>
</figure>

<div>
<a href="https://purrr.tidyverse.org/">
<img src="/_img/hex-stickers/purrr.webp" width="180" style="vertical-align: middle;">
purrrãƒ‘ãƒƒã‚±ãƒ¼ã‚¸</a>ã¨å…±ã«æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã¨å¼·åŠ› (ä»Šå›ã¯ç´¹ä»‹ã ã‘)
</div>

---
## `nest()` å…¥ã‚Œå­ã«ã™ã‚‹

ã‚°ãƒ«ãƒ¼ãƒ—æ¯ã«data.frameã‚’åŒºåˆ‡ã£ã¦listå‹ã®åˆ—ã«å…¥ã‚Œã‚‹ã€‚

```{r, nest}
mpg_nested = mpg |> tidyr::nest(data = !drv) |> print()
mpg_nested$data[[1]]
```


---
## Learning data preparation in two categories

<div style="float: right;">
<a href="https://dplyr.tidyverse.org/">
<img src="/_img/hex-stickers/dplyr.webp" width="180">
</a><br>
<a href="https://tidyr.tidyverse.org/">
<img src="/_img/hex-stickers/tidyr.webp" width="180">
</a>
</div>

- **Processing data structure** day 3 and 4
    - Extract subsets --- `select()`, `filter()`
    - Summarize by group --- `group_by()`, `summarize()`
    - Sort rows --- `arrange()`
    - Combine tables --- `*_join()`
    - Pivot longer â†” wider --- `pivot_longer()`, `pivot_wider()`
- Processing data content <span style="color: #888888;">â€” day 5</span>
    - Type conversion: continuous vs discrete, factors, time
    - Mathematical conversion: logarithm, normalization
    - Handling outliers and missing values
    - Character manipulation: pattern matching

<cite style="display: block; text-align: right;"><a href="https://www.amazon.co.jp/dp/4774196479/ref=as_li_ss_tl?ie=UTF8&linkCode=ll1&tag=heavywatal-22&linkId=8a3fd4e9a0c944b1b41242bbab8d147b">
æœ¬æ©‹æ™ºå…‰ã€Œå‰å‡¦ç†å¤§å…¨ã€
</a></cite>


---
## Don't try to remember; visit the official website

It is the shortest path to getting data transformation done.

<figure>
<a href="https://dplyr.tidyverse.org/">
<img src="/slides/image/rstats/dplyr-website.png" width="80%">
<figcaption class="url">https://dplyr.tidyverse.org/</figcaption>
</a>
</figure>



---
## ğŸ”° Challenge 1: transform and plot `economics`

```r
print(economics)
```

```{r, economics-longer}
#| echo: false
#| fig.height: 4.5
#| fig.width: 8
wtl::printdf(economics, n = 4L)
economics |>
  tidyr::pivot_longer(!date) |>
  ggplot() +
  aes(date, value) +
  geom_line() +
  facet_grid(rows = vars(name), scales = "free_y")
```

---
## ğŸ”° Challenge 2: transform and plot `world_bank_pop`

```r
print(world_bank_pop)
```
```{r, world-bank-pop-pivot}
#| fig.height: 4
#| fig.width: 11.5
#| echo: false
wtl::printdf(world_bank_pop, n = 4L)
wbp_tidy = world_bank_pop |>
  tidyr::pivot_longer(!c(country, indicator), names_to = "year") |>
  dplyr::mutate(year = as.numeric(year)) |>
  dplyr::filter(country %in% c("DEU", "FIN", "JPN")) |>
  tidyr::separate(indicator, c(NA, "region", "name"))

ggplot(wbp_tidy) +
  aes(year, value) +
  geom_line(aes(color = country, group = country)) +
  facet_grid(vars(name), vars(region), scale = "free_y")
```

---
## Do you remember this dataset?

```{r, before-tidy}
print(VADeaths)
```

â†“ *mise en place* &nbsp;ğŸ”ª&nbsp; put everything in place
<img `r src_alt_fig_chunk("vadeaths-plot")` align="right" width="540" style="margin-block-start: 4em;">

```{r, after-tidy}
#| echo: false
va_deaths = as.data.frame(VADeaths) |>  # data.frameã«å¤‰æ›
  tibble::rownames_to_column("age") |>  # è¡Œåã‚’åˆ—ã«
  tidyr::pivot_longer(                  # ç¸¦é•·ã«å¤‰å½¢ã—ãŸã„
    !age,                               # ageä»¥å¤–ã®åˆ—ã«å…¥ã£ã¦ã‚‹å€¤ã‚’ç§»å‹•
    names_to = c("region", "sex"),      # å…ƒã®åˆ—åã‚’2ã¤ã«åˆ†é›¢
    names_sep = " ",                    # ã‚¹ãƒšãƒ¼ã‚¹ã§åˆ‡ã‚‹
    values_to = "death") |>             # å€¤ã®è¡Œãå…ˆã®åˆ—å
  tidyr::separate(age, c("lbound", "ubound"), "-", convert = TRUE) |>
  print()

# åˆ¥è§£
.devnull = as.data.frame(VADeaths) |>
  tibble::rownames_to_column("age") |>
  tidyr::pivot_longer(!age, names_to = "region_sex", values_to = "death") |>
  tidyr::separate(region_sex, c("region", "sex")) |>
  tidyr::separate(age, c("lbound", "ubound"), convert = TRUE)
```

---
## ğŸ”° Challenge 3: transform and plot `VADeaths`

```{r, vadeaths-rownames}
VADeaths |> as.data.frame() |>       # was not data.frame
  tibble::rownames_to_column("age")  # rownames are irregular
```

<div class="column-container">
  <div class="column" style="flex-shrink: 0.8; min-width: 0;">

Convert it to a regular data.frame first.
```{r, vadeaths-class}
class(VADeaths)
rownames(VADeaths)
```

  </div>
  <div class="column">

```{r, vadeaths-plot}
#| fig.height: 3.8
#| fig.width: 5.7
#| echo: false
ggplot(va_deaths) +
  aes(lbound, death) +
  geom_point(aes(color = sex, shape = region), size = 5) +
  theme_classic(base_size = 18)
```

  </div>
</div>

---
## ğŸ”° Challenge 4: transform and plot `anscombe`

```r
anscombe |> tibble::rowid_to_column("id")   # IDã‚’ã¤ã‘ã¦ãŠã
```
```{r, anscombe}
#| echo: false
anscombe |> tibble::rowid_to_column("id") |> wtl::printdf(n = 6L)
```

```{r, anscombe-plot}
#| fig.height: 4
#| fig.width: 12
#| echo: false
tidy_anscombe = anscombe |>
  tidyr::pivot_longer(                       # ç¸¦é•·ã«å¤‰å½¢ã—ãŸã„
    everything(),                     # ã™ã¹ã¦ã®åˆ—ã«ã¤ã„ã¦
    names_to = c(".value", "group"),  # æ–°ã—ã„åˆ—å
    names_sep = 1L,                   # åˆ‡ã‚‹ä½ç½®
    names_transform = list(group = as.integer)) |> # å‹å¤‰æ›
  dplyr::arrange(group)                      # ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ä¸¦ã¹ã‚‹

# åˆ¥è§£
tidy_anscombe = anscombe |>
  tibble::rowid_to_column("id") |>
  tidyr::pivot_longer(!id) |>
  tidyr::separate(name, c("axis", "group"), sep = 1) |>
  tidyr::pivot_wider(names_from = "axis", values_from = "value") |>
  dplyr::arrange(group)

ggplot(tidy_anscombe) + aes(x, y) +
  geom_point(size = 3) +
  stat_smooth(method = lm, formula = y ~ x, se = FALSE, fullrange = TRUE) +
  facet_wrap(vars(group), nrow = 1L) +
  theme_bw(base_size = 16)
```

---
## ğŸ”° Challenge 5: Calculate summary stats of `anscombe`

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r, anscombe-summarize}
#| echo: false
tidy_anscombe |>
  dplyr::group_by(group) |>   # groupåˆ—ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦
  dplyr::summarize(            # x, yåˆ—ã‚’ä½¿ã£ã¦summarize
    mean_x = mean(x),
    mean_y = mean(y),
    sd_x = sd(x),
    sd_y = sd(y),
    cor_xy = cor(x, y)
  )
```


---
## Reference

R for Data Science --- Hadley Wickham et al.
: <https://r4ds.hadley.nz>,
  [Paperback](https://amzn.to/2tbRmVc),
  [æ—¥æœ¬èªç‰ˆæ›¸ç±](https://amzn.to/2yyFRKt)

[å‰å‡¦ç†å¤§å…¨ --- æœ¬æ©‹æ™ºå…‰](https://www.amazon.co.jp/dp/4774196479/ref=as_li_ss_tl?ie=UTF8&linkCode=ll1&tag=heavywatal-22&linkId=8a3fd4e9a0c944b1b41242bbab8d147b)<br>
[Rãƒ¦ãƒ¼ã‚¶ã®ãŸã‚ã®RStudio[å®Ÿè·µ]å…¥é–€ (å®‡å®™èˆ¹æœ¬) --- æ¾æ‘ã‚‰](https://amzn.to/2Yy5LND)

æ•´ç„¶ãƒ‡ãƒ¼ã‚¿ã¨ã¯ä½•ã‹ --- [@f_nisihara](https://twitter.com/f_nisihara)
: [Speaker Deck](https://speakerdeck.com/fnshr/zheng-ran-detatutenani),
  [Colorless Green Ideas](https://id.fnshr.info/2017/01/09/tidy-data-intro/)

Older versions
: ã€Œ[Rã«ã‚„ã‚‰ã›ã¦æ¥½ã—ã‚ˆã† â€” ãƒ‡ãƒ¼ã‚¿ã®å¯è¦–åŒ–ã¨ä¸‹ã”ã—ã‚‰ãˆ](https://heavywatal.github.io/slides/nagoya2018/)ã€
   å²©åµœèˆª 2018
: ã€ŒRã‚’ç”¨ã„ãŸãƒ‡ãƒ¼ã‚¿è§£æã®åŸºç¤ã¨å¿œç”¨ã€çŸ³å·ç”±å¸Œ 2019 åå¤å±‹å¤§å­¦
: ã€Œ[Rã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿å‰å‡¦ç†å®Ÿç¿’](https://heavywatal.github.io/slides/tmd2022/)ã€
   å²©åµœèˆª 2022 æ±äº¬åŒ»ç§‘æ­¯ç§‘å¤§
: ã€Œ[Rã‚’ç”¨ã„ãŸãƒ‡ãƒ¼ã‚¿è§£æã®åŸºç¤ã¨å¿œç”¨](https://comicalcommet.github.io/r-training-2023/)ã€
   çŸ³å·ç”±å¸Œ 2023 åå¤å±‹å¤§å­¦

`r .meta$next_link`
