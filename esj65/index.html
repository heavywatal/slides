<!DOCTYPE html>
<html lang="ja">
<head prefix="og: http://ogp.me/ns#">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<title>ESJ65-W07 それもRにやらせよう — 整然データの下ごしらえ</title>
<meta name="author" content="Watal M. Iwasaki">
<meta property="og:title" content="ESJ65-W07 それもRにやらせよう — 整然データの下ごしらえ">
<meta property="og:type" content="article">
<meta property="og:url" content="https://heavywatal.github.io/slides/esj65/">
<meta property="og:image" content="https://avatars.githubusercontent.com/heavywatal">
<meta property="og:description" content="">
<meta property="og:site_name" content="Slide decks — Heavy Watal">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@heavywatal">
<meta name="twitter:creator" content="@heavywatal">
<link rel="stylesheet" href="/lib/katex/katex.min.css">
<script defer src="/lib/katex/katex.min.js"></script>
<script defer src="/lib/katex/contrib/auto-render.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  renderMathInElement(document.body, {
    delimiters: [
      {left: "\\[", right: "\\]", display: true},
      {left: "$", right: "$", display: false}
    ]
  });
});
</script>
<style>
.katex {
  font-size: 1.12em;
}

.katex-display > .katex {
  text-align: left;
  padding-left: 2rem;
}
</style>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-V60H2JH0G6"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-V60H2JH0G6', { 'anonymize_ip': false });
}
</script>
<link rel="stylesheet" href="/slides/lib/reveal.js/reveal.css">
<script defer src="/slides/lib/reveal.js/reveal.js"></script>
<script defer src="/slides/lib/reveal.js/plugin/notes/notes.js"></script>
<script defer src="/slides/lib/reveal.js/plugin/search/search.js"></script>
<script defer src="/slides/lib/reveal-initialize.js"></script>
<script defer src="/slides/lib/reload-img-onclick.js"></script>
<link rel="stylesheet" href="/slides/css/style-reveal.css">
</head>
<body>
<div class="reveal">
<div class="slides">
<section>
<h1 id="それもrにやらせよう-----整然データの下ごしらえ">それもRにやらせよう &mdash; 整然データの下ごしらえ</h1>
<div class="author">
岩嵜 航 (Watal M. Iwasaki)
</div>
<div class="affiliation">
総研大<br>
(SOKENDAI, The Graduate University for Advanced Studies)
</div>
<div class="footnote">
2018-03-14
<a href="http://www.esj.ne.jp/meeting/65/">
生態学会65＠札幌
</a><br>
<a href="http://hosho.ees.hokudai.ac.jp/~kubo/ce/EcoSj2018.html">
[W07] データ解析で出会う統計的問題: R の新しい作図・作表
</a>
</div>
</section>
<section>
<h2 id="下ごしらえを自動化してハッピーに">下ごしらえを自動化してハッピーに</h2>
<blockquote>
<p>Happy families are all alike;<br>
every unhappy family is unhappy in its own way<br>
&mdash; Leo Tolstoy &ldquo;Anna Karenina&rdquo;</p>
</blockquote>
<blockquote>
<p>tidy datasets are all alike,<br>
but every messy dataset is messy in its own way<br>
&mdash; Hadley Wickham</p>
</blockquote>
<dl>
<dt>出発点となるデータはさまざま</dt>
<dd>実験ノート、フィールドノート、</dd>
<dd>データベース、シミュレーション。。。</dd>
<dt>解析や作図に使えるデータ形式はほぼ決まってる</dt>
<dd><code>glm(..., data, ...)</code>,
<code>ggplot(data, ...)</code>, &hellip;</dd>
</dl>

</section>
<section>
<h2 id="整然データ-tidy-data">整然データ tidy data</h2>
<ul>
<li>1行は1つの観測</li>
<li>1列は1つの変数</li>
<li>1セルは1つの値</li>
<li>(ggplotしたくなる形)</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">mtcars</span>
</span></span></code></pre></div><pre tabindex="0"><code>                     mpg cyl  disp  hp drat    wt  qsec vs am gear carb
Mazda RX4           21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
Mazda RX4 Wag       21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
Datsun 710          22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
Hornet 4 Drive      21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
Hornet Sportabout   18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
Valiant             18.1   6 225.0 105 2.76 3.460 20.22  1  0    3    1
Duster 360          14.3   8 360.0 245 3.21 3.570 15.84  0  0    3    4
Merc 240D           24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2
Merc 230            22.8   4 140.8  95 3.92 3.150 22.90  1  0    4    2
Merc 280            19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
Merc 280C           17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
Merc 450SE          16.4   8 275.8 180 3.07 4.070 17.40  0  0    3    3
Merc 450SL          17.3   8 275.8 180 3.07 3.730 17.60  0  0    3    3
Merc 450SLC         15.2   8 275.8 180 3.07 3.780 18.00  0  0    3    3
Cadillac Fleetwood  10.4   8 472.0 205 2.93 5.250 17.98  0  0    3    4
Lincoln Continental 10.4   8 460.0 215 3.00 5.424 17.82  0  0    3    4
Chrysler Imperial   14.7   8 440.0 230 3.23 5.345 17.42  0  0    3    4
Fiat 128            32.4   4  78.7  66 4.08 2.200 19.47  1  1    4    1
Honda Civic         30.4   4  75.7  52 4.93 1.615 18.52  1  1    4    2
Toyota Corolla      33.9   4  71.1  65 4.22 1.835 19.90  1  1    4    1
Toyota Corona       21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
Dodge Challenger    15.5   8 318.0 150 2.76 3.520 16.87  0  0    3    2
AMC Javelin         15.2   8 304.0 150 3.15 3.435 17.30  0  0    3    2
Camaro Z28          13.3   8 350.0 245 3.73 3.840 15.41  0  0    3    4
Pontiac Firebird    19.2   8 400.0 175 3.08 3.845 17.05  0  0    3    2
Fiat X1-9           27.3   4  79.0  66 4.08 1.935 18.90  1  1    4    1
Porsche 914-2       26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
Lotus Europa        30.4   4  95.1 113 3.77 1.513 16.90  1  1    5    2
Ford Pantera L      15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
Ferrari Dino        19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6
Maserati Bora       15.0   8 301.0 335 3.54 3.570 14.60  0  1    5    8
Volvo 142E          21.4   4 121.0 109 4.11 2.780 18.60  1  1    4    2
</code></pre><p>参考:<br>
<a href="http://r4ds.had.co.nz/tidy-data.html">http://r4ds.had.co.nz/tidy-data.html</a><br>
<a href="https://speakerdeck.com/fnshr/zheng-ran-detatutenani">https://speakerdeck.com/fnshr/zheng-ran-detatutenani</a><br></p>
</section>
<section>
<h2 id="雑然データ-messy-data">雑然データ messy data</h2>
<ul>
<li>1つの観測が縦横バラバラに散らばっている</li>
<li>1つの変数が複数列にまたがっている</li>
<li>1つのセルに複数の意味や値が含まれている</li>
<li>セルの結合？もってのほか！</li>
<li>(データを採るときに楽な形。これは仕方ない)</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">VADeaths</span>
</span></span></code></pre></div><pre tabindex="0"><code>      Rural Male Rural Female Urban Male Urban Female
50-54       11.7          8.7       15.4          8.4
55-59       18.1         11.7       24.3         13.6
60-64       26.9         20.3       37.0         19.3
65-69       41.0         30.9       54.6         35.1
70-74       66.0         54.3       71.1         50.0
</code></pre><p>↓下ごしらえ</p>
<pre tabindex="0"><code>   lbound ubound region    sex death_rate
1      50     54  Rural   Male       11.7
2      55     59  Rural   Male       18.1
3      60     64  Rural   Male       26.9
4      65     69  Rural   Male       41.0
5      70     74  Rural   Male       66.0
6      50     54  Rural Female        8.7
7      55     59  Rural Female       11.7
8      60     64  Rural Female       20.3
9      65     69  Rural Female       30.9
10     70     74  Rural Female       54.3
11     50     54  Urban   Male       15.4
12     55     59  Urban   Male       24.3
13     60     64  Urban   Male       37.0
14     65     69  Urban   Male       54.6
15     70     74  Urban   Male       71.1
16     50     54  Urban Female        8.4
17     55     59  Urban Female       13.6
18     60     64  Urban Female       19.3
19     65     69  Urban Female       35.1
20     70     74  Urban Female       50.0
</code></pre>
</section>
<section>
<h2 id="ゑくせる手作業--シーシュポスの岩">ゑくせる手作業 ＝ シーシュポスの岩</h2>
<img src="/slides/image/free/Punishment_sisyph.jpg" alt="Punishment sisyph.jpg" height="280" align="right">
<ul>
<li>膨大な単純作業がそもそもツラい</li>
<li>人間だもの、ミスは防ぎきれない</li>
<li>なるべく防ぐためのチェックもツラい</li>
<li>ミスを発見 → 初めからやり直し</li>
<li>新たなデータ・研究 → 初めからやり直し</li>
<li>どんなに経験を積んでも良くならない</li>
</ul>
<br>
規則性のある退屈な仕事は人間よりも機械のほうが得意。<br>
一度書いたプログラムは、データが変わっても使える財産。<br>
<p><strong>Reproducible Research, 再現性のためにも R にやらせよう</strong></p>
</section>
<section>
<h2 id="今回の目標">今回の目標</h2>
<h3 id="いまのrってこんなことができるんだな">いまのRってこんなことができるんだな</h3>
<h3 id="やりたくなったらこのへんを調べればいいんだな">やりたくなったらこのへんを調べればいいんだな</h3>
<br>
この2点さえ押さえれば、具体的なやり方は覚えなくても大丈夫

</section>
<section>
<h2 id="tidyverse">tidyverse</h2>
<a href="https://www.tidyverse.org/">
<img src="/slides/image/rstats/hex-badges.png" width="260" align="right">
</a>
<p>Rでデータを上手に扱うためのパッケージ群</p>
<ul>
<li>統一的な使い勝手</li>
<li>暗黙の処理をなるべくしない</li>
<li>意味のわかるエラーメッセージ</li>
<li><strong>シンプルな関数を繋げて使うデザイン</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">install.packages</span><span class="p">(</span><span class="s">&#34;tidyverse&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 関連ライブラリが一挙に読み込まれる</span>
</span></span></code></pre></div><p>Q. 素のRも覚えきってないのにいきなりパッケージ？<br>
A. 大丈夫。誰も覚えきってない。</p>

</section>
<section>
<h2 id="よく見かけるサンプルデータ-iris">よく見かけるサンプルデータ <code>iris</code></h2>
<p>Rに最初から入ってるdata.frame。<br>
3種のアヤメ150個体に関する4個の計測値。</p>
<p>うっかり実行すると、</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">iris</span>
</span></span></code></pre></div>
</section>
<section>
<h2 id="よく見かけるサンプルデータ-iris">よく見かけるサンプルデータ <code>iris</code></h2>
<p>Rに最初から入ってるdata.frame。<br>
3種のアヤメ150個体に関する4個の計測値。</p>
<p>うっかり実行すると、ながーい！</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">iris</span>
</span></span></code></pre></div><pre tabindex="0"><code>    Sepal.Length Sepal.Width Petal.Length Petal.Width    Species
1            5.1         3.5          1.4         0.2     setosa
2            4.9         3.0          1.4         0.2     setosa
3            4.7         3.2          1.3         0.2     setosa
4            4.6         3.1          1.5         0.2     setosa
5            5.0         3.6          1.4         0.2     setosa
6            5.4         3.9          1.7         0.4     setosa
7            4.6         3.4          1.4         0.3     setosa
8            5.0         3.4          1.5         0.2     setosa
9            4.4         2.9          1.4         0.2     setosa
10           4.9         3.1          1.5         0.1     setosa
11           5.4         3.7          1.5         0.2     setosa
12           4.8         3.4          1.6         0.2     setosa
13           4.8         3.0          1.4         0.1     setosa
14           4.3         3.0          1.1         0.1     setosa
15           5.8         4.0          1.2         0.2     setosa
16           5.7         4.4          1.5         0.4     setosa
17           5.4         3.9          1.3         0.4     setosa
18           5.1         3.5          1.4         0.3     setosa
19           5.7         3.8          1.7         0.3     setosa
20           5.1         3.8          1.5         0.3     setosa
21           5.4         3.4          1.7         0.2     setosa
22           5.1         3.7          1.5         0.4     setosa
23           4.6         3.6          1.0         0.2     setosa
24           5.1         3.3          1.7         0.5     setosa
25           4.8         3.4          1.9         0.2     setosa
26           5.0         3.0          1.6         0.2     setosa
27           5.0         3.4          1.6         0.4     setosa
28           5.2         3.5          1.5         0.2     setosa
29           5.2         3.4          1.4         0.2     setosa
30           4.7         3.2          1.6         0.2     setosa
31           4.8         3.1          1.6         0.2     setosa
32           5.4         3.4          1.5         0.4     setosa
33           5.2         4.1          1.5         0.1     setosa
34           5.5         4.2          1.4         0.2     setosa
35           4.9         3.1          1.5         0.2     setosa
36           5.0         3.2          1.2         0.2     setosa
37           5.5         3.5          1.3         0.2     setosa
38           4.9         3.6          1.4         0.1     setosa
39           4.4         3.0          1.3         0.2     setosa
40           5.1         3.4          1.5         0.2     setosa
41           5.0         3.5          1.3         0.3     setosa
42           4.5         2.3          1.3         0.3     setosa
43           4.4         3.2          1.3         0.2     setosa
44           5.0         3.5          1.6         0.6     setosa
45           5.1         3.8          1.9         0.4     setosa
46           4.8         3.0          1.4         0.3     setosa
47           5.1         3.8          1.6         0.2     setosa
48           4.6         3.2          1.4         0.2     setosa
49           5.3         3.7          1.5         0.2     setosa
50           5.0         3.3          1.4         0.2     setosa
51           7.0         3.2          4.7         1.4 versicolor
52           6.4         3.2          4.5         1.5 versicolor
53           6.9         3.1          4.9         1.5 versicolor
54           5.5         2.3          4.0         1.3 versicolor
55           6.5         2.8          4.6         1.5 versicolor
56           5.7         2.8          4.5         1.3 versicolor
57           6.3         3.3          4.7         1.6 versicolor
58           4.9         2.4          3.3         1.0 versicolor
59           6.6         2.9          4.6         1.3 versicolor
60           5.2         2.7          3.9         1.4 versicolor
61           5.0         2.0          3.5         1.0 versicolor
62           5.9         3.0          4.2         1.5 versicolor
63           6.0         2.2          4.0         1.0 versicolor
64           6.1         2.9          4.7         1.4 versicolor
65           5.6         2.9          3.6         1.3 versicolor
66           6.7         3.1          4.4         1.4 versicolor
67           5.6         3.0          4.5         1.5 versicolor
68           5.8         2.7          4.1         1.0 versicolor
69           6.2         2.2          4.5         1.5 versicolor
70           5.6         2.5          3.9         1.1 versicolor
71           5.9         3.2          4.8         1.8 versicolor
72           6.1         2.8          4.0         1.3 versicolor
73           6.3         2.5          4.9         1.5 versicolor
74           6.1         2.8          4.7         1.2 versicolor
75           6.4         2.9          4.3         1.3 versicolor
76           6.6         3.0          4.4         1.4 versicolor
77           6.8         2.8          4.8         1.4 versicolor
78           6.7         3.0          5.0         1.7 versicolor
79           6.0         2.9          4.5         1.5 versicolor
80           5.7         2.6          3.5         1.0 versicolor
81           5.5         2.4          3.8         1.1 versicolor
82           5.5         2.4          3.7         1.0 versicolor
83           5.8         2.7          3.9         1.2 versicolor
84           6.0         2.7          5.1         1.6 versicolor
85           5.4         3.0          4.5         1.5 versicolor
86           6.0         3.4          4.5         1.6 versicolor
87           6.7         3.1          4.7         1.5 versicolor
88           6.3         2.3          4.4         1.3 versicolor
89           5.6         3.0          4.1         1.3 versicolor
90           5.5         2.5          4.0         1.3 versicolor
91           5.5         2.6          4.4         1.2 versicolor
92           6.1         3.0          4.6         1.4 versicolor
93           5.8         2.6          4.0         1.2 versicolor
94           5.0         2.3          3.3         1.0 versicolor
95           5.6         2.7          4.2         1.3 versicolor
96           5.7         3.0          4.2         1.2 versicolor
97           5.7         2.9          4.2         1.3 versicolor
98           6.2         2.9          4.3         1.3 versicolor
99           5.1         2.5          3.0         1.1 versicolor
100          5.7         2.8          4.1         1.3 versicolor
101          6.3         3.3          6.0         2.5  virginica
102          5.8         2.7          5.1         1.9  virginica
103          7.1         3.0          5.9         2.1  virginica
104          6.3         2.9          5.6         1.8  virginica
105          6.5         3.0          5.8         2.2  virginica
106          7.6         3.0          6.6         2.1  virginica
107          4.9         2.5          4.5         1.7  virginica
108          7.3         2.9          6.3         1.8  virginica
109          6.7         2.5          5.8         1.8  virginica
110          7.2         3.6          6.1         2.5  virginica
111          6.5         3.2          5.1         2.0  virginica
112          6.4         2.7          5.3         1.9  virginica
113          6.8         3.0          5.5         2.1  virginica
114          5.7         2.5          5.0         2.0  virginica
115          5.8         2.8          5.1         2.4  virginica
116          6.4         3.2          5.3         2.3  virginica
117          6.5         3.0          5.5         1.8  virginica
118          7.7         3.8          6.7         2.2  virginica
119          7.7         2.6          6.9         2.3  virginica
120          6.0         2.2          5.0         1.5  virginica
121          6.9         3.2          5.7         2.3  virginica
122          5.6         2.8          4.9         2.0  virginica
123          7.7         2.8          6.7         2.0  virginica
124          6.3         2.7          4.9         1.8  virginica
125          6.7         3.3          5.7         2.1  virginica
126          7.2         3.2          6.0         1.8  virginica
127          6.2         2.8          4.8         1.8  virginica
128          6.1         3.0          4.9         1.8  virginica
129          6.4         2.8          5.6         2.1  virginica
130          7.2         3.0          5.8         1.6  virginica
131          7.4         2.8          6.1         1.9  virginica
132          7.9         3.8          6.4         2.0  virginica
133          6.4         2.8          5.6         2.2  virginica
134          6.3         2.8          5.1         1.5  virginica
135          6.1         2.6          5.6         1.4  virginica
136          7.7         3.0          6.1         2.3  virginica
137          6.3         3.4          5.6         2.4  virginica
138          6.4         3.1          5.5         1.8  virginica
139          6.0         3.0          4.8         1.8  virginica
140          6.9         3.1          5.4         2.1  virginica
141          6.7         3.1          5.6         2.4  virginica
142          6.9         3.1          5.1         2.3  virginica
143          5.8         2.7          5.1         1.9  virginica
144          6.8         3.2          5.9         2.3  virginica
145          6.7         3.3          5.7         2.5  virginica
146          6.7         3.0          5.2         2.3  virginica
147          6.3         2.5          5.0         1.9  virginica
148          6.5         3.0          5.2         2.0  virginica
149          6.2         3.4          5.4         2.3  virginica
150          5.9         3.0          5.1         1.8  virginica
</code></pre>
</section>
<section>
<h2 id="tibble-----dataframeの改良版">tibble &mdash; data.frameの改良版</h2>
<a href="https://tibble.tidyverse.org/">
<img src="/_img/hex-stickers/tibble.webp" width="120" align="right">
</a>
<ul>
<li><strong>巨大データをうっかり表示しても画面を埋め尽くさない</strong></li>
<li>列の名前や型を勝手に変更しない</li>
<li>一応説明したけど、この先は区別せずdata.frameと呼ぶ</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">as_tibble</span><span class="p">(</span><span class="n">iris</span><span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code># A tibble: 150 x 5
  Sepal.Length Sepal.Width Petal.Length Petal.Width Species
         &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
1          5.1         3.5          1.4         0.2 setosa 
2          4.9         3            1.4         0.2 setosa 
3          4.7         3.2          1.3         0.2 setosa 
4          4.6         3.1          1.5         0.2 setosa 
5          5           3.6          1.4         0.2 setosa 
6          5.4         3.9          1.7         0.4 setosa 
7          4.6         3.4          1.4         0.3 setosa 
8          5           3.4          1.5         0.2 setosa 
# ... with 142 more rows
</code></pre>
</section>
<section>
<h2 id="tibble-----dataframeの改良版">tibble &mdash; data.frameの改良版</h2>
<a href="https://tibble.tidyverse.org/">
<img src="/_img/hex-stickers/tibble.webp" width="120" align="right">
</a>
<ul>
<li>巨大データをうっかり表示しても画面を埋め尽くさない</li>
<li><strong>列の名前や型を勝手に変更しない</strong></li>
<li>一応説明したけど、この先は区別せずdata.frameと呼ぶ</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="nf">data.frame</span><span class="p">(</span><span class="s">&#34;x-1&#34;</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;b&#34;</span><span class="p">,</span> <span class="s">&#34;e&#34;</span><span class="p">,</span> <span class="s">&#34;e&#34;</span><span class="p">,</span> <span class="s">&#34;r&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">df[[</span><span class="s">&#34;x.1&#34;</span><span class="n">]]</span>   <span class="c1"># 名前が違う！中身も勝手にfactor型に！</span>
</span></span></code></pre></div><pre tabindex="0"><code>[1] b e e r
Levels: b e r
</code></pre><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">tbl</span> <span class="o">=</span> <span class="nf">tibble</span><span class="p">(</span><span class="s">&#34;x-1&#34;</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;b&#34;</span><span class="p">,</span> <span class="s">&#34;e&#34;</span><span class="p">,</span> <span class="s">&#34;e&#34;</span><span class="p">,</span> <span class="s">&#34;r&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">tbl[[</span><span class="s">&#34;x-1&#34;</span><span class="n">]]</span>  <span class="c1"># 当然character型のまま</span>
</span></span></code></pre></div><pre tabindex="0"><code>[1] &#34;b&#34; &#34;e&#34; &#34;e&#34; &#34;r&#34;
</code></pre>
</section>
<section>
<h2 id="readr-----dataframeの読み書き担当">readr &mdash; data.frameの読み書き担当</h2>
<a href="https://readr.tidyverse.org/">
<img src="/_img/hex-stickers/readr.webp" width="120" align="right">
</a>
<ul>
<li>生data.frameではなく安全なtibbleとして読んでくれる</li>
<li>列の名前や型を勝手に変更しない</li>
<li>オプションをごちゃごちゃ付けなくてもいい感じに動く<br>
(R標準の <code>read.table()</code> とかは意外と難しい)</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">readr</span><span class="o">::</span><span class="nf">write_tsv</span><span class="p">(</span><span class="n">iris</span><span class="p">,</span> <span class="s">&#34;iris.tsv&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">readr</span><span class="o">::</span><span class="nf">read_tsv</span><span class="p">(</span><span class="s">&#34;iris.tsv&#34;</span><span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code># A tibble: 150 x 5
  Sepal.Length Sepal.Width Petal.Length Petal.Width Species
         &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;chr&gt;  
1          5.1         3.5          1.4         0.2 setosa 
2          4.9         3            1.4         0.2 setosa 
3          4.7         3.2          1.3         0.2 setosa 
4          4.6         3.1          1.5         0.2 setosa 
5          5           3.6          1.4         0.2 setosa 
6          5.4         3.9          1.7         0.4 setosa 
7          4.6         3.4          1.4         0.3 setosa 
8          5           3.4          1.5         0.2 setosa 
# ... with 142 more rows
</code></pre>
</section>
<section>
<h2 id="dplyr-----dataframeの高速処理担当">dplyr &mdash; data.frameの高速処理担当</h2>
<a href="https://dplyr.tidyverse.org/">
<img src="/_img/hex-stickers/dplyr.webp" width="120" align="right">
</a>
<p>ひとつの関数はひとつの仕事。<br>
繋げて使いやすいシンプルな関数がたくさん。</p>
<dl>
<dt>抽出</dt>
<dd><code>filter()</code>, <code>select()</code>, <code>distinct()</code>, <code>sample_n()</code></dd>
<dt>変更・追加</dt>
<dd><code>mutate()</code>, <code>rename()</code></dd>
<dt>要約・集計</dt>
<dd><code>group_by()</code>, <code>summarise()</code>, <code>count()</code></dd>
<dt>ソート</dt>
<dd><code>arrange()</code></dd>
<dt>結合</dt>
<dd><code>left_join()</code>, <code>inner_join()</code>, <code>full_join()</code></dd>
</dl>
<p><em>etc.</em></p>

</section>
<section>
<h2 id="dplyr-----dataframeの高速処理担当">dplyr &mdash; data.frameの高速処理担当</h2>
<p>いつもdata.frameが第一引数。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="n">iris</span><span class="p">,</span> <span class="n">Sepal.Length</span> <span class="o">&lt;</span> <span class="m">4.6</span><span class="p">)</span>   <span class="c1"># 条件にあう行を抽出</span>
</span></span></code></pre></div><pre tabindex="0"><code>  Sepal.Length Sepal.Width Petal.Length Petal.Width Species
1          4.4         2.9          1.4         0.2  setosa
2          4.3         3.0          1.1         0.1  setosa
3          4.4         3.0          1.3         0.2  setosa
4          4.5         2.3          1.3         0.3  setosa
5          4.4         3.2          1.3         0.2  setosa
</code></pre><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">dplyr</span><span class="o">::</span><span class="nf">sample_n</span><span class="p">(</span><span class="n">iris</span><span class="p">,</span> <span class="m">3L</span><span class="p">)</span>                 <span class="c1"># ランダムに3行抽出</span>
</span></span></code></pre></div><pre tabindex="0"><code>    Sepal.Length Sepal.Width Petal.Length Petal.Width    Species
60           5.2         2.7          3.9         1.4 versicolor
14           4.3         3.0          1.1         0.1     setosa
107          4.9         2.5          4.5         1.7  virginica
</code></pre>
</section>
<section>
<h2 id="dplyr-----dataframeの高速処理担当">dplyr &mdash; data.frameの高速処理担当</h2>
<p>小さな関数を繋げて使う。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">iris</span> <span class="o">%&gt;%</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">arrange</span><span class="p">(</span><span class="n">Petal.Width</span><span class="p">)</span> <span class="o">%&gt;%</span>          <span class="c1"># 小さい順に並べ替え</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="n">Species</span> <span class="o">!=</span> <span class="s">&#34;setosa&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>   <span class="c1"># 行を除外</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="nf">matches</span><span class="p">(</span><span class="s">&#34;^Petal&#34;</span><span class="p">))</span> <span class="o">%&gt;%</span>    <span class="c1"># 列を除外</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">Species</span><span class="p">)</span> <span class="o">%&gt;%</span>             <span class="c1"># グループごとに</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">summarise_all</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span> <span class="o">%&gt;%</span>           <span class="c1"># 平均を計算</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">area</span> <span class="o">=</span> <span class="n">Sepal.Length</span> <span class="o">*</span> <span class="n">Sepal.Width</span> <span class="o">/</span> <span class="m">2</span><span class="p">)</span> <span class="o">%&gt;%</span>
</span></span><span class="line"><span class="cl">                                           <span class="c1"># 新しい列を作る</span>
</span></span><span class="line"><span class="cl">  <span class="nf">print</span><span class="p">()</span>                                  <span class="c1"># 表示してみる</span>
</span></span></code></pre></div><pre tabindex="0"><code>      Species Sepal.Length Sepal.Width     area
       &lt;fctr&gt;        &lt;num&gt;       &lt;num&gt;    &lt;num&gt;
1: versicolor        5.936       2.770 8.221360
2:  virginica        6.588       2.974 9.796356
</code></pre><p>見慣れないこの記号 <code>%&gt;%</code> は何？</p>

</section>
<section>
<h2 id="パイプ演算子-">パイプ演算子 <code>%&gt;%</code></h2>
<p>パイプの左側の変数を、右側の関数の第一引数にねじ込む:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="m">1</span> <span class="o">%&gt;%</span> <span class="nf">sum</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code>[1] 6
</code></pre><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">sum</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code>[1] 6
</code></pre><p>下ごしらえの流れ作業に便利:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># data %&gt;%  process-A  %&gt;%  process-B  %&gt;%  process-C</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span>      <span class="o">%&gt;%</span>  <span class="nf">sum</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">)</span>  <span class="o">%&gt;%</span>  <span class="nf">factorial</span><span class="p">()</span>
</span></span></code></pre></div><pre tabindex="0"><code>[1] 720
</code></pre>
</section>
<section>
<h2 id="パイプ演算子--を使わない">パイプ演算子 <code>%&gt;%</code> を使わない</h2>
<p>一時変数を使う方法:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">tmp1</span> <span class="o">=</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="n">iris</span><span class="p">,</span> <span class="n">Species</span> <span class="o">!=</span> <span class="s">&#34;setosa&#34;</span><span class="p">)</span> <span class="c1"># 行を除外</span>
</span></span><span class="line"><span class="cl"><span class="n">tmp2</span> <span class="o">=</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">tmp1</span><span class="p">,</span> <span class="o">-</span><span class="nf">matches</span><span class="p">(</span><span class="s">&#34;^Petal&#34;</span><span class="p">))</span>  <span class="c1"># 列を除外</span>
</span></span><span class="line"><span class="cl"><span class="n">tmp3</span> <span class="o">=</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">tmp2</span><span class="p">,</span> <span class="n">Species</span><span class="p">)</span>           <span class="c1"># グループごとに</span>
</span></span><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">summarise_all</span><span class="p">(</span><span class="n">tmp3</span><span class="p">,</span> <span class="n">mean</span><span class="p">)</span>       <span class="c1"># 平均を計算</span>
</span></span></code></pre></div><p>もしくは全部同じ名前で:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="n">iris</span><span class="p">,</span> <span class="n">Species</span> <span class="o">!=</span> <span class="s">&#34;setosa&#34;</span><span class="p">)</span>  <span class="c1"># 行を除外</span>
</span></span><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="o">-</span><span class="nf">matches</span><span class="p">(</span><span class="s">&#34;^Petal&#34;</span><span class="p">))</span> <span class="c1"># 列を除外</span>
</span></span><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Species</span><span class="p">)</span>          <span class="c1"># グループごとに</span>
</span></span><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">summarise_all</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">mean</span><span class="p">)</span>        <span class="c1"># 平均を計算</span>
</span></span></code></pre></div><p>どちらも悪くない。
何度も変数名を入力するのがやや冗長。</p>

</section>
<section>
<h2 id="パイプ演算子--を使わない">パイプ演算子 <code>%&gt;%</code> を使わない</h2>
<p>一時変数を使わない力技:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">summarise_all</span><span class="p">(</span>            <span class="c1"># 平均を計算</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span>                          <span class="c1"># グループごとに</span>
</span></span><span class="line"><span class="cl">    <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span>                            <span class="c1"># 列を除外</span>
</span></span><span class="line"><span class="cl">      <span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="n">iris</span><span class="p">,</span> <span class="n">Species</span> <span class="o">!=</span> <span class="s">&#34;setosa&#34;</span><span class="p">),</span> <span class="c1"># 行を除外</span>
</span></span><span class="line"><span class="cl">      <span class="o">-</span><span class="nf">matches</span><span class="p">(</span><span class="s">&#34;^Petal&#34;</span><span class="p">)),</span>                    <span class="c1"># 列を除外</span>
</span></span><span class="line"><span class="cl">    <span class="n">Species</span><span class="p">),</span>                               <span class="c1"># グループごとに</span>
</span></span><span class="line"><span class="cl">  <span class="n">mean</span><span class="p">)</span>                                   <span class="c1"># 平均を計算</span>
</span></span></code></pre></div><p>改行さえしない超人技:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">summarise_all</span><span class="p">(</span><span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="n">iris</span><span class="p">,</span> <span class="n">Species</span> <span class="o">!=</span> <span class="s">&#34;setosa&#34;</span><span class="p">),</span> <span class="o">-</span><span class="nf">matches</span><span class="p">(</span><span class="s">&#34;^Petal&#34;</span><span class="p">)),</span> <span class="n">Species</span><span class="p">),</span> <span class="n">mean</span><span class="p">)</span>
</span></span></code></pre></div><p>論理の流れとプログラムの流れが合わず、目が行ったり来たり。<br>
さっきのほうがぜんぜんマシ。</p>

</section>
<section>
<h2 id="パイプ演算子--を使う">パイプ演算子 <code>%&gt;%</code> を使う</h2>
<p>慣れれば、論理の流れを追いやすい:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">iris</span> <span class="o">%&gt;%</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="n">Species</span> <span class="o">!=</span> <span class="s">&#34;setosa&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>   <span class="c1"># 行を除外</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="nf">matches</span><span class="p">(</span><span class="s">&#34;^Petal&#34;</span><span class="p">))</span> <span class="o">%&gt;%</span>    <span class="c1"># 列を除外</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">Species</span><span class="p">)</span> <span class="o">%&gt;%</span>             <span class="c1"># グループごとに</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">summarise_all</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span> <span class="o">%&gt;%</span>           <span class="c1"># 平均を計算</span>
</span></span><span class="line"><span class="cl">  <span class="nf">print</span><span class="p">()</span>                                  <span class="c1"># 表示してみる</span>
</span></span></code></pre></div><pre tabindex="0"><code>      Species Sepal.Length Sepal.Width
       &lt;fctr&gt;        &lt;num&gt;       &lt;num&gt;
1: versicolor        5.936       2.770
2:  virginica        6.588       2.974
</code></pre><p>慣れるまではちょっと大変かも。無理して使わなくても大丈夫。</p>

</section>
<section>
<h2 id="tidyr-----dataframeの変形整形担当">tidyr &mdash; data.frameの変形・整形担当</h2>
<a href="https://tidyr.tidyverse.org/">
<img src="/_img/hex-stickers/tidyr.webp" width="120" align="right">
</a>
<dl>
<dt>横長から縦長に</dt>
<dd><code>gather()</code></dd>
<dt>縦長から横長に</dt>
<dd><code>spread()</code></dd>
<dt>入れ子構造をつくる、解消する</dt>
<dd><code>nest()</code>, <code>unnest()</code></dd>
<dt>1列を複数の列に分離</dt>
<dd><code>separate()</code></dd>
</dl>
<p><em>etc.</em></p>
</section>
<section>
<h2 id="tidyrgather-横長から縦長に"><code>tidyr::gather()</code> 横長から縦長に</h2>
<p>複数列にまたがる値を1列にする(ここでは<code>value</code>)。<br>
そのラベルも合わせて移動(ここでは<code>name</code>)。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">long_iris</span> <span class="o">=</span> <span class="n">iris</span> <span class="o">%&gt;%</span> <span class="nf">head</span><span class="p">(</span><span class="m">2L</span><span class="p">)</span> <span class="o">%&gt;%</span>              <span class="c1"># 最初の2行だけ</span>
</span></span><span class="line"><span class="cl">  <span class="nf">rownames_to_column</span><span class="p">(</span><span class="s">&#34;id&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>                 <span class="c1"># ID列を追加</span>
</span></span><span class="line"><span class="cl">  <span class="nf">print</span><span class="p">()</span> <span class="o">%&gt;%</span>                                  <span class="c1"># 途中経過を表示</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">gather</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">-</span><span class="n">id</span><span class="p">,</span> <span class="o">-</span><span class="n">Species</span><span class="p">)</span> <span class="o">%&gt;%</span>   <span class="c1"># 縦長に変形</span>
</span></span><span class="line"><span class="cl">  <span class="nf">print</span><span class="p">()</span>
</span></span></code></pre></div><pre tabindex="0"><code>  id Sepal.Length Sepal.Width Petal.Length Petal.Width Species
1  1          5.1         3.5          1.4         0.2  setosa
2  2          4.9         3.0          1.4         0.2  setosa
  id Species         name value
1  1  setosa Sepal.Length   5.1
2  2  setosa Sepal.Length   4.9
3  1  setosa  Sepal.Width   3.5
4  2  setosa  Sepal.Width   3.0
5  1  setosa Petal.Length   1.4
6  2  setosa Petal.Length   1.4
7  1  setosa  Petal.Width   0.2
8  2  setosa  Petal.Width   0.2
</code></pre>
</section>
<section>
<h2 id="tidyrspread-縦長から横長に"><code>tidyr::spread()</code> 縦長から横長に</h2>
<p>1列に収まっていた値(<code>value</code>)を複数列の行列に変換。<br>
そのラベル(<code>name</code>)を列の名前にする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">long_iris</span> <span class="o">%&gt;%</span> <span class="nf">print</span><span class="p">()</span> <span class="o">%&gt;%</span>      <span class="c1"># gatherしたやつ</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">spread</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>   <span class="c1"># 横長に戻す</span>
</span></span></code></pre></div><pre tabindex="0"><code>  id Species         name value
1  1  setosa Sepal.Length   5.1
2  2  setosa Sepal.Length   4.9
3  1  setosa  Sepal.Width   3.5
4  2  setosa  Sepal.Width   3.0
5  1  setosa Petal.Length   1.4
6  2  setosa Petal.Length   1.4
7  1  setosa  Petal.Width   0.2
8  2  setosa  Petal.Width   0.2
</code></pre><pre tabindex="0"><code>  id Species Petal.Length Petal.Width Sepal.Length Sepal.Width
1  1  setosa          1.4         0.2          5.1         3.5
2  2  setosa          1.4         0.2          4.9         3.0
</code></pre>
</section>
<section>
<h2 id="tidyrseparate-列を分離"><code>tidyr::separate()</code> 列を分離</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">long_iris</span> <span class="o">%&gt;%</span> <span class="nf">print</span><span class="p">()</span> <span class="o">%&gt;%</span>                     <span class="c1"># gatherしたやつ</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">separate</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;part&#34;</span><span class="p">,</span> <span class="s">&#34;measure&#34;</span><span class="p">))</span> <span class="c1"># 列を分離</span>
</span></span></code></pre></div><pre tabindex="0"><code>  id Species         name value
1  1  setosa Sepal.Length   5.1
2  2  setosa Sepal.Length   4.9
3  1  setosa  Sepal.Width   3.5
4  2  setosa  Sepal.Width   3.0
5  1  setosa Petal.Length   1.4
6  2  setosa Petal.Length   1.4
7  1  setosa  Petal.Width   0.2
8  2  setosa  Petal.Width   0.2
</code></pre><pre tabindex="0"><code>  id Species  part measure value
1  1  setosa Sepal  Length   5.1
2  2  setosa Sepal  Length   4.9
3  1  setosa Sepal   Width   3.5
4  2  setosa Sepal   Width   3.0
5  1  setosa Petal  Length   1.4
6  2  setosa Petal  Length   1.4
7  1  setosa Petal   Width   0.2
8  2  setosa Petal   Width   0.2
</code></pre>
</section>
<section>
<h2 id="tidyrnest-入れ子にする"><code>tidyr::nest()</code> 入れ子にする</h2>
<p>グループ毎にdata.frameを区切ってlist型の列に入れる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">nested_iris</span> <span class="o">=</span> <span class="nf">as_tibble</span><span class="p">(</span><span class="n">iris</span><span class="p">)</span> <span class="o">%&gt;%</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">nest</span><span class="p">(</span><span class="o">-</span><span class="n">Species</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">print</span><span class="p">()</span>
</span></span></code></pre></div><pre tabindex="0"><code>      Species     data
       &lt;fctr&gt;   &lt;list&gt;
1:     setosa &lt;tbl_df&gt;
2: versicolor &lt;tbl_df&gt;
3:  virginica &lt;tbl_df&gt;
</code></pre><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">nested_iris</span><span class="o">$</span><span class="n">data[[1L]]</span>
</span></span></code></pre></div><pre tabindex="0"><code># A tibble: 50 x 4
  Sepal.Length Sepal.Width Petal.Length Petal.Width
         &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;
1          5.1         3.5          1.4         0.2
2          4.9         3            1.4         0.2
3          4.7         3.2          1.3         0.2
4          4.6         3.1          1.5         0.2
5          5           3.6          1.4         0.2
6          5.4         3.9          1.7         0.4
7          4.6         3.4          1.4         0.3
8          5           3.4          1.5         0.2
# ... with 42 more rows
</code></pre><p>入れ子にされたlistの列どうする？
<code>purrr::map()</code>の出番！</p>

</section>
<section>
<h2 id="purrr">purrr</h2>
<a href="https://purrr.tidyverse.org/">
<img src="/_img/hex-stickers/purrr.webp" width="120" align="right">
</a>
<p>listやループの処理担当。</p>
<ul>
<li><code>map()</code>, <code>walk()</code></li>
<li><code>map_int()</code>, <code>map_dbl()</code>, <code>map_chr()</code></li>
<li><code>map_dfr()</code></li>
<li><code>pmap()</code>, <code>map2()</code></li>
<li><code>flatten()</code></li>
<li><em>etc.</em></li>
</ul>
<p>標準Rの <code>lapply()</code>, <code>sapply()</code>, <code>vapply()</code>, <code>unlist()</code> などの代わりに</p>

</section>
<section>
<h2 id="例題-anscombe">例題: <code>anscombe</code></h2>
<p>4組のx-yは、平均・分散・相関係数がほぼ同じ？</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">anscombe</span> <span class="o">%&gt;%</span>
</span></span><span class="line"><span class="cl">  <span class="n">tibble</span><span class="o">::</span><span class="nf">rownames_to_column</span><span class="p">(</span><span class="s">&#34;id&#34;</span><span class="p">)</span>       <span class="c1"># あとで必要なID列</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># xやyの値が何列にも広がってる。これを1列に(縦長に)したい</span>
</span></span></code></pre></div><pre tabindex="0"><code>   id x1 x2 x3 x4    y1   y2    y3    y4
1   1 10 10 10  8  8.04 9.14  7.46  6.58
2   2  8  8  8  8  6.95 8.14  6.77  5.76
3   3 13 13 13  8  7.58 8.74 12.74  7.71
4   4  9  9  9  8  8.81 8.77  7.11  8.84
5   5 11 11 11  8  8.33 9.26  7.81  8.47
6   6 14 14 14  8  9.96 8.10  8.84  7.04
7   7  6  6  6  8  7.24 6.13  6.08  5.25
8   8  4  4  4 19  4.26 3.10  5.39 12.50
9   9 12 12 12  8 10.84 9.13  8.15  5.56
10 10  7  7  7  8  4.82 7.26  6.42  7.91
11 11  5  5  5  8  5.68 4.74  5.73  6.89
</code></pre>
</section>
<section>
<h2 id="例題-anscombe">例題: <code>anscombe</code></h2>
<p>4組のx-yは、平均・分散・相関係数がほぼ同じ？</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">anscombe</span> <span class="o">%&gt;%</span>
</span></span><span class="line"><span class="cl">  <span class="n">tibble</span><span class="o">::</span><span class="nf">rownames_to_column</span><span class="p">(</span><span class="s">&#34;id&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>   <span class="c1"># あとで必要なID列</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">gather</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">-</span><span class="n">id</span><span class="p">)</span>         <span class="c1"># 縦長に変形</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># key列の x1 とかを x, 1 の2列に分離したい</span>
</span></span></code></pre></div><pre tabindex="0"><code>   id key value
1   1  x1 10.00
2   2  x1  8.00
3   3  x1 13.00
4   4  x1  9.00
5   5  x1 11.00
6   6  x1 14.00
7   7  x1  6.00
8   8  x1  4.00
9   9  x1 12.00
10 10  x1  7.00
11 11  x1  5.00
12  1  x2 10.00
13  2  x2  8.00
14  3  x2 13.00
15  4  x2  9.00
16  5  x2 11.00
17  6  x2 14.00
18  7  x2  6.00
19  8  x2  4.00
20  9  x2 12.00
21 10  x2  7.00
22 11  x2  5.00
23  1  x3 10.00
24  2  x3  8.00
25  3  x3 13.00
26  4  x3  9.00
27  5  x3 11.00
28  6  x3 14.00
29  7  x3  6.00
30  8  x3  4.00
31  9  x3 12.00
32 10  x3  7.00
33 11  x3  5.00
34  1  x4  8.00
35  2  x4  8.00
36  3  x4  8.00
37  4  x4  8.00
38  5  x4  8.00
39  6  x4  8.00
40  7  x4  8.00
41  8  x4 19.00
42  9  x4  8.00
43 10  x4  8.00
44 11  x4  8.00
45  1  y1  8.04
46  2  y1  6.95
47  3  y1  7.58
48  4  y1  8.81
49  5  y1  8.33
50  6  y1  9.96
51  7  y1  7.24
52  8  y1  4.26
53  9  y1 10.84
54 10  y1  4.82
55 11  y1  5.68
56  1  y2  9.14
57  2  y2  8.14
58  3  y2  8.74
59  4  y2  8.77
60  5  y2  9.26
61  6  y2  8.10
62  7  y2  6.13
63  8  y2  3.10
64  9  y2  9.13
65 10  y2  7.26
66 11  y2  4.74
67  1  y3  7.46
68  2  y3  6.77
69  3  y3 12.74
70  4  y3  7.11
71  5  y3  7.81
72  6  y3  8.84
73  7  y3  6.08
74  8  y3  5.39
75  9  y3  8.15
76 10  y3  6.42
77 11  y3  5.73
78  1  y4  6.58
79  2  y4  5.76
80  3  y4  7.71
81  4  y4  8.84
82  5  y4  8.47
83  6  y4  7.04
84  7  y4  5.25
85  8  y4 12.50
86  9  y4  5.56
87 10  y4  7.91
88 11  y4  6.89
</code></pre>
</section>
<section>
<h2 id="例題-anscombe">例題: <code>anscombe</code></h2>
<p>4組のx-yは、平均・分散・相関係数がほぼ同じ？</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">anscombe</span> <span class="o">%&gt;%</span>
</span></span><span class="line"><span class="cl">  <span class="n">tibble</span><span class="o">::</span><span class="nf">rownames_to_column</span><span class="p">(</span><span class="s">&#34;id&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>   <span class="c1"># あとで必要なID列</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">gather</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">-</span><span class="n">id</span><span class="p">)</span> <span class="o">%&gt;%</span>     <span class="c1"># 縦長に変形</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">separate</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;axis&#34;</span><span class="p">,</span> <span class="s">&#34;group&#34;</span><span class="p">),</span> <span class="m">1L</span><span class="p">)</span>      <span class="c1"># 列を分離</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># xとyのペアが1行になってほしい</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># xとyが新たな列名になるように横長にしたい</span>
</span></span></code></pre></div><pre tabindex="0"><code>   id axis group value
1   1    x     1 10.00
2   2    x     1  8.00
3   3    x     1 13.00
4   4    x     1  9.00
5   5    x     1 11.00
6   6    x     1 14.00
7   7    x     1  6.00
8   8    x     1  4.00
9   9    x     1 12.00
10 10    x     1  7.00
11 11    x     1  5.00
12  1    x     2 10.00
13  2    x     2  8.00
14  3    x     2 13.00
15  4    x     2  9.00
16  5    x     2 11.00
17  6    x     2 14.00
18  7    x     2  6.00
19  8    x     2  4.00
20  9    x     2 12.00
21 10    x     2  7.00
22 11    x     2  5.00
23  1    x     3 10.00
24  2    x     3  8.00
25  3    x     3 13.00
26  4    x     3  9.00
27  5    x     3 11.00
28  6    x     3 14.00
29  7    x     3  6.00
30  8    x     3  4.00
31  9    x     3 12.00
32 10    x     3  7.00
33 11    x     3  5.00
34  1    x     4  8.00
35  2    x     4  8.00
36  3    x     4  8.00
37  4    x     4  8.00
38  5    x     4  8.00
39  6    x     4  8.00
40  7    x     4  8.00
41  8    x     4 19.00
42  9    x     4  8.00
43 10    x     4  8.00
44 11    x     4  8.00
45  1    y     1  8.04
46  2    y     1  6.95
47  3    y     1  7.58
48  4    y     1  8.81
49  5    y     1  8.33
50  6    y     1  9.96
51  7    y     1  7.24
52  8    y     1  4.26
53  9    y     1 10.84
54 10    y     1  4.82
55 11    y     1  5.68
56  1    y     2  9.14
57  2    y     2  8.14
58  3    y     2  8.74
59  4    y     2  8.77
60  5    y     2  9.26
61  6    y     2  8.10
62  7    y     2  6.13
63  8    y     2  3.10
64  9    y     2  9.13
65 10    y     2  7.26
66 11    y     2  4.74
67  1    y     3  7.46
68  2    y     3  6.77
69  3    y     3 12.74
70  4    y     3  7.11
71  5    y     3  7.81
72  6    y     3  8.84
73  7    y     3  6.08
74  8    y     3  5.39
75  9    y     3  8.15
76 10    y     3  6.42
77 11    y     3  5.73
78  1    y     4  6.58
79  2    y     4  5.76
80  3    y     4  7.71
81  4    y     4  8.84
82  5    y     4  8.47
83  6    y     4  7.04
84  7    y     4  5.25
85  8    y     4 12.50
86  9    y     4  5.56
87 10    y     4  7.91
88 11    y     4  6.89
</code></pre>
</section>
<section>
<h2 id="例題-anscombe">例題: <code>anscombe</code></h2>
<p>4組のx-yは、平均・分散・相関係数がほぼ同じ？</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">anscombe</span> <span class="o">%&gt;%</span>
</span></span><span class="line"><span class="cl">  <span class="n">tibble</span><span class="o">::</span><span class="nf">rownames_to_column</span><span class="p">(</span><span class="s">&#34;id&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>   <span class="c1"># あとで必要なID列</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">gather</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">-</span><span class="n">id</span><span class="p">)</span> <span class="o">%&gt;%</span>     <span class="c1"># 縦長に変形</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">separate</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;axis&#34;</span><span class="p">,</span> <span class="s">&#34;group&#34;</span><span class="p">),</span> <span class="m">1L</span><span class="p">)</span> <span class="o">%&gt;%</span>  <span class="c1"># 列を分離</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">spread</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>             <span class="c1"># axis列をx列とy列に</span>
</span></span></code></pre></div><pre tabindex="0"><code>   id group  x     y
1   1     1 10  8.04
2   1     2 10  9.14
3   1     3 10  7.46
4   1     4  8  6.58
5  10     1  7  4.82
6  10     2  7  7.26
7  10     3  7  6.42
8  10     4  8  7.91
9  11     1  5  5.68
10 11     2  5  4.74
11 11     3  5  5.73
12 11     4  8  6.89
13  2     1  8  6.95
14  2     2  8  8.14
15  2     3  8  6.77
16  2     4  8  5.76
17  3     1 13  7.58
18  3     2 13  8.74
19  3     3 13 12.74
20  3     4  8  7.71
21  4     1  9  8.81
22  4     2  9  8.77
23  4     3  9  7.11
24  4     4  8  8.84
25  5     1 11  8.33
26  5     2 11  9.26
27  5     3 11  7.81
28  5     4  8  8.47
29  6     1 14  9.96
30  6     2 14  8.10
31  6     3 14  8.84
32  6     4  8  7.04
33  7     1  6  7.24
34  7     2  6  6.13
35  7     3  6  6.08
36  7     4  8  5.25
37  8     1  4  4.26
38  8     2  4  3.10
39  8     3  4  5.39
40  8     4 19 12.50
41  9     1 12 10.84
42  9     2 12  9.13
43  9     3 12  8.15
44  9     4  8  5.56
</code></pre>
</section>
<section>
<h2 id="例題-anscombe">例題: <code>anscombe</code></h2>
<p>4組のx-yは、平均・分散・相関係数がほぼ同じ？</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">tidy_anscombe</span> <span class="o">=</span> <span class="n">anscombe</span> <span class="o">%&gt;%</span>
</span></span><span class="line"><span class="cl">  <span class="n">tibble</span><span class="o">::</span><span class="nf">rownames_to_column</span><span class="p">(</span><span class="s">&#34;id&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>   <span class="c1"># あとで必要なID列</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">gather</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">-</span><span class="n">id</span><span class="p">)</span> <span class="o">%&gt;%</span>     <span class="c1"># 縦長に変形</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">separate</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;axis&#34;</span><span class="p">,</span> <span class="s">&#34;group&#34;</span><span class="p">),</span> <span class="m">1L</span><span class="p">)</span> <span class="o">%&gt;%</span>  <span class="c1"># 列を分離</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">spread</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">%&gt;%</span>         <span class="c1"># axis列をx列とy列に</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="n">id</span><span class="p">)</span> <span class="o">%&gt;%</span>                 <span class="c1"># 使い終わったID列を消す</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">arrange</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">%&gt;%</span>              <span class="c1"># グループごとに並べる</span>
</span></span><span class="line"><span class="cl">  <span class="nf">print</span><span class="p">()</span>                                <span class="c1"># ggplotしたい形！</span>
</span></span></code></pre></div><pre tabindex="0"><code>   group  x     y
1      1 10  8.04
2      1  7  4.82
3      1  5  5.68
4      1  8  6.95
5      1 13  7.58
6      1  9  8.81
7      1 11  8.33
8      1 14  9.96
9      1  6  7.24
10     1  4  4.26
11     1 12 10.84
12     2 10  9.14
13     2  7  7.26
14     2  5  4.74
15     2  8  8.14
16     2 13  8.74
17     2  9  8.77
18     2 11  9.26
19     2 14  8.10
20     2  6  6.13
21     2  4  3.10
22     2 12  9.13
23     3 10  7.46
24     3  7  6.42
25     3  5  5.73
26     3  8  6.77
27     3 13 12.74
28     3  9  7.11
29     3 11  7.81
30     3 14  8.84
31     3  6  6.08
32     3  4  5.39
33     3 12  8.15
34     4  8  6.58
35     4  8  7.91
36     4  8  6.89
37     4  8  5.76
38     4  8  7.71
39     4  8  8.84
40     4  8  8.47
41     4  8  7.04
42     4  8  5.25
43     4 19 12.50
44     4  8  5.56
</code></pre>
</section>
<section>
<h2 id="例題-anscombe">例題: <code>anscombe</code></h2>
<p>4組のx-yは、平均・分散・相関係数がほぼ同じ？</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">ggplot</span><span class="p">(</span><span class="n">tidy_anscombe</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="nf">geom_point</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="nf">stat_smooth</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">lm</span><span class="p">,</span> <span class="n">se</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="n">fullrange</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="nf">facet_wrap</span><span class="p">(</span><span class="o">~</span> <span class="n">group</span><span class="p">,</span> <span class="n">nrow</span> <span class="o">=</span> <span class="m">1L</span><span class="p">)</span>
</span></span></code></pre></div><img src="figure/plot_anscombe-1.png" title="plot of chunk plot_anscombe" alt="plot of chunk plot_anscombe" width="98%" />
</section>
<section>
<h2 id="例題-anscombe">例題: <code>anscombe</code></h2>
<p>dplyrのグループ化を使って要約</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">tidy_anscombe</span> <span class="o">%&gt;%</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">%&gt;%</span>   <span class="c1"># group列でグループ化して</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">summarise</span><span class="p">(</span>            <span class="c1"># x, y列を使ってsummarize</span>
</span></span><span class="line"><span class="cl">    <span class="n">mean_x</span> <span class="o">=</span> <span class="nf">mean</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">mean_y</span> <span class="o">=</span> <span class="nf">mean</span><span class="p">(</span><span class="n">y</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">sd_x</span> <span class="o">=</span> <span class="nf">sd</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">sd_y</span> <span class="o">=</span> <span class="nf">sd</span><span class="p">(</span><span class="n">y</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">cor_xy</span> <span class="o">=</span> <span class="nf">cor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code># A tibble: 4 x 6
  group mean_x mean_y  sd_x  sd_y cor_xy
  &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1 1          9   7.50  3.32  2.03  0.816
2 2          9   7.50  3.32  2.03  0.816
3 3          9   7.5   3.32  2.03  0.816
4 4          9   7.50  3.32  2.03  0.817
</code></pre>
</section>
<section>
<h2 id="例題-anscombe">例題: <code>anscombe</code></h2>
<p>tidyrのネストを使って要約 (中級者向け)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">tidy_anscombe</span> <span class="o">%&gt;%</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">nest</span><span class="p">(</span><span class="o">-</span><span class="n">group</span><span class="p">)</span> <span class="o">%&gt;%</span>    <span class="c1"># group列でネストして</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">purrr</span><span class="o">::</span><span class="nf">map</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="kr">function</span><span class="p">(</span><span class="n">data_i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">data_i</span> <span class="o">%&gt;%</span>               <span class="c1"># 入れ子の内側の各データをいじって</span>
</span></span><span class="line"><span class="cl">      <span class="nf">summarise_all</span><span class="p">(</span><span class="nf">funs</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">sd</span><span class="p">))</span> <span class="o">%&gt;%</span>
</span></span><span class="line"><span class="cl">      <span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">cor_xy</span> <span class="o">=</span> <span class="nf">cor</span><span class="p">(</span><span class="n">data_i</span><span class="o">$</span><span class="n">x</span><span class="p">,</span> <span class="n">data_i</span><span class="o">$</span><span class="n">y</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">}))</span> <span class="o">%&gt;%</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">unnest</span><span class="p">()</span>            <span class="c1"># 入れ子を解消</span>
</span></span></code></pre></div><pre tabindex="0"><code>  group x_mean   y_mean     x_sd     y_sd    cor_xy
1     1      9 7.500909 3.316625 2.031568 0.8164205
2     2      9 7.500909 3.316625 2.031657 0.8162365
3     3      9 7.500000 3.316625 2.030424 0.8162867
4     4      9 7.500909 3.316625 2.030579 0.8165214
</code></pre>
</section>
<section>
<h2 id="例題-先ほどの伊東さんhttpsfigsharecomarticlesggplot2___5982007のデータ準備部分">例題: <a href="https://figshare.com/articles/ggplot2___/5982007">先ほどの伊東さん</a>のデータ準備部分</h2>
<p><code>m_data</code> をベースに、2つをまとめた <code>g_data</code> を作りたい</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">prefix</span> <span class="o">=</span> <span class="s">&#34;https://raw.githubusercontent.com/ito4303/esj65/master/&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">m_data</span> <span class="o">=</span> <span class="nf">paste0</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s">&#34;Measurement_data.csv&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">read_csv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">s_data</span> <span class="o">=</span> <span class="nf">paste0</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s">&#34;Stem_data.csv&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">read_csv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">m_data</span> <span class="o">%&gt;%</span> <span class="nf">head</span><span class="p">(</span><span class="m">3L</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">s_data</span> <span class="o">%&gt;%</span> <span class="nf">head</span><span class="p">(</span><span class="m">3L</span><span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code># A tibble: 3 x 4
  Stem   Year   DBH Comment
  &lt;chr&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;  
1 WF002  2014   5.9 &lt;NA&gt;   
2 WF004  2014   3.8 &lt;NA&gt;   
3 315    1993  16.1 &lt;NA&gt;   
</code></pre><pre tabindex="0"><code># A tibble: 3 x 9
  Indv  Stem      X     Y    X1    Y1 Species              Start   End
  &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;                &lt;int&gt; &lt;int&gt;
1 WF002 WF002     0     0   2.8   3.2 Cleyera japonica      2014    NA
2 WF004 WF004     0     0   3.1   4   Quercus glauca        2014    NA
3 315   315       0     0   2.8   1.4 Symplocos prunifolia  1993    NA
</code></pre>
</section>
<section>
<h2 id="例題-先ほどの伊東さんhttpsfigsharecomarticlesggplot2___5982007のデータ準備部分">例題: <a href="https://figshare.com/articles/ggplot2___/5982007">先ほどの伊東さん</a>のデータ準備部分</h2>
<p><code>m_data</code> をベースに、2つをまとめた <code>g_data</code> を作りたい</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">g_data</span> <span class="o">=</span> <span class="n">m_data</span> <span class="o">%&gt;%</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">inner_join</span><span class="p">(</span><span class="n">s_data</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="s">&#34;Stem&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>  <span class="c1"># 共通する列で結合</span>
</span></span><span class="line"><span class="cl">  <span class="nf">print</span><span class="p">()</span>                                     <span class="c1"># 使う行を絞りたい</span>
</span></span></code></pre></div><pre tabindex="0"><code>         Stem  Year   DBH Comment   Indv     X     Y    X1    Y1
       &lt;char&gt; &lt;int&gt; &lt;num&gt;  &lt;char&gt; &lt;char&gt; &lt;int&gt; &lt;int&gt; &lt;num&gt; &lt;num&gt;
    1:  WF002  2014   5.9    &lt;NA&gt;  WF002     0     0   2.8   3.2
    2:  WF004  2014   3.8    &lt;NA&gt;  WF004     0     0   3.1   4.0
    3:    315  1993  16.1    &lt;NA&gt;    315     0     0   2.8   1.4
    4:    315  1996  16.6    &lt;NA&gt;    315     0     0   2.8   1.4
   ---                                                          
18199: 419531  1996   4.8    &lt;NA&gt; 419531   205    45 205.6  47.6
18200: 419531  1999   5.1    &lt;NA&gt; 419531   205    45 205.6  47.6
18201: 419531  2002   5.4    &lt;NA&gt; 419531   205    45 205.6  47.6
18202: 419531  2005    NA     cut 419531   205    45 205.6  47.6
                    Species Start   End
                     &lt;char&gt; &lt;int&gt; &lt;int&gt;
    1:     Cleyera japonica  2014    NA
    2:       Quercus glauca  2014    NA
    3: Symplocos prunifolia  1993    NA
    4: Symplocos prunifolia  1993    NA
   ---                                 
18199:       Quercus glauca  1993  2002
18200:       Quercus glauca  1993  2002
18201:       Quercus glauca  1993  2002
18202:       Quercus glauca  1993  2002
</code></pre>
</section>
<section>
<h2 id="例題-先ほどの伊東さんhttpsfigsharecomarticlesggplot2___5982007のデータ準備部分">例題: <a href="https://figshare.com/articles/ggplot2___/5982007">先ほどの伊東さん</a>のデータ準備部分</h2>
<p><code>m_data</code> をベースに、2つをまとめた <code>g_data</code> を作りたい</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">g_data</span> <span class="o">=</span> <span class="n">m_data</span> <span class="o">%&gt;%</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">inner_join</span><span class="p">(</span><span class="n">s_data</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="s">&#34;Stem&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>  <span class="c1"># 共通する列で結合</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span>                              <span class="c1"># 使う行を絞りたい</span>
</span></span><span class="line"><span class="cl">    <span class="n">Year</span> <span class="o">%in%</span> <span class="nf">c</span><span class="p">(</span><span class="m">1993</span><span class="p">,</span> <span class="m">2014</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">X1</span> <span class="o">&lt;</span> <span class="m">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">Species</span> <span class="o">%in%</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;Quercus glauca&#34;</span><span class="p">,</span> <span class="s">&#34;Symplocos prunifolia&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">DBH</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span> <span class="o">%&gt;%</span>                                       <span class="c1"># 使う列を絞りたい</span>
</span></span><span class="line"><span class="cl">  <span class="nf">print</span><span class="p">()</span>
</span></span></code></pre></div><pre tabindex="0"><code>       Stem  Year   DBH       Comment   Indv     X     Y    X1    Y1
     &lt;char&gt; &lt;int&gt; &lt;num&gt;        &lt;char&gt; &lt;char&gt; &lt;int&gt; &lt;int&gt; &lt;num&gt; &lt;num&gt;
  1:  WF004  2014   3.8          &lt;NA&gt;  WF004     0     0   3.1   4.0
  2:    315  1993  16.1          &lt;NA&gt;    315     0     0   2.8   1.4
  3:    315  2014  19.2          &lt;NA&gt;    315     0     0   2.8   1.4
  4:   1319  1993  12.7          &lt;NA&gt;   1319     0     5   0.1   7.3
 ---                                                                
539:  97374  2014   5.4 bark-stripped  97374    45    35  47.0  35.2
540:  97375  1993  10.2          &lt;NA&gt;  97375    45    35  46.4  38.6
541:  97376  1993   8.8          &lt;NA&gt;  98382    45    35  45.1  40.0
542:  98382  1993   8.5          &lt;NA&gt;  98382    45    40  45.0  40.0
                  Species Start   End
                   &lt;char&gt; &lt;int&gt; &lt;int&gt;
  1:       Quercus glauca  2014    NA
  2: Symplocos prunifolia  1993    NA
  3: Symplocos prunifolia  1993    NA
  4: Symplocos prunifolia  1993    NA
 ---                                 
539:       Quercus glauca  1993    NA
540: Symplocos prunifolia  1993  2005
541:       Quercus glauca  1993  2005
542:       Quercus glauca  1993  2005
</code></pre>
</section>
<section>
<h2 id="例題-先ほどの伊東さんhttpsfigsharecomarticlesggplot2___5982007のデータ準備部分">例題: <a href="https://figshare.com/articles/ggplot2___/5982007">先ほどの伊東さん</a>のデータ準備部分</h2>
<p><code>m_data</code> をベースに、2つをまとめた <code>g_data</code> を作りたい</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">g_data</span> <span class="o">=</span> <span class="n">m_data</span> <span class="o">%&gt;%</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">inner_join</span><span class="p">(</span><span class="n">s_data</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="s">&#34;Stem&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>  <span class="c1"># 共通する列で結合</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span>                              <span class="c1"># 使う行を絞りたい</span>
</span></span><span class="line"><span class="cl">    <span class="n">Year</span> <span class="o">%in%</span> <span class="nf">c</span><span class="p">(</span><span class="m">1993</span><span class="p">,</span> <span class="m">2014</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">X1</span> <span class="o">&lt;</span> <span class="m">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">Species</span> <span class="o">%in%</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;Quercus glauca&#34;</span><span class="p">,</span> <span class="s">&#34;Symplocos prunifolia&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">DBH</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span> <span class="o">%&gt;%</span>                                       <span class="c1"># 使う列を絞りたい</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span> <span class="n">Y1</span><span class="p">,</span> <span class="n">Year</span><span class="p">,</span> <span class="n">Species</span><span class="p">,</span> <span class="n">DBH</span><span class="p">)</span> <span class="o">%&gt;%</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">rename</span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">X1</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">Y1</span><span class="p">)</span> <span class="o">%&gt;%</span>           <span class="c1"># 列名を変更</span>
</span></span><span class="line"><span class="cl">  <span class="nf">print</span><span class="p">()</span>
</span></span></code></pre></div><pre tabindex="0"><code>         X     Y  Year              Species   DBH
     &lt;num&gt; &lt;num&gt; &lt;int&gt;               &lt;char&gt; &lt;num&gt;
  1:   3.1   4.0  2014       Quercus glauca   3.8
  2:   2.8   1.4  1993 Symplocos prunifolia  16.1
  3:   2.8   1.4  2014 Symplocos prunifolia  19.2
  4:   0.1   7.3  1993 Symplocos prunifolia  12.7
 ---                                             
539:  47.0  35.2  2014       Quercus glauca   5.4
540:  46.4  38.6  1993 Symplocos prunifolia  10.2
541:  45.1  40.0  1993       Quercus glauca   8.8
542:  45.0  40.0  1993       Quercus glauca   8.5
</code></pre>
</section>
<section>
<h2 id="例題-vadeaths">例題: <code>VADeaths</code></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">as.data.frame</span><span class="p">(</span><span class="n">VADeaths</span><span class="p">)</span>                     <span class="c1"># data.frameに変換</span>
</span></span><span class="line"><span class="cl">                                            <span class="c1"># 行名を列に</span>
</span></span><span class="line"><span class="cl">                                            <span class="c1"># 縦長に変形</span>
</span></span><span class="line"><span class="cl">                                                  <span class="c1"># 地域と性別を分離</span>
</span></span><span class="line"><span class="cl">                                            <span class="c1"># 下限と上限を分離</span>
</span></span></code></pre></div><pre tabindex="0"><code>      Rural Male Rural Female Urban Male Urban Female
50-54       11.7          8.7       15.4          8.4
55-59       18.1         11.7       24.3         13.6
60-64       26.9         20.3       37.0         19.3
65-69       41.0         30.9       54.6         35.1
70-74       66.0         54.3       71.1         50.0
</code></pre>
</section>
<section>
<h2 id="例題-vadeaths">例題: <code>VADeaths</code></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">as.data.frame</span><span class="p">(</span><span class="n">VADeaths</span><span class="p">)</span> <span class="o">%&gt;%</span>                 <span class="c1"># data.frameに変換</span>
</span></span><span class="line"><span class="cl">  <span class="n">tibble</span><span class="o">::</span><span class="nf">rownames_to_column</span><span class="p">(</span><span class="s">&#34;class&#34;</span><span class="p">)</span>       <span class="c1"># 行名を列に</span>
</span></span><span class="line"><span class="cl">                                            <span class="c1"># 縦長に変形</span>
</span></span><span class="line"><span class="cl">                                                  <span class="c1"># 地域と性別を分離</span>
</span></span><span class="line"><span class="cl">                                            <span class="c1"># 下限と上限を分離</span>
</span></span></code></pre></div><pre tabindex="0"><code>  class Rural Male Rural Female Urban Male Urban Female
1 50-54       11.7          8.7       15.4          8.4
2 55-59       18.1         11.7       24.3         13.6
3 60-64       26.9         20.3       37.0         19.3
4 65-69       41.0         30.9       54.6         35.1
5 70-74       66.0         54.3       71.1         50.0
</code></pre>
</section>
<section>
<h2 id="例題-vadeaths">例題: <code>VADeaths</code></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">as.data.frame</span><span class="p">(</span><span class="n">VADeaths</span><span class="p">)</span> <span class="o">%&gt;%</span>                 <span class="c1"># data.frameに変換</span>
</span></span><span class="line"><span class="cl">  <span class="n">tibble</span><span class="o">::</span><span class="nf">rownames_to_column</span><span class="p">(</span><span class="s">&#34;class&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>   <span class="c1"># 行名を列に</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">gather</span><span class="p">(</span><span class="n">people</span><span class="p">,</span> <span class="n">death</span><span class="p">,</span> <span class="o">-</span><span class="n">class</span><span class="p">)</span>      <span class="c1"># 縦長に変形</span>
</span></span><span class="line"><span class="cl">                                                  <span class="c1"># 地域と性別を分離</span>
</span></span><span class="line"><span class="cl">                                            <span class="c1"># 下限と上限を分離</span>
</span></span></code></pre></div><pre tabindex="0"><code>   class       people death
1  50-54   Rural Male  11.7
2  55-59   Rural Male  18.1
3  60-64   Rural Male  26.9
4  65-69   Rural Male  41.0
5  70-74   Rural Male  66.0
6  50-54 Rural Female   8.7
7  55-59 Rural Female  11.7
8  60-64 Rural Female  20.3
9  65-69 Rural Female  30.9
10 70-74 Rural Female  54.3
11 50-54   Urban Male  15.4
12 55-59   Urban Male  24.3
13 60-64   Urban Male  37.0
14 65-69   Urban Male  54.6
15 70-74   Urban Male  71.1
16 50-54 Urban Female   8.4
17 55-59 Urban Female  13.6
18 60-64 Urban Female  19.3
19 65-69 Urban Female  35.1
20 70-74 Urban Female  50.0
</code></pre>
</section>
<section>
<h2 id="例題-vadeaths">例題: <code>VADeaths</code></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">as.data.frame</span><span class="p">(</span><span class="n">VADeaths</span><span class="p">)</span> <span class="o">%&gt;%</span>                 <span class="c1"># data.frameに変換</span>
</span></span><span class="line"><span class="cl">  <span class="n">tibble</span><span class="o">::</span><span class="nf">rownames_to_column</span><span class="p">(</span><span class="s">&#34;class&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>   <span class="c1"># 行名を列に</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">gather</span><span class="p">(</span><span class="n">people</span><span class="p">,</span> <span class="n">death</span><span class="p">,</span> <span class="o">-</span><span class="n">class</span><span class="p">)</span> <span class="o">%&gt;%</span>  <span class="c1"># 縦長に変形</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">separate</span><span class="p">(</span><span class="n">people</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;region&#34;</span><span class="p">,</span> <span class="s">&#34;sex&#34;</span><span class="p">))</span>     <span class="c1"># 地域と性別を分離</span>
</span></span><span class="line"><span class="cl">                                            <span class="c1"># 下限と上限を分離</span>
</span></span></code></pre></div><pre tabindex="0"><code>   class region    sex death
1  50-54  Rural   Male  11.7
2  55-59  Rural   Male  18.1
3  60-64  Rural   Male  26.9
4  65-69  Rural   Male  41.0
5  70-74  Rural   Male  66.0
6  50-54  Rural Female   8.7
7  55-59  Rural Female  11.7
8  60-64  Rural Female  20.3
9  65-69  Rural Female  30.9
10 70-74  Rural Female  54.3
11 50-54  Urban   Male  15.4
12 55-59  Urban   Male  24.3
13 60-64  Urban   Male  37.0
14 65-69  Urban   Male  54.6
15 70-74  Urban   Male  71.1
16 50-54  Urban Female   8.4
17 55-59  Urban Female  13.6
18 60-64  Urban Female  19.3
19 65-69  Urban Female  35.1
20 70-74  Urban Female  50.0
</code></pre>
</section>
<section>
<h2 id="例題-vadeaths">例題: <code>VADeaths</code></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">as.data.frame</span><span class="p">(</span><span class="n">VADeaths</span><span class="p">)</span> <span class="o">%&gt;%</span>                 <span class="c1"># data.frameに変換</span>
</span></span><span class="line"><span class="cl">  <span class="n">tibble</span><span class="o">::</span><span class="nf">rownames_to_column</span><span class="p">(</span><span class="s">&#34;class&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>   <span class="c1"># 行名を列に</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">gather</span><span class="p">(</span><span class="n">people</span><span class="p">,</span> <span class="n">death</span><span class="p">,</span> <span class="o">-</span><span class="n">class</span><span class="p">)</span> <span class="o">%&gt;%</span>  <span class="c1"># 縦長に変形</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">separate</span><span class="p">(</span><span class="n">people</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;region&#34;</span><span class="p">,</span> <span class="s">&#34;sex&#34;</span><span class="p">))</span> <span class="o">%&gt;%</span> <span class="c1"># 地域と性別を分離</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">separate</span><span class="p">(</span><span class="n">class</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;lbound&#34;</span><span class="p">,</span> <span class="s">&#34;ubound&#34;</span><span class="p">),</span> <span class="s">&#34;-&#34;</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                            <span class="c1"># 下限と上限を分離</span>
</span></span></code></pre></div><pre tabindex="0"><code>   lbound ubound region    sex death
1      50     54  Rural   Male  11.7
2      55     59  Rural   Male  18.1
3      60     64  Rural   Male  26.9
4      65     69  Rural   Male  41.0
5      70     74  Rural   Male  66.0
6      50     54  Rural Female   8.7
7      55     59  Rural Female  11.7
8      60     64  Rural Female  20.3
9      65     69  Rural Female  30.9
10     70     74  Rural Female  54.3
11     50     54  Urban   Male  15.4
12     55     59  Urban   Male  24.3
13     60     64  Urban   Male  37.0
14     65     69  Urban   Male  54.6
15     70     74  Urban   Male  71.1
16     50     54  Urban Female   8.4
17     55     59  Urban Female  13.6
18     60     64  Urban Female  19.3
19     65     69  Urban Female  35.1
20     70     74  Urban Female  50.0
</code></pre>
</section>
<section>
<h2 id="例題-数値単位になっちゃってる列を処理">例題: 数値+単位になっちゃってる列を処理</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">women2</span> <span class="o">=</span> <span class="n">women</span> <span class="o">%&gt;%</span> <span class="nf">sample_n</span><span class="p">(</span><span class="m">2L</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">tibble</span><span class="o">::</span><span class="nf">as_tibble</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">height</span> <span class="o">=</span> <span class="nf">paste0</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="s">&#34;in&#34;</span><span class="p">),</span> <span class="n">weight</span> <span class="o">=</span> <span class="nf">paste</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="s">&#34;lbs&#34;</span><span class="p">))</span> <span class="o">%&gt;%</span> <span class="nf">print</span><span class="p">()</span>
</span></span></code></pre></div><pre tabindex="0"><code>   height  weight
   &lt;char&gt;  &lt;char&gt;
1:   72in 164 lbs
2:   67in 142 lbs
</code></pre><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># 単位を捨てる (スペースの有無によらず可能)</span>
</span></span><span class="line"><span class="cl"><span class="n">women2</span> <span class="o">%&gt;%</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">weight</span> <span class="o">=</span> <span class="n">readr</span><span class="o">::</span><span class="nf">parse_number</span><span class="p">(</span><span class="n">weight</span><span class="p">))</span>
</span></span></code></pre></div><pre tabindex="0"><code># A tibble: 2 x 2
  height weight
  &lt;chr&gt;   &lt;dbl&gt;
1 72in      164
2 67in      142
</code></pre><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># 単位を新しい列に分ける</span>
</span></span><span class="line"><span class="cl"><span class="n">women2</span> <span class="o">%&gt;%</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">separate</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;height&#34;</span><span class="p">,</span> <span class="s">&#34;uh&#34;</span><span class="p">),</span> <span class="m">-2L</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span> <span class="o">%&gt;%</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">separate</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;weight&#34;</span><span class="p">,</span> <span class="s">&#34;uw&#34;</span><span class="p">),</span> <span class="s">&#34; &#34;</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code># A tibble: 2 x 4
  height uh    weight uw   
   &lt;int&gt; &lt;chr&gt;  &lt;int&gt; &lt;chr&gt;
1     72 in       164 lbs  
2     67 in       142 lbs  
</code></pre>
</section>
<section>
<h2 id="質問を受けて補足-文字列処理">(質問を受けて補足) 文字列処理</h2>
<p>さらに複雑な文字列の抽出・置換をしたい場合は
<a href="https://stringr.tidyverse.org/">stringrパッケージ</a>
で正規表現を使う:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">c</span><span class="p">(</span><span class="s">&#34;Who am I? 24601!&#34;</span><span class="p">,</span> <span class="s">&#34;p = 0.02 *&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>
</span></span><span class="line"><span class="cl">  <span class="nf">str_extract</span><span class="p">(</span><span class="s">&#34;[\\d\\.]+&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>  <span class="c1"># 連続する数字または小数点を抽出</span>
</span></span><span class="line"><span class="cl">  <span class="nf">as.numeric</span><span class="p">()</span>                  <span class="c1"># 数値に変換</span>
</span></span></code></pre></div><pre tabindex="0"><code>[1] 24601.00     0.02
</code></pre><p>全角英数字を半角に変換</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">c</span><span class="p">(</span><span class="s">&#34;ｔｐ５３&#34;</span><span class="p">,</span> <span class="s">&#34;ＫＲＡＳ&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>
</span></span><span class="line"><span class="cl">  <span class="n">stringi</span><span class="o">::</span><span class="nf">stri_trans_nfkc</span><span class="p">()</span>
</span></span></code></pre></div><pre tabindex="0"><code>[1] &#34;tp53&#34; &#34;KRAS&#34;
</code></pre>
</section>
<section>
<h2 id="質問を受けて補足-名前の衝突">(質問を受けて補足) 名前の衝突</h2>
<p><code>filter(...)</code> でも動くのにわざわざ頭に <code>dplyr::</code> 付ける？</p>
<ul>
<li>今回の発表では、どのパッケージ由来かをなるべく明示したかった</li>
<li>ほかのパッケージや自分の作業によって、<br>
<strong>同じ名前の関数で上書きされちゃっても大丈夫なように:</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">filter</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="kr">return</span><span class="p">(</span><span class="kc">NULL</span><span class="p">)</span>     <span class="c1"># うっかり同名の関数を作る</span>
</span></span><span class="line"><span class="cl"><span class="nf">filter</span><span class="p">(</span><span class="n">iris</span><span class="p">,</span> <span class="n">Petal.Length</span> <span class="o">&lt;</span> <span class="m">1.2</span><span class="p">)</span>         <span class="c1"># 新しいほうが使われちゃう</span>
</span></span></code></pre></div><pre tabindex="0"><code>NULL
</code></pre><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="n">iris</span><span class="p">,</span> <span class="n">Petal.Length</span> <span class="o">&lt;</span> <span class="m">1.2</span><span class="p">)</span>  <span class="c1"># 明示したので大丈夫</span>
</span></span></code></pre></div><pre tabindex="0"><code>  Sepal.Length Sepal.Width Petal.Length Petal.Width Species
1          4.3         3.0          1.1         0.1  setosa
2          4.6         3.6          1.0         0.2  setosa
</code></pre>
</section>
<section>
<h2 id="質問を受けて補足-布教">(質問を受けて補足) 布教</h2>
<img src="/slides/image/free/Punishment_sisyph.jpg" alt="Punishment sisyph.jpg" height="280" align="right">
<p>頑なにエクセルを使い込む熟練のシーシュポスたちにどうやってRの利用を広めていくか？</p>
<ul>
<li>彼らが苦労してる作業を魔法のように一瞬で解決して見せる。</li>
<li>その魔法を使うのは意外と難しくない、と思わせる。</li>
<li>というのを地道に続けていくしかない・・・？</li>
</ul>
</section>
<section>
<h2 id="参考">参考</h2>
<dl>
<dt>R for Data Science &mdash; Hadley Wickham and Garrett Grolemund</dt>
<dd><a href="http://r4ds.had.co.nz/">http://r4ds.had.co.nz/</a></dd>
<dd><a href="https://amzn.to/2tbRmVc">英語版書籍</a></dd>
<dd><a href="https://amzn.to/2yyFRKt">日本語版書籍(Rではじめるデータサイエンス)</a></dd>
<dt>各パッケージの公式ドキュメント</dt>
<dd><a href="https://www.tidyverse.org/">tidyverse</a>,
<a href="https://dplyr.tidyverse.org/">dplyr</a>,
<a href="https://tidyr.tidyverse.org/">tidyr</a>,
<a href="https://purrr.tidyverse.org/">purrr</a>,
<a href="https://tibble.tidyverse.org/">tibble</a>,
<a href="https://readr.tidyverse.org/">readr</a>,
<a href="https://readxl.tidyverse.org/">readxl</a>,
<a href="https://stringr.tidyverse.org/">stringr</a></dd>
<dt>整然データとは何か &mdash; <a href="https://twitter.com/f_nisihara">@f_nisihara</a></dt>
<dd><a href="https://speakerdeck.com/fnshr/zheng-ran-detatutenani">https://speakerdeck.com/fnshr/zheng-ran-detatutenani</a></dd>
<dd><a href="http://id.fnshr.info/2017/01/09/tidy-data-intro/">http://id.fnshr.info/2017/01/09/tidy-data-intro/</a></dd>
</dl>
<p><a href="https://en.wikipedia.org/wiki/Sisyphus">https://en.wikipedia.org/wiki/Sisyphus</a></p>
</section>
<section>
<h2 id="疑問やエラーの解決方法">疑問やエラーの解決方法</h2>
<ul>
<li>公式ドキュメントを読む</li>
<li>エラー文をちゃんと読む</li>
<li>パッケージ名やエラー文をコピペしてウェブ検索<br>
→ StackOverflowや個人サイトに先例</li>
<li>身近な経験者に訊く</li>
<li>Slackのr-wakalangに質問を投稿する<br>
<a href="https://github.com/tokyor/r-wakalang">https://github.com/tokyor/r-wakalang</a> <br>
内容によってチャンネルを選ぶ:<br>
<code>#r_beginners</code>, <code>#statistics</code>, <code>#ggplot2</code>, etc.</li>
<li>質問するときは、状況を再現できる小さな例
<a href="https://reprex.tidyverse.org/">(reprex)</a>
を添えて</li>
</ul>

</section>
<section>
<h2 id="まとめ">まとめ</h2>
<ul>
<li>解析や作図の前に、使いやすい形にデータを整えよう。</li>
<li>マウスでぽちぽちセルの切り貼りをするのはやめて、<br>
そういうことはRにやらせよう。</li>
<li>いまRを使うなら、tidyverseの機能を使うと捗る。</li>
<li>調べ方がわかれば、具体的な方法を全部覚えなくても大丈夫。</li>
</ul>

</section>
</div>
</div>
</body>
</html>
