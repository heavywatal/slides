+++
url = "tmd2019/2-structure.html"
title = "2. ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å‡¦ç† â€” Rã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿å‰å‡¦ç†å®Ÿç¿’ 2019"
linktitle = "ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å‡¦ç†: æŠ½å‡ºã€é›†ç´„ã€çµåˆã€å¤‰å½¢ãªã©"
date = 2019-12-21T14:40:00+09:00
type = "reveal"
draft = false
+++

# [Rã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿å‰å‡¦ç†å®Ÿç¿’](.)

<div class="author">
å²©åµœ èˆª (Watal M. Iwasaki, PhD)
</div>

<div class="affiliation">
æ±åŒ—å¤§å­¦ ç”Ÿå‘½ç§‘å­¦ç ”ç©¶ç§‘ é€²åŒ–ã‚²ãƒãƒŸã‚¯ã‚¹åˆ†é‡ ç‰¹ä»»åŠ©æ•™<br>
(Graduate School of Life Sciences, Tohoku University)
</div>

<ol>
<li><a href="1-introduction.html">å…¥é–€: å‰å‡¦ç†ã¨ã¯ã€‚Rã‚’ä½¿ã†ãƒ¡ãƒªãƒƒãƒˆã€‚Rã®åŸºæœ¬</a>
<li class="current-deck"><a href="2-structure.html">ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å‡¦ç†: æŠ½å‡ºã€é›†ç´„ã€çµåˆã€å¤‰å½¢ãªã©</a>
<li><a href="3-content.html">ãƒ‡ãƒ¼ã‚¿å†…å®¹ã®å‡¦ç†: æ•°å€¤ã€æ–‡å­—åˆ—ã€æ—¥æ™‚ãªã©</a>
<li><a href="4-practice.html">å®Ÿè·µ: ç¾å®Ÿã®å•é¡Œã«å¯¾å‡¦ã—ã¦ã¿ã‚‹</a>
</ol>

<div class="footnote">
2019-12-21 æ±äº¬åŒ»ç§‘æ­¯ç§‘å¤§å­¦ M&Dã‚¿ãƒ¯ãƒ¼ æƒ…å ±æ¤œç´¢å®¤1
</div>

```{r setup-global, include=FALSE, code=readLines("setup.R")}
```

```{r setup-local, include=FALSE}
library(ggplot2)
library(tibble)
library(dplyr)
library(tidyr)
iris = tibble::as_tibble(iris)
anscombe = tibble::as_tibble(anscombe)
```


---
## å‰å‡¦ç†ã¯å¤§ãã2ã¤ã«åˆ†ã‘ã‚‰ã‚Œã‚‹

- **ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å¯¾è±¡ã¨ã™ã‚‹å‡¦ç†** (ğŸ‘ˆä»Šå›ã®ä¸»é¡Œ)
    - ä½¿ã„ãŸã„éƒ¨åˆ†ã ã‘æŠ½å‡º
    - ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ç‰¹å¾´ã‚’è¦ç´„
    - å¤§ãã„é †ã«ä¸¦ã¹æ›¿ãˆ
    - ç•°ãªã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã®çµåˆ
    - å¤‰å½¢: ç¸¦é•· â†” æ¨ªåºƒ
- ãƒ‡ãƒ¼ã‚¿å†…å®¹ã‚’å¯¾è±¡ã¨ã™ã‚‹å‡¦ç† (<a href="3-content.html">æ¬¡å›ã®ä¸»é¡Œ</a>)
    - æ•°å€¤ã‚’å¤‰æ›ã™ã‚‹ (e.g., å¯¾æ•°ã€åº§æ¨™ç³»)
    - å¤‰æ›: é€£ç¶šå¤‰æ•° â†” ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ«å¤‰æ•° â†” ãƒ€ãƒŸãƒ¼å¤‰æ•°
    - æ¬ æå€¤ `NA` ã«å¯¾å‡¦
    - æ–‡å­—åˆ—ã‹ã‚‰æ•°å€¤ã‚„æ—¥æ™‚ã‚’æŠœãå‡ºã™

---
## tidyverseã«ä¾¿åˆ©ãªé“å…·ãŒæƒã£ã¦ã‚‹

<a href="https://www.tidyverse.org/">
<img src="/slides/image/rstats/hex-badges.png" width="260" align="right">
</a>

Rã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ‰‹ã«æ‰±ã†ãŸã‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç¾¤

```{r tidyverse, eval=FALSE}
install.packages("tidyverse")
library(tidyverse)
# core packages are loaded
```

- çµ±ä¸€çš„ãªä½¿ã„å‹æ‰‹
- ã‚·ãƒ³ãƒ—ãƒ«ãªé–¢æ•°ã‚’ç¹‹ã’ã¦ä½¿ã†ãƒ‡ã‚¶ã‚¤ãƒ³

<figure>
<a href="https://r4ds.had.co.nz/introduction.html">
<img src="/slides/image/r4ds/data-science.png">
<figcaption class="url">https://r4ds.had.co.nz/introduction.html</figcaption>
</a>
</figure>

data.frameå‡¦ç†ã«ä½¿ã†ã®ã¯ä¸»ã« [dplyr](/rstats/dplyr.html) ã¨ [tidyr](/rstats/tidyr.html)

---
## dplyr --- data.frameã®é«˜é€Ÿå‡¦ç†æ‹…å½“

<a href="https://dplyr.tidyverse.org/">
<img src="/slides/image/hex-stickers/dplyr.png" width="120" align="right">
</a>

ã‚·ãƒ³ãƒ—ãƒ«ãªé–¢æ•°ãŒãŸãã•ã‚“ã€‚ç¹‹ã’ã¦ä½¿ã† (piping)

æŠ½å‡º
: åˆ—: `select()`,
: è¡Œ: `filter()`, `distinct()`, `sample_n()`

è¦ç´„ãƒ»é›†è¨ˆ
: `group_by()`, `summarize()`, `count()`

ã‚½ãƒ¼ãƒˆ
: `arrange()`

çµåˆ
: è¡Œæ–¹å‘: `bind_rows()`
: åˆ—æ–¹å‘: `left_join()`, `inner_join()`, `full_join()`

åˆ—ã®è¿½åŠ ãƒ»å¤‰æ›´
: `mutate()`, `rename()`


---
## dplyr ä½¿ç”¨ä¾‹

å°ã•ãªé–¢æ•°ã‚’ç¹‹ã’ã¦ä½¿ã†æµã‚Œä½œæ¥­:
```{r dplyr}
result = diamonds %>%              # ç”Ÿãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‡ºç™ºã—ã¦
  select(carat, cut, price) %>%    # åˆ—ã‚’æŠ½å‡ºã—ã¦
  filter(carat > 2) %>%            # è¡Œã‚’æŠ½å‡ºã—ã¦
  group_by(cut) %>%                # ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦
  summarize_all(mean) %>%          # ãã‚Œãã‚Œå¹³å‡ã‚’è¨ˆç®—
  print()                          # è¡¨ç¤ºã—ã¦ã¿ã‚‹
```

ã“ã®è¦‹æ…£ã‚Œã¬è¨˜å· `%>%` ã¯ä½•ï¼Ÿ

---
## Pipe operator (ãƒ‘ã‚¤ãƒ—æ¼”ç®—å­) `%>%`

ãƒ‘ã‚¤ãƒ—ã®å·¦å´ã®å¤‰æ•°ã‚’ã€å³å´ã®é–¢æ•°ã®ç¬¬ä¸€å¼•æ•°ã«ã­ã˜è¾¼ã‚€:
```r
diamonds %>% filter(carat > 2)
filter(diamonds, carat > 2)     # ã“ã‚Œã¨åŒã˜

# å‰å‡¦ç†ã®æµã‚Œä½œæ¥­ã«ä¾¿åˆ©:
diamonds %>% select(carat, price) %>% filter(carat > 2) %>% ...
#   data %>%  do_A()  %>%  do_B()  %>%  do_C()  %>% ...
```

[å•] ãƒ‘ã‚¤ãƒ—ã‚’ä½¿ã‚ãªã„å½¢ã«æ›¸ãæ›ãˆã‚ˆã†:
```{r letters}
seq_len(6) %>% sum()
letters %>% toupper() %>% head(3)
```

[è§£ç­”ä¾‹]
```r
sum(seq_len(6))
head(toupper(letters), 3)
```

---
## ãƒ‘ã‚¤ãƒ—æ¼”ç®—å­ `%>%` ã‚’ä½¿ã‚ãªã„æ–¹æ³•

ğŸ˜ ä¸€æ™‚å¤‰æ•°ã‚’ä½¿ã£ã¦:
```{r pipe-tmp-var}
tmp1 = select(diamonds, carat, cut, price)   # åˆ—ã‚’æŠ½å‡ºã—ã¦
tmp2 = filter(tmp1, carat > 2)               # è¡Œã‚’æŠ½å‡ºã—ã¦
tmp3 = group_by(tmp2, cut)                   # ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦
result = summarize_all(tmp3, mean)           # ãã‚Œãã‚Œå¹³å‡ã‚’è¨ˆç®—
```

ğŸ˜ ã‚‚ã—ãã¯å…¨éƒ¨åŒã˜åå‰ã§:
```{r pipe-recursive-assign}
result = select(diamonds, carat, cut, price) # åˆ—ã‚’æŠ½å‡ºã—ã¦
result = filter(result, carat > 2)           # è¡Œã‚’æŠ½å‡ºã—ã¦
result = group_by(result, cut)               # ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦
result = summarize_all(result, mean)         # ãã‚Œãã‚Œå¹³å‡ã‚’è¨ˆç®—
```

ã©ã¡ã‚‰ã‚‚æ‚ªããªã„ã€‚
ä½•åº¦ã‚‚å¤‰æ•°åã‚’å…¥åŠ›ã™ã‚‹ã®ãŒã‚„ã‚„å†—é•·ã€‚


---
## ãƒ‘ã‚¤ãƒ—æ¼”ç®—å­ `%>%` ã‚’ä½¿ã‚ãªã„æ–¹æ³•

ğŸ˜« ä¸€æ™‚å¤‰æ•°ã‚’ä½¿ã‚ãšã«:
```{r pipe-nest}
result = summarize_all(                # ãã‚Œãã‚Œå¹³å‡ã‚’è¨ˆç®—
    group_by(                            # ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦
      filter(                              # è¡Œã‚’æŠ½å‡ºã—ã¦
        select(diamonds, carat, cut, price), # åˆ—ã‚’æŠ½å‡ºã—ã¦
        carat > 2),                        # è¡Œã‚’æŠ½å‡ºã—ã¦
      cut),                              # ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦
    mean)                              # ãã‚Œãã‚Œå¹³å‡ã‚’è¨ˆç®—
```

ğŸ¤ª æ”¹è¡Œã•ãˆã›ãšã«:
```{r pipe-oneliner}
result = summarize_all(group_by(filter(select(diamonds, carat, cut, price), carat > 2), cut), mean)
```

è«–ç†ã®æµã‚Œã¨ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®æµã‚ŒãŒåˆã‚ãšã€ç›®ãŒè¡Œã£ãŸã‚Šæ¥ãŸã‚Šã€‚<br>
ã•ã£ãã®ã»ã†ãŒãœã‚“ãœã‚“ãƒã‚·ã€‚

---
## ãƒ‘ã‚¤ãƒ—æ¼”ç®—å­ `%>%` ã‚’ä½¿ãŠã†

ğŸ˜ æ…£ã‚Œã‚Œã°ã€è«–ç†ã®æµã‚Œã‚’è¿½ã„ã‚„ã™ã„:
```{r eg-pipe}
result = diamonds %>%
  select(carat, cut, price) %>%    # åˆ—ã‚’æŠ½å‡ºã—ã¦
  filter(carat > 2) %>%            # è¡Œã‚’æŠ½å‡ºã—ã¦
  group_by(cut) %>%                # ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦
  summarize_all(mean) %>%          # ãã‚Œãã‚Œå¹³å‡ã‚’è¨ˆç®—
  print()                          # è¡¨ç¤ºã—ã¦ã¿ã‚‹
```

æ…£ã‚Œã‚‹ã¾ã§ã¯ã¡ã‚‡ã£ã¨å¤§å¤‰ã‹ã‚‚ã€‚
ç„¡ç†ã—ã¦ä½¿ã‚ãªãã¦ã‚‚å¤§ä¸ˆå¤«ã€‚


---
## dplyrã‚’ä½¿ã£ã¦ã¿ã‚‹æº–å‚™

ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚“ã§ã€ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã¦ã¿ã‚‹
```r
# install.packages("tidyverse")
library(tidyverse)
print(diamonds)
View(diamonds)  # RStudio
```

```{r dplyr-diamonds, echo=FALSE}
print(diamonds)
```

---
## åˆ—ã®æŠ½å‡º: `select()`

**åˆ—ã®ç•ªå·**ã§æŒ‡å®š:
```{r select-number}
result = diamonds %>%
  select(1, 2, 7) %>%
  print()
```

åˆ¥è§£: `diamonds[, c(1, 2, 7)]`


---
## åˆ—ã®æŠ½å‡º: `select()`

**åˆ—ã®åå‰**ã§æŒ‡å®š:
```{r select-name}
result = diamonds %>%
  select(carat, cut, price) %>%
  print()
```

åˆ¥è§£: `diamonds[, c("carat", "cut", "price")]`


---
## åˆ—ã®æŠ½å‡º: `select()`

**æ¨ã¦ã‚‹åˆ—**ã‚’ãƒã‚¤ãƒŠã‚¹æŒ‡å®š:
```{r select-negative}
result = diamonds %>%
  select(-carat, -cut, -price) %>%
  print()
```

---
## åˆ—ã®æŠ½å‡º: `select()`

åå‰ã®**éƒ¨åˆ†ä¸€è‡´**ã§æŒ‡å®š:
```{r select-matches}
result = diamonds %>%
  select(starts_with("c")) %>%
  print()
```

See [tidyselect helpers](https://tidyselect.r-lib.org/reference/select_helpers.html) for more details.


---
## è¡Œã®æŠ½å‡º: `filter()`

ç­‰å· `==` ã§**å®Œå…¨ä¸€è‡´ã™ã‚‹è¡Œ**ã®ã¿æ®‹ã™:
```{r filter-exact}
result = diamonds %>%
  filter(cut == "Ideal") %>%
  print()
```

åˆ¥è§£: `diamonds[diamonds[["cut"]] == "Ideal", ]`


---
## è¡Œã®æŠ½å‡º: `filter()`

ä¸ç­‰å·ã§**ä¸€è‡´ã—ãªã„è¡Œ**ã®ã¿æ®‹ã™:
```{r filter-unequal}
result = diamonds %>%
  filter(price >= 1000) %>%
  print()
```

ä¸ç­‰å·: `!=`, `<`, `<=`, `>`, `>=`

---
## è¡Œã®æŠ½å‡º: `filter()`

è¤‡æ•°ã®å€¤ã®ã†ã¡**ã©ã‚Œã‹ã«ä¸€è‡´ã™ã‚‹è¡Œ**ã®ã¿æ®‹ã™:
```{r filter-in}
result = diamonds %>%
  filter(cut %in% c("Ideal", "Good")) %>%
  print()
```

---
## è¡Œã®æŠ½å‡º: `filter()`

2ã¤ã®æ¡ä»¶ã‚’**ä¸¡æ–¹æº€ãŸã™è¡Œ**ã®ã¿æ®‹ã™ (AND):
```{r filter-and}
result = diamonds %>%
  filter(carat > 2 & price < 14000) %>%
  print()
```

---
## è¡Œã®æŠ½å‡º: `filter()`

2ã¤ã®æ¡ä»¶ã®**ã„ãšã‚Œã‹ã‚’æº€ãŸã™è¡Œ**ã®ã¿æ®‹ã™ (OR):
```{r filter-or}
result = diamonds %>%
  filter(carat > 2 | price < 14000) %>%
  print()
```

---
## é‡è¤‡è¡Œã®é™¤å»: `distinct()`

æŒ‡å®šã—ãŸåˆ—ã«é–¢ã—ã¦ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè¡Œã®ã¿æ®‹ã™:
```{r distinct}
result = diamonds %>%
  distinct(cut, color) %>%
  print()
```

`.keep_all = TRUE`
ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹ã¨æŒ‡å®šã—ãªã‹ã£ãŸåˆ—ã‚‚æ®‹ã›ã‚‹ã€‚

---
## å€¤ã«ã‚ˆã‚‰ãšè¡Œã®æŠ½å‡º: `sample_n()`

**è¡Œæ•°ã‚’æŒ‡å®š**ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚µãƒ³ãƒ—ãƒ«:
```{r sample_n}
result = diamonds %>%
  sample_n(42L, replace = FALSE) %>%
  print()
```

è¡Œæ•°ã§ã¯ãªã**å‰²åˆã‚’æŒ‡å®š**ã™ã‚‹ãªã‚‰ `sample_frac()`


---
## è¦ç´„ãƒ»é›†è¨ˆ: `summarize()`

åˆ—ã®**åˆè¨ˆã€å¹³å‡ã€æœ€å¤§**ãªã©ã‚’æ±‚ã‚ã‚‹:
```{r summarize}
result = diamonds %>%
  summarize(sum(carat), mean(carat), max(price)) %>%
  print()
```

vectorã‚’å—ã‘å–ã£ã¦1ã¤ã®å€¤ã‚’è¿”ã™é›†ç´„é–¢æ•°:<br>
`min()`, `max()`, `mean()`, `median()`, `var()`, `sd()`, etc.


---
## è¦ç´„ãƒ»é›†è¨ˆ: `summarize()`

åˆ—ã®å€¤ã‚’**ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«**é›†è¨ˆã™ã‚‹:
```{r group_by}
result = diamonds %>%
  group_by(cut) %>%
  summarize(avg_carat = mean(carat),
            max_price = max(price)) %>%
  print()
```

---
## è¦ç´„ãƒ»é›†è¨ˆ: `count()`

æŒ‡å®šã—ãŸåˆ—ã®çµ„ã¿åˆã‚ã›å‡ºç¾æ•°ã‚’æ•°ãˆã‚‹:
```{r count}
result = diamonds %>%
  count(cut, color) %>%
  print()
```

`diamonds %>% group_by(cut, color) %>% tally()` ã¨åŒã˜ã€‚


---
## è¡Œã®ã‚½ãƒ¼ãƒˆ: `arrange()`

æŒ‡å®šã—ãŸåˆ—ã®å€¤ãŒ**å°ã•ã„é †ã«ä¸Šã‹ã‚‰**ä¸¦ã¹ã‚‹:
```{r arrange}
result = diamonds %>%
  arrange(color, desc(carat)) %>%  # è‰²ã®æ˜‡é †ã€‚è‰²ãŒåŒã˜ãªã‚‰å¤§ãã•é™é †
  print()
```

é€†ã«ã™ã‚‹ã«ã¯ `desc()` ã‚’ä½¿ã†ã€‚


---
## è¡Œã®çµåˆ: `bind_rows()`

ä¾‹ã€‚å…ˆé ­ã¨æœ«å°¾ã‚’6è¡Œãšã¤å–ã£ã¦ã²ã¨ã¤ã®è¡¨ã«çµåˆã™ã‚‹:
```{r bind_rows}
bind_rows(head(diamonds), tail(diamonds))
```


---
## å…±é€šã™ã‚‹åˆ—ã§çµåˆ: `full_join()`

ä»–æ–¹ã«ç„¡ã„éƒ¨åˆ†ã‚’ `NA` ã§è£œå®Œã—ã¦**å·¦å³ã¨ã‚‚å…¨è¡Œ**ä¿æŒ:
```{r full_join}
full_join(band_members, band_instruments, by = "name")
```
```
band_members          band_instruments
   name    band          name  plays
  <chr>   <chr>         <chr>  <chr>
1  Mick  Stones       1  John guitar
2  John Beatles       2  Paul   bass
3  Paul Beatles       3 Keith guitar
```

---
## å…±é€šã™ã‚‹åˆ—ã§çµåˆ: `left_join()`

å³å´ã«ç„¡ã„éƒ¨åˆ†ã‚’ `NA` ã§è£œå®Œã—ã¦**å·¦å´ã ã‘å…¨è¡Œ**ä¿æŒ:
```{r left_join}
left_join(band_members, band_instruments, by = "name")
```
```
band_members          band_instruments
   name    band          name  plays
  <chr>   <chr>         <chr>  <chr>
1  Mick  Stones       1  John guitar
2  John Beatles       2  Paul   bass
3  Paul Beatles       3 Keith guitar
```

ãã®é€†ã¯ `right_join()`

---
## å…±é€šã™ã‚‹åˆ—ã§çµåˆ: `inner_join()`

å·¦å³ã¨ã‚‚ã«**å…±é€šã™ã‚‹å€¤ã®ã‚ã‚‹è¡Œã ã‘**ä¿æŒ:
```{r inner_join}
inner_join(band_members, band_instruments, by = "name")
```
```
band_members          band_instruments
   name    band          name  plays
  <chr>   <chr>         <chr>  <chr>
1  Mick  Stones       1  John guitar
2  John Beatles       2  Paul   bass
3  Paul Beatles       3 Keith guitar
```

---
## joinã¾ã¨ã‚

<figure>
<a href="https://r4ds.had.co.nz/relational-data.html#mutating-joins">
<img src="/slides/image/r4ds/join.png" height="550">
<br>
<figcaption class="url">https://r4ds.had.co.nz/relational-data.html#mutating-joins</figcaption>
</a>
</figure>


---
## joinä¾‹é¡Œ: `nycflights13` ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ

é–¢é€£ã™ã‚‹data.frameã‚’ã„ã‚ã„ã‚ãªæ–¹æ³•ã§çµåˆã—ã¦ã¿ã‚ˆã†ã€‚

```r
install.packages("nycflights13")
library(nycflights13)
data(package = "nycflights13")
# airlines, airports, flights, planes, weather
```

<figure>
<a href="https://r4ds.had.co.nz/relational-data.html#nycflights13-relational">
<img src="/slides/image/r4ds/relational-nycflights.png" height="320">
<br>
<figcaption class="url">https://r4ds.had.co.nz/relational-data.html#nycflights13-relational</figcaption>
</a>
</figure>


---
## æ–°ã—ã„åˆ—ã®è¿½åŠ : `mutate()`

æ—¢å­˜ã®åˆ—åã‚’æŒ‡å®šã™ã‚‹ã¨ä¸Šæ›¸ã:
```{r mutate}
result = diamonds %>%
  mutate(ratio = price / carat,
         price = price * 108.36) %>%
  print()
```


---
## tidyr --- data.frameã®å¤‰å½¢ãƒ»æ•´å½¢æ‹…å½“

<a href="https://tidyr.tidyverse.org/">
<img src="/slides/image/hex-stickers/tidyr.png" width="120" align="right">
</a>

æ¨ªé•·ã‹ã‚‰ç¸¦é•·ã«
: `pivot_longer()`

ç¸¦é•·ã‹ã‚‰æ¨ªé•·ã«
: `pivot_wider()`

å…¥ã‚Œå­æ§‹é€ ã‚’ã¤ãã‚‹ã€è§£æ¶ˆã™ã‚‹
: `nest()`, `unnest()`

1åˆ—ã‚’è¤‡æ•°ã®åˆ—ã«åˆ†é›¢
: `separate()`

*etc.*


---
## `tidyr::pivot_longer()` æ¨ªé•·ã‹ã‚‰ç¸¦é•·ã«

è¤‡æ•°åˆ—ã«ã¾ãŸãŒã‚‹å€¤ã‚’1åˆ—ã«ã™ã‚‹ã€‚<br>
ãã®ãƒ©ãƒ™ãƒ«ã‚‚åˆã‚ã›ã¦ç§»å‹•ã€‚

<figure>
<a href="https://r4ds.had.co.nz/tidy-data.html#gathering">
<img src="/slides/image/r4ds/tidy-gather.png" width="800">
<br>
<figcaption class="url">https://r4ds.had.co.nz/tidy-data.html#gathering</figcaption>
</a>
</figure>

---
## `tidyr::pivot_longer()` æ¨ªé•·ã‹ã‚‰ç¸¦é•·ã«

è¤‡æ•°åˆ—ã«ã¾ãŸãŒã‚‹å€¤ã‚’1åˆ—ã«ã™ã‚‹(ã“ã“ã§ã¯`value`)ã€‚<br>
ãã®ãƒ©ãƒ™ãƒ«ã‚‚åˆã‚ã›ã¦ç§»å‹•(ã“ã“ã§ã¯`name`)ã€‚

```{r pivot_longer}
iris_long = iris %>% head(2L) %>%     # æœ€åˆã®2è¡Œã ã‘
  rownames_to_column("id") %>%        # IDåˆ—ã‚’è¿½åŠ 
  print() %>%                         # é€”ä¸­çµŒéã‚’è¡¨ç¤º
  pivot_longer(c(-id, -Species), names_to = "name", values_to = "value") %>%
  print()                             # id, Speciesä»¥å¤–ã®å€¤ã‚’ç§»å‹•
```


---
## `tidyr::pivot_wider()` ç¸¦é•·ã‹ã‚‰æ¨ªé•·ã«

1åˆ—ã«åã¾ã£ã¦ã„ãŸå€¤ã‚’è¤‡æ•°åˆ—ã®è¡Œåˆ—ã«å¤‰æ›ã€‚<br>
ãã®ãƒ©ãƒ™ãƒ«ã‚’åˆ—ã®åå‰ã«ã™ã‚‹ã€‚

<figure>
<a href="https://r4ds.had.co.nz/tidy-data.html#spreading">
<img src="/slides/image/r4ds/tidy-spread.png" height="480">
<br>
<figcaption class="url">https://r4ds.had.co.nz/tidy-data.html#spreading</figcaption>
</a>
</figure>

---
## `tidyr::pivot_wider()` ç¸¦é•·ã‹ã‚‰æ¨ªé•·ã«

1åˆ—ã«åã¾ã£ã¦ã„ãŸå€¤(`value`)ã‚’è¤‡æ•°åˆ—ã®è¡Œåˆ—ã«å¤‰æ›ã€‚<br>
ãã®ãƒ©ãƒ™ãƒ«(`name`)ã‚’åˆ—ã®åå‰ã«ã™ã‚‹ã€‚

```{r spread}
iris_long %>% print() %>%              # ã•ã£ãlong-formatã«ã—ãŸã‚„ã¤
  pivot_wider(names_from = name, values_from = value)   # æ¨ªé•·ã«æˆ»ã™
```

---
## `tidyr::separate()` åˆ—ã‚’åˆ†é›¢

<figure>
<a href="https://r4ds.had.co.nz/tidy-data.html#separate">
<img src="/slides/image/r4ds/tidy-separate.png" width="800">
<br>
<figcaption class="url">https://r4ds.had.co.nz/tidy-data.html#separate</figcaption>
</a>
</figure>

---
## `tidyr::separate()` åˆ—ã‚’åˆ†é›¢

```{r separate}
iris_long %>% print() %>%
  separate(name, c("part", "measure")) # åˆ—ã‚’åˆ†é›¢
```

---
## `tidyr::unite()` åˆ—ã‚’èåˆ

<figure>
<a href="https://r4ds.had.co.nz/tidy-data.html#unite">
<img src="/slides/image/r4ds/tidy-unite.png" width="800">
<br>
<figcaption class="url">https://r4ds.had.co.nz/tidy-data.html#unite</figcaption>
</a>
</figure>

---
## `tidyr::nest()` å…¥ã‚Œå­ã«ã™ã‚‹

ã‚°ãƒ«ãƒ¼ãƒ—æ¯ã«data.frameã‚’åŒºåˆ‡ã£ã¦listå‹ã®åˆ—ã«å…¥ã‚Œã‚‹ã€‚

<figure>
<a href="https://www.tidyverse.org/articles/2019/09/tidyr-1-0-0/">
<img src="/slides/image/rstats/nest-pack-chop.png" height="500">
<br>
<figcaption class="url">https://www.tidyverse.org/articles/2019/09/tidyr-1-0-0/</figcaption>
</a>
</figure>

---
## `tidyr::nest()` å…¥ã‚Œå­ã«ã™ã‚‹

ã‚°ãƒ«ãƒ¼ãƒ—æ¯ã«data.frameã‚’åŒºåˆ‡ã£ã¦listå‹ã®åˆ—ã«å…¥ã‚Œã‚‹ã€‚

```{r nest}
iris_nested = iris %>%
  as_tibble() %>%
  nest(data = -Species) %>% print()
iris_nested$data[[1L]]
```

---
## ä¾‹é¡Œ1: `VADeaths` ã‚’ç¸¦é•·ã«ã—ãŸã„

```{r vadeaths_df, results="hold"}
as.data.frame(VADeaths)                  # data.frameã«å¤‰æ›
                                         # è¡Œåã‚’åˆ—ã«
                                         # ç¸¦é•·ã«å¤‰å½¢ã—ãŸã„
```

---
## ä¾‹é¡Œ1: `VADeaths` ã‚’ç¸¦é•·ã«ã—ãŸã„

```{r vadeaths_rownames, results="hold"}
as.data.frame(VADeaths) %>%              # data.frameã«å¤‰æ›
  tibble::rownames_to_column("age")      # è¡Œåã‚’åˆ—ã«
                                         # ç¸¦é•·ã«å¤‰å½¢ã—ãŸã„
```

---
## ä¾‹é¡Œ1: `VADeaths` ã‚’ç¸¦é•·ã«ã—ãŸã„

```{r vadeaths_longer, results="hold"}
as.data.frame(VADeaths) %>%              # data.frameã«å¤‰æ›
  tibble::rownames_to_column("age") %>%  # è¡Œåã‚’åˆ—ã«
  pivot_longer(-age)                     # ageä»¥å¤–ã‚’ç§»å‹•ã—ã¦ç¸¦é•·åŒ–
                                         # æ–°ã—ã„nameåˆ—ã‚’åˆ†å‰²
```

---
## ä¾‹é¡Œ1: `VADeaths` ã‚’ç¸¦é•·ã«ã—ãŸã„

```{r vadeaths_region_sex, results="hold"}
as.data.frame(VADeaths) %>%              # data.frameã«å¤‰æ›
  tibble::rownames_to_column("age") %>%  # è¡Œåã‚’åˆ—ã«
  pivot_longer(-age) %>%                 # ageä»¥å¤–ã‚’ç§»å‹•ã—ã¦ç¸¦é•·åŒ–
  separate(name, c("region", "sex"))     # æ–°ã—ã„nameåˆ—ã‚’åˆ†å‰²
```

---
## ä¾‹é¡Œ1: `VADeaths` ã‚’ç¸¦é•·ã«ã—ãŸã„

```{r vadeaths_age, results="hold"}
va_deaths = as.data.frame(VADeaths) %>%  # data.frameã«å¤‰æ›
  tibble::rownames_to_column("age") %>%  # è¡Œåã‚’åˆ—ã«
  pivot_longer(-age) %>%                 # ageä»¥å¤–ã‚’ç§»å‹•ã—ã¦ç¸¦é•·åŒ–
  separate(name, c("region", "sex")) %>% # æ–°ã—ã„nameåˆ—ã‚’åˆ†å‰²
  separate(age, c("lbound", "ubound"), "-", convert = TRUE) %>%
  print()                                # ä¸‹é™ã¨ä¸Šé™ã‚’åˆ†é›¢
```

---
## ä¾‹é¡Œ1: `VADeaths` åˆ¥è§£

```{r vadeaths_pivot, results="hold"}
va_deaths = as.data.frame(VADeaths) %>%  # data.frameã«å¤‰æ›
  tibble::rownames_to_column("age") %>%  # è¡Œåã‚’åˆ—ã«
  tidyr::pivot_longer(                   # ç¸¦é•·ã«å¤‰å½¢ã—ãŸã„
    -age,                                # ageä»¥å¤–ã®åˆ—ã«å…¥ã£ã¦ã‚‹å€¤ã‚’ç§»å‹•
    names_to = c("region", "sex"),       # å…ƒã®åˆ—åã‚’2ã¤ã«åˆ†é›¢
    names_sep = " ",                     # ã‚¹ãƒšãƒ¼ã‚¹ã§åˆ‡ã‚‹
    values_to = "death") %>%             # å€¤ã®è¡Œãå…ˆã®åˆ—å
  tidyr::separate(age, c("lbound", "ubound"), "-", convert = TRUE) %>%
  print()                                # ä¸‹é™ã¨ä¸Šé™ã‚’åˆ†é›¢
```

---
## ä¾‹é¡Œ1: `VADeaths` ä½œå›³ä¾‹

```{r vadeaths_plot, fig.height = 5, fig.width = 10}
va_deaths %>%
  ggplot(aes(lbound, death)) +
  geom_point(aes(color = sex, shape = region), size = 5) +
  theme_classic(base_size = 16)
```

---
## ä¾‹é¡Œ2: `anscombe`

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r anscombe, results="hold"}
anscombe %>%
  rowid_to_column("id")              # IDã‚’ã¤ã‘ã¦ãŠã
                                     # x y ã§å§‹ã¾ã‚‹åˆ—ã®å€¤ã‚’ç§»ã—ã¦ç¸¦é•·ã«
```

ggplot does not accept this format. Let's transformt it.


---
## ä¾‹é¡Œ2: `anscombe`

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r anscombe_longer, results="hold"}
anscombe %>%
  rowid_to_column("id") %>%          # IDã‚’ã¤ã‘ã¦ãŠã
  pivot_longer(matches("^x|y"))      # x y ã§å§‹ã¾ã‚‹åˆ—ã®å€¤ã‚’ç§»ã—ã¦ç¸¦é•·ã«

                                     # nameåˆ—ã‚’åˆ†å‰²
```

---
## ä¾‹é¡Œ2: `anscombe`

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r anscombe_separate, results="hold"}
anscombe %>%
  rowid_to_column("id") %>%          # IDã‚’ã¤ã‘ã¦ãŠã
  pivot_longer(matches("^x|y")) %>%  # x y ã§å§‹ã¾ã‚‹åˆ—ã®å€¤ã‚’ç§»ã—ã¦ç¸¦é•·ã«
  separate(name, c("axis", "group"), 1L, convert = TRUE)
                                     # nameåˆ—ã‚’åˆ†å‰²
```

---
## ä¾‹é¡Œ2: `anscombe`

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r anscombe_wider, results="hold"}
tidy_anscombe = anscombe %>%
  rowid_to_column("id") %>%          # IDã‚’ã¤ã‘ã¦ãŠã
  pivot_longer(matches("^x|y")) %>%  # x y ã§å§‹ã¾ã‚‹åˆ—ã®å€¤ã‚’ç§»ã—ã¦ç¸¦é•·ã«
  separate(name, c("axis", "group"), 1L, convert = TRUE) %>%
                                     # nameåˆ—ã‚’åˆ†å‰²
  pivot_wider(names_from = axis, values_from = value) %>%
                                     # axisåˆ—å†…ã® x y ã‚’åˆ—ã«ã—ã¦æ¨ªé•·åŒ–
  dplyr::arrange(group) %>%          # ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ä¸¦ã¹ã‚‹
  print()                            # ggplotã—ãŸã„å½¢ï¼
```

---
## ä¾‹é¡Œ2: `anscombe` åˆ¥è§£

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r anscombe_pivot}
tidy_anscombe = anscombe %>%
  tidyr::pivot_longer(                # ç¸¦é•·ã«å¤‰å½¢ã—ãŸã„
    everything(),                     # ã™ã¹ã¦ã®åˆ—ã«ã¤ã„ã¦
    names_to = c(".value", "group"),  # æ–°ã—ã„åˆ—å
    names_sep = 1L) %>%               # åˆ‡ã‚‹ä½ç½®
  dplyr::mutate(group = as.integer(group)) %>% # å‹å¤‰æ›
  dplyr::arrange(group) %>%           # ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ä¸¦ã¹ã‚‹
  print()                             # ggplotã—ãŸã„å½¢ï¼
```


---
## ä¾‹é¡Œ2: `anscombe` ä½œå›³ä¾‹

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r plot_anscombe, fig.height=3, fig.width=10, out.width="98%"}
ggplot(tidy_anscombe, aes(x, y)) +
  geom_point(size = 3) +
  stat_smooth(method = lm, formula = y ~ x, se = FALSE, fullrange = TRUE) +
  facet_wrap(~ group, nrow = 1L)
```

---
## ä¾‹é¡Œ2: `anscombe` è¦ç´„

4çµ„ã®x-yã¯ã€å¹³å‡ãƒ»åˆ†æ•£ãƒ»ç›¸é–¢ä¿‚æ•°ãŒã»ã¼åŒã˜ï¼Ÿ

```{r summarize_anscombe}
tidy_anscombe %>%
  dplyr::group_by(group) %>%   # groupåˆ—ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦
  dplyr::summarize(            # x, yåˆ—ã‚’ä½¿ã£ã¦summarize
    mean_x = mean(x),
    mean_y = mean(y),
    sd_x = sd(x),
    sd_y = sd(y),
    cor_xy = cor(x, y)
  )
```


---
## Reference

R for Data Science --- Hadley Wickham & Garrett Grolemund
: [Website](https://r4ds.had.co.nz/), [Book](https://amzn.to/2tbRmVc)
: [æ—¥æœ¬èªç‰ˆæ›¸ç±(Rã§ã¯ã˜ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ã‚¹)](https://amzn.to/2yyFRKt)

[Rãƒ¦ãƒ¼ã‚¶ã®ãŸã‚ã®RStudio[å®Ÿè·µ]å…¥é–€](https://amzn.to/2Q8GlhE) --- æ¾æ‘å„ªå“‰ã»ã‹<br>
[å‰å‡¦ç†å¤§å…¨](https://amzn.to/2PFe4jF) --- æœ¬æ©‹æ™ºå…‰

éå»ã®è¬›ç¾©è³‡æ–™
: ã€Œ[Rã«ã‚„ã‚‰ã›ã¦æ¥½ã—ã‚ˆã† â€” ãƒ‡ãƒ¼ã‚¿ã®å¯è¦–åŒ–ã¨ä¸‹ã”ã—ã‚‰ãˆ](https://heavywatal.github.io/slides/nagoya2018/)ã€
   å²©åµœèˆª 2018
: ã€ŒRã‚’ç”¨ã„ãŸãƒ‡ãƒ¼ã‚¿è§£æã®åŸºç¤ã¨å¿œç”¨ã€çŸ³å·ç”±å¸Œ 2019 åå¤å±‹å¤§å­¦
: ã€Œ[Hands-on R Lecture for Makino Lab](https://heavywatal.github.io/slides/makino2019r/)ã€
   å²©åµœèˆª 2019 æ±åŒ—å¤§å­¦

Official documents:
: [tidyverse](https://www.tidyverse.org/),
  [ggplot2](https://ggplot2.tidyverse.org/),
  [dplyr](https://dplyr.tidyverse.org/),
  [tidyr](https://tidyr.tidyverse.org/),
  [purrr](https://purrr.tidyverse.org/),
  [tibble](https://tibble.tidyverse.org/),
  [readr](https://readr.tidyverse.org/),
  [readxl](https://readxl.tidyverse.org/)

<a href="3-content.html" rel="next" class="readmore">
3. ãƒ‡ãƒ¼ã‚¿å†…å®¹ã®å‡¦ç†: æ•°å€¤ã€æ–‡å­—åˆ—ã€æ—¥æ™‚ãªã©
</a>
