+++
url = "tohoku2022r/5-content.html"
title = "5. ãƒ‡ãƒ¼ã‚¿å†…å®¹ã®å‡¦ç†: æ•°å€¤ã€æ–‡å­—åˆ—ã€æ—¥æ™‚ãªã© â€” é€²åŒ–å­¦å®Ÿç¿’ 2022 ç‰§é‡ç ”"
linktitle = "ãƒ‡ãƒ¼ã‚¿å†…å®¹ã®å‡¦ç†: æ•°å€¤ã€æ–‡å­—åˆ—ã€æ—¥æ™‚ãªã©ã€‚"
date = 2022-04-13T14:30:00+09:00
type = "reveal"
draft = false
+++

<link rel="stylesheet" href="style.css">

# [é€²åŒ–å­¦å®Ÿç¿’ 2022 ç‰§é‡ç ”](.)

### 5. ãƒ‡ãƒ¼ã‚¿å†…å®¹ã®å‡¦ç†: æ•°å€¤ã€æ–‡å­—åˆ—ã€æ—¥æ™‚ãªã©ã€‚

<div class="author">
å²©åµœèˆª
</div>

<div class="affiliation">
æ±åŒ—å¤§å­¦ ç”Ÿå‘½ç§‘å­¦ç ”ç©¶ç§‘ é€²åŒ–ã‚²ãƒãƒŸã‚¯ã‚¹åˆ†é‡ ç‰§é‡ç ”
</div>

<div class="footnote">
2022-04-11 æ±åŒ—å¤§å­¦ ç†å­¦éƒ¨ç”Ÿç‰©å­¦ç§‘ é€²åŒ–å­¦å®Ÿç¿’
<a href="https://heavywatal.github.io/slides/tohoku2022r/">https://heavywatal.github.io/slides/tohoku2022r/</a>
</div>

```{r setup-global, include=FALSE, code=readLines("setup.R")}
```

```{r setup-local, include=FALSE}
library(ggplot2)
library(tibble)
library(dplyr)
library(tidyr)
knitr::opts_chunk$set(cache = TRUE)
```

---
## å‰å›ã¾ã§ã®ã¾ã¨ã‚

### âœ… Rã®åŸºç¤

- èª¿ã¹æ–¹ã•ãˆã‚ã‹ã‚Œã°ã€å…¨éƒ¨è¦šãˆãªãã¦ã‚‚å¤§ä¸ˆå¤«
- ã‚¨ãƒ©ãƒ¼ã¯æ—¥å¸¸èŒ¶é£¯äº‹ã€‚è½ã¡ç€ã„ã¦èª­ã¿å–ã‚ã†
- ã¾ãš**Rã‚¹ã‚¯ãƒªãƒ—ãƒˆ**ã«æ›¸ã„ã¦ã‹ã‚‰ã€**ã‚³ãƒ³ã‚½ãƒ¼ãƒ«**ã§å®Ÿè¡Œ
- ä¾¿åˆ©ãª**ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸**ã‚’ä½¿ãŠã†

### âœ… ãƒ‡ãƒ¼ã‚¿è§£æå…¨ä½“ã®æµã‚Œã€‚å¯è¦–åŒ–ã ã„ã˜

### âœ… ä¸€è²«æ€§ã®ã‚ã‚‹æ–‡æ³•ã§åˆç†çš„ã«æã‘ã‚‹ggplot2

### âœ… ä½¿ãˆã‚‹æ•´ç„¶ãƒ‡ãƒ¼ã‚¿ã«ã™ã‚‹ãŸã‚ã®å‰å‡¦ç†ãŒãŸã„ã¸ã‚“

---
## ãƒ‡ãƒ¼ã‚¿è§£æã®ãŠãŠã¾ã‹ãªæµã‚Œ

1. ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ç’°å¢ƒã®æ•´å‚™
1. ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã€èª­ã¿è¾¼ã¿
1. æ¢ç´¢çš„ãƒ‡ãƒ¼ã‚¿è§£æ
    - **å‰å‡¦ç†ã€åŠ å·¥** (åœ°å‘³ã€‚æ„å¤–ã¨é‡ã„) ğŸ‘ˆ æœ¬å®Ÿç¿’ã®ä¸»é¡Œ
    - å¯è¦–åŒ–ã€ä»®èª¬ç”Ÿæˆ (æ´¾æ‰‹ï¼ã ã„ã˜ï¼)
    - çµ±è¨ˆè§£æã€ä»®èª¬æ¤œè¨¼ (ã¿ã‚“ãªå‹‰å¼·ã—ãŸãŒã‚‹)
1. å ±å‘Šã€ç™ºè¡¨

<figure>
<a href="https://r4ds.had.co.nz/introduction.html">
<img src="/slides/image/r4ds/data-science.png">
<figcaption class="url">https://r4ds.had.co.nz/introduction.html</figcaption>
</a>
</figure>

---
## å‰å‡¦ç†ã¯å¤§ãã2ã¤ã«åˆ†ã‘ã‚‰ã‚Œã‚‹

<div style="float: right;">
<a href="https://dplyr.tidyverse.org/">
<img src="/slides/image/hex-stickers/dplyr.png" width="120">
</a><br>
<a href="https://tidyr.tidyverse.org/">
<img src="/slides/image/hex-stickers/tidyr.png" width="120">
</a>
</div>

- ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å¯¾è±¡ã¨ã™ã‚‹å‡¦ç† --- ç¬¬3, 4å›
    - ä½¿ã„ãŸã„éƒ¨åˆ†ã ã‘æŠ½å‡º --- `select()`, `filter()`
    - ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ç‰¹å¾´ã‚’è¦ç´„ --- `group_by()`, `summarize()`
    - ä½•ã‹ã®é †ã«ä¸¦ã¹æ›¿ãˆ --- `arrange()`
    - ç•°ãªã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã®çµåˆ --- `*_join()`
    - å¤‰å½¢: ç¸¦é•· â†” æ¨ªåºƒ --- `pivot_longer()`, `pivot_wider()`
- **ãƒ‡ãƒ¼ã‚¿å†…å®¹ã‚’å¯¾è±¡ã¨ã™ã‚‹å‡¦ç†** ğŸ‘ˆ ç¬¬5å› æœ¬æ—¥ã®è©±é¡Œ
    - æ•°å€¤ã®å¤‰æ›: å¯¾æ•°ã€æ­£è¦åŒ–
    - å¤–ã‚Œå€¤ãƒ»æ¬ æå€¤ã¸ã®å¯¾å‡¦
    - å‹å¤‰æ›: é€£ç¶šå¤‰æ•°ã€ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ«å¤‰æ•°ã€æŒ‡ç¤ºå¤‰æ•°ã€å› å­ã€æ—¥æ™‚
    - æ–‡å­—åˆ—å‡¦ç†: æ­£è¦è¡¨ç¾ã«ã‚ˆã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒ

<cite style="display: block; text-align: right;"><a href="https://www.amazon.co.jp/dp/4774196479/ref=as_li_ss_tl?ie=UTF8&linkCode=ll1&tag=heavywatal-22&linkId=8a3fd4e9a0c944b1b41242bbab8d147b">
æœ¬æ©‹æ™ºå…‰ã€Œå‰å‡¦ç†å¤§å…¨ã€
</a></cite>

---
## tidyverse: ãƒ‡ãƒ¼ã‚¿ç§‘å­¦ã®ãŸã‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç¾¤

- çµ±ä¸€çš„ãªä½¿ã„å‹æ‰‹
- ã‚·ãƒ³ãƒ—ãƒ«ãªé–¢æ•°ã‚’ç¹‹ã’ã¦ä½¿ã†ãƒ‡ã‚¶ã‚¤ãƒ³

<a href="https://www.tidyverse.org/">
<img src="/slides/image/rstats/hex-badges8.png" width="320" align="right">
</a>

```r
# install.packages("tidyverse")
library(tidyverse)  # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸èª­ã¿è¾¼ã¿
```
```
â”€â”€ Attaching packages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tidyverse 1.3.1 â”€â”€
âœ” ggplot2 3.3.5     âœ” purrr   0.3.4
âœ” tibble  3.1.6     âœ” dplyr   1.0.7
âœ” tidyr   1.2.0     âœ” stringr 1.4.0
âœ” readr   2.1.2     âœ” forcats 0.5.1
â”€â”€ Conflicts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tidyverse_conflicts() â”€â”€
âœ– dplyr::filter() masks stats::filter()
âœ– dplyr::lag()    masks stats::lag()
```

ãŸã¾ã«ã¯æ›´æ–°ã—ã‚ˆã†:
```r
update.packages(ask = "no", type = "binary")
# ã„ã¡ã„ã¡ç¢ºèªã›ãšã«ãƒ“ãƒ«ãƒ‰æ¸ˆã¿å®‰å®šç‰ˆã‚’å…¥ã‚Œã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€‚ç„¡ãã¦ã‚‚ã€‚
```

---
## å¤‰æ•°/ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‹ (å¾©ç¿’)

- **`vector`: åŸºæœ¬å‹ã€‚ä¸€æ¬¡å…ƒã®é…åˆ—ã€‚** (ğŸ‘ˆä»Šå›ã®ä¸»å½¹)
    - `logical`: è«–ç†å€¤ (`TRUE` or `FALSE`)
    - `numeric`: æ•°å€¤ (æ•´æ•° `42L` or å®Ÿæ•° `3.1416`)
    - `character`: æ–‡å­—åˆ— (`"a string"`)
    - `factor`: å› å­ (æ–‡å­—åˆ—ã£ã½ã„ã‘ã©å¾®å¦™ã«é•ã†)
- `array`: å¤šæ¬¡å…ƒé…åˆ—ã€‚`vector`åŒæ§˜ã€å…¨è¦ç´ ãŒåŒã˜å‹ã€‚
    - `matrix`: è¡Œåˆ— = äºŒæ¬¡å…ƒã®é…åˆ—ã€‚
- `list`: ç•°ãªã‚‹å‹ã§ã‚‚è©°ã‚è¾¼ã‚ã‚‹å¤ªã£è…¹ãƒ™ã‚¯ãƒˆãƒ«ã€‚
- **`data.frame`: åŒã˜é•·ã•ã®ãƒ™ã‚¯ãƒˆãƒ«ã‚’ä¸¦ã¹ãŸé•·æ–¹å½¢ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã€‚é‡è¦ã€‚** <br>
  `tibble` ã¨ã‹ `tbl_df` ã¨å‘¼ã°ã‚Œã‚‹äºœç¨®ã‚‚ã‚ã‚‹ã‘ã©ã»ã¼åŒã˜ã€‚


---
## vector: ä¸€æ¬¡å…ƒã®é…åˆ— (å¾©ç¿’)

1å€‹ã®å€¤ã§ã‚‚ãƒ™ã‚¯ãƒˆãƒ«æ‰±ã„ã€‚<br>
ãƒ™ã‚¯ãƒˆãƒ«ã®å„è¦ç´ ã«ä¸€æ°—ã«è¨ˆç®—ã‚’é©ç”¨ã§ãã‚‹ã€‚

```{r vector}
x = c(1, 2, 9)  # é•·ã•3ã®æ•°å€¤ãƒ™ã‚¯ãƒˆãƒ«
x + x           # åŒã˜é•·ã•åŒå£«ã®è¨ˆç®—
y = 10          # é•·ã•1ã®æ•°å€¤ãƒ™ã‚¯ãƒˆãƒ«
x + y           # é•·ã•3 + é•·ã•1 = é•·ã•3 (ãã‚Œãã‚Œè¶³ã—ç®—)
sqrt(x)         # square root
```

---
## æ•°å€¤: numericå‹

æ™®é€šã¯å€ç²¾åº¦æµ®å‹•å°æ•°ç‚¹å‹ `double` ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹:

```{r numeric}
answer = 42
typeof(answer)
```

æ˜ç¤ºçš„ã«å¤‰æ›ã—ãŸã‚Šæœ«å°¾ã«Lã‚’ä»˜ã‘ã‚‹ã“ã¨ã§æ•´æ•°æ‰±ã„ã‚‚ã§ãã‚‹:

```{r integer}
typeof(as.integer(answer))
whoami = 24601L
typeof(whoami)
```

---
## æ§˜ã€…ãªæ•°å­¦é–¢æ•°

ãƒ™ã‚¯ãƒˆãƒ«ã‚’å—ã‘å–ã‚Šã€ãã‚Œãã‚Œã®è¦ç´ ã«é©ç”¨

```{r math}
x = c(1, 2, 3)
sqrt(x)
log(x)
log10(x)
exp(x)
```

<div style="text-align: right;"><a class="url" href="https://stat.ethz.ch/R-manual/R-patched/library/base/html/00Index.html">
https://stat.ethz.ch/R-manual/R-patched/library/base/html/00Index.html
</a></div>

---
## data.frameã¯åˆ—vectorã®é›†ã¾ã‚Š

å†…å®¹ã‚’å¤‰æ›´ã™ã‚‹æ–¹æ³•ã¯ã„ãã¤ã‹ã‚ã‚‹ã€‚<br>
`diamonds` ã® `price` åˆ—ã‚’ãƒ‰ãƒ«ã‹ã‚‰å††ã«å¤‰æ›ã™ã‚‹ä¾‹:

```{r dfcolumn}
dia = diamonds    # åˆ¥åã‚³ãƒ”ãƒ¼

# dollaræ¼”ç®—å­ $ ã§æŒ‡å®š
dia$price = 105.59 * dia$price

# åå‰ã‚’ [[æ–‡å­—åˆ—]] ã§æŒ‡å®š
dia[["price"]] = 105.59 * dia[["price"]]

# dplyr::mutate with pipe
dia = diamonds %>%
  mutate(price = 105.59 * price)
```

1ç™ºãªã‚‰ã©ã‚Œã§ã‚‚ã„ã„ã€‚æµã‚Œä½œæ¥­ã«ã¯ `mutate()` ãŒä¾¿åˆ©ã€‚

---
## æ­£è¦åŒ– (min-max normalization)

æœ€å°=0ã€æœ€å¤§=1ã€ã«ãªã‚‹ã‚ˆã†ã«:

```{r normalize-min-max}
normalized_minmax = diamonds %>%
  mutate(price = (price - min(price)) / (max(price) - min(price))) %>%
  print()
```

å¤–ã‚Œå€¤ã®å½±éŸ¿ã‚’å¤§ããå—ã‘ã‚‹ã“ã¨ã«æ³¨æ„ã€‚


---
## æ­£è¦åŒ– (z-score normalization)

å¹³å‡=0ã€æ¨™æº–åå·®=1ã€ã«ãªã‚‹ã‚ˆã†ã«:

```{r normalize-z-score}
normalized_z = diamonds %>%
  mutate(price = (price - mean(price)) / sd(price)) %>%
  print()
```

`price = as.vector(scale(price))` ã§ã‚‚å¯èƒ½ã€‚<br>
`scale()` ã¯matrixã‚’è¿”ã™ãŸã‚ `as.vector()` ãŒå¿…è¦ã€‚


---
## æ­£è¦åŒ–ã®çµæœã‚’ç¢ºèª

åˆ†å¸ƒã®å½¢ã¯å¤‰ã‚ã‚‰ãšã€ç¯„å›²ãŒå¤‰ã‚ã‚‹ã€‚

z-scoreã¯æ­£è¦åˆ†å¸ƒå‰æã€‚ã“ã‚Œã ã‘éå¯¾ç§°ã ã¨ä½¿ã„ã«ãã„ã€‚

```{r normalize-plot, echo = FALSE, fig.width = 8, fig.height = 6}
dplyr::bind_rows(diamonds %>% dplyr::mutate(normalize = "-"),
  normalized_minmax %>% dplyr::mutate(normalize = "min-max"),
  normalized_z %>% dplyr::mutate(normalize = "z")) %>%
  ggplot() +
  aes(price) +
  geom_density(fill = "#999999", color = NA) +
  facet_wrap(vars(normalize), ncol = 1L, scale = "free", label = label_both) +
  theme_bw(base_size = 16)
```


---
## å¤–ã‚Œå€¤ã®é™¤å»

å¹³å‡å€¤ã‹ã‚‰æ¨™æº–åå·®ã®3å€ä»¥ä¸Šé›¢ã‚Œã¦ã„ã‚‹ã‚‚ã®($\lvert z \rvert \ge 3$)ã‚’å–ã‚Šé™¤ãä¾‹:

```{r outlier}
result = diamonds %>%
  filter(abs(price - mean(price)) / sd(price) < 3) %>%
  print()
```

å”¯ä¸€ã®æ–¹æ³•ã§ã¯ãªã„ã—ã€ãã‚‚ãã‚‚ã‚„ã‚‹ã¹ãã‹ã©ã†ã‹ã‚‚è¦æ¤œè¨


---
## æ¬ æå€¤ã®é™¤å» `tidyr::drop_na()`

(æŒ‡å®šã—ãŸåˆ—ã«) `NA` ãŒå«ã¾ã‚Œã¦ã‚‹è¡Œã‚’å‰Šé™¤ã™ã‚‹ã€‚

```{r drop_na}
df = tibble(x = c(1, 2, NA), y = c("a", NA, "b"))
df %>% drop_na()
```

ğŸ”° `starwars` ã§**èº«é•·ä½“é‡ãƒ‡ãƒ¼ã‚¿ã®ã‚ã‚‹è¡Œã ã‘æŠ½å‡º**ã—ã¦ã¿ã‚ˆã†

```{r starwars-drop, echo=FALSE}
starwars
```

---
## æ¬ æå€¤ã®è£œå®Œ `tidyr::replace_na()`

æ¬ æå€¤ `NA` ã‚’ä»»æ„ã®å€¤ã§ç½®ãæ›ãˆã‚‹ã€‚

```{r replace_na}
df = tibble(x = c(1, 2, NA), y = c("a", NA, "b"))
df %>% replace_na(list(x = 0, y = "unknown"))
```

ğŸ”° `starwars` ã§**é«ªã‚„ç›®ã®è‰²ãŒä¸æ˜ã®éƒ¨åˆ†ã‚’"UNKNOWN"ã«ç½®æ›**ã—ã‚ˆã†

```{r starwars-replace_na, echo=FALSE}
starwars
```

---
## æ¬ æå€¤ã¨ã¿ãªã™ `dplyr::na_if()`

ç‰¹å®šã®å€¤ã‚’ `NA` ã«ç½®ãæ›ãˆã‚‹:

```{r na_if}
df %>%
  mutate(x = na_if(x, 1), y = na_if(y, "a"))
```

ğŸ”° `starwars` ã®**æ€§åˆ¥"none"ã‚’æ¬ æå€¤ã«**ã—ã‚ˆã†

```{r starwars-na_if, echo=FALSE}
starwars
```

---
## æ¬ æå€¤ã®è£œå®Œ `dplyr::coalesce()`

å…ˆã«æŒ‡å®šã—ãŸåˆ—ãŒ `NA` ãªã‚‰æ¬¡ã®åˆ—ã®å€¤ã‚’æ¡ç”¨:

```{r coalesce}
y = c(1, 2, NA, NA, 5)
z = c(NA, NA, 3, 4, 5)
coalesce(y, z)
```

ç•°ãªã‚‹å‹ã‚’æ··ãœã‚‹ã¨æ€’ã‚‰ã‚Œã‚‹:
```{r coalesce-type}
df = tibble(x = c(1, 2, NA), y = c("a", NA, "b"))
df %>% mutate(z = coalesce(x, y))
```

ğŸ”° `starwars` ã§**é«ªè‰²ã®æ¬ æå€¤ã‚’è‚Œè‰²ã§è£œãŠã†**

---
## æ¡ä»¶ã«å¿œã˜ã¦å€¤ã‚’é¸æŠ `dplyr::if_else()`

æ™®é€šã® `if`, `else` ã¨ã¯é•ã£ã¦vectoræ¼”ç®—ãªã®ãŒç‰¹å¾´:

```{r ifelse}
condition = c(TRUE, TRUE, FALSE)
x = c(1, 2, 3)
y = c(100, 200, 300)
if_else(condition, x, y)
```

ğŸ”° `starwars` ã§**ç¨®æ—ãŒãƒ‰ãƒ­ã‚¤ãƒ‰ã®è¡Œã ã‘èº«é•·ã‚’100å€**ã—ã¦ã¿ã‚ˆã†


```{r starwars-ifelse, echo=FALSE}
starwars
```

---
## æ–‡å­—åˆ—: characterå‹ (string)

ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚€ã€‚ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚‚ä½¿ãˆã‚‹ã€‚

```{r string}
x = "This is a string"
y = 'If I want to include a "quote" inside a string, I use single quotes'
```

é–‰ã˜ãã³ã‚Œã‚‹ã¨å¤‰ãªçŠ¶æ…‹ã«ãªã‚‹ã®ã§ã€è½ã¡ç€ã„ã¦ <kbd>esc</kbd> or <kbd>ctrl</kbd><kbd>c</kbd>

```
> "This is a string without a closing quote
+
+
+ HELP I'M STUCK
```

<div style="text-align: right;"><a class="url" href=https://r4ds.had.co.nz/strings.html>
https://r4ds.had.co.nz/strings.html
</a></div>

---
## Rå‚™ãˆä»˜ã‘ã®æ–‡å­—åˆ—æ©Ÿèƒ½ã¯ä½¿ã„ã«ãã„

-   ä½•ã‚’ã‚„ã‚‹é–¢æ•°ãªã®ã‹åå‰ã‹ã‚‰åˆ†ã‹ã‚Šã«ãã„<br>
    `grep`, `grepl`, `regexpr`, `gregexpr`, `regexec`<br>
    `sub`, `gsub`, `substr`, `substring`
-   å¯¾è±¡æ–‡å­—åˆ—ã¯ã„ãã¤ã‚ã«æ¸¡ã™ï¼Ÿé–¢æ•°ã”ã¨ã«é•ã†ã€‚e.g.,<br>

    ```
    grep(pattern, x, ...)
    sub(pattern, replacement, x, ...)
    substr(x, start, stop)
    ```

-   æ¬ æå€¤ `NA` ã«å¯¾ã™ã‚‹æŒ™å‹•ãŒå¾®å¦™


---
## stringr --- æ–‡å­—åˆ—å‡¦ç†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

<a href="https://stringr.tidyverse.org/">
<img src="/slides/image/hex-stickers/stringr.png" width="120" align="right">
</a>

```{r stringr, include = FALSE}
library(stringr)
```

-   tidyverseã®ä¸€éƒ¨
-   ä½•ã‚’ã‚„ã‚‹é–¢æ•°ãªã®ã‹åå‰ã‹ã‚‰åˆ†ã‹ã‚Šã‚„ã™ã„
-   å¯¾è±¡æ–‡å­—åˆ—ãŒä¸€è²«ã—ã¦ç¬¬ä¸€å¼•æ•°
-   å¼•æ•°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å„è¦ç´ ã®åå‰ã‚„ä½ç½®ã‚’ä¿æŒã™ã‚‹
    -   é•·ã•ã‚¼ãƒ­ã®å…¥åŠ›ã‹ã‚‰ã¯é•·ã•ã‚¼ãƒ­ã®å‡ºåŠ›
    -   å…¥åŠ›ã« `NA` ãŒå«ã¾ã‚Œã‚‹å ´åˆã¯å¯¾å¿œã™ã‚‹å‡ºåŠ›ã‚‚ `NA`
-   [ICUæ­£è¦è¡¨ç¾](https://unicode-org.github.io/icu/userguide/strings/regexp.html)ã®ä»•æ§˜ãŒæ˜ç¢º
-   [å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://stringr.tidyverse.org/)ã‚’è¦‹ã‚Œã°å…¨å®¹ãŒæ´ã‚ã‚‹


---
## stringr --- æ–‡å­—åˆ—å‡¦ç†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

<figure style="margin: 0;">
<a href="https://stringr.tidyverse.org/">
<img src="/slides/image/cheatsheet/strings.png" width="90%">
<figcaption class="url">https://stringr.tidyverse.org/</figcaption>
</a>
</figure>


---
## æ–‡å­—åˆ—ã®åŸºæœ¬æ“ä½œ

```{r str_length}
fruit4 = head(fruit, 4L) %>% print()
str_length(fruit4)            # é•·ã•
str_sub(fruit4, 2, 4)         # éƒ¨åˆ†æŠ½å‡º
str_c(1:4, " ", fruit4, "!")  # çµåˆ
```

ğŸ”° `fruit` ã‚„ `words` ã®ä¸€éƒ¨ã‚’æŠœãå‡ºã—ã¦ä¸Šè¨˜ã®é–¢æ•°ã‚’è©¦ã—ã¦ã¿ã‚ˆã†


---
## ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°

å˜ç´”ãªä¸€è‡´ã ã‘ã˜ã‚ƒãªãã€ã„ã‚ã‚“ãªæ¡ä»¶ã§ãƒãƒƒãƒãƒ³ã‚°ã§ãã‚‹:

```{r pattern}
# aã§å§‹ã¾ã‚‹
str_subset(fruit, "^a")

# rã§çµ‚ã‚ã‚‹
str_subset(fruit, "r$")

# è‹±æ•°å­—3-4æ–‡å­—
str_subset(fruit, "^\\w{3,4}$")
```

ã“ã® `^` ã¨ã‹ `$` ã£ã¦ä½•è€…ï¼Ÿ

---
## æ­£è¦è¡¨ç¾: æŸ”è»Ÿãªæ¤œç´¢ãƒ»ç½®æ›ã‚’å¯èƒ½ã«ã™ã‚‹ãƒ„ãƒ¼ãƒ«

| ãƒ¡ã‚¿æ–‡å­— | æ„å‘³ | &emsp;&emsp;&emsp; | æ¼”ç®—å­ | æ„å‘³ |
| ---- | ---- | --- | ---- | ---- |
| `\d` | æ•°å­— (é€†ã¯ `\D`) | | `?`  | 0å›ã‹1å› |
| `\s` | ç©ºç™½ (é€†ã¯ `\S`) | | `*`  | 0å›ä»¥ä¸Šç¹°ã‚Šè¿”ã— |
| `\w` | è‹±æ•°å­— (é€†ã¯ `\W`) | | `+`  | 1å›ä»¥ä¸Šç¹°ã‚Šè¿”ã— |
| `.`  | **ä½•ã§ã‚‚1æ–‡å­—** | | `{n,m}` | nå›ä»¥ä¸Šmå›ä»¥ä¸‹ |
| `^`  | è¡Œé ­   | | `XXX(?=YYY)`  | YYYã«å…ˆç«‹ã¤XXX |
| `$`  | è¡Œæœ«   | | `(?<=YYY)XXX`  | YYYã«ç¶šãXXX |

<div style="text-align: right;"><a class="url" href="https://unicode-org.github.io/icu/userguide/strings/regexp.html#regular-expression-metacharacters">
https://unicode-org.github.io/icu/userguide/strings/regexp.html#regular-expression-metacharacters
</a></div>

Rã®`"æ™®é€šã®æ–‡å­—åˆ—"`ã§ã¯ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’é‡ã­ã‚‹å¿…è¦ãŒã‚ã‚‹: `"^\\d"`.
<aside style="font-size: 0.9rem; color: #888888;">

æ”¹è¡Œ `\n` ã¨ã‹ã‚¿ãƒ– `\t` ã®ã‚ˆã†ãª[ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹](https://duckduckgo.com/?q=escape+sequence)ã¨åŒºåˆ¥ã™ã‚‹ãŸã‚ã€‚<br>
`r"(rawæ–‡å­—åˆ—)"`ã‚’ä½¿ã†å ´åˆã¯ã²ã¨ã¤ã§ã„ã„: `r"(^\d)"`.

</aside>

---
## æ­£è¦è¡¨ç¾: ãƒãƒ¼ãƒˆã‚·ãƒ¼ãƒˆ

<figure style="margin: 0;">
<a href="https://stringr.tidyverse.org/">
<img src="/slides/image/cheatsheet/strings-regex.png" width="90%">
<figcaption class="url">https://stringr.tidyverse.org/</figcaption>
</a>
</figure>

---
## æ­£è¦è¡¨ç¾: ç·´ç¿’å•é¡Œ

ğŸ”° `str_subset()`, `fruit`, `words` ã§ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã‚’èº«ã«ç€ã‘ã‚ˆã†

- "o" ã§å§‹ã¾ã‚‹ã‚‚ã®
- "berry" ã§çµ‚ã‚ã‚‹ã‚‚ã®
- "c" ã§å§‹ã¾ã‚Š "r" ã§çµ‚ã‚ã‚‹ã‚‚ã®
- ç©ºç™½ã‚’å«ã‚€ã‚‚ã®ã€å«ã¾ãªã„ã‚‚ã®
- æ•°å­—ã‚’å«ã‚€ã‚‚ã®ã€å«ã¾ãªã„ã‚‚ã®
- ãã®ã»ã‹è‡ªåˆ†ã§é©å½“ã«è€ƒãˆã¦ã¿ã‚‹


---
## æ¤œå‡º `str_detect()`

ãƒãƒƒãƒã™ã‚‹ã‹ã©ã†ã‹ `TRUE`/`FALSE` ã‚’è¿”ã™ã€‚
```{r str_detect}
fruit4 = head(fruit, 4L)
str_detect(fruit4, "^a")
```

ğŸ”° `starwars` ã‹ã‚‰ `name` åˆ—ã«ç©ºç™½ã‚’å«ã¾ãªã„è¡Œã‚’æŠ½å‡ºã—ã‚ˆã†

```{r starwars-detect, echo=FALSE}
starwars
```

---
## æŠ½å‡º `str_extract()`

ãƒãƒƒãƒã—ãŸéƒ¨åˆ†æ–‡å­—åˆ—ã‚’å–ã‚Šå‡ºã™ã€‚ã—ãªã‹ã£ãŸè¦ç´ ã«ã¯ `NA`ã€‚
```{r str_extract}
fruit4 = head(fruit, 4L)
str_extract(fruit4, "^a..")
```

ğŸ”° `diamonds` ã® `clarity` åˆ—ã‚’æ•°å­—ãªã—ã«ã—ã¦ã¿ã‚ˆã†

```{r diamonds-extract, echo=FALSE}
diamonds
```


---
## ç½®æ› `str_replace()`, `str_replace_all()`

ã‚«ãƒƒã‚³ `()` ã§å›²ã‚“ã ãƒãƒƒãƒãƒ³ã‚°ã¯å¾Œã§å‚ç…§ã§ãã‚‹:
```{r str_replace}
fruit4 = head(fruit, 4L)
str_replace(fruit4, "..$", "!!")
str_replace(fruit4, "(..)$", "_\\1_")
```

ğŸ”° `starwars` ã® `name` åˆ—ã®æ•°å­—ã‚’å…¨éƒ¨ã‚¼ãƒ­ã«ã—ã¦ã¿ã‚ˆã†

```{r starwars-replace, echo=FALSE}
starwars
```

---
## dplyr, tidyr ã®åˆ—é¸æŠãªã©ã§ã‚‚æ´»èº

`matches()` ãŒã‚ã‚Œã° `starts_with()`/`ends_with()` ã¯ä¸è¦:

```r
diamonds %>% select(matches("^c"))   # starts_with("c")
starwars %>% select(matches("s$"))   # ends_with("s")
world_bank_pop %>%
  pivot_longer(matches("^\\d+$"), names_to = "year")
```

See ["tidyselect helpers"](https://tidyselect.r-lib.org/reference/select_helpers.html) for more details.


---
## å½¢å¼ã‚’å¤‰ãˆã‚‹ãƒ»æ•´ãˆã‚‹

```{r upperlower}
fruit4 = head(fruit, 4L)
str_to_upper(fruit4)              # å¤§æ–‡å­—ã«
str_pad(fruit4, 8, "left", "_")   # å¹…ã‚’åŸ‹ã‚ã¦æŒ‡å®šå¹…ã«
```

[`stringi`](http://www.gagolewski.com/software/stringi/) ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ã•ã‚‰ã«å¤šæ©Ÿèƒ½
```{r stringi}
stringi::stri_trans_nfkc("ï½¶ï¾€ï½¶ï¾…")  # åŠè§’ã‚«ãƒŠã‚’å…¨è§’ã«
```

ğŸ”° `starwars` ã® `name` åˆ—ã‚’å…¨éƒ¨å°æ–‡å­—ã«ã—ã¦ã¿ã‚ˆã†

---
## æ–‡å­—åˆ—ã‹ã‚‰åˆ¥ã®å‹ã«

<a href="https://readr.tidyverse.org/">
<img src="/slides/image/hex-stickers/readr.png" width="120" align="right">
</a>

```{r readr, include = FALSE}
library(readr)
```

ã“ã‚Œã¯stringrã§ã¯ãªãreadrã®æ‹…å½“:

```{r parse-character}
parse_number(c("p = 0.02 *", "N_A = 6e23"))
parse_double(c("0.02", "6e+23"))
parse_logical(c("1", "true", "0", "false"))
parse_date("2020-06-03")
```

`6e+23` ã¯ $6 \times 10 ^ {23}$ ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°çš„è¡¨ç¾ã€‚
$6e^{23}$ ã§ã¯ãªã„ã€‚

---
## å› å­å‹ `factor`

**ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ«å¤‰æ•°**(è³ªçš„å¤‰æ•°)ã‚’æ‰±ã†ãŸã‚ã®å‹ã€‚æ–‡å­—åˆ—ã£ã½ã„ã‘ã©**å®Ÿä½“ã¯æ•´æ•°**ã€‚

```{r factor}
month_levels = c(                       # å–ã‚Šã†ã‚‹å€¤
  "Jan", "Feb", "Mar", "Apr", "May", "Jun",
  "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
)
x1 = c("Dec", "Apr", "Jan", "Mar")      # ãŸã ã®æ–‡å­—åˆ—vector
y1 = factor(x1, levels = month_levels)  # å› å­å‹ã«å¤‰æ›
print(y1)
as.integer(y1)                          # æ•´æ•°å‹ã«å¤‰æ›å¯èƒ½
```

ğŸ”° `iris` ã«å«ã¾ã‚Œã‚‹å› å­å‹ã‚’ç¢ºèªã—ã‚ˆã†: `str(iris)`

<div style="text-align: right;"><a class="url" href="https://r4ds.had.co.nz/factors.html">
https://r4ds.had.co.nz/factors.html
</a></div>

---
## å› å­å‹ `factor`: æ–‡å­—åˆ—ã¨ã®é•ã„1

å–ã‚Šã†ã‚‹å€¤ (levels) ãŒæ—¢çŸ¥ã€‚

typoãªã©ã«ã‚ˆã‚Šlevelså¤–ã«ãªã‚‹ã¨ `NA` æ‰±ã„ã€‚

```{r factor-levels}
x2 = c("Dec", "Apr", "Jam", "Mar")
factor(x2, levels = month_levels)
```

å…ƒã®æ–‡å­—åˆ—vectorã«å…¨ã¦ã®levelsãŒå«ã¾ã‚Œã¦ã‚‹ãªã‚‰ç°¡å˜ã«å¤‰æ›å¯èƒ½:
```{r as_factor}
as.factor(starwars[["gender"]])
```

---
## å› å­å‹ `factor`: æ–‡å­—åˆ—ã¨ã®é•ã„2

ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã˜ã‚ƒãªã„é †åºãŒã‚ã‚‹:

```{r factor-sort}
x1 = c("Dec", "Apr", "Jan", "Mar")
sort(x1)     # æ–‡å­—åˆ—ã¨ã—ã¦ã‚½ãƒ¼ãƒˆã™ã‚‹ã¨ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †
y1 = factor(x1, levels = month_levels)
sort(y1)     # å› å­ã¨ã—ã¦ã‚½ãƒ¼ãƒˆã™ã‚‹ã¨levelsé †
```

---
## å› å­å‹ `factor`: é †åºã®æƒ…å ±ã¯ä½œå›³ã§ç”Ÿãã‚‹

æ–‡å­—åˆ—ã ã¨å‹æ‰‹ã«ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã€‚å› å­å‹ãªã‚‰ä»»æ„æŒ‡å®šå¯èƒ½:

```{r factor-mpg}
mpg_fct = mpg %>%
  mutate(drv = factor(drv, levels = c("f", "r", "4")))
```

```{r factor-plot, fig.width = 7, fig.height = 5, echo = FALSE}
p1 = mpg %>%
  ggplot() +
  aes(drv, hwy) +
  geom_boxplot(aes(fill = drv), outlier.alpha = 0) +
  geom_jitter(height = 0, width = 0.25, alpha = 0.5) +
  labs(x = "drv") +
  theme_classic(base_size = 18) +
  theme(legend.position = "none")
cowplot::plot_grid(p1 + ggtitle("mpg"), p1 %+% mpg_fct + ggtitle("mpg_fct"), nrow = 1L)
```

---
## é †åºã¤ãå› å­å‹ `ordered`

å¤§å°ã®æ¯”è¼ƒãŒã§ãã‚‹ã€‚

```{r ordered}
x1 = c("Dec", "Apr", "Jan", "Mar")
y3 = factor(x1, levels = month_levels, ordered = TRUE)
class(y3)
print(y3)
y3 < "Sep"
```

ğŸ”° `diamonds` ã«å«ã¾ã‚Œã‚‹orderedå‹ã‚’ç¢ºèªã—ã‚ˆã†: `str(diamonds)`<br>
ğŸ”° `cut` ãŒPremiumä»¥ä¸Šã®è¡Œã ã‘æŠœãå‡ºã™ã€ã¨ã‹ã€‚

---
## tidyverse ã®å› å­å‹æ‹…å½“ã¯ forcats

<a href="https://forcats.tidyverse.org/">
<img src="/slides/image/hex-stickers/forcats.png" width="120" align="right">
</a>

```{r forcats, include = FALSE}
library(forcats)
```

- `fct_relevel()`: æ‰‹å‹•ã§é †åºè¨­å®š
- `fct_reorder()`: åˆ¥ã®å¤‰æ•°ã«å¿œã˜ã¦é †åºã‚’ä¸¦ã¹æ›¿ãˆ
- `fct_infreq()`: é »åº¦ã«å¿œã˜ã¦é †åºã‚’ä¸¦ã¹æ›¿ãˆ
- `fct_lump()`: å°‘ãªã™ãã‚‹ã‚«ãƒ†ã‚´ãƒªã‚’"ãã®ä»–"ã¨ã—ã¦ã¾ã¨ã‚ã‚‹

```{r fct_infreq_data}
diamonds_fct = diamonds %>%
  mutate(color = fct_infreq(color))
mpg_fct = mpg %>%
  mutate(fl = fct_lump(fl, n = 2))
```

```{r fct_infreq, fig.width = 8, fig.height = 3, echo = FALSE}
p1 = diamonds_fct %>%
  ggplot() + aes(x = color) + geom_bar() + coord_flip() +
  theme_minimal(base_size = 16)
p2 = mpg_fct %>%
  ggplot() + aes(fl, cty, fill = fl) +
  geom_dotplot(binaxis = "y", stackdir = "center", binwidth = 0.5, stroke = 0) +
  theme_minimal(base_size = 16) +
  theme(legend.position = "none")
cowplot::plot_grid(p1, p2, nrow = 1L)
```

---
## factorã§é †åºã‚’å¤‰ãˆã¦ä½œå›³ã™ã‚‹ç·´ç¿’

ğŸ”° `mpg` ã§æ¬¡ã®ã‚ˆã†ãªå›³ã‚’æã„ã¦ã¿ã‚ˆã†

```{r plot-factor, echo = FALSE, fig.width = 5, fig.height = 5}
mpg %>%
  mutate(drv = fct_relevel(drv, "f", "r", "4")) %>%
  mutate(class = fct_rev(fct_infreq(class))) %>%
  ggplot() +
  aes(class) +
  geom_bar(aes(fill = drv)) +
  coord_flip() +
  theme_classic(base_size = 18) +
  theme(panel.grid = element_blank(), axis.title.y = element_blank(),
        axis.line.y = element_blank(), axis.ticks.y = element_blank(),
        legend.position = "top")
```

---
## æŒ‡ç¤ºå¤‰æ•°(ãƒ€ãƒŸãƒ¼å¤‰æ•°)ã«å¤‰æ›

ã‚¤ãƒã‚¼ãƒ­ã®å€¤ã‚’æŒãŸã›ã¦æ¨ªåºƒã«å¤‰å½¢ã™ã‚‹ã®ã¨ç­‰ä¾¡ã€‚

```{r dummy}
iris %>% rowid_to_column() %>%
  mutate(value = 1L) %>%
  pivot_wider(names_from = Species,
              values_from = value, values_fill = 0L)
```

ğŸ”° ã“ã‚Œã‚’å…ƒã® `iris` ã«æˆ»ã—ã¦ã¿ã‚ˆã†


---
## æ—¥æ™‚å‹: POSIXct, POSIXlt

- POSIXct: ã‚¨ãƒãƒƒã‚¯ã‹ã‚‰ã®çµŒéç§’æ•°ã€‚æ¯”è¼ƒã‚„å·®åˆ†ãªã©ã‚’å–ã‚Šã‚„ã™ã„ã€‚
- POSIXlt: list(ç§’, åˆ†, æ™‚, æ—¥, æœˆ, å¹´, ...)ã€‚å˜ä½ã”ã¨ã«æŠœãå‡ºã—ã‚„ã™ã„ã€‚

```{r datetime}
now = "2021-09-15 11:00:00"
ct = as.POSIXct(now)
unclass(ct)
lt = as.POSIXlt(now)
unclass(lt) %>% as_tibble()
```

ç´ ã®Rã§ã‚‚æ‰±ãˆã‚‹ã‘ã© lubridate ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã†ã¨ã‚‚ã£ã¨æ¥½ã«ã€‚

---
## lubridate --- æ—¥æ™‚å‹å‡¦ç†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

<a href="https://lubridate.tidyverse.org/">
<img src="/slides/image/hex-stickers/lubridate.png" width="120" align="right">
</a>

```{r lubridate, include = FALSE}
library(lubridate)
```

æ—¥æ™‚å‹ã¸ã®å¤‰æ›:
```{r lubridate-parse}
ymd(c("20201017", "2020-10-17", "20/10/17"))
```

æ—¥æ™‚å‹ã‹ã‚‰å˜ä½ã”ã¨ã«å€¤ã‚’å–å¾—:
```{r lubridate-get}
today = ymd(20201017)
month(today)
wday(today, label = TRUE)
```

ğŸ”° [å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://lubridate.tidyverse.org/)ãªã©ã‚’è¦‹ã¦ã„ã‚ã„ã‚ãªå¤‰æ›ãƒ»æŠ½å‡ºã‚’è©¦ã—ã¦ã¿ã‚ˆã†

---
## ãƒ‡ãƒ¼ã‚¿å†…å®¹ã‚’å¯¾è±¡ã¨ã™ã‚‹å‡¦ç† | ã¾ã¨ã‚

<div style="float: right;">
<a href="https://stringr.tidyverse.org/">
<img src="/slides/image/hex-stickers/stringr.png" width="120">
</a><br>
<a href="https://forcats.tidyverse.org/">
<img src="/slides/image/hex-stickers/forcats.png" width="120">
</a><br>
<a href="https://lubridate.tidyverse.org/">
<img src="/slides/image/hex-stickers/lubridate.png" width="120">
</a><br>
</div>

- æ­£è¦åŒ–ãƒ»æ¬ æå€¤å‡¦ç†ã¯ç›®çš„ã«å¿œã˜ã¦æ¤œè¨
- vectorã«ã¯**å‹**ãŒã‚ã‚‹: æ–‡å­—åˆ—ã€æ•°å€¤ã€å› å­ã€æ—¥æ™‚ã€etc.
- æ–‡å­—åˆ—ã‚’æ‰±ã†ã«ã¯ [stringr](https://stringr.tidyverse.org/)
    - **æ­£è¦è¡¨ç¾**ã¯ä¸€åº¦ç¿’å¾—ã™ã‚Œã°è¶…å¼·åŠ›
- å› å­ã‚’æ‰±ã†ã«ã¯ [forcats](https://forcats.tidyverse.org/)
    - çŸ¥ã£ã¦ãŠãã¨ãŸã¾ã«ä¾¿åˆ©ã€‚è‹¦æ‰‹ãªã‚‰å…¨éƒ¨æ–‡å­—åˆ—ã«ã—ã¦ã‚‚ã„ã„ã€‚
- æ—¥æ™‚ã‚’æ‰±ã†ã«ã¯ [lubridate](https://lubridate.tidyverse.org/)

å„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®[ãƒãƒ¼ãƒˆã‚·ãƒ¼ãƒˆ.pdf](https://www.rstudio.com/resources/cheatsheets/)ã‚’æ‰‹å…ƒã«æŒã£ã¦ãŠãã¨ä¾¿åˆ©ã€‚


---
## å‰å‡¦ç†ã«å¿…è¦ãªé“å…·ã¯ã ã„ãŸã„æƒã£ãŸ

<div style="float: right;">
<a href="https://dplyr.tidyverse.org/">
<img src="/slides/image/hex-stickers/dplyr.png" width="120">
</a><br>
<a href="https://tidyr.tidyverse.org/">
<img src="/slides/image/hex-stickers/tidyr.png" width="120">
</a><br>
<a href="https://stringr.tidyverse.org/">
<img src="/slides/image/hex-stickers/stringr.png" width="120">
</a>
</div>

- ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å¯¾è±¡ã¨ã™ã‚‹å‡¦ç† â€” ç¬¬3, 4å›
    - ä½¿ã„ãŸã„éƒ¨åˆ†ã ã‘æŠ½å‡º --- `select()`, `filter()`
    - ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ç‰¹å¾´ã‚’è¦ç´„ --- `group_by()`, `summarize()`
    - ä½•ã‹ã®é †ã«ä¸¦ã¹æ›¿ãˆ --- `arrange()`
    - ç•°ãªã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã®çµåˆ --- `*_join()`
    - å¤‰å½¢: ç¸¦é•· â†” æ¨ªåºƒ --- `pivot_longer()`, `pivot_wider()`
- **ãƒ‡ãƒ¼ã‚¿å†…å®¹ã‚’å¯¾è±¡ã¨ã™ã‚‹å‡¦ç†** â€” ğŸ‘ˆ ç¬¬5å› æœ¬æ—¥ã®è©±é¡Œ
    - æ•°å€¤ã®å¤‰æ›: å¯¾æ•°ã€æ­£è¦åŒ–
    - å¤–ã‚Œå€¤ãƒ»æ¬ æå€¤ã¸ã®å¯¾å‡¦
    - å‹å¤‰æ›: é€£ç¶šå¤‰æ•°ã€ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ«å¤‰æ•°ã€æŒ‡ç¤ºå¤‰æ•°ã€å› å­ã€æ—¥æ™‚
    - æ–‡å­—åˆ—å‡¦ç†: æ­£è¦è¡¨ç¾ã«ã‚ˆã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒ

<cite style="display: block; text-align: right;"><a href="https://www.amazon.co.jp/dp/4774196479/ref=as_li_ss_tl?ie=UTF8&linkCode=ll1&tag=heavywatal-22&linkId=8a3fd4e9a0c944b1b41242bbab8d147b">
æœ¬æ©‹æ™ºå…‰ã€Œå‰å‡¦ç†å¤§å…¨ã€
</a></cite>


---
## çµ±è¨ˆè§£æã®ä¸€æ­©æ‰‹å‰ã¾ã§ãªã‚‰è¡Œã‘ã‚‹

1. ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ç’°å¢ƒã®æ•´å‚™
1. ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã€èª­ã¿è¾¼ã¿
1. æ¢ç´¢çš„ãƒ‡ãƒ¼ã‚¿è§£æ
    - **å‰å‡¦ç†ã€åŠ å·¥** (åœ°å‘³ã€‚æ„å¤–ã¨é‡ã„) ğŸ‘ˆ æœ¬å®Ÿç¿’ã®ä¸»é¡Œ
    - å¯è¦–åŒ–ã€ä»®èª¬ç”Ÿæˆ (æ´¾æ‰‹ï¼ã ã„ã˜ï¼)
    - çµ±è¨ˆè§£æã€ä»®èª¬æ¤œè¨¼ (ã¿ã‚“ãªå‹‰å¼·ã—ãŸãŒã‚‹)
1. å ±å‘Šã€ç™ºè¡¨

<figure>
<a href="https://r4ds.had.co.nz/introduction.html">
<img src="/slides/image/r4ds/data-science.png">
<figcaption class="url">https://r4ds.had.co.nz/introduction.html</figcaption>
</a>
</figure>


---
## ğŸ”° èª²é¡Œ: å¥½ããªãƒ‡ãƒ¼ã‚¿ã‚’ã„ã˜ãã‚Šå€’ã—ã¦ã¿ã‚ˆã†

- è‡ªåˆ†ãŒã“ã‚Œã‹ã‚‰è§£æã—ãŸã„ãƒ‡ãƒ¼ã‚¿ (ã‚‚ã—æ‰‹å…ƒã«ã‚ã‚Œã°)
- Rã‚„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ä»˜å±ã®ãƒ‡ãƒ¼ã‚¿
    - `diamonds`, `starwars`, `mpg`, etc. See `data()`
- ä½•ã‹é©å½“ãªãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
    - [e-Stat](https://www.e-stat.go.jp/): æ”¿åºœçµ±è¨ˆã®ç·åˆçª“å£
    - [data.go.jp ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã‚µã‚¤ãƒˆ](https://www.data.go.jp/data/dataset?res_format=CSV): ä¸­å¤®çœåº
    - [BODIKã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã‚µã‚¤ãƒˆ](https://odcs.bodik.jp/): åœ°æ–¹è‡ªæ²»ä½“
    - [æ°—è±¡åº](https://www.data.jma.go.jp/gmd/risk/obsdl/index.php)
    - [DATA.GOV](https://www.data.gov/): U.S. Governmentâ€™s open data
- ã€Œã†ã¾ãã„ã‹ãªã„ã€ã€Œã“ã†ã—ãŸã„ã€ã€Œã‚‚ã£ã¨ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆãªæ–¹æ³•ã€
  ãªã©æ°—è»½ã«è³ªå•ã—ã¦ãã ã•ã„

---
## å®Ÿæ¼”: [ç›®é»’åŒºã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿](https://odcs.bodik.jp/131105/)

[ç”ºä¸åˆ¥ãƒ»å¹´é½¢åˆ¥ãƒ»ç”·å¥³åˆ¥äººå£...](https://data.bodik.jp/organization/968e265c-d998-4475-8abf-7e8a53f81595?res_format=CSV&groups=gr_0200)
ã®æœ€æ–°CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€èª­ã¿è¾¼ã¿

```{r meguro_read, echo = -1}
if (FALSE) {
  infile = "https://data.bodik.jp/dataset/98331303-9277-4266-bac6-a637ab5e47a5/resource/8019010f-a2b1-4313-bcd8-45ade27d2a3d/download/131105_population_20211001.csv"
  raw_meguro = readr::read_csv(infile)
  readr::write_csv(raw_meguro, fs::path_file(infile), na = "")
}
infile = "131105_population_20211001.csv"
raw_meguro = readr::read_csv(infile)
print(raw_meguro)
```

---
## å®Ÿæ¼”: ç›®é»’åŒºã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿

ggplotã—ãŸããªã‚‹å½¢ã«å¤‰å½¢ã€‚1è¡Œãšã¤çµŒéã‚’ç¢ºèªã—ã‚ˆã†ã€‚

```{r meguro_tidy}
tidy_meguro = raw_meguro %>%
  select("åœ°åŸŸå", matches("ã®.+æ€§$")) %>%
  rename(place = åœ°åŸŸå) %>%
  mutate(place = str_remove(place, "\\Sä¸ç›®")) %>%
  group_by(place) %>%
  summarize(across(everything(), sum)) %>%
  ungroup() %>%
  pivot_longer(!place, names_to = "category", values_to = "count") %>%
  separate(category, c("age", "sex"), sep = "ã®") %>%
  mutate(age = as.integer(str_extract(age, "^\\d+"))) %>%
  filter(!is.na(age)) %>%
  print()
```

---
## å®Ÿæ¼”: ç›®é»’åŒºã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿

ä½œå›³ã—ã¦ã¿ã‚‹

```{r meguro_plot, fig.height = 4.5, fig.width = 10}
ggplot(tidy_meguro) +
  aes(age, count) +
  geom_col(aes(fill = sex)) +
  facet_wrap(vars(place), nrow = 3L) +
  theme_bw(base_family = "HiraginoSans-W3") # æ—¥æœ¬èªã¯é¬¼é–€
```

---
## å®Ÿæ¼”: [e-Stat å›½å‹¢èª¿æŸ»2015](https://www.e-stat.go.jp/gis/statmap-search?page=1&type=1&toukeiCode=00200521) (å®®åŸçœŒ)

æ–‡å­—ã‚³ãƒ¼ãƒ‰ãŒå¤ã„ã€‚åˆ—åãŒ2è¡Œã«ã¾ãŸãŒã£ã¦ã‚‹ã€‚æ•°å€¤ã®åˆ—ã«å¤‰ãªæ–‡å­—ã€‚

```{r estat_read}
infile = "tblT000849C04.txt"
sjis = locale(encoding = "SJIS")
# readr::read_csv(infile, locale = sjis)
miyagi_L = readr::read_csv(infile, locale = sjis, col_select = seq(1, 7)) %>%
  dplyr::slice(-1)
miyagi_R = readr::read_csv(infile, locale = sjis, col_select = -seq(1, 7), skip = 1L, na = c("-", "X"), name_repair = "minimal")
raw_miyagi = bind_cols(miyagi_L, miyagi_R) %>% print()
```

---
## å®Ÿæ¼”: e-Stat å›½å‹¢èª¿æŸ»2015 (å®®åŸçœŒ)

ã¾ã ç½ ãŒãŸãã•ã‚“: åˆ—åã®é ­ã«ã‚¹ãƒšãƒ¼ã‚¹ã€‚å…¨è§’æ•°å­—ã€‚å¤‰ãªåŒºåˆ†ã€‚

```{r estat_tidy}
tidy_miyagi = raw_miyagi %>%
  dplyr::filter(HYOSYO == 1) %>%
  dplyr::select(CITYNAME, matches("[ç”·å¥³].+[æ­³ä¸Š]$")) %>%
  tidyr::pivot_longer(!CITYNAME, names_to = "category", values_to = "count") %>%
  dplyr::mutate(category = str_trim(category)) %>%
  tidyr::separate(category, c("sex", "age"), 1) %>%
  dplyr::mutate(age = stringi::stri_trans_nfkc(age)) %>%
  tidyr::separate(age, c("lower", "upper"), "ã€œ", fill = "right") %>%
  dplyr::mutate(lower = parse_number(lower), upper = parse_number(upper)) %>%
  dplyr::filter((upper - lower) < 5 | lower == 75) %>%
  dplyr::rename(age = lower) %>%
  print()
```

---
## å®Ÿæ¼”: e-Stat å›½å‹¢èª¿æŸ»2015 (å®®åŸçœŒ)

```{r estat_factor, include = FALSE}
total_miyagi = tidy_miyagi %>%
  dplyr::count(CITYNAME, wt = count, name = "count") %>%
  dplyr::arrange(desc(count))
tidy_miyagi = tidy_miyagi %>%
  dplyr::mutate(CITYNAME = factor(CITYNAME, levels = total_miyagi$CITYNAME))
```

```{r estat_plot, fig.height = 6, fig.width = 11}
ggplot(tidy_miyagi) +
  aes(age, count) +
  geom_col(aes(fill = sex)) +
  facet_wrap(vars(CITYNAME), ncol = 8L) +
  theme_minimal(base_family = "HiraginoSans-W3", base_size = 14)
```

---
## Reference

R for Data Science --- Hadley Wickham and Garrett Grolemund
: <https://r4ds.had.co.nz/>,
  [Paperback](https://amzn.to/2tbRmVc),
  [æ—¥æœ¬èªç‰ˆæ›¸ç±](https://amzn.to/2yyFRKt)

[å‰å‡¦ç†å¤§å…¨ --- æœ¬æ©‹æ™ºå…‰](https://www.amazon.co.jp/dp/4774196479/ref=as_li_ss_tl?ie=UTF8&linkCode=ll1&tag=heavywatal-22&linkId=8a3fd4e9a0c944b1b41242bbab8d147b)<br>
[Rãƒ¦ãƒ¼ã‚¶ã®ãŸã‚ã®RStudio[å®Ÿè·µ]å…¥é–€ (å®‡å®™èˆ¹æœ¬) --- æ¾æ‘ã‚‰](https://amzn.to/2Yy5LND)

Official documents:
: [tidyverse](https://www.tidyverse.org/),
  [dplyr](https://dplyr.tidyverse.org/),
  [tidyr](https://tidyr.tidyverse.org/),
  [stringr](https://stringr.tidyverse.org/),
  [forcats](https://forcats.tidyverse.org/),
  [lubridate](https://lubridate.tidyverse.org/)

Older versions
: ã€Œ[Rã«ã‚„ã‚‰ã›ã¦æ¥½ã—ã‚ˆã† â€” ãƒ‡ãƒ¼ã‚¿ã®å¯è¦–åŒ–ã¨ä¸‹ã”ã—ã‚‰ãˆ](https://heavywatal.github.io/slides/nagoya2018/)ã€
   å²©åµœèˆª 2018
: ã€ŒRã‚’ç”¨ã„ãŸãƒ‡ãƒ¼ã‚¿è§£æã®åŸºç¤ã¨å¿œç”¨ã€çŸ³å·ç”±å¸Œ 2019 åå¤å±‹å¤§å­¦
: ã€Œ[Rã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿å‰å‡¦ç†å®Ÿç¿’](https://heavywatal.github.io/slides/tmd2020/)ã€
   å²©åµœèˆª 2020 æ±äº¬åŒ»ç§‘æ­¯ç§‘å¤§
: ã€Œ[Rã‚’ç”¨ã„ãŸãƒ‡ãƒ¼ã‚¿è§£æã®åŸºç¤ã¨å¿œç”¨](https://comicalcommet.github.io/r-training-2021/)ã€
   çŸ³å·ç”±å¸Œ 2021 åå¤å±‹å¤§å­¦

<a href="6-distribution.html" rel="next" class="readmore">
6. çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°1: ç¢ºç‡åˆ†å¸ƒã€å°¤åº¦
</a>
