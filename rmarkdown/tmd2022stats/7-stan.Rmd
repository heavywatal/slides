+++
url = "tmd2022stats/7-stan.html"
title = "7. Stanã§GLM â€” çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å®Ÿç¿’ 2022 TMDU"
linktitle = "Stanã§GLM"
date = 2023-04-01T13:00:00+09:00
type = "reveal"
draft = false
+++

<link rel="stylesheet" href="style.css">

# [çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å®Ÿç¿’ 2022 TMDU](.)

<div class="author">
å²©åµœ èˆª (Watal M. Iwasaki, PhD)
</div>

<div class="affiliation">
æ±åŒ—å¤§å­¦ ç”Ÿå‘½ç§‘å­¦ç ”ç©¶ç§‘ é€²åŒ–ã‚²ãƒãƒŸã‚¯ã‚¹åˆ†é‡ ç‰¹ä»»åŠ©æ•™<br>
(Graduate School of Life Sciences, Tohoku University)
</div>

<ol>
<li><a href="1-introduction.html">å°å…¥</a>
<li><a href="2-distribution.html">ç¢ºç‡åˆ†å¸ƒã€æ“¬ä¼¼ä¹±æ•°ç”Ÿæˆ</a>
<li><a href="3-likelihood.html">å°¤åº¦ã€æœ€å°¤æ¨å®š</a>
<li><a href="4-glm.html">ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ« (GLM)</a>
<li><a href="5-glmm.html">å€‹ä½“å·®ã€ä¸€èˆ¬åŒ–ç·šå½¢æ··åˆãƒ¢ãƒ‡ãƒ« (GLMM)</a>
<li><a href="6-bayesian.html">ãƒ™ã‚¤ã‚ºæ¨å®šã¨MCMC</a>
<li class="current-deck"><a href="7-stan.html">Stanã§GLM</a>
<li><a href="8-hbm.html">éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ« (HBM)</a>
</ol>

<div class="footnote">
2023-04-01 æ±äº¬åŒ»ç§‘æ­¯ç§‘å¤§å­¦
<a href="https://heavywatal.github.io/slides/tmd2022stats/">https://heavywatal.github.io/slides/tmd2022stats/</a>
</div>

```{r setup-global, include=FALSE, file = "setup.R"}
```

```{r setup-local, include=FALSE}
library(ggplot2)
library(tibble)
library(dplyr)
library(tidyr)
library(cmdstanr)
knitr::opts_chunk$set(cache = TRUE, autodep = TRUE)
```

---
## Stan

<a href="https://mc-stan.org/">
<img src="/slides/image/stan/logo_name.png" width="120" align="right">
</a>

- Stanè¨€èªã§**ãƒ¢ãƒ‡ãƒ«ã‚’æŸ”è»Ÿã«è¨˜è¿°**ã§ãã‚‹ã€‚
- C++ã§æ›¸ã‹ã‚Œã¦ã„ã¦é«˜é€Ÿã«å‹•ä½œã€‚
- Rã‚„Pythonãªã©ã‹ã‚‰å‘¼ã³å‡ºã—ã¦ä½¿ã†ã®ãŒä¾¿åˆ©ã€‚

å‰å›ã€å›å¸°ã§ã¯ãªã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¨å®šã‚’ã‚„ã£ãŸã€‚

<hr>

æ¬¡ã«ã€å›å¸°åˆ†æã‚’Stanã§ã‚„ã£ã¦ã¿ã‚‹ã€‚

---
## ç›´ç·šå›å¸°ã™ã‚‹Stanã‚³ãƒ¼ãƒ‰ã®ä¾‹

`slope * x` ã®ã‚ˆã†ãªãƒ™ã‚¯ãƒˆãƒ«æ¼”ç®—ãŒã§ãã‚‹ã€‚

```{cat, engine.opts = list(file = "stan/lm.stan"), class.source = "stan"}
data {
  int<lower=0> N;
  vector<lower=0>[N] x;
  vector[N] y;
}

parameters {
  real intercept;
  real slope;
  real<lower=0> sigma;
}

model {
  y ~ normal(intercept + slope * x, sigma);
}
```

---
## å¤‰æ•°ã®å‹: `vector` vs `array`

`vector`, `row_vector`, `matrix` ã¯å®Ÿæ•° `real` ã®ã¿ã§ã€è¡Œåˆ—æ¼”ç®—ã§ãã‚‹:

```stan
real x;
vector[3] v;
row_vector[3] r;
matrix[3, 3] m;

x * v  // vector[3]
r * v  // real
v * r  // matrix[3, 3]
m * v  // vector[3]
m * m  // matrix[3, 3]
m[1]   // row_vector[3]
```

`array` ã«å‹ã®åˆ¶ç´„ã¯ç„¡ã„ãŒã€è¡Œåˆ—æ¼”ç®—ã¯ã§ããªã„ã®ã§è‡ªåŠ›forãƒ«ãƒ¼ãƒ—:
```stan
array[3] int a;
array[3] int b;
for (i in 1:3) {
  b[i] = 2 * a[i] + 1
}
```

---
## å¤‰æ•°ã‚’ã†ã¾ãä½¿ã£ã¦å¯èª­æ€§ã‚¢ãƒƒãƒ—

é€”ä¸­è¨ˆç®—ã«åå‰ã‚’ã¤ã‘ã‚‹ã“ã¨ã§ãƒ¢ãƒ‡ãƒ«ãŒèª­ã¿ã‚„ã™ããªã‚‹:

```stan
model {
  vector[N] mu = intercept + slope * x;
  y ~ normal(mu, sigma);
}
```

`transformed parameters` ã«æ›¸ãã¨<br>
`parameters` ã¨åŒæ§˜ã«MCMCã‚µãƒ³ãƒ—ãƒ«ãŒè¨˜éŒ²ã•ã‚Œã‚‹:

```stan
transformed parameters {
  vector[N] mu = intercept + slope * x;
}

model {
  y ~ normal(mu, sigma);
}
```

ã‚³ãƒ¼ãƒ‰ã®è¦‹é€šã—ã¯è‰¯ããªã‚‹ãŒã€çµæœã®é–²è¦§ã¯ã¡ã‚‡ã£ã¨ã‚„ã‚Šã¥ã‚‰ããªã‚‹ã€‚


---
## ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®äº‹å‰åˆ†å¸ƒã‚’æ˜ç¤ºçš„ã«è¨­å®šã§ãã‚‹

ãŒã€çœç•¥ã—ã¦ã‚‚StanãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã†ã¾ãã‚„ã£ã¦ãã‚Œã‚‹ã€‚<br>
ãã®ã›ã„ã§åæŸãŒæ‚ªã„ã‹ã‚‚ã€ã¨ãªã£ã¦ã‹ã‚‰è€ƒãˆã¦ã‚‚é…ããªã„ã€‚

```stan
parameters {
  real intercept;
  real slope;
  real<lower=0> sigma;
}

model {
  y ~ normal(intercept + slope * x, sigma);
  intercept ~ normal(0, 100);
  slope ~ normal(0, 100);
  sigma ~ student_t(3, 0, 10);
}
```

---
## äº‹å‰åˆ†å¸ƒã®é¸åˆ¥

1.  ã¨ã‚Šã‚ãˆãš**ç„¡æƒ…å ±äº‹å‰åˆ†å¸ƒ** $[-\infty, \infty]$ã€‚Stanã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€‚

1.  åæŸãŒæ‚ªã‹ã£ãŸã‚‰**å¼±æƒ…å ±äº‹å‰åˆ†å¸ƒ**ã‚’è©¦ã™ã€‚<br>
    äº‹å¾Œåˆ†å¸ƒã‚’æ›´æ–°ã—ã¦ã„ã£ãŸã¨ã**äº‹å‰åˆ†å¸ƒã£ã½ã•ãŒæ®‹ã‚‰ãªã„**ã®ãŒè‰¯ã„ã€‚

    - å–ã‚Šã†ã‚‹å€¤ã‚’é€ƒã™ã‚ˆã†ãªç‹­ã™ãã‚‹åˆ†å¸ƒã¯ãƒ€ãƒ¡ã€‚
    - ç‹­ã™ãã‚‹ã‚ˆã‚Šã¯ãƒã‚·ã ãŒã€åºƒã™ãã¦ã‚‚è‰¯ããªã„ã€‚
    - ä¸€æ§˜åˆ†å¸ƒ $[a, b]$ ã¯ä¸€è¦‹ç„¡æƒ…å ±ã£ã½ãã¦è‰¯ã•ãã†ã ãŒã€<br>
      äº‹å¾Œåˆ†å¸ƒã«è£¾é‡ãŒæ®‹ã£ãŸã‚Šçµ¶å£ãŒã§ããŸã‚Šã—ãŒã¡ãªã®ã§å¾®å¦™ã€‚

    ãŠã™ã™ã‚: [**Student's tåˆ†å¸ƒ**](https://mc-stan.org/docs/functions-reference/student-t-distribution.html)
    or [**æ­£è¦åˆ†å¸ƒ**](https://mc-stan.org/docs/functions-reference/normal-distribution.html)

<cite><https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations></cite>


---
## StanãŠã™ã™ã‚å¼±æƒ…å ±äº‹å‰åˆ†å¸ƒ: Student's tåˆ†å¸ƒ

Student's $t(\nu=\nu_0, \mu = 0, \sigma = \sigma_0)$

- è‡ªç”±åº¦ $3 \le \nu_0 \le 7 $ ã§é©å½“ã«å›ºå®šã€‚
  - $\nu = 1$ ã§ã‚³ãƒ¼ã‚·ãƒ¼åˆ†å¸ƒã€‚è£¾é‡ãŒåºƒã™ãã¦è‰¯ããªã„ã‚‰ã—ã„ã€‚
  - $\nu \to \infty$ ã§**æ­£è¦åˆ†å¸ƒ**ã€‚ã ã„ãŸã„ã“ã‚Œã§ã„ã„ã‚‰ã—ã„ã€‚
- ã‚¹ã‚±ãƒ¼ãƒ« $\sigma$: ã€Œæ¨å®šã—ãŸã„å€¤ã¯$[-\sigma_0, \sigma_0]$ã«åã¾ã‚‹ã ã‚ã†ã€ã¨ã„ã†å€¤ã€‚

```{r student_t, echo = FALSE, fig.height = 4, fig.width = 9}
tidyr::crossing(x = seq(-5, 5, 0.05), df = c(1, 3, 7, Inf)) %>%
  dplyr::mutate(nu = as.factor(df), Density = dt(x, df)) %>%
  ggplot() + aes(x, Density, group = df) +
  geom_line(aes(color = nu), size = 1, alpha = 0.7) +
  scale_color_viridis_d(end = 0.88, direction = 1, guide = guide_legend(reverse = TRUE)) +
  scale_x_continuous(breaks = c(-1, 0, 1), labels = c(expression(-sigma), 0, expression(sigma))) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank(),
        panel.grid.major.y = element_blank())
```

---
## MCMCã‚µãƒ³ãƒ—ãƒ«ã‚’ä½¿ã£ã¦ãƒ™ã‚¤ã‚ºç¢ºä¿¡åŒºé–“ã‚’ä½œå›³

```stan
data {
  // ...
  int<lower=0> N_tilde
  vector[N_tilde] x_tilde;
}
// ...
generated quantities {
  array[N_tilde] real y_tilde = normal_rng(intercept + slope * x_tilde, sigma);
}
```

```{cat, engine.opts = list(file = "stan/lm-credible.stan"), cache.rebuild = !file.exists("stan/lm-credible.stan")}
data {
  int<lower=0> N;
  vector<lower=0>[N] x;
  vector[N] y;
  int<lower=0> N_tilde;
  vector[N_tilde] x_tilde;
}

parameters {
  real intercept;
  real slope;
  real<lower=0> sigma;
}

model {
  y ~ normal(intercept + slope * x, sigma);
}

generated quantities {
  array[N_tilde] real y_tilde = normal_rng(intercept + slope * x_tilde, sigma);
}
```

```{r stan-lm-generated, include = FALSE, cache.extra = file.mtime("stan/lm-credible.stan")}
n = 300L
a = 3
b = -3
df_pois = tibble::tibble(x = runif(n, 0.4, 1.7), y = rpois(n, exp(a * x + b)))
mydata = as.list(df_pois)
mydata[["N"]] = n
mydata[["x_tilde"]] = seq(0.4, 1.7, 0.1)
mydata[["N_tilde"]] = length(mydata[["x_tilde"]])

model = cmdstan_model("stan/lm-credible.stan")
fit = model$sample(mydata, show_messages = FALSE, refresh = 0)
draws = fit$draws(format = "draws_df") %>% print()

.probs = c(lower = 0.025, median = 0.5, upper = 0.975)
df_quant = draws %>%
  dplyr::summarize(across(starts_with("y_tilde"), quantile, probs = .probs)) %>%
  dplyr::mutate(label = names(.probs)) %>%
  tidyr::pivot_longer(!label, names_to = "x", values_to = "y") %>%
  dplyr::mutate(x = mydata[["x_tilde"]][readr::parse_number(x)]) %>%
  tidyr::pivot_wider(names_from = label, values_from = y)
```
```{r stan-lm-credible, echo = FALSE, fig.height = 4.5, fig.width = 6}
ggplot(df_pois) +
  aes(x) +
  geom_point(aes(y = y), shape = 16L, alpha = 0.5) +
  geom_ribbon(aes(ymin = lower, ymax = upper), data = df_quant, alpha = 0.3) +
  geom_line(aes(y = median), data = df_quant) +
  theme_bw(18)
```

---
## ğŸ”° Stanã§ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«

TODO: `5-stan-glm.ipynb`
ã‚’é–‹ã„ã¦å®Ÿè¡Œã—ã¦ã„ã“ã†ã€‚

<div class="column-container">
  <div class="column" style="flex-shrink: 2.0;">

- ç›´ç·šå›å¸°
- ãƒã‚¢ã‚½ãƒ³å›å¸°
- ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°
- é‡å›å¸°
- åˆ†æ•£åˆ†æ
- å…±åˆ†æ•£åˆ†æ

  </div>
  <div class="column" style="flex-shrink: 1.0;">
<figure>
<img height=160 src="figure/lm-bad-1.png">
<img height=160 src="figure/glm-poisson-1.png">
<img height=160 src="figure/glm-logistic-1.png"><br>
<img height=160 src="figure/multiple-regression-1.png"><br>
<img height=160 src="figure/glm-anova-1.png">
<img height=160 src="figure/glm-ancova-1.png">
</figure>
  </div>
</div>


```{cat, engine.opts = list(file = "stan/poisson.stan"), cache.rebuild = !file.exists("stan/poisson.stan")}
data {
  int<lower=0> N;
  vector<lower=0>[N] x;
  array[N] int<lower=0> y;
}

parameters {
  real intercept;
  real slope;
}

model {
  vector[N] lambda = exp(intercept + slope * x);
  y ~ poisson(lambda);
}
```


```{cat, engine.opts = list(file = "stan/multiple.stan"), cache.rebuild = !file.exists("stan/multiple.stan")}
data {
  int<lower=0> N;
  vector[N] temperature;
  vector[N] humidity;
  array[N] int<lower=0> beer_sales;
}

parameters {
  real intercept;
  real coef_t;
  real coef_h;
}

model {
  vector[N] lambda = exp(intercept + coef_t * temperature + coef_h * humidity);
  beer_sales ~ poisson(lambda);
}
```


```{cat, engine.opts = list(file = "stan/logistic.stan"), cache.rebuild = !file.exists("stan/logistic.stan")}
data {
  int<lower=0> N;
  int<lower=0> n_trials;
  vector[N] temperature;
  array[N] int<lower=0,upper=n_trials> beer_sales;
}

parameters {
  real intercept;
  real slope;
}

model {
  vector[N] p = inv_logit(intercept + slope * temperature);
  beer_sales ~ binomial(n_trials, p);
}
```

```{cat, engine.opts = list(file = "stan/anova.stan"), cache.rebuild = !file.exists("stan/anova.stan")}
data {
  int<lower=0> N;
  vector<lower=0,upper=1>[N] sunny;
  vector<lower=0,upper=1>[N] rainy;
  vector<lower=0>[N] beer_sales;
}

parameters {
  real intercept;
  real coef_s;
  real coef_r;
  real sigma;
}

model {
  vector[N] mu = intercept + coef_s * sunny + coef_r * rainy;
  beer_sales ~ normal(mu, sigma);
}
```

```{cat, engine.opts = list(file = "stan/ancova.stan"), cache.rebuild = !file.exists("stan/ancova.stan")}
data {
  int<lower=0> N;
  vector<lower=0,upper=1>[N] sunny;
  vector<lower=0,upper=1>[N] rainy;
  vector<lower=0>[N] temperature;
  vector<lower=0>[N] beer_sales;
}

parameters {
  real intercept;
  real coef_s;
  real coef_r;
  real coef_t;
  real sigma;
}

model {
  vector[N] mu = intercept +
                 coef_s * sunny +
                 coef_r * rainy +
                 coef_t * temperature;
  beer_sales ~ normal(mu, sigma);
}
```


---
## ğŸ”° Stanã§penguinsã®å›å¸°åˆ†æã‚’ã—ã¦ã¿ã‚ˆã†

<a href="https://allisonhorst.github.io/palmerpenguins/">
<cite>https://allisonhorst.github.io/palmerpenguins/</cite><br>
<img src="/slides/image/rstats/lter_penguins.png" width="45%">
<img src="/slides/image/rstats/culmen_depth.png" width="45%">
</a>

<img src="figure/penguins-interaction-1.png" height="300">

---
## ğŸ”° Stanã§penguinsã®å›å¸°åˆ†æã‚’ã—ã¦ã¿ã‚ˆã†

<a href="https://allisonhorst.github.io/palmerpenguins/">
<cite>https://allisonhorst.github.io/palmerpenguins/</cite><br>
<img src="/slides/image/rstats/lter_penguins.png" width="45%">
<img src="/slides/image/rstats/culmen_depth.png" width="45%">
</a>

`Stan does not support NA` ã¨æ€’ã‚‰ã‚Œã‚‹ã®ã§æ¬ æå€¤ã‚’å–ã‚Šé™¤ã„ã¦ãŠã:

```python
penguins = sm.datasets.get_rdataset("penguins", "palmerpenguins", True).data
penguins_dropna = penguins.dropna()
```

```{cat, engine.opts = list(file = "stan/penguins-lm.stan"), cache.rebuild = !file.exists("stan/penguins-lm.stan")}
data {
  int<lower=0> N;
  vector<lower=0>[N] body_mass_g;
  vector<lower=0>[N] flipper_length_mm;
}

parameters {
  real intercept;
  real slope;
  real<lower=0> sigma;
}

model {
  flipper_length_mm ~ normal(intercept + slope * body_mass_g, sigma);
}
```

```{cat, engine.opts = list(file = "stan/penguins-multiple.stan"), cache.rebuild = !file.exists("stan/penguins-multiple.stan")}
data {
  int<lower=0> N;
  vector<lower=0>[N] body_mass_g;
  vector<lower=0>[N] flipper_length_mm;
  array[N] int<lower=0,upper=1> sp_Chinstrap;
  array[N] int<lower=0,upper=1> sp_Gentoo;
}

parameters {
  real intercept;
  real slope;
  real b_chinstrap;
  real b_gentoo;
  real<lower=0> sigma;
}

model {
  array[N] real mu;
  for (i in 1:N) {
    mu[i] = intercept + slope * body_mass_g[i] + b_chinstrap * sp_Chinstrap[i] + b_gentoo * sp_Gentoo[i];
  }
  flipper_length_mm ~ normal(mu, sigma);
}
```


---
## å‚è€ƒæ–‡çŒ®

- [ãƒ‡ãƒ¼ã‚¿è§£æã®ãŸã‚ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€](https://amzn.to/33suMIZ) ä¹…ä¿æ‹“å¼¥ 2012
- [Stanã¨Rã§ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°](https://amzn.to/3uwx7Pb) æ¾æµ¦å¥å¤ªéƒ 2016
- [Rã¨Stanã§ã¯ã˜ã‚ã‚‹ ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿åˆ†æå…¥é–€](https://amzn.to/3o1eCzP) é¦¬å ´çœŸå“‰ 2019
- [ãƒ‡ãƒ¼ã‚¿åˆ†æã®ãŸã‚ã®æ•°ç†ãƒ¢ãƒ‡ãƒ«å…¥é–€](https://amzn.to/3uCxTKo) æ±Ÿå´è²´è£• 2020
- [åˆ†æè€…ã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿è§£é‡ˆå­¦å…¥é–€](https://amzn.to/3uznzCK) æ±Ÿå´è²´è£• 2020
- [çµ±è¨ˆå­¦ã‚’å“²å­¦ã™ã‚‹](https://amzn.to/3ty80Kv) å¤§å¡šæ·³ 2020

<a href="8-hbm.html" rel="next" class="readmore">
8. éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«
</a>
