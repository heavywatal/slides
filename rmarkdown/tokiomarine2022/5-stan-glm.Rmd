+++
url = "tokiomarine2022/5-stan-glm.html"
title = "5. Stanã§GLM â€” çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°æ¦‚è«– DSHC 2022"
linktitle = "Stanã§GLM"
date = 2022-08-24T11:10:00+09:00
type = "reveal"
draft = false
+++

<link rel="stylesheet" href="style.css">

# [çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°æ¦‚è«– DSHC 2022](.)

<div class="author">
å²©åµœ èˆª (Watal M. Iwasaki, PhD)
</div>

<div class="affiliation">
æ±åŒ—å¤§å­¦ ç”Ÿå‘½ç§‘å­¦ç ”ç©¶ç§‘ é€²åŒ–ã‚²ãƒãƒŸã‚¯ã‚¹åˆ†é‡ ç‰¹ä»»åŠ©æ•™<br>
(Graduate School of Life Sciences, Tohoku University)
</div>

<ol>
<li><a href="1-introduction.html">å°å…¥</a>
<li><a href="2-stats-model.html">çµ±è¨ˆãƒ¢ãƒ‡ãƒ«ã®åŸºæœ¬: ç¢ºç‡åˆ†å¸ƒã€å°¤åº¦</a>
<li><a href="3-glm.html">ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã€æ··åˆãƒ¢ãƒ‡ãƒ«</a>
<li><a href="4-bayesian.html">ãƒ™ã‚¤ã‚ºæ¨å®šã¨MCMC</a>
<li class="current-deck"><a href="5-stan-glm.html">Stanã§GLM</a>
<li><a href="6-stan-hbm.html">Stanã§éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«</a>
</ol>

<div class="footnote">
2022-08-24 æ±äº¬æµ·ä¸Š Data Science Hill Climb
<a href="https://heavywatal.github.io/slides/tokiomarine2022/">https://heavywatal.github.io/slides/tokiomarine2022/</a>
</div>

```{r setup-global, include=FALSE, code=readLines("setup.R")}
```

```{r setup-local, include=FALSE}
library(ggplot2)
library(tibble)
library(dplyr)
library(tidyr)
library(rstan)
rstan_options(auto_write = TRUE)
knitr::opts_chunk$set(cache = TRUE)
```

---
## Stan

<a href="https://mc-stan.org/">
<img src="/slides/image/stan/logo_name.png" width="120" align="right">
</a>

- Stanè¨€èªã§ãƒ¢ãƒ‡ãƒ«ã‚’æ›¸ã
- C++ã‚’ä»‹ã—ã¦æ©Ÿæ¢°èªã«ç¿»è¨³(ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«)ã™ã‚‹ã®ã§é«˜é€Ÿ
- Rã‚„Pythonãªã©ã‹ã‚‰å‘¼ã³å‡ºã—ã¦ä½¿ã†ã®ãŒä¾¿åˆ©

å¤§éƒ¨åˆ†ã¯Rã§èª¬æ˜ã—ã€éƒ¨åˆ†çš„ã«Pythonã§ã®ç·´ç¿’ã‚’æŒŸã¿ã¾ã™ã€‚<br>

èããªãŒã‚‰æ‰‹å…ƒã§[tokiomarine2022-stan.ipynb](tokiomarine2022-stan.ipynb)ã‚’å®Ÿè¡Œã—ã¦ã‚‚ã„ã„ã§ã™ã€‚

```r
# install.packages("rstan")
library(rstan)
rstan_options(auto_write = TRUE)
```

---
## ãŠãŠã¾ã‹ãªæµã‚Œ

```r
# ãƒ‡ãƒ¼ã‚¿æº–å‚™
mydata

# Stanè¨€èªã§æ›¸ã„ãŸãƒ¢ãƒ‡ãƒ«ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
model = rstan::stan_model(file = "model.stan")

# MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
fit = rstan::sampling(model, data = mydata)

# çµæœã‚’çœºã‚ã‚‹
print(fit)
rstan::stan_trace(fit)
rstan::stan_hist(fit)
rstan::stan_ac(fit)
```


---
## èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š: ãƒ‡ãƒ¼ã‚¿æº–å‚™

è¡¨ãŒå‡ºã‚‹ç¢ºç‡ $p=0.7$ ã®ã‚¤ã‚«ã‚µãƒã‚³ã‚¤ãƒ³ã‚’Nå›æŠ•ã’ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½œã‚‹ã€‚<br>
ã“ã® $p$ ã‚’Stanã§æ¨å®šã—ã¦ã¿ã‚ˆã†ã€‚

```{r stan-set-seed, echo = FALSE}
set.seed(42)
```
```{r stan-binom, fig.width = 4, fig.height = 4}
true_p = 0.7
N = 40L
mydata = list(N = N, x = rbinom(N, 1, true_p))
print(mydata)
```

Rãªã‚‰listå‹ã€Pythonãªã‚‰dictå‹ã«ã¾ã¨ã‚ã¦Stanã«æ¸¡ã™ã€‚


---
## èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š: Stanè¨€èªã§ãƒ¢ãƒ‡ãƒ«å®šç¾©

æ–‡å­—åˆ—ã¨ã—ã¦ä¿æŒã™ã‚‹ã‹ã€åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ã„ã¦ãŠã:

```{r read-binom-stan, code = 'cat(readr::read_file("binom.stan"))', echo = FALSE}
```

- ã„ãã¤ã‹ã®ãƒ–ãƒ­ãƒƒã‚¯ã«åˆ†ã‘ã¦è¨˜è¿°ã™ã‚‹:<br>
  R/Pythonã‹ã‚‰å—ã‘å–ã‚‹ `data`, æ¨å®šã™ã‚‹ `parameter`, æœ¬ä½“ã® `model`.
- æ•´æ•°å‹ `int`, å®Ÿæ•°å‹ `real`, ãã‚Œã‚‰ã®é…åˆ—ãŒã‚ã‚‹ã€‚
- ä¸‹é™ `lower`, ä¸Šé™ `upper` ã‚’è¨­å®šã§ãã‚‹ã€‚


---
## Stanè¨€èªã®7ç¨®ã®ãƒ–ãƒ­ãƒƒã‚¯

é †ç•ªå³å®ˆã€‚ã‚ˆãä½¿ã†ã®ã¯**å¤ªå­—ã®ã‚„ã¤**ã€‚

1. `functions {...}`
1. **`data {...}`**
1. `transformed data {...}`
1. **`parameters {...}`**
1. `transformed parameters {...}`
1. **`model {...}`**
1. `generated quantities {...}`

<https://mc-stan.org/docs/reference-manual/overview-of-stans-program-blocks.html>


---
## èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š: MCMCã‚µãƒ³ãƒ—ãƒ«

äºˆã‚å®Ÿè¡Œé€Ÿåº¦ã®é€Ÿã„æ©Ÿæ¢°èªã«ç¿»è¨³(ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«):

```{r stan-binom-model, fig.width = 4, fig.height = 4}
model = rstan::stan_model("binom.stan")
```

ã“ã‚Œã«çµæ§‹æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã§ã€å¤‰æ›´ãŒç„¡ã‘ã‚Œã°å†åˆ©ç”¨ã™ã‚‹ãŸã‚å…ˆã»ã©
`rstan_options(auto_write = TRUE)` ã—ã¦ãŠã„ãŸã€‚

<hr>

ãƒ¢ãƒ‡ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°:

```{r stan-binom-sample, fig.width = 4, fig.height = 3}
fit = rstan::sampling(model, data = mydata)
```

ã„ã‚ã„ã‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã‚ã‚‹ã‘ã©ã¨ã‚Šã‚ãˆãšãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§:<br>
`chains = 4`, `iter = 2000`, `warmup = floor(iter/2)`, `thin = 1`, ...

å•é¡ŒãŒã‚ã£ãŸã‚‰å®Ÿè¡Œçµ‚äº†æ™‚ã«è­¦å‘Šã—ã¦ãã‚Œã‚‹ã®ã§**ã¡ã‚ƒã‚“ã¨èª­ã‚€**ã€‚

---
## èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š: çµæœã‚’çœºã‚ã‚‹

$\hat R$ ã‚‚ã»ã¼1ã§ $N_\text{eff}$ ã‚‚å¤§ãã„ã®ã§ã‚ˆã•ãã†ã€‚<br>
å¿µã®ãŸã‚ trace plot ã‚‚ç¢ºèªã—ã¦ãŠã“ã†ã€‚

```{r stan-binom-fit, fig.width = 4, fig.height = 3}
print(fit)
```

ä¹±æ•°ã‚’ä½¿ã£ãŸè¨ˆç®—ãªã®ã§(ä¹±æ•°ã‚·ãƒ¼ãƒ‰ã‚’å›ºå®šã—ãªã„é™ã‚Š)æ¯å›å¤‰ã‚ã‚‹ã€‚


---
## èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š: trace plot ç¢ºèª

ã©ã®chainã‚‚ä¼¼ãŸç¯„å›²ã‚’å‹•ã„ã¦ã„ã¦ã€ã—ã£ã‹ã‚Šæ¯›è™«ã£ã½ã„:

```{r stan-binom-traceplot, fig.width = 11, fig.height = 4}
rstan::stan_trace(fit)
```

---
## èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š: è‡ªå·±ç›¸é–¢ã®ç¢ºèª

2--3ã‚¹ãƒ†ãƒƒãƒ—ãã‚‰ã„ã§è‡ªå·±ç›¸é–¢ãŒã»ã¼æ¶ˆãˆã‚‹ã®ã§å•é¡Œãªã—:

```{r stan-binom-ac, fig.width = 4, fig.height = 4}
rstan::stan_ac(fit, pars = c("p"))
```

---
## èª¬æ˜å¤‰æ•°ãªã—ã®ãƒ™ã‚¤ã‚ºæ¨å®š: æ¨å®šçµæœç¢ºèª

ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºNãŒå°ã•ã„ã›ã„ã‹è£¾é‡ã®åºƒã„æ¨å®šçµæœã€‚<br>
çœŸã®$p$ã®å€¤ã‚‚å«ã¾ã‚Œã¦ã„ã‚‹:

```{r stan-binom-hist, fig.width = 4, fig.height = 4}
rstan::stan_hist(fit, bins = 30)
```

æ¬¡ã¯ã‚‚ã†å°‘ã—ã ã‘è¤‡é›‘ãªä¾‹ã‚’è¦‹ã¦ã¿ã‚ˆã†ã€‚

---
## ç·šå½¢å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: ãƒ‡ãƒ¼ã‚¿æº–å‚™

<a href="https://allisonhorst.github.io/palmerpenguins/">
<cite>https://allisonhorst.github.io/palmerpenguins/</cite><br>
<img src="/slides/image/rstats/lter_penguins.png" width="45%">
<img src="/slides/image/rstats/culmen_depth.png" width="45%">
</a>

```{r stan-penguins-glm, echo = FALSE, fig.width = 7, fig.height = 4, warning = FALSE}
if (!require(palmerpenguins, quietly = TRUE)) {
  install.packages("palmerpenguins")
  library(palmerpenguins)
}
penguins_colors = c(Adelie = "darkorange", Chinstrap = "purple", Gentoo = "cyan4")

p_penweight = penguins %>%
  ggplot() + aes(body_mass_g, flipper_length_mm) +
  geom_point(shape = 16, alpha = 0.66) +
  scale_color_manual(values = penguins_colors) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank())

fit1 = glm(flipper_length_mm ~ body_mass_g, data = penguins)
p_penweight +
  geom_line(aes(y = pred), data = modelr::add_predictions(penguins, fit1), size = 1, color = "#3366ff")
```


---
## ç·šå½¢å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: ãƒ‡ãƒ¼ã‚¿æº–å‚™

<a href="https://allisonhorst.github.io/palmerpenguins/">
<cite>https://allisonhorst.github.io/palmerpenguins/</cite><br>
<img src="/slides/image/rstats/lter_penguins.png" width="45%">
<img src="/slides/image/rstats/culmen_depth.png" width="45%">
</a>

`Stan does not support NA` ã¨æ€’ã‚‰ã‚Œã‚‹ã®ã§æ¬ æå€¤ã‚’å–ã‚Šé™¤ã„ã¦ãŠã:

```{r stan-penguins-bill-data, echo = FALSE, fig.width = 7, fig.height = 4}
mydata = penguins %>%
  dplyr::select(c("body_mass_g", "flipper_length_mm")) %>%
  tidyr::drop_na() %>%
  as.list()
mydata$N = length(mydata$body_mass_g)
str(mydata)
```

---
## å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: Stanè¨€èªã§ãƒ¢ãƒ‡ãƒ«å®šç¾©

åˆ‡ç‰‡ã€å‚¾ãã€ã°ã‚‰ã¤ãã‚’æ¨å®šã™ã‚‹:

```{r read-penguins-stan, code = 'cat(readr::read_file("penguins.stan"))', echo = FALSE}
```


---
## å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: MCMCã‚µãƒ³ãƒ—ãƒ«

äºˆã‚å®Ÿè¡Œé€Ÿåº¦ã®é€Ÿã„æ©Ÿæ¢°èªã«ç¿»è¨³(ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«):

```{r stan-penguins-model, fig.width = 4, fig.height = 4}
model = rstan::stan_model("penguins.stan")
```

ãƒ¢ãƒ‡ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°:

```{r stan-penguins-sample, fig.width = 4, fig.height = 3}
fit = rstan::sampling(model, data = mydata)
```

ã„ã‚ã„ã‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã‚ã‚‹ã‘ã©ã¨ã‚Šã‚ãˆãšãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§:<br>
`chains = 4`, `iter = 2000`, `warmup = floor(iter/2)`, `thin = 1`, ...

å•é¡ŒãŒã‚ã£ãŸã‚‰å®Ÿè¡Œçµ‚äº†æ™‚ã«è­¦å‘Šã—ã¦ãã‚Œã‚‹ã®ã§**ã¡ã‚ƒã‚“ã¨èª­ã‚€**ã€‚

---
## å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: çµæœã‚’çœºã‚ã‚‹

$\hat R$ ã‚‚ã»ã¼1ã§ $N_\text{eff}$ ã‚‚å¤§ãã„ã®ã§ã‚ˆã•ãã†ã€‚<br>
å¿µã®ãŸã‚ trace plot ã‚‚ç¢ºèªã—ã¦ãŠã“ã†ã€‚

```{r stan-penguins-fit, fig.width = 4, fig.height = 3}
print(fit)
```


---
## å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: trace plot ç¢ºèª

ã©ã®chainã‚‚ä¼¼ãŸç¯„å›²ã‚’å‹•ã„ã¦ã„ã¦ã€ã—ã£ã‹ã‚Šæ¯›è™«ã£ã½ã„:

```{r stan-penguins-traceplot, fig.width = 11, fig.height = 4}
rstan::stan_trace(fit)
```

---
## å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: è‡ªå·±ç›¸é–¢ã®ç¢ºèª

ã©ã‚Œã‚‚ã¾ã‚ã¾ã‚ã™ãæ¶ˆãˆã‚‹ã®ã§å•é¡Œãªã—:

```{r stan-penguins-ac, fig.width = 11, fig.height = 4}
rstan::stan_ac(fit, pars = c("intercept", "slope", "sigma"))
```

---
## å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: æ¨å®šçµæœç¢ºèª

æ­£è¦åˆ†å¸ƒã£ã½ã„ãã‚Œã„ãªå½¢:

```{r stan-penguins-hist, fig.width = 11, fig.height = 3}
rstan::stan_hist(fit, bins = 30)
```

ã“ã‚Œã‚‰ã®å€¤ã‚’ä½¿ã£ã¦ç‚¹æ¨å®šãƒ»åŒºé–“æ¨å®šã‚‚å¯èƒ½ã€‚


---
## å˜å›å¸°ã®ãƒ™ã‚¤ã‚ºæ¨å®š: æ¨å®šçµæœã§å›å¸°

ç„¡äº‹ã«æœ€å°¤æ¨å®šã¨ä¼¼ãŸã‚ˆã†ãªç·šãŒå¼•ã‘ãŸã€‚

```{r stan-penguins-regression, fig.width = 4, fig.height = 4, warning = FALSE}
coef = rstan::get_posterior_mean(fit)[, "mean-all chains"]
p_penweight +
  geom_abline(intercept = coef["intercept"], slope = coef["slope"], size = 1, color = "#3366ff")
```

---
## ğŸ”° å˜å›å¸°ã®ç·´ç¿’å•é¡Œ

TODO

<hr>

â˜•ï¸ ä¼‘æ†© + è³ªç–‘å¿œç­”


---
## Stanã§é‡å›å¸°

TODO

```{r rstanarm-penguins-multi, fig.width = 8, fig.height = 5, message = FALSE, warning = FALSE}
fit = rstanarm::stan_glm(flipper_length_mm ~ body_mass_g + species, family = gaussian(), data = penguins)
pred = penguins %>% tidyr::drop_na() %>% tidybayes::add_fitted_draws(fit)
p_penweight + aes(color = species, group = species) +
  ggdist::stat_lineribbon(aes(y = .value), data = pred, size = 0.4) +
  scale_color_manual(values = penguins_colors) +
  scale_fill_brewer(palette = "Greys")
```

---
## ğŸ”° Stanã§é‡å›å¸°ã®ç·´ç¿’å•é¡Œ

TODO

<hr>

â˜•ï¸ ä¼‘æ†© + è³ªç–‘å¿œç­”


---
## Stanã§ãƒã‚¢ã‚½ãƒ³å›å¸°

TODO

<img src="figure/glm-poisson-1.png">


---
## ğŸ”° Stanã§ãƒã‚¢ã‚½ãƒ³å›å¸°ã®ç·´ç¿’å•é¡Œ

TODO

<hr>

â˜•ï¸ ä¼‘æ†© + è³ªç–‘å¿œç­”


---
## Stanã§ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°

TODO

<img src="figure/glm-logistic-1.png">


---
## ğŸ”° Stanã§ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°

TODO

<hr>

â˜•ï¸ ä¼‘æ†© + è³ªç–‘å¿œç­”

---
## å‚è€ƒæ–‡çŒ®

- [ãƒ‡ãƒ¼ã‚¿è§£æã®ãŸã‚ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€](https://amzn.to/33suMIZ) ä¹…ä¿æ‹“å¼¥ 2012
- [Stanã¨Rã§ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°](https://amzn.to/3uwx7Pb) æ¾æµ¦å¥å¤ªéƒ 2016
- [Rã¨Stanã§ã¯ã˜ã‚ã‚‹ ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿åˆ†æå…¥é–€](https://amzn.to/3o1eCzP) é¦¬å ´çœŸå“‰ 2019
- [ãƒ‡ãƒ¼ã‚¿åˆ†æã®ãŸã‚ã®æ•°ç†ãƒ¢ãƒ‡ãƒ«å…¥é–€](https://amzn.to/3uCxTKo) æ±Ÿå´è²´è£• 2020
- [åˆ†æè€…ã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿è§£é‡ˆå­¦å…¥é–€](https://amzn.to/3uznzCK) æ±Ÿå´è²´è£• 2020
- [çµ±è¨ˆå­¦ã‚’å“²å­¦ã™ã‚‹](https://amzn.to/3ty80Kv) å¤§å¡šæ·³ 2020

<a href="6-stan-hbm.html" rel="next" class="readmore">
6. Stanã§éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«
</a>
