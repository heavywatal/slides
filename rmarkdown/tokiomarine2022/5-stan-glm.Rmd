+++
url = "tokiomarine2022/5-stan-glm.html"
title = "5. Stanã§GLM â€” çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°æ¦‚è«– DSHC 2022"
linktitle = "Stanã§GLM"
date = 2022-08-24T11:10:00+09:00
type = "reveal"
draft = false
+++

<link rel="stylesheet" href="style.css">

# [çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°æ¦‚è«– DSHC 2022](.)

<div class="author">
å²©åµœ èˆª (Watal M. Iwasaki, PhD)
</div>

<div class="affiliation">
æ±åŒ—å¤§å­¦ ç”Ÿå‘½ç§‘å­¦ç ”ç©¶ç§‘ é€²åŒ–ã‚²ãƒãƒŸã‚¯ã‚¹åˆ†é‡ ç‰¹ä»»åŠ©æ•™<br>
(Graduate School of Life Sciences, Tohoku University)
</div>

<ol>
<li><a href="1-introduction.html">å°å…¥</a>
<li><a href="2-stats-model.html">çµ±è¨ˆãƒ¢ãƒ‡ãƒ«ã®åŸºæœ¬: ç¢ºç‡åˆ†å¸ƒã€å°¤åº¦</a>
<li><a href="3-glm.html">ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã€æ··åˆãƒ¢ãƒ‡ãƒ«</a>
<li><a href="4-bayesian.html">ãƒ™ã‚¤ã‚ºæ¨å®šã¨MCMC</a>
<li class="current-deck"><a href="5-stan-glm.html">Stanã§GLM</a>
<li><a href="6-stan-hbm.html">Stanã§éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«</a>
</ol>

<div class="footnote">
2022-08-24 æ±äº¬æµ·ä¸Š Data Science Hill Climb
<a href="https://heavywatal.github.io/slides/tokiomarine2022/">https://heavywatal.github.io/slides/tokiomarine2022/</a>
</div>

```{r setup-global, include=FALSE, file = "setup.R"}
```

```{r setup-local, include=FALSE}
library(ggplot2)
library(tibble)
library(dplyr)
library(tidyr)
library(cmdstanr)
knitr::opts_chunk$set(cache = TRUE, autodep = TRUE)
```

---
## Stan

<a href="https://mc-stan.org/">
<img src="/slides/image/stan/logo_name.png" width="120" align="right">
</a>

- Stanè¨€èªã§**ãƒ¢ãƒ‡ãƒ«ã‚’æŸ”è»Ÿã«è¨˜è¿°**ã§ãã‚‹ã€‚
- C++ã§æ›¸ã‹ã‚Œã¦ã„ã¦é«˜é€Ÿã«å‹•ä½œã€‚
- Rã‚„Pythonãªã©ã‹ã‚‰å‘¼ã³å‡ºã—ã¦ä½¿ã†ã®ãŒä¾¿åˆ©ã€‚

å‰å›ã€å›å¸°ã§ã¯ãªã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¨å®šã‚’ã‚„ã£ãŸã€‚

æ¬¡ã«ã€statsmodelã§æ‰±ã£ãŸå›å¸°åˆ†æã‚’Stanã§æ›¸ãç›´ã—ã¦ã¿ã‚ˆã†ã€‚

ğŸ”°
[`5-stan-glm.ipynb`](5-stan-glm.ipynb)
ã‚’Jupyterã§é–‹ãã€ã‚¹ãƒ©ã‚¤ãƒ‰èª¬æ˜ã«æ²¿ã£ã¦å®Ÿè¡Œã—ã¦ã„ã“ã†ã€‚


---
## Stanã§ç›´ç·šå›å¸°

<img src="figure/lm-bad-1.png">

```{cat, engine.opts = list(file = "lm.stan")}
data {
  int<lower=0> N;
  vector<lower=0>[N] x;
  vector[N] y;
}

parameters {
  real intercept;
  real slope;
  real sigma;
}

model {
  y ~ normal(intercept + slope * x, sigma);
}
```


---
## Stanã§ãƒã‚¢ã‚½ãƒ³å›å¸°

<img src="figure/glm-poisson-1.png">

```{cat, engine.opts = list(file = "poisson.stan")}
data {
  int<lower=0> N;
  vector<lower=0>[N] x;
  array[N] int<lower=0> y;
}

parameters {
  real intercept;
  real slope;
}

model {
  y ~ poisson(exp(intercept + slope * x));
}
```


---
## Stanã§ãƒã‚¢ã‚½ãƒ³é‡å›å¸°

<img src="figure/multiple-regression-1.png">

```{cat, engine.opts = list(file = "multiple.stan")}
data {
  int<lower=0> N;
  vector[N] temperature;
  vector[N] humidity;
  array[N] int<lower=0> beer_sales;
}

parameters {
  real intercept;
  real coef_t;
  real coef_h;
}

model {
  beer_sales ~ poisson(exp(intercept + coef_t * temperature + coef_h * humidity));
}
```


---
## Stanã§ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°

<img src="figure/glm-logistic-1.png">

```{cat, engine.opts = list(file = "logistic.stan")}
data {
  int<lower=0> N;
  int<lower=0> n_trials;
  vector[N] temperature;
  array[N] int<lower=0,upper=n_trials> beer_sales;
}

parameters {
  real intercept;
  real slope;
}

model {
  beer_sales ~ binomial(n_trials, inv_logit(intercept + slope * temperature));
}
```

---
## Stanã§åˆ†æ•£åˆ†æ

<img src="figure/glm-anova-1.png">

```{cat, engine.opts = list(file = "anova.stan")}
data {
  int<lower=0> N;
  vector<lower=0,upper=1>[N] sunny;
  vector<lower=0,upper=1>[N] rainy;
  vector<lower=0>[N] beer_sales;
}

parameters {
  real intercept;
  real coef_s;
  real coef_r;
  real sigma;
}

model {
  beer_sales ~ normal(intercept + coef_s * sunny + coef_r * rainy, sigma);
}
```


---
## Stanã§å…±åˆ†æ•£åˆ†æ

<img src="figure/glm-ancova-1.png">

```{cat, engine.opts = list(file = "ancova.stan")}
data {
  int<lower=0> N;
  vector<lower=0,upper=1>[N] sunny;
  vector<lower=0,upper=1>[N] rainy;
  vector<lower=0>[N] temperature;
  vector<lower=0>[N] beer_sales;
}

parameters {
  real intercept;
  real coef_s;
  real coef_r;
  real coef_t;
  real sigma;
}

model {
  beer_sales ~ normal(intercept + coef_s * sunny +
                                  coef_r * rainy +
                                  coef_t * temperature, sigma);
}
```


---
## ğŸ”° Stanã§penguinsã®å›å¸°åˆ†æã‚’ã—ã¦ã¿ã‚ˆã†

<a href="https://allisonhorst.github.io/palmerpenguins/">
<cite>https://allisonhorst.github.io/palmerpenguins/</cite><br>
<img src="/slides/image/rstats/lter_penguins.png" width="45%">
<img src="/slides/image/rstats/culmen_depth.png" width="45%">
</a>

<img src="figure/penguins-interaction-1.png" height="300">

---
## ğŸ”° Stanã§penguinsã®å›å¸°åˆ†æã‚’ã—ã¦ã¿ã‚ˆã†

<a href="https://allisonhorst.github.io/palmerpenguins/">
<cite>https://allisonhorst.github.io/palmerpenguins/</cite><br>
<img src="/slides/image/rstats/lter_penguins.png" width="45%">
<img src="/slides/image/rstats/culmen_depth.png" width="45%">
</a>

`Stan does not support NA` ã¨æ€’ã‚‰ã‚Œã‚‹ã®ã§æ¬ æå€¤ã‚’å–ã‚Šé™¤ã„ã¦ãŠã:

```python
penguins = sm.datasets.get_rdataset("penguins", "palmerpenguins", True).data
penguins_dropna = penguins.dropna()
```

```{cat, engine.opts = list(file = "penguins-lm.stan")}
data {
  int<lower=0> N;
  vector<lower=0>[N] body_mass_g;
  vector<lower=0>[N] flipper_length_mm;
}

parameters {
  real intercept;
  real slope;
  real<lower=0> sigma;
}

model {
  flipper_length_mm ~ normal(intercept + slope * body_mass_g, sigma);
}
```

```{cat, engine.opts = list(file = "penguins-multiple.stan")}
data {
  int<lower=0> N;
  vector<lower=0>[N] body_mass_g;
  vector<lower=0>[N] flipper_length_mm;
  array[N] int<lower=0,upper=1> sp_Chinstrap;
  array[N] int<lower=0,upper=1> sp_Gentoo;
}

parameters {
  real intercept;
  real slope;
  real b_chinstrap;
  real b_gentoo;
  real<lower=0> sigma;
}

model {
  array[N] real mu;
  for (i in 1:N) {
    mu[i] = intercept + slope * body_mass_g[i] + b_chinstrap * sp_Chinstrap[i] + b_gentoo * sp_Gentoo[i];
  }
  flipper_length_mm ~ normal(mu, sigma);
}
```


---
## å‚è€ƒæ–‡çŒ®

- [ãƒ‡ãƒ¼ã‚¿è§£æã®ãŸã‚ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€](https://amzn.to/33suMIZ) ä¹…ä¿æ‹“å¼¥ 2012
- [Stanã¨Rã§ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°](https://amzn.to/3uwx7Pb) æ¾æµ¦å¥å¤ªéƒ 2016
- [Rã¨Stanã§ã¯ã˜ã‚ã‚‹ ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿åˆ†æå…¥é–€](https://amzn.to/3o1eCzP) é¦¬å ´çœŸå“‰ 2019
- [ãƒ‡ãƒ¼ã‚¿åˆ†æã®ãŸã‚ã®æ•°ç†ãƒ¢ãƒ‡ãƒ«å…¥é–€](https://amzn.to/3uCxTKo) æ±Ÿå´è²´è£• 2020
- [åˆ†æè€…ã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿è§£é‡ˆå­¦å…¥é–€](https://amzn.to/3uznzCK) æ±Ÿå´è²´è£• 2020
- [çµ±è¨ˆå­¦ã‚’å“²å­¦ã™ã‚‹](https://amzn.to/3ty80Kv) å¤§å¡šæ·³ 2020

<a href="6-stan-hbm.html" rel="next" class="readmore">
6. Stanã§éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«
</a>
