+++
url = "tokiomarine2022/6-stan-hbm.html"
title = "6. Stanã§éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ« â€” çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°æ¦‚è«– DSHC 2022"
linktitle = "Stanã§éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«"
date = 2022-08-24T15:30:00+09:00
type = "reveal"
draft = false
+++

<link rel="stylesheet" href="style.css">

# [çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°æ¦‚è«– DSHC 2022](.)

<div class="author">
å²©åµœ èˆª (Watal M. Iwasaki, PhD)
</div>

<div class="affiliation">
æ±åŒ—å¤§å­¦ ç”Ÿå‘½ç§‘å­¦ç ”ç©¶ç§‘ é€²åŒ–ã‚²ãƒãƒŸã‚¯ã‚¹åˆ†é‡ ç‰¹ä»»åŠ©æ•™<br>
(Graduate School of Life Sciences, Tohoku University)
</div>

<ol>
<li><a href="1-introduction.html">å°å…¥</a>
<li><a href="2-stats-model.html">çµ±è¨ˆãƒ¢ãƒ‡ãƒ«ã®åŸºæœ¬: ç¢ºç‡åˆ†å¸ƒã€å°¤åº¦</a>
<li><a href="3-glm.html">ä¸€èˆ¬åŒ–ç·šå½¢ãƒ¢ãƒ‡ãƒ«ã€æ··åˆãƒ¢ãƒ‡ãƒ«</a>
<li><a href="4-bayesian.html">ãƒ™ã‚¤ã‚ºæ¨å®šã¨MCMC</a>
<li><a href="5-stan-glm.html">Stanã§GLM</a>
<li class="current-deck"><a href="6-stan-hbm.html">Stanã§éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«</a>
</ol>

<div class="footnote">
2022-08-24 æ±äº¬æµ·ä¸Š Data Science Hill Climb
<a href="https://heavywatal.github.io/slides/tokiomarine2022/">https://heavywatal.github.io/slides/tokiomarine2022/</a>
</div>

```{r setup-global, include=FALSE, file = "setup.R"}
```

```{r setup-local, include=FALSE}
library(ggplot2)
library(tibble)
library(dplyr)
library(tidyr)
library(cmdstanr)
knitr::opts_chunk$set(cache = TRUE, autodep = TRUE)
```

---
## GLMMã§ç™»å ´ã—ãŸå€‹ä½“å·®ã‚’éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã§

<figure>
<a href="https://kuboweb.github.io/-kubo/ce/LinksGlm.html">
<img src="../tokiomarine2021/image/kubo-p2.png" width="100%">
<figcaption class="url">ä¹…ä¿ã•ã‚“ https://kuboweb.github.io/-kubo/ce/LinksGlm.html</figcaption>
</a>
</figure>


---
## GLMMã§ç™»å ´ã—ãŸå€‹ä½“å·®ã‚’éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã§

æ¤ç‰©100å€‹ä½“ã‹ã‚‰8å€‹ãšã¤ç¨®å­ã‚’å–ã£ã¦æ¤ãˆãŸã‚‰å…¨ä½“ã§åŠåˆ†ã¡ã‚‡ã„ç™ºèŠ½ã€‚<br>
è¦ª1å€‹ä½“ã‚ãŸã‚Šã®ç”Ÿå­˜æ•°ã¯<span style="color: #3366ff;">n=8ã®äºŒé …åˆ†å¸ƒ</span>ã«ãªã‚‹ã¯ãšã ã‘ã©ã€<br>
æ¥µç«¯ãªå€¤(å…¨éƒ¨æ­»äº¡ã€å…¨éƒ¨ç”Ÿå­˜)ãŒå¤šã‹ã£ãŸã€‚å€‹ä½“å·®ï¼Ÿ

<img src="figure/overdispersion-1.png" alt="plot of chunk overdispersion">


---
## éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ¡ãƒ¼ã‚¸å›³

äº‹å‰åˆ†å¸ƒã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã€ã•ã‚‰ã«äº‹å‰åˆ†å¸ƒã‚’è¨­å®šã™ã‚‹ã®ã§éšå±¤ãƒ™ã‚¤ã‚º

<figure>
<img src="../tokiomarine2021/hbm.drawio.svg">
</figure>


---
## ã•ã£ãã®å›³ã‚’Stanè¨€èªã§è¨˜è¿°ã™ã‚‹ã¨

ãŠçµµæããƒ¢ãƒ‡ãƒ«ã¨Stanãƒ¢ãƒ‡ãƒ«ã‚’è¦‹æ¯”ã¹ã¦ã¿ã‚ˆã†ã€‚

```{cat glmm-stan, engine.opts = list(file = "glmm.stan"), class.source = "stan"}
data {
  int<lower=0> N;
  array[N] int<lower=0> y;
}

parameters {
  real a;           // mean ability
  vector[N] r;      // individual difference
  real<lower=0> s;  // sd of r
}

model {
  y ~ binomial(8, inv_logit(a + r));
  a ~ normal(0, 10);
  r ~ normal(0, s);
  s ~ exponential(0.01);
//  s ~ exponential(0.01);
}
```

`inv_logit(a + r)` ãŒ p ã«ç›¸å½“ã€‚<br>
`10` ã¨ã‹ `0.01` ã¨ã‹ã€ã‚¨ã‚¤ãƒ¤ã£ã¨æ±ºã‚ã¦ã‚‹ã‚„ã¤ãŒè¶…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‚

---
## å¤‰é‡åŠ¹æœãŒå…¥ã£ãŸæ¨å®šçµæœ

```{r stan-glmm-prep, echo=FALSE, fig.width = 4, fig.height = 3, message = FALSE, result = FALSE}
ninds = 100L
mu_ind = 0.5
sd_ind = 3
df_od = tibble::tibble(
  z = rnorm(ninds, mu_ind, sd_ind),
  p = wtl::sigmoid(z),
  y = rbinom(ninds, 8L, p))
# sum_y = sum(df_od$y)
# p_hat = sum_y / 800
# tidy_od = df_od %>%
#   dplyr::count(y, name = "observed") %>%
#   dplyr::mutate(expected = ninds * dbinom(y, 8, p_hat)) %>%
#   tidyr::pivot_longer(!y, names_to = "key", values_to = "count") %>%
#   dplyr::mutate(width = ifelse(key == "expected", 0.8, 0.4), alpha = ifelse(key == "expected", 0.5, 1))
mydata = list(y = df_od$y, N = ninds)
model = cmdstan_model("glmm.stan")
fit = model$sample(data = mydata, step_size = 0.1, refresh = 0)
```

```{r stan-glmm-print, echo = FALSE, fig.width = 4, fig.height = 3}
print(fit)
```

---
## æŠœç²‹ã—ã¦ä½œå›³ã€‚æ‚ªããªã„ã€‚

ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã®çœŸã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å€¤ã¯ $a = 0.5,~s = 3.0$ ã ã£ãŸã€‚

```{r stan-glmm, echo = FALSE, fig.width = 11, fig.height = 7}
draws = fit$draws(c("a", "s", "r[1]", "r[2]"))
p_trace = bayesplot::mcmc_trace(draws) + coord_flip()
p_hist = bayesplot::mcmc_hist(draws, bins = 30)
cowplot::plot_grid(p_trace, p_hist, ncol = 1L)
```


---
## äº‹å‰åˆ†å¸ƒã®é¸åˆ¥

1.  ã¨ã‚Šã‚ãˆãš**ç„¡æƒ…å ±äº‹å‰åˆ†å¸ƒ** $[-\infty, \infty]$ã€‚Stanã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€‚

1.  åæŸãŒæ‚ªã‹ã£ãŸã‚‰**å¼±æƒ…å ±äº‹å‰åˆ†å¸ƒ**ã‚’è©¦ã™ã€‚<br>
    äº‹å¾Œåˆ†å¸ƒã‚’æ›´æ–°ã—ã¦ã„ã£ãŸã¨ã**äº‹å‰åˆ†å¸ƒã£ã½ã•ãŒæ®‹ã‚‰ãªã„**ã®ãŒè‰¯ã„ã€‚

    - å–ã‚Šã†ã‚‹å€¤ã‚’é€ƒã™ã‚ˆã†ãªç‹­ã™ãã‚‹åˆ†å¸ƒã¯ãƒ€ãƒ¡ã€‚
    - ç‹­ã™ãã‚‹ã‚ˆã‚Šã¯ãƒã‚·ã ãŒã€åºƒã™ãã¦ã‚‚è‰¯ããªã„ã€‚
    - ä¸€æ§˜åˆ†å¸ƒ $[a, b]$ ã¯ä¸€è¦‹ç„¡æƒ…å ±ã£ã½ãã¦è‰¯ã•ãã†ã ãŒã€<br>
      äº‹å¾Œåˆ†å¸ƒã«è£¾é‡ãŒæ®‹ã£ãŸã‚Šçµ¶å£ãŒã§ããŸã‚Šã—ãŒã¡ãªã®ã§å¾®å¦™ã€‚

    ãŠã™ã™ã‚: **Student's tåˆ†å¸ƒ**ã€æ­£è¦åˆ†å¸ƒã€æŒ‡æ•°åˆ†å¸ƒãªã©ã€‚

<cite><https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations></cite>


---
## StanãŠã™ã™ã‚å¼±æƒ…å ±äº‹å‰åˆ†å¸ƒ: Student's tåˆ†å¸ƒ

Student's $t(\nu=\nu_0, \mu = 0, \sigma = \sigma_0)$

- è‡ªç”±åº¦ $\nu$: å°ã•ã„ã»ã©è£¾é‡ãŒåºƒã„ã€‚$3 \le \nu_0 \le 7 $ ã§é©å½“ã«å›ºå®šã€‚
- ã‚¹ã‚±ãƒ¼ãƒ« $\sigma$: ã€Œæ¨å®šã—ãŸã„å€¤ã¯$[-\sigma_0, \sigma_0]$ã«åã¾ã‚‹ã ã‚ã†ã€ã¨ã„ã†å€¤ã€‚

```{r student_t, echo = FALSE, fig.height = 5, fig.width = 10}
tidyr::crossing(x = seq(-5, 5, 0.05), df = c(1, 3, 7, Inf)) %>%
  dplyr::mutate(nu = as.factor(df), Density = dt(x, df)) %>%
  ggplot() + aes(x, Density, group = df) +
  geom_line(aes(color = nu), size = 1, alpha = 0.7) +
  scale_color_viridis_d(end = 0.88, direction = 1, guide = guide_legend(reverse = TRUE)) +
  scale_x_continuous(breaks = c(-1, 0, 1), labels = c(expression(-sigma), 0, expression(sigma))) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank(), axis.ticks = element_blank(),
        panel.grid.major.y = element_blank())
```

æ­£ã®å€¤ã—ã‹å–ã‚‰ãªã„å ´åˆã¯ `<lower=0>` ã¨ã—ã¦å³åŠåˆ†ã ã‘ä½¿ã†ã¨ã‹ã€‚


---
## ğŸ”° éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã®ç·´ç¿’å•é¡Œ

[`6-stan-hbm.ipynb`](6-stan-hbm.ipynb)
ã‚’Jupyterã§é–‹ãã€ã‚¹ãƒ©ã‚¤ãƒ‰èª¬æ˜ã«æ²¿ã£ã¦å®Ÿè¡Œã—ã¦ã„ã“ã†ã€‚


TODO: æ™‚é–“ãŒä½™ã£ãŸå ´åˆã®ç·´ç¿’å•é¡Œ


---
## éç·šå½¢å›å¸°ã®ä¾‹: ãƒ‡ãƒ¼ã‚¿

åˆºæ¿€å¼·åº¦xã«å¯¾ã™ã‚‹å¿œç­”å¼·åº¦yã‚’20å€‹ä½“èª¿æŸ»ã€‚<br>
éå¯¾ç§°ãªã²ã¨å±±ã€‚å¿œç­”å¤‰æ•°ã‚‚èª¬æ˜å¤‰æ•°ã‚‚æ­£ã®å€¤ã€‚

<div>\[\begin{split}
y = ae ^ {-bx} - ce ^ {-dx}
\end{split}\]</div>

```{r non-linear, echo = FALSE, fig.width = 10, fig.height = 5}
expo = function(x, y0, lambda) y0 * exp(- lambda * x)

genfunc = function(params) {
  function(x) {
    expo(x, params["a"], params["b"]) - expo(x, params["c"], params["d"])
  }
}

params = c(a = 0.08, b = 0.01, c = 0.05, d = 0.05)
func = genfunc(params)
n_inds = 20L
sd_inds = 0.005
shape = 60
min_ipi = 5
intercept = sort(rnorm(n_inds, 0, sd_inds))
df = tidyr::crossing(id = seq_len(n_inds), x = seq(min_ipi, 105, 10)) %>%
  dplyr::mutate(y = rgamma(length(x), shape = shape, scale = (func(x) + intercept[id]) / shape))

p_base = ggplot(df) + aes(x, y) +
  geom_point(aes(color = id), alpha = 0.7, shape = 16, size = 3) +
  geom_line(aes(color = id, group = id), alpha = 0.2) +
  xlim(0, NA) + ylim(0, NA) +
  geom_function(fun = func) +
  theme_bw(base_size = 20) +
  theme(panel.grid.minor = element_blank())

p_base
```

---
## éç·šå½¢å›å¸°ã®ä¾‹: Stanã‚³ãƒ¼ãƒ‰

```stan
data {
  int<lower=1> N;
  vector[N] x;
  vector[N] y;
  int id[N];
  int<lower=1> Ninds;
}

parameters {
  real a;
  real d;
  real<upper=a> c;
  real<upper=d> b;
  real shape;
  vector[Ninds] intercept;
}

model {
  vector[N] mu = a * exp(-b * x) - (a - c) * exp(-d * x) + intercept[id];
  y ~ gamma(shape, shape ./ mu);
  a ~ exponential(1);
  b ~ exponential(1);
  c ~ exponential(1);
  d ~ exponential(1);
  shape ~ exponential(0.001);
  intercept ~ normal(0, 0.005);
}
```



---
## éšå±¤ãƒ™ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã®ã»ã‹ã®å¿œç”¨å…ˆ

- æ™‚ç³»åˆ—ãƒ¢ãƒ‡ãƒ« (çŠ¶æ…‹ç©ºé–“ãƒ¢ãƒ‡ãƒ«)
- ç©ºé–“æ§‹é€ ã®ã‚ã‚‹ãƒ¢ãƒ‡ãƒ« (e.g., CARãƒ¢ãƒ‡ãƒ«)
- æ¬ æå€¤ã®è£œå®Œ



---
## ãƒ™ã‚¤ã‚ºæ¨å®šã¾ã¨ã‚

- æ¡ä»¶ä»˜ãç¢ºç‡ $\text{Prob}(B \mid A)$ ã®ç†è§£ãŒå¤§äº‹ã€‚
    - äº‹å¾Œåˆ†å¸ƒ $\propto$ å°¤åº¦ â¨‰ äº‹å‰åˆ†å¸ƒ
    - ç¢ºä¿¡åº¦åˆã„ã‚’ãƒ‡ãƒ¼ã‚¿ã§æ›´æ–°ã—ã¦ã„ãã€‚
- æ¨å®šçµæœã¯åˆ†å¸ƒãã®ã‚‚ã®ã€‚
    - ãã“ã‹ã‚‰ç‚¹æ¨å®šã‚‚åŒºé–“æ¨å®šã‚‚å¯èƒ½ã€‚
- è§£æçš„ã«è§£ã‘ãªã„å•é¡Œã¯è¨ˆç®—æ©Ÿã«ä¹±æ•°ã‚’æŒ¯ã‚‰ã›ã¦è§£ãã€‚
    - ç†è«–ãƒ»æŠ€è¡“ã®é€²æ­©ãŒç›®è¦šã¾ã—ã„ã€‚


---
## å›å¸°åˆ†æãµã‚Šã‹ãˆã‚Š

ã‚ˆã‚ŠæŸ”è»Ÿã«ãƒ¢ãƒ‡ãƒ«ã‚’è¨˜è¿°ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚è¨ˆç®—æ–¹æ³•ã‚‚å¤‰åŒ–ã€‚

<figure>
<a href="https://kuboweb.github.io/-kubo/ce/LinksGlm.html">
<img src="../tokiomarine2021/image/kubo-p2.png" width="100%">
<figcaption class="url">ä¹…ä¿ã•ã‚“ https://kuboweb.github.io/-kubo/ce/LinksGlm.html</figcaption>
</a>
</figure>


---
## å…¨ä½“ã¾ã¨ã‚

- çµ±è¨ˆã¨ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’ã†ã¾ãã¾ã¨ã‚ã€ãã‚Œã«åŸºã¥ã„ã¦æ¨è«–ã™ã‚‹ãŸã‚ã®æ‰‹æ³•ã€‚
- ãƒ¢ãƒ‡ãƒ«ã«ã¯**ç†è§£å¿—å‘**ã¨**å¿œç”¨å¿—å‘**ãŒã‚ã‚Šã€çµ±è¨ˆãƒ¢ãƒ‡ãƒ«ã¯å‰è€…å¯„ã‚Šã€‚
    - ã©ã¡ã‚‰ã‚‚å¤šå°‘ã¯åˆ†ã‹ã£ãŸä¸Šã§ä½¿ã„åˆ†ã‘ãŸã„ã€‚
    - ã©ã£ã¡ã«ã—ã‚çœŸã®æ­£ã—ã„ä½•ã‹ã§ã¯ãªã„ã€‚
- **ç¢ºç‡åˆ†å¸ƒ**ã¨ãã®èƒŒå¾Œã«ã‚ã‚‹**ç¢ºç‡éç¨‹**ã®ç†è§£ãŒé‡è¦ã€‚
    - ä¹±æ•°ç”Ÿæˆâ†’ä½œå›³ã‚’ç¹°ã‚Šè¿”ã—ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ´ã‚‚ã†ã€‚
    - MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‚‚äº‹å¾Œåˆ†å¸ƒã‹ã‚‰ã®ä¹±æ•°ç”Ÿæˆã€‚


---
## å‚è€ƒæ–‡çŒ®

- [ãƒ‡ãƒ¼ã‚¿è§£æã®ãŸã‚ã®çµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€](https://amzn.to/33suMIZ) ä¹…ä¿æ‹“å¼¥ 2012
- [Stanã¨Rã§ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°](https://amzn.to/3uwx7Pb) æ¾æµ¦å¥å¤ªéƒ 2016
- [Rã¨Stanã§ã¯ã˜ã‚ã‚‹ ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿åˆ†æå…¥é–€](https://amzn.to/3o1eCzP) é¦¬å ´çœŸå“‰ 2019
- [ãƒ‡ãƒ¼ã‚¿åˆ†æã®ãŸã‚ã®æ•°ç†ãƒ¢ãƒ‡ãƒ«å…¥é–€](https://amzn.to/3uCxTKo) æ±Ÿå´è²´è£• 2020
- [åˆ†æè€…ã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿è§£é‡ˆå­¦å…¥é–€](https://amzn.to/3uznzCK) æ±Ÿå´è²´è£• 2020
- [çµ±è¨ˆå­¦ã‚’å“²å­¦ã™ã‚‹](https://amzn.to/3ty80Kv) å¤§å¡šæ·³ 2020

<a href="." class="readmore">
ç›®æ¬¡ã«æˆ»ã‚‹
</a>
