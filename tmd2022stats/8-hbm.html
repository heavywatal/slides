<!DOCTYPE html>
<html>
<head prefix="og: http://ogp.me/ns#">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<title>8. 階層ベイズモデル (HBM) — 統計モデリング実習 2022 TMDU</title>
<meta name="author" content="Watal M. Iwasaki">
<meta property="og:title" content="8. 階層ベイズモデル (HBM) — 統計モデリング実習 2022 TMDU">
<meta property="og:type" content="article">
<meta property="og:url" content="https://heavywatal.github.io/slides/tmd2022stats/8-hbm.html">
<meta property="og:image" content="https://avatars.githubusercontent.com/heavywatal">
<meta property="og:description" content="">
<meta property="og:site_name" content="Slide decks — Heavy Watal">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@heavywatal">
<meta name="twitter:creator" content="@heavywatal">
<link rel="stylesheet" href="/lib/katex/katex.min.css">
<script defer src="/lib/katex/katex.min.js"></script>
<script defer src="/lib/katex/contrib/auto-render.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  renderMathInElement(document.body, {
    delimiters: [
      {left: "\\[", right: "\\]", display: true},
      {left: "$", right: "$", display: false}
    ]
  });
});
</script>
<style>
.katex {
  font-size: 1.12em;
}

.katex-display > .katex {
  text-align: left;
  padding-left: 2rem;
}
</style>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-V60H2JH0G6"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-V60H2JH0G6', { 'anonymize_ip': false });
}
</script>
<link rel="stylesheet" href="/slides/lib/reveal.js/reveal.css">
<script defer src="/slides/lib/reveal.js/reveal.js"></script>
<script defer src="/slides/lib/reveal.js/plugin/notes/notes.js"></script>
<script defer src="/slides/lib/reveal.js/plugin/search/search.js"></script>
<script defer src="/slides/lib/reveal-initialize.js"></script>
<script>
window.addEventListener('DOMContentLoaded', function() {
  Reveal.configure({width: 1333, height: 1000});
  document.querySelector('html').style.fontSize = '222%';
})
</script>
<script defer src="/slides/lib/reload-img-onclick.js"></script>
<link rel="stylesheet" href="/slides/css/theme-reveal.css">
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="reveal">
<div class="slides">
<section>
<h1 id="統計モデリング実習-2022-tmdu"><a href=".">統計モデリング実習 2022 TMDU</a></h1>
<div class="author">
岩嵜 航 (Watal M. Iwasaki, PhD)
</div>
<div class="affiliation">
東北大学 生命科学研究科 進化ゲノミクス分野 特任助教<br>
(Graduate School of Life Sciences, Tohoku University)
</div>
<ol>
<li><a href="1-introduction.html">導入、直線回帰</a>
<li><a href="2-distribution.html">確率分布、擬似乱数生成</a>
<li><a href="3-likelihood.html">尤度、最尤推定</a>
<li><a href="4-glm.html">一般化線形モデル (GLM)</a>
<li><a href="5-glmm.html">個体差、一般化線形混合モデル (GLMM)</a>
<li><a href="6-bayesian.html">ベイズの定理、事後分布、MCMC</a>
<li><a href="7-stan.html">StanでGLM</a>
<li class="current-deck"><a href="8-hbm.html">階層ベイズモデル (HBM)</a>
</ol>
<div class="footnote">
2023-04-01 東京医科歯科大学<br>
<a href="https://heavywatal.github.io/slides/tmd2022stats/">https://heavywatal.github.io/slides/tmd2022stats/</a>
</div>

</section>
<section>
<h2 id="glmmで登場した個体差を階層ベイズモデルで">GLMMで登場した個体差を階層ベイズモデルで</h2>
<figure>
<a href="https://kuboweb.github.io/-kubo/ce/LinksGlm.html">
<img src="../tokiomarine2021/image/kubo-p2.png" width="1000">
<figcaption class="url">久保さん https://kuboweb.github.io/-kubo/ce/LinksGlm.html</figcaption>
</a>
</figure>

</section>
<section>
<h2 id="glmmで登場した個体差を階層ベイズモデルで">GLMMで登場した個体差を階層ベイズモデルで</h2>
<p>植物100個体から8個ずつ種子を取って植えたら全体で半分ちょい発芽。<br>
親1個体あたりの生存数は<span style="color: #3366ff;">n=8の二項分布</span>になるはずだけど、<br>
極端な値(全部死亡、全部生存)が多かった。個体差？</p>
<img src="figure/overdispersion-1.png" alt="plot of chunk overdispersion">
</section>
<section>
<h2 id="個体差をモデルに組み込みたい">個体差をモデルに組み込みたい</h2>
<p>各個体の生存率$p_i$をそのままパラメータにすると<strong>過剰適合</strong>。<br>
「パラメータ数 ≥ サンプルサイズ」の“データ読み上げ”モデル。<br>
i.e., この個体は4個生き残って生存率0.5だね。次の個体は2個体だから&hellip;&hellip;</p>
<img src="figure/saturated-glmm-1.png" alt="plot of chunk saturated-glmm">
<p>個体の生存能力をもっと少ないパラメータで表現できないか？</p>

</section>
<section>
<h2 id="個体差をモデルに組み込みたい">個体差をモデルに組み込みたい</h2>
<p>各個体の生存率$p_i$が能力値$z_i$のシグモイド関数で決まると仮定。<br>
その能力値は全個体共通の正規分布に従うと仮定:
$z_i \sim \mathcal{N}(\hat z, \sigma)$</p>
<img src="figure/sigmoid-1.png" alt="plot of chunk sigmoid">
<p>パラメータ2つで済む: 平均 $\hat z$, ばらつき $\sigma$ 。</p>
<p>前者は標本平均 $\hat p$ から求まるとして、後者どうする？</p>

</section>
<section>
<h2 id="個体能力のばらつき-sigma-が大きいと両端が増える">個体能力のばらつき $\sigma$ が大きいと両端が増える</h2>
<p>普通の二項分布は個体差無し $\sigma = 0$ を仮定してるのと同じ。</p>
<img src="figure/alter-sigma-1.png" alt="plot of chunk alter-sigma">
<img src="figure/alter-sigma-2.png" alt="plot of chunk alter-sigma">
</section>
<section>
<h2 id="zの値で色分けしてみると想像しやすい">zの値で色分けしてみると想像しやすい</h2>
<p>正規分布と二項分布の混ぜ合わせ&hellip;&hellip;?</p>
<img src="figure/alter-sigma-z-1.png" alt="plot of chunk alter-sigma-z">
<img src="figure/alter-sigma-z-2.png" alt="plot of chunk alter-sigma-z">
</section>
<section>
<h2 id="階層ベイズモデルのイメージ図">階層ベイズモデルのイメージ図</h2>
<p>事前分布のパラメータに、さらに事前分布を設定するので階層ベイズ</p>
<figure>
<img src="../tokiomarine2022/hbm.drawio.svg" width="800">
</figure>

</section>
<section>
<h2 id="さっきの図をstan言語で記述すると">さっきの図をStan言語で記述すると</h2>
<p><code>10</code> とか <code>3</code> とか、エイヤっと決めてるやつが超パラメータ。</p>
<pre tabindex="0"><code class="language-stan" data-lang="stan">data {
  int&lt;lower=0&gt; N;
  array[N] int&lt;lower=0&gt; y;
}

parameters {
  real z_hat;           // mean ability
  real&lt;lower=0&gt; sigma;  // sd of r
  vector[N] r;          // individual difference
}

transformed parameters {
  vector[N] z = z_hat + r;
  vector[N] p = inv_logit(z);
}

model {
  y ~ binomial(8, p);
  z_hat ~ normal(0, 10);
  r ~ normal(0, sigma);
  sigma ~ student_t(3, 0, 1);
}
</code></pre>
</section>
<section>
<h2 id="変量効果が入った推定結果">変量効果が入った推定結果</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">seeds_data</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="n">df_seeds_od</span><span class="o">$</span><span class="n">y</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">samplesize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">model</span> <span class="o">=</span> <span class="nf">cmdstan_model</span><span class="p">(</span><span class="s">&#34;stan/glmm.stan&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fit</span> <span class="o">=</span> <span class="n">model</span><span class="o">$</span><span class="nf">sample</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">seeds_data</span><span class="p">,</span> <span class="n">seed</span> <span class="o">=</span> <span class="m">19937L</span><span class="p">,</span> <span class="n">step_size</span> <span class="o">=</span> <span class="m">0.1</span><span class="p">,</span> <span class="n">refresh</span> <span class="o">=</span> <span class="m">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">draws</span> <span class="o">=</span> <span class="n">fit</span><span class="o">$</span><span class="nf">draws</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#34;z_hat&#34;</span><span class="p">,</span> <span class="s">&#34;sigma&#34;</span><span class="p">,</span> <span class="s">&#34;r[1]&#34;</span><span class="p">,</span> <span class="s">&#34;r[2]&#34;</span><span class="p">))</span>
</span></span></code></pre></div><pre tabindex="0"><code> variable    mean  median   sd  mad      q5     q95 rhat ess_bulk ess_tail
    lp__  -455.60 -455.30 9.34 9.25 -471.31 -441.11 1.00      784     1292
    z_hat    0.25    0.25 0.30 0.30   -0.24    0.74 1.00      777     1266
    sigma    2.77    2.75 0.34 0.33    2.26    3.37 1.00     1145     1581
    r[1]    -0.23   -0.25 0.78 0.74   -1.51    1.08 1.00     3484     2638
    r[2]     1.79    1.72 1.09 1.06    0.17    3.78 1.00     4776     2441
    r[3]     1.74    1.65 1.07 0.99    0.17    3.66 1.00     4304     2656
    r[4]    -3.73   -3.54 1.60 1.49   -6.69   -1.51 1.00     4847     2537
    r[5]    -2.20   -2.13 1.02 1.01   -4.00   -0.65 1.00     4411     2449
    r[6]    -2.17   -2.10 1.02 0.95   -4.00   -0.64 1.00     4336     2545
    r[7]     0.92    0.90 0.87 0.85   -0.45    2.40 1.00     4167     2377

 # showing 10 of 303 rows (change via &#39;max_rows&#39; argument or &#39;cmdstanr_max_rows&#39; option)
</code></pre>
</section>
<section>
<h2 id="抜粋して作図悪くない">抜粋して作図。悪くない。</h2>
<p>データ生成の真のパラメータ値は $\hat z = 0.5,~\sigma = 3.0$ だった。</p>
<pre tabindex="0"><code>`stat_bin()` using `bins = 30`. Pick better value with
`binwidth`.
</code></pre><p><img src="./figure/stan-glmm-1.png" alt="plot of chunk stan-glmm"></p>

</section>
<section>
<h2 id="-階層ベイズモデルの練習問題-種の数">🔰 階層ベイズモデルの練習問題: 種の数</h2>
<p>100個体の植物から8つずつ種を取った、のデータでやってみよう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">sigmoid</span> <span class="o">=</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">gain</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span><span class="m">1</span> <span class="o">/</span> <span class="p">(</span><span class="m">1</span> <span class="o">+</span> <span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="n">gain</span> <span class="o">*</span> <span class="n">x</span><span class="p">))}</span>
</span></span><span class="line"><span class="cl"><span class="n">samplesize</span> <span class="o">=</span> <span class="m">100L</span>
</span></span><span class="line"><span class="cl"><span class="n">df_seeds_od</span> <span class="o">=</span> <span class="n">tibble</span><span class="o">::</span><span class="nf">tibble</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">z</span> <span class="o">=</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">samplesize</span><span class="p">,</span> <span class="m">0.5</span><span class="p">,</span> <span class="m">3</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="n">p</span> <span class="o">=</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">z</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="n">y</span> <span class="o">=</span> <span class="nf">rbinom</span><span class="p">(</span><span class="n">samplesize</span><span class="p">,</span> <span class="m">8L</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
</span></span></code></pre></div><img src="figure/overdispersion-1.png" alt="plot of chunk overdispersion">

</section>
<section>
<h2 id="-階層ベイズモデルの練習問題-ビール注文数">🔰 階層ベイズモデルの練習問題: ビール注文数</h2>
<!-- TODO: 時間が余った場合の練習問題 -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">samplesize</span> <span class="o">=</span> <span class="m">300L</span>
</span></span><span class="line"><span class="cl"><span class="n">lambda</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">overdisp</span> <span class="o">=</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">.n</span> <span class="o">=</span> <span class="n">lambda</span> <span class="o">/</span> <span class="p">(</span><span class="n">overdisp</span> <span class="o">-</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">.p</span> <span class="o">=</span> <span class="m">1</span> <span class="o">/</span> <span class="n">overdisp</span>
</span></span><span class="line"><span class="cl"><span class="n">df_beer_od</span> <span class="o">=</span> <span class="n">tibble</span><span class="o">::</span><span class="nf">tibble</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">X</span> <span class="o">=</span> <span class="nf">rnbinom</span><span class="p">(</span><span class="n">samplesize</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">.n</span><span class="p">,</span> <span class="n">prob</span> <span class="o">=</span> <span class="n">.p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><img src="figure/beer-overdispersion-1.png" alt="plot of chunk beer-overdispersion">

</section>
<section>
<h2 id="非線形回帰の例-データ">非線形回帰の例: データ</h2>
<p>刺激強度xに対する応答強度yを20個体調査。<br>
非対称なひと山。応答変数も説明変数も正の値。</p>
<div>\[\begin{split}
y = ae ^ {-bx} - ce ^ {-dx}
\end{split}\]</div>
<p><img src="./figure/non-linear-1.png" alt="plot of chunk non-linear"></p>

</section>
<section>
<h2 id="非線形回帰の例-stanコード">非線形回帰の例: Stanコード</h2>
<p>さっきの数式を <code>model</code> ブロックに書く。</p>
<pre tabindex="0"><code class="language-stan" data-lang="stan">data {
  int&lt;lower=1&gt; N;
  vector[N] x;
  vector[N] y;
  int id[N];
  int&lt;lower=1&gt; Ninds;
}

parameters {
  real&lt;lower=0&gt; a;
  real&lt;lower=0&gt; d;
  real&lt;lower=0,upper=a&gt; c;
  real&lt;lower=0,upper=d&gt; b;
  real shape;
  vector[Ninds] intercept;
}

model {
  vector[N] mu = a * exp(-b * x) - (a - c) * exp(-d * x) + intercept[id];
  y ~ gamma(shape, shape ./ mu);
  a ~ normal(0, 100);
  b ~ normal(0, 100);
  c ~ normal(0, 100);
  d ~ normal(0, 100);
  shape ~ normal(0, 100);
  intercept ~ normal(0, 0.005);
}
</code></pre>
</section>
<section>
<h2 id="階層ベイズモデルのほかの応用先">階層ベイズモデルのほかの応用先</h2>
<ul>
<li>時系列モデル (状態空間モデル)</li>
<li>空間構造のあるモデル (e.g., CARモデル)</li>
<li>欠損値の補完</li>
</ul>

</section>
<section>
<h2 id="ベイズ推定まとめ">ベイズ推定まとめ</h2>
<ul>
<li>条件付き確率 $\text{Prob}(B \mid A)$ の理解が大事。
<ul>
<li>事後分布 $\propto$ 尤度 ⨉ 事前分布</li>
<li>確信度合いをデータで更新していく。</li>
</ul>
</li>
<li>推定結果は分布そのもの。
<ul>
<li>そこから点推定も区間推定も可能。</li>
</ul>
</li>
<li>解析的に解けない問題は計算機に乱数を振らせて解く。
<ul>
<li>MCMCサンプル $\sim$ 解きにくい事後分布</li>
<li>理論・技術の進歩が目覚ましい。</li>
</ul>
</li>
</ul>

</section>
<section>
<h2 id="回帰分析ふりかえり">回帰分析ふりかえり</h2>
<p>より柔軟にモデルを記述できるようになった。計算方法も変化。</p>
<figure>
<a href="https://kuboweb.github.io/-kubo/ce/LinksGlm.html">
<img src="../tokiomarine2021/image/kubo-p2.png" width="1000">
<figcaption class="url">久保さん https://kuboweb.github.io/-kubo/ce/LinksGlm.html</figcaption>
</a>
</figure>

</section>
<section>
<h2 id="全体まとめ">全体まとめ</h2>
<ul>
<li>統計とは、データをうまくまとめ、それに基づいて推論するための手法。</li>
<li>モデルには<strong>理解志向</strong>と<strong>応用志向</strong>があり、統計モデルは前者寄り。
<ul>
<li>どちらも多少は分かった上で使い分けたい。</li>
<li>どっちにしろ真の正しい何かではない。</li>
</ul>
</li>
<li><strong>確率分布</strong>とその背後にある<strong>確率過程</strong>の理解が重要。
<ul>
<li>乱数生成→作図を繰り返してイメージを掴もう。</li>
<li>MCMCサンプリングも事後分布からの乱数生成。</li>
</ul>
</li>
<li>本講義で「統計モデリングを完全に理解した」とは言えない。
<ul>
<li>理論も実践もほとんど説明していない。</li>
<li>本を読む準備ができた、くらいの気持ち？</li>
</ul>
</li>
</ul>

</section>
<section>
<h2 id="参考文献">参考文献</h2>
<ul>
<li><a href="https://amzn.to/33suMIZ">データ解析のための統計モデリング入門</a> 久保拓弥 2012</li>
<li><a href="https://amzn.to/3uwx7Pb">StanとRでベイズ統計モデリング</a> 松浦健太郎 2016</li>
<li><a href="https://amzn.to/3o1eCzP">RとStanではじめる ベイズ統計モデリングによるデータ分析入門</a> 馬場真哉 2019</li>
<li><a href="https://amzn.to/3uCxTKo">データ分析のための数理モデル入門</a> 江崎貴裕 2020</li>
<li><a href="https://amzn.to/3uznzCK">分析者のためのデータ解釈学入門</a> 江崎貴裕 2020</li>
<li><a href="https://amzn.to/3ty80Kv">統計学を哲学する</a> 大塚淳 2020</li>
</ul>
<a href="." class="readmore">
目次に戻る
</a>

</section>
</div>
</div>
</body>
</html>
